### 📄 hrms_project\attendance\__init__.py
```default_app_config = 'attendance.apps.AttendanceConfig'

"""
Attendance App

This Django app provides attendance and leave management functionality including:
- Daily attendance tracking with Friday rules
- Leave management with various leave types
- Holiday management with recurring holidays
- Calendar views for attendance, leaves, and holidays
"""

```

### 📄 hrms_project\attendance\admin\__init__.py
```from django.contrib import admin

from .base import (
    BaseModelAdmin,
    EmployeeLinkedModelAdmin,
    PeriodModelAdmin,
    ColorCodedStatusMixin
)
from ..models import (
    Shift, ShiftAssignment, RamadanPeriod, AttendanceRecord, 
    AttendanceLog, Leave, LeaveType, Holiday, DateSpecificShiftOverride
)
from ..utils.display import DisplayFormatter, SHIFT_TYPE_COLORS, STATUS_COLORS

@admin.register(DateSpecificShiftOverride)
class DateSpecificShiftOverrideAdmin(BaseModelAdmin):
    list_display = ('date', 'shift_type', 'override_start_time', 'override_end_time')
    list_filter = ('shift_type',)
    date_hierarchy = 'date'
    search_fields = ('date',)

@admin.register(Shift)
class ShiftAdmin(BaseModelAdmin):
    list_display = ('name', 'shift_type_display', 'timing_display', 'default_timing_display', 'break_display', 'is_active')
    list_filter = ('shift_type', 'is_active')
    search_fields = ('name', 'description')
    ordering = ('shift_type', 'name')
    
    def shift_type_display(self, obj):
        return DisplayFormatter.color_coded_display(
            obj.shift_type,
            obj.get_shift_type_display(),
            SHIFT_TYPE_COLORS
        )
    shift_type_display.short_description = 'Type'
    
    def timing_display(self, obj):
        return DisplayFormatter.timing_display(
            obj.start_time,
            obj.end_time,
            "Current shift timing"
        )
    timing_display.short_description = 'Current Timing'
    
    def default_timing_display(self, obj):
        return DisplayFormatter.timing_display(
            obj.default_start_time,
            obj.default_end_time,
            "Default shift timing"
        )
    default_timing_display.short_description = 'Default Timing'

    def break_display(self, obj):
        return format_html(
            '<span title="Break duration & Grace period">{}m break / {}m grace</span>',
            obj.break_duration,
            obj.grace_period
        )
    break_display.short_description = 'Break/Grace'

@admin.register(ShiftAssignment)
class ShiftAssignmentAdmin(EmployeeLinkedModelAdmin, PeriodModelAdmin):
    list_display = ('employee_link', 'shift_link', 'period_display', 'is_active', 'created_by', 'created_at')
    list_filter = ('is_active', 'shift', 'created_at')
    raw_id_fields = ('employee', 'shift')
    
    def shift_link(self, obj):
        url = reverse('admin:attendance_shift_change', args=[obj.shift.id])
        return format_html('<a href="{}">{}</a>', url, obj.shift.name)
    shift_link.short_description = 'Shift'

@admin.register(RamadanPeriod)
class RamadanPeriodAdmin(PeriodModelAdmin):
    list_display = ('year', 'start_date', 'end_date', 'duration_display', 'is_active')
    list_filter = ('year', 'is_active')
    search_fields = ('year',)
    ordering = ('-year',)
    
    def duration_display(self, obj):
        if obj.start_date and obj.end_date:
            duration = (obj.end_date - obj.start_date).days + 1
            return f"{duration} days"
        return "Not set"
    duration_display.short_description = 'Duration'

@admin.register(AttendanceLog)
class AttendanceLogAdmin(EmployeeLinkedModelAdmin, ColorCodedStatusMixin):
    list_display = ('employee_link', 'date', 'time_display', 'status_display', 'source')
    list_filter = ('date', 'source', 'status', 'is_active')  
    date_hierarchy = 'date'
    ordering = ('-date', 'employee__first_name')
    raw_id_fields = ('employee',)

    def time_display(self, obj):
        return DisplayFormatter.timing_display(
            obj.first_in_time,
            obj.last_out_time
        )
    time_display.short_description = 'Timing'

    status_colors = STATUS_COLORS

@admin.register(AttendanceRecord)
class AttendanceRecordAdmin(EmployeeLinkedModelAdmin):
    list_display = ('employee_link', 'timestamp', 'event_point', 'device_name')  
    list_filter = ('event_point', 'timestamp')  
    date_hierarchy = 'timestamp'
    ordering = ('-timestamp',)
    raw_id_fields = ('employee',)

@admin.register(Leave)
class LeaveAdmin(EmployeeLinkedModelAdmin, PeriodModelAdmin, ColorCodedStatusMixin):
    list_display = ('employee_link', 'leave_type', 'period_display', 'duration', 'status_display', 'created_at')  
    list_filter = ('status', 'leave_type', 'created_at')
    date_hierarchy = 'start_date'
    raw_id_fields = ('employee',)

    status_colors = {
        'pending': 'orange',
        'approved': 'green',
        'rejected': 'red',
        'cancelled': 'gray'
    }

@admin.register(LeaveType)
class LeaveTypeAdmin(BaseModelAdmin):
    list_display = ('name', 'code', 'days_allowed', 'is_paid', 'is_active')
    list_filter = ('is_paid', 'is_active')
    search_fields = ('name', 'code')
    ordering = ('name',)

@admin.register(Holiday)
class HolidayAdmin(BaseModelAdmin):
    list_display = ('name', 'date', 'is_recurring', 'is_active')
    list_filter = ('is_recurring', 'is_active')
    search_fields = ('name',)
    date_hierarchy = 'date'
    ordering = ('-date',)

```

### 📄 hrms_project\attendance\admin\base.py
```from django.contrib import admin
from django.urls import reverse
from django.utils.html import format_html
from typing import Optional, Tuple, List

from ..utils.display import DisplayFormatter

class BaseModelAdmin(admin.ModelAdmin):
    """
    Base admin class with common functionality for all admin views.
    """
    list_per_page = 25
    
    def get_ordering(self, request) -> Tuple:
        """Default to created_at descending if model has this field"""
        if hasattr(self.model, 'created_at'):
            return ('-created_at',)
        return super().get_ordering(request)

class EmployeeLinkedModelAdmin(BaseModelAdmin):
    """
    Admin class for models that have an employee relationship.
    Provides employee link functionality.
    """
    def get_search_fields(self, request) -> List[str]:
        """Add employee-related search fields"""
        fields = super().get_search_fields(request) or []
        fields.extend([
            'employee__first_name',
            'employee__last_name',
            'employee__employee_number'
        ])
        return fields

    def get_list_filter(self, request) -> List[str]:
        """Add created_at to list filters if available"""
        filters = super().get_list_filter(request) or []
        if hasattr(self.model, 'created_at'):
            filters = list(filters)
            filters.append('created_at')
        return filters

    def employee_link(self, obj) -> str:
        """Generate a link to the employee admin page"""
        if obj.employee:
            url = reverse('admin:employees_employee_change', args=[obj.employee.id])
            return format_html('<a href="{}">{}</a>', url, obj.employee)
        return '-'
    employee_link.short_description = 'Employee'

class PeriodModelAdmin(BaseModelAdmin):
    """
    Admin class for models with start/end date periods.
    Provides period display and filtering functionality.
    """
    date_hierarchy = 'start_date'

    def get_list_filter(self, request) -> List[str]:
        """Add period-related filters"""
        filters = super().get_list_filter(request) or []
        filters = list(filters)
        if hasattr(self.model, 'is_active'):
            filters.append('is_active')
        return filters

    def period_display(self, obj) -> str:
        """Display the period using the centralized formatter"""
        return DisplayFormatter.period_display(
            obj.start_date,
            getattr(obj, 'end_date', None),
            getattr(obj, 'is_permanent', False)
        )
    period_display.short_description = 'Period'

class ColorCodedStatusMixin:
    """
    Mixin that provides color-coded status display functionality.
    """
    def status_display(self, obj) -> str:
        """
        Display the status with color coding.
        Requires STATUS_CHOICES on the model and status_colors in the admin class.
        """
        if not hasattr(self, 'status_colors'):
            raise AttributeError(
                f"{self.__class__.__name__} must define status_colors dictionary mapping "
                "status values to colors"
            )
            
        status_dict = dict(getattr(obj, 'STATUS_CHOICES', ()))
        if not status_dict:
            raise AttributeError(
                f"{obj.__class__.__name__} must define STATUS_CHOICES"
            )
            
        return DisplayFormatter.color_coded_display(
            obj.status,
            status_dict.get(obj.status, obj.status),
            self.status_colors
        )
    status_display.short_description = 'Status'

```

### 📄 hrms_project\attendance\admin.py
```from django.contrib import admin
from django.utils.html import format_html
from django.urls import reverse
from django.utils.safestring import mark_safe

from .models import (
    Shift, ShiftAssignment, RamadanPeriod, AttendanceRecord, 
    AttendanceLog, Leave, LeaveType, Holiday, DateSpecificShiftOverride
)

def get_colored_display(value, display_value, color_map):
    """
    Utility function to generate color-coded HTML display.
    
    Args:
        value: The value to look up in the color map
        display_value: The text to display
        color_map: Dictionary mapping values to colors
        
    Returns:
        format_html string with colored span
    """
    color = color_map.get(value, 'gray')
    return format_html(
        '<span style="color: {};">{}</span>',
        color,
        display_value
    )

class EmployeeLinkedModelAdmin(admin.ModelAdmin):
    """
    Base admin class for models that have an employee relationship.
    Provides common employee link display functionality.
    """
    def employee_link(self, obj):
        url = reverse('admin:employees_employee_change', args=[obj.employee.id])
        return format_html('<a href="{}">{}</a>', url, obj.employee)
    employee_link.short_description = 'Employee'

class PeriodDisplayMixin:
    """
    Mixin that provides period display functionality for models with start_date and end_date.
    """
    def period_display(self, obj):
        start = obj.start_date.strftime('%b %d, %Y')
        if hasattr(obj, 'end_date') and obj.end_date:
            end = obj.end_date.strftime('%b %d, %Y')
            if getattr(obj, 'is_permanent', False):
                return f"From {start} (Permanent)"
            return f"{start} - {end}"
        return f"From {start}"
    period_display.short_description = 'Period'

@admin.register(DateSpecificShiftOverride)
class DateSpecificShiftOverrideAdmin(admin.ModelAdmin):
    list_display = ('date', 'shift_type', 'override_start_time', 'override_end_time')
    list_filter = ('shift_type',)
    date_hierarchy = 'date'
    search_fields = ('date',)

@admin.register(Shift)
class ShiftAdmin(admin.ModelAdmin):
    list_display = ('name', 'shift_type_display', 'timing_display', 'default_timing_display', 'break_display', 'is_active')
    list_filter = ('shift_type', 'is_active')
    search_fields = ('name', 'description')
    ordering = ('shift_type', 'name')
    
    def shift_type_display(self, obj):
        shift_colors = {
            'DEFAULT': 'green',
            'NIGHT': 'purple',
            'OPEN': 'blue'
        }
        return get_colored_display(
            obj.shift_type,
            obj.get_shift_type_display(),
            shift_colors
        )
    shift_type_display.short_description = 'Type'
    
    def timing_display(self, obj):
        return format_html(
            '<span title="Current shift timing">{}</span>',
            f"{obj.start_time.strftime('%I:%M %p')} - {obj.end_time.strftime('%I:%M %p')}"
        )
    timing_display.short_description = 'Current Timing'
    
    def default_timing_display(self, obj):
        if obj.default_start_time and obj.default_end_time:
            return format_html(
                '<span title="Default shift timing">{}</span>',
                f"{obj.default_start_time.strftime('%I:%M %p')} - {obj.default_end_time.strftime('%I:%M %p')}"
            )
        return format_html('<span class="text-muted">Not set</span>')
    default_timing_display.short_description = 'Default Timing'

    def break_display(self, obj):
        return format_html(
            '<span title="Break duration & Grace period">{}m break / {}m grace</span>',
            obj.break_duration,
            obj.grace_period
        )
    break_display.short_description = 'Break/Grace'

@admin.register(ShiftAssignment)
class ShiftAssignmentAdmin(EmployeeLinkedModelAdmin, PeriodDisplayMixin):
    list_display = ('employee_link', 'shift_link', 'period_display', 'is_active', 'created_by', 'created_at')
    list_filter = ('is_active', 'shift', 'created_at')
    search_fields = ('employee__first_name', 'employee__last_name', 'employee__employee_number', 'shift__name')
    ordering = ('-created_at',)
    raw_id_fields = ('employee', 'shift')
    
    def shift_link(self, obj):
        url = reverse('admin:attendance_shift_change', args=[obj.shift.id])
        return format_html('<a href="{}">{}</a>', url, obj.shift.name)
    shift_link.short_description = 'Shift'

@admin.register(RamadanPeriod)
class RamadanPeriodAdmin(admin.ModelAdmin):
    list_display = ('year', 'start_date', 'end_date', 'duration_display', 'is_active')
    list_filter = ('year', 'is_active')
    search_fields = ('year',)
    ordering = ('-year',)
    
    def duration_display(self, obj):
        if obj.start_date and obj.end_date:
            duration = (obj.end_date - obj.start_date).days + 1
            return f"{duration} days"
        return "Not set"
    duration_display.short_description = 'Duration'

@admin.register(AttendanceLog)
class AttendanceLogAdmin(EmployeeLinkedModelAdmin):
    list_display = ('employee_link', 'date', 'time_display', 'status_display', 'source')
    list_filter = ('date', 'source', 'status', 'is_active')  
    search_fields = ('employee__first_name', 'employee__last_name', 'employee__employee_number')
    date_hierarchy = 'date'
    ordering = ('-date', 'employee__first_name')
    raw_id_fields = ('employee',)

    def time_display(self, obj):
        if obj.first_in_time and obj.last_out_time:
            return f"{obj.first_in_time.strftime('%I:%M %p')} - {obj.last_out_time.strftime('%I:%M %p')}"
        return "No time records"
    time_display.short_description = 'Timing'

    def status_display(self, obj):
        status_colors = {
            'present': 'green',
            'absent': 'red',
            'late': 'orange',
            'leave': 'blue',
            'holiday': 'purple'
        }
        return get_colored_display(
            obj.status,
            obj.get_status_display(),
            status_colors
        )
    status_display.short_description = 'Status'

@admin.register(AttendanceRecord)
class AttendanceRecordAdmin(EmployeeLinkedModelAdmin):
    list_display = ('employee_link', 'timestamp', 'event_point', 'device_name')  
    list_filter = ('event_point', 'timestamp')  
    search_fields = ('employee__first_name', 'employee__last_name', 'employee__employee_number', 'device_name')
    date_hierarchy = 'timestamp'
    ordering = ('-timestamp',)
    raw_id_fields = ('employee',)

@admin.register(Leave)
class LeaveAdmin(EmployeeLinkedModelAdmin, PeriodDisplayMixin):
    list_display = ('employee_link', 'leave_type', 'period_display', 'duration', 'status', 'created_at')  
    list_filter = ('status', 'leave_type', 'created_at')
    search_fields = ('employee__first_name', 'employee__last_name', 'employee__employee_number')
    date_hierarchy = 'start_date'
    ordering = ('-created_at',)
    raw_id_fields = ('employee',)

@admin.register(LeaveType)
class LeaveTypeAdmin(admin.ModelAdmin):
    list_display = ('name', 'code', 'days_allowed', 'is_paid', 'is_active')
    list_filter = ('is_paid', 'is_active')
    search_fields = ('name', 'code')
    ordering = ('name',)

@admin.register(Holiday)
class HolidayAdmin(admin.ModelAdmin):
    list_display = ('name', 'date', 'is_recurring', 'is_active')
    list_filter = ('is_recurring', 'is_active')
    search_fields = ('name',)
    date_hierarchy = 'date'
    ordering = ('-date',)

```

### 📄 hrms_project\attendance\api\leave_api_views.py
```from datetime import datetime
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework import status

from django.shortcuts import get_object_or_404

from ..models import LeaveType, Employee
from ..services.leave_rule_service import LeaveRuleService

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def validate_leave_request(request):
    """
    Validate a leave request in real-time
    
    Expected payload:
    {
        "employee": "id",  # Optional, only for admin users
        "leave_type": "id",
        "leave_sub_type": "sub_type_code",
        "start_date": "YYYY-MM-DD",
        "end_date": "YYYY-MM-DD"
    }
    """
    # Get employee (either from request or specified employee for admin users)
    try:
        if request.user.is_staff and request.data.get('employee'):
            employee = get_object_or_404(Employee, id=request.data.get('employee'))
        else:
            employee = request.user.employee
    except (Employee.DoesNotExist, AttributeError):
        return Response(
            {'message': 'No valid employee found for this request'},
            status=status.HTTP_400_BAD_REQUEST
        )
    
    # Get and validate leave type
    leave_type_id = request.data.get('leave_type')
    if not leave_type_id:
        return Response(
            {'message': 'Leave type is required'},
            status=status.HTTP_400_BAD_REQUEST
        )
    
    leave_type = get_object_or_404(LeaveType, id=leave_type_id)
    
    # Get other parameters
    sub_type = request.data.get('leave_sub_type', '')
    
    try:
        start_date = datetime.strptime(
            request.data.get('start_date', ''),
            '%Y-%m-%d'
        ).date()
        end_date = datetime.strptime(
            request.data.get('end_date', ''),
            '%Y-%m-%d'
        ).date()
    except ValueError:
        return Response(
            {'message': 'Invalid date format. Use YYYY-MM-DD'},
            status=status.HTTP_400_BAD_REQUEST
        )
    
    # Validate the request
    is_valid, message, data = LeaveRuleService.validate_leave_request(
        employee=employee,
        leave_type=leave_type,
        sub_type=sub_type,
        start_date=start_date,
        end_date=end_date
    )
    
    return Response({
        'is_valid': is_valid,
        'message': message,
        'data': data
    }) 
```

### 📄 hrms_project\attendance\api\report_views.py
```from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework.exceptions import ValidationError
from typing import List
import logging

from ..utils.validation import RequestValidator
from ..services.report_generator import ReportGeneratorFactory

logger = logging.getLogger('attendance')

class ReportViewSet(viewsets.ViewSet):
    """ViewSet for handling report generation and exports"""
    
    permission_classes = [IsAuthenticated]

    def _handle_report_request(
        self,
        report_type: str,
        request_params: dict,
        optional_params: List[str],
        export_format: str = None
    ):
        """
        Handle report generation request
        
        Args:
            report_type: Type of report to generate
            request_params: Request parameters
            optional_params: Optional parameters to validate
            export_format: Optional export format
        """
        try:
            logger.debug(f"Handling report request - Type: {report_type}, Params: {request_params}")
            
            # Validate date range first
            validated_dates = RequestValidator.validate_date_range(
                request_params.get('start_date'),
                request_params.get('end_date')
            )
            logger.debug(f"Validated dates: {validated_dates}")
            
            # Validate optional parameters
            params = {
                'start_date': validated_dates['start_date'],
                'end_date': validated_dates['end_date']
            }
            
            # Add optional parameters if present
            for param in optional_params:
                param_value = RequestValidator.validate_list_param(request_params, param)
                if param_value:
                    params[param] = param_value
            logger.debug(f"Final params after validation: {params}")
            
            # Create report generator
            generator = ReportGeneratorFactory.create(report_type)
            
            # Generate report in requested format (default to json)
            format = export_format if export_format else 'json'
            logger.debug(f"Generating report in {format} format")
            return generator.generate(format, **params)
            
        except ValidationError as e:
            logger.error(f"Validation error: {str(e)}")
            return Response({"error": str(e)}, status=400)
        except Exception as e:
            logger.error(f"Unexpected error: {str(e)}")
            return Response(
                {"error": f"Unexpected error: {str(e)}"}, 
                status=500
            )

    @action(detail=False, methods=['get'])
    def attendance(self, request):
        """Generate attendance report"""
        logger.debug("Generating attendance report")
        return self._handle_report_request(
            'attendance',
            request.query_params,
            ['departments', 'employees', 'status']
        )

    @action(detail=False, methods=['get'])
    def leave(self, request):
        """Generate leave report"""
        logger.debug("Generating leave report")
        return self._handle_report_request(
            'leave',
            request.query_params,
            ['departments', 'employees', 'leave_types']
        )

    @action(detail=False, methods=['get']) 
    def holiday(self, request):
        """Generate holiday report"""
        logger.debug("Generating holiday report")
        return self._handle_report_request(
            'holiday',
            request.query_params,
            []
        )

    @action(detail=False, methods=['get'])
    def export(self, request):
        """Export report in specified format"""
        logger.debug("Exporting report")
        try:
            report_type = request.query_params.get('type', 'attendance')
            export_format = request.query_params.get('format', 'csv')
            
            optional_params = {
                'attendance': ['departments', 'employees', 'status'],
                'leave': ['departments', 'employees', 'leave_types'],
                'holiday': []
            }.get(report_type, [])
            
            return self._handle_report_request(
                report_type,
                request.query_params,
                optional_params,
                export_format
            )
            
        except ValidationError as e:
            logger.error(f"Validation error: {str(e)}")
            return Response({"error": str(e)}, status=400)
        except Exception as e:
            logger.error(f"Unexpected error: {str(e)}")
            return Response(
                {"error": f"Unexpected error: {str(e)}"}, 
                status=500
            )

```

### 📄 hrms_project\attendance\api\urls.py
```from django.urls import path
from . import views
from .leave_api_views import validate_leave_request

app_name = 'attendance_api'

urlpatterns = [
    path('shift-assignments/', views.shift_assignments, name='shift_assignments'),
    path('validate-leave-request/', validate_leave_request, name='validate_leave_request'),
]

```

### 📄 hrms_project\attendance\api\views.py
```from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from ..models import ShiftAssignment
from datetime import datetime
import dateutil.parser

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def shift_assignments(request):
    """API endpoint for FullCalendar to fetch shift assignments"""
    # Get query parameters
    start = request.GET.get('start')
    end = request.GET.get('end')
    department = request.GET.get('department')
    shift_type = request.GET.get('shift_type')
    employee = request.GET.get('employee')

    # Base queryset
    queryset = ShiftAssignment.objects.filter(is_active=True).select_related('employee', 'shift')

    # Apply filters
    if start:
        try:
            start_date = dateutil.parser.parse(start).date()
            queryset = queryset.filter(start_date__gte=start_date)
        except (ValueError, TypeError):
            return Response({'error': 'Invalid start date format'}, status=400)
            
    if end:
        try:
            end_date = dateutil.parser.parse(end).date()
            queryset = queryset.filter(
                start_date__lte=end_date
            ).exclude(
                end_date__lt=start_date
            )
        except (ValueError, TypeError):
            return Response({'error': 'Invalid end date format'}, status=400)
    if department:
        queryset = queryset.filter(employee__department_id=department)
    if shift_type:
        queryset = queryset.filter(shift__shift_type=shift_type)
    if employee:
        queryset = queryset.filter(employee_id=employee)

    # Convert to FullCalendar events format
    events = []
    for assignment in queryset:
        event = {
            'id': assignment.id,
            'title': f"{assignment.employee.get_full_name()} - {assignment.shift.name}",
            'start': assignment.start_date.isoformat(),
            'end': assignment.end_date.isoformat() if assignment.end_date else None,
            'allDay': True,
            'extendedProps': {
                'employee_id': assignment.employee.id,
                'shift_id': assignment.shift.id,
                'shift_type': assignment.shift.shift_type,
                'is_date_specific': assignment.end_date is not None,
                'is_ramadan': False  # TODO: Add Ramadan check logic
            }
        }
        events.append(event)

    return Response(events)

```

### 📄 hrms_project\attendance\apps.py
```from django.apps import AppConfig
from django.db.models.signals import post_save, post_delete
from typing import Dict, Tuple, Callable


class AttendanceConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'attendance'
    verbose_name = 'Attendance Management'

    def _connect_model_signals(self):
        """
        Dynamically connect signal handlers for models.
        Uses a configuration dictionary to map models to their signal handlers.
        """
        from . import signals

        # Define signal handlers for each model
        # Format: 'model_name': (post_save_handler, post_delete_handler)
        signal_handlers: Dict[str, Tuple[Callable, Callable]] = {
            'AttendanceRecord': (
                signals.process_attendance_record,
                signals.cleanup_attendance_record
            ),
            'Leave': (
                signals.process_leave_request,
                signals.cleanup_leave_request
            ),
            'Holiday': (
                signals.process_holiday,
                signals.cleanup_holiday
            ),
        }

        # Special case for LeaveType which only needs post_save
        single_handlers = {
            'LeaveType': (signals.create_leave_balances, None)
        }

        # Connect regular signals (post_save and post_delete)
        for model_name, (save_handler, delete_handler) in signal_handlers.items():
            sender = f'{self.name}.{model_name}'
            post_save.connect(save_handler, sender=sender)
            post_delete.connect(delete_handler, sender=sender)

        # Connect single signals
        for model_name, (save_handler, delete_handler) in single_handlers.items():
            sender = f'{self.name}.{model_name}'
            if save_handler:
                post_save.connect(save_handler, sender=sender)
            if delete_handler:
                post_delete.connect(delete_handler, sender=sender)

    def _setup_celery_schedule(self):
        """
        Set up Celery Beat schedule from the schedules module.
        Handles the case where Celery is not installed or configured.
        """
        try:
            from django.conf import settings
            from .schedules import BEAT_SCHEDULE

            # Only update if Celery is configured
            if hasattr(settings, 'CELERY_BEAT_SCHEDULE'):
                settings.CELERY_BEAT_SCHEDULE.update(BEAT_SCHEDULE)
        except ImportError:
            # Celery not installed or configured, skip task scheduling
            pass

    def ready(self):
        """
        Initialize app configuration when Django is ready.
        Connects signal handlers and sets up periodic tasks.
        """
        # Connect model signals
        self._connect_model_signals()

        # Setup Celery Beat schedule
        self._setup_celery_schedule()

        # Load and register custom template tags
        from django.template.backends.django import get_installed_libraries
        get_installed_libraries()

```

### 📄 hrms_project\attendance\cache.py
```from datetime import date, datetime, timedelta
from typing import Optional, Dict, Any, List, TypeVar, Generic, Union
from django.core.cache import cache
from django.db.models import QuerySet
from django.conf import settings

# Cache configuration
CACHE_KEYS = {
    'employee_shift': 'employee_shift_{}',  # Employee's current shift
    'ramadan_period': 'ramadan_period_{}',  # Active Ramadan period for date
    'department_shifts': 'department_shifts_{}',  # Department's shift assignments
    'employee_schedule': 'employee_schedule_{}_{}_{}',  # Employee's schedule for date range
    'shift_statistics': 'shift_statistics_{}',  # Statistics for shift
    'attendance_metrics': 'attendance_metrics_{}_{}',  # Daily attendance metrics
    'report_attendance': 'report_attendance_{}',  # Attendance report
    'report_leave': 'report_leave_{}',  # Leave report
    'report_holiday': 'report_holiday_{}',  # Holiday report
}

CACHE_TIMEOUTS = {
    'employee_shift': 60 * 60,  # 1 hour
    'ramadan_period': 60 * 60 * 24,  # 24 hours
    'department_shifts': 60 * 30,  # 30 minutes
    'employee_schedule': 60 * 15,  # 15 minutes
    'shift_statistics': 60 * 60,  # 1 hour
    'attendance_metrics': 60 * 60 * 12,  # 12 hours
    'report_attendance': 60 * 60,  # 1 hour
    'report_leave': 60 * 60,  # 1 hour
    'report_holiday': 60 * 60 * 24,  # 24 hours
}

def generate_cache_key(key_name: str, *args) -> str:
    """
    Centralized cache key generation function.
    
    Args:
        key_name: Name of the cache key template from CACHE_KEYS
        *args: Arguments to format into the key template
        
    Returns:
        Formatted cache key string
    
    Raises:
        KeyError: If key_name is not found in CACHE_KEYS
    """
    if key_name not in CACHE_KEYS:
        raise KeyError(f"Unknown cache key name: {key_name}")
    
    # Format date objects to ISO format
    formatted_args = [
        arg.isoformat() if isinstance(arg, date) else arg
        for arg in args
    ]
    
    return CACHE_KEYS[key_name].format(*formatted_args)

T = TypeVar('T')

class CacheManager(Generic[T]):
    """
    Base cache manager class providing generic cache operations.
    
    Type Parameters:
        T: The type of data being cached
    """
    
    def __init__(self, key_name: str, timeout_key: str):
        """
        Initialize cache manager with key configuration.
        
        Args:
            key_name: Name of the cache key template from CACHE_KEYS
            timeout_key: Name of the timeout from CACHE_TIMEOUTS
        """
        self.key_name = key_name
        self.timeout = CACHE_TIMEOUTS[timeout_key]
    
    def get_key(self, *args) -> str:
        """Generate cache key for given arguments"""
        return generate_cache_key(self.key_name, *args)
    
    def get(self, *args) -> Optional[T]:
        """Get cached data"""
        key = self.get_key(*args)
        return cache.get(key)
    
    def set(self, data: T, *args) -> None:
        """Set cache data"""
        key = self.get_key(*args)
        cache.set(key, data, self.timeout)
    
    def clear(self, *args) -> None:
        """Clear cached data"""
        key = self.get_key(*args)
        cache.delete(key)
    
    def clear_pattern(self, pattern: str) -> None:
        """
        Clear all cache keys matching a pattern.
        Note: Implementation depends on cache backend capabilities.
        Falls back to no-op if pattern deletion is not supported.
        """
        if hasattr(cache, 'delete_pattern'):
            # For cache backends that support pattern deletion (e.g., Redis)
            cache.delete_pattern(pattern)

class ShiftCache:
    """Cache manager for shift-related data"""
    
    _employee_shift = CacheManager[Dict[str, Any]]('employee_shift', 'employee_shift')
    _department_shifts = CacheManager[Dict[str, List[Dict[str, Any]]]]('department_shifts', 'department_shifts')
    
    @classmethod
    def get_employee_shift(cls, employee_id: int) -> Optional[Dict[str, Any]]:
        """Get employee's current shift from cache"""
        return cls._employee_shift.get(employee_id)
    
    @classmethod
    def set_employee_shift(cls, employee_id: int, shift_data: Dict[str, Any]) -> None:
        """Cache employee's current shift"""
        cls._employee_shift.set(shift_data, employee_id)
    
    @classmethod
    def clear_employee_shift(cls, employee_id: int) -> None:
        """Clear employee's shift cache"""
        cls._employee_shift.clear(employee_id)
    
    @classmethod
    def get_department_shifts(cls, department_id: int) -> Optional[Dict[str, List[Dict[str, Any]]]]:
        """Get department shifts from cache"""
        return cls._department_shifts.get(department_id)
    
    @classmethod
    def set_department_shifts(cls, department_id: int, shifts_data: Dict[str, List[Dict[str, Any]]]) -> None:
        """Cache department shifts"""
        cls._department_shifts.set(shifts_data, department_id)
    
    @classmethod
    def clear_department_shifts(cls, department_id: int) -> None:
        """Clear department shifts cache"""
        cls._department_shifts.clear(department_id)

class RamadanCache:
    """Cache manager for Ramadan period data"""
    
    _period = CacheManager[Dict[str, Any]]('ramadan_period', 'ramadan_period')
    
    @classmethod
    def get_active_period(cls, target_date: date) -> Optional[Dict[str, Any]]:
        """Get active Ramadan period from cache"""
        return cls._period.get(target_date)
    
    @classmethod
    def set_active_period(cls, target_date: date, period_data: Dict[str, Any]) -> None:
        """Cache active Ramadan period"""
        cls._period.set(period_data, target_date)
    
    @classmethod
    def clear_active_period(cls, target_date: date) -> None:
        """Clear Ramadan period cache"""
        cls._period.clear(target_date)
    
    @classmethod
    def clear_all_periods(cls) -> None:
        """Clear all Ramadan period caches"""
        # Try to use pattern deletion if supported
        cls._period.clear_pattern('ramadan_period_*')
        
        # Fallback to iterative deletion if pattern deletion is not supported
        if not hasattr(cache, 'delete_pattern'):
            current_date = date.today()
            year_start = date(current_date.year, 1, 1)
            year_end = date(current_date.year, 12, 31)
            
            current = year_start
            while current <= year_end:
                cls.clear_active_period(current)
                current += timedelta(days=1)

class AttendanceMetricsCache:
    """Cache manager for attendance metrics"""
    
    _metrics = CacheManager[Dict[str, Any]]('attendance_metrics', 'attendance_metrics')
    
    @classmethod
    def get_metrics(cls, date_str: str, department_id: Optional[int] = None) -> Optional[Dict[str, Any]]:
        """Get attendance metrics from cache"""
        return cls._metrics.get(date_str, department_id or 'all')
    
    @classmethod
    def set_metrics(
        cls,
        date_str: str,
        metrics_data: Dict[str, Any],
        department_id: Optional[int] = None
    ) -> None:
        """Cache attendance metrics"""
        cls._metrics.set(metrics_data, date_str, department_id or 'all')
    
    @classmethod
    def clear_metrics(cls, date_str: str, department_id: Optional[int] = None) -> None:
        """Clear attendance metrics cache"""
        cls._metrics.clear(date_str, department_id or 'all')

def invalidate_employee_caches(employee_id: int) -> None:
    """Invalidate all caches related to an employee"""
    # Clear shift cache
    ShiftCache.clear_employee_shift(employee_id)
    
    # Clear schedule caches for recent dates
    today = date.today()
    schedule_cache = CacheManager[Any]('employee_schedule', 'employee_schedule')
    
    for days in range(-7, 30):  # Past week to next month
        target_date = today + timedelta(days=days)
        schedule_cache.clear(employee_id, target_date, target_date)

def invalidate_department_caches(department_id: int) -> None:
    """Invalidate all caches related to a department"""
    # Clear department shifts
    ShiftCache.clear_department_shifts(department_id)
    
    # Clear department metrics
    today = date.today()
    for days in range(-30, 1):  # Past month
        target_date = today + timedelta(days=days)
        AttendanceMetricsCache.clear_metrics(
            target_date.isoformat(),
            department_id
        )

def warm_employee_caches(employee_id: int) -> None:
    """Pre-warm commonly accessed employee caches"""
    from attendance.services import ShiftService
    
    # Warm up current shift
    current_shift = ShiftService.get_employee_current_shift(employee_id)
    if current_shift:
        ShiftCache.set_employee_shift(employee_id, current_shift)

```

### 📄 hrms_project\attendance\config\shift_defaults.py
```"""
Default configurations for shifts.
These can be modified without changing the model code.
"""

# Shift type priorities (higher number = higher priority)
SHIFT_PRIORITIES = {
    'NIGHT': 3,    # Highest priority
    'OPEN': 2,     # Medium priority
    'DEFAULT': 1,  # Lowest priority
}

# Default shift configurations
DEFAULT_SHIFTS = [
    {
        'name': 'Default Shift',
        'shift_type': 'DEFAULT',
        'start_time': '07:00',
        'end_time': '16:00',
        'grace_period': 15,
        'break_duration': 60,
    },
    {
        'name': 'Night Shift',
        'shift_type': 'NIGHT',
        'start_time': '18:00',
        'end_time': '03:00',
        'grace_period': 15,
        'break_duration': 60,
    },
    {
        'name': 'Open Shift',
        'shift_type': 'OPEN',
        'start_time': '00:00',
        'end_time': '23:59',
        'grace_period': 30,
        'break_duration': 60,
    },
]
```

### 📄 hrms_project\attendance\forms.py
```from django import forms
from django.core.validators import FileExtensionValidator
from typing import Dict, Any, Optional
from datetime import date
from .models import Holiday, Leave, LeaveType, LeaveDocument

class BaseForm(forms.Form):
    """
    Base form class that provides common functionality for all forms.
    Automatically adds Bootstrap classes to form widgets.
    """
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._add_bootstrap_classes()
    
    def _add_bootstrap_classes(self):
        """Add Bootstrap classes to form widgets based on their type"""
        for field in self.fields.values():
            widget = field.widget
            if isinstance(widget, (forms.Select, forms.SelectMultiple)):
                self._add_widget_class(widget, 'form-select')
            elif isinstance(widget, forms.CheckboxInput):
                self._add_widget_class(widget, 'form-check-input')
            elif isinstance(widget, forms.FileInput):
                self._add_widget_class(widget, 'form-control')
            else:
                self._add_widget_class(widget, 'form-control')
    
    @staticmethod
    def _add_widget_class(widget: forms.Widget, class_name: str):
        """Add a CSS class to a widget if it doesn't already have it"""
        if 'class' in widget.attrs:
            if class_name not in widget.attrs['class']:
                widget.attrs['class'] += f' {class_name}'
        else:
            widget.attrs['class'] = class_name

class BaseModelForm(forms.ModelForm, BaseForm):
    """
    Base model form class that combines ModelForm functionality with BaseForm.
    """
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._add_bootstrap_classes()

class DateRangeValidationMixin:
    """
    Mixin to provide date range validation functionality.
    Can be used with both forms and serializers.
    """
    
    def validate_date_range(
        self,
        start_date: date,
        end_date: date,
        allow_single_day: bool = True,
        allow_past_dates: bool = True,
        max_days: Optional[int] = None
    ) -> None:
        """
        Validate a date range according to specified constraints.
        
        Args:
            start_date: The start date of the range
            end_date: The end date of the range
            allow_single_day: Whether the start and end date can be the same
            allow_past_dates: Whether dates in the past are allowed
            max_days: Maximum number of days allowed between start and end date
            
        Raises:
            ValidationError: If the date range is invalid
        """
        if not start_date or not end_date:
            return
            
        if start_date > end_date:
            raise forms.ValidationError('End date must be after start date')
            
        if not allow_single_day and start_date == end_date:
            raise forms.ValidationError('Start and end date cannot be the same')
            
        if not allow_past_dates and start_date < date.today():
            raise forms.ValidationError('Past dates are not allowed')
            
        if max_days:
            days_difference = (end_date - start_date).days + 1
            if days_difference > max_days:
                raise forms.ValidationError(
                    f'Date range cannot exceed {max_days} days'
                )

class HolidayForm(BaseModelForm):
    class Meta:
        model = Holiday
        fields = [
            'name',
            'date',
            'holiday_type',
            'description',
            'is_recurring',
            'is_paid',
        ]
        widgets = {
            'date': forms.DateInput(attrs={'type': 'date'}),
            'description': forms.Textarea(attrs={'rows': 3}),
        }

class LeaveBalanceUploadForm(BaseForm):
    csv_file = forms.FileField(
        label="CSV File",
        help_text="Upload a CSV file with employee_number and leave_balance columns."
    )
    as_of_date = forms.DateField(
        label="Balance as of Date",
        widget=forms.DateInput(attrs={'type': 'date'}),
        help_text="Date to associate with these beginning balances."
    )
    leave_type_code = forms.CharField(
        label="Leave Type Code",
        initial='ANNUAL',
        widget=forms.HiddenInput(),
    )

class LeaveRequestForm(BaseModelForm, DateRangeValidationMixin):
    leave_sub_type = forms.ChoiceField(
        choices=[],  # Will be populated dynamically
        required=False,
        label='Leave Sub Type',  # Give it a default label
        widget=forms.Select()
    )
    
    document = forms.FileField(
        required=False,
        validators=[FileExtensionValidator(allowed_extensions=['pdf', 'jpg', 'jpeg', 'png'])],
        help_text='Supported formats: PDF, JPG, JPEG, PNG'
    )

    class Meta:
        model = Leave
        fields = [
            'leave_type',
            'leave_sub_type',
            'start_date',
            'end_date',
            'reason'
        ]
        widgets = {
            'start_date': forms.DateInput(attrs={'type': 'date'}),
            'end_date': forms.DateInput(attrs={'type': 'date'}),
            'reason': forms.Textarea(attrs={'rows': 3})
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        leave_type = self.data.get('leave_type') if self.data else None
        
        # Initialize with empty choices
        self.fields['leave_sub_type'].choices = [('', 'Select type')]
        
        # Set initial choices based on leave type
        if leave_type:
            self.set_sub_type_choices(leave_type)

    def set_sub_type_choices(self, leave_type_id):
        """Set sub-type choices based on leave type"""
        try:
            leave_type = LeaveType.objects.get(id=leave_type_id)
            choices = [('', 'Select type')]  # Always include the empty choice
            
            if leave_type.code == 'ANNUAL':
                choices.extend([
                    ('full_day', 'Full Day'),
                    ('half_day', 'Half Day'),
                ])
            elif leave_type.code == 'HALF':
                choices.extend([
                    ('morning', 'Morning'),
                    ('afternoon', 'Afternoon'),
                ])
            elif leave_type.code == 'MATERNITY':
                choices.extend([
                    ('paid_60', '60 days (Full Pay)'),
                    ('unpaid_15', 'Additional 15 days (Unpaid)'),
                ])
            elif leave_type.code == 'DEATH':
                choices.extend([
                    ('spouse_30', 'Woman\'s Husband (30 days)'),
                    ('spouse_3', 'Man\'s Wife (3 days)'),
                    ('first_degree', 'First Degree Relative (3 days)'),
                    ('second_degree', 'Second Degree Spouse Relative (3 days)'),
                ])
            elif leave_type.code == 'SICK':
                choices.extend([
                    ('tier1', 'First 15 days - Full Pay'),
                    ('tier2', 'Next 20 days - Half Pay'),
                    ('tier3', 'Next 20 days - Unpaid'),
                ])
            elif leave_type.code == 'MARRIAGE':
                choices.extend([('3_days', '3 days')])
            elif leave_type.code == 'PATERNITY':
                choices.extend([('1_day', '1 day')])
            elif leave_type.code == 'HAJJ':
                choices.extend([('14_days', '14 days (Full Pay)')])
            elif leave_type.code == 'IDDAH':
                choices.extend([
                    ('paid_30', '1 month (Full Pay)'),
                    ('unpaid_100', '3 months and 10 Days (Unpaid)'),
                ])
                
            self.fields['leave_sub_type'].choices = choices
            self.fields['leave_sub_type'].required = len(choices) > 1  # Required if there are choices other than the empty option
            self.fields['leave_sub_type'].label = f'{leave_type.name} Type' if len(choices) > 1 else ''
                
        except LeaveType.DoesNotExist:
            self.fields['leave_sub_type'].choices = [('', 'Select type')]
            self.fields['leave_sub_type'].required = False
            self.fields['leave_sub_type'].label = ''

    def clean(self):
        cleaned_data = super().clean()
        start_date = cleaned_data.get('start_date')
        end_date = cleaned_data.get('end_date')
        leave_type = cleaned_data.get('leave_type')
        leave_sub_type = cleaned_data.get('leave_sub_type')

        if start_date and end_date:
            # Ensure end date is never less than start date
            if end_date < start_date:
                # Automatically adjust end date to match start date
                cleaned_data['end_date'] = start_date
                end_date = start_date
                # Add a message to the form to inform the user
                self.add_error('end_date', 'End date cannot be earlier than start date. It has been adjusted automatically.')
            
            # Validate date range
            self.validate_date_range(
                start_date,
                end_date,
                allow_single_day=True,
                allow_past_dates=True
            )

            # Additional validation for half-day leave
            if leave_sub_type in ['half_day', 'morning', 'afternoon'] and start_date != end_date:
                raise forms.ValidationError('Half day leave must be for a single day')

            # Validate leave sub-type is provided when required
            if leave_type and leave_type.code in ['ANNUAL', 'HALF', 'MATERNITY', 'DEATH', 'SICK', 'MARRIAGE', 'PATERNITY', 'HAJJ', 'IDDAH'] and not leave_sub_type:
                raise forms.ValidationError('Please select the leave sub-type')

        return cleaned_data
```

### 📄 hrms_project\attendance\management\commands\__init__.py
```"""
Management commands for attendance app.

Available commands:
- reset_annual_leave: Reset annual leave balances for all employees
- generate_holidays: Generate holidays for next year based on recurring holidays
"""

```

### 📄 hrms_project\attendance\management\commands\cleanup_shifts.py
```import logging
from datetime import datetime, date, timedelta
from typing import Optional, Callable, Any, List, Dict
from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone
from django.db.models import Q, Count, QuerySet, Model
from django.contrib.auth.models import User

from attendance.models import (
    Shift, ShiftAssignment, RamadanPeriod, AttendanceLog
)
from attendance.cache import (
    ShiftCache, RamadanCache, invalidate_department_caches,
    invalidate_employee_caches
)

logger = logging.getLogger(__name__)

class CacheInvalidationService:
    """Service for handling cache invalidation operations"""
    
    @staticmethod
    def clear_all_caches(command_instance: BaseCommand) -> None:
        """Clear all relevant caches"""
        # Clear Ramadan periods
        RamadanCache.clear_all_periods()
        
        # Get unique departments from shift assignments
        departments = set(ShiftAssignment.objects.values_list(
            'employee__department_id',
            flat=True
        ))
        
        # Clear department caches
        for dept_id in departments:
            if dept_id:
                invalidate_department_caches(dept_id)
        
        command_instance.stdout.write('Cleared relevant caches')

class DataArchiver:
    """Handles archiving data to CSV files"""
    
    @staticmethod
    def archive_to_csv(
        queryset: QuerySet,
        fields: List[str],
        filename_prefix: str,
        command_instance: BaseCommand
    ) -> None:
        """
        Archive queryset data to a CSV file.
        
        Args:
            queryset: The queryset to archive
            fields: List of field names to include
            filename_prefix: Prefix for the archive filename
            command_instance: Command instance for output
        """
        timestamp = timezone.now().strftime('%Y%m%d_%H%M%S')
        filename = f'{filename_prefix}_{timestamp}.csv'
        
        with open(filename, 'w') as f:
            # Write header
            f.write(','.join(fields) + '\n')
            
            # Write data
            for obj in queryset:
                values = [str(getattr(obj, field)) for field in fields]
                f.write(','.join(values) + '\n')
        
        command_instance.stdout.write(f'Archived data to {filename}')

class Command(BaseCommand):
    help = 'Cleanup and maintenance of shift-related data'

    def add_arguments(self, parser):
        parser.add_argument(
            '--days',
            type=int,
            default=90,
            help='Number of days to keep in history (default: 90)'
        )
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Show what would be deleted without actually deleting'
        )
        parser.add_argument(
            '--force',
            action='store_true',
            help='Force cleanup without confirmation'
        )
        parser.add_argument(
            '--archive',
            action='store_true',
            help='Archive data instead of deleting'
        )

    def handle(self, *args, **options):
        try:
            days = options['days']
            dry_run = options['dry_run']
            force = options['force']
            archive = options['archive']
            
            cutoff_date = timezone.now().date() - timedelta(days=days)
            
            self.stdout.write(
                self.style.WARNING(
                    f'\nStarting shift data cleanup for data older than {cutoff_date}'
                )
            )
            
            if dry_run:
                self.stdout.write(
                    self.style.WARNING('DRY RUN - No data will be deleted')
                )
            
            # Confirm unless --force is used
            if not dry_run and not force:
                confirm = input(
                    '\nThis will permanently delete old shift data. '
                    'Are you sure? [y/N]: '
                )
                if confirm.lower() != 'y':
                    self.stdout.write('Operation cancelled.')
                    return
            
            with transaction.atomic():
                # Clean up expired shift assignments
                self._cleanup_objects(
                    queryset=ShiftAssignment.objects.filter(
                        end_date__lt=cutoff_date,
                        is_active=False
                    ),
                    object_type='shift assignments',
                    archive_config={
                        'fields': ['employee_id', 'shift_id', 'start_date', 'end_date', 'created_at'],
                        'prefix': 'shift_assignments_archive'
                    } if archive else None,
                    dry_run=dry_run
                )
                
                # Clean up old Ramadan periods
                self._cleanup_objects(
                    queryset=RamadanPeriod.objects.filter(
                        end_date__lt=cutoff_date,
                        is_active=False
                    ),
                    object_type='Ramadan periods',
                    archive_config={
                        'fields': ['year', 'start_date', 'end_date', 'is_active'],
                        'prefix': 'ramadan_periods_archive'
                    } if archive else None,
                    dry_run=dry_run
                )
                
                # Clean up orphaned shifts
                self._cleanup_objects(
                    queryset=Shift.objects.filter(shiftassignment__isnull=True),
                    object_type='orphaned shifts',
                    dry_run=dry_run
                )
                
                # Clean up duplicate assignments
                self._cleanup_duplicate_assignments(dry_run)
                
                if not dry_run:
                    # Clear relevant caches
                    CacheInvalidationService.clear_all_caches(self)
            
            self.stdout.write(self.style.SUCCESS('\nCleanup completed successfully'))
            
        except Exception as e:
            self.stderr.write(
                self.style.ERROR(f'Error during cleanup: {str(e)}')
            )
            logger.error('Error in cleanup_shifts command', exc_info=True)

    def _cleanup_objects(
        self,
        queryset: QuerySet,
        object_type: str,
        archive_config: Optional[Dict[str, Any]] = None,
        dry_run: bool = False
    ) -> None:
        """
        Generic cleanup function for handling object deletion and archiving.
        
        Args:
            queryset: The queryset to clean up
            object_type: Description of the object type for logging
            archive_config: Optional archive configuration with fields and filename prefix
            dry_run: Whether this is a dry run
        """
        count = queryset.count()
        self.stdout.write(f'\nFound {count} {object_type}')
        
        if not dry_run:
            if archive_config:
                DataArchiver.archive_to_csv(
                    queryset,
                    archive_config['fields'],
                    archive_config['prefix'],
                    self
                )
            
            queryset.delete()
            self.stdout.write(f'Deleted {count} {object_type}')

    def _cleanup_duplicate_assignments(self, dry_run: bool) -> None:
        """Clean up duplicate active assignments for employees"""
        duplicates = ShiftAssignment.objects.filter(
            is_active=True
        ).values(
            'employee'
        ).annotate(
            count=Count('id')
        ).filter(
            count__gt=1
        )
        
        count = len(duplicates)
        self.stdout.write(f'\nFound {count} employees with multiple active assignments')
        
        if not dry_run:
            for dup in duplicates:
                # Keep only the most recent assignment
                assignments = ShiftAssignment.objects.filter(
                    employee_id=dup['employee'],
                    is_active=True
                ).order_by('-created_at')
                
                # Deactivate all but the most recent
                assignments.exclude(id=assignments[0].id).update(is_active=False)
            
            self.stdout.write(f'Fixed {count} duplicate assignments')

```

### 📄 hrms_project\attendance\management\commands\generate_holidays.py
```from django.core.management.base import BaseCommand
from django.utils import timezone
from django.db import transaction
from attendance.models import Holiday
from datetime import datetime
import logging

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Generate holidays for next year based on recurring holidays'

    def add_arguments(self, parser):
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Run without making changes to see what would happen',
        )
        parser.add_argument(
            '--year',
            type=int,
            help='Specify year to generate (defaults to next year)',
        )
        parser.add_argument(
            '--force',
            action='store_true',
            help='Force generation even if not December',
        )

    def handle(self, *args, **options):
        dry_run = options['dry_run']
        force = options['force']
        target_year = options['year'] or timezone.now().year + 1
        current_month = timezone.now().month

        # Check if it's December or force flag is set
        if current_month != 12 and not force:
            self.stdout.write(
                self.style.WARNING(
                    'Holiday generation should be run in December. '
                    'Use --force to override.'
                )
            )
            return

        self.stdout.write(
            self.style.SUCCESS(f'Starting holiday generation for year {target_year}')
        )
        if dry_run:
            self.stdout.write(
                self.style.WARNING('DRY RUN - no changes will be made')
            )

        try:
            with transaction.atomic():
                # Get all recurring holidays
                recurring_holidays = Holiday.objects.filter(
                    is_recurring=True,
                    is_active=True
                )

                self.stdout.write(
                    f'Found {recurring_holidays.count()} recurring holidays'
                )

                holidays_created = 0
                holidays_skipped = 0

                # Process each recurring holiday
                for holiday in recurring_holidays:
                    # Create date for target year
                    try:
                        new_date = holiday.date.replace(year=target_year)
                        
                        # Check if holiday already exists
                        existing = Holiday.objects.filter(
                            date=new_date,
                            name=holiday.name
                        ).exists()
                        
                        if existing:
                            self.stdout.write(
                                f'  Skipping {holiday.name} - already exists on {new_date}'
                            )
                            holidays_skipped += 1
                            continue

                        # Create new holiday instance
                        if not dry_run:
                            new_holiday = Holiday.objects.create(
                                date=new_date,
                                name=holiday.name,
                                description=holiday.description,
                                holiday_type=holiday.holiday_type,
                                is_paid=holiday.is_paid,
                                is_recurring=False  # New instance is not recurring
                            )
                            
                            # Copy department associations if any
                            if holiday.applicable_departments.exists():
                                new_holiday.applicable_departments.set(
                                    holiday.applicable_departments.all()
                                )

                        self.stdout.write(
                            f'  Created {holiday.name} on {new_date}'
                        )
                        holidays_created += 1

                    except Exception as e:
                        logger.error(
                            f'Error processing holiday {holiday.name}: {str(e)}'
                        )
                        if not dry_run:
                            raise

                if dry_run:
                    transaction.set_rollback(True)
                    self.stdout.write(
                        self.style.SUCCESS(
                            f'Dry run completed - would create {holidays_created} '
                            f'holidays ({holidays_skipped} skipped)'
                        )
                    )
                else:
                    self.stdout.write(
                        self.style.SUCCESS(
                            f'Successfully created {holidays_created} holidays '
                            f'({holidays_skipped} skipped)'
                        )
                    )

        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Error generating holidays: {str(e)}')
            )
            logger.error(f'Holiday generation failed: {str(e)}')
            raise

```

### 📄 hrms_project\attendance\management\commands\generate_report.py
```import logging
from django.core.management.base import BaseCommand
from django.template.loader import render_to_string
from django.utils import timezone
from django.db.models import Count, Avg, Q, Sum, F, ExpressionWrapper, fields
from django.db.models.functions import ExtractHour, ExtractMinute
from datetime import datetime, timedelta, date
from typing import Dict, Any, Optional, Tuple, List, Union
from dataclasses import dataclass
from django.core.serializers.json import DjangoJSONEncoder
from attendance.models import AttendanceLog, Leave, LeaveType, LeaveBalance
from employees.models import Employee, Department
import os
import csv
from io import StringIO
import json

logger = logging.getLogger(__name__)

@dataclass
class DateRange:
    """Data class to hold date range information"""
    start_date: date
    end_date: date
    total_days: int

    @property
    def as_dict(self) -> Dict[str, Any]:
        return {
            'start_date': self.start_date,
            'end_date': self.end_date,
            'total_days': self.total_days
        }

class ReportGenerator:
    """Base class for report generation functionality"""
    
    def __init__(self, start_date: date, end_date: date):
        self.date_range = DateRange(
            start_date=start_date,
            end_date=end_date,
            total_days=(end_date - start_date).days + 1
        )
        self.generated_at = timezone.now()

    def get_attendance_stats(self, queryset: Any) -> Dict[str, int]:
        """Calculate attendance statistics for a queryset"""
        return queryset.aggregate(
            total_present=Count('id', filter=Q(first_in_time__isnull=False)),
            total_absent=Count('id', filter=Q(first_in_time__isnull=True)),
            total_late=Count('id', filter=Q(is_late=True))
        )

    def get_leave_stats(self, queryset: Any) -> List[Dict[str, Any]]:
        """Calculate leave statistics for a queryset"""
        return list(queryset.values('leave_type__name').annotate(
            total_days=Count('id'),
            total_employees=Count('employee', distinct=True)
        ))

    def prepare_base_data(self) -> Dict[str, Any]:
        """Prepare common report data"""
        return {
            'period': self.date_range.as_dict,
            'generated_at': self.generated_at
        }

class ReportExporter:
    """Handles report export functionality"""
    
    def __init__(self, output_dir: str):
        self.output_dir = output_dir
        os.makedirs(output_dir, exist_ok=True)

    def save_report(
        self,
        data: Dict[str, Any],
        format_type: str,
        filename: str,
        template_name: Optional[str] = None
    ) -> None:
        """
        Save report in specified format using appropriate handler
        """
        handlers = {
            'html': self._save_html,
            'csv': self._save_csv,
            'json': self._save_json
        }
        
        handler = handlers.get(format_type)
        if not handler:
            raise ValueError(f"Unsupported format: {format_type}")
        
        filepath = os.path.join(self.output_dir, f'{filename}.{format_type}')
        handler(data, filepath, template_name)

    def _save_html(self, data: Dict[str, Any], filepath: str, template_name: str) -> None:
        """Save report as HTML"""
        content = render_to_string(f'attendance/reports/{template_name}', data)
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)

    def _save_csv(self, data: Dict[str, Any], filepath: str, _: str) -> None:
        """Save report as CSV"""
        with open(filepath, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            self._write_csv_data(writer, data)

    def _save_json(self, data: Dict[str, Any], filepath: str, _: str) -> None:
        """Save report as JSON"""
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(
                self._prepare_json_data(data),
                f,
                indent=2,
                cls=DjangoJSONEncoder
            )

    def _write_csv_data(self, writer: csv.writer, data: Dict[str, Any]) -> None:
        """Write report data in CSV format"""
        # Write header
        writer.writerow(['Report Generated:', data['generated_at'].strftime('%Y-%m-%d %H:%M:%S')])
        writer.writerow(['Period:', f"{data['period']['start_date']} to {data['period']['end_date']}"])
        writer.writerow([])

        # Write statistics
        if 'statistics' in data:
            writer.writerow(['Statistics'])
            for key, value in data['statistics'].items():
                if isinstance(value, (int, float)):
                    value = f"{value:.2f}%"
                writer.writerow([key.replace('_', ' ').title(), value])
            writer.writerow([])

        # Write attendance data
        if 'attendance' in data and isinstance(data['attendance'], dict):
            writer.writerow(['Attendance Summary'])
            for key, value in data['attendance'].items():
                if key != 'logs':  # Skip detailed logs
                    writer.writerow([key.replace('_', ' ').title(), value])

    def _prepare_json_data(self, data: Any) -> Any:
        """Prepare data for JSON serialization"""
        if isinstance(data, dict):
            return {k: self._prepare_json_data(v) for k, v in data.items()}
        elif hasattr(data, '_meta'):  # Django model instance
            return {
                field.name: getattr(data, field.name)
                for field in data._meta.fields
            }
        elif isinstance(data, (list, tuple)):
            return [self._prepare_json_data(item) for item in data]
        return data

class Command(BaseCommand):
    help = 'Generate attendance and leave reports for specified period'

    def add_arguments(self, parser):
        parser.add_argument(
            '--report-type',
            type=str,
            choices=['daily', 'weekly', 'monthly', 'custom'],
            default='monthly',
            help='Type of report to generate'
        )
        parser.add_argument(
            '--start-date',
            type=str,
            help='Start date for custom report (YYYY-MM-DD)'
        )
        parser.add_argument(
            '--end-date',
            type=str,
            help='End date for custom report (YYYY-MM-DD)'
        )
        parser.add_argument(
            '--department',
            type=int,
            help='Department ID to filter report'
        )
        parser.add_argument(
            '--employee',
            type=int,
            help='Employee ID to generate individual report'
        )
        parser.add_argument(
            '--format',
            type=str,
            choices=['html', 'csv', 'json'],
            default='html',
            help='Output format for the report'
        )
        parser.add_argument(
            '--output-dir',
            type=str,
            help='Directory to save report files'
        )

    def calculate_date_range(
        self,
        report_type: str,
        start_date: Optional[str] = None,
        end_date: Optional[str] = None
    ) -> DateRange:
        """Calculate start and end dates based on report type"""
        end = timezone.now().date()
        
        if report_type == 'daily':
            start = end
        elif report_type == 'weekly':
            start = end - timedelta(days=7)
        elif report_type == 'monthly':
            start = end.replace(day=1)
        else:  # custom
            try:
                start = datetime.strptime(start_date, '%Y-%m-%d').date()
                end = datetime.strptime(end_date, '%Y-%m-%d').date()
            except (ValueError, TypeError):
                raise ValueError('Invalid date format. Use YYYY-MM-DD')
        
        return DateRange(start, end, (end - start).days + 1)

    def handle(self, *args, **options):
        try:
            # Calculate date range
            date_range = self.calculate_date_range(
                options['report_type'],
                options.get('start_date'),
                options.get('end_date')
            )

            # Initialize report exporter
            exporter = ReportExporter(options.get('output_dir', 'reports'))

            # Generate appropriate report
            if options.get('employee'):
                self._generate_employee_report(
                    options['employee'],
                    date_range,
                    options['format'],
                    exporter
                )
            elif options.get('department'):
                self._generate_department_report(
                    options['department'],
                    date_range,
                    options['format'],
                    exporter
                )
            else:
                self._generate_organization_report(
                    date_range,
                    options['format'],
                    exporter
                )

            self.stdout.write(
                self.style.SUCCESS(
                    f'Successfully generated {options["report_type"]} report(s) '
                    f'in {options["format"]} format'
                )
            )

        except Exception as e:
            logger.error(f'Error generating report: {str(e)}')
            self.stderr.write(f'Error generating report: {str(e)}')
            raise

    def _generate_employee_report(
        self,
        employee_id: int,
        date_range: DateRange,
        format_type: str,
        exporter: ReportExporter
    ) -> None:
        """Generate detailed report for a single employee"""
        employee = Employee.objects.get(id=employee_id)
        
        # Get attendance logs
        attendance_logs = AttendanceLog.objects.filter(
            employee=employee,
            date__range=[date_range.start_date, date_range.end_date]
        ).order_by('date')

        # Calculate attendance statistics
        present_days = attendance_logs.filter(first_in_time__isnull=False).count()
        absent_days = attendance_logs.filter(first_in_time__isnull=True).count()
        late_days = attendance_logs.filter(is_late=True).count()

        # Calculate average arrival time
        avg_arrival = attendance_logs.exclude(
            first_in_time__isnull=True
        ).annotate(
            hour=ExtractHour('first_in_time'),
            minute=ExtractMinute('first_in_time')
        ).aggregate(
            avg_hour=Avg('hour'),
            avg_minute=Avg('minute')
        )

        # Get leave information
        leaves = Leave.objects.filter(
            employee=employee,
            start_date__lte=date_range.end_date,
            end_date__gte=date_range.start_date
        ).select_related('leave_type')

        # Get leave balances
        leave_balances = LeaveBalance.objects.filter(
            employee=employee,
            is_active=True
        ).select_related('leave_type')

        report_data = {
            'employee': employee,
            'period': date_range.as_dict,
            'attendance': {
                'present_days': present_days,
                'absent_days': absent_days,
                'late_days': late_days,
                'attendance_rate': (present_days / date_range.total_days * 100) if date_range.total_days > 0 else 0,
                'avg_arrival_time': (
                    f"{int(avg_arrival['avg_hour'] or 0):02d}:"
                    f"{int(avg_arrival['avg_minute'] or 0):02d}"
                ),
                'logs': attendance_logs
            },
            'leaves': leaves,
            'leave_balances': leave_balances,
            'generated_at': timezone.now()
        }

        filename = f"employee_report_{employee.employee_number}_{date_range.start_date}_{date_range.end_date}"
        exporter.save_report(report_data, format_type, filename, 'employee_report.html')

    def _generate_department_report(
        self,
        department_id: int,
        date_range: DateRange,
        format_type: str,
        exporter: ReportExporter
    ) -> None:
        """Generate summary report for a department"""
        department = Department.objects.get(id=department_id)
        employees = Employee.objects.filter(department=department, is_active=True)

        # Calculate department statistics
        attendance_stats = AttendanceLog.objects.filter(
            employee__department=department,
            date__range=[date_range.start_date, date_range.end_date]
        ).aggregate(
            total_present=Count('id', filter=Q(first_in_time__isnull=False)),
            total_absent=Count('id', filter=Q(first_in_time__isnull=True)),
            total_late=Count('id', filter=Q(is_late=True))
        )

        # Calculate leave statistics
        leave_stats = Leave.objects.filter(
            employee__department=department,
            start_date__lte=date_range.end_date,
            end_date__gte=date_range.start_date,
            status='approved'
        ).values('leave_type__name').annotate(
            total_days=Count('id'),
            total_employees=Count('employee', distinct=True)
        )

        employee_count = employees.count()
        report_data = {
            'department': department,
            'period': date_range.as_dict,
            'statistics': {
                'total_employees': employee_count,
                'present_rate': (attendance_stats['total_present'] / (date_range.total_days * employee_count) * 100) if employee_count > 0 else 0,
                'absent_rate': (attendance_stats['total_absent'] / (date_range.total_days * employee_count) * 100) if employee_count > 0 else 0,
                'late_rate': (attendance_stats['total_late'] / attendance_stats['total_present'] * 100) if attendance_stats['total_present'] > 0 else 0,
            },
            'attendance': attendance_stats,
            'leave_stats': leave_stats,
            'employees': employees,
            'generated_at': timezone.now()
        }

        filename = f"department_report_{department.code}_{date_range.start_date}_{date_range.end_date}"
        exporter.save_report(report_data, format_type, filename, 'department_report.html')

    def _generate_organization_report(
        self,
        date_range: DateRange,
        format_type: str,
        exporter: ReportExporter
    ) -> None:
        """Generate overall organization attendance and leave report"""
        departments = Department.objects.all()

        # Overall statistics
        org_stats = AttendanceLog.objects.filter(
            date__range=[date_range.start_date, date_range.end_date]
        ).aggregate(
            total_present=Count('id', filter=Q(first_in_time__isnull=False)),
            total_absent=Count('id', filter=Q(first_in_time__isnull=True)),
            total_late=Count('id', filter=Q(is_late=True))
        )

        # Department-wise statistics
        dept_stats = []
        for dept in departments:
            stats = AttendanceLog.objects.filter(
                employee__department=dept,
                date__range=[date_range.start_date, date_range.end_date]
            ).aggregate(
                present=Count('id', filter=Q(first_in_time__isnull=False)),
                absent=Count('id', filter=Q(first_in_time__isnull=True)),
                late=Count('id', filter=Q(is_late=True))
            )
            dept_stats.append({
                'department': dept,
                'stats': stats
            })

        # Leave type statistics
        leave_stats = Leave.objects.filter(
            start_date__lte=date_range.end_date,
            end_date__gte=date_range.start_date,
            status='approved'
        ).values('leave_type__name').annotate(
            total_days=Count('id'),
            total_employees=Count('employee', distinct=True)
        )

        report_data = {
            'period': date_range.as_dict,
            'organization': {
                'total_departments': departments.count(),
                'total_employees': Employee.objects.filter(is_active=True).count(),
                'stats': org_stats
            },
            'department_stats': dept_stats,
            'leave_stats': leave_stats,
            'generated_at': timezone.now()
        }

        filename = f"organization_report_{date_range.start_date}_{date_range.end_date}"
        exporter.save_report(report_data, format_type, filename, 'organization_report.html')

```

### 📄 hrms_project\attendance\management\commands\import_attendance.py
```from django.core.management.base import BaseCommand, CommandError
from django.utils import timezone
from django.db import transaction
from employees.models import Employee
from attendance.models import AttendanceRecord
import pandas as pd
import logging
from datetime import datetime
import pytz

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Import attendance records from machine export file (Excel/CSV)'

    def add_arguments(self, parser):
        parser.add_argument('file_path', type=str, help='Path to the input file')
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Run without making changes to see what would happen',
        )
        parser.add_argument(
            '--format',
            choices=['excel', 'csv'],
            default='excel',
            help='Input file format (default: excel)',
        )
        parser.add_argument(
            '--timezone',
            default='Asia/Riyadh',
            help='Timezone for timestamps (default: Asia/Riyadh)',
        )
        parser.add_argument(
            '--skip-rows',
            type=int,
            default=0,
            help='Number of header rows to skip',
        )

    def handle(self, *args, **options):
        file_path = options['file_path']
        dry_run = options['dry_run']
        file_format = options['format']
        tz = pytz.timezone(options['timezone'])
        skip_rows = options['skip_rows']

        self.stdout.write(
            self.style.SUCCESS(f'Starting attendance import from {file_path}')
        )
        if dry_run:
            self.stdout.write(
                self.style.WARNING('DRY RUN - no changes will be made')
            )

        try:
            # Read the file
            if file_format == 'excel':
                df = pd.read_excel(file_path, skiprows=skip_rows)
            else:
                df = pd.read_csv(file_path, skiprows=skip_rows)

            # Expected columns with possible variations
            employee_id_cols = ['Personnel ID', 'Employee ID', 'ID', 'Badge']
            timestamp_cols = ['Date And Time', 'DateTime', 'Timestamp', 'Time']
            device_cols = ['Device Name', 'Device', 'Terminal']
            event_cols = ['Event Point', 'Event', 'Type']

            # Find actual column names in the file
            employee_id_col = next((col for col in employee_id_cols if col in df.columns), None)
            timestamp_col = next((col for col in timestamp_cols if col in df.columns), None)
            device_col = next((col for col in device_cols if col in df.columns), None)
            event_col = next((col for col in event_cols if col in df.columns), None)

            if not all([employee_id_col, timestamp_col]):
                raise CommandError('Required columns not found in the file')

            records_created = 0
            duplicates = 0
            errors = 0

            with transaction.atomic():
                for _, row in df.iterrows():
                    try:
                        # Get employee
                        employee_number = str(row[employee_id_col]).strip()
                        try:
                            employee = Employee.objects.get(employee_number=employee_number)
                        except Employee.DoesNotExist:
                            self.stdout.write(
                                self.style.WARNING(
                                    f'Employee not found: {employee_number}'
                                )
                            )
                            errors += 1
                            continue

                        # Parse timestamp
                        try:
                            timestamp = pd.to_datetime(row[timestamp_col])
                            timestamp = tz.localize(timestamp.replace(tzinfo=None))
                        except Exception as e:
                            self.stdout.write(
                                self.style.ERROR(
                                    f'Invalid timestamp for {employee_number}: {str(e)}'
                                )
                            )
                            errors += 1
                            continue

                        # Check for duplicate record
                        if AttendanceRecord.objects.filter(
                            employee=employee,
                            timestamp=timestamp,
                            is_active=True
                        ).exists():
                            duplicates += 1
                            continue

                        # Create attendance record
                        if not dry_run:
                            record = AttendanceRecord.objects.create(
                                employee=employee,
                                timestamp=timestamp,
                                device_name=row.get(device_col, ''),
                                event_point=row.get(event_col, ''),
                                source='import'
                            )
                            records_created += 1

                    except Exception as e:
                        self.stdout.write(
                            self.style.ERROR(f'Error processing row: {str(e)}')
                        )
                        logger.error(f'Import error: {str(e)}', exc_info=True)
                        errors += 1
                        if not dry_run:
                            raise

                if dry_run:
                    transaction.set_rollback(True)
                    self.stdout.write(
                        self.style.SUCCESS(
                            f'Dry run completed - would create {records_created} records\n'
                            f'Duplicates: {duplicates}\n'
                            f'Errors: {errors}'
                        )
                    )
                else:
                    self.stdout.write(
                        self.style.SUCCESS(
                            f'Successfully created {records_created} records\n'
                            f'Duplicates: {duplicates}\n'
                            f'Errors: {errors}'
                        )
                    )

        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Error importing attendance records: {str(e)}')
            )
            logger.error(f'Attendance import failed: {str(e)}', exc_info=True)
            raise CommandError(str(e))

```

### 📄 hrms_project\attendance\management\commands\init_leave_types.py
```from django.core.management.base import BaseCommand
from django.db import transaction
from attendance.models import LeaveType
import logging
import json

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Initialize default leave types with standard configurations'

    def add_arguments(self, parser):
        parser.add_argument(
            '--force',
            action='store_true',
            help='Force creation even if leave types exist',
        )

    def handle(self, *args, **options):
        force = options['force']

        # Check if leave types already exist
        if LeaveType.objects.exists():
            if force:
                # Delete existing leave types when using --force
                self.stdout.write(
                    self.style.WARNING('Deleting existing leave types...')
                )
                LeaveType.objects.all().delete()
            else:
                self.stdout.write(
                    self.style.WARNING(
                        'Leave types already exist. Use --force to reinitialize.'
                    )
                )
                return

        try:
            with transaction.atomic():
                # Define default leave types
                leave_types = [
                    {
                        'code': 'ANNUAL',
                        'name': 'Annual Leave',
                        'description': 'Standard annual leave with full day and half day options',
                        'category': 'REGULAR',
                        'days_allowed': 30,
                        'is_paid': True,
                        'requires_document': False,
                        'gender_specific': 'A',
                        'accrual_enabled': True,
                        'accrual_days': 2.5,
                        'accrual_period': 'MONTHLY',
                        'reset_period': 'YEARLY',
                        'balance_calculation': 'ACCRUAL',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': False,
                            'min_days': 0.5,
                            'max_days': 30
                        })
                    },
                    {
                        'code': 'EMERG',
                        'name': 'Emergency Leave',
                        'description': 'For emergency situations requiring immediate leave (employer discretion)',
                        'category': 'SPECIAL',
                        'days_allowed': 5,
                        'is_paid': True,
                        'requires_document': False,
                        'gender_specific': 'A',
                        'accrual_enabled': False,
                        'reset_period': 'YEARLY',
                        'balance_calculation': 'FIXED',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': False,
                            'min_days': 0.5,
                            'max_days': 5
                        })
                    },
                    {
                        'code': 'HALF',
                        'name': 'Half Day Leave',
                        'description': 'Half day leave options for morning or afternoon',
                        'category': 'REGULAR',
                        'days_allowed': 0,
                        'is_paid': True,
                        'requires_document': False,
                        'gender_specific': 'A',
                        'accrual_enabled': False,
                        'reset_period': 'YEARLY',
                        'balance_calculation': 'SHARED',
                        'shared_balance_with': 'ANNUAL',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': True,
                            'fixed_duration': 0.5
                        })
                    },
                    {
                        'code': 'INJURY',
                        'name': 'Injury Leave',
                        'description': 'Leave for work-related injuries as per Social Insurance Law, Legislative Decree No.(24) of 1976',
                        'category': 'MEDICAL',
                        'days_allowed': 180,
                        'is_paid': True,
                        'requires_document': True,
                        'gender_specific': 'A',
                        'accrual_enabled': False,
                        'reset_period': 'NEVER',
                        'balance_calculation': 'FIXED',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': False,
                            'min_days': 1,
                            'max_days': 180
                        })
                    },
                    {
                        'code': 'MARRIAGE',
                        'name': 'Marriage Leave',
                        'description': 'Leave for employee marriage (Article 4)',
                        'category': 'SPECIAL',
                        'days_allowed': 3,
                        'is_paid': True,
                        'requires_document': True,
                        'gender_specific': 'A',
                        'accrual_enabled': False,
                        'reset_period': 'NEVER',
                        'balance_calculation': 'FIXED',
                        'validation_rules': json.dumps({
                            'is_one_time': True,
                            'has_fixed_duration': True,
                            'fixed_duration': 3
                        })
                    },
                    {
                        'code': 'MATERNITY',
                        'name': 'Maternity Leave',
                        'description': 'Maternity leave for female employees (Article 34). 60 days paid + 15 days unpaid',
                        'category': 'SPECIAL',
                        'days_allowed': 75,
                        'is_paid': True,
                        'requires_document': True,
                        'gender_specific': 'F',
                        'accrual_enabled': False,
                        'reset_period': 'EVENT',
                        'balance_calculation': 'FIXED',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': True,
                            'fixed_duration': 75,
                            'sub_types': [
                                {'code': 'paid_60', 'days': 60, 'paid': True},
                                {'code': 'unpaid_15', 'days': 15, 'paid': False}
                            ]
                        })
                    },
                    {
                        'code': 'PATERNITY',
                        'name': 'Paternity Leave',
                        'description': 'Paternity leave for male employees (Article 4)',
                        'category': 'SPECIAL',
                        'days_allowed': 1,
                        'is_paid': True,
                        'requires_document': True,
                        'gender_specific': 'M',
                        'accrual_enabled': False,
                        'reset_period': 'EVENT',
                        'balance_calculation': 'FIXED',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': True,
                            'fixed_duration': 1
                        })
                    },
                    {
                        'code': 'PERMISSION',
                        'name': 'Permission Leave',
                        'description': 'Short duration leave with employer discretion',
                        'category': 'REGULAR',
                        'days_allowed': 3,
                        'is_paid': True,
                        'requires_document': False,
                        'gender_specific': 'A',
                        'accrual_enabled': False,
                        'reset_period': 'YEARLY',
                        'balance_calculation': 'FIXED',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': False,
                            'min_days': 0.5,
                            'max_days': 3
                        })
                    },
                    {
                        'code': 'DEATH',
                        'name': 'Relative Death Leave',
                        'description': 'Compassionate leave for death of relatives (Article 4). 30 days for widow, 3 days for others',
                        'category': 'SPECIAL',
                        'days_allowed': 30,
                        'is_paid': True,
                        'requires_document': True,
                        'gender_specific': 'A',
                        'accrual_enabled': False,
                        'reset_period': 'EVENT',
                        'balance_calculation': 'FIXED',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': True,
                            'sub_types': [
                                {'code': 'spouse_30', 'days': 30, 'description': "Woman's Husband"},
                                {'code': 'spouse_3', 'days': 3, 'description': "Man's Wife"},
                                {'code': 'first_degree', 'days': 3, 'description': 'First Degree Relative'},
                                {'code': 'second_degree', 'days': 3, 'description': 'Second Degree Spouse Relative'}
                            ]
                        })
                    },
                    {
                        'code': 'SICK',
                        'name': 'Sick Leave',
                        'description': 'Sick leave with three tiers (Article 56). 15 days full pay, 20 days half pay, 20 days unpaid',
                        'category': 'MEDICAL',
                        'days_allowed': 55,
                        'is_paid': True,
                        'requires_document': True,
                        'gender_specific': 'A',
                        'accrual_enabled': False,
                        'reset_period': 'YEARLY',
                        'balance_calculation': 'TIERED',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': False,
                            'tiers': [
                                {'name': 'Full Pay', 'days': 15, 'pay_percentage': 100},
                                {'name': 'Half Pay', 'days': 20, 'pay_percentage': 50},
                                {'name': 'No Pay', 'days': 20, 'pay_percentage': 0}
                            ]
                        })
                    },
                    {
                        'code': 'HAJJ',
                        'name': 'Hajj Leave',
                        'description': 'Leave for performing Hajj pilgrimage (Article 61)',
                        'category': 'SPECIAL',
                        'days_allowed': 14,
                        'is_paid': True,
                        'requires_document': True,
                        'gender_specific': 'A',
                        'accrual_enabled': False,
                        'reset_period': 'NEVER',
                        'balance_calculation': 'FIXED',
                        'validation_rules': json.dumps({
                            'is_one_time': True,
                            'has_fixed_duration': True,
                            'fixed_duration': 14
                        })
                    },
                    {
                        'code': 'IDDAH',
                        'name': 'Iddah Leave',
                        'description': 'Iddah leave for Muslim female employees (Article 35). 30 days paid + 100 days unpaid',
                        'category': 'SPECIAL',
                        'days_allowed': 130,
                        'is_paid': True,
                        'requires_document': True,
                        'gender_specific': 'F',
                        'accrual_enabled': False,
                        'reset_period': 'EVENT',
                        'balance_calculation': 'FIXED',
                        'validation_rules': json.dumps({
                            'is_one_time': False,
                            'has_fixed_duration': True,
                            'sub_types': [
                                {'code': 'paid_30', 'days': 30, 'paid': True},
                                {'code': 'unpaid_100', 'days': 100, 'paid': False}
                            ]
                        })
                    }
                ]

                # Create leave types
                for leave_type_data in leave_types:
                    # Handle shared balance reference
                    shared_balance_with = leave_type_data.pop('shared_balance_with', None)
                    leave_type = LeaveType.objects.create(**leave_type_data)
                    
                    # Update shared balance reference after all types are created
                    if shared_balance_with:
                        try:
                            referenced_type = LeaveType.objects.get(code=shared_balance_with)
                            leave_type.shared_balance_with = referenced_type
                            leave_type.save()
                        except LeaveType.DoesNotExist:
                            logger.warning(f"Referenced leave type {shared_balance_with} not found for {leave_type.code}")

                self.stdout.write(
                    self.style.SUCCESS('Successfully initialized leave types')
                )

        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Failed to initialize leave types: {str(e)}')
            )
            raise e

```

### 📄 hrms_project\attendance\management\commands\init_ramadan_periods.py
```import logging
from datetime import date
from typing import Dict, Any, Tuple, List
from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone

from attendance.models import RamadanPeriod
from attendance.services.ramadan_service import RamadanService

logger = logging.getLogger(__name__)

# Sample Ramadan periods for the next few years
# Dates are approximate and should be adjusted based on actual calendar
SAMPLE_PERIODS = [
    {
        'year': 2024,
        'start_date': date(2024, 3, 11),
        'end_date': date(2024, 4, 9),
        'is_active': True,
    },
    {
        'year': 2025,
        'start_date': date(2025, 3, 1),
        'end_date': date(2025, 3, 30),
        'is_active': False,
    },
    {
        'year': 2026,
        'start_date': date(2026, 2, 18),
        'end_date': date(2026, 3, 19),
        'is_active': False,
    }
]

class RamadanPeriodInitializer:
    """Handles Ramadan period initialization logic"""
    
    def __init__(self, command_instance: BaseCommand):
        self.command = command_instance
        self.ramadan_service = RamadanService()
        self.created_count = 0
        self.updated_count = 0
        self.skipped_count = 0

    def process_period(self, period_data: Dict[str, Any], force: bool = False) -> None:
        """
        Process a single Ramadan period - create, update, or skip based on force flag.
        
        Args:
            period_data: Dictionary containing period data
            force: Whether to force update existing periods
        """
        year = period_data['year']
        
        try:
            # Validate period dates using RamadanService
            self.ramadan_service.validate_period_dates(
                period_data['start_date'],
                period_data['end_date']
            )
            
            # Add timestamps
            period_data = {
                **period_data,
                'created_at': timezone.now(),
                'updated_at': timezone.now()
            }
            
            if force:
                self._update_or_create_period(year, period_data)
            else:
                self._create_if_not_exists(year, period_data)
                
        except Exception as e:
            self.command.stderr.write(
                self.command.style.ERROR(f'Error processing period for {year}: {str(e)}')
            )
            logger.error(f'Error processing Ramadan period for {year}', exc_info=True)

    def _update_or_create_period(self, year: int, period_data: Dict[str, Any]) -> None:
        """Update existing period or create new one"""
        period, created = RamadanPeriod.objects.update_or_create(
            year=year,
            defaults=period_data
        )
        
        if created:
            self.created_count += 1
            self.command.stdout.write(
                self.command.style.SUCCESS(f'Created Ramadan period for {year}')
            )
        else:
            self.updated_count += 1
            self.command.stdout.write(
                self.command.style.WARNING(f'Updated Ramadan period for {year}')
            )

    def _create_if_not_exists(self, year: int, period_data: Dict[str, Any]) -> None:
        """Create period only if it doesn't exist"""
        if not RamadanPeriod.objects.filter(year=year).exists():
            RamadanPeriod.objects.create(**period_data)
            self.created_count += 1
            self.command.stdout.write(
                self.command.style.SUCCESS(f'Created Ramadan period for {year}')
            )
        else:
            self.skipped_count += 1
            self.command.stdout.write(
                self.command.style.WARNING(f'Skipped existing period for {year}')
            )

    def print_summary(self, force: bool) -> None:
        """Print summary of operations performed"""
        self.command.stdout.write('\nSummary:')
        self.command.stdout.write(f'Created: {self.created_count}')
        if force:
            self.command.stdout.write(f'Updated: {self.updated_count}')
        else:
            self.command.stdout.write(f'Skipped: {self.skipped_count}')
        self.command.stdout.write(
            self.command.style.SUCCESS('Successfully initialized Ramadan periods')
        )

class Command(BaseCommand):
    help = 'Initialize sample Ramadan periods in the system'

    def add_arguments(self, parser):
        parser.add_argument(
            '--force',
            action='store_true',
            help='Force recreation of Ramadan periods even if they exist',
        )

    def handle(self, *args, **options):
        try:
            initializer = RamadanPeriodInitializer(self)
            
            with transaction.atomic():
                # Process each period
                for period_data in SAMPLE_PERIODS:
                    initializer.process_period(period_data, options['force'])
                
                # Print summary
                initializer.print_summary(options['force'])

        except Exception as e:
            self.stderr.write(
                self.style.ERROR(f'Error initializing Ramadan periods: {str(e)}')
            )
            logger.error('Error in init_ramadan_periods command', exc_info=True)

```

### 📄 hrms_project\attendance\management\commands\init_shift_types.py
```import logging
from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone
from datetime import time

from attendance.models import Shift

logger = logging.getLogger(__name__)

DEFAULT_SHIFTS = [
    {
        'name': 'Default Shift',
        'shift_type': 'DEFAULT',
        'start_time': time(7, 0),        # Current timing
        'end_time': time(16, 0),         # Current timing
        'default_start_time': time(7, 0), # Default timing
        'default_end_time': time(16, 0),  # Default timing
        'break_duration': 60,
        'grace_period': 15
    },
    {
        'name': 'Open Shift',
        'shift_type': 'OPEN',
        'start_time': time(8, 0),        # Current timing
        'end_time': time(17, 0),         # Current timing
        'default_start_time': time(8, 0), # Default timing
        'default_end_time': time(17, 0),  # Default timing
        'break_duration': 60,
        'grace_period': 15
    },
    {
        'name': 'Night Shift Default',
        'shift_type': 'NIGHT',
        'start_time': time(18, 0),        # Current timing
        'end_time': time(3, 0),          # Current timing
        'default_start_time': time(18, 0), # Default timing
        'default_end_time': time(3, 0),    # Default timing
        'break_duration': 60,
        'grace_period': 15
    }
]

class Command(BaseCommand):
    help = 'Initialize default shift types in the system'

    def add_arguments(self, parser):
        parser.add_argument(
            '--force',
            action='store_true',
            help='Force recreation of shift types even if they exist',
        )

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                created_count = 0
                updated_count = 0
                skipped_count = 0

                for shift_data in DEFAULT_SHIFTS:
                    shift_name = shift_data['name']
                    
                    if options['force']:
                        # Update or create
                        shift, created = Shift.objects.update_or_create(
                            name=shift_name,
                            defaults={
                                **shift_data,
                                'created_at': timezone.now(),
                                'updated_at': timezone.now()
                            }
                        )
                        if created:
                            created_count += 1
                            self.stdout.write(
                                self.style.SUCCESS(f'Created shift: {shift_name}')
                            )
                        else:
                            updated_count += 1
                            self.stdout.write(
                                self.style.WARNING(f'Updated shift: {shift_name}')
                            )
                    else:
                        # Only create if doesn't exist
                        if not Shift.objects.filter(name=shift_name).exists():
                            Shift.objects.create(
                                **shift_data,
                                created_at=timezone.now(),
                                updated_at=timezone.now()
                            )
                            created_count += 1
                            self.stdout.write(
                                self.style.SUCCESS(f'Created shift: {shift_name}')
                            )
                        else:
                            skipped_count += 1
                            self.stdout.write(
                                self.style.WARNING(f'Skipped existing shift: {shift_name}')
                            )

                # Print summary
                self.stdout.write('\nSummary:')
                self.stdout.write(f'Created: {created_count}')
                if options['force']:
                    self.stdout.write(f'Updated: {updated_count}')
                else:
                    self.stdout.write(f'Skipped: {skipped_count}')
                self.stdout.write(
                    self.style.SUCCESS('Successfully initialized shift types')
                )

        except Exception as e:
            self.stderr.write(
                self.style.ERROR(f'Error initializing shift types: {str(e)}')
            )
            logger.error('Error in init_shift_types command', exc_info=True)

```

### 📄 hrms_project\attendance\management\commands\recalculate_leave_balance.py
```from django.core.management.base import BaseCommand, CommandError
from django.utils import timezone
from django.db import transaction
from django.db.models import QuerySet
from employees.models import Employee
from attendance.models import LeaveType, LeaveBalance
from attendance.services import LeaveBalanceService
import logging
from datetime import datetime, date
from calendar import monthrange
from decimal import Decimal
from typing import Optional, List, TextIO, Tuple

logger = logging.getLogger(__name__)

class LeaveBalanceProcessor:
    """Handles leave balance processing operations"""
    
    @staticmethod
    def get_employees(employee_id: Optional[int] = None) -> QuerySet[Employee]:
        """
        Get employees to process based on filter criteria.
        
        Args:
            employee_id: Optional ID to filter specific employee
            
        Returns:
            QuerySet of employees
            
        Raises:
            CommandError: If no employees found
        """
        employees = Employee.objects.filter(is_active=True)
        if employee_id:
            employees = employees.filter(id=employee_id)
            
        if not employees.exists():
            raise CommandError('No employees found')
            
        return employees
    
    @staticmethod
    def get_leave_types(leave_type_code: Optional[str] = None) -> QuerySet[LeaveType]:
        """
        Get leave types to process based on filter criteria.
        
        Args:
            leave_type_code: Optional code to filter specific leave type
            
        Returns:
            QuerySet of leave types
            
        Raises:
            CommandError: If no leave types found
        """
        leave_types = LeaveType.objects.filter(is_active=True)
        if leave_type_code:
            leave_types = leave_types.filter(code=leave_type_code.upper())
            
        if not leave_types.exists():
            raise CommandError('No leave types found')
            
        return leave_types

class LeaveBalanceFormatter:
    """Handles formatting and output of leave balance information"""
    
    def __init__(self, stdout: TextIO):
        self.stdout = stdout
    
    def print_processing_start(self, month: int, year: int) -> None:
        """Print processing start message"""
        self.stdout.write(
            self.style_success(
                f'Starting leave balance recalculation for {month:02d}/{year}'
            )
        )
    
    def print_employee_header(self, employee: Employee) -> None:
        """Print employee processing header"""
        self.stdout.write(
            f'\nProcessing {employee.get_full_name()}:'
        )
    
    def print_leave_type_header(self, leave_type: LeaveType) -> None:
        """Print leave type processing header"""
        self.stdout.write(
            f'  Leave Type: {leave_type.name}'
        )
    
    def print_balance_details(self, balance: LeaveBalance) -> None:
        """
        Print formatted balance details.
        
        Args:
            balance: LeaveBalance instance to format and print
        """
        available = balance.total_days - balance.used_days - balance.pending_days
        
        self.stdout.write(
            f'    Total Days: {float(balance.total_days):.2f}\n'
            f'    Used Days: {float(balance.used_days):.2f}\n'
            f'    Pending Days: {float(balance.pending_days):.2f}\n'
            f'    Available Days: {float(available):.2f}'
        )
    
    def print_completion(self) -> None:
        """Print completion message"""
        self.stdout.write(
            self.style_success('Leave balances recalculated successfully')
        )
    
    @staticmethod
    def style_success(message: str) -> str:
        """Style success messages consistently"""
        return f'\033[92m{message}\033[0m'  # Green text

class Command(BaseCommand):
    help = 'Recalculate leave balances for a given month/year'

    def add_arguments(self, parser):
        parser.add_argument(
            '--month',
            type=int,
            required=True,
            help='Month to process (1-12)',
        )
        parser.add_argument(
            '--year',
            type=int,
            required=True,
            help='Year to process',
        )
        parser.add_argument(
            '--employee',
            type=int,
            help='Employee ID to process (optional)',
        )
        parser.add_argument(
            '--leave-type',
            help='Leave type code to process (optional)',
        )

    def handle(self, *args, **options):
        try:
            month = options['month']
            year = options['year']
            
            # Validate month
            if not 1 <= month <= 12:
                raise CommandError('Month must be between 1 and 12')
            
            # Initialize processors
            processor = LeaveBalanceProcessor()
            formatter = LeaveBalanceFormatter(self.stdout)
            
            # Get employees and leave types
            employees = processor.get_employees(options.get('employee'))
            leave_types = processor.get_leave_types(options.get('leave_type'))
            
            # Start processing
            formatter.print_processing_start(month, year)
            
            with transaction.atomic():
                for employee in employees:
                    formatter.print_employee_header(employee)
                    
                    for leave_type in leave_types:
                        formatter.print_leave_type_header(leave_type)
                        
                        # Calculate balance
                        balance = LeaveBalanceService.recalculate_balance(
                            employee=employee,
                            leave_type=leave_type,
                            month=month,
                            year=year
                        )
                        
                        # Print results
                        formatter.print_balance_details(balance)
            
            formatter.print_completion()
            
        except Exception as e:
            logger.error(f'Leave balance recalculation failed: {str(e)}', exc_info=True)
            raise CommandError(str(e))

```

### 📄 hrms_project\attendance\management\commands\reprocess_attendance.py
```from django.core.management.base import BaseCommand, CommandError
from django.utils import timezone
from datetime import datetime
from attendance.models import AttendanceLog
from attendance.services.attendance_status_service import AttendanceStatusService

class Command(BaseCommand):
    help = 'Recalculate attendance status for existing AttendanceLogs'

    def add_arguments(self, parser):
        parser.add_argument('--date', type=str, help='Process logs for a specific date (YYYY-MM-DD)')
        parser.add_argument('--date-range', nargs=2, type=str, help='Process logs for a date range (YYYY-MM-DD YYYY-MM-DD)')
        parser.add_argument('--employee-id', type=int, help='Process logs for a specific employee ID')

    def handle(self, *args, **options):
        queryset = AttendanceLog.objects.all()
        processed = 0
        errors = 0

        try:
            # Filter by date if specified
            if options['date']:
                try:
                    process_date = datetime.strptime(options['date'], '%Y-%m-%d').date()
                    queryset = queryset.filter(date=process_date)
                    self.stdout.write(f'Filtering logs for date: {process_date}')
                except ValueError:
                    raise CommandError('Invalid date format. Use YYYY-MM-DD')

            # Filter by date range if specified
            elif options['date_range']:
                try:
                    start_date = datetime.strptime(options['date_range'][0], '%Y-%m-%d').date()
                    end_date = datetime.strptime(options['date_range'][1], '%Y-%m-%d').date()
                    if start_date > end_date:
                        raise CommandError('Start date must be before end date')
                    queryset = queryset.filter(date__range=[start_date, end_date])
                    self.stdout.write(f'Filtering logs between {start_date} and {end_date}')
                except ValueError:
                    raise CommandError('Invalid date format in range. Use YYYY-MM-DD')

            # Filter by employee if specified
            if options['employee_id']:
                queryset = queryset.filter(employee_id=options['employee_id'])
                self.stdout.write(f'Filtering logs for employee ID: {options["employee_id"]}')

            total_logs = queryset.count()
            if total_logs == 0:
                self.stdout.write(self.style.WARNING('No attendance logs found matching the criteria'))
                return

            self.stdout.write(f'Found {total_logs} attendance logs to process')
            self.stdout.write('Starting reprocessing...')

            # Process each log
            for log in queryset:
                try:
                    self.stdout.write(f'Processing log ID {log.id} for {log.date}...', ending='\r')
                    AttendanceStatusService.update_attendance_status(log)
                    processed += 1
                except Exception as e:
                    self.stderr.write(f'\nError processing log ID {log.id}: {str(e)}')
                    errors += 1

            # Summary
            self.stdout.write('\n' + self.style.SUCCESS(f'Successfully processed {processed} attendance logs'))
            if errors > 0:
                self.stdout.write(self.style.WARNING(f'Encountered {errors} errors during processing'))

        except Exception as e:
            raise CommandError(f'An error occurred: {str(e)}')

```

### 📄 hrms_project\attendance\management\commands\reset_annual_leave.py
```import logging
from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone
from django.db.models import F
from attendance.models import LeaveType, LeaveBalance, LeaveTransaction
from employees.models import Employee

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Reset leave balances for fixed-allowance leave types at the start of a new year'

    def add_arguments(self, parser):
        parser.add_argument(
            '--year',
            type=int,
            help='Specify year to reset balances for (defaults to current year)'
        )
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Simulate the reset without making actual changes'
        )

    def handle(self, *args, **options):
        year = options.get('year') or timezone.now().year
        dry_run = options.get('dry_run', False)

        if dry_run:
            self.stdout.write(self.style.WARNING('Running in dry-run mode - no changes will be made'))

        try:
            with transaction.atomic():
                # Get all active employees
                employees = Employee.objects.filter(is_active=True)
                self.stdout.write(f'Found {employees.count()} active employees')

                # Get leave types that need annual reset
                leave_types = LeaveType.objects.filter(
                    is_active=True,
                    rules__accrual_type='FIXED',
                    rules__reset_period='YEARLY'
                ).select_related('rules')

                self.stdout.write(f'Found {leave_types.count()} leave types to reset')

                balances_reset = 0
                balances_archived = 0

                for leave_type in leave_types:
                    self.stdout.write(f'\nProcessing {leave_type.name}:')
                    allowed_days = leave_type.rules.days_allowed

                    for employee in employees:
                        # Get current balance
                        try:
                            current_balance = LeaveBalance.objects.get(
                                employee=employee,
                                leave_type=leave_type
                            )

                            # Archive old balance if it exists and has transactions
                            if LeaveTransaction.objects.filter(
                                leave_balance=current_balance,
                                transaction_date__year=year-1
                            ).exists():
                                if not dry_run:
                                    LeaveBalance.objects.create(
                                        employee=employee,
                                        leave_type=leave_type,
                                        year=year-1,
                                        initial_balance=current_balance.initial_balance,
                                        current_balance=current_balance.current_balance,
                                        is_archived=True
                                    )
                                balances_archived += 1

                            # Reset balance to allowed days
                            if not dry_run:
                                current_balance.initial_balance = allowed_days
                                current_balance.current_balance = allowed_days
                                current_balance.year = year
                                current_balance.last_reset = timezone.now()
                                current_balance.save()

                                # Create reset transaction
                                LeaveTransaction.objects.create(
                                    leave_balance=current_balance,
                                    transaction_type='RESET',
                                    days=allowed_days,
                                    balance_after=allowed_days,
                                    description=f'Annual reset for {year}',
                                    transaction_date=timezone.now()
                                )
                            balances_reset += 1

                        except LeaveBalance.DoesNotExist:
                            # Create new balance if it doesn't exist
                            if not dry_run:
                                balance = LeaveBalance.objects.create(
                                    employee=employee,
                                    leave_type=leave_type,
                                    year=year,
                                    initial_balance=allowed_days,
                                    current_balance=allowed_days,
                                    last_reset=timezone.now()
                                )
                                LeaveTransaction.objects.create(
                                    leave_balance=balance,
                                    transaction_type='INITIAL',
                                    days=allowed_days,
                                    balance_after=allowed_days,
                                    description=f'Initial balance for {year}',
                                    transaction_date=timezone.now()
                                )
                            balances_reset += 1

                if not dry_run:
                    transaction.commit()
                    self.stdout.write(self.style.SUCCESS(
                        f'\nSuccessfully reset {balances_reset} balances and archived {balances_archived} old balances'
                    ))
                else:
                    self.stdout.write(self.style.WARNING(
                        f'\nDry run complete: Would reset {balances_reset} balances and archive {balances_archived} old balances'
                    ))

        except Exception as e:
            logger.error(f'Error resetting leave balances: {str(e)}')
            self.stdout.write(self.style.ERROR(f'Error resetting leave balances: {str(e)}'))
            if not dry_run:
                transaction.rollback()
            raise

    def _log_employee_balance(self, employee, leave_type, old_balance, new_balance):
        """Helper to log balance changes for auditing"""
        logger.info(
            f'Employee: {employee.employee_number} - {employee.get_full_name()}\n'
            f'Leave Type: {leave_type.name}\n'
            f'Old Balance: {old_balance}\n'
            f'New Balance: {new_balance}\n'
            f'Timestamp: {timezone.now()}\n'
            f'{"-"*50}'
        )

```

### 📄 hrms_project\attendance\management\commands\year_end_processing.py
```from django.core.management.base import BaseCommand, CommandError
from django.utils import timezone
from django.db import transaction
from django.core.management import call_command
import logging
from datetime import datetime, date

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Perform end-of-year processing tasks for attendance management'

    def add_arguments(self, parser):
        parser.add_argument(
            '--year',
            type=int,
            help='Year to process (defaults to current year)',
        )
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Run without making changes to see what would happen',
        )
        parser.add_argument(
            '--skip-reset',
            action='store_true',
            help='Skip leave balance reset',
        )
        parser.add_argument(
            '--skip-holidays',
            action='store_true',
            help='Skip holiday generation',
        )
        parser.add_argument(
            '--skip-archive',
            action='store_true',
            help='Skip record archiving',
        )
        parser.add_argument(
            '--force',
            action='store_true',
            help='Force processing even if not December',
        )

    def handle(self, *args, **options):
        year = options['year'] or timezone.now().year
        dry_run = options['dry_run']
        skip_reset = options['skip_reset']
        skip_holidays = options['skip_holidays']
        skip_archive = options['skip_archive']
        force = options['force']

        # Check if it's December or force flag is set
        if timezone.now().month != 12 and not force:
            self.stdout.write(
                self.style.WARNING(
                    'Year-end processing should be run in December. '
                    'Use --force to override.'
                )
            )
            return

        try:
            with transaction.atomic():
                self.stdout.write(
                    self.style.SUCCESS(
                        f'Starting year-end processing for {year}'
                    )
                )

                if not skip_reset:
                    self.stdout.write('Resetting leave balances...')
                    try:
                        if not dry_run:
                            call_command('reset_annual_leave', year=year + 1)
                        self.stdout.write('Leave balances reset complete')
                    except Exception as e:
                        self.stdout.write(
                            self.style.ERROR(f'Error resetting leave balances: {str(e)}')
                        )
                        raise

                if not skip_holidays:
                    self.stdout.write('Generating holidays for next year...')
                    try:
                        if not dry_run:
                            call_command('generate_holidays', year=year + 1, force=True)
                        self.stdout.write('Holiday generation complete')
                    except Exception as e:
                        self.stdout.write(
                            self.style.ERROR(f'Error generating holidays: {str(e)}')
                        )
                        raise

                if not skip_archive:
                    self.stdout.write('Archiving old records...')
                    try:
                        if not dry_run:
                            self._archive_old_records(year)
                        self.stdout.write('Record archiving complete')
                    except Exception as e:
                        self.stdout.write(
                            self.style.ERROR(f'Error archiving records: {str(e)}')
                        )
                        raise

                # Generate year-end reports
                self.stdout.write('Generating year-end reports...')
                try:
                    if not dry_run:
                        self._generate_year_end_reports(year)
                    self.stdout.write('Report generation complete')
                except Exception as e:
                    self.stdout.write(
                        self.style.ERROR(f'Error generating reports: {str(e)}')
                    )
                    raise

                if dry_run:
                    transaction.set_rollback(True)
                    self.stdout.write(
                        self.style.SUCCESS('Dry run completed successfully')
                    )
                else:
                    self.stdout.write(
                        self.style.SUCCESS('Year-end processing completed successfully')
                    )

        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Year-end processing failed: {str(e)}')
            )
            logger.error(f'Year-end processing failed: {str(e)}', exc_info=True)
            raise CommandError(str(e))

    def _archive_old_records(self, year):
        """Archive old attendance records and logs"""
        from attendance.models import (
            AttendanceRecord, AttendanceLog, Leave, 
            LeaveBalance, Holiday
        )
        
        year_start = date(year, 1, 1)
        year_end = date(year, 12, 31)

        # Archive attendance records
        AttendanceRecord.objects.filter(
            timestamp__year=year,
            is_active=True
        ).update(
            is_active=False,
            archived_at=timezone.now()
        )

        # Archive attendance logs
        AttendanceLog.objects.filter(
            date__year=year,
            is_active=True
        ).update(
            is_active=False,
            archived_at=timezone.now()
        )

        # Archive completed leaves
        Leave.objects.filter(
            end_date__year=year,
            status__in=['approved', 'rejected', 'cancelled'],
            is_active=True
        ).update(
            is_active=False,
            archived_at=timezone.now()
        )

        # Archive old leave balances
        LeaveBalance.objects.filter(
            year=year,
            is_active=True
        ).update(
            is_active=False,
            archived_at=timezone.now()
        )

        # Archive past holidays
        Holiday.objects.filter(
            date__year=year,
            is_recurring=False,
            is_active=True
        ).update(
            is_active=False,
            archived_at=timezone.now()
        )

    def _generate_year_end_reports(self, year):
        """Generate comprehensive year-end reports"""
        from employees.models import Department

        # Generate overall attendance report
        call_command('generate_report', 
            year=year,
            format='excel',
            output=f'reports/year_end_{year}/attendance_summary_{year}.xlsx'
        )

        # Generate department-wise reports
        departments = Department.objects.filter(is_active=True)
        for dept in departments:
            call_command('generate_report',
                year=year,
                department=dept.id,
                format='excel',
                output=f'reports/year_end_{year}/attendance_{dept.code}_{year}.xlsx'
            )

        # Generate leave balance report
        call_command('generate_report',
            year=year,
            format='excel',
            type='leave_balance',
            output=f'reports/year_end_{year}/leave_balance_{year}.xlsx'
        )

        # Generate holiday report
        call_command('generate_report',
            year=year,
            format='excel',
            type='holiday',
            output=f'reports/year_end_{year}/holidays_{year}.xlsx'
        )

```

### 📄 hrms_project\attendance\migrations\0001_initial.py
```# Generated by Django 4.2.9 on 2025-02-04 00:30

from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('employees', '0009_alter_employeeoffence_details_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [

        migrations.CreateModel(
            name='Leave',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('start_date', models.DateField()),
                ('end_date', models.DateField()),
                ('duration', models.DecimalField(decimal_places=2, help_text='Duration in days', max_digits=4)),
                ('start_half', models.BooleanField(default=False, help_text='True if starting with half day')),
                ('end_half', models.BooleanField(default=False, help_text='True if ending with half day')),
                ('reason', models.TextField()),
                ('status', models.CharField(choices=[('draft', 'Draft'), ('pending', 'Pending Approval'), ('approved', 'Approved'), ('rejected', 'Rejected'), ('cancelled', 'Cancelled')], default='draft', max_length=20)),
                ('submitted_at', models.DateTimeField(blank=True, null=True)),
                ('approved_at', models.DateTimeField(blank=True, null=True)),
                ('rejection_reason', models.TextField(blank=True)),
                ('cancellation_reason', models.TextField(blank=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('approved_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approved_leaves', to=settings.AUTH_USER_MODEL)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='leaves', to='employees.employee')),
            ],
        ),
        migrations.CreateModel(
            name='LeaveType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('code', models.CharField(max_length=20, unique=True)),
                ('category', models.CharField(choices=[('REGULAR', 'Regular Leave'), ('SPECIAL', 'Special Leave'), ('MEDICAL', 'Medical Leave')], max_length=20)),
                ('description', models.TextField(blank=True)),
                ('days_allowed', models.PositiveIntegerField(help_text='Number of days allowed per period')),
                ('is_paid', models.BooleanField(default=True)),
                ('requires_document', models.BooleanField(default=False)),
                ('gender_specific', models.CharField(choices=[('M', 'Male Only'), ('F', 'Female Only'), ('A', 'All')], default='A', max_length=1)),
                ('accrual_enabled', models.BooleanField(default=False)),
                ('accrual_days', models.DecimalField(blank=True, decimal_places=2, help_text='Days accrued per month/period', max_digits=4, null=True)),
                ('accrual_period', models.CharField(blank=True, choices=[('MONTHLY', 'Monthly'), ('WORKED', 'Per Worked Days')], max_length=10, null=True)),
                ('reset_period', models.CharField(choices=[('YEARLY', 'Yearly'), ('NEVER', 'Never Reset'), ('EVENT', 'Per Event')], default='YEARLY', max_length=10)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='Shift',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('start_time', models.TimeField()),
                ('end_time', models.TimeField()),
                ('is_night_shift', models.BooleanField(default=False)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'ordering': ['start_time'],
            },
        ),
        migrations.CreateModel(
            name='LeaveDocument',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('document', models.FileField(upload_to='leave_documents/%Y/%m/', validators=[django.core.validators.FileExtensionValidator(allowed_extensions=['pdf', 'jpg', 'jpeg', 'png'])])),
                ('document_type', models.CharField(max_length=50)),
                ('notes', models.TextField(blank=True)),
                ('uploaded_at', models.DateTimeField(auto_now_add=True)),
                ('leave', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documents', to='attendance.leave')),
            ],
        ),
        migrations.CreateModel(
            name='LeaveActivity',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('action', models.CharField(max_length=50)),
                ('details', models.TextField(blank=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('actor', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('leave', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='activities', to='attendance.leave')),
            ],
            options={
                'verbose_name_plural': 'Leave activities',
                'ordering': ['-created_at'],
            },
        ),
        migrations.AddField(
            model_name='leave',
            name='leave_type',
            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='leave_requests', to='attendance.leavetype'),
        ),
        migrations.CreateModel(
            name='Holiday',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('date', models.DateField()),
                ('holiday_type', models.CharField(choices=[('PUBLIC', 'Public Holiday'), ('COMPANY', 'Company Holiday'), ('OPTIONAL', 'Optional Holiday')], default='PUBLIC', max_length=20)),
                ('is_recurring', models.BooleanField(default=False, help_text='If True, holiday repeats every year')),
                ('description', models.TextField(blank=True)),
                ('is_paid', models.BooleanField(default=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('applicable_departments', models.ManyToManyField(blank=True, related_name='holidays', to='employees.department')),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-date'],
            },
        ),
        migrations.CreateModel(
            name='AttendanceLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('date', models.DateField()),
                ('first_in_time', models.TimeField()),
                ('last_out_time', models.TimeField()),
                ('source', models.CharField(choices=[('system', 'System'), ('manual', 'Manual')], default='system', max_length=20)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_attendance_logs', to=settings.AUTH_USER_MODEL)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='attendance_logs', to='employees.employee')),
                ('shift', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='attendance.shift')),
            ],
            options={
                'ordering': ['-date'],
                'unique_together': {('employee', 'date')},
            },
        ),
        migrations.CreateModel(
            name='AttendanceEdit',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('original_first_in', models.TimeField()),
                ('original_last_out', models.TimeField()),
                ('edited_first_in', models.TimeField()),
                ('edited_last_out', models.TimeField()),
                ('edit_timestamp', models.DateTimeField(auto_now_add=True)),
                ('edit_reason', models.TextField()),
                ('is_active', models.BooleanField(default=True)),
                ('attendance_log', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='edits', to='attendance.attendancelog')),
                ('edited_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-edit_timestamp'],
            },
        ),
        migrations.CreateModel(
            name='LeaveBalance',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('total_days', models.DecimalField(decimal_places=2, default=0, max_digits=6)),
                ('used_days', models.DecimalField(decimal_places=2, default=0, max_digits=6)),
                ('pending_days', models.DecimalField(decimal_places=2, default=0, max_digits=6)),
                ('last_accrual_date', models.DateField(blank=True, null=True)),
                ('last_reset_date', models.DateField(blank=True, null=True)),
                ('valid_until', models.DateField(blank=True, null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='leave_balances', to='employees.employee')),
                ('leave_type', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='employee_balances', to='attendance.leavetype')),
            ],
            options={
                'ordering': ['employee', 'leave_type'],
                'unique_together': {('employee', 'leave_type')},
            },
        ),
        migrations.CreateModel(
            name='AttendanceRecord',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('timestamp', models.DateTimeField()),
                ('device_name', models.CharField(max_length=100)),
                ('event_point', models.CharField(max_length=100)),
                ('verify_type', models.CharField(max_length=50)),
                ('event_description', models.TextField(blank=True, null=True)),
                ('remarks', models.TextField(blank=True, null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='attendance_records', to='employees.employee')),
            ],
            options={
                'ordering': ['-timestamp'],
                'unique_together': {('employee', 'timestamp')},
            },
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0002_initial_leave_types.py
```from django.db import migrations

def create_leave_types(apps, schema_editor):
    LeaveType = apps.get_model('attendance', 'LeaveType')

    leave_types = [
        # Emergency Leave
        {
            'name': 'Emergency Leave',
            'code': 'EMERG',
            'category': 'REGULAR',
            'description': 'Emergency leave up to 15 days per year',
            'days_allowed': 15,
            'is_paid': True,
            'requires_document': False,
            'gender_specific': 'A',
            'accrual_enabled': False,
            'reset_period': 'YEARLY'
        },
        # Annual Leave
        {
            'name': 'Annual Leave',
            'code': 'ANNUAL',
            'category': 'REGULAR',
            'description': 'Annual leave accrued at 2.5 days per 30 working days',
            'days_allowed': 30,
            'is_paid': True,
            'requires_document': False,
            'gender_specific': 'A',
            'accrual_enabled': True,
            'accrual_days': 2.5,
            'accrual_period': 'WORKED',
            'reset_period': 'YEARLY'
        },
        # Half Day Leave
        {
            'name': 'Half Day Leave',
            'code': 'HALF',
            'category': 'REGULAR',
            'description': 'Half day leave deducted from annual leave balance',
            'days_allowed': 0,  # Deducted from annual leave
            'is_paid': True,
            'requires_document': False,
            'gender_specific': 'A',
            'accrual_enabled': False,
            'reset_period': 'NEVER'
        },
        # Permission Leave
        {
            'name': 'Permission Leave',
            'code': 'PERM',
            'category': 'REGULAR',
            'description': 'Short permission tracked in hours (8 hours = 1 day)',
            'days_allowed': 3,
            'is_paid': True,
            'requires_document': False,
            'gender_specific': 'A',
            'accrual_enabled': False,
            'reset_period': 'YEARLY'
        },
        # Regular Sick Leave - Tier 1
        {
            'name': 'Sick Leave - Tier 1',
            'code': 'SICK1',
            'category': 'MEDICAL',
            'description': 'First 15 days of sick leave (fully paid)',
            'days_allowed': 15,
            'is_paid': True,
            'requires_document': True,
            'gender_specific': 'A',
            'accrual_enabled': False,
            'reset_period': 'YEARLY'
        },
        # Regular Sick Leave - Tier 2
        {
            'name': 'Sick Leave - Tier 2',
            'code': 'SICK2',
            'category': 'MEDICAL',
            'description': 'Next 20 days of sick leave (half paid)',
            'days_allowed': 20,
            'is_paid': True,
            'requires_document': True,
            'gender_specific': 'A',
            'accrual_enabled': False,
            'reset_period': 'YEARLY'
        },
        # Regular Sick Leave - Tier 3
        {
            'name': 'Sick Leave - Tier 3',
            'code': 'SICK3',
            'category': 'MEDICAL',
            'description': 'Final 20 days of sick leave (unpaid)',
            'days_allowed': 20,
            'is_paid': False,
            'requires_document': True,
            'gender_specific': 'A',
            'accrual_enabled': False,
            'reset_period': 'YEARLY'
        },
        # Injury Leave
        {
            'name': 'Injury Leave',
            'code': 'INJURY',
            'category': 'MEDICAL',
            'description': 'Unlimited paid leave for work-related injuries',
            'days_allowed': 0,  # Unlimited
            'is_paid': True,
            'requires_document': True,
            'gender_specific': 'A',
            'accrual_enabled': False,
            'reset_period': 'EVENT'
        },
        # Relative Death Leave
        {
            'name': 'Relative Death Leave',
            'code': 'DEATH',
            'category': 'SPECIAL',
            'description': '3 days paid leave per death event',
            'days_allowed': 3,
            'is_paid': True,
            'requires_document': True,
            'gender_specific': 'A',
            'accrual_enabled': False,
            'reset_period': 'EVENT'
        },
        # Maternity Leave
        {
            'name': 'Maternity Leave',
            'code': 'MATER',
            'category': 'SPECIAL',
            'description': '60 days paid leave for childbirth',
            'days_allowed': 60,
            'is_paid': True,
            'requires_document': True,
            'gender_specific': 'F',
            'accrual_enabled': False,
            'reset_period': 'EVENT'
        },
        # Paternity Leave
        {
            'name': 'Paternity Leave',
            'code': 'PATER',
            'category': 'SPECIAL',
            'description': '1 day paid leave for childbirth',
            'days_allowed': 1,
            'is_paid': True,
            'requires_document': True,
            'gender_specific': 'M',
            'accrual_enabled': False,
            'reset_period': 'EVENT'
        },
        # Marriage Leave
        {
            'name': 'Marriage Leave',
            'code': 'MARR',
            'category': 'SPECIAL',
            'description': '3 days paid leave per marriage event',
            'days_allowed': 3,
            'is_paid': True,
            'requires_document': True,
            'gender_specific': 'A',
            'accrual_enabled': False,
            'reset_period': 'EVENT'
        },
    ]

    for leave_type in leave_types:
        LeaveType.objects.create(**leave_type)

def remove_leave_types(apps, schema_editor):
    LeaveType = apps.get_model('attendance', 'LeaveType')
    LeaveType.objects.all().delete()

class Migration(migrations.Migration):
    dependencies = [
        ('attendance', '0001_initial'),
    ]

    operations = [
        migrations.RunPython(create_leave_types, remove_leave_types),
    ]

```

### 📄 hrms_project\attendance\migrations\0003_leaverule.py
```# Generated by Django 4.2.9 on 2025-02-04 07:32

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0002_initial_leave_types'),
    ]

    operations = [
        migrations.CreateModel(
            name='LeaveRule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('code', models.CharField(max_length=50, unique=True)),
                ('description', models.TextField(blank=True)),
                ('days_allowed', models.DecimalField(decimal_places=2, max_digits=5)),
                ('is_paid', models.BooleanField(default=True)),
                ('requires_approval', models.BooleanField(default=True)),
                ('requires_documentation', models.BooleanField(default=False)),
                ('documentation_info', models.TextField(blank=True, help_text='What documents are required')),
                ('reset_frequency', models.CharField(choices=[('never', 'Never'), ('annually', 'Annually'), ('monthly', 'Monthly'), ('per_event', 'Per Event')], default='annually', max_length=20)),
                ('gender_specific', models.CharField(choices=[('M', 'Male Only'), ('F', 'Female Only'), ('A', 'All')], default='A', max_length=1)),
                ('min_service_months', models.PositiveIntegerField(default=0)),
                ('max_days_per_request', models.PositiveIntegerField(blank=True, null=True)),
                ('min_days_per_request', models.DecimalField(decimal_places=2, default=0.5, max_digits=4)),
                ('notice_days_required', models.PositiveIntegerField(default=0)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'ordering': ['name'],
            },
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0004_attendancelog_early_departure_and_more.py
```# Generated by Django 4.2.9 on 2025-02-08 07:21

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0003_leaverule'),
    ]

    operations = [
        migrations.AddField(
            model_name='attendancelog',
            name='early_departure',
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name='attendancelog',
            name='early_minutes',
            field=models.PositiveIntegerField(default=0),
        ),
        migrations.AddField(
            model_name='attendancelog',
            name='is_late',
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name='attendancelog',
            name='late_minutes',
            field=models.PositiveIntegerField(default=0),
        ),
        migrations.AddField(
            model_name='attendancelog',
            name='status',
            field=models.CharField(choices=[('present', 'Present'), ('absent', 'Absent'), ('late', 'Late'), ('leave', 'Leave'), ('holiday', 'Holiday')], default='absent', max_length=20),
        ),
        migrations.AddField(
            model_name='attendancelog',
            name='total_work_minutes',
            field=models.PositiveIntegerField(default=0),
        ),
        migrations.AlterField(
            model_name='attendancelog',
            name='first_in_time',
            field=models.TimeField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='attendancelog',
            name='last_out_time',
            field=models.TimeField(blank=True, null=True),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0006_add_shift_management.py
```from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone


class Migration(migrations.Migration):

    dependencies = [
        ('employees', '0010_employee_user'),
        ('core', '0001_initial'),  
        ('attendance', '0004_attendancelog_early_departure_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='shift',
            name='shift_type',
            field=models.CharField(
                choices=[
                    ('DEFAULT', 'Default Shift (7AM-4PM)'),
                    ('CLEANER', 'Cleaner Shift (6AM-3PM)'),
                    ('NIGHT', 'Night Shift'),
                    ('OPEN', 'Open Shift'),
                ],
                default='DEFAULT',
                max_length=20
            ),
        ),
        migrations.AddField(
            model_name='shift',
            name='grace_period',
            field=models.PositiveIntegerField(
                default=15,
                help_text='Grace period in minutes'
            ),
        ),
        migrations.AddField(
            model_name='shift',
            name='break_duration',
            field=models.PositiveIntegerField(
                default=60,
                help_text='Break duration in minutes'
            ),
        ),
        migrations.CreateModel(
            name='RamadanPeriod',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('year', models.IntegerField()),
                ('start_date', models.DateField()),
                ('end_date', models.DateField()),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Ramadan Period',
                'verbose_name_plural': 'Ramadan Periods',
                'ordering': ['-year'],
            },
        ),
        migrations.CreateModel(
            name='ShiftAssignment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('start_date', models.DateField(help_text='Start date of shift assignment')),
                ('end_date', models.DateField(blank=True, help_text='End date of shift assignment (null = permanent)', null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_shift_assignments', to='core.user')),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='shift_assignments', to='employees.employee')),
                ('shift', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='assignments', to='attendance.shift')),
            ],
            options={
                'verbose_name': 'Shift Assignment',
                'verbose_name_plural': 'Shift Assignments',
                'ordering': ['-start_date'],
            },
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0007_alter_shift_shift_type_and_more.py
```# Generated by Django 4.2.9 on 2025-02-11 11:13

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('attendance', '0006_add_shift_management'),
    ]

    operations = [
        migrations.AlterField(
            model_name='shift',
            name='shift_type',
            field=models.CharField(choices=[('DEFAULT', 'Default Shift (7AM-4PM)'), ('NIGHT', 'Night Shift'), ('OPEN', 'Open Shift')], default='DEFAULT', max_length=20),
        ),
        migrations.AlterField(
            model_name='shiftassignment',
            name='created_by',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_shift_assignments', to=settings.AUTH_USER_MODEL),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0008_shift_default_night_end_time_and_more.py
```# Generated by Django 4.2.9 on 2025-02-11 14:41

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0007_alter_shift_shift_type_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='shift',
            name='default_night_end_time',
            field=models.TimeField(blank=True, help_text='Default end time for night shift', null=True),
        ),
        migrations.AddField(
            model_name='shift',
            name='default_night_start_time',
            field=models.TimeField(blank=True, help_text='Default start time for night shift', null=True),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0009_datespecificshiftoverride_and_more.py
```# Generated by Django 4.2.9 on 2025-02-12 08:54

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0008_shift_default_night_end_time_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='DateSpecificShiftOverride',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('date', models.DateField(help_text='Date for which shift is overridden', unique=True)),
                ('shift_type', models.CharField(choices=[('DEFAULT', 'Default Shift (7AM-4PM)'), ('NIGHT', 'Night Shift'), ('OPEN', 'Open Shift')], default='NIGHT', help_text='Shift type to override', max_length=20)),
                ('override_start_time', models.TimeField(blank=True, help_text='Override start time', null=True)),
                ('override_end_time', models.TimeField(blank=True, help_text='Override end time', null=True)),
            ],
            options={
                'verbose_name': 'Shift Override',
                'verbose_name_plural': 'Shift Overrides',
                'ordering': ['-date'],
            },
        ),
        migrations.RemoveField(
            model_name='shift',
            name='default_night_end_time',
        ),
        migrations.RemoveField(
            model_name='shift',
            name='default_night_start_time',
        ),
        migrations.RemoveField(
            model_name='shift',
            name='is_night_shift',
        ),
        migrations.AddField(
            model_name='shift',
            name='default_end_time',
            field=models.TimeField(blank=True, help_text='Default end time for this shift type', null=True),
        ),
        migrations.AddField(
            model_name='shift',
            name='default_start_time',
            field=models.TimeField(blank=True, help_text='Default start time for this shift type', null=True),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0010_datespecificshift.py
```# Generated by Django 4.2.9 on 2025-02-12 13:13

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('attendance', '0009_datespecificshiftoverride_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='DateSpecificShift',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('date', models.DateField()),
                ('start_time', models.TimeField()),
                ('end_time', models.TimeField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('shift', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='date_specific_timings', to='attendance.shift')),
            ],
            options={
                'ordering': ['date', 'start_time'],
                'unique_together': {('shift', 'date')},
            },
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0011_shift_ramadan_end_time_shift_ramadan_start_time.py
```# Generated by Django 4.2.9 on 2025-02-12 13:22

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0010_datespecificshift'),
    ]

    operations = [
        migrations.AddField(
            model_name='shift',
            name='ramadan_end_time',
            field=models.TimeField(blank=True, help_text='End time during Ramadan period', null=True),
        ),
        migrations.AddField(
            model_name='shift',
            name='ramadan_start_time',
            field=models.TimeField(blank=True, help_text='Start time during Ramadan period', null=True),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0012_create_default_shifts.py
```from django.db import migrations
from django.utils import timezone

def create_default_shifts(apps, schema_editor):
    Shift = apps.get_model('attendance', 'Shift')
    
    # Define default shifts
    default_shifts = [
        {
            'name': 'Default Shift',
            'shift_type': 'DEFAULT',
            'start_time': '07:00',
            'end_time': '16:00',
            'default_start_time': '07:00',
            'default_end_time': '16:00',
            'grace_period': 15,
            'break_duration': 60,
            'is_active': True,
        },
        {
            'name': 'Night Shift',
            'shift_type': 'NIGHT',
            'start_time': '18:00',
            'end_time': '03:00',
            'default_start_time': '18:00',
            'default_end_time': '03:00',
            'grace_period': 15,
            'break_duration': 60,
            'is_active': True,
        },
        {
            'name': 'Open Shift',
            'shift_type': 'OPEN',
            'start_time': '00:00',
            'end_time': '23:59',
            'default_start_time': '00:00',
            'default_end_time': '23:59',
            'grace_period': 30,
            'break_duration': 60,
            'is_active': True,
        },
    ]

    # Create shifts if they don't exist
    for shift_data in default_shifts:
        Shift.objects.get_or_create(
            shift_type=shift_data['shift_type'],
            defaults=shift_data
        )

def remove_default_shifts(apps, schema_editor):
    Shift = apps.get_model('attendance', 'Shift')
    Shift.objects.filter(shift_type__in=['DEFAULT', 'NIGHT', 'OPEN']).delete()

class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0011_shift_ramadan_end_time_shift_ramadan_start_time'),
    ]

    operations = [
        migrations.RunPython(create_default_shifts, remove_default_shifts),
    ] 
```

### 📄 hrms_project\attendance\migrations\0013_remove_shift_default_end_time_and_more.py
```# Generated by Django 4.2.9 on 2025-02-12 18:54

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0012_create_default_shifts'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='shift',
            name='default_end_time',
        ),
        migrations.RemoveField(
            model_name='shift',
            name='default_start_time',
        ),
        migrations.AddField(
            model_name='shift',
            name='default_night_end_time',
            field=models.TimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='shift',
            name='default_night_start_time',
            field=models.TimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='shift',
            name='is_night_shift',
            field=models.BooleanField(default=False),
        ),
        migrations.AlterField(
            model_name='datespecificshiftoverride',
            name='shift_type',
            field=models.CharField(choices=[('DEFAULT', 'Default Shift'), ('NIGHT', 'Night Shift'), ('OPEN', 'Open Shift')], default='NIGHT', help_text='Shift type to override', max_length=20),
        ),
        migrations.AlterField(
            model_name='shift',
            name='break_duration',
            field=models.IntegerField(default=60),
        ),
        migrations.AlterField(
            model_name='shift',
            name='grace_period',
            field=models.IntegerField(default=15),
        ),
        migrations.AlterField(
            model_name='shift',
            name='shift_type',
            field=models.CharField(choices=[('DEFAULT', 'Default Shift'), ('NIGHT', 'Night Shift'), ('OPEN', 'Open Shift')], max_length=10),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0014_remove_holiday_applicable_departments.py
```# Generated by Django 4.2.9 on 2025-02-13 12:16

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0013_remove_shift_default_end_time_and_more'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='holiday',
            name='applicable_departments',
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0015_leavebeginningbalance.py
```# Generated by Django 4.2.9 on 2025-02-15 09:45

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('employees', '0010_employee_user'),
        ('attendance', '0014_remove_holiday_applicable_departments'),
    ]

    operations = [
        migrations.CreateModel(
            name='LeaveBeginningBalance',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('balance_days', models.DecimalField(decimal_places=2, help_text='Initial leave balance in days.', max_digits=6, verbose_name='Balance Days')),
                ('as_of_date', models.DateField(help_text='Date when this balance was recorded', verbose_name='As of Date')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='beginning_balances', to='employees.employee', verbose_name='Employee')),
                ('leave_type', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='attendance.leavetype', verbose_name='Leave Type')),
            ],
            options={
                'verbose_name': 'Leave Beginning Balance',
                'verbose_name_plural': 'Leave Beginning Balances',
                'unique_together': {('employee', 'leave_type', 'as_of_date')},
            },
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0016_attendancelog_holiday_holiday_applicable_departments_and_more.py
```# Generated by Django 4.2.9 on 2025-02-16 14:30

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('employees', '0010_employee_user'),
        ('attendance', '0015_leavebeginningbalance'),
    ]

    operations = [
        migrations.AddField(
            model_name='attendancelog',
            name='holiday',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='attendance_logs', to='attendance.holiday'),
        ),
        migrations.AddField(
            model_name='holiday',
            name='applicable_departments',
            field=models.ManyToManyField(blank=True, help_text='Leave empty to apply to all departments', related_name='holidays', to='employees.department'),
        ),
        migrations.AlterField(
            model_name='attendancelog',
            name='source',
            field=models.CharField(choices=[('system', 'System'), ('manual', 'Manual'), ('holiday', 'Holiday')], default='system', max_length=20),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0017_remove_holiday_fields.py
```# Generated manually

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0016_attendancelog_holiday_holiday_applicable_departments_and_more'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='holiday',
            name='applicable_departments',
        ),
        migrations.RemoveField(
            model_name='attendancelog',
            name='holiday',
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0018_leave_leave_sub_type.py
```# Generated by Django 4.2.9 on 2025-02-23 11:10

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0017_remove_holiday_fields'),
    ]

    operations = [
        migrations.AddField(
            model_name='leave',
            name='leave_sub_type',
            field=models.CharField(blank=True, help_text='Sub-type or specific category of the leave', max_length=50),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0019_leavebalancetier.py
```# Generated by Django 4.2.9 on 2025-02-23 12:34

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0018_leave_leave_sub_type'),
    ]

    operations = [
        migrations.CreateModel(
            name='LeaveBalanceTier',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('tier_number', models.PositiveIntegerField()),
                ('tier_name', models.CharField(max_length=50)),
                ('days_allowed', models.DecimalField(decimal_places=2, help_text='Number of days allowed in this tier', max_digits=6)),
                ('days_used', models.DecimalField(decimal_places=2, default=0, help_text='Number of days used from this tier', max_digits=6)),
                ('pay_percentage', models.DecimalField(decimal_places=2, help_text='Percentage of salary paid for this tier', max_digits=5)),
                ('balance', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tiers', to='attendance.leavebalance')),
            ],
            options={
                'ordering': ['tier_number'],
                'unique_together': {('balance', 'tier_number')},
            },
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0020_leavetype_balance_calculation_and_more.py
```# Generated by Django 4.2.9 on 2025-02-23 13:07

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0019_leavebalancetier'),
    ]

    operations = [
        migrations.AddField(
            model_name='leavetype',
            name='balance_calculation',
            field=models.CharField(choices=[('FIXED', 'Fixed Allowance'), ('ACCRUAL', 'Monthly Accrual'), ('TIERED', 'Tiered System'), ('SHARED', 'Shared Balance')], default='FIXED', help_text='How the leave balance is calculated', max_length=20),
        ),
        migrations.AddField(
            model_name='leavetype',
            name='shared_balance_with',
            field=models.ForeignKey(blank=True, help_text='For shared balance types, reference the main leave type', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='shared_leave_types', to='attendance.leavetype'),
        ),
        migrations.AddField(
            model_name='leavetype',
            name='validation_rules',
            field=models.JSONField(blank=True, default=dict, help_text='JSON field for storing leave type specific validation rules'),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\0021_attendancelog_leave.py
```# Generated by Django 4.2.9 on 2025-02-26 12:22

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('attendance', '0020_leavetype_balance_calculation_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='attendancelog',
            name='leave',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='attendance_logs', to='attendance.leave'),
        ),
    ]

```

### 📄 hrms_project\attendance\migrations\__init__.py
```
```

### 📄 hrms_project\attendance\models.py
```from django.db import models
from django.conf import settings
from django.core.exceptions import ValidationError
from django.core.validators import FileExtensionValidator
from django.utils import timezone
from employees.models import Employee
from .config.shift_defaults import SHIFT_PRIORITIES, DEFAULT_SHIFTS

class RamadanPeriod(models.Model):
    """Defines Ramadan periods for different years"""
    year = models.IntegerField()
    start_date = models.DateField()
    end_date = models.DateField()
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-year']
        verbose_name = 'Ramadan Period'
        verbose_name_plural = 'Ramadan Periods'

    def __str__(self):
        return f"Ramadan {self.year} ({self.start_date} to {self.end_date})"

    def clean(self):
        if self.start_date and self.end_date:
            if self.start_date > self.end_date:
                raise ValidationError("End date cannot be before start date")
            if self.start_date.year != self.year or self.end_date.year != self.year:
                raise ValidationError("Dates must be within the specified year")

    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)

class Shift(models.Model):
    """Define different types of shifts"""
    SHIFT_TYPES = [
        ('DEFAULT', 'Default Shift'),
        ('NIGHT', 'Night Shift'),
        ('OPEN', 'Open Shift'),
    ]

    name = models.CharField(max_length=100)
    shift_type = models.CharField(max_length=10, choices=SHIFT_TYPES)
    start_time = models.TimeField()
    end_time = models.TimeField()
    is_night_shift = models.BooleanField(default=False)
    grace_period = models.IntegerField(default=15)  # in minutes
    break_duration = models.IntegerField(default=60)  # in minutes
    is_active = models.BooleanField(default=True)
    default_night_start_time = models.TimeField(null=True, blank=True)
    default_night_end_time = models.TimeField(null=True, blank=True)
    ramadan_start_time = models.TimeField(
        null=True,
        blank=True,
        help_text="Start time during Ramadan period"
    )
    ramadan_end_time = models.TimeField(
        null=True,
        blank=True,
        help_text="End time during Ramadan period"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    @property
    def priority(self) -> int:
        """Get the priority of this shift type from configuration"""
        return SHIFT_PRIORITIES.get(self.shift_type, 0)

    @classmethod
    def get_default_shifts(cls) -> list:
        """Return the default shift configurations from settings"""
        return DEFAULT_SHIFTS

    def __str__(self):
        return self.name

    class Meta:
        ordering = ['start_time']

class DateSpecificShift(models.Model):
    """Model to store date-specific shift timings"""
    shift = models.ForeignKey(Shift, on_delete=models.CASCADE, related_name='date_specific_timings')
    date = models.DateField()
    start_time = models.TimeField()
    end_time = models.TimeField()
    created_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = ['shift', 'date']
        ordering = ['date', 'start_time']

    def __str__(self):
        return f"{self.shift.name} - {self.date} ({self.start_time}-{self.end_time})"

class DateSpecificShiftOverride(models.Model):
    """Track date-specific shift time overrides"""
    date = models.DateField(unique=True, help_text="Date for which shift is overridden")
    shift_type = models.CharField(max_length=20, choices=Shift.SHIFT_TYPES, default='NIGHT', help_text="Shift type to override")
    override_start_time = models.TimeField(null=True, blank=True, help_text="Override start time")
    override_end_time = models.TimeField(null=True, blank=True, help_text="Override end time")

    def __str__(self):
        return f"{self.get_shift_type_display()} Override for {self.date}"

    class Meta:
        ordering = ['-date']
        verbose_name = 'Shift Override'
        verbose_name_plural = 'Shift Overrides'

class ShiftAssignment(models.Model):
    """Track shift assignments for employees"""
    employee = models.ForeignKey(
        'employees.Employee',
        on_delete=models.CASCADE,
        related_name='shift_assignments'
    )
    shift = models.ForeignKey(
        Shift,
        on_delete=models.CASCADE,
        related_name='assignments'
    )
    start_date = models.DateField(help_text="Start date of shift assignment")
    end_date = models.DateField(
        null=True,
        blank=True,
        help_text="End date of shift assignment (null = permanent)"
    )
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='created_shift_assignments'
    )

    class Meta:
        ordering = ['-start_date']
        verbose_name = 'Shift Assignment'
        verbose_name_plural = 'Shift Assignments'

    def __str__(self):
        end = f" to {self.end_date}" if self.end_date else " (Permanent)"
        return f"{self.employee} - {self.shift.name} from {self.start_date}{end}"

    def clean(self):
        if self.start_date and self.end_date and self.end_date < self.start_date:
            raise ValidationError("End date cannot be before start date")

        # Check for overlapping assignments
        overlapping = ShiftAssignment.objects.filter(
            employee=self.employee,
            is_active=True,
            start_date__lte=self.end_date or timezone.now().date(),
        ).exclude(pk=self.pk)

        if self.end_date:
            overlapping = overlapping.filter(
                models.Q(end_date__isnull=True) |
                models.Q(end_date__gte=self.start_date)
            )
        
        if overlapping.exists():
            raise ValidationError(
                "This assignment overlaps with an existing shift assignment"
            )

    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)

class AttendanceRecord(models.Model):
    """Raw attendance data from machine"""
    employee = models.ForeignKey(
        Employee,
        on_delete=models.CASCADE,
        related_name='attendance_records'
    )
    timestamp = models.DateTimeField()
    device_name = models.CharField(max_length=100)
    event_point = models.CharField(max_length=100)
    verify_type = models.CharField(max_length=50)
    event_description = models.TextField(blank=True, null=True)
    remarks = models.TextField(blank=True, null=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = ['employee', 'timestamp']
        ordering = ['-timestamp']

    def __str__(self):
        return f"{self.employee} - {self.timestamp}"

class AttendanceLog(models.Model):
    """Processed attendance data with first in/last out times"""
    STATUS_CHOICES = [
        ('present', 'Present'),
        ('absent', 'Absent'),
        ('late', 'Late'),
        ('leave', 'Leave'),
        ('holiday', 'Holiday')
    ]

    employee = models.ForeignKey(
        Employee,
        on_delete=models.CASCADE,
        related_name='attendance_logs'
    )
    date = models.DateField()
    first_in_time = models.TimeField(null=True, blank=True)
    last_out_time = models.TimeField(null=True, blank=True)
    shift = models.ForeignKey(
        Shift,
        on_delete=models.SET_NULL,
        null=True,
        blank=True
    )
    leave = models.ForeignKey(
        'Leave',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='attendance_logs'
    )
    
    # Status tracking
    status = models.CharField(
        max_length=20,
        choices=STATUS_CHOICES,
        default='absent'
    )
    is_late = models.BooleanField(default=False)
    late_minutes = models.PositiveIntegerField(default=0)
    early_departure = models.BooleanField(default=False)
    early_minutes = models.PositiveIntegerField(default=0)
    total_work_minutes = models.PositiveIntegerField(default=0)
    source = models.CharField(
        max_length=20,
        choices=[
            ('system', 'System'),
            ('manual', 'Manual'),
            ('holiday', 'Holiday')
        ],
        default='system'
    )
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='created_attendance_logs'
    )

    class Meta:
        unique_together = ['employee', 'date']
        ordering = ['-date']

    def __str__(self):
        return f"{self.employee} - {self.date} ({self.status})"

class AttendanceEdit(models.Model):
    """Track changes to attendance logs"""
    attendance_log = models.ForeignKey(
        AttendanceLog,
        on_delete=models.CASCADE,
        related_name='edits'
    )
    original_first_in = models.TimeField()
    original_last_out = models.TimeField()
    edited_first_in = models.TimeField()
    edited_last_out = models.TimeField()
    edited_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True
    )
    edit_timestamp = models.DateTimeField(auto_now_add=True)
    edit_reason = models.TextField()
    is_active = models.BooleanField(default=True)

    class Meta:
        ordering = ['-edit_timestamp']

    def __str__(self):
        return f"Edit on {self.attendance_log} at {self.edit_timestamp}"

class LeaveType(models.Model):
    """Define leave types and their rules"""
    CATEGORY_CHOICES = [
        ('REGULAR', 'Regular Leave'),
        ('SPECIAL', 'Special Leave'),
        ('MEDICAL', 'Medical Leave'),
    ]
    
    BALANCE_CALCULATION_CHOICES = [
        ('FIXED', 'Fixed Allowance'),
        ('ACCRUAL', 'Monthly Accrual'),
        ('TIERED', 'Tiered System'),
        ('SHARED', 'Shared Balance'),
    ]
    
    name = models.CharField(max_length=100)
    code = models.CharField(max_length=20, unique=True)
    category = models.CharField(max_length=20, choices=CATEGORY_CHOICES)
    description = models.TextField(blank=True)
    
    # Leave allowance configuration
    days_allowed = models.PositiveIntegerField(help_text="Number of days allowed per period")
    is_paid = models.BooleanField(default=True)
    requires_document = models.BooleanField(default=False)
    gender_specific = models.CharField(
        max_length=1, 
        choices=[('M', 'Male Only'), ('F', 'Female Only'), ('A', 'All')],
        default='A'
    )
    
    # Balance calculation settings
    balance_calculation = models.CharField(
        max_length=20,
        choices=BALANCE_CALCULATION_CHOICES,
        default='FIXED',
        help_text="How the leave balance is calculated"
    )
    shared_balance_with = models.ForeignKey(
        'self',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='shared_leave_types',
        help_text="For shared balance types, reference the main leave type"
    )
    validation_rules = models.JSONField(
        default=dict,
        blank=True,
        help_text="JSON field for storing leave type specific validation rules"
    )
    
    # Accrual settings
    accrual_enabled = models.BooleanField(default=False)
    accrual_days = models.DecimalField(
        max_digits=4, 
        decimal_places=2, 
        null=True, 
        blank=True,
        help_text="Days accrued per month/period"
    )
    accrual_period = models.CharField(
        max_length=10,
        choices=[('MONTHLY', 'Monthly'), ('WORKED', 'Per Worked Days')],
        null=True,
        blank=True
    )
    
    # Reset configuration
    reset_period = models.CharField(
        max_length=10,
        choices=[
            ('YEARLY', 'Yearly'),
            ('NEVER', 'Never Reset'),
            ('EVENT', 'Per Event')
        ],
        default='YEARLY'
    )
    
    # System fields
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.name} ({self.code})"
    
    class Meta:
        ordering = ['name']

class LeaveBalance(models.Model):
    """Track leave balances for employees"""
    employee = models.ForeignKey(
        Employee,
        on_delete=models.CASCADE,
        related_name='leave_balances'
    )
    leave_type = models.ForeignKey(
        LeaveType,
        on_delete=models.CASCADE,
        related_name='employee_balances'
    )
    
    total_days = models.DecimalField(max_digits=6, decimal_places=2, default=0)
    used_days = models.DecimalField(max_digits=6, decimal_places=2, default=0)
    pending_days = models.DecimalField(max_digits=6, decimal_places=2, default=0)
    
    last_accrual_date = models.DateField(null=True, blank=True)
    last_reset_date = models.DateField(null=True, blank=True)
    valid_until = models.DateField(null=True, blank=True)
    
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.employee} - {self.leave_type} Balance"
    
    @property
    def available_days(self):
        """Calculate available days excluding pending requests"""
        return self.total_days - self.used_days - self.pending_days

    class Meta:
        unique_together = ['employee', 'leave_type']
        ordering = ['employee', 'leave_type']

class LeaveBeginningBalance(models.Model):
    """Stores initial leave balances for employees as of a specific date."""
    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='beginning_balances', verbose_name="Employee")
    leave_type = models.ForeignKey('LeaveType', on_delete=models.CASCADE, verbose_name="Leave Type")
    balance_days = models.DecimalField(max_digits=6, decimal_places=2, verbose_name="Balance Days", help_text="Initial leave balance in days.")
    as_of_date = models.DateField(help_text="Date when this balance was recorded", verbose_name="As of Date")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = ['employee', 'leave_type', 'as_of_date']
        verbose_name = "Leave Beginning Balance"
        verbose_name_plural = "Leave Beginning Balances"

    def __str__(self):
        return f"{self.employee} - {self.leave_type} - Balance as of {self.as_of_date}"

class LeaveRule(models.Model):
    """Defines rules and configurations for different leave types"""
    name = models.CharField(max_length=100)
    code = models.CharField(max_length=50, unique=True)
    description = models.TextField(blank=True)
    days_allowed = models.DecimalField(max_digits=5, decimal_places=2)
    is_paid = models.BooleanField(default=True)
    requires_approval = models.BooleanField(default=True)
    requires_documentation = models.BooleanField(default=False)
    documentation_info = models.TextField(blank=True, help_text="What documents are required")
    reset_frequency = models.CharField(
        max_length=20,
        choices=[
            ('never', 'Never'),
            ('annually', 'Annually'),
            ('monthly', 'Monthly'),
            ('per_event', 'Per Event'),
        ],
        default='annually'
    )
    gender_specific = models.CharField(
        max_length=1,
        choices=[('M', 'Male Only'), ('F', 'Female Only'), ('A', 'All')],
        default='A'
    )
    min_service_months = models.PositiveIntegerField(default=0)
    max_days_per_request = models.PositiveIntegerField(null=True, blank=True)
    min_days_per_request = models.DecimalField(
        max_digits=4, 
        decimal_places=2,
        default=0.5
    )
    notice_days_required = models.PositiveIntegerField(default=0)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.name

    class Meta:
        ordering = ['name']

class Leave(models.Model):
    """Track leave requests and their status"""
    LEAVE_STATUS = [
        ('draft', 'Draft'),
        ('pending', 'Pending Approval'),
        ('approved', 'Approved'),
        ('rejected', 'Rejected'),
        ('cancelled', 'Cancelled')
    ]

    employee = models.ForeignKey(
        Employee,
        on_delete=models.CASCADE,
        related_name='leaves'
    )
    leave_type = models.ForeignKey(
        LeaveType,
        on_delete=models.PROTECT,
        related_name='leave_requests'
    )
    
    # Request details
    leave_sub_type = models.CharField(
        max_length=50,
        blank=True,
        help_text='Sub-type or specific category of the leave'
    )
    start_date = models.DateField()
    end_date = models.DateField()
    duration = models.DecimalField(
        max_digits=4,
        decimal_places=2,
        help_text="Duration in days"
    )
    start_half = models.BooleanField(
        default=False,
        help_text="True if starting with half day"
    )
    end_half = models.BooleanField(
        default=False,
        help_text="True if ending with half day"
    )
    reason = models.TextField()
    
    # Status tracking
    status = models.CharField(
        max_length=20,
        choices=LEAVE_STATUS,
        default='draft'
    )
    submitted_at = models.DateTimeField(null=True, blank=True)
    approved_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        related_name='approved_leaves'
    )
    approved_at = models.DateTimeField(null=True, blank=True)
    rejection_reason = models.TextField(blank=True)
    cancellation_reason = models.TextField(blank=True)
    
    # System fields
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.employee} - {self.leave_type} ({self.start_date} to {self.end_date})"

    def clean(self):
        if self.start_date and self.end_date:
            if self.start_date > self.end_date:
                raise ValidationError("End date cannot be before start date")

    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)

class LeaveDocument(models.Model):
    """Store documents related to leave requests"""
    leave = models.ForeignKey(
        Leave,
        on_delete=models.CASCADE,
        related_name='documents'
    )
    document = models.FileField(
        upload_to='leave_documents/%Y/%m/',
        validators=[
            FileExtensionValidator(
                allowed_extensions=['pdf', 'jpg', 'jpeg', 'png']
            )
        ]
    )
    document_type = models.CharField(max_length=50)
    notes = models.TextField(blank=True)
    uploaded_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return f"{self.leave} - {self.document_type}"

class LeaveActivity(models.Model):
    """Track all activities related to leave requests"""
    leave = models.ForeignKey(
        Leave,
        on_delete=models.CASCADE,
        related_name='activities'
    )
    actor = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True
    )
    action = models.CharField(max_length=50)
    details = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return f"{self.leave} - {self.action} by {self.actor}"
    
    class Meta:
        ordering = ['-created_at']
        verbose_name_plural = 'Leave activities'

class Holiday(models.Model):
    """Define holidays and their configurations"""
    HOLIDAY_TYPES = [
        ('PUBLIC', 'Public Holiday'),
        ('COMPANY', 'Company Holiday'),
        ('OPTIONAL', 'Optional Holiday')
    ]
    
    name = models.CharField(max_length=100)
    date = models.DateField()
    holiday_type = models.CharField(
        max_length=20,
        choices=HOLIDAY_TYPES,
        default='PUBLIC'
    )
    is_recurring = models.BooleanField(
        default=False,
        help_text="If True, holiday repeats every year"
    )
    description = models.TextField(blank=True)
    is_paid = models.BooleanField(default=True)
    is_active = models.BooleanField(default=True)
    created_by = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-date']

    def __str__(self):
        return f"{self.name} ({self.date})"

class LeaveBalanceTier(models.Model):
    """Track tiered leave balances (e.g., sick leave tiers)"""
    balance = models.ForeignKey(
        LeaveBalance,
        on_delete=models.CASCADE,
        related_name='tiers'
    )
    tier_number = models.PositiveIntegerField()
    tier_name = models.CharField(max_length=50)
    days_allowed = models.DecimalField(
        max_digits=6,
        decimal_places=2,
        help_text="Number of days allowed in this tier"
    )
    days_used = models.DecimalField(
        max_digits=6,
        decimal_places=2,
        default=0,
        help_text="Number of days used from this tier"
    )
    pay_percentage = models.DecimalField(
        max_digits=5,
        decimal_places=2,
        help_text="Percentage of salary paid for this tier"
    )
    
    class Meta:
        unique_together = ['balance', 'tier_number']
        ordering = ['tier_number']
        
    def __str__(self):
        return f"{self.balance} - {self.tier_name} ({self.tier_number})"
        
    @property
    def days_remaining(self):
        """Calculate remaining days in this tier"""
        return self.days_allowed - self.days_used

```

### 📄 hrms_project\attendance\schedules.py
```"""
Celery Beat schedule configurations for attendance tasks
"""

BEAT_SCHEDULE = {
    'process-monthly-leave-accruals': {
        'task': 'attendance.tasks.process_monthly_leave_accruals',
        'schedule': 60 * 60 * 24,  # Daily at midnight (will only run on 1st day of month)
    },
    'process-leave-year-reset': {
        'task': 'attendance.tasks.process_leave_year_reset',
        'schedule': 60 * 60 * 24,  # Daily at midnight (will only run on Jan 1st)
    },
    'process-friday-attendance': {
        'task': 'attendance.tasks.process_friday_attendance',
        'schedule': 60 * 60 * 24,  # Daily at midnight (will only run on Fridays)
    },
    'process-recurring-holidays': {
        'task': 'attendance.tasks.process_recurring_holidays',
        'schedule': 60 * 60 * 24,  # Daily at midnight (will only run on Dec 1st)
    },
}

```

### 📄 hrms_project\attendance\serializers.py
```from rest_framework import serializers
from typing import Optional, Any
from django.contrib.auth import get_user_model
from .models import (
    Shift, AttendanceRecord, AttendanceLog,
    AttendanceEdit, Leave, Holiday
)
from employees.models import Employee

User = get_user_model()

class EmployeeNameMixin:
    """
    Mixin that provides employee name serialization functionality.
    Requires the model to have an 'employee' field.
    """
    employee_name = serializers.SerializerMethodField()

    def get_employee_name(self, obj: Any) -> Optional[str]:
        """Get employee's full name"""
        if hasattr(obj, 'employee') and obj.employee:
            return obj.employee.get_full_name()
        return None

class UserNameMixin:
    """
    Mixin that provides user name serialization functionality.
    Used for fields like created_by, edited_by, approved_by.
    """
    def get_user_name(self, user: Optional[User]) -> Optional[str]:
        """Get user's full name if user exists"""
        return user.get_full_name() if user else None

    def get_created_by_name(self, obj: Any) -> Optional[str]:
        """Get creating user's full name"""
        return self.get_user_name(getattr(obj, 'created_by', None))

    def get_edited_by_name(self, obj: Any) -> Optional[str]:
        """Get editing user's full name"""
        return self.get_user_name(getattr(obj, 'edited_by', None))

    def get_approved_by_name(self, obj: Any) -> Optional[str]:
        """Get approving user's full name"""
        return self.get_user_name(getattr(obj, 'approved_by', None))

class StatusDeterminationMixin:
    """
    Mixin that provides status determination functionality.
    Can be extended for different status determination needs.
    """
    def determine_status(self, obj: Any, check_leave: bool = True, check_holiday: bool = True) -> Optional[str]:
        """
        Determine status based on various conditions.
        
        Args:
            obj: The object to determine status for
            check_leave: Whether to check for leave status
            check_holiday: Whether to check for holiday status
            
        Returns:
            Status string or None
        """
        if check_leave:
            # Check for approved leave
            is_on_leave = Leave.objects.filter(
                employee=obj.employee,
                start_date__lte=obj.date,
                end_date__gte=obj.date,
                status='approved'
            ).exists()
            
            if is_on_leave:
                return 'leave'

        if check_holiday:
            # Check if the date is a holiday
            is_holiday = Holiday.objects.filter(
                date=obj.date,
                is_active=True
            ).exists()
            
            if is_holiday:
                if hasattr(obj, 'first_in_time') and obj.first_in_time:
                    return 'present'
                return None

        # Normal day status logic
        if hasattr(obj, 'is_late') and obj.is_late:
            return 'late'
        elif hasattr(obj, 'first_in_time') and obj.first_in_time:
            return 'present'
        return 'absent'

class ShiftSerializer(serializers.ModelSerializer):
    class Meta:
        model = Shift
        fields = '__all__'

class AttendanceRecordSerializer(serializers.ModelSerializer, EmployeeNameMixin):
    class Meta:
        model = AttendanceRecord
        fields = '__all__'

class AttendanceLogSerializer(serializers.ModelSerializer, EmployeeNameMixin, StatusDeterminationMixin):
    shift_name = serializers.SerializerMethodField()
    employee_id = serializers.SerializerMethodField()
    personnel_id = serializers.SerializerMethodField()
    status = serializers.SerializerMethodField()
    employee_name = serializers.SerializerMethodField()
    department = serializers.SerializerMethodField()

    class Meta:
        model = AttendanceLog
        fields = [
            'id', 'employee_id', 'employee_name', 'personnel_id',
            'date', 'first_in_time', 'last_out_time',
            'shift_name', 'status', 'is_late', 'source',
            'department'
        ]

    def get_shift_name(self, obj: AttendanceLog) -> Optional[str]:
        return obj.shift.name if obj.shift else None

    def get_employee_id(self, obj: AttendanceLog) -> Optional[int]:
        return obj.employee.id if obj.employee else None

    def get_personnel_id(self, obj: AttendanceLog) -> Optional[str]:
        return obj.employee.employee_number if obj.employee else None
        
    def get_status(self, obj: AttendanceLog) -> Optional[str]:
        return self.determine_status(obj)

    def get_department(self, obj: AttendanceLog) -> Optional[str]:
        """Get department name through employee relationship"""
        if obj.employee and obj.employee.department:
            return obj.employee.department.name
        return None

class AttendanceEditSerializer(serializers.ModelSerializer, UserNameMixin):
    edited_by_name = serializers.SerializerMethodField()

    class Meta:
        model = AttendanceEdit
        fields = '__all__'

class LeaveSerializer(serializers.ModelSerializer, EmployeeNameMixin, UserNameMixin):
    approved_by_name = serializers.SerializerMethodField()

    class Meta:
        model = Leave
        fields = '__all__'

class HolidaySerializer(serializers.ModelSerializer, UserNameMixin):
    created_by_name = serializers.SerializerMethodField()

    class Meta:
        model = Holiday
        fields = '__all__'

class AttendanceUploadSerializer(serializers.Serializer):
    file = serializers.FileField()

class BulkAttendanceCreateSerializer(serializers.Serializer):
    records = serializers.ListField(
        child=serializers.DictField()
    )

    def validate(self, data: dict) -> dict:
        records = data.get('records', [])
        for record in records:
            if not all(k in record for k in ('employee_id', 'timestamp')):
                raise serializers.ValidationError(
                    "Each record must contain employee_id and timestamp"
                )
        return data

    def create(self, validated_data: dict) -> list:
        records = validated_data.get('records', [])
        created_records = []

        for record in records:
            try:
                employee = Employee.objects.get(id=record['employee_id'])
                attendance_record = AttendanceRecord.objects.create(
                    employee=employee,
                    timestamp=record['timestamp'],
                    device_name=record.get('device_name', ''),
                    event_point=record.get('event_point', ''),
                    verify_type=record.get('verify_type', ''),
                    event_description=record.get('event_description', ''),
                    remarks=record.get('remarks', '')
                )
                created_records.append(attendance_record)
            except Employee.DoesNotExist:
                continue

        return created_records
```

### 📄 hrms_project\attendance\services\__init__.py
```from .shift_service import ShiftService
from .ramadan_service import RamadanService
from .attendance_status_service import AttendanceStatusService
from .leave_balance_service import LeaveBalanceService

__all__ = [
    'ShiftService',
    'RamadanService',
    'AttendanceStatusService',
    'LeaveBalanceService'
]
```

### 📄 hrms_project\attendance\services\attendance_status_service.py
```from datetime import datetime, timedelta
from typing import Optional, Dict, Any, Tuple
from django.utils import timezone
from ..models import Shift, DateSpecificShiftOverride
from .shift_service import ShiftService
from .ramadan_service import RamadanService

class AttendanceStatusService:
    """Service for handling attendance status calculations"""

    @staticmethod
    def _get_shift_timings(
        shift: Shift,
        date: datetime.date,
        is_muslim: bool = False
    ) -> Dict[str, datetime.time]:
        """
        Get appropriate shift timings considering Ramadan and night shift overrides.
        
        Args:
            shift: The shift to get timings for
            date: The date to check
            is_muslim: Whether the employee is Muslim (for Ramadan timing)
            
        Returns:
            Dictionary containing start_time and end_time
        """
        # Check for Ramadan timing first for Muslim employees
        if is_muslim:
            ramadan_timing = RamadanService.get_ramadan_shift_timing(shift, date)
            if ramadan_timing:
                return ramadan_timing

        # Get regular shift timing
        shift_timing = ShiftService.get_shift_timing(shift, date)

        # Check for night shift override
        if shift.shift_type == 'NIGHT':
            override = DateSpecificShiftOverride.objects.filter(
                date=date,
                shift_type='NIGHT'
            ).first()
            if override:
                if override.override_start_time:
                    shift_timing['start_time'] = override.override_start_time
                if override.override_end_time:
                    shift_timing['end_time'] = override.override_end_time

        return shift_timing

    @staticmethod
    def calculate_status(attendance_log) -> str:
        """
        Calculate attendance status based on attendance log, considering:
        - Shift type-specific timings
        - Ramadan adjustments for Muslim employees
        - Night shift overrides
        - Grace periods
        """
        # Check existing status for leave and holiday
        if attendance_log.status in ['leave', 'holiday']:
            return attendance_log.status
        elif not attendance_log.first_in_time:
            return 'absent'

        shift = attendance_log.shift
        if not shift:
            # Try to get default shift if none assigned
            shift = Shift.objects.filter(
                shift_type='DEFAULT',
                is_active=True
            ).first()
            if not shift:
                return 'absent'  # No shift assigned and no default shift available
            attendance_log.shift = shift  # Update log with default shift

        # Get shift timings
        shift_timing = AttendanceStatusService._get_shift_timings(
            shift,
            attendance_log.date,
            attendance_log.employee.religion == "Muslim"
        )
        shift_start_time = shift_timing['start_time']
        shift_end_time = shift_timing['end_time']

        # Calculate lateness
        grace_minutes = shift.grace_period or 0
        shift_start_with_grace = (
            datetime.combine(attendance_log.date, shift_start_time) + 
            timedelta(minutes=grace_minutes)
        ).time()

        # Handle night shift that crosses midnight
        is_late = False
        late_minutes = 0
        if shift.shift_type == 'NIGHT' and shift_end_time < shift_start_time:
            # For night shifts, if check-in is after midnight, compare with previous day
            if attendance_log.first_in_time < shift_start_time:
                # Employee checked in after midnight but before shift end
                is_late = attendance_log.first_in_time > shift_start_with_grace
            else:
                # Employee checked in before midnight
                is_late = attendance_log.first_in_time > shift_start_with_grace
        else:
            # Regular shift timing comparison
            is_late = attendance_log.first_in_time > shift_start_with_grace

        if is_late:
            late_minutes = int(
                (datetime.combine(attendance_log.date, attendance_log.first_in_time) -
                datetime.combine(attendance_log.date, shift_start_time))
                .total_seconds() / 60
            )

        # Update attendance log with lateness info
        attendance_log.is_late = is_late
        attendance_log.late_minutes = late_minutes
        attendance_log.save(update_fields=['is_late', 'late_minutes'])

        return 'late' if is_late else 'present'
    
    @staticmethod
    def calculate_work_duration(attendance_log, employee) -> int:
        """
        Calculate work duration in minutes taking into account:
        - Regular shifts: Deduct 1-hour break
        - Ramadan period for Muslim employees: No break deduction
        - Night shifts: Handle midnight spanning

        Args:
            attendance_log: The AttendanceLog instance
            employee: The Employee instance

        Returns:
            int: Total work duration in minutes
        """
        if not attendance_log.first_in_time or not attendance_log.last_out_time:
            return 0

        # Convert times to datetime for calculations
        date = attendance_log.date
        first_in = datetime.combine(date, attendance_log.first_in_time)
        last_out = datetime.combine(date, attendance_log.last_out_time)

        shift = attendance_log.shift
        if not shift:
            return 0

        # Get appropriate shift timings
        is_muslim = employee.religion == "Muslim"
        shift_timing = AttendanceStatusService._get_shift_timings(shift, date, is_muslim)
        shift_start_time = shift_timing['start_time']
        shift_end_time = shift_timing['end_time']

        # Handle night shift spanning midnight
        if shift.shift_type == 'NIGHT' and shift_end_time < shift_start_time:
            if last_out.time() < first_in.time():
                # Add one day to last_out for correct duration calculation
                last_out += timedelta(days=1)

        # Calculate base duration
        duration = int((last_out - first_in).total_seconds() / 60)  # Convert to minutes

        # Check if employee is Muslim and date falls in Ramadan
        ramadan_period = RamadanService.get_active_period(date)

        if ramadan_period and is_muslim:
            if shift.ramadan_end_time:
                # Use Ramadan-specific end time to calculate duration
                expected_hours = (
                    datetime.combine(date, shift.ramadan_end_time) - 
                    datetime.combine(date, shift_start_time)
                ).seconds / 3600
            else:
                # Calculate Ramadan hours if no specific end time is set
                normal_hours = (
                    datetime.combine(date, shift_end_time) - 
                    datetime.combine(date, shift_start_time)
                ).seconds / 3600
                expected_hours = RamadanService.calculate_working_hours(normal_hours, is_ramadan=True)

            # Convert expected hours to minutes for comparison
            expected_minutes = int(expected_hours * 60)
            duration = min(duration, expected_minutes)
        else:
            # For non-Ramadan or non-Muslim employees, deduct break duration
            duration -= shift.break_duration

        return max(duration, 0)  # Ensure non-negative duration

    @staticmethod
    def update_attendance_status(attendance_log) -> str:
        """
        Update the attendance log with status, lateness, and work duration
        
        Returns:
            str: The calculated status
        """
        # Calculate status (updates is_late and late_minutes)
        status = AttendanceStatusService.calculate_status(attendance_log)
        
        # Calculate work duration
        work_duration = AttendanceStatusService.calculate_work_duration(
            attendance_log,
            attendance_log.employee
        )
        
        # Update log
        attendance_log.status = status
        attendance_log.total_work_minutes = work_duration
        attendance_log.save(
            update_fields=['status', 'total_work_minutes']
        )
        
        return status

```

### 📄 hrms_project\attendance\services\cache_invalidation_service.py
```from datetime import date, timedelta
from typing import Optional, List, Set
from django.core.cache import cache
from django.utils import timezone

from ..cache import RamadanCache

class CacheInvalidationService:
    """Service for handling cache invalidation operations"""

    @staticmethod
    def clear_employee_shift_cache(employee_id: int) -> None:
        """Clear employee shift cache"""
        cache_key = f'employee_shift_{employee_id}'
        cache.delete(cache_key)

    @staticmethod
    def clear_shift_statistics_cache(shift_id: int) -> None:
        """Clear shift statistics cache"""
        cache_key = f'shift_statistics_{shift_id}'
        cache.delete(cache_key)

    @staticmethod
    def clear_ramadan_period_cache(start_date: date, end_date: date) -> None:
        """
        Clear Ramadan period cache for a date range.
        Uses pattern-based deletion if available, falls back to iterative deletion.
        """
        if hasattr(cache, 'delete_pattern'):
            # For cache backends that support pattern deletion (e.g., Redis)
            cache.delete_pattern('ramadan_period_*')
        else:
            # Fallback to iterative deletion
            current_date = start_date
            while current_date <= end_date:
                RamadanCache.clear_active_period(current_date)
                current_date += timedelta(days=1)

    @staticmethod
    def clear_employee_schedule_cache(
        employee_id: int,
        start_date: Optional[date] = None,
        end_date: Optional[date] = None,
        days_before: int = 7,
        days_after: int = 30
    ) -> None:
        """
        Clear employee schedule cache for a date range.
        If no dates provided, clears for default range around current date.
        """
        if not start_date:
            start_date = timezone.now().date() - timedelta(days=days_before)
        if not end_date:
            end_date = timezone.now().date() + timedelta(days=days_after)

        current_date = start_date
        while current_date <= end_date:
            key = f'employee_schedule_{employee_id}_{current_date}_{current_date}'
            cache.delete(key)
            current_date += timedelta(days=1)

    @staticmethod
    def clear_department_caches(department_ids: Set[int]) -> None:
        """Clear all caches related to departments"""
        for dept_id in department_ids:
            if dept_id:
                # Clear department shifts
                cache_key = f'department_shifts_{dept_id}'
                cache.delete(cache_key)

                # Clear department metrics
                today = timezone.now().date()
                for days in range(-30, 1):  # Past month
                    target_date = today + timedelta(days=days)
                    cache_key = f'attendance_metrics_{target_date.isoformat()}_{dept_id}'
                    cache.delete(cache_key)

    @classmethod
    def invalidate_shift_related_caches(
        cls,
        employee_ids: List[int],
        shift_id: Optional[int] = None,
        department_ids: Optional[Set[int]] = None
    ) -> None:
        """
        Invalidate all caches related to shift changes.
        
        Args:
            employee_ids: List of affected employee IDs
            shift_id: Optional shift ID if shift-specific caches need clearing
            department_ids: Optional set of department IDs to clear
        """
        # Clear shift statistics if provided
        if shift_id:
            cls.clear_shift_statistics_cache(shift_id)

        # Clear employee-specific caches
        for employee_id in employee_ids:
            cls.clear_employee_shift_cache(employee_id)
            cls.clear_employee_schedule_cache(employee_id)

        # Clear department caches if provided
        if department_ids:
            cls.clear_department_caches(department_ids)

    @classmethod
    def invalidate_ramadan_related_caches(
        cls,
        start_date: date,
        end_date: date,
        affected_employees: Optional[List[int]] = None
    ) -> None:
        """
        Invalidate all caches related to Ramadan period changes.
        
        Args:
            start_date: Start date of affected period
            end_date: End date of affected period
            affected_employees: Optional list of affected employee IDs
        """
        # Clear Ramadan period cache
        cls.clear_ramadan_period_cache(start_date, end_date)

        # Clear affected employee caches if provided
        if affected_employees:
            for employee_id in affected_employees:
                cls.clear_employee_shift_cache(employee_id)
                cls.clear_employee_schedule_cache(
                    employee_id,
                    start_date=start_date,
                    end_date=end_date
                )
```

### 📄 hrms_project\attendance\services\leave_balance_service.py
```from datetime import datetime, date
from typing import List, Optional, Dict, Any, Union
from django.db.models import Q, QuerySet
from django.db import transaction
from calendar import monthrange
from decimal import Decimal

from attendance.models import LeaveBalance, LeaveType, Leave, Employee


class LeaveBalanceService:
    """Service for handling leave balance calculations"""

    @staticmethod
    def _calculate_leave_days(
        leave: Leave,
        start_date: date,
        end_date: date
    ) -> Decimal:
        """
        Calculate leave days for a specific period, handling half days.
        
        Args:
            leave: The leave record
            start_date: Period start date
            end_date: Period end date
            
        Returns:
            Decimal: Number of leave days
        """
        # For leaves spanning multiple months, only count days in current month
        leave_start = max(leave.start_date, start_date)
        leave_end = min(leave.end_date, end_date)
        days = Decimal(str((leave_end - leave_start).days + 1))
        
        # Adjust for half days
        if leave.start_half and leave_start == leave.start_date:
            days -= Decimal('0.5')
        if leave.end_half and leave_end == leave.end_date:
            days -= Decimal('0.5')
            
        return days

    @staticmethod
    def _get_period_dates(month: int, year: int) -> tuple[date, date]:
        """
        Get start and end dates for a given month/year.
        
        Args:
            month: Month number (1-12)
            year: Year
            
        Returns:
            tuple: (start_date, end_date)
        """
        start_date = date(year, month, 1)
        _, last_day = monthrange(year, month)
        end_date = date(year, month, last_day)
        return start_date, end_date

    @staticmethod
    def _process_balance_recalculation(
        employee: Employee,
        leave_type: LeaveType,
        start_date: date,
        end_date: date
    ) -> LeaveBalance:
        """
        Core balance recalculation logic.
        
        Args:
            employee: Employee to process
            leave_type: Leave type to process
            start_date: Period start date
            end_date: Period end date
            
        Returns:
            LeaveBalance: Updated balance record
        """
        # Calculate monthly allowance
        days_per_month = Decimal(str(leave_type.days_allowed)) / Decimal('12')
        
        # Get or create leave balance
        balance, created = LeaveBalance.objects.get_or_create(
            employee=employee,
            leave_type=leave_type,
            defaults={
                'total_days': days_per_month,
                'used_days': Decimal('0'),
                'pending_days': Decimal('0')
            }
        )

        # Get approved leaves in period
        used_leaves = Leave.objects.filter(
            employee=employee,
            leave_type=leave_type,
            start_date__lte=end_date,
            end_date__gte=start_date,
            status='approved',
            is_active=True
        )

        # Calculate total days used
        total_used = sum(
            LeaveBalanceService._calculate_leave_days(leave, start_date, end_date)
            for leave in used_leaves
        )

        # Update balance
        balance.used_days = total_used
        balance.total_days = days_per_month
        balance.save()

        return balance

    @classmethod
    def recalculate_balances(
        cls,
        month: int,
        year: int,
        employees: Optional[QuerySet[Employee]] = None,
        leave_types: Optional[QuerySet[LeaveType]] = None
    ) -> List[LeaveBalance]:
        """
        Recalculate leave balances for specified employees and leave types.
        
        Args:
            month: Month to process
            year: Year to process
            employees: Optional queryset of employees to process (defaults to all active)
            leave_types: Optional queryset of leave types to process (defaults to all active)
            
        Returns:
            List of updated LeaveBalance records
        """
        # Get period dates
        start_date, end_date = cls._get_period_dates(month, year)
        
        # Get employees and leave types if not provided
        if employees is None:
            employees = Employee.objects.filter(is_active=True)
        if leave_types is None:
            leave_types = LeaveType.objects.filter(is_active=True)
        
        balances = []
        with transaction.atomic():
            for employee in employees:
                for leave_type in leave_types:
                    balance = cls._process_balance_recalculation(
                        employee=employee,
                        leave_type=leave_type,
                        start_date=start_date,
                        end_date=end_date
                    )
                    balances.append(balance)
        
        return balances

    @classmethod
    def recalculate_balance(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        month: int,
        year: int
    ) -> LeaveBalance:
        """
        Recalculate leave balance for a specific employee and leave type.
        
        Args:
            employee: Employee to process
            leave_type: Leave type to process
            month: Month to process
            year: Year to process
            
        Returns:
            Updated LeaveBalance record
        """
        # Use the generic function with specific employee and leave type
        balances = cls.recalculate_balances(
            month=month,
            year=year,
            employees=Employee.objects.filter(pk=employee.pk),
            leave_types=LeaveType.objects.filter(pk=leave_type.pk)
        )
        return balances[0]

    @classmethod
    def recalculate_all_balances(cls, month: int, year: int) -> List[LeaveBalance]:
        """
        Recalculate leave balances for all active employees.
        
        Args:
            month: Month to process
            year: Year to process
            
        Returns:
            List of updated LeaveBalance records
        """
        # Use the generic function with default employee and leave type selection
        return cls.recalculate_balances(month=month, year=year)

```

### 📄 hrms_project\attendance\services\leave_rule_service.py
```from datetime import datetime, date, timedelta
from decimal import Decimal
from typing import Tuple, Dict, Any, Optional
from django.db.models import Q
from django.utils import timezone

from ..models import (
    Leave, LeaveType, LeaveBalance, LeaveBalanceTier,
    Employee, Holiday, AttendanceLog, LeaveBeginningBalance
)

class LeaveRuleService:
    """Service for handling leave request validation and rules"""
    
    @classmethod
    def validate_leave_request(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """
        Validate a leave request based on leave type rules
        
        Args:
            employee: The employee requesting leave
            leave_type: The type of leave being requested
            sub_type: The sub-type of leave (if applicable)
            start_date: The start date of the leave
            end_date: The end date of the leave
            
        Returns:
            Tuple containing:
            - bool: Whether the request is valid
            - str: Message explaining the validation result
            - dict: Additional data (e.g., available balance)
        """
        # Ensure end date is never less than start date
        if end_date < start_date:
            end_date = start_date
            
        # Get the appropriate validator based on leave type
        validator = cls._get_validator(leave_type.code)
        return validator(employee, leave_type, sub_type, start_date, end_date)
    
    @classmethod
    def _get_validator(cls, leave_type_code: str):
        """Return appropriate validator function based on leave type"""
        validators = {
            'ANNUAL': cls._validate_annual_leave,
            'HALF': cls._validate_annual_leave,  # Uses same balance as annual
            'SICK': cls._validate_sick_leave,
            'HAJJ': cls._validate_hajj_leave,
            'DEATH': cls._validate_death_leave,
            'MARRIAGE': cls._validate_fixed_duration_leave,
            'PATERNITY': cls._validate_fixed_duration_leave,
            'MATERNITY': cls._validate_maternity_leave,
            'IDDAH': cls._validate_iddah_leave,
            'INJURY': cls._validate_injury_leave,
            'EMERG': cls._validate_emergency_leave,
            'PERMISSION': cls._validate_permission_leave
        }
        return validators.get(leave_type_code, cls._validate_default)
    
    @classmethod
    def _validate_annual_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate annual or half-day leave request"""
        # Calculate duration based on sub-type
        if sub_type in ['half_day', 'morning', 'afternoon']:
            duration = Decimal('0.5')
        else:
            duration = cls._calculate_leave_duration(start_date, end_date)
            
        # Get beginning balance
        beginning_balance = LeaveBeginningBalance.objects.filter(
            employee=employee,
            leave_type=leave_type
        ).order_by('-as_of_date').first()
        
        initial_balance = beginning_balance.balance_days if beginning_balance else 0
        
        # Get beginning date (try join_date first, then beginning balance, then default to Jan 1st)
        if beginning_balance:
            start_date_calc = beginning_balance.as_of_date
        else:
            # Try to get join_date if it exists
            if hasattr(employee, 'join_date') and employee.join_date:
                start_date_calc = employee.join_date
            else:
                # Default to January 1st of current year
                current_year = date.today().year
                start_date_calc = date(current_year, 1, 1)
        
        end_date_calc = date.today()
        
        try:
            # Get holidays for the period
            holiday_dates = set(Holiday.objects.filter(
                date__range=[start_date_calc, end_date_calc]
            ).values_list('date', flat=True))
            
            # Get attendance logs for the period
            attendance_logs = set(AttendanceLog.objects.filter(
                employee=employee,
                date__range=[start_date_calc, end_date_calc],
                status='present'
            ).values_list('date', flat=True))
            
            # Count Fridays that should be included
            friday_count = 0
            current_date = start_date_calc
            while current_date <= end_date_calc:
                if current_date.weekday() == 4:  # Friday
                    thursday = current_date - timedelta(days=1)
                    saturday = current_date + timedelta(days=1)
                    
                    # Check if Thursday or Saturday was attended or was a holiday
                    thursday_attended = thursday in attendance_logs or thursday in holiday_dates
                    saturday_attended = saturday in attendance_logs or saturday in holiday_dates
                    
                    if thursday_attended or saturday_attended:
                        friday_count += 1
                
                current_date += timedelta(days=1)
            
            # Calculate total working days including valid Fridays and holidays
            total_working_days = Decimal(len(attendance_logs) + friday_count + len(holiday_dates))
            
            # Calculate monthly rate (2.5 days per month, assuming 30 working days per month)
            daily_rate = Decimal('2.5') / Decimal('30')
            
            # Calculate accrued leave
            accrued_days = total_working_days * daily_rate
            
            # Get leave balance
            balance = LeaveBalance.objects.filter(
                employee=employee,
                leave_type=leave_type,
                is_active=True
            ).first()
            
            # Get used days from balance
            used_days = balance.used_days if balance else Decimal('0')
            pending_days = balance.pending_days if balance else Decimal('0')
            
            # Calculate total and remaining days
            total_days = Decimal(initial_balance) + accrued_days
            remaining_days = total_days - used_days - pending_days
            
            # Add pending days for this request if it's not already approved
            # This ensures that if a user has a pending request, they can't submit another one that would exceed their balance
            pending_leave_days = Decimal('0')
            pending_leaves = Leave.objects.filter(
                employee=employee,
                leave_type=leave_type,
                status='pending',
                is_active=True
            ).exclude(start_date=start_date, end_date=end_date)  # Exclude current request if editing
            
            for leave in pending_leaves:
                pending_leave_days += leave.duration
            
            # Subtract pending days from remaining days
            remaining_days -= pending_leave_days
            
            # Check if sufficient balance
            if remaining_days < duration:
                return False, f"Insufficient balance. Available: {remaining_days:.2f} days", {
                    'available_balance': remaining_days,
                    'requested_duration': duration,
                    'total_days': total_days,
                    'used_days': used_days,
                    'pending_days': pending_days + pending_leave_days,
                    'accrued_days': accrued_days
                }
                
            return True, "Leave can be taken", {
                'available_balance': remaining_days,
                'requested_duration': duration,
                'total_days': total_days,
                'used_days': used_days,
                'pending_days': pending_days + pending_leave_days,
                'accrued_days': accrued_days,
                'is_paid': True
            }
            
        except Exception as e:
            print(f"Error in leave calculation: {str(e)}")
            # If there's an error in calculation, use defaults from balance
            balance = LeaveBalance.objects.filter(
                employee=employee,
                leave_type=leave_type,
                is_active=True
            ).first()
            
            if not balance:
                return False, "No leave balance found", {}
                
            if balance.available_days < duration:
                return False, f"Insufficient balance. Available: {balance.available_days:.2f} days", {
                    'available_balance': balance.available_days,
                    'requested_duration': duration
                }
                
            return True, "Leave can be taken", {
                'available_balance': balance.available_days,
                'requested_duration': duration,
                'is_paid': True
            }
    
    @classmethod
    def _validate_sick_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate sick leave request with tier progression"""
        duration = cls._calculate_leave_duration(start_date, end_date)
        
        # Get sick leave balance and tiers
        balance = LeaveBalance.objects.filter(
            employee=employee,
            leave_type__code='SICK',
            is_active=True
        ).first()
        
        if not balance:
            return False, "No sick leave balance found", {}
            
        tiers = LeaveBalanceTier.objects.filter(
            balance=balance
        ).order_by('tier_number')
        
        if not tiers.exists():
            # Create tiers if they don't exist
            tiers = [
                LeaveBalanceTier.objects.create(
                    balance=balance,
                    tier_number=1,
                    tier_name='Full Pay',
                    days_allowed=15,
                    pay_percentage=100
                ),
                LeaveBalanceTier.objects.create(
                    balance=balance,
                    tier_number=2,
                    tier_name='Half Pay',
                    days_allowed=20,
                    pay_percentage=50
                ),
                LeaveBalanceTier.objects.create(
                    balance=balance,
                    tier_number=3,
                    tier_name='No Pay',
                    days_allowed=20,
                    pay_percentage=0
                )
            ]
        
        # Find available tier
        available_tier = None
        for tier in tiers:
            if tier.days_used < tier.days_allowed:
                available_tier = tier
                break
                
        if not available_tier:
            return False, "All sick leave tiers exhausted", {
                'tiers': [
                    {
                        'name': tier.tier_name,
                        'used': tier.days_used,
                        'allowed': tier.days_allowed
                    }
                    for tier in tiers
                ]
            }
            
        # Check if requested duration fits in current tier
        remaining_in_tier = available_tier.days_allowed - available_tier.days_used
        if duration > remaining_in_tier:
            return False, f"Requested duration exceeds available days in {available_tier.tier_name} tier", {
                'available_days': remaining_in_tier,
                'requested_duration': duration,
                'tier': available_tier.tier_name
            }
            
        return True, f"Leave can be taken using {available_tier.tier_name} tier", {
            'available_days': remaining_in_tier,
            'requested_duration': duration,
            'tier': available_tier.tier_name
        }
    
    @classmethod
    def _validate_hajj_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate Hajj leave (once during employment)"""
        # Check if employee has taken Hajj leave before
        previous_hajj = Leave.objects.filter(
            employee=employee,
            leave_type__code='HAJJ',
            status__in=['approved', 'pending'],
            is_active=True
        ).exists()
        
        if previous_hajj:
            return False, "Hajj leave can only be taken once during employment", {}
            
        # Validate duration
        duration = cls._calculate_leave_duration(start_date, end_date)
        if duration > 14:  # Hajj leave is fixed at 14 days
            return False, "Hajj leave cannot exceed 14 days", {
                'allowed_duration': 14,
                'requested_duration': duration
            }
            
        return True, "Hajj leave can be taken", {
            'allowed_duration': 14,
            'requested_duration': duration
        }
    
    @classmethod
    def _validate_death_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate death (compassionate) leave"""
        # Get allowed duration based on sub-type
        allowed_duration = {
            'spouse_30': 30,  # woman's husband
            'spouse_3': 3,    # man's wife
            'first_degree': 3,
            'second_degree': 3
        }.get(sub_type)
        
        if not allowed_duration:
            return False, "Invalid death leave sub-type", {}
            
        duration = cls._calculate_leave_duration(start_date, end_date)
        if duration > allowed_duration:
            return False, f"Death leave cannot exceed {allowed_duration} days for this type", {
                'allowed_duration': allowed_duration,
                'requested_duration': duration
            }
            
        return True, "Death leave can be taken", {
            'allowed_duration': allowed_duration,
            'requested_duration': duration
        }
    
    @classmethod
    def _validate_maternity_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate maternity leave request"""
        # Check gender
        if employee.gender != 'F':
            return False, "Maternity leave is only available for female employees", {}

        # Validate duration based on sub-type
        duration = cls._calculate_leave_duration(start_date, end_date)
        if sub_type == 'paid_60':
            if duration != 60:
                return False, "Paid maternity leave must be exactly 60 days", {
                    'allowed_duration': 60,
                    'requested_duration': duration
                }
        elif sub_type == 'unpaid_15':
            if duration != 15:
                return False, "Additional unpaid maternity leave must be exactly 15 days", {
                    'allowed_duration': 15,
                    'requested_duration': duration
                }
        else:
            return False, "Invalid maternity leave sub-type", {}

        return True, "Maternity leave can be taken", {
            'requested_duration': duration,
            'is_paid': sub_type == 'paid_60'
        }
    
    @classmethod
    def _validate_iddah_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate Iddah leave request"""
        # Check gender
        if employee.gender != 'F':
            return False, "Iddah leave is only available for female employees", {}

        # Validate duration based on sub-type
        duration = cls._calculate_leave_duration(start_date, end_date)
        if sub_type == 'paid_30':
            if duration != 30:
                return False, "Paid Iddah leave must be exactly 30 days", {
                    'allowed_duration': 30,
                    'requested_duration': duration
                }
        elif sub_type == 'unpaid_100':
            if duration != 100:
                return False, "Unpaid Iddah leave must be exactly 100 days", {
                    'allowed_duration': 100,
                    'requested_duration': duration
                }
        else:
            return False, "Invalid Iddah leave sub-type", {}

        return True, "Iddah leave can be taken", {
            'requested_duration': duration,
            'is_paid': sub_type == 'paid_30'
        }
    
    @classmethod
    def _validate_injury_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate injury leave request"""
        duration = cls._calculate_leave_duration(start_date, end_date)
        if duration > 180:  # Maximum as per Social Insurance Law
            return False, "Injury leave cannot exceed 180 days", {
                'allowed_duration': 180,
                'requested_duration': duration
            }
        return True, "Injury leave can be taken", {'requested_duration': duration}
    
    @classmethod
    def _validate_emergency_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate emergency leave request"""
        duration = cls._calculate_leave_duration(start_date, end_date)
        if duration > 5:  # Maximum emergency leave days
            return False, "Emergency leave cannot exceed 5 days", {
                'allowed_duration': 5,
                'requested_duration': duration
            }
        return True, "Emergency leave can be taken", {'requested_duration': duration}
    
    @classmethod
    def _validate_permission_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate permission leave request"""
        duration = cls._calculate_leave_duration(start_date, end_date)
        if duration > 3:  # Maximum permission leave days
            return False, "Permission leave cannot exceed 3 days", {
                'allowed_duration': 3,
                'requested_duration': duration
            }
        if duration < 0.5:  # Minimum half day
            return False, "Permission leave must be at least half day", {
                'min_duration': 0.5,
                'requested_duration': duration
            }
        return True, "Permission leave can be taken", {'requested_duration': duration}
    
    @classmethod
    def _validate_fixed_duration_leave(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Validate fixed duration leaves (Marriage, Paternity)"""
        duration = cls._calculate_leave_duration(start_date, end_date)
        allowed_duration = leave_type.days_allowed

        if duration != allowed_duration:
            return False, f"{leave_type.name} must be exactly {allowed_duration} days", {
                'allowed_duration': allowed_duration,
                'requested_duration': duration
            }

        # Check gender for paternity leave
        if leave_type.code == 'PATERNITY' and employee.gender != 'M':
            return False, "Paternity leave is only available for male employees", {}

        return True, f"{leave_type.name} can be taken", {'requested_duration': duration}
    
    @classmethod
    def _validate_default(
        cls,
        employee: Employee,
        leave_type: LeaveType,
        sub_type: str,
        start_date: date,
        end_date: date
    ) -> Tuple[bool, str, Dict[str, Any]]:
        """Default validator for leave types without special rules"""
        duration = cls._calculate_leave_duration(start_date, end_date)
        
        # Check if duration matches any fixed duration sub-type
        if sub_type:
            try:
                allowed_days = int(sub_type.split('_')[0])
                if duration != allowed_days:
                    return False, f"Leave duration must be exactly {allowed_days} days", {
                        'allowed_duration': allowed_days,
                        'requested_duration': duration
                    }
            except (ValueError, IndexError):
                pass
        
        return True, "Leave can be taken", {
            'requested_duration': duration
        }
    
    @staticmethod
    def _calculate_leave_duration(start_date: date, end_date: date) -> Decimal:
        """Calculate leave duration excluding holidays"""
        # Ensure end date is never less than start date
        if end_date < start_date:
            end_date = start_date
            
        duration = (end_date - start_date).days + 1
        
        # Subtract holidays
        holidays = Holiday.objects.filter(
            date__range=[start_date, end_date],
            is_active=True
        ).count()
        
        return Decimal(str(duration - holidays)) 
```

### 📄 hrms_project\attendance\services\pdf_service.py
```from typing import Dict, Any, Optional
from datetime import datetime
import tempfile
from pathlib import Path

from django.template.loader import render_to_string
from django.conf import settings
from weasyprint import HTML, CSS
from weasyprint.text.fonts import FontConfiguration

class PDFReportService:
    """Service for generating PDF reports from attendance data"""
    
    @classmethod
    def generate_attendance_report_pdf(cls, data: Dict[str, Any], template_name: str = 'attendance/pdf/attendance_report.html') -> bytes:
        """
        Generate PDF report for attendance data
        
        Args:
            data: Dictionary containing report data
            template_name: Name of the template to use for PDF generation
            
        Returns:
            PDF file content as bytes
        """
        # Prepare the HTML content
        html_string = render_to_string(template_name, {
            'data': data,
            'generated_at': datetime.now(),
            'report_type': 'Attendance Report'
        })
        
        # Set up fonts
        font_config = FontConfiguration()
        
        # Get CSS for PDF
        css_string = cls._get_report_css()
        
        # Create PDF
        html = HTML(string=html_string)
        css = CSS(string=css_string, font_config=font_config)
        
        # Use temp file to avoid memory issues with large reports
        with tempfile.NamedTemporaryFile(delete=False, suffix='.pdf') as tmp_file:
            html.write_pdf(
                target=tmp_file.name,
                stylesheets=[css],
                font_config=font_config,
                presentational_hints=True
            )
            
            # Read the generated PDF
            with open(tmp_file.name, 'rb') as pdf_file:
                pdf_content = pdf_file.read()
                
        # Clean up temp file
        Path(tmp_file.name).unlink()
        
        return pdf_content
    
    @classmethod
    def generate_leave_report_pdf(cls, data: Dict[str, Any], template_name: str = 'attendance/pdf/leave_report.html') -> bytes:
        """Generate PDF report for leave data"""
        html_string = render_to_string(template_name, {
            'data': data,
            'generated_at': datetime.now(),
            'report_type': 'Leave Report'
        })
        
        font_config = FontConfiguration()
        css_string = cls._get_report_css()
        
        html = HTML(string=html_string)
        css = CSS(string=css_string, font_config=font_config)
        
        with tempfile.NamedTemporaryFile(delete=False, suffix='.pdf') as tmp_file:
            html.write_pdf(
                target=tmp_file.name,
                stylesheets=[css],
                font_config=font_config,
                presentational_hints=True
            )
            
            with open(tmp_file.name, 'rb') as pdf_file:
                pdf_content = pdf_file.read()
                
        Path(tmp_file.name).unlink()
        
        return pdf_content
    
    @classmethod
    def generate_holiday_report_pdf(cls, data: Dict[str, Any], template_name: str = 'attendance/pdf/holiday_report.html') -> bytes:
        """Generate PDF report for holiday data"""
        html_string = render_to_string(template_name, {
            'data': data,
            'generated_at': datetime.now(),
            'report_type': 'Holiday Report'
        })
        
        font_config = FontConfiguration()
        css_string = cls._get_report_css()
        
        html = HTML(string=html_string)
        css = CSS(string=css_string, font_config=font_config)
        
        with tempfile.NamedTemporaryFile(delete=False, suffix='.pdf') as tmp_file:
            html.write_pdf(
                target=tmp_file.name,
                stylesheets=[css],
                font_config=font_config,
                presentational_hints=True
            )
            
            with open(tmp_file.name, 'rb') as pdf_file:
                pdf_content = pdf_file.read()
                
        Path(tmp_file.name).unlink()
        
        return pdf_content
    
    @staticmethod
    def _get_report_css() -> str:
        """Get CSS styles for PDF reports"""
        return """
            @page {
                size: A4;
                margin: 2.5cm 1.5cm;
                @top-center {
                    content: string(title);
                }
                @bottom-right {
                    content: "Page " counter(page) " of " counter(pages);
                }
            }
            
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                line-height: 1.4;
                font-size: 11pt;
                color: #333;
            }
            
            .report-header {
                text-align: center;
                margin-bottom: 2em;
                string-set: title content();
            }
            
            .report-title {
                font-size: 24pt;
                font-weight: bold;
                margin-bottom: 0.5em;
            }
            
            .report-subtitle {
                font-size: 14pt;
                color: #666;
            }
            
            .summary-cards {
                display: flex;
                justify-content: space-between;
                margin: 2em 0;
            }
            
            .summary-card {
                padding: 1em;
                border: 1px solid #ddd;
                border-radius: 4px;
                width: 23%;
            }
            
            .summary-card h3 {
                margin: 0;
                color: #666;
                font-size: 12pt;
            }
            
            .summary-card .value {
                font-size: 20pt;
                font-weight: bold;
                margin: 0.5em 0;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 1em 0;
            }
            
            th, td {
                padding: 0.5em;
                border: 1px solid #ddd;
                text-align: left;
            }
            
            th {
                background-color: #f5f5f5;
                font-weight: bold;
            }
            
            tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            
            .chart-container {
                margin: 2em 0;
                page-break-inside: avoid;
            }
            
            .footer {
                margin-top: 2em;
                font-size: 9pt;
                color: #666;
                text-align: center;
            }
        """
```

### 📄 hrms_project\attendance\services\ramadan_service.py
```from datetime import date, datetime, timedelta
from typing import Optional, Dict, Any, List, Tuple
from django.db import transaction
from django.utils import timezone
from django.core.exceptions import ValidationError

from ..models import RamadanPeriod

class RamadanService:
    """Service for handling Ramadan period operations"""

    @staticmethod
    def _validate_period(
        start_date: date,
        end_date: date,
        year: int,
        exclude_id: Optional[int] = None
    ) -> Tuple[int, bool]:
        """
        Validate Ramadan period dates and check for overlaps.
        
        Args:
            start_date: Proposed start date
            end_date: Proposed end date
            year: Year the period should be in
            exclude_id: Optional ID to exclude from overlap check
            
        Returns:
            Tuple of (duration_days, has_overlap)
            
        Raises:
            ValueError: If dates are invalid
        """
        # Check year consistency
        if start_date.year != year or end_date.year != year:
            raise ValueError("Start and end dates must be within the specified year")
            
        # Check date order
        if end_date < start_date:
            raise ValueError("End date cannot be before start date")
            
        # Check duration (typical Ramadan is 29-30 days)
        duration = (end_date - start_date).days + 1
        if duration < 28 or duration > 31:
            raise ValueError(f"Duration ({duration} days) seems invalid for Ramadan")
            
        # Check for overlaps
        query = RamadanPeriod.objects.filter(
            start_date__lte=end_date,
            end_date__gte=start_date
        )
        if exclude_id is not None:
            query = query.exclude(id=exclude_id)
            
        has_overlap = query.exists()
        if has_overlap:
            raise ValueError("This period overlaps with an existing Ramadan period")
            
        return duration, has_overlap

    @staticmethod
    def validate_period_dates(
        start_date: date,
        end_date: date,
        year: int,
        exclude_id: Optional[int] = None
    ) -> bool:
        """
        Public method to validate Ramadan period dates.
        
        Args:
            start_date: Proposed start date
            end_date: Proposed end date
            year: Year the period should be in
            exclude_id: Optional ID to exclude from overlap check
            
        Returns:
            True if dates are valid
            
        Raises:
            ValueError: If validation fails
        """
        RamadanService._validate_period(start_date, end_date, year, exclude_id)
        return True

    @staticmethod
    def get_active_period(date_to_check: Optional[date] = None) -> Optional[RamadanPeriod]:
        """
        Get the active Ramadan period for a given date.
        
        Args:
            date_to_check: The date to check (defaults to today)
            
        Returns:
            RamadanPeriod if date falls within an active period, None otherwise
        """
        if not date_to_check:
            date_to_check = timezone.now().date()
            
        return RamadanPeriod.objects.filter(
            start_date__lte=date_to_check,
            end_date__gte=date_to_check,
            is_active=True
        ).first()

    @staticmethod
    def create_period(year: int, start_date: date, end_date: date) -> RamadanPeriod:
        """
        Create a new Ramadan period.
        
        Args:
            year: The year of the Ramadan period
            start_date: Start date of Ramadan
            end_date: End date of Ramadan
            
        Returns:
            The created RamadanPeriod instance
            
        Raises:
            ValueError: If dates are invalid or period overlaps
        """
        # Validate period
        RamadanService._validate_period(start_date, end_date, year)
            
        return RamadanPeriod.objects.create(
            year=year,
            start_date=start_date,
            end_date=end_date,
            is_active=True
        )

    @staticmethod
    @transaction.atomic
    def update_period(
        period_id: int,
        year: int,
        start_date: date,
        end_date: date,
        is_active: bool
    ) -> RamadanPeriod:
        """
        Update an existing Ramadan period.
        
        Args:
            period_id: ID of the period to update
            year: New year
            start_date: New start date
            end_date: New end date
            is_active: New active status
            
        Returns:
            The updated RamadanPeriod instance
            
        Raises:
            ValueError: If dates are invalid or period overlaps
            RamadanPeriod.DoesNotExist: If period_id is invalid
        """
        # Validate period
        RamadanService._validate_period(start_date, end_date, year, period_id)
            
        period = RamadanPeriod.objects.get(id=period_id)
        period.year = year
        period.start_date = start_date
        period.end_date = end_date
        period.is_active = is_active
        period.save()
        
        return period

    @staticmethod
    def get_all_periods(include_inactive: bool = False) -> List[Dict[str, Any]]:
        """
        Get all Ramadan periods with optional filtering.
        
        Args:
            include_inactive: Whether to include inactive periods
            
        Returns:
            List of dictionaries containing period details
        """
        queryset = RamadanPeriod.objects.all()
        if not include_inactive:
            queryset = queryset.filter(is_active=True)
            
        return [{
            'id': period.id,
            'year': period.year,
            'start_date': period.start_date,
            'end_date': period.end_date,
            'is_active': period.is_active,
            'duration': (period.end_date - period.start_date).days + 1
        } for period in queryset.order_by('-year')]

    @staticmethod
    def calculate_working_hours(
        normal_hours: float,
        is_ramadan: bool = False
    ) -> float:
        """
        Calculate adjusted working hours for Ramadan.
        
        Args:
            normal_hours: Regular working hours
            is_ramadan: Whether the calculation is for Ramadan period
            
        Returns:
            Adjusted working hours
        """
        if not is_ramadan:
            return normal_hours
            
        # Default Ramadan reduction (2 hours less)
        return max(normal_hours - 2, 4)  # Minimum 4 hours

    @staticmethod
    def get_ramadan_shift_timing(shift, date) -> Dict[str, Any]:
        """
        Get Ramadan-adjusted shift timing if applicable.

        Args:
            shift: The shift to get timings for
            date: The date to check

        Returns:
            Dict with start_time and end_time, or empty dict if not in Ramadan
        """
        if not shift:
            return {}

        # Check if date falls in Ramadan period
        ramadan_period = RamadanService.get_active_period(date)
        if not ramadan_period:
            return {}

        # Use Ramadan specific times if set, otherwise use default times
        start_time = shift.ramadan_start_time or shift.start_time
        end_time = shift.ramadan_end_time or shift.end_time

        return {
            'start_time': start_time,
            'end_time': end_time,
            'is_ramadan': True
        }

```

### 📄 hrms_project\attendance\services\report_generator.py
```from typing import Dict, Any, Optional, List
from datetime import datetime
import csv
import xlsxwriter
from django.http import HttpResponse
from rest_framework.response import Response
from rest_framework.exceptions import ValidationError
from django.core.exceptions import ObjectDoesNotExist

from .pdf_service import PDFReportService
from .report_service import ReportService

class BaseReportGenerator:
    """Base class for report generation with common functionality"""
    
    def __init__(self, report_type: str):
        self.report_type = report_type
        self.exporters = {
            'csv': self._to_csv,
            'excel': self._to_excel,
            'pdf': self._to_pdf,
            'json': self._to_json
        }

    def generate(self, format: str, **params) -> Any:
        """
        Main entry point for report generation.
        
        Args:
            format: Output format (csv, excel, pdf, json)
            **params: Report parameters
            
        Returns:
            Generated report in requested format
        """
        data = self._gather_data(**params)
        exporter = self.exporters.get(format)
        if not exporter:
            raise ValueError(f"Unsupported format: {format}")
        return exporter(data)

    def _gather_data(self, **params) -> Dict:
        """
        Gather and process data for the report.
        To be implemented by subclasses.
        """
        raise NotImplementedError("Subclasses must implement _gather_data")

    def _to_json(self, data: Dict) -> Response:
        """Convert report data to JSON response"""
        return Response(data)

    def _to_pdf(self, data: Dict) -> HttpResponse:
        """Generate PDF report"""
        try:
            pdf_generators = {
                'attendance': PDFReportService.generate_attendance_report_pdf,
                'leave': PDFReportService.generate_leave_report_pdf,
                'holiday': PDFReportService.generate_holiday_report_pdf
            }
            
            generator = pdf_generators.get(self.report_type)
            if not generator:
                raise ValueError(f"PDF generation not supported for {self.report_type}")
            
            pdf_content = generator(data)
            filename = f"{self.report_type}_report_{datetime.now().strftime('%Y%m%d')}.pdf"
            
            response = HttpResponse(pdf_content, content_type='application/pdf')
            response['Content-Disposition'] = f'attachment; filename="{filename}"'
            return response
            
        except Exception as e:
            raise ValidationError(f"Error generating PDF: {str(e)}")

    def _to_csv(self, data: Dict) -> HttpResponse:
        """Generate CSV report"""
        response = HttpResponse(content_type='text/csv')
        response['Content-Disposition'] = f'attachment; filename="{self.report_type}_report.csv"'
        writer = csv.writer(response)
        self._write_csv(writer, data)
        return response

    def _to_excel(self, data: Dict) -> HttpResponse:
        """Generate Excel report"""
        response = HttpResponse(
            content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        )
        response['Content-Disposition'] = f'attachment; filename="{self.report_type}_report.xlsx"'
        
        workbook = xlsxwriter.Workbook(response)
        self._write_excel(workbook, data)
        workbook.close()
        return response

    def _write_csv(self, writer: csv.writer, data: Dict):
        """Write data to CSV format. To be implemented by subclasses."""
        raise NotImplementedError("Subclasses must implement _write_csv")

    def _write_excel(self, workbook: 'xlsxwriter.Workbook', data: Dict):
        """Write data to Excel format. To be implemented by subclasses."""
        raise NotImplementedError("Subclasses must implement _write_excel")

class AttendanceReportGenerator(BaseReportGenerator):
    """Generator for attendance reports"""
    
    def __init__(self):
        super().__init__('attendance')

    def _gather_data(self, **params) -> Dict:
        try:
            return ReportService.get_attendance_report(**params)
        except ObjectDoesNotExist as e:
            raise ValidationError(f"Data not found: {str(e)}")
        except Exception as e:
            raise ValidationError(f"Error generating attendance report: {str(e)}")

    def _write_csv(self, writer: csv.writer, data: Dict):
        # Write summary
        writer.writerow(['Summary'])
        writer.writerow(['Status', 'Count'])
        for status, count in data['summary'].items():
            writer.writerow([status.title(), count])
        
        # Write employee records
        writer.writerow([])
        writer.writerow(['Employee Records'])
        writer.writerow(['ID', 'Name', 'Department', 'Present', 'Absent', 'Late', 'Leave'])
        for record in data['employee_records']:
            writer.writerow([
                record['id'],
                record['name'],
                record['department'],
                record['present_days'],
                record['absent_days'],
                record['late_days'],
                record['leave_days']
            ])

    def _write_excel(self, workbook: 'xlsxwriter.Workbook', data: Dict):
        # Summary worksheet
        ws = workbook.add_worksheet('Summary')
        ws.write('A1', 'Summary')
        ws.write('A2', 'Status')
        ws.write('B2', 'Count')
        row = 3
        for status, count in data['summary'].items():
            ws.write(f'A{row}', status.title())
            ws.write(f'B{row}', count)
            row += 1
        
        # Employee records worksheet
        ws = workbook.add_worksheet('Employee Records')
        headers = ['ID', 'Name', 'Department', 'Present', 'Absent', 'Late', 'Leave']
        for col, header in enumerate(headers):
            ws.write(0, col, header)
        
        for row, record in enumerate(data['employee_records'], 1):
            ws.write(row, 0, record['id'])
            ws.write(row, 1, record['name'])
            ws.write(row, 2, record['department'])
            ws.write(row, 3, record['present_days'])
            ws.write(row, 4, record['absent_days'])
            ws.write(row, 5, record['late_days'])
            ws.write(row, 6, record['leave_days'])

class LeaveReportGenerator(BaseReportGenerator):
    """Generator for leave reports"""
    
    def __init__(self):
        super().__init__('leave')

    def _gather_data(self, **params) -> Dict:
        try:
            return ReportService.get_leave_report(**params)
        except ObjectDoesNotExist as e:
            raise ValidationError(f"Data not found: {str(e)}")
        except Exception as e:
            raise ValidationError(f"Error generating leave report: {str(e)}")

    def _write_csv(self, writer: csv.writer, data: Dict):
        writer.writerow(['Leave Type Statistics'])
        writer.writerow(['Type', 'Count', 'Average Duration'])
        for stat in data['leave_type_stats']:
            writer.writerow([
                stat['leave_type'],
                stat['count'],
                round(stat['avg_duration'], 2) if stat['avg_duration'] else 0
            ])

    def _write_excel(self, workbook: 'xlsxwriter.Workbook', data: Dict):
        ws = workbook.add_worksheet('Leave Statistics')
        headers = ['Type', 'Count', 'Average Duration']
        for col, header in enumerate(headers):
            ws.write(0, col, header)
        
        for row, stat in enumerate(data['leave_type_stats'], 1):
            ws.write(row, 0, stat['leave_type'])
            ws.write(row, 1, stat['count'])
            ws.write(row, 2, round(stat['avg_duration'], 2) if stat['avg_duration'] else 0)

class HolidayReportGenerator(BaseReportGenerator):
    """Generator for holiday reports"""
    
    def __init__(self):
        super().__init__('holiday')

    def _gather_data(self, **params) -> Dict:
        try:
            return ReportService.get_holiday_report(**params)
        except ObjectDoesNotExist as e:
            raise ValidationError(f"Data not found: {str(e)}")
        except Exception as e:
            raise ValidationError(f"Error generating holiday report: {str(e)}")

    def _write_csv(self, writer: csv.writer, data: Dict):
        writer.writerow(['Date', 'Name', 'Description', 'Type'])
        for holiday in data['holidays']:
            writer.writerow([
                holiday['date'],
                holiday['name'],
                holiday['description'],
                holiday['type']
            ])

    def _write_excel(self, workbook: 'xlsxwriter.Workbook', data: Dict):
        ws = workbook.add_worksheet('Holidays')
        headers = ['Date', 'Name', 'Description', 'Type']
        for col, header in enumerate(headers):
            ws.write(0, col, header)
        
        for row, holiday in enumerate(data['holidays'], 1):
            ws.write(row, 0, holiday['date'])
            ws.write(row, 1, holiday['name'])
            ws.write(row, 2, holiday['description'])
            ws.write(row, 3, holiday['type'])

class ReportGeneratorFactory:
    """Factory for creating report generators"""
    
    GENERATORS = {
        'attendance': AttendanceReportGenerator,
        'leave': LeaveReportGenerator,
        'holiday': HolidayReportGenerator
    }
    
    @classmethod
    def create(cls, report_type: str) -> BaseReportGenerator:
        """Create appropriate report generator instance"""
        generator_class = cls.GENERATORS.get(report_type)
        if not generator_class:
            raise ValueError(f"Unknown report type: {report_type}")
        return generator_class()

```

### 📄 hrms_project\attendance\services\report_service.py
```from datetime import datetime, date, timedelta
from typing import List, Dict, Any, Optional, Callable, TypeVar
from django.db.models import Count, Q
from django.core.cache import cache
from django.utils import timezone
from functools import wraps
import logging

from ..models import (
    AttendanceLog, Leave, Holiday, LeaveType
)
from employees.models import Employee, Department
from ..cache import generate_cache_key

logger = logging.getLogger('attendance')

T = TypeVar('T', bound=Dict[str, Any])

class ReportService:
    """Service class for generating various attendance reports"""
    
    CACHE_TIMEOUT = 3600  # 1 hour cache timeout
    
    @classmethod
    def _get_cache_key(cls, report_type: str, **params) -> str:
        """Generate a cache key based on report type and parameters"""
        # Convert params to a sorted tuple of values for consistent cache keys
        param_values = []
        for key in sorted(params.keys()):
            value = params[key]
            if isinstance(value, (list, tuple)):
                # Sort lists/tuples for consistent cache keys
                value = tuple(sorted(value))
            param_values.append(value)
        
        return generate_cache_key(f'report_{report_type}', *param_values)

    @classmethod
    def _generate_report(
        cls,
        report_type: str,
        data_generator: Callable[..., T],
        params: Dict[str, Any]
    ) -> T:
        """
        Base report generation function with caching.
        
        Args:
            report_type: Type of report being generated
            data_generator: Function that generates the report data
            params: Parameters for report generation
            
        Returns:
            Generated report data
        """
        logger.debug(f"Generating {report_type} report with params: {params}")
        
        try:
            # Check cache first
            cache_key = cls._get_cache_key(report_type, **params)
            cached_data = cache.get(cache_key)
            if cached_data:
                logger.debug("Returning cached report data")
                return cached_data

            # Generate report data
            report_data = data_generator(**params)
            logger.debug("Successfully generated report data")

            # Add common fields
            report_data.update({
                'start_date': params['start_date'],
                'end_date': params['end_date'],
                'generated_at': timezone.now()
            })

            # Cache the report
            cache.set(cache_key, report_data, cls.CACHE_TIMEOUT)
            return report_data
            
        except Exception as e:
            logger.error(f"Error generating report data: {str(e)}")
            raise

    @classmethod
    def _generate_attendance_data(
        cls,
        start_date: datetime,
        end_date: datetime,
        departments: Optional[List[int]] = None,
        employees: Optional[List[int]] = None,
        status: Optional[List[str]] = None
    ) -> Dict[str, Any]:
        """Generate attendance report data"""
        # Convert datetime to date for database queries
        start_date = start_date.date()
        end_date = end_date.date()
        
        # Build base query for employees
        base_query = Employee.objects.all()
        if departments:
            base_query = base_query.filter(department_id__in=departments)
        if employees:
            base_query = base_query.filter(id__in=employees)

        # Get holidays
        holidays = Holiday.objects.filter(
            date__range=[start_date, end_date],
            is_active=True
        )
        holiday_dates = set(h.date for h in holidays)

        # Get attendance logs
        attendance_logs = AttendanceLog.objects.filter(
            date__range=[start_date, end_date]
        )
        holiday_logs = attendance_logs.filter(date__in=holiday_dates)
        non_holiday_logs = attendance_logs.exclude(date__in=holiday_dates)

        # Calculate statistics
        present_count = (
            non_holiday_logs.filter(first_in_time__isnull=False, is_late=False).count() +
            holiday_logs.filter(first_in_time__isnull=False).count()
        )
        late_count = non_holiday_logs.filter(is_late=True).count()
        absent_count = non_holiday_logs.filter(first_in_time__isnull=True).count()
        leave_count = Leave.objects.filter(
            Q(start_date__lte=end_date) & 
            Q(end_date__gte=start_date) &
            Q(status='approved')
        ).count()

        # Generate trend data
        trend_data = cls._generate_trend_data(
            start_date, end_date, attendance_logs, holidays, holiday_dates
        )

        # Generate department statistics
        department_stats = cls._generate_department_stats(
            holiday_logs, non_holiday_logs, start_date, end_date
        )

        # Generate employee records
        employee_records = cls._generate_employee_records(
            base_query, holiday_logs, non_holiday_logs, start_date, end_date
        )

        return {
            'summary': {
                'present': present_count,
                'absent': absent_count,
                'late': late_count,
                'leave': leave_count
            },
            'trend_data': trend_data,
            'department_stats': department_stats,
            'employee_records': employee_records,
            'holidays': [
                {
                    'date': h.date.strftime('%Y-%m-%d'),
                    'name': h.name,
                    'description': h.description if hasattr(h, 'description') else ''
                }
                for h in holidays
            ]
        }

    @classmethod
    def _generate_leave_data(
        cls,
        start_date: datetime,
        end_date: datetime,
        departments: Optional[List[int]] = None,
        employees: Optional[List[int]] = None,
        leave_types: Optional[List[str]] = None
    ) -> Dict[str, Any]:
        """Generate leave report data"""
        # Convert datetime to date for database queries
        start_date = start_date.date()
        end_date = end_date.date()
        
        # Build base query
        leaves = Leave.objects.filter(
            Q(start_date__lte=end_date) & 
            Q(end_date__gte=start_date)
        )
        
        if departments:
            leaves = leaves.filter(employee__department_id__in=departments)
        if employees:
            leaves = leaves.filter(employee_id__in=employees)
        if leave_types:
            leaves = leaves.filter(leave_type__name__in=leave_types)

        # Calculate statistics
        total_leaves = leaves.count()
        approved_leaves = leaves.filter(status='approved').count()
        pending_leaves = leaves.filter(status='pending').count()
        rejected_leaves = leaves.filter(status='rejected').count()

        # Generate leave type statistics
        leave_type_stats = cls._generate_leave_type_stats(leaves)

        # Generate department statistics
        department_stats = cls._generate_leave_department_stats(leaves)

        # Generate employee records
        employee_records = [
            {
                'employee_name': f"{leave.employee.first_name} {leave.employee.last_name}",
                'department': leave.employee.department.name if leave.employee.department else '-',
                'leave_type': leave.leave_type.name,
                'start_date': leave.start_date,
                'end_date': leave.end_date,
                'duration': (leave.end_date - leave.start_date).days + 1,
                'status': leave.status
            }
            for leave in leaves
        ]

        return {
            'total_leaves': total_leaves,
            'approved_leaves': approved_leaves,
            'pending_leaves': pending_leaves,
            'rejected_leaves': rejected_leaves,
            'leave_type_stats': leave_type_stats,
            'department_stats': department_stats,
            'employee_records': employee_records
        }

    @classmethod
    def _generate_holiday_data(
        cls,
        start_date: datetime,
        end_date: datetime
    ) -> Dict[str, Any]:
        """Generate holiday report data"""
        # Convert datetime to date for database queries
        start_date = start_date.date()
        end_date = end_date.date()
        
        holidays = Holiday.objects.filter(
            date__range=[start_date, end_date],
            is_active=True
        ).order_by('date')

        # Generate monthly distribution
        months = {}
        for holiday in holidays:
            month = holiday.date.strftime('%B %Y')
            if month not in months:
                months[month] = {
                    'name': month,
                    'count': 0,
                    'holidays': []
                }
            months[month]['count'] += 1
            months[month]['holidays'].append({
                'date': holiday.date,
                'name': holiday.name
            })

        return {
            'total_holidays': holidays.count(),
            'holidays': [
                {
                    'date': h.date,
                    'name': h.name,
                    'description': h.description if hasattr(h, 'description') else ''
                }
                for h in holidays
            ],
            'monthly_distribution': list(months.values())
        }

    @classmethod
    def get_attendance_report(
        cls,
        start_date: datetime,
        end_date: datetime,
        departments: Optional[List[int]] = None,
        employees: Optional[List[int]] = None,
        status: Optional[List[str]] = None
    ) -> Dict[str, Any]:
        """Generate attendance report for the given parameters"""
        return cls._generate_report(
            'attendance',
            cls._generate_attendance_data,
            {
                'start_date': start_date,
                'end_date': end_date,
                'departments': departments,
                'employees': employees,
                'status': status
            }
        )

    @classmethod
    def get_leave_report(
        cls,
        start_date: datetime,
        end_date: datetime,
        departments: Optional[List[int]] = None,
        employees: Optional[List[int]] = None,
        leave_types: Optional[List[str]] = None
    ) -> Dict[str, Any]:
        """Generate leave report for the given parameters"""
        return cls._generate_report(
            'leave',
            cls._generate_leave_data,
            {
                'start_date': start_date,
                'end_date': end_date,
                'departments': departments,
                'employees': employees,
                'leave_types': leave_types
            }
        )

    @classmethod
    def get_holiday_report(
        cls,
        start_date: datetime,
        end_date: datetime
    ) -> Dict[str, Any]:
        """Generate holiday report for the given date range"""
        return cls._generate_report(
            'holiday',
            cls._generate_holiday_data,
            {
                'start_date': start_date,
                'end_date': end_date
            }
        )

    # Helper methods for generating report components
    @staticmethod
    def _generate_trend_data(
        start_date: datetime,
        end_date: datetime,
        attendance_logs: Any,
        holidays: Any,
        holiday_dates: set
    ) -> List[Dict[str, Any]]:
        """Generate daily trend data"""
        trend_data = []
        current_date = start_date
        while current_date <= end_date:
            day_logs = attendance_logs.filter(date=current_date)
            is_holiday = current_date in holiday_dates
            holiday_obj = holidays.filter(date=current_date).first() if is_holiday else None
            
            if is_holiday:
                trend_data.append({
                    'date': current_date.strftime('%Y-%m-%d'),
                    'present': day_logs.filter(first_in_time__isnull=False).count(),
                    'absent': 0,  # Don't count absences on holidays
                    'late': 0,    # Don't count late on holidays
                    'leave': Leave.objects.filter(
                        Q(start_date__lte=current_date) & 
                        Q(end_date__gte=current_date) &
                        Q(status='approved')
                    ).count(),
                    'is_holiday': True,
                    'holiday_name': holiday_obj.name if holiday_obj else 'Holiday'
                })
            else:
                trend_data.append({
                    'date': current_date.strftime('%Y-%m-%d'),
                    'present': day_logs.filter(first_in_time__isnull=False, is_late=False).count(),
                    'absent': day_logs.filter(first_in_time__isnull=True).count(),
                    'late': day_logs.filter(is_late=True).count(),
                    'leave': Leave.objects.filter(
                        Q(start_date__lte=current_date) & 
                        Q(end_date__gte=current_date) &
                        Q(status='approved')
                    ).count(),
                    'is_holiday': False,
                    'holiday_name': None
                })
            current_date += timedelta(days=1)
        return trend_data

    @staticmethod
    def _generate_department_stats(
        holiday_logs: Any,
        non_holiday_logs: Any,
        start_date: datetime,
        end_date: datetime
    ) -> List[Dict[str, Any]]:
        """Generate department statistics"""
        department_stats = []
        for dept in Department.objects.all():
            dept_holiday_logs = holiday_logs.filter(employee__department=dept)
            dept_non_holiday_logs = non_holiday_logs.filter(employee__department=dept)
            
            department_stats.append({
                'department': dept.name,
                'present': (
                    dept_non_holiday_logs.filter(first_in_time__isnull=False, is_late=False).count() +
                    dept_holiday_logs.filter(first_in_time__isnull=False).count()
                ),
                'absent': dept_non_holiday_logs.filter(first_in_time__isnull=True).count(),
                'late': dept_non_holiday_logs.filter(is_late=True).count(),
                'leave': Leave.objects.filter(
                    Q(employee__department=dept) &
                    Q(start_date__lte=end_date) & 
                    Q(end_date__gte=start_date) &
                    Q(status='approved')
                ).count()
            })
        return department_stats

    @staticmethod
    def _generate_employee_records(
        base_query: Any,
        holiday_logs: Any,
        non_holiday_logs: Any,
        start_date: datetime,
        end_date: datetime
    ) -> List[Dict[str, Any]]:
        """Generate employee records"""
        employee_records = []
        for emp in base_query:
            emp_holiday_logs = holiday_logs.filter(employee=emp)
            emp_non_holiday_logs = non_holiday_logs.filter(employee=emp)
            
            employee_records.append({
                'id': emp.id,
                'name': f"{emp.first_name} {emp.last_name}",
                'department': emp.department.name if emp.department else '-',
                'present_days': (
                    emp_non_holiday_logs.filter(first_in_time__isnull=False, is_late=False).count() +
                    emp_holiday_logs.filter(first_in_time__isnull=False).count()
                ),
                'absent_days': emp_non_holiday_logs.filter(first_in_time__isnull=True).count(),
                'late_days': emp_non_holiday_logs.filter(is_late=True).count(),
                'leave_days': Leave.objects.filter(
                    Q(employee=emp) &
                    Q(start_date__lte=end_date) & 
                    Q(end_date__gte=start_date) &
                    Q(status='approved')
                ).count()
            })
        return employee_records

    @staticmethod
    def _generate_leave_type_stats(leaves: Any) -> List[Dict[str, Any]]:
        """Generate leave type statistics"""
        leave_type_stats = []
        for lt in LeaveType.objects.all():
            lt_leaves = leaves.filter(leave_type=lt)
            if lt_leaves.exists():
                total_days = sum((l.end_date - l.start_date).days + 1 for l in lt_leaves)
                leave_type_stats.append({
                    'leave_type': lt.name,
                    'count': lt_leaves.count(),
                    'avg_duration': total_days / lt_leaves.count() if lt_leaves.count() > 0 else 0
                })
        return leave_type_stats

    @staticmethod
    def _generate_leave_department_stats(leaves: Any) -> List[Dict[str, Any]]:
        """Generate department-wise leave statistics"""
        department_stats = []
        for dept in Department.objects.all():
            dept_leaves = leaves.filter(employee__department=dept)
            if dept_leaves.exists():
                department_stats.append({
                    'department': dept.name,
                    'total_leaves': dept_leaves.count(),
                    'by_type': [
                        {
                            'leave_type': lt.name,
                            'count': dept_leaves.filter(leave_type=lt).count()
                        }
                        for lt in LeaveType.objects.all()
                        if dept_leaves.filter(leave_type=lt).exists()
                    ]
                })
        return department_stats
```

### 📄 hrms_project\attendance\services\shift_service.py
```from datetime import datetime, date, timedelta, time
from typing import Optional, List, Dict, Any

from django.db import transaction
from django.db.models import Q
from django.utils import timezone
from django.contrib.auth.models import User

from ..models import Shift, ShiftAssignment, RamadanPeriod, DateSpecificShift
from employees.models import Employee

class ShiftService:
    @staticmethod
    def get_active_shifts():
        """Get all active shifts ordered by start time"""
        return Shift.objects.filter(is_active=True).order_by('start_time')

    @staticmethod
    def get_employee_current_shift(employee: Employee) -> Optional[Shift]:
        """Get an employee's currently active shift"""
        today = timezone.now().date()
        assignment = ShiftAssignment.objects.filter(
            employee=employee,
            start_date__lte=today,
            is_active=True
        ).filter(
            Q(end_date__isnull=True) | Q(end_date__gte=today)
        ).first()
        if assignment:
            return assignment.shift
        
        # Fallback to default shift if no assignment
        return Shift.objects.filter(
            shift_type='DEFAULT',
            is_active=True
        ).first()

    @staticmethod
    def get_employee_shift_history(employee: Employee) -> List[Dict[str, Any]]:
        """Get complete shift assignment history for an employee"""
        assignments = ShiftAssignment.objects.filter(
            employee=employee
        ).select_related('shift', 'created_by').order_by('-start_date')
        
        return [{
            'shift_name': assignment.shift.name,
            'start_date': assignment.start_date,
            'end_date': assignment.end_date,
            'is_active': assignment.is_active,
            'created_by': assignment.created_by.get_full_name(),
            'created_at': assignment.created_at
        } for assignment in assignments]

    @staticmethod
    @transaction.atomic
    def assign_shift(
        employee: Employee,
        shift: Shift,
        start_date: date,
        end_date: Optional[date],
        created_by: User,
        is_active: bool = True
    ) -> ShiftAssignment:
        """
        Assign a shift to an employee
        
        Args:
            employee: The employee to assign the shift to
            shift: The shift to assign
            start_date: When the assignment starts
            end_date: Optional end date for temporary assignments
            created_by: User creating the assignment
            is_active: Whether the assignment should be active
            
        Returns:
            The created shift assignment
        """
        if is_active:
            # Deactivate any existing active assignments
            ShiftAssignment.objects.filter(
                employee=employee,
                is_active=True
            ).update(is_active=False)
            
        # Create new assignment
        return ShiftAssignment.objects.create(
            employee=employee,
            shift=shift,
            start_date=start_date,
            end_date=end_date,
            created_by=created_by,
            is_active=is_active
        )

    @staticmethod
    def get_shift_timing(shift: Shift, date: date) -> Dict[str, Any]:
        """
        Get shift timing for a given date considering:
        1. Date-specific shifts
        2. Default shift timings
        3. Ramadan adjustments
        
        Args:
            shift: The shift to check
            date: The date to check timing for
            
        Returns:
            Dict with start_time and end_time
        """
        # Check for date-specific shift first
        date_specific = DateSpecificShift.objects.filter(shift=shift, date=date).first()
        if date_specific:
            return {
                'start_time': date_specific.start_time,
                'end_time': date_specific.end_time,
                'is_date_specific': True
            }

        # Check for Ramadan period
        ramadan_period = RamadanPeriod.objects.filter(
            start_date__lte=date,
            end_date__gte=date,
            is_active=True
        ).first()

        # Use ramadan timing if available and we're in ramadan period
        if ramadan_period and hasattr(shift, 'ramadan_start_time') and hasattr(shift, 'ramadan_end_time'):
            if shift.ramadan_start_time and shift.ramadan_end_time:
                return {
                    'start_time': shift.ramadan_start_time,
                    'end_time': shift.ramadan_end_time,
                    'is_ramadan': True
                }

        # Return default timing
        return {
            'start_time': shift.start_time,
            'end_time': shift.end_time,
            'is_default': True
        }

    @staticmethod
    @transaction.atomic
    def set_date_specific_shift(
        shift: Shift,
        date: date,
        start_time: time,
        end_time: time,
        created_by: User
    ) -> DateSpecificShift:
        """
        Set date-specific timing for a shift
        
        Args:
            shift: The shift to set timing for
            date: The specific date
            start_time: New start time
            end_time: New end time
            created_by: User creating the override
            
        Returns:
            Created DateSpecificShift instance
        """
        date_specific, created = DateSpecificShift.objects.update_or_create(
            shift=shift,
            date=date,
            defaults={
                'start_time': start_time,
                'end_time': end_time,
                'created_by': created_by
            }
        )
        return date_specific

    @staticmethod
    def filter_assignments(
        department_id: Optional[int] = None,
        shift_id: Optional[int] = None,
        is_active: Optional[bool] = None,
        search_query: Optional[str] = None,
        assignment_type: Optional[str] = None
    ):
        """
        Filter shift assignments based on various criteria
        
        Args:
            department_id: Filter by department
            shift_id: Filter by shift
            is_active: Filter by active status
            search_query: Search employee name or number
            assignment_type: Filter by permanent/temporary
            
        Returns:
            Filtered queryset of ShiftAssignment objects
        """
        queryset = ShiftAssignment.objects.all()
        
        if department_id:
            queryset = queryset.filter(employee__department_id=department_id)
            
        if shift_id:
            queryset = queryset.filter(shift_id=shift_id)
            
        if is_active is not None:
            queryset = queryset.filter(is_active=is_active)
            
        if search_query:
            queryset = queryset.filter(
                Q(employee__first_name__icontains=search_query) |
                Q(employee__last_name__icontains=search_query) |
                Q(employee__employee_number__icontains=search_query)
            )
            
        if assignment_type:
            if assignment_type == 'permanent':
                queryset = queryset.filter(end_date__isnull=True)
            elif assignment_type == 'temporary':
                queryset = queryset.filter(end_date__isnull=False)
                
        return queryset.select_related(
            'employee',
            'employee__department',
            'shift',
            'created_by'
        ).order_by('-created_at')

    @staticmethod
    def get_department_shifts(department_id: int, date: Optional[date] = None) -> Dict[str, List[Dict]]:
        """
        Get all shift assignments for a department grouped by shift
        
        Args:
            department_id: The department to get shifts for
            date: Optional date to check assignments for
            
        Returns:
            Dict with shift names as keys and lists of employees as values
        """
        if not date:
            date = timezone.now().date()
            
        assignments = ShiftAssignment.objects.filter(
            employee__department_id=department_id,
            start_date__lte=date,
            is_active=True
        ).filter(
            Q(end_date__isnull=True) | Q(end_date__gte=date)
        ).select_related('employee', 'shift')
        
        shifts = {}
        for assignment in assignments:
            shift_name = assignment.shift.name
            if shift_name not in shifts:
                shifts[shift_name] = []
                
            shifts[shift_name].append({
                'employee_number': assignment.employee.employee_number,
                'employee_name': assignment.employee.get_full_name(),
                'assignment_id': assignment.id,
                'start_date': assignment.start_date,
                'end_date': assignment.end_date
            })
            
        return shifts

    @staticmethod
    @transaction.atomic
    def bulk_assign_shift(
        employee_ids: List[int],
        shift: Shift,
        start_date: date,
        end_date: Optional[date],
        created_by: User,
        is_active: bool = True
    ) -> int:
        """
        Assign a shift to multiple employees at once
        
        Args:
            employee_ids: List of employee IDs to assign the shift to
            shift: The shift to assign
            start_date: When the assignment starts
            end_date: Optional end date for temporary assignments
            created_by: User creating the assignments
            is_active: Whether the assignments should be active
            
        Returns:
            Number of assignments created
        """
        if is_active:
            # Deactivate existing active assignments for these employees
            ShiftAssignment.objects.filter(
                employee_id__in=employee_ids,
                is_active=True
            ).update(is_active=False)
            
        # Create new assignments
        assignments = [
            ShiftAssignment(
                employee_id=emp_id,
                shift=shift,
                start_date=start_date,
                end_date=end_date,
                created_by=created_by,
                is_active=is_active
            )
            for emp_id in employee_ids
        ]
        
        created = ShiftAssignment.objects.bulk_create(assignments)
        return len(created)

```

### 📄 hrms_project\attendance\services.py
```from django.utils import timezone
from django.db.models import Q, F
from datetime import datetime, timedelta, time
from typing import Optional, List, Dict, Any

from .models import (
    Employee, AttendanceLog, AttendanceRecord,
    Leave, LeaveType, LeaveBalance, Holiday,
    ShiftAssignment, RamadanPeriod
)

class AttendanceStatusService:
    """Service class for determining attendance status"""

    @staticmethod
    def is_ramadan(date: datetime.date, employee: Employee) -> bool:
        """Check if the given date falls within Ramadan period for Muslim employees"""
        if employee.religion != "Muslim":
            return False

        return RamadanPeriod.objects.filter(
            year=date.year,
            start_date__lte=date,
            end_date__gte=date,
            is_active=True
        ).exists()

    @staticmethod
    def get_employee_shift(employee: Employee, date: datetime.date) -> Optional[ShiftAssignment]:
        """Get the active shift assignment for an employee on a given date"""
        return ShiftAssignment.objects.filter(
            employee=employee,
            start_date__lte=date,
            is_active=True
        ).filter(
            Q(end_date__isnull=True) | Q(end_date__gte=date)
        ).first()

    
    @staticmethod
    def calculate_status(attendance_log: AttendanceLog) -> dict:
        """
        Calculate attendance status, late minutes, early departure etc.
        Returns dict with status details
        """
        # Get the shift assignment
        shift_assignment = AttendanceStatusService.get_employee_shift(
            attendance_log.employee, attendance_log.date
        )

        # If no shift assigned, use default shift
        if not shift_assignment:
            shift = attendance_log.shift  # Fallback to the one set in attendance_log
            if not shift:
                return {
                    'status': 'absent',
                    'is_late': False,
                    'late_minutes': 0,
                    'early_departure': False,
                    'early_minutes': 0,
                    'total_work_minutes': 0
                }
        else:
            shift = shift_assignment.shift
            attendance_log.shift = shift  # Update the log with the correct shift

        
        # Check if it's Ramadan for Muslim employees
        is_ramadan_day = AttendanceStatusService.is_ramadan(attendance_log.date, attendance_log.employee)

        # Get shift times
        shift_start = shift.start_time
        shift_end = shift.end_time if not is_ramadan_day else (
            datetime.combine(attendance_log.date, shift_start) + timedelta(hours=6)
        ).time()
        
        # Initialize result
        result = {
            'status': 'absent',
            'is_late': False,
            'late_minutes': 0,
            'early_departure': False,
            'early_minutes': 0,
            'total_work_minutes': 0
        }
        
        # If no check-in/out, mark as absent
        if not attendance_log.first_in_time or not attendance_log.last_out_time:
            return result

        # Apply grace period for lateness
        actual_start = (
            datetime.combine(attendance_log.date, shift_start) + 
            timedelta(minutes=shift.grace_period)
        ).time()

        # Calculate late minutes only if beyond grace period
        if attendance_log.first_in_time > actual_start:
            late_delta = datetime.combine(attendance_log.date, attendance_log.first_in_time) - \
                        datetime.combine(attendance_log.date, shift_start)
            result['is_late'] = True
            result['late_minutes'] = late_delta.seconds // 60
            
        # Calculate early departure
        if attendance_log.last_out_time < shift_end:
            early_delta = datetime.combine(attendance_log.date, shift_end) - \
                         datetime.combine(attendance_log.date, attendance_log.last_out_time)
            result['early_departure'] = True
            result['early_minutes'] = early_delta.seconds // 60
            
        # Calculate total work minutes
        work_delta = datetime.combine(attendance_log.date, attendance_log.last_out_time) - \
                    datetime.combine(attendance_log.date, attendance_log.first_in_time)

        total_minutes = work_delta.seconds // 60

        # Handle break deduction
        if is_ramadan_day:
            # No break deduction during Ramadan
            result['total_work_minutes'] = total_minutes
        else:
            # Always deduct break duration unless it's a custom shift with different break duration
            result['total_work_minutes'] = total_minutes - shift.break_duration
        
        # Determine status
        if result['is_late']:
            result['status'] = 'late'
        else:
            result['status'] = 'present'
            
        return result
    
    @staticmethod
    def update_attendance_status(attendance_log: AttendanceLog):
        """Update attendance log with calculated status"""
        status_details = AttendanceStatusService.calculate_status(attendance_log)
        
        for key, value in status_details.items():
            setattr(attendance_log, key, value)
            
        attendance_log.save()


class FridayRuleService:
    """Service class for handling Friday attendance rules"""

    @staticmethod
    def get_friday_status(employee: Employee, friday_date: datetime.date) -> str:
        """
        Determine Friday attendance status based on Thursday and Saturday attendance.
        
        Rules:
        1. If employee works on both Thursday and Saturday -> Present
        2. If employee is absent on both Thursday and Saturday -> Absent
        3. If employee is present on either Thursday or Saturday -> Present
        """
        # Verify the date is a Friday
        if friday_date.weekday() != 4:  # 4 is Friday
            raise ValueError("Provided date is not a Friday")

        thursday_date = friday_date - timedelta(days=1)
        saturday_date = friday_date + timedelta(days=1)

        # Check Thursday attendance
        thursday_present = AttendanceLog.objects.filter(
            employee=employee,
            date=thursday_date,
            is_active=True,
            first_in_time__isnull=False
        ).exists()

        # Check Saturday attendance
        saturday_present = AttendanceLog.objects.filter(
            employee=employee,
            date=saturday_date,
            is_active=True,
            first_in_time__isnull=False
        ).exists()

        # Apply rules
        if thursday_present and saturday_present:
            return 'present'
        elif not thursday_present and not saturday_present:
            return 'absent'
        else:
            return 'present'

    @staticmethod
    def process_friday_attendance():
        """Process Friday attendance for all employees"""
        today = timezone.now().date()
        if today.weekday() != 4:  # Not Friday
            return

        employees = Employee.objects.filter(is_active=True)
        for employee in employees:
            status = FridayRuleService.get_friday_status(employee, today)
            AttendanceLog.objects.update_or_create(
                employee=employee,
                date=today,
                defaults={
                    'status': status,
                    'source': 'friday_rule'
                }
            )

class LeaveBalanceService:
    """Service class for managing leave balances"""

    @staticmethod
    def calculate_annual_leave_accrual(employee: Employee, period_start: datetime.date, period_end: datetime.date) -> float:
        """
        Calculate annual leave accrual based on worked days.
        Rate: 2.5 days for every 30 working days
        """
        # Count working days (including Fridays that count as worked)
        worked_days = AttendanceLog.objects.filter(
            Q(employee=employee) &
            Q(date__range=(period_start, period_end)) &
            Q(is_active=True) &
            (Q(status='present') | Q(source='friday_rule'))
        ).count()

        # Calculate accrual
        return (worked_days / 30) * 2.5

    @staticmethod
    def update_leave_balances():
        """Update leave balances for all employees"""
        today = timezone.now().date()
        first_of_month = today.replace(day=1)
        
        if today != first_of_month:  # Only run on first day of month
            return

        employees = Employee.objects.filter(is_active=True)
        leave_types = LeaveType.objects.filter(is_active=True)

        for employee in employees:
            for leave_type in leave_types:
                if leave_type.accrual_enabled and leave_type.accrual_period == 'WORKED':
                    # Calculate accrual for previous month
                    last_month_end = first_of_month - timedelta(days=1)
                    last_month_start = last_month_end.replace(day=1)
                    
                    try:
                        # Calculate accrual
                        accrual = LeaveBalanceService.calculate_annual_leave_accrual(
                            employee, last_month_start, last_month_end
                        )

                        # Update balance
                        balance, created = LeaveBalance.objects.get_or_create(
                            employee=employee,
                            leave_type=leave_type,
                            is_active=True,
                            defaults={'total_days': 0}
                        )
                        
                        # Update last accrual date
                        balance.last_accrual_date = last_month_end
                        balance.total_days += accrual
                        balance.save()
                    except Exception as e:
                        print(f"Error updating leave balance for {employee} - {leave_type}: {str(e)}")
                        continue

class LeaveRequestService:
    """Service class for handling leave requests"""

    @staticmethod
    def validate_leave_request(
        employee: Employee,
        leave_type: LeaveType,
        start_date: datetime.date,
        end_date: datetime.date,
        start_half: bool = False,
        end_half: bool = False
    ) -> Dict[str, Any]:
        """Validate a leave request"""
        if start_date > end_date:
            return {'valid': False, 'error': 'End date cannot be before start date'}

        # Calculate duration
        duration = (end_date - start_date).days + 1
        if start_half:
            duration -= 0.5
        if end_half:
            duration -= 0.5

        # Check balance
        try:
            balance = LeaveBalance.objects.get(
                employee=employee,
                leave_type=leave_type,
                is_active=True
            )
            if duration > balance.available_days:
                return {
                    'valid': False,
                    'error': f'Insufficient leave balance. Available: {balance.available_days} days'
                }
        except LeaveBalance.DoesNotExist:
            return {'valid': False, 'error': 'No leave balance found'}

        # Check for overlapping leaves
        overlapping = Leave.objects.filter(
            employee=employee,
            is_active=True,
            status__in=['pending', 'approved'],
            start_date__lte=end_date,
            end_date__gte=start_date
        ).exists()

        if overlapping:
            return {'valid': False, 'error': 'Leave dates overlap with existing leave'}

        return {
            'valid': True,
            'duration': duration,
            'balance_after': balance.available_days - duration
        }

    @staticmethod
    def create_leave_request(
        employee: Employee,
        leave_type: LeaveType,
        start_date: datetime.date,
        end_date: datetime.date,
        reason: str,
        start_half: bool = False,
        end_half: bool = False,
        documents: List = None
    ) -> Dict[str, Any]:
        """Create a new leave request"""
        validation = LeaveRequestService.validate_leave_request(
            employee, leave_type, start_date, end_date, start_half, end_half
        )

        if not validation['valid']:
            return {'success': False, 'error': validation['error']}

        leave = Leave.objects.create(
            employee=employee,
            leave_type=leave_type,
            start_date=start_date,
            end_date=end_date,
            start_half=start_half,
            end_half=end_half,
            duration=validation['duration'],
            reason=reason,
            status='pending'
        )

        if documents:
            for doc in documents:
                leave.documents.create(document=doc)

        return {'success': True, 'leave_request': leave}

class RecurringHolidayService:
    """Service class for managing recurring holidays"""

    @staticmethod
    def generate_next_year_holidays():
        """Generate next year's holidays from recurring holidays"""
        current_year = timezone.now().year
        next_year = current_year + 1
        
        recurring_holidays = Holiday.objects.filter(is_recurring=True)
        
        for holiday in recurring_holidays:
            # Create new holiday instance for next year
            new_date = holiday.date.replace(year=next_year)
            Holiday.objects.create(
                name=holiday.name,
                date=new_date,
                holiday_type=holiday.holiday_type,
                description=holiday.description,
                is_paid=holiday.is_paid,
                is_recurring=False  # New instance is not recurring
            )

class RamadanService:
    """Service class for handling Ramadan-specific logic"""

    @staticmethod
    def get_ramadan_shift_timing(shift, date):
        """
        Get Ramadan-adjusted shift timing if applicable
        Returns dict with start_time and end_time
        """
        if not shift:
            return {}

        # Check if date falls in Ramadan period
        ramadan_period = RamadanPeriod.objects.filter(
            year=date.year,
            start_date__lte=date,
            end_date__gte=date,
            is_active=True
        ).first()

        if not ramadan_period:
            return {}

        # Use Ramadan specific times if set, otherwise use default times
        start_time = shift.ramadan_start_time or shift.start_time
        end_time = shift.ramadan_end_time or shift.end_time

        return {
            'start_time': start_time,
            'end_time': end_time
        }

class HolidayService:
    @staticmethod
    def generate_next_year_holidays():
        """Generate next year's holidays from recurring holidays"""
        current_year = timezone.now().year
        next_year = current_year + 1
        
        recurring_holidays = Holiday.objects.filter(is_recurring=True)
        
        for holiday in recurring_holidays:
            # Create new holiday instance for next year
            new_date = holiday.date.replace(year=next_year)
            Holiday.objects.create(
                name=holiday.name,
                date=new_date,
                holiday_type=holiday.holiday_type,
                description=holiday.description,
                is_paid=holiday.is_paid,
                is_recurring=False  # New instance is not recurring
            )

```

### 📄 hrms_project\attendance\signals.py
```from django.db.models.signals import pre_save, post_save, pre_delete, post_delete
from django.dispatch import receiver
from django.utils import timezone
from django.db import transaction
from django.db.models import Q
from datetime import datetime, timedelta
from typing import List
import logging

# Configure logging
logger = logging.getLogger(__name__)

# Module-level flag to track if we've already logged the cache import message
_cache_import_logged = False

# Try to import cache, but don't fail if it's not configured
try:
    from django.core.cache import cache
    # Only log once
    if not _cache_import_logged:
        logger.info("Successfully imported cache in signals")
        _cache_import_logged = True
except ImportError:
    if not _cache_import_logged:
        logger.warning("Failed to import cache in signals, continuing without caching")
        _cache_import_logged = True
    cache = None

from .models import (
    Shift, ShiftAssignment, RamadanPeriod, AttendanceLog,
    AttendanceRecord, Leave, LeaveType, LeaveBalance, Holiday, Employee, LeaveActivity
)
from .services import (
    ShiftService, RamadanService, AttendanceStatusService
)
from .services.cache_invalidation_service import CacheInvalidationService

@receiver(pre_save, sender=ShiftAssignment)
def handle_shift_assignment_update(sender, instance, **kwargs):
    """Handle shift assignment changes"""
    if instance.pk:  # Existing assignment
        old_instance = ShiftAssignment.objects.get(pk=instance.pk)
        
        # If making active and wasn't active before
        if instance.is_active and not old_instance.is_active:
            # Deactivate other active assignments for this employee
            ShiftAssignment.objects.filter(
                employee=instance.employee,
                is_active=True
            ).exclude(pk=instance.pk).update(is_active=False)
            
        # Clear caches
        CacheInvalidationService.invalidate_shift_related_caches(
            employee_ids=[instance.employee_id],
            department_ids={instance.employee.department_id} if instance.employee.department_id else None
        )

@receiver(post_save, sender=ShiftAssignment)
def handle_shift_assignment_create(sender, instance, created, **kwargs):
    """Handle new shift assignments"""
    if created and instance.is_active:
        # Deactivate other active assignments for this employee
        with transaction.atomic():
            ShiftAssignment.objects.filter(
                employee=instance.employee,
                is_active=True
            ).exclude(pk=instance.pk).update(is_active=False)
    
    # Clear employee shift cache
    if cache:
        try:
            cache_key = f'employee_shift_{instance.employee_id}'
            cache.delete(cache_key)
            logger.debug(f"Successfully cleared cache for key: {cache_key}")
        except Exception as e:
            logger.error(f"Error clearing cache: {str(e)}")

@receiver(pre_delete, sender=ShiftAssignment)
def handle_shift_assignment_delete(sender, instance, **kwargs):
    """Handle shift assignment deletion"""
    # Clear caches
    CacheInvalidationService.invalidate_shift_related_caches(
        employee_ids=[instance.employee_id],
        department_ids={instance.employee.department_id} if instance.employee.department_id else None
    )

@receiver(pre_save, sender=RamadanPeriod)
def validate_ramadan_period(sender, instance, **kwargs):
    """Validate Ramadan period before saving"""
    if instance.pk:
        # Update case
        RamadanService.validate_period_dates(
            start_date=instance.start_date,
            end_date=instance.end_date,
            year=instance.year,
            exclude_id=instance.pk
        )
    else:
        # Create case
        RamadanService.validate_period_dates(
            start_date=instance.start_date,
            end_date=instance.end_date,
            year=instance.year
        )

@receiver(post_save, sender=RamadanPeriod)
def handle_ramadan_period_change(sender, instance, created, **kwargs):
    """Handle Ramadan period changes"""
    # Clear caches
    CacheInvalidationService.invalidate_ramadan_related_caches(
        start_date=instance.start_date,
        end_date=instance.end_date
    )
    
    if instance.is_active:
        # Deactivate other active periods in the same year
        RamadanPeriod.objects.filter(
            year=instance.year,
            is_active=True
        ).exclude(pk=instance.pk).update(is_active=False)

@receiver(pre_save, sender=Shift)
def validate_shift_timing(sender, instance, **kwargs):
    """Validate shift timing before saving"""
    if instance.start_time == instance.end_time:
        raise ValueError("Start time and end time cannot be the same")
        
    if instance.break_duration < 0 or instance.break_duration > 180:
        raise ValueError("Break duration must be between 0 and 180 minutes")
        
    if instance.grace_period < 0 or instance.grace_period > 60:
        raise ValueError("Grace period must be between 0 and 60 minutes")

@receiver(post_save, sender=Shift)
def handle_shift_changes(sender, instance, created, **kwargs):
    """Handle shift changes"""
    # Get affected employees
    affected_employees = list(ShiftAssignment.objects.filter(
        shift=instance,
        is_active=True
    ).values_list('employee_id', flat=True))

    # Get affected departments
    affected_departments = set(Employee.objects.filter(
        id__in=affected_employees
    ).values_list('department_id', flat=True))

    # Clear caches
    CacheInvalidationService.invalidate_shift_related_caches(
        employee_ids=affected_employees,
        shift_id=instance.id,
        department_ids=affected_departments
    )

    # If shift is deactivated, deactivate its assignments
    if not instance.is_active:
        ShiftAssignment.objects.filter(
            shift=instance,
            is_active=True
        ).update(is_active=False)

@receiver(pre_save, sender=AttendanceLog)
def calculate_attendance_status(sender, instance, **kwargs):
    """
    Calculate attendance status based on shift
    """
    # Skip calculation for holidays and leaves
    if instance.status in ['holiday', 'leave']:
        return

    # Get the employee's shift for this date
    shift = instance.shift
    if not shift:
        shift = ShiftAssignment.objects.filter(
            employee=instance.employee,
            start_date__lte=instance.date,
            is_active=True
        ).filter(
            Q(end_date__isnull=True) | Q(end_date__gte=instance.date)
        ).order_by('-start_date').first()

        if shift:
            shift = shift.shift
        else:
            # Use default shift if no assignment found
            shift = Shift.objects.filter(shift_type='DEFAULT', is_active=True).first()

        instance.shift = shift

    if not shift:
        instance.status = 'absent'
        return

    # If we have first_in_time, employee is present
    if instance.first_in_time:
        # Get shift timing considering Ramadan period
        ramadan_timing = RamadanService.get_ramadan_shift_timing(shift, instance.date)
        start_time = ramadan_timing.get('start_time', shift.start_time)
        
        # Convert times to datetime for comparison
        date = instance.date
        shift_start = datetime.combine(date, start_time)
        first_in = datetime.combine(date, instance.first_in_time)

        # Calculate late minutes
        grace_minutes = shift.grace_period if shift else 15
        grace_time = shift_start + timedelta(minutes=grace_minutes)
        
        if first_in > grace_time:
            instance.is_late = True
            instance.late_minutes = int((first_in - grace_time).total_seconds() / 60)
            instance.status = 'late'
        else:
            instance.is_late = False
            instance.late_minutes = 0
            instance.status = 'present'

        # Calculate total work minutes if we have last_out_time
        if instance.last_out_time:
            last_out = datetime.combine(date, instance.last_out_time)
            if last_out < first_in:  # Handle case where checkout is next day
                last_out += timedelta(days=1)
            total_minutes = int((last_out - first_in).total_seconds() / 60)
            instance.total_work_minutes = max(0, total_minutes)
    else:
        instance.status = 'absent'
        instance.total_work_minutes = 0

@receiver(post_save, sender=AttendanceRecord)
def process_attendance_record(sender, instance, created, **kwargs):
    """
    Process attendance record to create or update attendance log
    """
    if not created and not instance.is_active:
        return

    # Get or create attendance log for the day
    date = instance.timestamp.date()
    try:
        log = AttendanceLog.objects.get(
            employee=instance.employee,
            date=date,
            is_active=True
        )
    except AttendanceLog.DoesNotExist:
        log = AttendanceLog(
            employee=instance.employee,
            date=date,
            source='system'
        )

    # Get all active records for the day
    records = AttendanceRecord.objects.filter(
        employee=instance.employee,
        timestamp__date=date,
        is_active=True
    ).order_by('timestamp')

    if records.exists():
        # Update log times and shift
        log.first_in_time = records.first().timestamp.time()
        log.last_out_time = records.last().timestamp.time()
        # Get the shift assignment
        shift_assignment = ShiftService.get_employee_current_shift(instance.employee)
        if shift_assignment:
            log.shift = shift_assignment
        
        # Save initial changes
        log.save()
        
        # Calculate and update status
        AttendanceStatusService.update_attendance_status(log)

@receiver(post_delete, sender=AttendanceRecord)
def cleanup_attendance_record(sender, instance, **kwargs):
    """
    Clean up attendance log when record is deleted
    """
    date = instance.timestamp.date()
    
    try:
        log = AttendanceLog.objects.get(
            employee=instance.employee,
            date=date,
            is_active=True
        )
        
        # Get remaining records for the day
        records = AttendanceRecord.objects.filter(
            employee=instance.employee,
            timestamp__date=date,
            is_active=True
        ).order_by('timestamp')
        
        if not records.exists():
            # No more records, delete log
            log.delete()
        else:
            # Update log times
            log.first_in_time = records.first().timestamp.time()
            log.last_out_time = records.last().timestamp.time()
            log.save()
            
    except AttendanceLog.DoesNotExist:
        pass

@receiver(post_save, sender=Leave)
def process_leave_request(sender, instance, created, **kwargs):
    """
    Process leave request approval/rejection
    """
    if not instance.is_active:
        return

    # For newly created pending leaves, update pending_days in balance
    if created and instance.status == 'pending':
        try:
            balance = LeaveBalance.objects.get(
                employee=instance.employee,
                leave_type=instance.leave_type,
                is_active=True
            )
            balance.pending_days += instance.duration
            balance.save()
        except LeaveBalance.DoesNotExist:
            pass

    # Create activity for status changes if not a new leave
    if not created:
        # Get the previous state of the leave
        try:
            old_instance = Leave.objects.get(pk=instance.pk)
            # If status has changed, create an activity
            if old_instance.status != instance.status:
                action = instance.status
                actor = None
                
                # Try to determine the actor based on the status
                if instance.status == 'approved' and instance.approved_by:
                    actor = instance.approved_by
                elif instance.status == 'rejected' and hasattr(instance, 'rejected_by') and instance.rejected_by:
                    actor = instance.rejected_by
                
                # Create the activity
                LeaveActivity.objects.create(
                    leave=instance,
                    actor=actor,
                    action=action,
                    details=f"Leave request {action}"
                )
                
                # If status changed from pending to approved, update leave balance
                if old_instance.status != 'approved' and instance.status == 'approved':
                    # Update leave balance for newly approved leave
                    try:
                        balance = LeaveBalance.objects.get(
                            employee=instance.employee,
                            leave_type=instance.leave_type,
                            is_active=True
                        )
                        balance.used_days += instance.duration
                        balance.pending_days = max(0, balance.pending_days - instance.duration)  # Remove from pending if was pending
                        balance.save()
                    except LeaveBalance.DoesNotExist:
                        pass
                
                # If status changed from pending to rejected or cancelled, update pending_days
                elif old_instance.status == 'pending' and instance.status in ['rejected', 'cancelled']:
                    # Update pending days
                    try:
                        balance = LeaveBalance.objects.get(
                            employee=instance.employee,
                            leave_type=instance.leave_type,
                            is_active=True
                        )
                        balance.pending_days = max(0, balance.pending_days - instance.duration)  # Ensure we don't go negative
                        balance.save()
                    except LeaveBalance.DoesNotExist:
                        pass
                
                # If status changed from approved to rejected or cancelled, restore leave balance
                elif old_instance.status == 'approved' and instance.status in ['rejected', 'cancelled']:
                    # Restore leave balance
                    try:
                        balance = LeaveBalance.objects.get(
                            employee=instance.employee,
                            leave_type=instance.leave_type,
                            is_active=True
                        )
                        balance.used_days = max(0, balance.used_days - instance.duration)  # Ensure we don't go negative
                        balance.save()
                    except LeaveBalance.DoesNotExist:
                        pass
        except Leave.DoesNotExist:
            pass  # This shouldn't happen, but just in case

    # For newly created approved leaves or leaves that were just approved
    if created and instance.status == 'approved':
        # Create attendance logs for leave days
        current_date = instance.start_date
        while current_date <= instance.end_date:
            # Skip if log already exists
            if not AttendanceLog.objects.filter(
                employee=instance.employee,
                date=current_date,
                is_active=True
            ).exists():
                AttendanceLog.objects.create(
                    employee=instance.employee,
                    date=current_date,
                    status='leave',
                    source='leave',
                    leave=instance
                )
            current_date += timedelta(days=1)

        # Update leave balance for newly created approved leave
        try:
            balance = LeaveBalance.objects.get(
                employee=instance.employee,
                leave_type=instance.leave_type,
                is_active=True
            )
            balance.used_days += instance.duration
            balance.pending_days = max(0, balance.pending_days - instance.duration)  # Remove from pending if was pending
            balance.save()
        except LeaveBalance.DoesNotExist:
            pass

@receiver(post_delete, sender=Leave)
def cleanup_leave_request(sender, instance, **kwargs):
    """
    Clean up attendance logs when leave is deleted
    """
    # Delete attendance logs created for this leave
    AttendanceLog.objects.filter(
        employee=instance.employee,
        date__range=(instance.start_date, instance.end_date),
        source='leave',
        leave=instance,
        is_active=True
    ).delete()

    # Delete leave activities associated with this leave
    LeaveActivity.objects.filter(leave=instance).delete()

    # Restore leave balance if was approved
    if instance.status == 'approved':
        try:
            balance = LeaveBalance.objects.get(
                employee=instance.employee,
                leave_type=instance.leave_type,
                is_active=True
            )
            balance.used_days = max(0, balance.used_days - instance.duration)  # Ensure we don't go negative
            balance.save()
        except LeaveBalance.DoesNotExist:
            pass
    # Update pending_days if the leave was pending
    elif instance.status == 'pending':
        try:
            balance = LeaveBalance.objects.get(
                employee=instance.employee,
                leave_type=instance.leave_type,
                is_active=True
            )
            balance.pending_days = max(0, balance.pending_days - instance.duration)  # Ensure we don't go negative
            balance.save()
        except LeaveBalance.DoesNotExist:
            pass

@receiver(post_save, sender=Holiday)
def process_holiday(sender, instance, created, **kwargs):
    """
    Process holiday creation/update
    """
    if not instance.is_active:
        return

    # Get all active employees
    employees = Employee.objects.filter(is_active=True)

    for employee in employees:
        # Update or create attendance log
        AttendanceLog.objects.update_or_create(
            employee=employee,
            date=instance.date,
            defaults={
                'status': 'holiday',
                'source': 'holiday',
                'is_active': True
            }
        )

@receiver(post_delete, sender=Holiday)
def cleanup_holiday(sender, instance, **kwargs):
    """
    Clean up attendance logs when holiday is deleted
    """
    # Delete attendance logs created for this holiday
    AttendanceLog.objects.filter(
        date=instance.date,
        source='holiday',
        is_active=True
    ).delete()

@receiver(post_save, sender=LeaveType)
def create_leave_balances(sender, instance, created, **kwargs):
    """
    Create leave balances for new leave type
    """
    if created and instance.is_active:
        # Create leave balance for all active employees
        employees = Employee.objects.filter(is_active=True)
        balances = []
        
        for employee in employees:
            if not LeaveBalance.objects.filter(
                employee=employee,
                leave_type=instance,
                is_active=True
            ).exists():
                balances.append(LeaveBalance(
                    employee=employee,
                    leave_type=instance,
                    total_days=instance.days_allowed if not instance.accrual_enabled else 0,
                    used_days=0,
                    pending_days=0,
                    last_reset_date=timezone.now().date()
                ))
        
        if balances:
            LeaveBalance.objects.bulk_create(balances)

```

### 📄 hrms_project\attendance\static\attendance\js\attendance.js
```// Initialize calendar and event handlers
document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    initializeLeaveForm();
    initializeAttendanceMarking();
    setupDateRangePicker();
});

// Calendar Functions
function initializeCalendar() {
    const calendarEl = document.getElementById('attendance-calendar');
    if (!calendarEl) return;

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: '/attendance/api/calendar-events/',
        eventDidMount: function(info) {
            // Add tooltips to events
            const status = info.event.extendedProps.status;
            const timeIn = info.event.extendedProps.first_in || '';
            const timeOut = info.event.extendedProps.last_out || '';
            
            tippy(info.el, {
                content: `
                    <strong>Status:</strong> ${status}<br>
                    <strong>Time In:</strong> ${timeIn}<br>
                    <strong>Time Out:</strong> ${timeOut}
                `,
                allowHTML: true
            });
        },
        eventClick: function(info) {
            showAttendanceDetail(info.event);
        }
    });

    calendar.render();
}

function showAttendanceDetail(event) {
    // Fetch and display attendance details in modal
    fetch(`/attendance/api/logs/${event.id}/details/`)
        .then(response => response.json())
        .then(data => {
            const modal = new bootstrap.Modal(document.getElementById('attendance-detail-modal'));
            document.getElementById('attendance-detail-content').innerHTML = `
                <div class="attendance-detail">
                    <h5>Attendance Details</h5>
                    <div class="detail-row">
                        <strong>Date:</strong> ${data.date}
                    </div>
                    <div class="detail-row">
                        <strong>Status:</strong> ${data.status}
                    </div>
                    <div class="detail-row">
                        <strong>Time In:</strong> ${data.first_in || '-'}
                    </div>
                    <div class="detail-row">
                        <strong>Time Out:</strong> ${data.last_out || '-'}
                    </div>
                    <div class="detail-row">
                        <strong>Source:</strong> ${data.source}
                    </div>
                </div>
            `;
            modal.show();
        })
        .catch(error => console.error('Error:', error));
}

// Leave Request Functions
function initializeLeaveForm() {
    const leaveForm = document.getElementById('leave-request-form');
    if (!leaveForm) return;

    const leaveTypeSelect = document.getElementById('leave_type');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');

    // Update leave balance display when type changes
    leaveTypeSelect?.addEventListener('change', function() {
        updateLeaveBalance(this.value);
    });

    // Calculate duration when dates change
    [startDateInput, endDateInput].forEach(input => {
        input?.addEventListener('change', function() {
            if (startDateInput.value && endDateInput.value) {
                calculateLeaveDuration(startDateInput.value, endDateInput.value);
            }
        });
    });

    // Handle form submission
    leaveForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitLeaveRequest(new FormData(this));
    });
}

function updateLeaveBalance(leaveTypeId) {
    if (!leaveTypeId) return;

    fetch(`/attendance/api/leave-balance/${leaveTypeId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('leave-balance-display').innerHTML = `
                Available: ${data.available_days} days<br>
                Consumed: ${data.consumed_days} days
            `;
        })
        .catch(error => console.error('Error:', error));
}

function calculateLeaveDuration(startDate, endDate) {
    fetch('/attendance/api/calculate-leave-duration/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ start_date: startDate, end_date: endDate })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('duration-display').textContent = 
            `Duration: ${data.duration} days`;
    })
    .catch(error => console.error('Error:', error));
}

function submitLeaveRequest(formData) {
    fetch('/attendance/api/leave-requests/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Leave request submitted successfully');
            setTimeout(() => window.location.href = '/attendance/leaves/', 2000);
        } else {
            showAlert('danger', data.error || 'Error submitting leave request');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error submitting leave request');
        console.error('Error:', error);
    });
}

// Attendance Marking Functions
function initializeAttendanceMarking() {
    const markAttendanceForm = document.getElementById('mark-attendance-form');
    if (!markAttendanceForm) return;

    markAttendanceForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitAttendance(new FormData(this));
    });

    // Initialize employee search typeahead
    const employeeInput = document.getElementById('employee_search');
    if (employeeInput) {
        new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                url: '/attendance/api/search-employees/?q=%QUERY',
                wildcard: '%QUERY'
            }
        });

        $(employeeInput).typeahead(null, {
            name: 'employees',
            display: 'full_name',
            source: employeeEngine
        });
    }
}

function submitAttendance(formData) {
    fetch('/attendance/api/mark-attendance/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Attendance marked successfully');
            document.getElementById('mark-attendance-form').reset();
        } else {
            showAlert('danger', data.error || 'Error marking attendance');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error marking attendance');
        console.error('Error:', error);
    });
}

// Utility Functions
function setupDateRangePicker() {
    const dateRangePicker = document.getElementById('date-range');
    if (!dateRangePicker) return;

    $(dateRangePicker).daterangepicker({
        autoUpdateInput: false,
        locale: {
            cancelLabel: 'Clear'
        }
    });

    $(dateRangePicker).on('apply.daterangepicker', function(ev, picker) {
        $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
        updateDateRange(picker.startDate, picker.endDate);
    });

    $(dateRangePicker).on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
    });
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const alertContainer = document.getElementById('alert-container');
    if (alertContainer) {
        alertContainer.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Handle Back Button
window.addEventListener('popstate', function(e) {
    if (e.state && e.state.modal) {
        // Close any open modals when using browser back button
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) modalInstance.hide();
        });
    }
});

```

### 📄 hrms_project\attendance\static\attendance\js\attendance_report.js
```import {
    getReportParameters,
    handleExportFormat,
    handleDateRangeChange,
    setDateRangeFromPreset,
    formatDate,
    showLoadingState,
    hideLoadingState,
    showError
} from './report_utils.js';

// Constants
const CHART_COLORS = {
    present: 'rgb(40, 167, 69)',
    absent: 'rgb(220, 53, 69)',
    late: 'rgb(255, 193, 7)',
    leave: 'rgb(23, 162, 184)'
};

// State management
let attendanceTrendChart = null;
let departmentChart = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize event listeners
    document.getElementById('generateReport')?.addEventListener('click', generateReport);
    document.getElementById('dateRange')?.addEventListener('change', handleDateRangeChange);
    document.getElementById('exportFormat')?.addEventListener('change', (e) => handleExportFormat(e, { defaultReportType: 'attendance' }));
    document.getElementById('reportType')?.addEventListener('change', handleReportTypeChange);
    
    // Initialize date inputs with default values
    setDefaultDates();
});

function setDefaultDates() {
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    if (startDateInput) startDateInput.value = formatDate(firstDayOfMonth);
    if (endDateInput) endDateInput.value = formatDate(today);
}

async function generateReport() {
    const params = getReportParameters();
    showLoadingState();
    
    try {
        const reportType = document.getElementById('reportType')?.value || 'attendance';
        const searchParams = new URLSearchParams();
        
        // Add basic parameters
        searchParams.append('start_date', params.start_date);
        searchParams.append('end_date', params.end_date);
        
        // Add array parameters correctly
        if (params.departments) {
            params.departments.forEach(dept => searchParams.append('departments[]', dept));
        }
        if (params.employees) {
            params.employees.forEach(emp => searchParams.append('employees[]', emp));
        }
        if (params.status) {
            params.status.forEach(status => searchParams.append('status[]', status));
        }
        
        const response = await fetch(`/attendance/api/reports/${reportType}/?${searchParams.toString()}`);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to fetch report data');
        }
        
        const data = await response.json();
        updateReportUI(data, reportType);
    } catch (error) {
        console.error('Error generating report:', error);
        showError(error.message || 'Failed to generate report. Please try again.');
    } finally {
        hideLoadingState();
    }
}

function updateReportUI(data, reportType) {
    // Update summary cards with default values in case data is missing
    const summary = data.summary || { present: 0, absent: 0, late: 0, leave: 0 };
    
    const presentCount = document.getElementById('presentCount');
    const absentCount = document.getElementById('absentCount');
    const lateCount = document.getElementById('lateCount');
    const leaveCount = document.getElementById('leaveCount');
    
    if (presentCount) presentCount.textContent = summary.present || '0';
    if (absentCount) absentCount.textContent = summary.absent || '0';
    if (lateCount) lateCount.textContent = summary.late || '0';
    if (leaveCount) leaveCount.textContent = summary.leave || '0';
    
    // Display holidays if they exist
    const holidayInfo = document.getElementById('holidayInfo');
    if (holidayInfo && data.holidays && data.holidays.length > 0) {
        holidayInfo.innerHTML = `
            <div class="alert alert-info">
                <h5>Holidays in Selected Period:</h5>
                <ul class="list-unstyled mb-0">
                    ${data.holidays.map(holiday => 
                        `<li><strong>${formatDate(new Date(holiday.date))}:</strong> ${holiday.name}</li>`
                    ).join('')}
                </ul>
            </div>
        `;
        holidayInfo.style.display = 'block';
    } else if (holidayInfo) {
        holidayInfo.style.display = 'none';
    }
    
    // Update charts if data is available
    if (data.trend_data) {
        updateAttendanceTrendChart(data.trend_data);
    }
    if (data.department_stats) {
        updateDepartmentChart(data.department_stats);
    }
    
    // Update report table
    if (data.employee_records) {
        updateReportTable(data.employee_records);
    }
}

function updateReportTable(records) {
    const tbody = document.querySelector('#reportTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    records.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.id || ''}</td>
            <td>${record.name || ''}</td>
            <td>${record.department || ''}</td>
            <td>${record.present_days || 0}</td>
            <td>${record.absent_days || 0}</td>
            <td>${record.late_days || 0}</td>
            <td>${record.leave_days || 0}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewEmployeeDetails(${record.id})">
                    View Details
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateAttendanceTrendChart(trendData) {
    const ctx = document.getElementById('attendanceTrendChart')?.getContext('2d');
    if (!ctx) return;
    
    if (attendanceTrendChart) {
        attendanceTrendChart.destroy();
    }
    
    const labels = trendData.map(data => {
        const label = formatDate(new Date(data.date));
        return data.is_holiday ? `${label} (Holiday)` : label;
    });
    
    const datasets = [
        {
            label: 'Present',
            data: trendData.map(data => data.present),
            backgroundColor: CHART_COLORS.present,
            borderColor: CHART_COLORS.present,
            tension: 0.1
        },
        {
            label: 'Absent',
            data: trendData.map(data => data.absent),
            backgroundColor: CHART_COLORS.absent,
            borderColor: CHART_COLORS.absent,
            tension: 0.1
        },
        {
            label: 'Late',
            data: trendData.map(data => data.late),
            backgroundColor: CHART_COLORS.late,
            borderColor: CHART_COLORS.late,
            tension: 0.1
        },
        {
            label: 'Leave',
            data: trendData.map(data => data.leave),
            backgroundColor: CHART_COLORS.leave,
            borderColor: CHART_COLORS.leave,
            tension: 0.1
        }
    ];
    
    attendanceTrendChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    ticks: {
                        callback: function(value, index) {
                            const isHoliday = trendData[index]?.is_holiday;
                            const label = this.getLabelForValue(value);
                            return isHoliday ? `${label} *` : label;
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Attendance Trend'
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const index = context[0].dataIndex;
                            const data = trendData[index];
                            let title = formatDate(new Date(data.date));
                            if (data.is_holiday) {
                                title += ` (Holiday - ${data.holiday_name})`;
                            }
                            return title;
                        }
                    }
                }
            }
        }
    });
}

function updateDepartmentChart(departmentStats) {
    const ctx = document.getElementById('departmentChart')?.getContext('2d');
    if (!ctx) return;
    
    if (departmentChart) {
        departmentChart.destroy();
    }
    
    const labels = departmentStats.map(stat => stat.department);
    const datasets = [
        {
            label: 'Present',
            data: departmentStats.map(stat => stat.present),
            backgroundColor: CHART_COLORS.present
        },
        {
            label: 'Absent',
            data: departmentStats.map(stat => stat.absent),
            backgroundColor: CHART_COLORS.absent
        },
        {
            label: 'Late',
            data: departmentStats.map(stat => stat.late),
            backgroundColor: CHART_COLORS.late
        },
        {
            label: 'Leave',
            data: departmentStats.map(stat => stat.leave),
            backgroundColor: CHART_COLORS.leave
        }
    ];
    
    departmentChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
            responsive: true,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Department-wise Attendance'
                }
            }
        }
    });
}

function viewEmployeeDetails(employeeId) {
    if (employeeId) {
        window.location.href = `/attendance/attendance_detail/?employee_id=${employeeId}`;
    }
}

```

### 📄 hrms_project\attendance\static\attendance\js\leave-status-modal.js
```// Leave Status Modal Handler
class LeaveStatusModal {
    constructor() {
        console.log('LeaveStatusModal constructor starting...');
        
        // Check for required dependencies
        console.log('Checking dependencies:', {
            bootstrap: typeof bootstrap !== 'undefined',
            jQuery: typeof $ !== 'undefined'
        });
        
        this.modalElement = document.getElementById('statusChangeModal');
        console.log('Modal element found:', !!this.modalElement);
        
        this.statusSelect = document.getElementById('newStatus');
        this.remarksInput = document.getElementById('statusRemarks');
        this.confirmBtn = document.getElementById('confirmStatusChange');
        
        console.log('Required elements found:', {
            statusSelect: !!this.statusSelect,
            remarksInput: !!this.remarksInput,
            confirmBtn: !!this.confirmBtn
        });
        
        this.modal = null;
        
        if (this.modalElement && typeof bootstrap !== 'undefined') {
            console.log('Initializing Bootstrap modal...');
            try {
                this.modal = new bootstrap.Modal(this.modalElement);
                console.log('Bootstrap modal created successfully');
                this.initialize();
            } catch (error) {
                console.error('Failed to create Bootstrap modal:', error);
            }
        } else {
            console.error('Cannot initialize modal:', {
                modalElement: !!this.modalElement,
                bootstrap: typeof bootstrap !== 'undefined'
            });
        }
    }

    initialize() {
        console.log('Starting modal initialization...');
        if (!this.statusSelect || !this.remarksInput || !this.confirmBtn) {
            console.error('Missing required elements:', {
                statusSelect: !!this.statusSelect,
                remarksInput: !!this.remarksInput,
                confirmBtn: !!this.confirmBtn
            });
            return;
        }

        this.bindEvents();
        console.log('Modal initialization complete');
    }

    bindEvents() {
        console.log('Binding modal events...');
        const buttons = document.querySelectorAll('.change-status-btn');
        console.log(`Found ${buttons.length} status change buttons`);

        buttons.forEach((button, index) => {
            console.log(`Setting up button ${index}:`, {
                status: button.dataset.status,
                id: button.dataset.id
            });
            
            button.addEventListener('click', (e) => {
                console.log(`Button ${index} clicked`);
                e.preventDefault();
                this.handleButtonClick(e);
            });
        });

        this.confirmBtn.addEventListener('click', () => {
            console.log('Confirm button clicked');
            this.handleStatusChange();
        });
        
        console.log('Event binding complete');
    }

    handleButtonClick(e) {
        const button = e.target.closest('.change-status-btn');
        if (!button) {
            console.error('Could not find button element');
            return;
        }

        const currentStatus = button.dataset.status;
        const leaveId = button.dataset.id;
        console.log('Button clicked:', { currentStatus, leaveId });

        if (!currentStatus || !leaveId) {
            console.error('Missing required data attributes');
            return;
        }

        this.currentLeaveId = leaveId;
        this.show(currentStatus, leaveId);
    }

    show(currentStatus, leaveId) {
        console.log('Showing modal for status:', currentStatus, 'leaveId:', leaveId);
        
        if (!this.modal) {
            console.error('Modal not initialized');
            return;
        }

        // Update status options
        const statusToAction = {
            'pending': '',
            'approved': 'approve',
            'rejected': 'reject',
            'cancelled': 'cancel'
        };

        Array.from(this.statusSelect.options).forEach(option => {
            option.style.display = option.value === statusToAction[currentStatus] ? 'none' : '';
        });

        // Clear previous remarks
        this.remarksInput.value = '';

        // Show modal
        this.modal.show();
    }

    async handleStatusChange() {
        const newStatus = this.statusSelect.value;
        const remarks = this.remarksInput.value;

        console.log('Handling status change:', {
            leaveId: this.currentLeaveId,
            status: newStatus,
            remarks: remarks
        });

        try {
            const response = await fetch(`/attendance/api/leaves/${this.currentLeaveId}/${newStatus}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCookie('csrftoken')
                },
                body: JSON.stringify({ remarks })
            });

            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);

            if (data.error) {
                throw new Error(data.error);
            }

            // Hide modal and reload page on success
            this.modal.hide();
            window.location.reload();

        } catch (error) {
            console.error('API Error:', error);
            alert('Error updating leave status: ' + error.message);
        }
    }

    getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    console.log('Modal handler script loaded, waiting for dependencies...');
    
    function checkDependencies() {
        console.log('Checking dependencies:', {
            bootstrap: typeof bootstrap !== 'undefined',
            jQuery: typeof $ !== 'undefined'
        });
        
        if (typeof bootstrap === 'undefined') {
            console.log('Bootstrap not yet loaded, retrying...');
            setTimeout(checkDependencies, 100);
            return;
        }
        
        console.log('Dependencies loaded, creating modal handler');
        window.leaveStatusModal = new LeaveStatusModal();
    }
    
    checkDependencies();
}); 
```

### 📄 hrms_project\attendance\static\attendance\js\ramadan.js
```class RamadanPeriodManager {
    constructor() {
        this.addModal = new bootstrap.Modal(document.getElementById('addPeriodModal'));
        this.editModal = new bootstrap.Modal(document.getElementById('editPeriodModal'));
        this.initializeEventListeners();
    }

    getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async savePeriod() {
        const form = document.getElementById('addPeriodForm');
        const formData = new FormData(form);
        const data = {
            year: parseInt(formData.get('year')),
            start_date: formData.get('start_date'),
            end_date: formData.get('end_date'),
            is_active: formData.get('is_active') === 'on'
        };

        try {
            const response = await fetch('/attendance/ramadan_period/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (response.ok) {
                this.addModal.hide();
                location.reload();
            } else {
                throw new Error(result.error || 'Error adding Ramadan period');
            }
        } catch (error) {
            alert(error.message);
        }
    }

    async editPeriod(id) {
        try {
            const response = await fetch(`/attendance/ramadan_period/${id}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': this.getCookie('csrftoken')
                }
            });

            const period = await response.json();
            if (response.ok) {
                const form = document.getElementById('editPeriodForm');
                form.querySelector('[name="id"]').value = period.id;
                form.querySelector('[name="year"]').value = period.year;
                form.querySelector('[name="start_date"]').value = period.start_date;
                form.querySelector('[name="end_date"]').value = period.end_date;
                form.querySelector('[name="is_active"]').checked = period.is_active;
                this.editModal.show();
            } else {
                throw new Error(period.error || 'Error fetching Ramadan period');
            }
        } catch (error) {
            alert(error.message);
        }
    }

    async updatePeriod() {
        const form = document.getElementById('editPeriodForm');
        const formData = new FormData(form);
        const id = formData.get('id');
        const data = {
            year: parseInt(formData.get('year')),
            start_date: formData.get('start_date'),
            end_date: formData.get('end_date'),
            is_active: formData.get('is_active') === 'on'
        };

        try {
            const response = await fetch(`/attendance/ramadan_period/${id}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                this.editModal.hide();
                location.reload();
            } else {
                const result = await response.json();
                throw new Error(result.error || 'Error updating Ramadan period');
            }
        } catch (error) {
            alert(error.message);
        }
    }

    async deletePeriod(id) {
        if (!confirm('Are you sure you want to delete this Ramadan period?')) {
            return;
        }

        try {
            const response = await fetch(`/attendance/ramadan_period/${id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': this.getCookie('csrftoken')
                }
            });

            if (response.ok) {
                location.reload();
            } else {
                const result = await response.json();
                throw new Error(result.error || 'Error deleting Ramadan period');
            }
        } catch (error) {
            alert(error.message);
        }
    }

    validatePeriod(form) {
        const year = parseInt(form.querySelector('[name="year"]').value);
        const startDate = new Date(form.querySelector('[name="start_date"]').value);
        const endDate = new Date(form.querySelector('[name="end_date"]').value);

        if (startDate > endDate) {
            alert('End date cannot be before start date');
            return false;
        }

        if (startDate.getFullYear() !== year || endDate.getFullYear() !== year) {
            alert('Start and end dates must be within the specified year');
            return false;
        }

        return true;
    }

    initializeEventListeners() {
        // Add form submit event
        const addForm = document.getElementById('addPeriodForm');
        const addSaveBtn = document.querySelector('#addPeriodModal .btn-primary');
        addSaveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (this.validatePeriod(addForm)) {
                this.savePeriod();
            }
        });

        // Edit form submit event
        const editForm = document.getElementById('editPeriodForm');
        const editSaveBtn = document.querySelector('#editPeriodModal .btn-primary');
        editSaveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (this.validatePeriod(editForm)) {
                this.updatePeriod();
            }
        });

        // Year field change handlers
        [addForm, editForm].forEach(form => {
            const yearInput = form.querySelector('[name="year"]');
            const startDateInput = form.querySelector('[name="start_date"]');
            const endDateInput = form.querySelector('[name="end_date"]');

            yearInput.addEventListener('change', () => {
                const year = yearInput.value;
                startDateInput.min = `${year}-01-01`;
                startDateInput.max = `${year}-12-31`;
                endDateInput.min = `${year}-01-01`;
                endDateInput.max = `${year}-12-31`;
            });
        });
    }
}

```

### 📄 hrms_project\attendance\static\attendance\js\report_utils.js
```/**
 * Common utilities for report handling
 */

// Report parameter handling
export function getReportParameters() {
    const params = {
        start_date: document.getElementById('startDate')?.value,
        end_date: document.getElementById('endDate')?.value
    };

    // Get department value
    const departmentSelect = document.getElementById('department');
    if (departmentSelect?.value) {
        params.departments = [departmentSelect.value];
    }

    // Get status values - handle multiple selection
    const statusSelect = document.getElementById('status');
    if (statusSelect?.selectedOptions) {
        const selectedStatus = Array.from(statusSelect.selectedOptions).map(opt => opt.value);
        if (selectedStatus.length > 0) {
            params.status = selectedStatus;
        }
    }

    const dateRange = document.getElementById('dateRange')?.value;
    if (dateRange && dateRange !== 'custom') {
        const dates = calculateDatesFromRange(dateRange);
        params.start_date = dates.startDate;
        params.end_date = dates.endDate;
    }
    
    return params;
}

// Export format handling
export async function handleExportFormat(event, options = {}) {
    const format = event.target.value;
    if (format === 'html') return;
    
    const reportType = document.getElementById('reportType')?.value || options.defaultReportType || 'attendance';
    const params = getReportParameters();
    const searchParams = new URLSearchParams();
    
    // Add all parameters
    Object.entries(params).forEach(([key, value]) => {
        if (Array.isArray(value)) {
            value.forEach(v => searchParams.append(`${key}[]`, v));
        } else {
            searchParams.append(key, value);
        }
    });
    
    // Add export format and type
    searchParams.append('format', format);
    searchParams.append('type', reportType);
    
    try {
        showLoadingState();
        if (format === 'pdf') {
            const response = await fetch(`/attendance/api/reports/export/?${searchParams.toString()}`);
            if (!response.ok) throw new Error('Failed to generate PDF');
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${reportType}_report.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        } else {
            window.location.href = `/attendance/api/reports/export/?${searchParams.toString()}`;
        }
    } catch (error) {
        console.error('Error exporting report:', error);
        showError('Failed to export report. Please try again.');
    } finally {
        hideLoadingState();
        event.target.value = 'html';
    }
}

// Date handling utilities
export function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

export function calculateDatesFromRange(range) {
    const today = new Date();
    let startDate = new Date();
    
    switch (range) {
        case 'today':
            startDate = today;
            break;
        case 'week':
            startDate = new Date(today.setDate(today.getDate() - 7));
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
    }
    
    return {
        startDate: formatDate(startDate),
        endDate: formatDate(new Date())
    };
}

// UI state handling
export function showLoadingState() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.add('active');
}

export function hideLoadingState() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.classList.remove('active');
}

export function showError(message) {
    const errorToast = document.getElementById('errorToast');
    const errorMessage = document.getElementById('errorMessage');
    if (errorToast && errorMessage) {
        errorMessage.textContent = message;
        const toast = new bootstrap.Toast(errorToast);
        toast.show();
    } else {
        alert(message); // Fallback if toast elements don't exist
    }
}

// Date range handling
export function handleDateRangeChange(event) {
    const customDateRange = document.getElementById('customDateRange');
    if (customDateRange) {
        customDateRange.style.display = event.target.value === 'custom' ? 'block' : 'none';
    }
    
    if (event.target.value !== 'custom') {
        setDateRangeFromPreset(event.target.value);
    }
}

export function setDateRangeFromPreset(preset) {
    const today = new Date();
    let startDate = new Date();
    
    switch (preset) {
        case 'today':
            startDate = today;
            break;
        case 'week':
            startDate = new Date(today.setDate(today.getDate() - 7));
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
    }
    
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    if (startDateInput) startDateInput.value = formatDate(startDate);
    if (endDateInput) endDateInput.value = formatDate(new Date());
}
```

### 📄 hrms_project\attendance\static\attendance\js\shifts.js
```import {
    getReportParameters,
    handleExportFormat,
    formatDate,
    showLoadingState,
    hideLoadingState,
    showError
} from './report_utils.js';

// Global variables
let selectedEmployeeId = null;
let calendar = null;

// Function to check for overlapping shifts
async function checkOverlappingShifts() {
    const employeeSelect = document.getElementById('employee');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');

    if (!employeeSelect || !startDateInput) return;

    const employeeId = employeeSelect.value;
    const startDate = startDateInput.value;
    const endDate = endDateInput?.value || startDate;
    const currentAssignmentId = new URLSearchParams(window.location.search).get('id');

    if (!employeeId || !startDate) return;

    try {
        const response = await fetch(`/api/attendance/check-shift-overlap/?employee=${employeeId}&start_date=${startDate}&end_date=${endDate}${currentAssignmentId ? `&exclude=${currentAssignmentId}` : ''}`);
        const data = await response.json();
        
        const form = document.getElementById('shift-assignment-form');
        if (!form) return;

        let warningElement = document.getElementById('overlap-warning');
        if (data.overlapping) {
            if (!warningElement) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'overlap-warning';
                warningDiv.className = 'alert alert-warning mt-3';
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    Warning: This assignment overlaps with existing shift assignments:
                    <ul>
                        ${data.overlapping.map(overlap => `
                            <li>${overlap.shift_name}: ${overlap.start_date} to ${overlap.end_date || 'Permanent'}</li>
                        `).join('')}
                    </ul>
                `;
                const lastFormGroup = form.querySelector('.mb-3:last-child');
                if (lastFormGroup) {
                    form.insertBefore(warningDiv, lastFormGroup);
                } else {
                    form.appendChild(warningDiv);
                }
            }
        } else if (warningElement) {
            warningElement.remove();
        }
    } catch (error) {
        console.error('Error checking shift overlap:', error);
        showError('Error checking shift overlap');
    }
}

// Function to update night shift indicator
function updateNightShiftIndicator() {
    const shiftSelect = document.getElementById('shift');
    const nightShiftIndicator = document.getElementById('night-shift-indicator');
    
    if (!shiftSelect || !nightShiftIndicator) return;

    const selectedOption = shiftSelect.options[shiftSelect.selectedIndex];
    if (!selectedOption) return;

    const isNightShift = selectedOption.dataset.shiftType === 'NIGHT';
    nightShiftIndicator.style.display = isNightShift ? 'block' : 'none';
}

// Initialize calendar
function initializeCalendar() {
    const calendarEl = document.getElementById('shift-assignment-calendar');
    if (!calendarEl) return;

    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        slotMinTime: '00:00:00',
        slotMaxTime: '24:00:00',
        allDaySlot: false,
        height: '800px',
        slotDuration: '01:00:00',
        dayMaxEvents: true,
        displayEventTime: true,
        nextDayThreshold: '00:00:00',
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        },
        views: {
            timeGridDay: {
                type: 'timeGrid',
                duration: { days: 1 }
            },
            timeGridWeek: {
                type: 'timeGrid',
                duration: { weeks: 1 }
            },
            dayGridMonth: {
                type: 'dayGrid',
                duration: { months: 1 }
            }
        },
        events: async function(info, successCallback, failureCallback) {
            try {
                showLoadingState();
                // Build query parameters
                const params = new URLSearchParams({
                    start: info.startStr,
                    end: info.endStr,
                    view: info.view?.type || 'dayGridMonth'
                });
                
                const departmentFilter = document.getElementById('departmentFilter');
                const shiftTypeFilter = document.getElementById('shiftTypeFilter');
                
                if (selectedEmployeeId) {
                    params.append('employee_id', selectedEmployeeId);
                }
                if (departmentFilter?.value) {
                    params.append('department_id', departmentFilter.value);
                }
                if (shiftTypeFilter?.value) {
                    params.append('shift_type', shiftTypeFilter.value);
                }
                
                const response = await fetch(`/attendance/api/shift_assignment_calendar_events/?${params}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                
                const formattedEvents = data.map(event => ({
                    ...event,
                    allDay: false,
                    display: 'block',
                    className: [
                        ...(event.className || []),
                        'shift-event',
                        `shift-type-${event.shift_type.toLowerCase()}`
                    ]
                }));
                successCallback(formattedEvents);
            } catch (error) {
                console.error('Error fetching events:', error);
                failureCallback(error);
                showError('Error fetching calendar events');
            } finally {
                hideLoadingState();
            }
        },
        eventContent: function(arg) {
            try {
                const shiftType = arg.event.extendedProps?.shift_type || 'DEFAULT';
                const className = `shift-type-${shiftType.toLowerCase()}`;
                const timeText = arg.event.extendedProps?.shift_timing || 
                    `${arg.event.start?.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - 
                     ${arg.event.end?.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                
                // Different display for month view vs week/day view
                if (arg.view.type === 'dayGridMonth') {
                    return {
                        html: `
                            <div class="fc-event-main-wrapper ${className}">
                                <div class="fc-event-title">${arg.event.title || ''}</div>
                                <div class="fc-event-time">${timeText}</div>
                                <div class="fc-event-type">${shiftType}</div>
                            </div>
                        `
                    };
                } else {
                    // For week/day view, show a more compact version
                    return {
                        html: `
                            <div class="fc-event-main-wrapper ${className}">
                                <div class="fc-event-title">${arg.event.title || ''}</div>
                                <div class="fc-event-type">${shiftType}</div>
                            </div>
                        `
                    };
                }
            } catch (error) {
                console.error('Error in eventContent:', error);
                return {
                    html: '<div>Error displaying event</div>'
                };
            }
        },
        dateClick: function(info) {
            try {
                if (selectedEmployeeId) {
                    // If employee selected, show assignment modal
                    const modal = new bootstrap.Modal(document.getElementById('employeeSearchModal'));
                    document.getElementById('selectedDate').value = info.dateStr;
                    modal.show();
                } else {
                    // If no employee selected, show day detail view
                    window.location.href = `/attendance/shifts/day/${info.dateStr}/`;
                }
            } catch (error) {
                console.error('Error in dateClick:', error);
                showError('Error handling date click');
            }
        }
    });

    return calendar;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize calendar
    calendar = initializeCalendar();
    if (calendar) {
        // Fix calendar rendering on tab change
        document.querySelector('button[data-bs-target="#calendar-view"]')?.addEventListener('shown.bs.tab', function (e) {
            setTimeout(() => calendar.render(), 0);
        });
        calendar.render();
    }

    // Initialize filters
    const departmentFilter = document.getElementById('departmentFilter');
    const shiftTypeFilter = document.getElementById('shiftTypeFilter');
    
    departmentFilter?.addEventListener('change', () => calendar?.refetchEvents());
    shiftTypeFilter?.addEventListener('change', () => calendar?.refetchEvents());

    // Quick assignment form handlers
    const quickAssignmentForm = document.getElementById('quick-assignment-form');
    if (quickAssignmentForm) {
        const employeeSelect = document.getElementById('employee');
        const shiftSelect = document.getElementById('shift');
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');

        // Initialize night shift indicator if elements exist
        if (shiftSelect) {
            updateNightShiftIndicator();
            shiftSelect.addEventListener('change', updateNightShiftIndicator);
        }

        // Check for overlaps when form inputs change
        [employeeSelect, startDateInput, endDateInput].forEach(element => {
            if (element) {
                element.addEventListener('change', checkOverlappingShifts);
            }
        });

        // Handle form submission
        quickAssignmentForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            try {
                showLoadingState();
                const formData = new FormData(this);
                
                const response = await fetch('/attendance/api/shift-assignments/quick/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    calendar?.refetchEvents();
                    bootstrap.Modal.getInstance(document.getElementById('quickAssignmentModal')).hide();
                } else {
                    throw new Error(data.error || 'Failed to create assignment');
                }
            } catch (error) {
                console.error('Error:', error);
                showError(error.message || 'Failed to create assignment');
            } finally {
                hideLoadingState();
            }
        });
    }
});

// Add the styles
const styles = `
    .shift-type-default {
        background-color: #0d6efd !important;
        border-color: #0a58ca !important;
        color: white !important;
    }
    .shift-type-night {
        background-color: #0dcaf0 !important;
        border-color: #0a9ec0 !important;
        color: black !important;
    }
    .shift-type-open {
        background-color: #6c757d !important;
        border-color: #565e64 !important;
        color: white !important;
    }
    .shift-event {
        margin: 1px 0;
        padding: 2px;
        border-radius: 3px;
    }
    .fc-event-main-wrapper {
        padding: 2px 4px;
    }
    .fc-event-title {
        font-weight: bold;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .fc-event-time {
        font-size: 0.9em;
        opacity: 0.9;
    }
    .fc-event-type {
        font-size: 0.8em;
        opacity: 0.8;
        font-style: italic;
    }
    .fc-timegrid-event {
        min-height: 2em !important;
    }
    .fc-timegrid-event .fc-event-main {
        padding: 2px 4px !important;
    }
    .fc-timegrid-event .fc-event-title {
        font-size: 0.9em;
    }
    .fc-timegrid-event .fc-event-type {
        font-size: 0.8em;
    }
`;

// Add the styles to the document
const styleSheet = document.createElement('style');
styleSheet.textContent = styles;
document.head.appendChild(styleSheet);

```

### 📄 hrms_project\attendance\tasks.py
```from datetime import datetime, date, timedelta
import logging

from celery import shared_task
from django.db import transaction
from django.db.models import Q
from django.utils import timezone
from django.core.mail import send_mail
from django.conf import settings
from django.template.loader import render_to_string

from .models import (
    ShiftAssignment, AttendanceLog, RamadanPeriod,
    Employee, Leave
)
from .services import ShiftService, RamadanService

logger = logging.getLogger(__name__)

@shared_task
def update_expired_shift_assignments():
    """Deactivate expired shift assignments"""
    today = timezone.now().date()
    
    expired = ShiftAssignment.objects.filter(
        end_date__lt=today,
        is_active=True
    )
    
    updated_count = expired.update(is_active=False)
    logger.info(f"Deactivated {updated_count} expired shift assignments")
    
    return updated_count

@shared_task
def notify_shift_changes():
    """Notify employees of upcoming shift changes"""
    tomorrow = timezone.now().date() + timedelta(days=1)
    
    # Find assignments starting tomorrow
    new_assignments = ShiftAssignment.objects.filter(
        start_date=tomorrow,
        is_active=True
    ).select_related('employee', 'shift')
    
    for assignment in new_assignments:
        try:
            # Check if this is different from current shift
            current_shift = ShiftService.get_employee_current_shift(assignment.employee)
            if current_shift and current_shift != assignment.shift:
                # Prepare email
                context = {
                    'employee': assignment.employee,
                    'old_shift': current_shift,
                    'new_shift': assignment.shift,
                    'start_date': tomorrow
                }
                
                html_message = render_to_string(
                    'attendance/email/shift_change_notification.html',
                    context
                )
                
                # Send email
                send_mail(
                    subject='Shift Change Notification',
                    message='Your shift is changing tomorrow.',
                    from_email=settings.DEFAULT_FROM_EMAIL,
                    recipient_list=[assignment.employee.email],
                    html_message=html_message
                )
                
                logger.info(f"Sent shift change notification to {assignment.employee}")
                
        except Exception as e:
            logger.error(f"Error sending shift change notification: {str(e)}")

@shared_task
def process_ramadan_shift_changes():
    """Handle shift adjustments for Ramadan period"""
    today = timezone.now().date()
    
    # Check if today is start or end of Ramadan
    ramadan_start = RamadanPeriod.objects.filter(
        start_date=today,
        is_active=True
    ).first()
    
    ramadan_end = RamadanPeriod.objects.filter(
        end_date=today,
        is_active=True
    ).first()
    
    if ramadan_start:
        logger.info("Processing Ramadan start adjustments")
        # Notify all employees with active shifts
        assignments = ShiftAssignment.objects.filter(
            is_active=True,
            start_date__lte=today
        ).filter(
            Q(end_date__isnull=True) | Q(end_date__gte=today)
        ).select_related('employee', 'shift')
        
        for assignment in assignments:
            try:
                context = {
                    'employee': assignment.employee,
                    'shift': assignment.shift,
                    'ramadan_period': ramadan_start,
                    'adjusted_timing': RamadanService.get_ramadan_shift_timing(
                        assignment.shift, today
                    )
                }
                
                html_message = render_to_string(
                    'attendance/email/ramadan_timing_notification.html',
                    context
                )
                
                send_mail(
                    subject='Ramadan Working Hours Notification',
                    message='Your working hours have been adjusted for Ramadan.',
                    from_email=settings.DEFAULT_FROM_EMAIL,
                    recipient_list=[assignment.employee.email],
                    html_message=html_message
                )
                
            except Exception as e:
                logger.error(f"Error sending Ramadan notification: {str(e)}")
    
    elif ramadan_end:
        logger.info("Processing Ramadan end adjustments")
        # Similar notification for end of Ramadan
        assignments = ShiftAssignment.objects.filter(
            is_active=True,
            start_date__lte=today
        ).filter(
            Q(end_date__isnull=True) | Q(end_date__gte=today)
        ).select_related('employee', 'shift')
        
        for assignment in assignments:
            try:
                context = {
                    'employee': assignment.employee,
                    'shift': assignment.shift,
                    'ramadan_period': ramadan_end,
                    'is_end': True
                }
                
                html_message = render_to_string(
                    'attendance/email/ramadan_timing_notification.html',
                    context
                )
                
                send_mail(
                    subject='Regular Working Hours Resume',
                    message='Regular working hours will resume after Ramadan.',
                    from_email=settings.DEFAULT_FROM_EMAIL,
                    recipient_list=[assignment.employee.email],
                    html_message=html_message
                )
                
            except Exception as e:
                logger.error(f"Error sending Ramadan end notification: {str(e)}")

@shared_task
def calculate_attendance_metrics(date_str=None):
    """Calculate attendance metrics for a given date"""
    if date_str:
        target_date = datetime.strptime(date_str, '%Y-%m-%d').date()
    else:
        target_date = timezone.now().date() - timedelta(days=1)
    
    logs = AttendanceLog.objects.filter(
        date=target_date
    ).select_related('employee')
    
    metrics = {
        'total': logs.count(),
        'present': 0,
        'absent': 0,
        'late': 0,
        'leave': 0,
        'early_departure': 0
    }
    
    for log in logs:
        if log.is_leave:
            metrics['leave'] += 1
        elif not log.first_in_time:
            metrics['absent'] += 1
        else:
            metrics['present'] += 1
            if log.is_late:
                metrics['late'] += 1
            if log.early_departure:
                metrics['early_departure'] += 1
    
    # Store metrics in cache or database as needed
    logger.info(f"Attendance metrics for {target_date}: {metrics}")
    return metrics

@shared_task
def notify_missing_shift_assignments():
    """Notify HR about employees without active shift assignments"""
    employees = Employee.objects.filter(
        is_active=True
    ).exclude(
        shiftassignment__is_active=True
    )
    
    if employees.exists():
        context = {
            'employees': employees,
            'count': employees.count()
        }
        
        html_message = render_to_string(
            'attendance/email/missing_shift_notification.html',
            context
        )
        
        send_mail(
            subject='Employees Without Shift Assignments',
            message=f'{employees.count()} employees have no active shift assignment.',
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[settings.HR_EMAIL],
            html_message=html_message
        )
        
        logger.info(f"Sent notification for {employees.count()} employees without shifts")
        return employees.count()
    
    return 0


def process_monthly_leave_accruals():
    """Process monthly leave accruals for all employees"""
    today = timezone.now().date()
    
    # Check if it's the first day of the month
    if today.day == 1:
        employees = Employee.objects.filter(
            is_active=True
        )
        
        for employee in employees:
            with transaction.atomic():
                # Increment leave balance for each leave type
                for leave_type in employee.leave_types.all():
                    employee.leave_balances.create(
                        leave_type=leave_type,
                        year=today.year,
                        balance=leave_type.accrual_rate
                    )
        
        logger.info("Processed monthly leave accruals")
        return employees.count()
    
    return 0
```

### 📄 hrms_project\attendance\templates\attendance\attendance_detail.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Attendance Details</h5>
                <small class="text-muted">Employee: {{ employee_name }} (ID: {{ personnel_id }})</small>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLogModal">
                    <i class="fas fa-plus"></i> Add Log
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Dashboard Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">Status</h6>
                        <p class="card-text h4 mb-0" id="status">
                            {{ stats.status }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">Total Hours</h6>
                        <p class="card-text h4 mb-0" id="total-hours">
                            {{ stats.total_hours }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">First In</h6>
                        <p class="card-text h4 mb-0" id="first-in">
                            {{ stats.first_in }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title">Last Out</h6>
                        <p class="card-text h4 mb-0" id="last-out">
                            {{ stats.last_out }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Employee and Date Information -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Employee Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th width="150">Department:</th>
                                <td>{{ department }}</td>
                            </tr>
                            <tr>
                                <th>Designation:</th>
                                <td>{{ designation }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Date Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <th width="150">Date:</th>
                                <td>{{ date }}</td>
                            </tr>
                            <tr>
                                <th>Day:</th>
                                <td>{{ day }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Logs Table -->
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Attendance Logs</h6>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Source</th>
                                <th>Device</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-logs">
                            {% for record in raw_records %}
                            <tr {% if record.time == stats.first_in or record.time == stats.last_out %}class="table-primary"{% endif %}>
                                <td>{{ record.time }}</td>
                                <td>
                                    <span class="badge {% if record.event_point == 'IN' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ record.event_point }}
                                        {% if record.time == stats.first_in %}
                                            (First)
                                        {% elif record.time == stats.last_out %}
                                            (Last)
                                        {% endif %}
                                    </span>
                                </td>
                                <td>{{ record.description }}</td>
                                <td>{{ record.device }}</td>
                        
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editLog('{{ record.id }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('{{ record.id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No attendance records found for this date.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Log Modal -->
<div class="modal fade" id="editLogModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-log-form">
                    <input type="hidden" id="edit-log-id">
                    <div class="mb-3">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="edit-log-time" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Edit Reason</label>
                        <textarea class="form-control" id="edit-reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLogEdit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Log Modal -->
<div class="modal fade" id="addLogModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-log-form">
                    <div class="mb-3">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="add-log-time" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="add-log-type" required>
                            <option value="IN">Check In</option>
                            <option value="OUT">Check Out</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <textarea class="form-control" id="add-log-reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addNewLog()">Add Log</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteLogModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this log? This action cannot be undone.</p>
                <input type="hidden" id="delete-log-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteLog()">Delete</button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

{% endblock %}

{% block extra_js %}
<script>
let currentPersonnelId = '{{ personnel_id }}';
let currentDate = '{{ date }}';

function formatDateForAPI(dateStr) {
    // Try different date formats and convert to YYYY-MM-DD
    const date = new Date(dateStr);
    if (isNaN(date)) {
        // If standard parsing fails, try custom parsing
        const formats = [
            { regex: /^(\d{4})-(\d{2})-(\d{2})$/, parts: [1, 2, 3] },  // YYYY-MM-DD
            { regex: /^(\d{1,2})\/?(\d{1,2})\/?(\d{4})$/, parts: [3, 1, 2] },  // MM/DD/YYYY or M/D/YYYY
            { regex: /^([A-Za-z]{3})\s+(\d{1,2}),\s+(\d{4})$/, parts: null }  // MMM DD, YYYY
        ];

        for (const format of formats) {
            const match = dateStr.match(format.regex);
            if (match) {
                if (format.parts) {
                    const [_, ...parts] = match;
                    const [year, month, day] = format.parts.map(i => parts[i-1]);
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                } else {
                    // Handle MMM DD, YYYY format
                    const date = new Date(dateStr);
                    if (!isNaN(date)) {
                        return date.toISOString().split('T')[0];
                    }
                }
            }
        }
        console.error('Unable to parse date:', dateStr);
        return dateStr; // Return original if all parsing fails
    }
    return date.toISOString().split('T')[0];
}

function loadAttendanceDetails() {
    const formattedDate = formatDateForAPI(currentDate);
    console.log('Formatted Date:', formattedDate);
    console.log('Personnel ID:', currentPersonnelId);
    console.log('Current Date:', currentDate);

    fetch(`/attendance/api/details/?personnel_id=${currentPersonnelId}&date=${formattedDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Update summary stats
            document.querySelector('#status').textContent = data.stats.status;
            document.querySelector('#total-hours').textContent = data.stats.total_hours;
            document.querySelector('#first-in').textContent = data.stats.first_in;
            document.querySelector('#last-out').textContent = data.stats.last_out;
            
            // Update attendance logs
            const logsBody = document.querySelector('#attendance-logs');
            logsBody.innerHTML = '';
            
            if (data.raw_records.length === 0) {
                logsBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">No attendance records found for this date.</td>
                    </tr>
                `;
                return;
            }
            
            data.raw_records.forEach(record => {
                const isFirstIn = record.time === data.stats.first_in;
                const isLastOut = record.time === data.stats.last_out;
                const rowClass = (isFirstIn || isLastOut) ? 'table-primary' : '';
                
                const row = `
                    <tr class="${rowClass}">
                        <td>${record.time}</td>
                        <td>
                            <span class="badge ${record.event_point === 'IN' ? 'bg-success' : 'bg-danger'}">
                                ${record.event_point}
                                ${isFirstIn ? ' (First)' : ''}
                                ${isLastOut ? ' (Last)' : ''}
                            </span>
                        </td>
                        <td>${record.description}</td>
                        <td>${record.device}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editLog('${record.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('${record.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                logsBody.innerHTML += row;
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load attendance details');
        });
}

// We don't need to load attendance details on page load since Django already provides the data

function editLog(recordId) {
    fetch(`/attendance/api/records/${recordId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit-log-id').value = recordId;
            document.getElementById('edit-log-time').value = data.timestamp.split('T')[1].substring(0, 5);
            const modal = new bootstrap.Modal(document.getElementById('editLogModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load log details');
        });
}

function saveLogEdit() {
    const recordId = document.getElementById('edit-log-id').value;
    const time = document.getElementById('edit-log-time').value;
    const reason = document.getElementById('edit-reason').value;

    if (!time || !reason) {
        alert('Please fill in all fields');
        return;
    }

    fetch(`/attendance/api/records/${recordId}/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            time: time,
            reason: reason
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to update log');
        return response.json();
    })
    .then(() => {
        loadAttendanceDetails(); // Reload data instead of full page refresh
        const modal = bootstrap.Modal.getInstance(document.getElementById('editLogModal'));
        modal.hide();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update log');
    });
}

function addNewLog() {
    const time = document.getElementById('add-log-time').value;
    const type = document.getElementById('add-log-type').value;
    const reason = document.getElementById('add-log-reason').value;

    if (!time || !reason) {
        alert('Please fill in all fields');
        return;
    }

    fetch('/attendance/api/records/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            personnel_id: currentPersonnelId,
            date: currentDate,
            time: time,
            type: type,
            reason: reason
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to add log');
        return response.json();
    })
    .then(() => {
        loadAttendanceDetails(); // Reload data instead of full page refresh
        const modal = bootstrap.Modal.getInstance(document.getElementById('addLogModal'));
        modal.hide();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add log');
    });
}

function confirmDelete(recordId) {
    document.getElementById('delete-log-id').value = recordId;
    const modal = new bootstrap.Modal(document.getElementById('deleteLogModal'));
    modal.show();
}

function deleteLog() {
    const recordId = document.getElementById('delete-log-id').value;

    fetch(`/attendance/api/records/${recordId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to delete log');
        loadAttendanceDetails(); // Reload data instead of full page refresh
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteLogModal'));
        modal.hide();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete log');
    });
}
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\attendance_list.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Daily Attendance</h5>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#reprocessModal">
                    <i class="fas fa-sync"></i> Reprocess Attendance
                </button>
                <a href="{% url 'attendance:upload_attendance' %}" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Upload Attendance
                </a>
            </div>

            <!-- Reprocess Modal -->
            <div class="modal fade" id="reprocessModal" tabindex="-1" aria-labelledby="reprocessModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="{% url 'attendance:reprocess_attendance' %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="reprocessModalLabel">Reprocess Attendance</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Date Range</label>
                                    <div class="row">
                                        <div class="col">
                                            <input type="date" name="start_date" class="form-control" required>
                                        </div>
                                        <div class="col">
                                            <input type="date" name="end_date" class="form-control" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Employee (Optional)</label>
                                    <select name="employee_id" class="form-select">
                                        <option value="">All Employees</option>
                                    </select>
                                </div>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> This will recalculate attendance statuses based on current rules. Please use with caution.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-sync"></i> Reprocess
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="start-date">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="end-date">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="department-filter">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="status-filter">
                    <option value="">All Status</option>
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                    <option value="late">Late</option>
                    <option value="leave">Leave</option>
                    <option value="holiday">Holiday</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="search-input" placeholder="Search employees...">
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Present</h5>
                        <h2 class="mb-0" id="present-count">{{ present_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Absent</h5>
                        <h2 class="mb-0" id="absent-count">{{ absent_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h5 class="card-title">Late</h5>
                        <h2 class="mb-0" id="late-count">{{ late_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">On Leave</h5>
                        <h2 class="mb-0" id="leave-count">{{ on_leave_count }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Personnel ID</th>
                        <th>Employee Name</th>
                        <th>Department</th>
                        <th>Date</th>
                        <th>First In</th>
                        <th>Last Out</th>
                        <th>Status</th>
                        <th>Source</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="attendance-logs">
                    <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated dynamically -->
            </ul>
        </nav>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start-date').value = today;
    document.getElementById('end-date').value = today;

    // Initial load of attendance data
    fetchAttendanceLogs(1);

    // Add event listeners for filters
    const filters = ['start-date', 'end-date', 'department-filter', 'status-filter', 'search-input'];
    filters.forEach(id => {
        const element = document.getElementById(id);
        element.addEventListener(id === 'search-input' ? 'input' : 'change', () => {
            fetchAttendanceLogs(1);
        });
    });

    // Initialize employee select in reprocess modal
    const employeeSelect = document.querySelector('#reprocessModal select[name="employee_id"]');
    employeeSelect.addEventListener('focus', function() {
        if (!this.dataset.loaded) {
            fetch('{% url "attendance:get_department_employees" %}')
                .then(response => response.json())
                .then(data => {
                    const options = data.employees.map(emp => 
                        `<option value="${emp.id}">${emp.name}</option>`
                    ).join('');
                    this.innerHTML += options;
                    this.dataset.loaded = 'true';
                })
                .catch(error => console.error('Error loading employees:', error));
        }
    });

    // Automatically populate reprocess date range with current filter values
    document.querySelector('[data-bs-target="#reprocessModal"]').addEventListener('click', function() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (startDate) {
            document.querySelector('#reprocessModal input[name="start_date"]').value = startDate;
        }
        if (endDate) {
            document.querySelector('#reprocessModal input[name="end_date"]').value = endDate;
        }
    });
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function fetchAttendanceLogs(page = 1) {
    // Ensure page is a number
    if (typeof page !== 'number') {
        page = 1;
    }

    const params = new URLSearchParams({
        start_date: document.getElementById('start-date').value || '',
        end_date: document.getElementById('end-date').value || '',
        department: document.getElementById('department-filter').value || '',
        status: document.getElementById('status-filter').value || '',
        search: document.getElementById('search-input').value || '',
        page: page.toString()
    });

    fetch(`/attendance/api/logs/?${params}`, {
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Update summary counts
        document.getElementById('present-count').textContent = data.summary?.present || 0;
        document.getElementById('absent-count').textContent = data.summary?.absent || 0;
        document.getElementById('late-count').textContent = data.summary?.late || 0;
        document.getElementById('leave-count').textContent = data.summary?.leave || 0;

        // Update table content
        const tbody = document.getElementById('attendance-logs');
        tbody.innerHTML = data.results.map(log => `
            <tr>
                <td>${log.personnel_id || '-'}</td>
                <td>
                    <a href="/employees/${log.employee_id}/" class="text-decoration-none">
                        ${log.employee_name || '-'}
                    </a>
                </td>
                <td>${log.department || '-'}</td>
                <td id="log-date-${log.id}">${formatDate(log.date) || '-'}</td>
                <td>${formatTime(log.first_in_time) || '-'}</td>
                <td>${formatTime(log.last_out_time) || '-'}</td>
                <td>
                    <span class="badge ${getStatusBadgeClass(getStatusText(log))}">
                        ${getStatusText(log)}
                    </span>
                </td>
                <td>${log.source || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="viewDetails('${log.id}', '${log.personnel_id || ''}', '${log.date}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        updatePagination(data);
    })
    .catch(error => {
        console.error('Error fetching attendance logs:', error);
        const tbody = document.getElementById('attendance-logs');
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-danger">
                    Error loading attendance data. Please try again.
                </td>
            </tr>
        `;
    });
}

function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

function formatTime(timeString) {
    if (!timeString) return null;
    const date = new Date(`2000-01-01T${timeString}`);
    return date.toLocaleTimeString(undefined, { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
}

function getStatusText(log) {
    if (!log.first_in_time) return 'Absent';
    if (log.is_late) return 'Late';
    return 'Present';
}

function getStatusBadgeClass(status) {
    switch (status.toLowerCase()) {
        case 'present':
            return 'bg-success';
        case 'absent':
            return 'bg-danger';
        case 'late':
            return 'bg-warning text-dark';
        case 'leave':
            return 'bg-info';
        default:
            return 'bg-secondary';
    }
}

function updatePagination(data) {
    const pagination = document.getElementById('pagination');
    if (!data.count) {
        pagination.innerHTML = '';
        return;
    }

    // Use the page size from the response or default to 400
    const pageSize = data.results.length || 400;
    const totalPages = Math.ceil(data.count / pageSize);
    const currentPage = parseInt(new URLSearchParams(window.location.search).get('page')) || 1;

    let paginationHtml = '';
    
    // Previous button
    paginationHtml += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="fetchAttendanceLogs(${currentPage - 1}); return false;">Previous</a>
        </li>
    `;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHtml += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="fetchAttendanceLogs(${i}); return false;">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    // Next button
    paginationHtml += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="fetchAttendanceLogs(${currentPage + 1}); return false;">Next</a>
        </li>
    `;

    pagination.innerHTML = paginationHtml;
}

function viewDetails(logId, personnelId, date) {
    if (!personnelId || !date) {
        console.error('Missing required parameters for viewDetails');
        return;
    }
    window.location.href = `{% url 'attendance:attendance_detail' %}?personnel_id=${personnelId}&date=${date}`;
}
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\attendance_report.html
```{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'attendance/css/reports.css' %}">
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-chart-bar"></i> Attendance Reports
        </h5>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="report-filters">
            <div class="row g-3">
                <!-- Report Type -->
                <div class="col-md-3">
                    <label for="reportType" class="form-label">Report Type</label>
                    <select class="form-select" id="reportType">
                        <option value="attendance">Attendance Report</option>
                        <option value="leave">Leave Report</option>
                        <option value="holiday">Holiday Report</option>
                    </select>
                </div>

                <!-- Department Filter -->
                <div class="col-md-3">
                    <label for="department" class="form-label">Department</label>
                    <select class="form-select" id="department">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Date Range -->
                <div class="col-md-3">
                    <label for="dateRange" class="form-label">Date Range</label>
                    <select class="form-select" id="dateRange">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>

                <!-- Custom Date Range -->
                <div class="col-md-6" id="customDateRange" style="display: none;">
                    <div class="row">
                        <div class="col-6">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-6">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" multiple>
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="late">Late</option>
                        <option value="leave">On Leave</option>
                    </select>
                </div>

                <!-- Export Format -->
                <div class="col-md-3">
                    <label for="exportFormat" class="form-label">Export Format</label>
                    <select class="form-select" id="exportFormat">
                        <option value="html">Web View</option>
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                        <option value="pdf">PDF</option>
                    </select>
                </div>

                <!-- Generate Button -->
                <div class="col-md-12">
                    <button class="btn btn-primary" id="generateReport">
                        <i class="fas fa-sync-alt"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Holiday Information -->
        <div id="holidayInfo" style="display: none;">
            <!-- Holiday information will be populated by JavaScript -->
        </div>

        <!-- Report Content -->
        <div class="report-content">
            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h6 class="card-title">Present</h6>
                            <h3 class="card-text" id="presentCount">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h6 class="card-title">Absent</h6>
                            <h3 class="card-text" id="absentCount">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <h6 class="card-title">Late</h6>
                            <h3 class="card-text" id="lateCount">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h6 class="card-title">On Leave</h6>
                            <h3 class="card-text" id="leaveCount">-</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6 class="card-title">Daily Attendance Trend</h6>
                        <canvas id="attendanceTrendChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h6 class="card-title">Department-wise Attendance</h6>
                        <canvas id="departmentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Report Table -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">Detailed Report</h6>
                        <div class="table-actions">
                            <input type="text" class="form-control form-control-sm" id="tableSearch" placeholder="Search...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="reportTable">
                            <thead>
                                <tr>
                                    <th>Employee ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Present Days</th>
                                    <th>Absent Days</th>
                                    <th>Late Days</th>
                                    <th>Leave Days</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<!-- Error Toast -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="errorToast">
        <div class="toast-header bg-danger text-white">
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="errorMessage">
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Custom report JS -->
<script type="module" src="{% static 'attendance/js/attendance_report.js' %}"></script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\base.html
```{% extends 'core/base.html' %}
{% load static %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/main.min.css' rel='stylesheet' />
<!-- Custom attendance CSS -->
<link href="{% static 'attendance/css/attendance.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2">
            <!-- Daily Attendance Section -->
            <div class="list-group mb-4">
                <div class="list-group-item bg-light fw-bold">
                    <i class="fas fa-clock"></i> Daily Attendance
                </div>
                <a href="{% url 'attendance:attendance_list' %}" 
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'attendance_list' %}active{% endif %}">
                    <i class="fas fa-list"></i> View Attendance
                </a>
                <a href="{% url 'attendance:mark_attendance' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'mark_attendance' %}active{% endif %}">
                    <i class="fas fa-edit"></i> Mark Attendance
                </a>
                <a href="{% url 'attendance:upload_attendance' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'upload_attendance' %}active{% endif %}">
                    <i class="fas fa-upload"></i> Upload Attendance
                </a>
                <a href="{% url 'attendance:attendance_report' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'attendance_report' %}active{% endif %}">
                    <i class="fas fa-chart-bar"></i> Reports
                </a>
            </div>

            <!-- Shift Management Section -->
            <div class="list-group mb-4">
                <div class="list-group-item bg-light fw-bold">
                    <i class="fas fa-business-time"></i> Shift Management
                </div>
                <a href="{% url 'attendance:shift_list' %}"
                   class="list-group-item list-group-item-action {% if 'shift' in request.resolver_match.url_name and 'assignment' not in request.resolver_match.url_name %}active{% endif %}">
                    <i class="fas fa-list"></i> View Shifts
                </a>
                <a href="{% url 'attendance:shift_assignment_list' %}"
                   class="list-group-item list-group-item-action {% if 'assignment' in request.resolver_match.url_name %}active{% endif %}">
                    <i class="fas fa-users"></i> Shift Assignments
                </a>
                <a href="{% url 'attendance:ramadan_periods' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'ramadan_periods' %}active{% endif %}">
                    <i class="fas fa-moon"></i> Ramadan Periods
                </a>
            </div>

            <!-- Holiday Management Section -->
            <div class="list-group mb-4">
                <div class="list-group-item bg-light fw-bold">
                    <i class="fas fa-star"></i> Holiday Management
                </div>
                <a href="{% url 'attendance:holiday_list' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'holiday_list' %}active{% endif %}">
                    <i class="fas fa-list"></i> Holiday List
                </a>
                <a href="{% url 'attendance:holiday_create' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'holiday_create' %}active{% endif %}">
                    <i class="fas fa-plus"></i> Add Holiday
                </a>
                <a href="{% url 'attendance:recurring_holidays' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'recurring_holidays' %}active{% endif %}">
                    <i class="fas fa-redo"></i> Recurring Holidays
                </a>
            </div>

            <!-- Leave Management Section -->
            <div class="list-group mb-4">
                <div class="list-group-item bg-light fw-bold">
                    <i class="fas fa-calendar-minus"></i> Leave Management
                </div>
                <a href="{% url 'attendance:leave_request_list' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'leave_request_list' %}active{% endif %}">
                    <i class="fas fa-list"></i> Leave Requests
                </a>
                <a href="{% url 'attendance:leave_request_create' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'leave_request_create' %}active{% endif %}">
                    <i class="fas fa-plus"></i> Apply for Leave
                </a>
                <a href="{% url 'attendance:leave_balance' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'leave_balance' %}active{% endif %}">
                    <i class="fas fa-balance-scale"></i> Leave Balances
                </a>
                <a href="{% url 'attendance:leave_types' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'leave_types' %}active{% endif %}">
                    <i class="fas fa-tags"></i> Leave Types
                </a>
            </div>

            <!-- Calendar Views Section -->
            <div class="list-group mb-4">
                <div class="list-group-item bg-light fw-bold">
                    <i class="fas fa-calendar-alt"></i> Calendar Views
                </div>
                <a href="{% url 'attendance:calendar_month' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'calendar_month' %}active{% endif %}">
                    <i class="far fa-calendar"></i> Monthly View
                </a>
                <a href="{% url 'attendance:calendar_week' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'calendar_week' %}active{% endif %}">
                    <i class="far fa-calendar-alt"></i> Weekly View
                </a>
                <a href="{% url 'attendance:calendar_department' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'calendar_department' %}active{% endif %}">
                    <i class="fas fa-users"></i> Department View
                </a>
            </div>

            <!-- Status Legend -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Status Legend</h6>
                </div>
                <div class="card-body p-2">
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot bg-success"></div>
                        <span class="ms-2">Present</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot bg-danger"></div>
                        <span class="ms-2">Absent</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot bg-warning"></div>
                        <span class="ms-2">Late</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot bg-info"></div>
                        <span class="ms-2">Leave</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot bg-primary"></div>
                        <span class="ms-2">Holiday</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="status-dot bg-secondary"></div>
                        <span class="ms-2">Friday</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            {% block attendance_content %}{% endblock %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- FullCalendar Bundle -->
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.10/index.global.min.js'></script>
<!-- Custom attendance JS -->
<script src="{% static 'attendance/js/attendance.js' %}"></script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\calendar.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<style>
.fc-event {
    cursor: pointer;
}

.fc-day-friday {
    background-color: rgba(0,0,0,0.05);
}

.fc-day-today {
    background-color: rgba(0,123,255,0.1) !important;
}

.calendar-legend {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

.tooltip-inner {
    max-width: 300px;
}

#filter-collapse {
    transition: all 0.3s ease-in-out;
}

/* Select2 Custom Styles */
.select2-container--default .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
    padding-left: 12px;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
}
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h5 class="mb-0 d-inline-block me-2">Attendance Calendar</h5>
                <h6 class="mb-0 me-3" id="calendar-title"></h6>
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse">
                    <i class="fas fa-filter"></i> Filters
                </button>
            </div>
            <div class="btn-group ms-auto">
                <button class="btn btn-outline-secondary" id="prev-month">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary" id="today">Today</button>
                <button class="btn btn-outline-secondary" id="next-month">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="collapse mb-4" id="filter-collapse">
            <div class="card card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="department-filter">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Employee</label>
                        <select class="form-control" id="employee-filter">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">View Type</label>
                        <select class="form-select" id="view-type">
                            <option value="dayGridMonth">Month</option>
                            <option value="dayGridWeek">Week</option>
                            <option value="dayGridDay">Day</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" id="apply-filters">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Legend -->
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color bg-success"></div>
                <span>Present</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-danger"></div>
                <span>Absent</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-warning"></div>
                <span>Late</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-info"></div>
                <span>Leave</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-primary"></div>
                <span>Holiday</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(0,0,0,0.05);"></div>
                <span>Friday</span>
            </div>
        </div>

        <!-- Calendar -->
        <div id="calendar"></div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetails">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2
    $('#employee-filter').select2({
        placeholder: 'Search by ID or Name',
        allowClear: true,
        minimumInputLength: 1,
        ajax: {
            url: '{% url "attendance:search_employees" %}',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return {
                    q: params.term,
                    department: $('#department-filter').val()
                };
            },
            processResults: function(data) {
                return {
                    results: data.map(function(emp) {
                        return {
                            id: emp.id,
                            text: emp.employee_number + ' - ' + emp.full_name,
                            employee_number: emp.employee_number
                        };
                    })
                };
            },
            cache: true
        }
    });

    // Update search when department changes
    $('#department-filter').on('change', function() {
        $('#employee-filter').val(null).trigger('change');
    });

    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: false,
        dayHeaderFormat: { weekday: 'short' },
        firstDay: 0, // Start week on Sunday
        height: 'auto',
        dayCellDidMount: function(info) {
            // Add class to Fridays
            if (info.date.getDay() === 5) { // 5 is Friday
                info.el.classList.add('fc-day-friday');
            }
        },
        eventDidMount: function(info) {
            // Add tooltips
            $(info.el).tooltip({
                title: info.event.extendedProps.tooltip || info.event.title,
                placement: 'top',
                container: 'body'
            });
        },
        eventClick: function(info) {
            showEventDetails(info.event);
        },
        displayEventTime: false, // Hide time from event display
        eventDisplay: 'block', // Display events as blocks
        events: function(info, successCallback, failureCallback) {
            const department = $('#department-filter').val();
            const employee = $('#employee-filter').val();
            
            // Format dates in ISO format (YYYY-MM-DD)
            const start = info.start.toISOString().split('T')[0];
            const end = info.end.toISOString().split('T')[0];
            
            fetch(`/attendance/api/calendar_events/?start=${start}&end=${end}&department=${department}&employee=${employee}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Server error:', data.error);
                        failureCallback(new Error(data.error));
                        return;
                    }
                    successCallback(data);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                });
        }
    });

    calendar.render();

    // Navigation buttons
    $('#prev-month').click(() => {
        calendar.prev();
        calendar.refetchEvents();
    });
    $('#next-month').click(() => {
        calendar.next();
        calendar.refetchEvents();
    });
    $('#today').click(() => {
        calendar.today();
        calendar.refetchEvents();
    });

    // View type change
    $('#view-type').change(function() {
        calendar.changeView($(this).val());
    });

    // Apply filters
    $('#apply-filters').click(function() {
        calendar.refetchEvents();
    });

    // Handle date clicks
    $(document).on('click', '.fc-daygrid-day', function(e) {
        const date = $(this).data('date');
        const employeeId = $('#employee-filter').val();
        
        // Prepare URL for attendance details
        let url = `{% url "attendance:attendance_detail" %}?date=${date}`;
        
        if (employeeId) {
            const empNumber = $('#employee-filter').select2('data')[0]?.employee_number;
            if (empNumber) {
                url += '&personnel_id=' + empNumber;
            }
        }
        
        // Load attendance details in modal
        $('#eventDetails').load(url, function() {
            $('#eventModal').modal('show');
        });
    });

    // Update calendar title
    function updateCalendarTitle() {
        const date = calendar.getDate();
        const title = date.toLocaleString('default', { month: 'long', year: 'numeric' });
        $('#calendar-title').text(title);
    }

    // Initialize calendar with current month
    const today = new Date();
    calendar.gotoDate(today);
    updateCalendarTitle();

    // Update title on navigation
    calendar.on('datesSet', function(info) {
        updateCalendarTitle();
    });

    function showEventDetails(event) {
        const modal = $('#eventModal');
        const title = event.title;
        const details = event.extendedProps;
        
        modal.find('#eventTitle').text(title);
        
        let detailsHtml = '<dl class="row mb-0">';
        
        // Common fields
        if (details.type === 'attendance') {
            detailsHtml += `
                <dt class="col-sm-4">Employee</dt>
                <dd class="col-sm-8">${details.employee}</dd>
                ${details.department ? `
                    <dt class="col-sm-4">Department</dt>
                    <dd class="col-sm-8">${details.department}</dd>
                ` : ''}
                <dt class="col-sm-4">Status</dt>
                <dd class="col-sm-8">
                    <span class="badge bg-${details.status_color}">${details.status}</span>
                </dd>
                <dt class="col-sm-4">Time In</dt>
                <dd class="col-sm-8">${details.time_in || '-'}</dd>
                <dt class="col-sm-4">Time Out</dt>
                <dd class="col-sm-8">${details.time_out || '-'}</dd>
                ${details.work_hours ? `
                    <dt class="col-sm-4">Work Hours</dt>
                    <dd class="col-sm-8">${details.work_hours}</dd>
                ` : ''}
                ${details.late_by ? `
                    <dt class="col-sm-4">Late By</dt>
                    <dd class="col-sm-8">${details.late_by}</dd>
                ` : ''}
            `;

            // Add View Details button
            detailsHtml += `
                <div class="text-end mt-3">
                    <a href="/attendance/attendance_detail/?date=${event.startStr}&employee_id=${details.employee_id}" 
                       class="btn btn-primary btn-sm">
                        View Full Details
                    </a>
                </div>
            `;
        } else if (details.type === 'holiday') {
            detailsHtml += `
                <dt class="col-sm-4">Holiday Type</dt>
                <dd class="col-sm-8">${details.holiday_type.replace('_', ' ').toLowerCase()
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ')}</dd>
                ${details.description ? `
                    <dt class="col-sm-4">Description</dt>
                    <dd class="col-sm-8">${details.description}</dd>
                ` : ''}
            `;

            // Add View Holiday Details button if you have a holiday details page
            detailsHtml += `
                <div class="text-end mt-3">
                    <a href="/attendance/holidays/${event.id.split('_')[1]}" 
                       class="btn btn-primary btn-sm">
                        View Holiday Details
                    </a>
                </div>
            `;
        }
        
        detailsHtml += '</dl>';
        
        modal.find('#eventDetails').html(detailsHtml);
        modal.modal('show');
    }

    // Clean up tooltips when events are removed
    calendar.on('eventRemove', function(info) {
        $(info.el).tooltip('dispose');
    });
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\email\attendance_reminder.html
```<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 20px;
        }
        .header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 3px solid #17a2b8;
            margin-bottom: 20px;
        }
        .content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .reminder-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .time-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            text-align: center;
        }
        .current-time {
            font-size: 24px;
            font-weight: bold;
            color: #856404;
            margin: 10px 0;
        }
        .schedule-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .info-table th,
        .info-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .info-table th {
            background-color: #f1f3f5;
            font-weight: bold;
            width: 40%;
        }
        .footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }
        .action-buttons {
            margin: 20px 0;
            text-align: center;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #17a2b8;
            color: white;
        }
        .clock-status {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            text-align: center;
        }
        .status-item {
            padding: 15px;
            border-radius: 4px;
            min-width: 150px;
        }
        .status-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 18px;
            font-weight: bold;
        }
        .status-pending {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
        }
        .status-completed {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .quick-links {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .quick-links ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .quick-links li {
            margin: 10px 0;
        }
        .quick-links a {
            color: #17a2b8;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>Attendance Reminder</h2>
        <p>{{ current_date|date:"l, F j, Y" }}</p>
    </div>

    <div class="content">
        <p>Dear {{ employee.get_full_name }},</p>

        <div class="reminder-box">
            <h3>🕒 Daily Attendance Reminder</h3>
            <p>This is a friendly reminder about your attendance for today.</p>
        </div>

        <div class="time-box">
            <div class="current-time">{{ current_time|time:"h:i A" }}</div>
            <p>Current Time</p>
        </div>

        <div class="clock-status">
            <div class="status-item {% if clock_in_time %}status-completed{% else %}status-pending{% endif %}">
                <div class="status-label">Clock In</div>
                <div class="status-value">
                    {% if clock_in_time %}
                    {{ clock_in_time|time:"h:i A" }}
                    {% else %}
                    Pending
                    {% endif %}
                </div>
            </div>
            <div class="status-item {% if clock_out_time %}status-completed{% else %}status-pending{% endif %}">
                <div class="status-label">Clock Out</div>
                <div class="status-value">
                    {% if clock_out_time %}
                    {{ clock_out_time|time:"h:i A" }}
                    {% else %}
                    Pending
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="schedule-info">
            <h4>Today's Schedule</h4>
            <table class="info-table">
                <tr>
                    <th>Regular Start Time</th>
                    <td>{{ schedule.start_time|time:"h:i A" }}</td>
                </tr>
                <tr>
                    <th>Regular End Time</th>
                    <td>{{ schedule.end_time|time:"h:i A" }}</td>
                </tr>
                <tr>
                    <th>Grace Period</th>
                    <td>{{ grace_period }} minutes</td>
                </tr>
            </table>
        </div>

        {% if missing_action %}
        <div class="action-buttons">
            <a href="{{ portal_link }}" class="btn btn-primary">{{ missing_action }}</a>
        </div>
        {% endif %}

        <div class="quick-links">
            <h4>Quick Links</h4>
            <ul>
                <li><a href="{{ attendance_history_link }}">View Attendance History</a></li>
                <li><a href="{{ request_correction_link }}">Request Attendance Correction</a></li>
                <li><a href="{{ leave_request_link }}">Submit Leave Request</a></li>
                {% if support_link %}
                <li><a href="{{ support_link }}">Technical Support</a></li>
                {% endif %}
            </ul>
        </div>

        {% if notifications %}
        <div class="reminder-box">
            <h4>Important Notifications</h4>
            <ul>
                {% for notification in notifications %}
                <li>{{ notification }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <div class="footer">
        <p>This is an automated reminder from the HR Management System.</p>
        <p>For any issues with attendance recording, please contact your supervisor or HR immediately.</p>
        {% if help_desk_contact %}
        <p>Technical Support: {{ help_desk_contact }}</p>
        {% endif %}
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\email\attendance_warning.html
```<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 20px;
        }
        .header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 3px solid #dc3545;
            margin-bottom: 20px;
        }
        .content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .warning-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .incident-details {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .incident-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .incident-table th,
        .incident-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .incident-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .policy-reminder {
            background-color: #e2e3e5;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .action-required {
            background-color: #cce5ff;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>Attendance Warning Notice</h2>
    </div>

    <div class="content">
        <p>Dear {{ employee.get_full_name }},</p>

        <div class="warning-box">
            <h3>⚠️ Warning: Attendance Policy Violation</h3>
            <p>This notice is to inform you that your attendance record has fallen below company standards.</p>
        </div>

        <div class="incident-details">
            <h4>Violation Details:</h4>
            <table class="incident-table">
                <tr>
                    <th>Type:</th>
                    <td>{{ violation_type }}</td>
                </tr>
                <tr>
                    <th>Period:</th>
                    <td>{{ period }}</td>
                </tr>
                <tr>
                    <th>Incidents:</th>
                    <td>{{ incident_count }}</td>
                </tr>
            </table>

            {% if incidents %}
            <h4>Recent Incidents:</h4>
            <table class="incident-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for incident in incidents %}
                    <tr>
                        <td>{{ incident.date|date:"d/m/Y" }}</td>
                        <td>{{ incident.type }}</td>
                        <td>{{ incident.details }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>

        <div class="policy-reminder">
            <h4>Company Policy Reminder:</h4>
            <ul>
                <li>Regular working hours are from {{ work_hours }}</li>
                <li>Maximum allowed late arrivals per month: {{ max_late_allowed }}</li>
                <li>Maximum allowed unexcused absences per month: {{ max_absences_allowed }}</li>
                <li>Three warnings may result in disciplinary action</li>
            </ul>
        </div>

        <div class="action-required">
            <h4>Required Actions:</h4>
            <ol>
                <li>Please provide an explanation for these incidents to your supervisor within 3 working days</li>
                <li>Schedule a meeting with HR to discuss any underlying issues</li>
                <li>Ensure future compliance with attendance policies</li>
            </ol>
        </div>

        <p>If you are experiencing any issues that affect your attendance, please discuss them with your supervisor or HR. We are here to help and can work together to find appropriate solutions.</p>

        <p>Best regards,<br>
        HR Department</p>
    </div>

    <div class="footer">
        <p>This is an official warning notice. Please acknowledge receipt by replying to this email.</p>
        <p>If you need assistance, please contact HR at {{ hr_email|default:"hr@company.com" }}</p>
        <p>Reference: {{ warning_reference }}<br>
        Notice Date: {{ generated_at|date:"l, F j, Y" }}</p>
        {% if warning_level %}
        <p><strong>Warning Level:</strong> {{ warning_level }} of 3</p>
        {% endif %}
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\email\leave_request_notification.html
```<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 20px;
        }
        .header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 3px solid #007bff;
            margin-bottom: 20px;
        }
        .content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .leave-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .detail-table th,
        .detail-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .detail-table th {
            background-color: #f1f3f5;
            font-weight: bold;
            width: 35%;
        }
        .balance-info {
            background-color: #e8f4ff;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .action-buttons {
            margin: 20px 0;
            text-align: center;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 0 10px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .btn-approve {
            background-color: #28a745;
            color: white;
        }
        .btn-reject {
            background-color: #dc3545;
            color: white;
        }
        .note {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }
        .document-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .document-list {
            list-style: none;
            padding: 0;
        }
        .document-list li {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .status-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending {
            background-color: #ffc107;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>Leave Request Notification</h2>
        <span class="status-tag status-pending">Pending Approval</span>
    </div>

    <div class="content">
        <h3>New Leave Request</h3>
        <p>A new leave request has been submitted and requires your approval.</p>

        <div class="leave-details">
            <h4>Request Details</h4>
            <table class="detail-table">
                <tr>
                    <th>Employee:</th>
                    <td>{{ leave.employee.get_full_name }} ({{ leave.employee.employee_number }})</td>
                </tr>
                <tr>
                    <th>Department:</th>
                    <td>{{ leave.employee.department.name }}</td>
                </tr>
                <tr>
                    <th>Leave Type:</th>
                    <td>{{ leave.get_leave_type_display }}</td>
                </tr>
                <tr>
                    <th>Start Date:</th>
                    <td>{{ leave.start_date|date:"l, F j, Y" }}</td>
                </tr>
                <tr>
                    <th>End Date:</th>
                    <td>{{ leave.end_date|date:"l, F j, Y" }}</td>
                </tr>
                <tr>
                    <th>Duration:</th>
                    <td>{{ leave.duration }} day{{ leave.duration|pluralize }}</td>
                </tr>
                {% if leave.reason %}
                <tr>
                    <th>Reason:</th>
                    <td>{{ leave.reason }}</td>
                </tr>
                {% endif %}
            </table>
        </div>

        <div class="balance-info">
            <h4>Leave Balance Information</h4>
            <table class="detail-table">
                <tr>
                    <th>Current Balance:</th>
                    <td>{{ leave.balance_before }} days</td>
                </tr>
                <tr>
                    <th>Requested Days:</th>
                    <td>{{ leave.duration }} days</td>
                </tr>
                <tr>
                    <th>Remaining Balance:</th>
                    <td>{{ leave.balance_after }} days</td>
                </tr>
            </table>
        </div>

        {% if leave.documents.exists %}
        <div class="document-section">
            <h4>Supporting Documents</h4>
            <ul class="document-list">
                {% for doc in leave.documents.all %}
                <li>
                    <i class="far fa-file"></i>
                    {{ doc.filename }}
                    <a href="{{ doc.file.url }}" target="_blank">(View)</a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="action-buttons">
            <a href="{{ approve_url }}" class="btn btn-approve">Approve Request</a>
            <a href="{{ reject_url }}" class="btn btn-reject">Reject Request</a>
        </div>

        {% if conflicts %}
        <div class="note">
            <h4>⚠️ Important Notes:</h4>
            <ul>
                {% for conflict in conflicts %}
                <li>{{ conflict }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <div class="footer">
        <p>This is an automated notification from the HR Management System.</p>
        <p>Reference: {{ leave.reference_number }}<br>
        Submitted: {{ leave.created_at|date:"l, F j, Y H:i" }}</p>
        <p>Please review and respond to this request promptly. If you have any questions, please contact HR.</p>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\email\low_balance_notification.html
```<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 20px;
        }
        .header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 3px solid #ffc107;
            margin-bottom: 20px;
        }
        .content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .alert-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .balance-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .info-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .info-table th,
        .info-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .info-table th {
            background-color: #f1f3f5;
            font-weight: bold;
            width: 40%;
        }
        .accrual-info {
            background-color: #e8f4ff;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .upcoming-leaves {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #ffc107;
            transition: width 0.3s ease;
        }
        .recommendation-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>Low Leave Balance Alert</h2>
    </div>

    <div class="content">
        <p>Dear {{ employee.get_full_name }},</p>

        <div class="alert-box">
            <h3>⚠️ Low Leave Balance Notice</h3>
            <p>This is to inform you that your leave balance is running low.</p>
        </div>

        <div class="balance-info">
            <h4>Current Leave Balance</h4>
            <table class="info-table">
                <tr>
                    <th>Leave Type</th>
                    <td>{{ leave_type }}</td>
                </tr>
                <tr>
                    <th>Current Balance</th>
                    <td>{{ current_balance }} days</td>
                </tr>
                <tr>
                    <th>Threshold Level</th>
                    <td>{{ threshold }} days</td>
                </tr>
            </table>

            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ balance_percentage }}%"></div>
            </div>
        </div>

        <div class="accrual-info">
            <h4>Next Accrual Information</h4>
            <table class="info-table">
                <tr>
                    <th>Next Accrual Date</th>
                    <td>{{ next_accrual_date|date:"F j, Y" }}</td>
                </tr>
                <tr>
                    <th>Expected Days to be Added</th>
                    <td>{{ expected_accrual }} days</td>
                </tr>
            </table>
        </div>

        {% if upcoming_leaves %}
        <div class="upcoming-leaves">
            <h4>Upcoming Approved Leaves</h4>
            <table class="info-table">
                <thead>
                    <tr>
                        <th>Period</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in upcoming_leaves %}
                    <tr>
                        <td>{{ leave.start_date|date:"M j" }} - {{ leave.end_date|date:"M j, Y" }}</td>
                        <td>{{ leave.duration }} day{{ leave.duration|pluralize }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <div class="recommendation-box">
            <h4>Recommendations</h4>
            <ul>
                <li>Plan your upcoming leaves carefully considering your current balance</li>
                <li>Consider spreading out your leave requests over time</li>
                <li>Discuss with your supervisor if you need to take emergency leave</li>
                {% if has_unused_leaves %}
                <li>You have unused leaves from other categories that you might want to consider using</li>
                {% endif %}
            </ul>
        </div>
    </div>

    <div class="footer">
        <p>This is an automated notification from the HR Management System.</p>
        <p>Generated on: {{ generated_at|date:"l, F j, Y" }}</p>
        <p>For any questions about your leave balance or policy, please contact HR.</p>
        {% if help_link %}
        <p><a href="{{ help_link }}">View Leave Policy Documentation</a></p>
        {% endif %}
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\email\missing_attendance_report.html
```<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 20px;
        }
        .header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 3px solid #dc3545;
            margin-bottom: 20px;
        }
        .content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .alert-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .missing-records {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .records-table th,
        .records-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .records-table th {
            background-color: #f1f3f5;
            font-weight: bold;
        }
        .records-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .instructions {
            background-color: #e8f4ff;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }
        .action-required {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .summary-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .summary-item {
            padding: 10px;
        }
        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
        }
        .summary-label {
            font-size: 14px;
            color: #666;
        }
        .deadline-notice {
            font-weight: bold;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>Missing Attendance Records Report</h2>
    </div>

    <div class="content">
        <p>Dear {{ employee.get_full_name }},</p>

        <div class="alert-box">
            <h3>⚠️ Missing Attendance Records</h3>
            <p>We have noticed that you have missing attendance records for the following period:</p>
            <p><strong>Period:</strong> {{ period_start|date:"F j, Y" }} - {{ period_end|date:"F j, Y" }}</p>
        </div>

        <div class="summary-box">
            <div class="summary-item">
                <div class="summary-number">{{ total_missing_records }}</div>
                <div class="summary-label">Total Missing Records</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">{{ missing_in_records }}</div>
                <div class="summary-label">Missing Check-ins</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">{{ missing_out_records }}</div>
                <div class="summary-label">Missing Check-outs</div>
            </div>
        </div>

        <div class="missing-records">
            <h4>Missing Record Details</h4>
            <table class="records-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Missing Record Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in missing_records %}
                    <tr>
                        <td>{{ record.date|date:"d/m/Y" }}</td>
                        <td>{{ record.date|date:"l" }}</td>
                        <td>{{ record.missing_type }}</td>
                        <td>{{ record.status }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="action-required">
            <h4>Action Required</h4>
            <p>Please take the following actions:</p>
            <ol>
                <li>Review the missing records listed above</li>
                <li>Submit justification for each missing record through the HR portal</li>
                <li>Attach any supporting documents if available</li>
                <li>Submit your response by <span class="deadline-notice">{{ submission_deadline|date:"F j, Y" }}</span></li>
            </ol>
        </div>

        <div class="instructions">
            <h4>How to Submit Your Response</h4>
            <ol>
                <li>Log in to the HR Portal</li>
                <li>Go to the "Attendance" section</li>
                <li>Click on "Missing Records Resolution"</li>
                <li>Fill in the required information for each missing record</li>
                <li>Submit for approval</li>
            </ol>
            {% if portal_link %}
            <p><a href="{{ portal_link }}">Click here to access the HR Portal</a></p>
            {% endif %}
        </div>

        {% if policy_reminders %}
        <div class="instructions">
            <h4>Policy Reminders</h4>
            <ul>
                {% for reminder in policy_reminders %}
                <li>{{ reminder }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <div class="footer">
        <p>This is an automated notification from the HR Management System.</p>
        <p>Generated on: {{ generated_at|date:"l, F j, Y" }}</p>
        <p>If you believe there is an error in this report or need assistance, please contact HR immediately.</p>
        <p>Reference: {{ report_reference }}</p>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\email\missing_shift_notification.html
```<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; }
        .header { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
        .content { padding: 20px 0; }
        .alert { color: #721c24; background-color: #f8d7da; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .employee-list { background-color: #f1f3f5; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .employee-item { padding: 8px; border-bottom: 1px solid #dee2e6; }
        .employee-item:last-child { border-bottom: none; }
        .department { color: #6c757d; font-size: 0.9em; }
        .summary { font-weight: bold; color: #dc3545; margin: 15px 0; }
        .footer { color: #6c757d; font-size: 0.9em; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th { background-color: #f8f9fa; text-align: left; padding: 10px; }
        td { padding: 8px; border-top: 1px solid #dee2e6; }
        .action-needed { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Missing Shift Assignments Alert</h2>
        </div>
        
        <div class="content">
            <div class="alert">
                <strong>Action Required:</strong> {{ count }} employee(s) currently have no active shift assignment.
            </div>
            
            <p>The following employees require shift assignments:</p>
            
            <div class="employee-list">
                <table>
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Department</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for employee in employees %}
                        <tr class="employee-item">
                            <td>
                                <strong>{{ employee.get_full_name }}</strong><br>
                                <small>{{ employee.employee_number }}</small>
                            </td>
                            <td class="department">
                                {{ employee.department.name|default:'No Department' }}
                            </td>
                            <td>
                                <span class="action-needed">No Shift Assigned</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="summary">
                <p>Please assign appropriate shifts to these employees to ensure proper attendance tracking.</p>
            </div>
            
            <p>Quick actions:</p>
            <ul>
                <li>Review each employee's work schedule requirements</li>
                <li>Assign appropriate shifts based on department needs</li>
                <li>Ensure shift assignments are properly documented</li>
                <li>Update HR records accordingly</li>
            </ul>
            
            <p>To assign shifts, please visit the <a href="{{ site_url }}{% url 'attendance:shift_assignment_create' %}">Shift Assignment</a> page.</p>
        </div>
        
        <div class="footer">
            <p>This is an automated system notification.</p>
            <p>Generated on {{ today|date:"l, F d, Y" }} at {{ today|time:"g:i A" }}</p>
            <hr>
            <p>Human Resources Management System<br>
            Attendance Management Module</p>
        </div>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\email\monthly_attendance_summary.html
```<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            padding: 20px;
        }
        .header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 3px solid #28a745;
            margin-bottom: 20px;
        }
        .content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .summary-box {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin: 15px 0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .summary-item {
            padding: 15px;
            text-align: center;
            min-width: 120px;
        }
        .summary-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .summary-label {
            font-size: 14px;
            color: #666;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 15px 0;
        }
        .stats-card {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
        }
        .stats-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .detail-table th,
        .detail-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .detail-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .detail-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .chart-container {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        .chart-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        .attendance-pattern {
            display: flex;
            gap: 2px;
            margin: 15px 0;
        }
        .pattern-day {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .present { background-color: #28a745; }
        .absent { background-color: #dc3545; }
        .late { background-color: #ffc107; }
        .leave { background-color: #17a2b8; }
        .weekend { background-color: #6c757d; }
        .holiday { background-color: #6610f2; }
        .footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #666;
        }
        .trend-indicator {
            display: inline-block;
            margin-left: 5px;
        }
        .trend-up { color: #28a745; }
        .trend-down { color: #dc3545; }
        .trend-neutral { color: #6c757d; }
        .highlight-box {
            background-color: #e8f4ff;
            border: 1px solid #b8daff;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>Monthly Attendance Summary</h2>
        <p>{{ month_name }} {{ year }}</p>
    </div>

    <div class="content">
        <p>Dear {{ employee.get_full_name }},</p>

        <p>Here's your attendance summary for {{ month_name }} {{ year }}:</p>

        <div class="summary-box">
            <div class="summary-item">
                <div class="summary-number">{{ total_working_days }}</div>
                <div class="summary-label">Working Days</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">{{ present_days }}</div>
                <div class="summary-label">Present Days</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">{{ late_days }}</div>
                <div class="summary-label">Late Arrivals</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">{{ absent_days }}</div>
                <div class="summary-label">Absent Days</div>
            </div>
            <div class="summary-item">
                <div class="summary-number">{{ leave_days }}</div>
                <div class="summary-label">Leave Days</div>
            </div>
        </div>

        <div class="highlight-box">
            <h4>Monthly Highlights</h4>
            <ul>
                <li>Attendance Rate: {{ attendance_rate }}%
                    <span class="trend-indicator {{ attendance_trend_class }}">
                        {{ attendance_trend_icon }} {{ attendance_trend }}%
                    </span>
                </li>
                <li>Average Arrival Time: {{ avg_arrival_time }}
                    <span class="trend-indicator {{ arrival_trend_class }}">
                        {{ arrival_trend_icon }}
                    </span>
                </li>
                <li>Total Working Hours: {{ total_working_hours }} hours</li>
                {% if overtime_hours %}
                <li>Overtime Hours: {{ overtime_hours }} hours</li>
                {% endif %}
            </ul>
        </div>

        <div class="stats-grid">
            <div class="stats-card">
                <div class="stats-title">Arrival Time Distribution</div>
                <table class="detail-table">
                    <tr>
                        <td>On Time (Before {{ regular_time }})</td>
                        <td>{{ ontime_count }} days</td>
                    </tr>
                    <tr>
                        <td>Late ({{ grace_period }} grace period)</td>
                        <td>{{ late_within_grace }} days</td>
                    </tr>
                    <tr>
                        <td>Late (After grace period)</td>
                        <td>{{ late_after_grace }} days</td>
                    </tr>
                </table>
            </div>

            <div class="stats-card">
                <div class="stats-title">Leave Summary</div>
                <table class="detail-table">
                    {% for leave in leave_summary %}
                    <tr>
                        <td>{{ leave.type }}</td>
                        <td>{{ leave.days }} days</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">Monthly Attendance Pattern</div>
            <div class="attendance-pattern">
                {% for day in attendance_pattern %}
                <div class="pattern-day {{ day.status }}" title="{{ day.date|date:'D, M d' }}: {{ day.status|title }}"></div>
                {% endfor %}
            </div>
            <div style="margin-top: 10px;">
                <small>
                    <span class="pattern-day present" style="display: inline-block;"></span> Present
                    <span class="pattern-day absent" style="display: inline-block; margin-left: 10px;"></span> Absent
                    <span class="pattern-day late" style="display: inline-block; margin-left: 10px;"></span> Late
                    <span class="pattern-day leave" style="display: inline-block; margin-left: 10px;"></span> Leave
                    <span class="pattern-day weekend" style="display: inline-block; margin-left: 10px;"></span> Weekend
                    <span class="pattern-day holiday" style="display: inline-block; margin-left: 10px;"></span> Holiday
                </small>
            </div>
        </div>

        {% if improvement_areas %}
        <div class="highlight-box">
            <h4>Areas for Improvement</h4>
            <ul>
                {% for area in improvement_areas %}
                <li>{{ area }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if next_month_holidays %}
        <div class="highlight-box">
            <h4>Upcoming Holidays ({{ next_month_name }})</h4>
            <ul>
                {% for holiday in next_month_holidays %}
                <li>{{ holiday.date|date:"F j" }} - {{ holiday.description }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <div class="footer">
        <p>This is an automated monthly summary from the HR Management System.</p>
        <p>Generated on: {{ generated_at|date:"l, F j, Y" }}</p>
        <p>For detailed attendance records, please visit the HR Portal.</p>
        {% if portal_link %}
        <p><a href="{{ portal_link }}">Access HR Portal</a></p>
        {% endif %}
        <p>If you notice any discrepancies, please contact HR within 3 working days.</p>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\email\ramadan_timing_notification.html
```<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; }
        .header { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
        .content { padding: 20px 0; }
        .timing-details { background-color: #f1f3f5; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .ramadan-note { color: #856404; background-color: #fff3cd; padding: 10px; border-radius: 5px; }
        .footer { color: #6c757d; font-size: 0.9em; margin-top: 20px; }
        .blessing { font-style: italic; color: #28a745; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>{% if is_end %}Regular Working Hours Resume{% else %}Ramadan Working Hours{% endif %}</h2>
        </div>
        
        <div class="content">
            <p>Dear {{ employee.get_full_name }},</p>
            
            {% if is_end %}
                <p>This is to inform you that regular working hours will resume after Ramadan ends on 
                   <strong>{{ ramadan_period.end_date|date:"l, F d, Y" }}</strong>.</p>
                
                <div class="timing-details">
                    <h3>Regular Shift Details:</h3>
                    <p><strong>Shift:</strong> {{ shift.name }}</p>
                    <p><strong>Timing:</strong> {{ shift.start_time|time:"g:i A" }} - {{ shift.end_time|time:"g:i A" }}</p>
                    {% if shift.break_duration %}
                        <p><strong>Break Duration:</strong> {{ shift.break_duration }} minutes</p>
                    {% endif %}
                </div>
                
                <p class="blessing">Thank you for your dedication during the blessed month of Ramadan.</p>
            {% else %}
                <p>In observance of the holy month of Ramadan, your working hours will be adjusted from 
                   <strong>{{ ramadan_period.start_date|date:"l, F d, Y" }}</strong>.</p>
                
                <div class="timing-details">
                    <h3>Adjusted Ramadan Timing:</h3>
                    <p><strong>Shift:</strong> {{ shift.name }}</p>
                    <p><strong>Timing:</strong> {{ adjusted_timing.start_time|time:"g:i A" }} - {{ adjusted_timing.end_time|time:"g:i A" }}</p>
                    {% if shift.break_duration %}
                        <p><strong>Break Duration:</strong> {{ shift.break_duration }} minutes</p>
                    {% endif %}
                </div>
                
                <div class="ramadan-note">
                    <p><strong>Note:</strong> These adjusted hours will be in effect throughout Ramadan 
                       ({{ ramadan_period.start_date|date:"M d" }} - {{ ramadan_period.end_date|date:"M d, Y" }}).</p>
                </div>
                
                <p class="blessing">Ramadan Kareem! رمضان كريم</p>
            {% endif %}
            
            <p>If you have any questions about your working hours, please contact HR.</p>
        </div>
        
        <div class="footer">
            <p>This is an automated message. Please do not reply to this email.</p>
            <p>Human Resources Department</p>
        </div>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\email\shift_change_notification.html
```<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; }
        .header { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
        .content { padding: 20px 0; }
        .shift-details { background-color: #f1f3f5; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .footer { color: #6c757d; font-size: 0.9em; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Shift Change Notification</h2>
        </div>
        <div class="content">
            <p>Dear {{ employee.get_full_name }},</p>
            
            <p>This is to inform you that your work shift will change effective from <strong>{{ start_date|date:"l, F d, Y" }}</strong>.</p>
            
            <div class="shift-details">
                <h3>Shift Details:</h3>
                <p><strong>Current Shift:</strong> {{ old_shift.name }}<br>
                   Timing: {{ old_shift.start_time|time:"g:i A" }} - {{ old_shift.end_time|time:"g:i A" }}</p>
                
                <p><strong>New Shift:</strong> {{ new_shift.name }}<br>
                   Timing: {{ new_shift.start_time|time:"g:i A" }} - {{ new_shift.end_time|time:"g:i A" }}</p>
                
                {% if new_shift.grace_period %}
                <p><em>Note: Grace period of {{ new_shift.grace_period }} minutes applies.</em></p>
                {% endif %}
            </div>
            
            <p>Please ensure you adjust your schedule accordingly. If you have any questions, please contact HR.</p>
        </div>
        <div class="footer">
            <p>This is an automated message. Please do not reply to this email.</p>
            <p>Human Resources Department</p>
        </div>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\holiday_form.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">{% if form.instance.pk %}Edit Holiday{% else %}Add Holiday{% endif %}</h5>
    </div>
    <div class="card-body">
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                {{ error }}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Holiday Name -->
            <div class="mb-3">
                <label for="name" class="form-label">Holiday Name *</label>
                <input type="text" 
                       class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                       id="name" 
                       name="name"
                       value="{{ form.name.value|default:'' }}"
                       required>
                {% if form.name.errors %}
                <div class="invalid-feedback">
                    {{ form.name.errors|join:", " }}
                </div>
                {% endif %}
            </div>

            <!-- Holiday Date -->
            <div class="mb-3">
                <label for="date" class="form-label">Date *</label>
                <input type="date" 
                       class="form-control {% if form.date.errors %}is-invalid{% endif %}" 
                       id="date" 
                       name="date"
                       value="{{ form.date.value|date:'Y-m-d'|default:'' }}"
                       required>
                {% if form.date.errors %}
                <div class="invalid-feedback">
                    {{ form.date.errors|join:", " }}
                </div>
                {% endif %}
                <div id="friday-notice" class="text-muted small mt-1" style="display: none;">
                    <i class="fas fa-info-circle"></i> This is a Friday
                </div>
            </div>

            <!-- Holiday Type -->
            <div class="mb-3">
                <label for="holiday_type" class="form-label">Holiday Type *</label>
                <select class="form-select {% if form.holiday_type.errors %}is-invalid{% endif %}" 
                        id="holiday_type" 
                        name="holiday_type"
                        required>
                    <option value="">Select Type</option>
                    <option value="PUBLIC" {% if form.holiday_type.value == 'PUBLIC' %}selected{% endif %}>Public Holiday</option>
                    <option value="COMPANY" {% if form.holiday_type.value == 'COMPANY' %}selected{% endif %}>Company Holiday</option>
                    <option value="OPTIONAL" {% if form.holiday_type.value == 'OPTIONAL' %}selected{% endif %}>Optional Holiday</option>
                </select>
                {% if form.holiday_type.errors %}
                <div class="invalid-feedback">
                    {{ form.holiday_type.errors|join:", " }}
                </div>
                {% endif %}
            </div>

            <!-- Description -->
            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control {% if form.description.errors %}is-invalid{% endif %}" 
                          id="description" 
                          name="description" 
                          rows="3">{{ form.description.value|default:'' }}</textarea>
                {% if form.description.errors %}
                <div class="invalid-feedback">
                    {{ form.description.errors|join:", " }}
                </div>
                {% endif %}
            </div>

            <!-- Holiday Options -->
            <div class="mb-3">
                <div class="form-check">
                    <input type="checkbox" 
                           class="form-check-input" 
                           id="is_recurring" 
                           name="is_recurring"
                           {% if form.is_recurring.value %}checked{% endif %}>
                    <label class="form-check-label" for="is_recurring">
                        Recurring Holiday (repeats yearly)
                    </label>
                </div>
                <div class="form-check">
                    <input type="checkbox" 
                           class="form-check-input" 
                           id="is_paid" 
                           name="is_paid"
                           {% if form.is_paid.value %}checked{% endif %}>
                    <label class="form-check-label" for="is_paid">
                        Paid Holiday
                    </label>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    {% if form.instance.pk %}Update{% else %}Create{% endif %} Holiday
                </button>
                <a href="{% url 'attendance:holiday_list' %}" class="btn btn-secondary">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Show notice when date is Friday
    $('#date').change(function() {
        const date = new Date($(this).val());
        if (date.getDay() === 5) { // 5 is Friday (0 is Sunday)
            $('#friday-notice').show();
        } else {
            $('#friday-notice').hide();
        }
    });

    // Form validation
    (function() {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();

    // If editing, check Friday on page load
    if ($('#date').val()) {
        const date = new Date($('#date').val());
        if (date.getDay() === 5) {
            $('#friday-notice').show();
        }
    }
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\holiday_list.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-star"></i> Holidays
        </h5>
        <a href="{% url 'attendance:holiday_create' %}" class="btn btn-primary btn-sm">
            <i class="fas fa-plus"></i> Add Holiday
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Recurring</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for holiday in holidays %}
                    <tr>
                        <td>{{ holiday.name }}</td>
                        <td>{{ holiday.date|date:"d M Y" }}</td>
                        <td>{{ holiday.get_holiday_type_display }}</td>
                        <td>{{ holiday.description|truncatechars:50 }}</td>
                        <td>
                            {% if holiday.is_recurring %}
                            <span class="badge bg-success">Yes</span>
                            {% else %}
                            <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'attendance:holiday_edit' pk=holiday.id %}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ holiday.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <!-- Delete Modal -->
                            <div class="modal fade" id="deleteModal{{ holiday.id }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Confirm Delete</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete the holiday "{{ holiday.name }}"?</p>
                                            <p class="text-danger">This action cannot be undone.</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <form action="{% url 'attendance:holiday_delete' pk=holiday.id %}" method="post" style="display: inline;">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger">Delete</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No holidays found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
```

### 📄 hrms_project\attendance\templates\attendance\leave_balance.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
{% if user.is_staff %}
<!-- Employee Selection Form -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-user"></i> Select Employee
        </h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="department" name="department">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>
                        {{ dept.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search Employee</label>
                <input type="text" class="form-control" name="search" placeholder="Name or Employee Number" value="{{ request.GET.search }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Employee</label>
                <select class="form-select" id="employee" name="employee">
                    <option value="">Select Employee</option>
                    {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if selected_employee == emp.id|stringformat:"s" %}selected{% endif %}>
                        {{ emp.employee_number }} - {{ emp.get_full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-balance-scale"></i> Leave Balances
        </h5>
    </div>
    <div class="card-body">
        {% if user.is_staff %}
        <div class="mb-4">
            <h6 class="mb-3">Import Beginning Balances</h6>
            <form method="post" enctype="multipart/form-data" class="row g-3">
                {% csrf_token %}
                <div class="col-md-4">
                    {{ form.csv_file.label_tag }}
                    {{ form.csv_file }}
                    <small class="text-muted">{{ form.csv_file.help_text }}</small>
                </div>
                <div class="col-md-4">
                    {{ form.as_of_date.label_tag }}
                    {{ form.as_of_date }}
                    <small class="text-muted">{{ form.as_of_date.help_text }}</small>
                </div>
                {{ form.leave_type_code }}
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
        {% endif %}

        {% if beginning_balances %}
        <div class="mb-4">
            <h6 class="mb-3">Beginning Balances</h6>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            {% if user.is_staff %}
                            <th>Employee</th>
                            {% endif %}
                            <th>Leave Type</th>
                            <th>Balance Days</th>
                            <th>As of Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for balance in beginning_balances %}
                        <tr>
                            {% if user.is_staff %}
                            <td>{{ balance.employee.get_full_name }}</td>
                            {% endif %}
                            <td>{{ balance.leave_type.name }}</td>
                            <td>{{ balance.balance_days }}</td>
                            <td>{{ balance.as_of_date }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        <div class="row">
            {% for balance in balances %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">{{ balance.leave_type.name }}</h6>
                        <div class="progress mb-3" style="height: 20px;">
                            {% if balance.total_days > 0 %}
                                {% widthratio balance.used_days balance.total_days 100 as used_percentage %}
                                {% widthratio balance.pending_days balance.total_days 100 as pending_percentage %}
                                {% with total_percentage=used_percentage|add:pending_percentage %}
                                <div class="progress-bar {% if total_percentage > 75 %}bg-danger{% elif total_percentage > 50 %}bg-warning{% else %}bg-success{% endif %}"
                                     role="progressbar"
                                     style="width: {{ used_percentage }}%"
                                     aria-valuenow="{{ used_percentage }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {{ used_percentage }}%
                                </div>
                                {% if balance.pending_days > 0 %}
                                <div class="progress-bar bg-secondary"
                                     role="progressbar"
                                     style="width: {{ pending_percentage }}%"
                                     aria-valuenow="{{ pending_percentage }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {{ pending_percentage }}%
                                </div>
                                {% endif %}
                                {% endwith %}
                            {% else %}
                                <div class="progress-bar bg-success"
                                     role="progressbar"
                                     style="width: 0%"
                                     aria-valuenow="0"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    0%
                                </div>
                            {% endif %}
                        </div>
                        <div class="row text-center">
                            <div class="col">
                                <small class="text-muted d-block">Total</small>
                                <strong>{{ balance.total_days|floatformat:2 }}</strong>
                            </div>
                            <div class="col">
                                <small class="text-muted d-block">Used</small>
                                <strong>{{ balance.used_days|floatformat:2 }}</strong>
                            </div>
                            <div class="col">
                                <small class="text-muted d-block">Pending</small>
                                <strong>{{ balance.pending_days|floatformat:2 }}</strong>
                            </div>
                            <div class="col">
                                <small class="text-muted d-block">Available</small>
                                <strong>{{ balance.available_days|floatformat:2 }}</strong>
                            </div>
                        </div>
                        {% if balance.leave_type.description %}
                        <div class="mt-3">
                            <small class="text-muted">{{ balance.leave_type.description }}</small>
                        </div>
                        {% elif balance.leave_type.code == 'ANNUAL' %}
                        <div class="mt-3">
                            <small class="text-muted">Annual leave accrued at 2.5 days per 30 working days (0.083 days per working day)</small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-grid">
                            <a href="{% url 'attendance:leave_request_create' %}?type={{ balance.leave_type.id }}" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-plus"></i> Apply for {{ balance.leave_type.name }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="alert alert-info">
                    No leave balances found.
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\leave_detail.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Leave Request Details</h5>
        <div>
            {% if leave.status == 'pending' %}
                {% if leave.employee == user.employee %}
                <button class="btn btn-danger cancel-leave">
                    <i class="fas fa-times"></i> Cancel Request
                </button>
                {% elif perms.attendance.can_approve_leave %}
                <button class="btn btn-success approve-leave">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button class="btn btn-danger reject-leave">
                    <i class="fas fa-times"></i> Reject
                </button>
                {% endif %}
            {% endif %}
            <a href="{% url 'attendance:leave_request_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Leave Request Details -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">Leave Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Employee:</strong>
                            </div>
                            <div class="col-md-8">
                                {{ leave.employee.get_full_name }}
                                <br>
                                <small class="text-muted">{{ leave.employee.department.name }}</small>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Leave Type:</strong>
                            </div>
                            <div class="col-md-8">
                                {{ leave.leave_type.name }}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Duration:</strong>
                            </div>
                            <div class="col-md-8">
                                {{ leave.duration }} days
                                <br>
                                <small class="text-muted">
                                    From: {{ leave.start_date|date:"M d, Y" }}
                                    {% if leave.start_half %} (Half Day){% endif %}
                                    <br>
                                    To: {{ leave.end_date|date:"M d, Y" }}
                                    {% if leave.end_half %} (Half Day){% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Status:</strong>
                            </div>
                            <div class="col-md-8">
                                {% if leave.status == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                                {% elif leave.status == 'approved' %}
                                <span class="badge bg-success">Approved</span>
                                {% elif leave.status == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                                {% else %}
                                <span class="badge bg-secondary">Cancelled</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Reason:</strong>
                            </div>
                            <div class="col-md-8">
                                {{ leave.reason }}
                            </div>
                        </div>
                        
                        {% if leave.rejection_reason %}
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Rejection Reason:</strong>
                            </div>
                            <div class="col-md-8 text-danger">
                                {{ leave.rejection_reason }}
                            </div>
                        </div>
                        {% endif %}

                        {% if leave.cancellation_reason %}
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <strong>Cancellation Reason:</strong>
                            </div>
                            <div class="col-md-8">
                                {{ leave.cancellation_reason }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Supporting Documents -->
                {% if leave.documents.all %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">Supporting Documents</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            {% for doc in leave.documents.all %}
                            <a href="{{ doc.document.url }}" class="list-group-item list-group-item-action" target="_blank">
                                <i class="fas fa-file-{{ doc.document.name|slice:'-3:' }}"></i>
                                {{ doc.document.name|split:'/'|last }}
                                <span class="float-end text-muted">
                                    <small>{{ doc.uploaded_at|date:"M d, Y H:i" }}</small>
                                </span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Activity Timeline -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Activity Timeline</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="timeline">
                            {% for activity in leave.activities.all %}
                            <div class="timeline-item">
                                <div class="timeline-marker 
                                    {% if activity.action == 'create' %}bg-primary
                                    {% elif activity.action == 'approve' %}bg-success
                                    {% elif activity.action == 'reject' %}bg-danger
                                    {% elif activity.action == 'cancel' %}bg-secondary
                                    {% else %}bg-info{% endif %}">
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-heading">
                                        <strong>{{ activity.get_action_display }}</strong>
                                        <small class="float-end text-muted">
                                            {{ activity.created_at|date:"M d, Y H:i" }}
                                        </small>
                                    </div>
                                    <div class="timeline-body">
                                        {% if activity.actor %}
                                        <small>By: {{ activity.actor.get_full_name }}</small><br>
                                        {% endif %}
                                        {{ activity.details }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Modals -->
<!-- Cancel Leave Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Leave Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cancelForm">
                    <div class="mb-3">
                        <label for="cancellation_reason" class="form-label">Reason for Cancellation</label>
                        <textarea class="form-control" id="cancellation_reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="confirmCancel">Cancel Leave</button>
            </div>
        </div>
    </div>
</div>

<!-- Approve Leave Modal -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approve Leave Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="approveForm">
                    <div class="mb-3">
                        <label for="approval_remarks" class="form-label">Remarks (Optional)</label>
                        <textarea class="form-control" id="approval_remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="confirmApprove">Approve</button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Leave Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Leave Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rejectForm">
                    <div class="mb-3">
                        <label for="rejection_reason" class="form-label">Reason for Rejection</label>
                        <textarea class="form-control" id="rejection_reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="confirmReject">Reject</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
.timeline {
    position: relative;
    padding: 1rem;
}

.timeline-item {
    position: relative;
    padding-left: 2rem;
    margin-bottom: 1.5rem;
}

.timeline-marker {
    position: absolute;
    left: 0;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    margin-top: 0.25rem;
}

.timeline-content {
    position: relative;
    background: #f8f9fa;
    border-radius: 0.25rem;
    padding: 0.75rem;
}

.timeline-heading {
    margin-bottom: 0.5rem;
}

.timeline-body {
    font-size: 0.875rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 7px;
    height: 100%;
    width: 1px;
    background-color: #dee2e6;
}

.timeline-item:last-child::before {
    display: none;
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Cancel leave request
    $('.cancel-leave').click(function() {
        $('#cancelModal').modal('show');
    });

    $('#confirmCancel').click(function() {
        const reason = $('#cancellation_reason').val();
        if (!reason) {
            alert('Please provide a reason for cancellation');
            return;
        }

        $.ajax({
            url: '{% url "attendance:leave_request_cancel" pk=leave.id %}',
            type: 'POST',
            data: { reason: reason },
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function() {
                window.location.reload();
            },
            error: function(xhr) {
                alert('Error cancelling leave request');
            }
        });
        $('#cancelModal').modal('hide');
    });

    // Approve leave request
    $('.approve-leave').click(function() {
        $('#approveModal').modal('show');
    });

    $('#confirmApprove').click(function() {
        const remarks = $('#approval_remarks').val();
        $.ajax({
            url: '{% url "attendance:leave_request_approve" pk=leave.id %}',
            type: 'POST',
            data: { remarks: remarks },
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function() {
                window.location.reload();
            },
            error: function(xhr) {
                alert('Error approving leave request');
            }
        });
        $('#approveModal').modal('hide');
    });

    // Reject leave request
    $('.reject-leave').click(function() {
        $('#rejectModal').modal('show');
    });

    $('#confirmReject').click(function() {
        const reason = $('#rejection_reason').val();
        if (!reason) {
            alert('Please provide a reason for rejection');
            return;
        }

        $.ajax({
            url: '{% url "attendance:leave_request_reject" pk=leave.id %}',
            type: 'POST',
            data: { reason: reason },
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function() {
                window.location.reload();
            },
            error: function(xhr) {
                alert('Error rejecting leave request');
            }
        });
        $('#rejectModal').modal('hide');
    });
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\leave_form.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Apply for Leave</h5>
    </div>
    <div class="card-body">
        <!-- Leave Balance Summary -->
        <div class="card bg-light mb-4">
            <div class="card-body">
                <h6 class="card-title">Your Leave Balances</h6>
                <div class="row">
                    {% for balance in leave_balances %}
                    <div class="col-md-3 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>{{ balance.leave_type.name }}:</span>
                            <strong>{{ balance.available_days }} days</strong>
                        </div>
                        {% if balance.pending_days > 0 %}
                        <small class="text-muted">
                            ({{ balance.pending_days }} days pending approval)
                        </small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                {{ error }}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Leave Type Selection -->
            <div class="mb-3">
                <label for="leave_type" class="form-label">Leave Type *</label>
                <select class="form-select {% if form.leave_type.errors %}is-invalid{% endif %}" 
                        id="leave_type" 
                        name="leave_type"
                        required>
                    <option value="">Select Leave Type</option>
                    {% for type in leave_types %}
                    <option value="{{ type.id }}" 
                            data-requires-document="{{ type.requires_document|yesno:'true,false' }}"
                            data-balance="{{ type.balance }}"
                            data-gender-specific="{{ type.gender_specific }}"
                            {% if type.id == form.leave_type.value|stringformat:'i' %}selected{% endif %}>
                        {{ type.name }}
                        {% if type.balance %}({{ type.balance }} days available){% endif %}
                    </option>
                    {% endfor %}
                </select>
                {% if form.leave_type.errors %}
                <div class="invalid-feedback">
                    {{ form.leave_type.errors|join:", " }}
                </div>
                {% endif %}
                <div id="leave-type-info" class="form-text mt-1"></div>
            </div>

            <!-- Date Range -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="start_date" class="form-label">Start Date *</label>
                    <input type="date" 
                           class="form-control {% if form.start_date.errors %}is-invalid{% endif %}" 
                           id="start_date" 
                           name="start_date"
                           value="{{ form.start_date.value|date:'Y-m-d'|default:'' }}"
                           required>
                    {% if form.start_date.errors %}
                    <div class="invalid-feedback">
                        {{ form.start_date.errors|join:", " }}
                    </div>
                    {% endif %}
                    <div class="form-check mt-2">
                        <input type="checkbox" 
                               class="form-check-input" 
                               id="start_half" 
                               name="start_half"
                               {% if form.start_half.value %}checked{% endif %}>
                        <label class="form-check-label" for="start_half">
                            Half Day (Morning)
                        </label>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="end_date" class="form-label">End Date *</label>
                    <input type="date" 
                           class="form-control {% if form.end_date.errors %}is-invalid{% endif %}" 
                           id="end_date" 
                           name="end_date"
                           value="{{ form.end_date.value|date:'Y-m-d'|default:'' }}"
                           required>
                    {% if form.end_date.errors %}
                    <div class="invalid-feedback">
                        {{ form.end_date.errors|join:", " }}
                    </div>
                    {% endif %}
                    <div class="form-check mt-2">
                        <input type="checkbox" 
                               class="form-check-input" 
                               id="end_half" 
                               name="end_half"
                               {% if form.end_half.value %}checked{% endif %}>
                        <label class="form-check-label" for="end_half">
                            Half Day (Afternoon)
                        </label>
                    </div>
                </div>
            </div>

            <!-- Duration Summary -->
            <div class="mb-3">
                <div class="alert alert-info" id="duration-info">
                    Please select dates to see leave duration
                </div>
            </div>

            <!-- Reason -->
            <div class="mb-3">
                <label for="reason" class="form-label">Reason *</label>
                <textarea class="form-control {% if form.reason.errors %}is-invalid{% endif %}" 
                          id="reason" 
                          name="reason" 
                          rows="3"
                          required>{{ form.reason.value|default:'' }}</textarea>
                {% if form.reason.errors %}
                <div class="invalid-feedback">
                    {{ form.reason.errors|join:", " }}
                </div>
                {% endif %}
            </div>

            <!-- Documents -->
            <div id="document-section" class="mb-3" style="display: none;">
                <label class="form-label">Supporting Documents</label>
                <div class="input-group">
                    <input type="file" 
                           class="form-control {% if form.documents.errors %}is-invalid{% endif %}" 
                           id="documents" 
                           name="documents"
                           multiple
                           accept=".pdf,.jpg,.jpeg,.png">
                    <label class="input-group-text" for="documents">Upload</label>
                </div>
                {% if form.documents.errors %}
                <div class="invalid-feedback d-block">
                    {{ form.documents.errors|join:", " }}
                </div>
                {% endif %}
                <div class="form-text">
                    Supported formats: PDF, JPG, PNG. Maximum file size: 5MB
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary" id="submit-btn">Submit Leave Request</button>
                <a href="{% url 'attendance:leave_request_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Handle leave type change
    $('#leave_type').change(function() {
        const selected = $(this).find('option:selected');
        const requiresDocument = selected.data('requires-document');
        const genderSpecific = selected.data('gender-specific');
        const balance = selected.data('balance');
        
        // Show/hide document section
        if (requiresDocument) {
            $('#document-section').slideDown();
            $('#documents').prop('required', true);
        } else {
            $('#document-section').slideUp();
            $('#documents').prop('required', false);
        }
        
        // Update info text
        let infoText = [];
        if (balance !== undefined) {
            infoText.push(`Available balance: ${balance} days`);
        }
        if (requiresDocument) {
            infoText.push('Supporting documents required');
        }
        if (genderSpecific && genderSpecific !== 'A') {
            infoText.push(`Only available for ${genderSpecific === 'M' ? 'male' : 'female'} employees`);
        }
        
        $('#leave-type-info').html(infoText.join(' • '));
    });

    // Calculate duration
    function calculateDuration() {
        const startDate = $('#start_date').val();
        const endDate = $('#end_date').val();
        const startHalf = $('#start_half').prop('checked');
        const endHalf = $('#end_half').prop('checked');
        
        if (startDate && endDate) {
            $.ajax({
                url: '{% url "attendance:calculate_leave_duration" %}',
                data: {
                    start_date: startDate,
                    end_date: endDate,
                    start_half: startHalf,
                    end_half: endHalf
                },
                success: function(response) {
                    $('#duration-info').html(
                        `Leave duration: ${response.days} day${response.days !== 1 ? 's' : ''}<br>` +
                        `Working days: ${response.working_days} day${response.working_days !== 1 ? 's' : ''}`
                    );
                }
            });
        }
    }

    $('#start_date, #end_date, #start_half, #end_half').on('change', calculateDuration);

    // Validate end date not before start date
    $('#end_date').change(function() {
        const startDate = new Date($('#start_date').val());
        const endDate = new Date($(this).val());
        
        if (endDate < startDate) {
            alert('End date cannot be before start date');
            $(this).val($('#start_date').val());
        }
    });

    // Form validation
    (function() {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();

    // Initialize leave type info if type is pre-selected
    $('#leave_type').trigger('change');
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\leave_list.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Leave Requests</h5>
        <div>
            <a href="{% url 'attendance:leave_request_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Apply for Leave
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="status-filter">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Leave Type</label>
                <select class="form-select" id="type-filter">
                    <option value="">All Types</option>
                    {% for type in leave_types %}
                    <option value="{{ type.code }}">{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="department-filter">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary" id="apply-filters">Apply Filters</button>
            </div>
        </div>

        <!-- Leave Balance Summary -->
        {% if user_leave_balances %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Your Leave Balances</h6>
                        <div class="row">
                            {% for balance in user_leave_balances %}
                            <div class="col-md-3 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>{{ balance.leave_type.name }}:</span>
                                    <strong>{{ balance.available_days }} days</strong>
                                </div>
                                {% if balance.pending_days > 0 %}
                                <small class="text-muted">
                                    ({{ balance.pending_days }} days pending approval)
                                </small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Leave Requests Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Leave Type</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in leaves %}
                    <tr>
                        <td>
                            {{ leave.employee.get_full_name }}
                            <br>
                            <small class="text-muted">{{ leave.employee.department.name }}</small>
                        </td>
                        <td>
                            {{ leave.leave_type.name }}
                            {% if leave.start_half or leave.end_half %}
                            <br>
                            <small class="text-muted">
                                {% if leave.start_half %}Start: Half Day{% endif %}
                                {% if leave.end_half %}End: Half Day{% endif %}
                            </small>
                            {% endif %}
                        </td>
                        <td>
                            {{ leave.duration }} days
                            <br>
                            <small class="text-muted">
                                {{ leave.start_date|date:"M d, Y" }} - {{ leave.end_date|date:"M d, Y" }}
                            </small>
                        </td>
                        <td>
                            {% if leave.status == 'pending' %}
                            <span class="badge bg-warning">Pending</span>
                            {% elif leave.status == 'approved' %}
                            <span class="badge bg-success">Approved</span>
                            {% elif leave.status == 'rejected' %}
                            <span class="badge bg-danger">Rejected</span>
                            {% else %}
                            <span class="badge bg-secondary">Cancelled</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ leave.created_at|date:"M d, Y" }}
                            <br>
                            <small class="text-muted">{{ leave.created_at|time:"H:i" }}</small>
                        </td>
                        <td>
                            <a href="{% url 'attendance:leave_request_detail' pk=leave.id %}" 
                               class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if leave.status == 'pending' and leave.employee == user.employee %}
                            <button class="btn btn-sm btn-danger cancel-leave" data-id="{{ leave.id }}">
                                <i class="fas fa-times"></i>
                            </button>
                            {% endif %}
                            {% if perms.attendance.can_approve_leave and leave.status == 'pending' %}
                            <button class="btn btn-sm btn-success approve-leave" data-id="{{ leave.id }}">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger reject-leave" data-id="{{ leave.id }}">
                                <i class="fas fa-times"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No leave requests found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1">&laquo; First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Action Modals -->
<!-- Cancel Leave Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Leave Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cancelForm">
                    <div class="mb-3">
                        <label for="cancellation_reason" class="form-label">Reason for Cancellation</label>
                        <textarea class="form-control" id="cancellation_reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="confirmCancel">Cancel Leave</button>
            </div>
        </div>
    </div>
</div>

<!-- Approve Leave Modal -->
<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approve Leave Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="approveForm">
                    <div class="mb-3">
                        <label for="approval_remarks" class="form-label">Remarks (Optional)</label>
                        <textarea class="form-control" id="approval_remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="confirmApprove">Approve</button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Leave Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Leave Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rejectForm">
                    <div class="mb-3">
                        <label for="rejection_reason" class="form-label">Reason for Rejection</label>
                        <textarea class="form-control" id="rejection_reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" id="confirmReject">Reject</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    let currentLeaveId = null;

    // Cancel leave request
    $('.cancel-leave').click(function() {
        currentLeaveId = $(this).data('id');
        $('#cancelModal').modal('show');
    });

    $('#confirmCancel').click(function() {
        const reason = $('#cancellation_reason').val();
        if (!reason) {
            alert('Please provide a reason for cancellation');
            return;
        }

        $.ajax({
            url: `/attendance/leave/${currentLeaveId}/cancel/`,
            type: 'POST',
            data: { reason: reason },
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function() {
                location.reload();
            },
            error: function(xhr) {
                alert('Error cancelling leave request');
            }
        });
        $('#cancelModal').modal('hide');
    });

    // Approve leave request
    $('.approve-leave').click(function() {
        currentLeaveId = $(this).data('id');
        $('#approveModal').modal('show');
    });

    $('#confirmApprove').click(function() {
        const remarks = $('#approval_remarks').val();
        $.ajax({
            url: `/attendance/leave/${currentLeaveId}/approve/`,
            type: 'POST',
            data: { remarks: remarks },
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function() {
                location.reload();
            },
            error: function(xhr) {
                alert('Error approving leave request');
            }
        });
        $('#approveModal').modal('hide');
    });

    // Reject leave request
    $('.reject-leave').click(function() {
        currentLeaveId = $(this).data('id');
        $('#rejectModal').modal('show');
    });

    $('#confirmReject').click(function() {
        const reason = $('#rejection_reason').val();
        if (!reason) {
            alert('Please provide a reason for rejection');
            return;
        }

        $.ajax({
            url: `/attendance/leave/${currentLeaveId}/reject/`,
            type: 'POST',
            data: { reason: reason },
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function() {
                location.reload();
            },
            error: function(xhr) {
                alert('Error rejecting leave request');
            }
        });
        $('#rejectModal').modal('hide');
    });

    // Apply filters
    $('#apply-filters').click(function() {
        const status = $('#status-filter').val();
        const type = $('#type-filter').val();
        const department = $('#department-filter').val();
        
        window.location.href = `?status=${status}&type=${type}&department=${department}`;
    });
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\leave_request_detail.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
<!-- Custom badge styles -->
<style>
    .badge.bg-pending {
        background-color: #ffc107 !important;
        color: #000;
    }
    .badge.bg-approved {
        background-color: #198754 !important;
        color: #fff;
    }
    .badge.bg-rejected {
        background-color: #dc3545 !important;
        color: #fff;
    }
    .badge.bg-cancelled {
        background-color: #6c757d !important;
        color: #fff;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- jQuery first -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Then Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('Detail page loaded');
    
    // Function to show the status modal
    window.showStatusModal = function(leaveId, currentStatus) {
        console.log('showStatusModal called:', { leaveId, currentStatus });
        
        const modal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
        const statusSelect = document.getElementById('newStatus');
        
        // Map current status to action
        const statusToAction = {
            'pending': '',
            'approved': 'approve',
            'rejected': 'reject',
            'cancelled': 'cancel'
        };
        
        // Hide current status from options
        Array.from(statusSelect.options).forEach(option => {
            option.style.display = option.value === statusToAction[currentStatus] ? 'none' : '';
        });
        
        // Clear previous remarks
        document.getElementById('statusRemarks').value = '';
        
        // Store leave ID for use in handleStatusChange
        window.currentLeaveId = leaveId;
        
        // Show modal
        modal.show();
    };

    // Function to handle status change
    async function handleStatusChange() {
        const leaveId = window.currentLeaveId;
        const newStatus = document.getElementById('newStatus').value;
        const remarks = document.getElementById('statusRemarks').value;
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

        try {
            const response = await fetch(`/attendance/api/leaves/${leaveId}/${newStatus}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ remarks })
            });
            
            const data = await response.json();
            if (response.ok) {
                window.location.reload();
            } else {
                alert(data.error || 'Failed to process the request');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while processing your request');
        }
    }
    
    // Bind confirm button click
    const confirmBtn = document.getElementById('confirmStatusChange');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', handleStatusChange);
    }

    // Bind status change button
    const changeStatusBtn = document.querySelector('.change-status');
    if (changeStatusBtn) {
        changeStatusBtn.addEventListener('click', function() {
            const leaveId = this.dataset.id;
            const currentStatus = this.dataset.currentStatus;
            showStatusModal(leaveId, currentStatus);
        });
    }

    // Add delete confirmation modal handler
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    let leaveIdToDelete = null;

    // Delete button click handler
    document.querySelector('.delete-leave')?.addEventListener('click', function() {
        leaveIdToDelete = this.dataset.id;
        deleteModal.show();
    });

    // Confirm delete button handler
    document.getElementById('confirmDeleteBtn')?.addEventListener('click', async function() {
        if (!leaveIdToDelete) return;
        
        try {
            const response = await fetch(`/attendance/api/leaves/${leaveIdToDelete}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
                }
            });
            
            const data = await response.json();
            if (response.ok) {
                window.location.href = "{% url 'attendance:leave_request_list' %}";
            } else {
                alert(data.error || 'Failed to delete the leave request');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the leave request');
        }
    });
});
</script>
{% endblock %}

{% block attendance_content %}
<!-- Add CSRF Token at the top of the content -->
{% csrf_token %}

<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Leave Request Details</h5>
            </div>
            <div class="col-auto">
                {% if leave.status != 'deleted' and perms.attendance.can_approve_leave %}
                <div class="btn-group me-2">
                    <button type="button" 
                            class="btn btn-primary change-status" 
                            data-id="{{ leave.id }}"
                            data-current-status="{{ leave.status }}"
                            title="Change Status">
                        <i class="fas fa-exchange-alt"></i> Change Status
                    </button>
                    <button type="button"
                            class="btn btn-danger delete-leave"
                            data-id="{{ leave.id }}"
                            title="Delete Leave">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
                {% endif %}
                <a href="{% url 'attendance:leave_request_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Employee Information -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Employee Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Employee ID:</div>
                            <div class="col-sm-8">{{ leave.employee.employee_number }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Name:</div>
                            <div class="col-sm-8">{{ leave.employee.get_full_name }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Department:</div>
                            <div class="col-sm-8">{{ leave.employee.department.name }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Position:</div>
                            <div class="col-sm-8">{{ leave.employee.designation }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leave Balance -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Leave Balance</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-sm-4">
                                <div class="border rounded p-2 text-center">
                                    <small class="text-muted d-block">Annual Leave</small>
                                    <strong class="d-block" id="annual-balance">{{ balance.annual.remaining }}</strong>
                                    <small class="text-muted">remaining</small>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="border rounded p-2 text-center">
                                    <small class="text-muted d-block">Sick Leave</small>
                                    <strong class="d-block" id="sick-balance">{{ balance.sick.remaining }}</strong>
                                    <small class="text-muted">remaining</small>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="border rounded p-2 text-center">
                                    <small class="text-muted d-block">Permission</small>
                                    <strong class="d-block" id="permission-balance">{{ balance.permission.remaining }}</strong>
                                    <small class="text-muted">hours</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leave Request Details -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Leave Details</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Leave Type:</div>
                            <div class="col-sm-8">
                                <span class="badge bg-info">{{ leave.get_leave_type_display }}</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Duration:</div>
                            <div class="col-sm-8">{{ leave.start_date|date:"M d, Y" }} - {{ leave.end_date|date:"M d, Y" }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Total Days:</div>
                            <div class="col-sm-8">{{ leave.duration }} days</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Status:</div>
                            <div class="col-sm-8">
                                <span class="badge bg-{{ leave.status|lower }}">
                                    {{ leave.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Submitted On:</div>
                            <div class="col-sm-8">{{ leave.created_at|date:"M d, Y H:i" }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Last Updated:</div>
                            <div class="col-sm-8">{{ leave.updated_at|date:"M d, Y H:i" }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Approved By:</div>
                            <div class="col-sm-8">
                                {% if leave.approved_by %}
                                    {{ leave.approved_by.get_full_name }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {% if leave.remarks %}
                <div class="mt-3">
                    <h6 class="text-muted">Remarks</h6>
                    <p class="mb-0">{{ leave.remarks }}</p>
                </div>
                {% endif %}

                {% if leave.attachment %}
                <div class="mt-3">
                    <h6 class="text-muted">Attachment</h6>
                    <a href="{{ leave.attachment.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                        <i class="fas fa-paperclip"></i> View Attachment
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Similar Leaves History -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Similar Leaves History</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Duration</th>
                                <th>Days</th>
                                <th>Sub Type</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for similar_leave in similar_leaves %}
                            <tr {% if similar_leave.id == leave.id %}class="table-primary"{% endif %}>
                                <td>{{ similar_leave.start_date|date:"M d, Y" }} - {{ similar_leave.end_date|date:"M d, Y" }}</td>
                                <td>{{ similar_leave.duration }}</td>
                                <td>{{ similar_leave.leave_sub_type|default:"-" }}</td>
                                <td>
                                    <span class="badge bg-{{ similar_leave.status|lower }}">
                                        {{ similar_leave.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ similar_leave.created_at|date:"M d, Y H:i" }}</td>
                                <td>
                                    <a href="{% url 'attendance:leave_request_detail' similar_leave.id %}" 
                                       class="btn btn-sm btn-info" 
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No similar leave requests found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">Change Leave Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newStatus" class="form-label">New Status</label>
                    <select class="form-select" id="newStatus">
                        <option value="approve">Approve</option>
                        <option value="reject">Reject</option>
                        <option value="cancel">Cancel</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="statusRemarks" class="form-label">Remarks</label>
                    <textarea class="form-control" id="statusRemarks" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChange">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this leave request? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block footer_scripts %}
{{ block.super }}
{% endblock %}
```

### 📄 hrms_project\attendance\templates\attendance\leave_request_form.html
```{% extends 'attendance/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<style>
.select2-container--bootstrap-5 .select2-selection {
    min-height: 38px;
}
.select2-container--bootstrap-5 .select2-selection--single {
    padding-top: 4px;
}
.select2-container--bootstrap-5 .select2-search--dropdown .select2-search__field {
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    margin-bottom: 8px;
}
/* Progress bar styles */
.progress {
    height: 5px !important;
    background-color: #e9ecef;
    border-radius: 0.25rem;
    margin-top: 0.5rem;
}
.progress-bar {
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    transition: width 0.6s ease;
}
/* Progress bar color variants */
.progress-bar-annual {
    background-color: #28a745 !important;
}
.progress-bar-sick {
    background-color: #17a2b8 !important;
}
.progress-bar-other {
    background-color: #ffc107 !important;
}

/* Validation feedback styles */
.validation-feedback {
    margin-top: 0.5rem;
    padding: 0.5rem;
    border-radius: 0.25rem;
    border: 1px solid transparent;
}
.validation-feedback.is-valid {
    color: #28a745;
    background-color: #d4edda;
    border-color: #c3e6cb;
}
.validation-feedback.is-invalid {
    color: #dc3545;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}
.validation-feedback.is-loading {
    color: #17a2b8;
    background-color: #e9ecef;
    border-color: #dee2e6;
}
.submit-status {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 0.25rem;
    border: 1px solid #dee2e6;
    background-color: #f8f9fa;
}
.submit-status.disabled {
    border-left: 4px solid #dc3545;
}
.submit-status.enabled {
    border-left: 4px solid #28a745;
}
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">New Leave Request</h5>
            </div>
            <div class="col-auto">
                <a href="{% url 'attendance:leave_request_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        {% if user.is_staff %}
        <!-- Employee Selection Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-user"></i> Select Employee
                </h6>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3" id="employeeSelectForm">
                    <div class="col-md-3">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="department" name="department">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:"s" %}selected{% endif %}>
                                {{ dept.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-7">
                        <label class="form-label">Search Employee</label>
                        <select class="form-select" id="employee" name="employee" required>
                            <option value="">Search by name or employee number</option>
                            {% for emp in employees %}
                            <option value="{{ emp.id }}" {% if selected_employee.id == emp.id %}selected{% endif %}>
                                {{ emp.employee_number }} - {{ emp.get_full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Select</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        {% if selected_employee or not user.is_staff %}
        <!-- Leave Balance Summary -->
        <div class="row mb-4">
            {% for balance in leave_balances %}
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">{{ balance.leave_type.name }} Balance</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="mb-0">{{ balance.available_days }}</h3>
                            <small class="text-muted">days available</small>
                        </div>
                        <div class="progress mt-2">
                            <div class="progress-bar {% if balance.leave_type.code == 'ANNUAL' %}progress-bar-annual{% elif balance.leave_type.code == 'SICK' %}progress-bar-sick{% else %}progress-bar-other{% endif %}" 
                                 role="progressbar"
                                 style="width: {{ balance.balance_percentage }}%"
                                 aria-valuenow="{{ balance.balance_percentage }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Leave Request Form -->
        <form method="post" enctype="multipart/form-data" id="leaveRequestForm">
            {% if selected_employee %}
            <input type="hidden" name="employee" value="{{ selected_employee.id }}">
            {% endif %}
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    {{ form.leave_type|as_crispy_field }}
                </div>
                <div class="col-md-6">
                    {{ form.leave_sub_type|as_crispy_field }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    {{ form.start_date|as_crispy_field }}
                </div>
                <div class="col-md-6">
                    {{ form.end_date|as_crispy_field }}
                </div>
            </div>
            <!-- Add total days display -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-calendar-day"></i> Total Days:</span>
                                <span id="totalDaysDisplay" class="fw-bold">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    {{ form.reason|as_crispy_field }}
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    {{ form.document|as_crispy_field }}
                </div>
            </div>
            <!-- Add validation message area -->
            <div class="row">
                <div class="col-12">
                    <div class="validation-feedback"></div>
                    <div class="submit-status"></div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Submit Request
                    </button>
                    <a href="{% url 'attendance:leave_request_list' %}" class="btn btn-secondary">
                        Cancel
                    </a>
                </div>
            </div>
        </form>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Please select an employee to create a leave request.
        </div>
        {% endif %}
    </div>
</div>
{% endblock attendance_content %}

{% block extra_js %}
<!-- jQuery first, then Select2 -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        // Initialize Select2 on the employee select
        $('#employee').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Search by name or employee number',
            allowClear: true,
            dropdownParent: $('#employeeSelectForm')
        });

        // Handle department change
        $('#department').change(function() {
            $('#employeeSelectForm').submit();
        });

        // Get form elements
        const leaveTypeSelect = $('#id_leave_type');
        const subTypeSelect = $('#id_leave_sub_type');
        const startDateInput = $('#id_start_date');
        const endDateInput = $('#id_end_date');
        const subTypeContainer = subTypeSelect.closest('.form-group');
        const validationFeedback = $('.validation-feedback');
        const totalDaysDisplay = $('#totalDaysDisplay');
        
        // Function to calculate total days
        function calculateTotalDays() {
            const startDate = startDateInput.val();
            const endDate = endDateInput.val();
            const leaveType = leaveTypeSelect.val();
            const subType = subTypeSelect.val();
            
            if (!startDate || !endDate) {
                totalDaysDisplay.text('-');
                return;
            }
            
            // Calculate days between dates
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Ensure end date is not before start date
            if (end < start) {
                endDateInput.val(startDate);
                end.setTime(start.getTime());
            }
            
            const diffTime = Math.abs(end - start);
            let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end dates
            
            // Adjust for half-day or other special sub-types
            if (subType) {
                if (subType === 'half_day' || subType === 'morning' || subType === 'afternoon') {
                    diffDays = 0.5;
                } else if (subType.includes('_days')) {
                    // Extract days from sub-type code (e.g., '3_days' -> 3)
                    try {
                        const days = parseInt(subType.split('_')[0]);
                        if (!isNaN(days)) {
                            diffDays = days;
                        }
                    } catch (e) {
                        console.error('Error parsing days from sub-type:', e);
                    }
                }
            }
            
            totalDaysDisplay.text(diffDays.toString() + (diffDays === 1 ? ' day' : ' days'));
        }
        
        // Function to validate leave request
        function validateLeaveRequest() {
            const leaveType = $('#id_leave_type').val();
            const leaveSubType = $('#id_leave_sub_type').val();
            const startDate = $('#id_start_date').val();
            const endDate = $('#id_end_date').val();
            const employeeId = $('input[name="employee"]').val();

            // Calculate total days
            calculateTotalDays();

            // Clear previous validation messages
            validationFeedback.removeClass('is-valid is-invalid').empty();
            $('.submit-status').removeClass('enabled disabled').empty();

            if (!leaveType || !startDate || !endDate) {
                showValidationMessage('Please fill in all required fields', false);
                return;
            }

            // Show loading state
            validationFeedback
                .removeClass('is-valid is-invalid')
                .addClass('is-loading')
                .html('<i class="fas fa-spinner fa-spin"></i> Validating...');

            // Prepare request data
            const requestData = {
                leave_type: leaveType,
                leave_sub_type: leaveSubType,
                start_date: startDate,
                end_date: endDate
            };

            if (employeeId) {
                requestData.employee = employeeId;
            }

            $.ajax({
                url: '/api/attendance/validate-leave-request/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                data: requestData,
                success: function(response) {
                    let validationDetails = [];
                    const submitBtn = $('button[type="submit"]');
                    
                    if (!response.is_valid) {
                        // Build validation details for invalid request
                        if (response.data.allowed_duration !== undefined) {
                            validationDetails.push(
                                `Allowed duration: ${response.data.allowed_duration} days`,
                                `Requested duration: ${response.data.requested_duration} days`
                            );
                        }
                        if (response.data.min_duration !== undefined) {
                            validationDetails.push(
                                `Minimum duration: ${response.data.min_duration} days`,
                                `Requested duration: ${response.data.requested_duration} days`
                            );
                        }
                        if (response.data.available_balance !== undefined) {
                            validationDetails.push(
                                `Available balance: ${response.data.available_balance} days`,
                                `Requested duration: ${response.data.requested_duration} days`
                            );
                        }
                        
                        // Show validation message
                        showValidationMessage(response.message, false, validationDetails);
                        
                        // Update submit status
                        $('.submit-status')
                            .addClass('disabled')
                            .html(`<strong>Cannot submit:</strong> ${response.message}`);
                            
                        submitBtn.prop('disabled', true);
                    } else {
                        // Build validation details for valid request
                        if (response.data.available_balance !== undefined) {
                            validationDetails.push(
                                `Available balance: ${response.data.available_balance} days`,
                                `Requesting: ${response.data.requested_duration} days`,
                                `Available after request: ${response.data.available_balance - response.data.requested_duration} days`
                            );
                        }
                        if (response.data.is_paid !== undefined) {
                            validationDetails.push(
                                response.data.is_paid ? 'This is a paid leave' : 'This is an unpaid leave'
                            );
                        }
                        if (response.data.tier) {
                            validationDetails.push(`Using ${response.data.tier}`);
                        }
                        
                        // Show validation message
                        showValidationMessage(response.message, true, validationDetails);
                        
                        // Update submit status
                        $('.submit-status')
                            .addClass('enabled')
                            .html('<strong>Ready to submit:</strong> All validations passed');
                            
                        submitBtn.prop('disabled', false);
                    }
                },
                error: function() {
                    showValidationMessage('Error validating request. Please try again.', false);
                    $('.submit-status')
                        .addClass('disabled')
                        .html('<strong>Cannot submit:</strong> Validation error occurred');
                    $('button[type="submit"]').prop('disabled', true);
                }
            });
        }

        // Helper function to show validation message
        function showValidationMessage(message, isValid, details = []) {
            validationFeedback
                .removeClass('is-loading')
                .addClass(isValid ? 'is-valid' : 'is-invalid');
            
            let html = `<strong>${message}</strong>`;
            if (details.length > 0) {
                html += '<ul class="mb-0 mt-2">';
                details.forEach(detail => {
                    html += `<li>${detail}</li>`;
                });
                html += '</ul>';
            }
            
            validationFeedback.html(html);
        }

        // Initially hide the sub-type field if no leave type is selected
        if (!leaveTypeSelect.val()) {
            subTypeContainer.hide();
        }

        // Handle leave type change
        leaveTypeSelect.change(function() {
            const leaveTypeId = $(this).val();
            const subTypeField = $('#id_leave_sub_type');
            
            // Hide sub-type field if no leave type selected
            if (!leaveTypeId) {
                subTypeContainer.hide();
                subTypeField.prop('required', false);
                validationFeedback.hide();
                calculateTotalDays(); // Update total days when leave type changes
                return;
            }

            // Submit form to get updated sub-types
            const form = $('#leaveRequestForm');
            const formData = new FormData(form[0]);
            formData.append('update_sub_types', 'true');

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.sub_type_choices) {
                        subTypeField.empty();
                        
                        // Add the choices from the response
                        response.sub_type_choices.forEach(function(choice) {
                            subTypeField.append($('<option></option>')
                                .val(choice[0])
                                .text(choice[1]));
                        });
                        
                        // Show/hide sub-type field based on choices
                        if (response.sub_type_choices.length > 1) {  // More than just the empty option
                            subTypeContainer.show();
                            subTypeField.prop('required', true);
                        } else {
                            subTypeContainer.hide();
                            subTypeField.prop('required', false);
                        }
                        
                        // Calculate total days after sub-type is updated
                        calculateTotalDays();
                        
                        // Validate the request
                        validateLeaveRequest();
                    }
                }
            });
        });
        
        // Trigger validation on input changes
        leaveTypeSelect.change(validateLeaveRequest);
        subTypeSelect.change(function() {
            calculateTotalDays(); // Update total days when sub-type changes
            validateLeaveRequest();
        });
        startDateInput.change(function() {
            calculateTotalDays(); // Update total days when start date changes
            validateLeaveRequest();
        });
        endDateInput.change(function() {
            calculateTotalDays(); // Update total days when end date changes
            validateLeaveRequest();
        });
        
        // Calculate total days on initial load
        calculateTotalDays();
    });

    // Initialize date inputs
    const startDateInput = document.getElementById('id_start_date');
    const endDateInput = document.getElementById('id_end_date');
    
    if (startDateInput && endDateInput) {
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        startDateInput.min = today;
        
        // Update end date minimum when start date changes
        startDateInput.addEventListener('change', function() {
            endDateInput.min = this.value;
            if (endDateInput.value && endDateInput.value < this.value) {
                endDateInput.value = this.value;
                // Trigger change event to update calculations
                $(endDateInput).trigger('change');
            }
        });
        
        // Ensure end date is never less than start date
        endDateInput.addEventListener('change', function() {
            if (startDateInput.value && this.value < startDateInput.value) {
                this.value = startDateInput.value;
                // Show a brief message to the user
                const $feedback = $('<div class="alert alert-warning alert-dismissible fade show mt-2" role="alert">')
                    .text('End date cannot be earlier than start date. It has been adjusted automatically.')
                    .append('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>');
                
                $(this).parent().append($feedback);
                
                // Remove the message after 5 seconds
                setTimeout(function() {
                    $feedback.alert('close');
                }, 5000);
            }
        });
    }
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\leave_request_list.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<!-- Custom badge styles -->
<style>
    .badge.bg-pending {
        background-color: #ffc107 !important;  /* warning yellow */
        color: #000;
    }
    .badge.bg-approved {
        background-color: #198754 !important;  /* success green */
        color: #fff;
    }
    .badge.bg-rejected {
        background-color: #dc3545 !important;  /* danger red */
        color: #fff;
    }
    .badge.bg-cancelled {
        background-color: #6c757d !important;  /* secondary gray */
        color: #fff;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- jQuery first, then Select2 -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock %}

{% block attendance_content %}
<!-- Add CSRF Token at the top of the content -->
{% csrf_token %}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Leave Requests</h5>
        <div>
            <a href="{% url 'attendance:leave_request_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Apply for Leave
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-4">
            {% if user.is_staff %}
            <div class="col-md-3">
                <label class="form-label">Employee</label>
                <select class="form-select" id="employee-filter" name="employee">
                    <option value="">All Employees</option>
                    {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if selected_employee == emp.id %}selected{% endif %}>
                        {{ emp.employee_number }} - {{ emp.get_full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="start-date" name="start_date">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="end-date" name="end_date">
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">Leave Type</label>
                <select class="form-select" id="type-filter" name="leave_type">
                    <option value="">All Types</option>
                    {% for type in leave_types %}
                    <option value="{{ type.code }}">{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select class="form-select" id="status-filter" name="status">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            {% if user.is_staff %}
            <div class="col-md-2">
                <label class="form-label">Department</label>
                <select class="form-select" id="department-filter" name="department">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="apply-filters">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
            </div>
        </div>

        <!-- Leave Requests Table -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Leave Type</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in leave_requests %}
                    <tr>
                        <td>{{ leave.employee.get_full_name }}</td>
                        <td>{{ leave.employee.department.name }}</td>
                        <td>{{ leave.leave_type.name }}</td>
                        <td>
                            {{ leave.start_date|date:"M d, Y" }} - {{ leave.end_date|date:"M d, Y" }}
                            <br>
                            <small class="text-muted">{{ leave.duration }} days</small>
                        </td>
                        <td>
                            <span class="badge bg-{{ leave.status }}">
                                {{ leave.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'attendance:leave_request_detail' leave.id %}" 
                                   class="btn btn-sm btn-info" 
                                   title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if user.is_staff %}
                                    {% if leave.status != 'deleted' %}
                                    <button type="button" 
                                            class="btn btn-sm btn-primary change-status" 
                                            data-id="{{ leave.id }}"
                                            data-current-status="{{ leave.status }}"
                                            title="Change Status"
                                            onclick="showStatusModal({{ leave.id }}, '{{ leave.status }}')">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" 
                                            class="btn btn-sm btn-danger delete-leave" 
                                            data-id="{{ leave.id }}"
                                            title="Delete"
                                            onclick="confirmDelete({{ leave.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                {% elif leave.employee == user.employee and leave.status == 'pending' %}
                                    <button type="button" 
                                            class="btn btn-sm btn-danger cancel-leave" 
                                            data-id="{{ leave.id }}"
                                            title="Cancel Request">
                                        <i class="fas fa-times"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No leave requests found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this leave request? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Leave Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newStatus" class="form-label">New Status</label>
                    <select class="form-select" id="newStatus">
                        <option value="approve">Approve</option>
                        <option value="reject">Reject</option>
                        <option value="cancel">Cancel</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="statusRemarks" class="form-label">Remarks</label>
                    <textarea class="form-control" id="statusRemarks" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChange">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for handling filters and actions -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // Initialize Select2 for employee filter
    if (document.getElementById('employee-filter')) {
        $('#employee-filter').select2({
            theme: 'bootstrap-5',
            placeholder: 'Search employee...',
            allowClear: true
        });
    }

    // Handle department filter change
    const departmentFilter = document.getElementById('department-filter');
    if (departmentFilter) {
        departmentFilter.addEventListener('change', async function() {
            const departmentId = this.value;
            const employeeSelect = document.getElementById('employee-filter');
            
            if (employeeSelect) {
                // Clear current options
                employeeSelect.innerHTML = '<option value="">All Employees</option>';
                
                if (departmentId) {
                    try {
                        const response = await fetch(`/attendance/get_department_employees/?department_id=${departmentId}`);
                        const employees = await response.json();
                        
                        employees.forEach(emp => {
                            const option = new Option(
                                `${emp.employee_number} - ${emp.full_name}`,
                                emp.id
                            );
                            employeeSelect.add(option);
                        });
                    } catch (error) {
                        console.error('Error fetching employees:', error);
                    }
                }
                
                // Trigger Select2 to update
                $(employeeSelect).trigger('change');
            }
        });
    }

    // Handle filter form submission
    document.getElementById('apply-filters')?.addEventListener('click', function() {
        const params = new URLSearchParams();
        
        const employee = document.getElementById('employee-filter')?.value;
        const startDate = document.getElementById('start-date')?.value;
        const endDate = document.getElementById('end-date')?.value;
        const leaveType = document.getElementById('type-filter')?.value;
        const status = document.getElementById('status-filter')?.value;
        const department = document.getElementById('department-filter')?.value;
        
        if (employee) params.append('employee', employee);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (leaveType) params.append('leave_type', leaveType);
        if (status) params.append('status', status);
        if (department) params.append('department', department);
        
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    });

    // Initialize modals
    const statusModal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    let currentLeaveId = null;

    // Show status change modal
    window.showStatusModal = function(leaveId, currentStatus) {
        currentLeaveId = leaveId;
        const statusSelect = document.getElementById('newStatus');
        
        // Map current status to action
        const statusToAction = {
            'pending': '',
            'approved': 'approve',
            'rejected': 'reject',
            'cancelled': 'cancel'
        };
        
        // Remove current status from options
        Array.from(statusSelect.options).forEach(option => {
            option.style.display = option.value === statusToAction[currentStatus] ? 'none' : '';
        });
        
        // Show the modal
        statusModal.show();
    };

    // Handle status change
    document.getElementById('confirmStatusChange').addEventListener('click', function() {
        if (currentLeaveId) {
            const newStatus = document.getElementById('newStatus').value;
            const remarks = document.getElementById('statusRemarks').value;
            handleLeaveAction(newStatus, currentLeaveId, remarks);
            statusModal.hide();
        }
    });

    // Handle leave request actions
    const handleLeaveAction = async (action, leaveId, remarks = '') => {
        try {
            const response = await fetch(`/attendance/api/leaves/${leaveId}/${action}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ remarks })
            });
            
            const data = await response.json();
            if (response.ok) {
                window.location.reload();
            } else {
                alert(data.error || 'Failed to process the request. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        }
    };

    // Delete confirmation modal
    let leaveIdToDelete = null;

    window.confirmDelete = function(leaveId) {
        leaveIdToDelete = leaveId;
        deleteModal.show();
    };

    document.getElementById('confirmDeleteBtn')?.addEventListener('click', function() {
        if (leaveIdToDelete) {
            handleLeaveAction('delete', leaveIdToDelete);
            deleteModal.hide();
        }
    });
});
</script>

{% endblock %}

{% block footer_scripts %}
{{ block.super }}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Leave Status Modal Handler -->
<script src="{% static 'attendance/js/leave-status-modal.js' %}"></script>
{% endblock %}
```

### 📄 hrms_project\attendance\templates\attendance\leave_types.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
<style>
.tier-config {
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    padding: 1rem;
    margin-bottom: 1rem;
}
.tier-config:not(:last-child) {
    border-bottom: 1px solid #dee2e6;
}
.validation-rules {
    background-color: #e9ecef;
    border-radius: 0.25rem;
    padding: 1rem;
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-tags"></i> Leave Types
        </h5>
        {% if perms.attendance.add_leavetype %}
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addLeaveTypeModal">
            <i class="fas fa-plus"></i> Add Leave Type
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Code</th>
                        <th>Category</th>
                        <th>Balance Type</th>
                        <th>Days Allowed</th>
                        <th>Paid</th>
                        <th>Document Required</th>
                        <th>Gender Specific</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave_type in leave_types %}
                    <tr>
                        <td>{{ leave_type.name }}</td>
                        <td><code>{{ leave_type.code }}</code></td>
                        <td>
                            <span class="badge bg-info">{{ leave_type.category }}</span>
                        </td>
                        <td>
                            {% if leave_type.balance_calculation == 'TIERED' %}
                            <span class="badge bg-warning">Tiered</span>
                            {% elif leave_type.balance_calculation == 'SHARED' %}
                            <span class="badge bg-info">Shared</span>
                            {% elif leave_type.balance_calculation == 'FIXED' %}
                            <span class="badge bg-success">Fixed</span>
                            {% else %}
                            <span class="badge bg-secondary">Accrual</span>
                            {% endif %}
                        </td>
                        <td>{{ leave_type.days_allowed }}</td>
                        <td>
                            {% if leave_type.is_paid %}
                            <span class="badge bg-success">Yes</span>
                            {% else %}
                            <span class="badge bg-danger">No</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if leave_type.requires_document %}
                            <span class="badge bg-warning">Required</span>
                            {% else %}
                            <span class="badge bg-secondary">Optional</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if leave_type.gender_specific == 'A' %}
                            <span class="badge bg-primary">All</span>
                            {% elif leave_type.gender_specific == 'M' %}
                            <span class="badge bg-info">Male</span>
                            {% else %}
                            <span class="badge bg-info">Female</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if perms.attendance.change_leavetype %}
                            <div class="btn-group">
                                <button type="button" 
                                        class="btn btn-sm btn-outline-primary edit-leave-type"
                                        data-id="{{ leave_type.id }}"
                                        data-name="{{ leave_type.name }}"
                                        data-code="{{ leave_type.code }}"
                                        data-category="{{ leave_type.category }}"
                                        data-balance-calculation="{{ leave_type.balance_calculation }}"
                                        data-days="{{ leave_type.days_allowed }}"
                                        data-paid="{{ leave_type.is_paid|yesno:'true,false' }}"
                                        data-document="{{ leave_type.requires_document|yesno:'true,false' }}"
                                        data-gender="{{ leave_type.gender_specific }}"
                                        data-description="{{ leave_type.description }}"
                                        data-validation-rules="{{ leave_type.validation_rules|safe }}"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editLeaveTypeModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% if perms.attendance.delete_leavetype %}
                                <button type="button" 
                                        class="btn btn-sm btn-outline-danger delete-leave-type"
                                        data-id="{{ leave_type.id }}"
                                        data-name="{{ leave_type.name }}"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteLeaveTypeModal">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center">No leave types found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Leave Type Modal (Combined) -->
<div class="modal fade" id="leaveTypeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add/Edit Leave Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="leaveTypeForm" method="POST">
                {% csrf_token %}
                <input type="hidden" id="leave_type_id" name="id">
                <div class="modal-body">
                    <div class="row">
                        <!-- Basic Information -->
                        <div class="col-md-6">
                            <h6 class="mb-3">Basic Information</h6>
                            <div class="mb-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="code" class="form-label">Code</label>
                                <input type="text" class="form-control" id="code" name="code" required>
                                <div class="form-text">Unique identifier (e.g., ANNUAL, SICK)</div>
                            </div>
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="REGULAR">Regular</option>
                                    <option value="MEDICAL">Medical</option>
                                    <option value="SPECIAL">Special</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="balance_calculation" class="form-label">Balance Calculation</label>
                                <select class="form-select" id="balance_calculation" name="balance_calculation" required>
                                    <option value="FIXED">Fixed Allowance</option>
                                    <option value="ACCRUAL">Monthly Accrual</option>
                                    <option value="TIERED">Tiered System</option>
                                    <option value="SHARED">Shared Balance</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Additional Settings -->
                        <div class="col-md-6">
                            <h6 class="mb-3">Additional Settings</h6>
                            <div class="mb-3">
                                <label for="days_allowed" class="form-label">Days Allowed</label>
                                <input type="number" class="form-control" id="days_allowed" name="days_allowed" required min="0" step="0.5">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_paid" name="is_paid" checked>
                                    <label class="form-check-label" for="is_paid">Paid Leave</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="requires_document" name="requires_document">
                                    <label class="form-check-label" for="requires_document">Requires Document</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="gender_specific" class="form-label">Gender Specific</label>
                                <select class="form-select" id="gender_specific" name="gender_specific" required>
                                    <option value="A">All</option>
                                    <option value="M">Male Only</option>
                                    <option value="F">Female Only</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Tier Configuration (for Sick Leave) -->
                    <div id="tierConfig" class="mt-4" style="display: none;">
                        <h6 class="mb-3">Tier Configuration</h6>
                        <div id="tiers">
                            <div class="tier-config">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">Tier Name</label>
                                        <input type="text" class="form-control" name="tier_name[]" value="Full Pay">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Days Allowed</label>
                                        <input type="number" class="form-control" name="tier_days[]" value="15">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Pay Percentage</label>
                                        <input type="number" class="form-control" name="tier_percentage[]" value="100">
                                    </div>
                                </div>
                            </div>
                            <!-- Additional tiers will be added dynamically -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addTier">
                            <i class="fas fa-plus"></i> Add Tier
                        </button>
                    </div>

                    <!-- Shared Balance Configuration -->
                    <div id="sharedBalanceConfig" class="mt-4" style="display: none;">
                        <h6 class="mb-3">Shared Balance Configuration</h6>
                        <div class="mb-3">
                            <label class="form-label">Share Balance With</label>
                            <select class="form-select" name="shared_balance_with">
                                <option value="">Select Leave Type</option>
                                {% for lt in leave_types %}
                                <option value="{{ lt.id }}">{{ lt.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Validation Rules -->
                    <div class="validation-rules mt-4">
                        <h6 class="mb-3">Validation Rules</h6>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_one_time" name="is_one_time">
                                <label class="form-check-label" for="is_one_time">
                                    One-time Leave (can only be taken once during employment)
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="has_fixed_duration" name="has_fixed_duration">
                                <label class="form-check-label" for="has_fixed_duration">
                                    Fixed Duration Leave
                                </label>
                            </div>
                            <div id="fixedDurationConfig" class="mt-2" style="display: none;">
                                <input type="number" class="form-control" name="fixed_duration" placeholder="Number of days">
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3 mt-4">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Leave Type</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Leave Type Modal -->
<div class="modal fade" id="deleteLeaveTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Leave Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the leave type "<span id="deleteLeaveTypeName"></span>"?</p>
                <p class="text-danger">This action cannot be undone. All associated leave records will be affected.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteLeaveTypeForm" method="POST">
                    {% csrf_token %}
                    <input type="hidden" id="delete_id" name="id">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Handle balance calculation type change
    $('#balance_calculation').change(function() {
        const value = $(this).val();
        
        // Show/hide tier configuration
        $('#tierConfig').toggle(value === 'TIERED');
        
        // Show/hide shared balance configuration
        $('#sharedBalanceConfig').toggle(value === 'SHARED');
    });
    
    // Handle fixed duration checkbox
    $('#has_fixed_duration').change(function() {
        $('#fixedDurationConfig').toggle(this.checked);
    });
    
    // Add tier button
    $('#addTier').click(function() {
        const tierHtml = `
            <div class="tier-config">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Tier Name</label>
                        <input type="text" class="form-control" name="tier_name[]">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Days Allowed</label>
                        <input type="number" class="form-control" name="tier_days[]">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Pay Percentage</label>
                        <input type="number" class="form-control" name="tier_percentage[]">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-outline-danger btn-sm d-block remove-tier">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#tiers').append(tierHtml);
    });
    
    // Remove tier button
    $(document).on('click', '.remove-tier', function() {
        $(this).closest('.tier-config').remove();
    });
    
    // Edit leave type button
    $('.edit-leave-type').click(function() {
        const data = $(this).data();
        
        // Populate form fields
        $('#leave_type_id').val(data.id);
        $('#name').val(data.name);
        $('#code').val(data.code);
        $('#category').val(data.category);
        $('#balance_calculation').val(data.balanceCalculation).trigger('change');
        $('#days_allowed').val(data.days);
        $('#is_paid').prop('checked', data.paid === 'true');
        $('#requires_document').prop('checked', data.document === 'true');
        $('#gender_specific').val(data.gender);
        $('#description').val(data.description);
        
        // Parse and populate validation rules
        if (data.validationRules) {
            const rules = JSON.parse(data.validationRules);
            $('#is_one_time').prop('checked', rules.is_one_time);
            $('#has_fixed_duration').prop('checked', rules.has_fixed_duration).trigger('change');
            if (rules.has_fixed_duration) {
                $('input[name="fixed_duration"]').val(rules.fixed_duration);
            }
        }
        
        // Show modal
        $('#leaveTypeModal').modal('show');
    });
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\mark_attendance.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Mark Attendance</h5>
    </div>
    <div class="card-body">
        <form id="mark-attendance-form">
            <div class="row">
                <!-- Employee Selection -->
                <div class="col-md-6 mb-3">
                    <label for="employee-select" class="form-label">Employee</label>
                    <select class="form-select" id="employee-select" required>
                        <option value="">Select Employee</option>
                        {% for emp in employees %}
                        <option value="{{ emp.id }}">{{ emp.get_full_name }} ({{ emp.employee_number }})</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Date Selection -->
                <div class="col-md-6 mb-3">
                    <label for="attendance-date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="attendance-date" required 
                           value="{{ today|date:'Y-m-d' }}">
                </div>

                <!-- Time Selection -->
                <div class="col-md-6 mb-3">
                    <label for="first-in" class="form-label">First In Time</label>
                    <input type="time" class="form-control" id="first-in" required>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="last-out" class="form-label">Last Out Time</label>
                    <input type="time" class="form-control" id="last-out" required>
                </div>

                <!-- Shift Selection -->
                <div class="col-md-6 mb-3">
                    <label for="shift-select" class="form-label">Shift</label>
                    <select class="form-select" id="shift-select">
                        <option value="">No Shift</option>
                        {% for shift in shifts %}
                        <option value="{{ shift.id }}">{{ shift.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Source -->
                <div class="col-md-6 mb-3">
                    <label for="source" class="form-label">Source</label>
                    <select class="form-select" id="source" required>
                        <option value="manual">Manual Entry</option>
                        <option value="system">System</option>
                    </select>
                </div>

                <!-- Remarks -->
                <div class="col-12 mb-3">
                    <label for="remarks" class="form-label">Remarks</label>
                    <textarea class="form-control" id="remarks" rows="3"></textarea>
                </div>

                <!-- Submit Button -->
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Attendance
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mark-attendance-form');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            employee: document.getElementById('employee-select').value,
            date: document.getElementById('attendance-date').value,
            first_in_time: document.getElementById('first-in').value,
            last_out_time: document.getElementById('last-out').value,
            shift: document.getElementById('shift-select').value,
            source: document.getElementById('source').value,
            remarks: document.getElementById('remarks').value
        };

        fetch('/api/attendance/logs/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            alert('Attendance marked successfully');
            form.reset();
        })
        .catch(error => {
            alert('Error marking attendance: ' + error.message);
        });
    });
});
</script>
{% endblock %}
```

### 📄 hrms_project\attendance\templates\attendance\pdf\attendance_report.html
```<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Attendance Report</title>
</head>
<body>
    <div class="report-header">
        <h1 class="report-title">Attendance Report</h1>
        <div class="report-subtitle">
            {{ data.start_date|date:"F d, Y" }} - {{ data.end_date|date:"F d, Y" }}
        </div>
        <div class="report-meta">
            Generated on: {{ generated_at|date:"F d, Y h:i A" }}
        </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-cards">
        <div class="summary-card present">
            <h3>Present</h3>
            <div class="value">{{ data.summary.present }}</div>
        </div>
        <div class="summary-card absent">
            <h3>Absent</h3>
            <div class="value">{{ data.summary.absent }}</div>
        </div>
        <div class="summary-card late">
            <h3>Late</h3>
            <div class="value">{{ data.summary.late }}</div>
        </div>
        <div class="summary-card leave">
            <h3>On Leave</h3>
            <div class="value">{{ data.summary.leave }}</div>
        </div>
    </div>

    <!-- Department Statistics -->
    {% if data.department_stats %}
    <div class="section">
        <h2>Department Statistics</h2>
        <table>
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Present</th>
                    <th>Absent</th>
                    <th>Late</th>
                    <th>On Leave</th>
                </tr>
            </thead>
            <tbody>
                {% for dept in data.department_stats %}
                <tr>
                    <td>{{ dept.department }}</td>
                    <td>{{ dept.present }}</td>
                    <td>{{ dept.absent }}</td>
                    <td>{{ dept.late }}</td>
                    <td>{{ dept.leave }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Detailed Employee Records -->
    {% if data.employee_records %}
    <div class="section">
        <h2>Employee Details</h2>
        <table>
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Present Days</th>
                    <th>Absent Days</th>
                    <th>Late Days</th>
                    <th>Leave Days</th>
                </tr>
            </thead>
            <tbody>
                {% for record in data.employee_records %}
                <tr>
                    <td>{{ record.id }}</td>
                    <td>{{ record.name }}</td>
                    <td>{{ record.department }}</td>
                    <td>{{ record.present_days }}</td>
                    <td>{{ record.absent_days }}</td>
                    <td>{{ record.late_days }}</td>
                    <td>{{ record.leave_days }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Daily Trend Data -->
    {% if data.trend_data %}
    <div class="section">
        <h2>Daily Attendance Trend</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Present</th>
                    <th>Absent</th>
                    <th>Late</th>
                    <th>On Leave</th>
                </tr>
            </thead>
            <tbody>
                {% for trend in data.trend_data %}
                <tr>
                    <td>{{ trend.date }}</td>
                    <td>{{ trend.present }}</td>
                    <td>{{ trend.absent }}</td>
                    <td>{{ trend.late }}</td>
                    <td>{{ trend.leave }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="footer">
        <p>This is an automatically generated report. For any discrepancies, please contact HR department.</p>
        <p>© {% now "Y" %} Your Company Name. All rights reserved.</p>
    </div>
</body>
</html>
```

### 📄 hrms_project\attendance\templates\attendance\pdf\holiday_report.html
```<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Holiday Report</title>
</head>
<body>
    <div class="report-header">
        <h1 class="report-title">Holiday Report</h1>
        <div class="report-subtitle">
            {{ data.start_date|date:"F d, Y" }} - {{ data.end_date|date:"F d, Y" }}
        </div>
        <div class="report-meta">
            Generated on: {{ generated_at|date:"F d, Y h:i A" }}
        </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-cards">
        <div class="summary-card">
            <h3>Total Holidays</h3>
            <div class="value">{{ data.total_holidays }}</div>
        </div>
    </div>

    <!-- Holiday Calendar -->
    <div class="section">
        <h2>Holiday Calendar</h2>
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Holiday Name</th>
                    <th>Type</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {% for holiday in data.holidays %}
                <tr>
                    <td>{{ holiday.date|date:"l, F d, Y" }}</td>
                    <td>{{ holiday.name }}</td>
                    <td>{{ holiday.type|title }}</td>
                    <td>{{ holiday.description|default:"-" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Holiday Type Distribution -->
    {% if data.holiday_type_stats %}
    <div class="section">
        <h2>Holiday Type Distribution</h2>
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in data.holiday_type_stats %}
                <tr>
                    <td>{{ stat.type|title }}</td>
                    <td>{{ stat.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Month-wise Distribution -->
    {% if data.monthly_distribution %}
    <div class="section">
        <h2>Monthly Distribution</h2>
        <table>
            <thead>
                <tr>
                    <th>Month</th>
                    <th>Number of Holidays</th>
                    <th>Holidays</th>
                </tr>
            </thead>
            <tbody>
                {% for month in data.monthly_distribution %}
                <tr>
                    <td>{{ month.name }}</td>
                    <td>{{ month.count }}</td>
                    <td>
                        <ul>
                            {% for holiday in month.holidays %}
                            <li>{{ holiday.date|date:"d" }} - {{ holiday.name }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Optional Holiday Usage -->
    {% if data.optional_holiday_usage %}
    <div class="section">
        <h2>Optional Holiday Usage</h2>
        <table>
            <thead>
                <tr>
                    <th>Holiday Name</th>
                    <th>Date</th>
                    <th>Employees Availed</th>
                    <th>Department Distribution</th>
                </tr>
            </thead>
            <tbody>
                {% for holiday in data.optional_holiday_usage %}
                <tr>
                    <td>{{ holiday.name }}</td>
                    <td>{{ holiday.date|date:"F d, Y" }}</td>
                    <td>{{ holiday.employees_availed }}</td>
                    <td>
                        <ul>
                            {% for dept in holiday.department_stats %}
                            <li>{{ dept.name }}: {{ dept.count }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Notes Section -->
    <div class="section">
        <h2>Important Notes</h2>
        <ul>
            <li>Public holidays are mandatory for all employees.</li>
            <li>Optional holidays can be availed by submitting a request in advance.</li>
            <li>Employees working on holidays are eligible for compensatory off as per company policy.</li>
        </ul>
    </div>

    <div class="footer">
        <p>This is an automatically generated report. For any discrepancies, please contact HR department.</p>
        <p>© {% now "Y" %} Your Company Name. All rights reserved.</p>
    </div>

    <style>
        /* Additional styles specific to holiday report */
        .section ul {
            margin: 0;
            padding-left: 1.2em;
        }
        
        .section ul li {
            margin: 0.2em 0;
        }
    </style>
</body>
</html>
```

### 📄 hrms_project\attendance\templates\attendance\pdf\leave_report.html
```<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Leave Report</title>
</head>
<body>
    <div class="report-header">
        <h1 class="report-title">Leave Report</h1>
        <div class="report-subtitle">
            {{ data.start_date|date:"F d, Y" }} - {{ data.end_date|date:"F d, Y" }}
        </div>
        <div class="report-meta">
            Generated on: {{ generated_at|date:"F d, Y h:i A" }}
        </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-cards">
        <div class="summary-card total">
            <h3>Total Leaves</h3>
            <div class="value">{{ data.total_leaves }}</div>
        </div>
        <div class="summary-card approved">
            <h3>Approved</h3>
            <div class="value">{{ data.approved_leaves }}</div>
        </div>
        <div class="summary-card pending">
            <h3>Pending</h3>
            <div class="value">{{ data.pending_leaves }}</div>
        </div>
        <div class="summary-card rejected">
            <h3>Rejected</h3>
            <div class="value">{{ data.rejected_leaves }}</div>
        </div>
    </div>

    <!-- Leave Type Statistics -->
    {% if data.leave_type_stats %}
    <div class="section">
        <h2>Leave Type Distribution</h2>
        <table>
            <thead>
                <tr>
                    <th>Leave Type</th>
                    <th>Count</th>
                    <th>Average Duration (Days)</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in data.leave_type_stats %}
                <tr>
                    <td>{{ stat.leave_type }}</td>
                    <td>{{ stat.count }}</td>
                    <td>{{ stat.avg_duration|floatformat:1 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Department Statistics -->
    {% if data.department_stats %}
    <div class="section">
        <h2>Department-wise Leave Statistics</h2>
        <table>
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Total Leaves</th>
                    <th>Leave Types Breakdown</th>
                </tr>
            </thead>
            <tbody>
                {% for dept in data.department_stats %}
                <tr>
                    <td>{{ dept.department }}</td>
                    <td>{{ dept.total_leaves }}</td>
                    <td>
                        <ul>
                            {% for type in dept.by_type %}
                            <li>{{ type.leave_type }}: {{ type.count }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Employee Leave Records -->
    {% if data.employee_records %}
    <div class="section">
        <h2>Employee Leave Details</h2>
        <table>
            <thead>
                <tr>
                    <th>Employee</th>
                    <th>Department</th>
                    <th>Leave Type</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Duration</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for record in data.employee_records %}
                <tr>
                    <td>{{ record.employee_name }}</td>
                    <td>{{ record.department }}</td>
                    <td>{{ record.leave_type }}</td>
                    <td>{{ record.start_date|date:"M d, Y" }}</td>
                    <td>{{ record.end_date|date:"M d, Y" }}</td>
                    <td>{{ record.duration }} days</td>
                    <td>{{ record.status|title }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Leave Balance Summary -->
    {% if data.leave_balances %}
    <div class="section">
        <h2>Leave Balance Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Total Employees</th>
                    <th>Average Balance</th>
                    <th>Low Balance Alert</th>
                </tr>
            </thead>
            <tbody>
                {% for balance in data.leave_balances %}
                <tr>
                    <td>{{ balance.department }}</td>
                    <td>{{ balance.total_employees }}</td>
                    <td>{{ balance.avg_balance|floatformat:1 }} days</td>
                    <td>
                        {% if balance.low_balance_count > 0 %}
                        {{ balance.low_balance_count }} employees
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="footer">
        <p>This is an automatically generated report. For any discrepancies, please contact HR department.</p>
        <p>© {% now "Y" %} Your Company Name. All rights reserved.</p>
    </div>
</body>
</html>
```

### 📄 hrms_project\attendance\templates\attendance\recurring_holidays.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Recurring Holidays</h5>
        <div>
            <button id="generate-next-year" class="btn btn-success">
                <i class="fas fa-sync"></i> Generate Next Year's Holidays
            </button>
            <a href="{% url 'attendance:holiday_create' %}?recurring=true" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Recurring Holiday
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label class="form-label">Holiday Type</label>
                <select class="form-select" id="type-filter">
                    <option value="">All Types</option>
                    <option value="PUBLIC">Public Holiday</option>
                    <option value="COMPANY">Company Holiday</option>
                    <option value="OPTIONAL">Optional Holiday</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary" id="apply-filters">Apply Filters</button>
            </div>
        </div>

        <!-- Holiday Table -->
        <div class="table-responsive">
            <table class="table table-hover" id="recurring-holidays-table">
                <thead>
                    <tr>
                        <th>Date Pattern</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Last Generated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for holiday in holidays %}
                    <tr>
                        <td>{{ holiday.date|date:"d M" }} <em class="text-muted">(yearly)</em></td>
                        <td>{{ holiday.name }}</td>
                        <td>
                            <span class="badge bg-{{ holiday.holiday_type|lower }}">
                                {{ holiday.get_holiday_type_display }}
                            </span>
                        </td>
                        <td>
                            {% if holiday.last_generated %}
                            {{ holiday.last_generated|date:"d M Y" }}
                            {% else %}
                            <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'attendance:holiday_edit' pk=holiday.id %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-danger delete-holiday" data-id="{{ holiday.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No recurring holidays defined</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1">&laquo; First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this recurring holiday?</p>
                <p class="text-danger"><strong>Note:</strong> This will not delete any already generated holiday instances.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Generation Confirmation Modal -->
<div class="modal fade" id="generateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Next Year's Holidays</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will generate holiday entries for next year based on recurring holidays.</p>
                <div id="generation-preview">
                    <h6>Holidays to be generated:</h6>
                    <ul id="preview-list"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmGenerate">Generate</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    let deleteId = null;

    // Delete holiday
    $('.delete-holiday').click(function() {
        deleteId = $(this).data('id');
        $('#deleteModal').modal('show');
    });

    $('#confirmDelete').click(function() {
        if (deleteId) {
            $.ajax({
                url: `/attendance/holiday/${deleteId}/delete/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                success: function() {
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error deleting holiday');
                }
            });
        }
        $('#deleteModal').modal('hide');
    });

    // Generate next year's holidays
    $('#generate-next-year').click(function() {
        // First get preview
        $.ajax({
            url: '{% url "attendance:preview_next_year_holidays" %}',
            type: 'GET',
            success: function(data) {
                const previewList = $('#preview-list');
                previewList.empty();
                
                data.holidays.forEach(function(holiday) {
                    const li = $('<li>').text(
                        `${holiday.name} - ${holiday.date} - ${holiday.type}`
                    );
                    previewList.append(li);
                });
                
                $('#generateModal').modal('show');
            },
            error: function() {
                alert('Error loading preview');
            }
        });
    });

    $('#confirmGenerate').click(function() {
        $.ajax({
            url: '{% url "attendance:generate_next_year_holidays" %}',
            type: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function(data) {
                $('#generateModal').modal('hide');
                alert(`Successfully generated ${data.count} holidays for next year`);
                location.reload();
            },
            error: function() {
                alert('Error generating holidays');
            }
        });
    });

    // Apply filters
    $('#apply-filters').click(function() {
        const type = $('#type-filter').val();
        window.location.href = `?type=${type}`;
    });
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\report_template.html
```<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ report_title }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 24px;
        }
        .header .timestamp {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-present { background-color: #d4edda; color: #155724; }
        .status-absent { background-color: #f8d7da; color: #721c24; }
        .status-late { background-color: #fff3cd; color: #856404; }
        .status-leave { background-color: #cce5ff; color: #004085; }
        .status-holiday { background-color: #e2e3e5; color: #383d41; }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .summary h2 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .summary-item {
            background-color: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .summary-item .label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .summary-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
                padding: 0;
            }
            .summary {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{{ report_title }}</h1>
            <div class="timestamp">Generated on: {{ generated_at|default:now }}</div>
        </div>

        {% if filters %}
        <div class="filters">
            <strong>Filters:</strong>
            {% for key, value in filters.items %}
            <span>{{ key }}: {{ value }}</span>{% if not forloop.last %} | {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <div class="table-responsive">
            {{ table_content|safe }}
        </div>

        {% if summary_data %}
        <div class="summary">
            <h2>Summary</h2>
            <div class="summary-grid">
                {% for label, value in summary_data.items %}
                <div class="summary-item">
                    <div class="label">{{ label }}</div>
                    <div class="value">{{ value }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <script>
            // Add status badges to status column
            document.addEventListener('DOMContentLoaded', function() {
                const statusCells = document.querySelectorAll('td:nth-child(5)'); // Adjust index based on status column
                statusCells.forEach(cell => {
                    const status = cell.textContent.trim().toLowerCase();
                    cell.innerHTML = `<span class="status-badge status-${status}">${cell.textContent}</span>`;
                });
            });
        </script>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\reports\department_report.html
```<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <link href="{% static 'attendance/css/reports.css' %}" rel="stylesheet">
</head>
<body>
    <div class="header">
        <h1>Department Attendance Report</h1>
        <p>{{ period.start_date|date:"F j, Y" }} - {{ period.end_date|date:"F j, Y" }}</p>
    </div>

    <div class="department-info">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Department</div>
                <div class="info-value">{{ department.name }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Department Code</div>
                <div class="info-value">{{ department.code }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Total Employees</div>
                <div class="info-value">{{ statistics.total_employees }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Report Period</div>
                <div class="info-value">{{ period.total_days }} Days</div>
            </div>
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-card stat-present">
            <div class="stat-value">{{ statistics.present_rate|floatformat:1 }}%</div>
            <div class="stat-label">Present Rate</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ statistics.present_rate }}%; background-color: #28a745"></div>
            </div>
        </div>
        <div class="stat-card stat-late">
            <div class="stat-value">{{ statistics.late_rate|floatformat:1 }}%</div>
            <div class="stat-label">Late Rate</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ statistics.late_rate }}%; background-color: #ffc107"></div>
            </div>
        </div>
        <div class="stat-card stat-absent">
            <div class="stat-value">{{ statistics.absent_rate|floatformat:1 }}%</div>
            <div class="stat-label">Absent Rate</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ statistics.absent_rate }}%; background-color: #dc3545"></div>
            </div>
        </div>
        <div class="stat-card stat-leave">
            <div class="stat-value">{{ attendance.total_leave_days }}</div>
            <div class="stat-label">Leave Days</div>
        </div>
    </div>

    <div class="employee-list">
        <h2>Employee Attendance Summary</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>ID</th>
                        <th>Present Days</th>
                        <th>Absent Days</th>
                        <th>Late Days</th>
                        <th>Leave Days</th>
                        <th>Attendance Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in employees %}
                    <tr>
                        <td>{{ employee.get_full_name }}</td>
                        <td>{{ employee.employee_number }}</td>
                        <td>{{ employee.stats.present_days }}</td>
                        <td>{{ employee.stats.absent_days }}</td>
                        <td>{{ employee.stats.late_days }}</td>
                        <td>{{ employee.stats.leave_days }}</td>
                        <td>
                            {{ employee.stats.attendance_rate|floatformat:1 }}%
                            {% if employee.stats.trend > 0 %}
                            <span class="trend-indicator trend-up">↑</span>
                            {% elif employee.stats.trend < 0 %}
                            <span class="trend-indicator trend-down">↓</span>
                            {% else %}
                            <span class="trend-indicator trend-neutral">→</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="leave-section">
        <h2>Leave Statistics</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Leave Type</th>
                        <th>Total Days</th>
                        <th>Employees</th>
                        <th>Average Per Employee</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in leave_stats %}
                    <tr>
                        <td>{{ stat.leave_type__name }}</td>
                        <td>{{ stat.total_days }}</td>
                        <td>{{ stat.total_employees }}</td>
                        <td>{{ stat.average_days|floatformat:1 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        <p>Report generated on {{ generated_at|date:"l, F j, Y" }} at {{ generated_at|time:"h:i A" }}</p>
        <p>For individual employee reports, please use the generate_report command with --employee option.</p>
        <p>This is a system-generated report. Please contact HR for any discrepancies.</p>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\reports\employee_report.html
```<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <link href="{% static 'attendance/css/reports.css' %}" rel="stylesheet">
</head>
<body>
    <div class="header">
        <h1>Employee Attendance Report</h1>
        <p>{{ period.start_date|date:"F j, Y" }} - {{ period.end_date|date:"F j, Y" }}</p>
    </div>

    <div class="employee-info">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Name</div>
                <div class="info-value">{{ employee.get_full_name }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Employee ID</div>
                <div class="info-value">{{ employee.employee_number }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Department</div>
                <div class="info-value">{{ employee.department.name }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Designation</div>
                <div class="info-value">{{ employee.designation }}</div>
            </div>
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-card stat-present">
            <div class="stat-value">{{ statistics.present_days }}</div>
            <div class="stat-label">Present Days</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ statistics.present_rate }}%; background-color: #28a745"></div>
            </div>
            <div class="percent-indicator">{{ statistics.present_rate|floatformat:1 }}%</div>
        </div>
        <div class="stat-card stat-late">
            <div class="stat-value">{{ statistics.late_days }}</div>
            <div class="stat-label">Late Days</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ statistics.late_rate }}%; background-color: #ffc107"></div>
            </div>
            <div class="percent-indicator">{{ statistics.late_rate|floatformat:1 }}%</div>
        </div>
        <div class="stat-card stat-absent">
            <div class="stat-value">{{ statistics.absent_days }}</div>
            <div class="stat-label">Absent Days</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ statistics.absent_rate }}%; background-color: #dc3545"></div>
            </div>
            <div class="percent-indicator">{{ statistics.absent_rate|floatformat:1 }}%</div>
        </div>
        <div class="stat-card stat-leave">
            <div class="stat-value">{{ statistics.leave_days }}</div>
            <div class="stat-label">Leave Days</div>
        </div>
    </div>

    <div class="daily-attendance">
        <h2>Daily Attendance Log</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>First In</th>
                        <th>Last Out</th>
                        <th>Total Hours</th>
                        <th>Status</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in attendance_logs %}
                    <tr>
                        <td>{{ log.date|date:"M d, Y" }}</td>
                        <td>{{ log.date|date:"l" }}</td>
                        <td>{{ log.first_in_time|time:"h:i A"|default:"-" }}</td>
                        <td>{{ log.last_out_time|time:"h:i A"|default:"-" }}</td>
                        <td>{{ log.total_hours|floatformat:2 }}</td>
                        <td>
                            <span class="status-badge {{ log.status|lower }}">
                                {{ log.status }}
                            </span>
                        </td>
                        <td>{{ log.remarks|default:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="leave-section">
        <h2>Leave Summary</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Leave Type</th>
                        <th>Taken</th>
                        <th>Balance</th>
                        <th>Expiry</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in leave_summary %}
                    <tr>
                        <td>{{ leave.type }}</td>
                        <td>{{ leave.taken }}</td>
                        <td>{{ leave.balance }}</td>
                        <td>{{ leave.expiry_date|date:"M d, Y"|default:"N/A" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if leave_records %}
    <div class="leave-details">
        <h2>Leave Details</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Leave Type</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Days</th>
                        <th>Status</th>
                        <th>Approved By</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in leave_records %}
                    <tr>
                        <td>{{ record.leave_type }}</td>
                        <td>{{ record.start_date|date:"M d, Y" }}</td>
                        <td>{{ record.end_date|date:"M d, Y" }}</td>
                        <td>{{ record.days }}</td>
                        <td>
                            <span class="status-badge {{ record.status|lower }}">
                                {{ record.status }}
                            </span>
                        </td>
                        <td>{{ record.approved_by|default:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="footer">
        <p>Report generated on {{ generated_at|date:"l, F j, Y" }} at {{ generated_at|time:"h:i A" }}</p>
        <p>For any discrepancies in this report, please contact the HR department.</p>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\reports\organization_report.html
```<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <link href="{% static 'attendance/css/reports.css' %}" rel="stylesheet">
</head>
<body>
    <div class="header">
        <h1>Organization Attendance Report</h1>
        <p>{{ period.start_date|date:"F j, Y" }} - {{ period.end_date|date:"F j, Y" }}</p>
    </div>

    <div class="org-overview">
        <div class="overview-card">
            <div class="overview-value">{{ organization.total_departments }}</div>
            <div class="overview-label">Departments</div>
        </div>
        <div class="overview-card">
            <div class="overview-value">{{ organization.total_employees }}</div>
            <div class="overview-label">Active Employees</div>
        </div>
        <div class="overview-card">
            <div class="overview-value">{{ organization.stats.total_present }}</div>
            <div class="overview-label">Total Present Days</div>
        </div>
        <div class="overview-card">
            <div class="overview-value">{{ organization.stats.total_absent }}</div>
            <div class="overview-label">Total Absent Days</div>
        </div>
    </div>

    <div class="department-section">
        <h2>Department Analysis</h2>
        <div class="department-grid">
            {% for dept in department_stats %}
            <div class="department-card">
                <div class="department-header">
                    <div class="department-name">{{ dept.department.name }}</div>
                    <small>{{ dept.stats.total_employees }} Employees</small>
                </div>
                <div class="department-stats">
                    <div class="stat-item">
                        <div class="overview-value">{{ dept.stats.present_rate|floatformat:1 }}%</div>
                        <div class="overview-label">Present Rate</div>
                        <div class="progress-bar">
                            <div class="progress-fill fill-present" style="width: {{ dept.stats.present_rate }}%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="overview-value">{{ dept.stats.late_rate|floatformat:1 }}%</div>
                        <div class="overview-label">Late Rate</div>
                        <div class="progress-bar">
                            <div class="progress-fill fill-late" style="width: {{ dept.stats.late_rate }}%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="overview-value">{{ dept.stats.absent_rate|floatformat:1 }}%</div>
                        <div class="overview-label">Absent Rate</div>
                        <div class="progress-bar">
                            <div class="progress-fill fill-absent" style="width: {{ dept.stats.absent_rate }}%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="overview-value">{{ dept.stats.leave_days }}</div>
                        <div class="overview-label">Leave Days</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="leave-summary">
        <h2>Leave Statistics</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Leave Type</th>
                        <th>Total Days</th>
                        <th>Total Employees</th>
                        <th>Average Days/Employee</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in leave_stats %}
                    <tr>
                        <td>{{ stat.leave_type__name }}</td>
                        <td>{{ stat.total_days }}</td>
                        <td>{{ stat.total_employees }}</td>
                        <td>{{ stat.total_days|divisibleby:stat.total_employees }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        <p>Report generated on {{ generated_at|date:"l, F j, Y" }} at {{ generated_at|time:"h:i A" }}</p>
        <p>For detailed department-wise reports, please use the generate_report command with --department option.</p>
        <p>This is a system-generated report. Please contact HR for any discrepancies.</p>
    </div>
</body>
</html>

```

### 📄 hrms_project\attendance\templates\attendance\shifts\assignment_form.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link href="{% static 'attendance/css/shifts.css' %}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<style>
    .selected-employee {
        background-color: #f8f9fa;
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .employee-item {
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    .employee-item:hover {
        background-color: #f8f9fa;
    }
    .employee-item .form-check-input {
        margin-right: 10px;
        width: 18px;
        height: 18px;
    }
    .employee-item.checked {
        background-color: #e7f3ff;
    }
    .employee-search-results {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 0.5rem;
    }
    .select-buttons {
        border-bottom: 1px solid #dee2e6;
        padding: 10px;
        margin-bottom: 10px;
    }
    .select-buttons .btn {
        min-width: 100px;
    }
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">{{ form.id|yesno:"Edit,Create" }} Shift Assignment</h5>
    </div>
    <div class="card-body">
        <form method="post" id="shift-assignment-form">
            {% csrf_token %}
            
            <!-- Employee Selection -->
            <div class="mb-3">
                {% if form %}
                    <!-- Single employee selection for edit mode -->
                    <label class="form-label">Employee</label>
                    <select class="form-select" name="employee" id="employee" disabled>
                        <option value="{{ form.employee.id }}" selected>
                            {{ form.employee.get_full_name }} ({{ form.employee.employee_number }})
                        </option>
                    </select>
                    <input type="hidden" name="employee" value="{{ form.employee.id }}">
                {% else %}
                    <!-- Multiple employee selection for create mode -->
                    <label class="form-label">Select Employees</label>
                    <div class="d-flex align-items-center mb-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="employeeSearch" 
                                   placeholder="Search by name or employee number...">
                            <select class="form-select" id="departmentFilter" style="max-width: 200px;">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                    <option value="{{ dept.name }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="select-buttons">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="selectAll">
                            <i class="bi bi-check-all"></i> Select All
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="deselectAll">
                            <i class="bi bi-x-lg"></i> Deselect All
                        </button>
                    </div>

                    <div class="employee-search-results">
                        {% for employee in employees %}
                        <div class="employee-item" data-department="{{ employee.department.name }}">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input employee-checkbox" 
                                       id="emp_{{ employee.id }}" value="{{ employee.id }}"
                                       data-name="{{ employee.get_full_name }}"
                                       data-number="{{ employee.employee_number }}">
                                <label class="form-check-label" for="emp_{{ employee.id }}">
                                    {{ employee.get_full_name }} ({{ employee.employee_number }})
                                    <small class="text-muted">- {{ employee.department.name }}</small>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div id="selectedEmployees" class="mt-3">
                        <span class="text-muted">No employees selected</span>
                    </div>
                    <input type="hidden" name="employee[]" id="selectedEmployeeIds" required>
                {% endif %}
            </div>

            <!-- Shift Selection -->
            <div class="mb-3">
                <label class="form-label">Shift</label>
                <select class="form-select" name="shift" id="shift" required>
                    <option value="">Select Shift</option>
                    {% for shift in shifts %}
                        <option value="{{ shift.id }}" 
                                {% if form and form.shift.id == shift.id %}selected{% endif %}
                                data-shift-type="{{ shift.shift_type }}">
                            {{ shift.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Start Date -->
            <div class="mb-3">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" name="start_date" id="start_date" required
                       value="{{ form.start_date|date:'Y-m-d' }}">
            </div>

            <!-- End Date -->
            <div class="mb-3">
                <label class="form-label">End Date (Optional)</label>
                <input type="date" class="form-control" name="end_date" id="end_date"
                       value="{{ form.end_date|date:'Y-m-d' }}">
                <small class="text-muted">Leave blank for permanent assignment</small>
            </div>

            <!-- Active Status -->
            <div class="mb-3">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="is_active" id="is_active"
                           {% if not form or form.is_active %}checked{% endif %}>
                    <label class="form-check-label" for="is_active">Active</label>
                </div>
            </div>

            <!-- Night Shift Indicator -->
            <div id="night-shift-indicator" class="alert alert-info" style="display: none;">
                <i class="fas fa-moon"></i> This is a night shift assignment
            </div>

            <!-- Submit Buttons -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    {{ form.id|yesno:"Update,Create" }} Assignment
                </button>
                <a href="{% url 'attendance:shift_assignment_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize night shift indicator
    const shiftSelect = document.getElementById('shift');
    const nightShiftIndicator = document.getElementById('night-shift-indicator');
    
    function updateNightShiftIndicator() {
        if (!shiftSelect || !nightShiftIndicator) return;
        
        const selectedOption = shiftSelect.options[shiftSelect.selectedIndex];
        if (!selectedOption) return;
        
        const isNightShift = selectedOption.dataset.shiftType === 'NIGHT';
        nightShiftIndicator.style.display = isNightShift ? 'block' : 'none';
    }
    
    // Update indicator on load and change
    updateNightShiftIndicator();
    shiftSelect?.addEventListener('change', updateNightShiftIndicator);

    // Date validation
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');

    if (startDateInput && endDateInput) {
        startDateInput.addEventListener('change', function() {
            if (endDateInput.value && this.value > endDateInput.value) {
                endDateInput.value = this.value;
            }
            endDateInput.min = this.value;
        });

        endDateInput.addEventListener('change', function() {
            if (this.value && this.value < startDateInput.value) {
                this.value = startDateInput.value;
            }
        });
    }

    // Multiple employee selection functionality (only in create mode)
    if (!document.querySelector('form').dataset.editMode) {
        const searchInput = document.getElementById('employeeSearch');
        const departmentFilter = document.getElementById('departmentFilter');
        const employeeList = document.querySelector('.employee-search-results');
        const selectedEmployeesDiv = document.getElementById('selectedEmployees');
        const selectedEmployeeIds = document.getElementById('selectedEmployeeIds');
        const selectAllBtn = document.getElementById('selectAll');
        const deselectAllBtn = document.getElementById('deselectAll');

        // Handle employee filtering
        function filterEmployees() {
            const searchTerm = searchInput.value.toLowerCase();
            const department = departmentFilter.value;

            document.querySelectorAll('.employee-item').forEach(item => {
                const label = item.querySelector('.form-check-label');
                const text = label.textContent.toLowerCase();
                const empDepartment = item.dataset.department;
                
                const matchesSearch = text.includes(searchTerm);
                const matchesDepartment = !department || empDepartment === department;
                
                item.style.display = matchesSearch && matchesDepartment ? '' : 'none';
            });
        }

        // Update selected employees display
        function updateSelectedEmployees() {
            const selectedEmployees = [];
            let html = '';
            
            document.querySelectorAll('.employee-checkbox:checked').forEach(checkbox => {
                selectedEmployees.push({
                    id: checkbox.value,
                    name: checkbox.dataset.name,
                    number: checkbox.dataset.number
                });
            });

            if (selectedEmployees.length > 0) {
                selectedEmployees.forEach(emp => {
                    html += `
                        <div class="selected-employee d-flex justify-content-between align-items-center">
                            <span>${emp.name} (${emp.number})</span>
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                    onclick="removeEmployee('${emp.id}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>`;
                });
            } else {
                html = '<span class="text-muted">No employees selected</span>';
            }

            selectedEmployeesDiv.innerHTML = html;
            selectedEmployeeIds.value = selectedEmployees.map(emp => emp.id).join(',');
        }

        // Event listeners
        searchInput?.addEventListener('input', filterEmployees);
        departmentFilter?.addEventListener('change', filterEmployees);
        
        selectAllBtn?.addEventListener('click', function() {
            const visibleCheckboxes = Array.from(document.querySelectorAll('.employee-checkbox')).filter(checkbox => 
                checkbox.closest('.employee-item').style.display !== 'none'
            );
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('.employee-item').classList.add('checked');
            });
            updateSelectedEmployees();
        });

        deselectAllBtn?.addEventListener('click', function() {
            document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.employee-item').classList.remove('checked');
            });
            updateSelectedEmployees();
        });

        employeeList?.addEventListener('change', function(e) {
            if (e.target.classList.contains('employee-checkbox')) {
                const item = e.target.closest('.employee-item');
                if (e.target.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
                updateSelectedEmployees();
            }
        });

        // Function to remove an employee from selection
        window.removeEmployee = function(employeeId) {
            const checkbox = document.getElementById('emp_' + employeeId);
            if (checkbox) {
                checkbox.checked = false;
                checkbox.closest('.employee-item').classList.remove('checked');
                updateSelectedEmployees();
            }
        };
    }
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\shifts\assignment_list.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link href="{% static 'attendance/css/shifts.css' %}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
<style>
    #shift-assignment-calendar {
        margin-top: 20px;
        height: 800px;  /* Set a fixed height */
        width: 100%;
    }
    .fc-event {
        cursor: pointer;
        border: none;
        padding: 2px 4px;
    }
    .fc-event-title {
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .fc-event-time {
        font-size: 0.9em;
        opacity: 0.8;
    }
    /* Shift type styles */
    .shift-type-default {
        background-color: #0d6efd !important;  /* Bootstrap primary */
        border-color: #0a58ca !important;
        color: white !important;
    }
    .shift-type-night {
        background-color: #0dcaf0 !important;  /* Bootstrap info */
        border-color: #0a9ec0 !important;
        color: black !important;
    }
    .shift-type-open {
        background-color: #6c757d !important;  /* Bootstrap secondary */
        border-color: #565e64 !important;
        color: white !important;
    }
    .date-specific {
        border-left: 4px solid #ffc107 !important;  /* Bootstrap warning */
    }
    .ramadan {
        border-left: 4px solid #198754 !important;  /* Bootstrap success */
    }
    /* Filter styles */
    .calendar-filters {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .calendar-filters .form-label {
        font-weight: 500;
        color: #495057;
    }
    .calendar-filters .form-select {
        border-radius: 6px;
    }
    /* Add employee search styles */
    .employee-search {
        position: relative;
        margin-bottom: 15px;
    }
    
    .employee-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .employee-search-results.show {
        display: block;
    }
    
    .employee-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .employee-item:hover {
        background-color: #f8f9fa;
    }
    
    .selected-employee {
        background-color: #e7f3ff;
        padding: 8px;
        margin: 4px 0;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Shift Assignments</h5>
            <a href="{% url 'attendance:shift_assignment_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Assignment
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="assignmentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view"
                        type="button" role="tab" aria-controls="list-view" aria-selected="true">
                    List View
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-view"
                        type="button" role="tab" aria-controls="calendar-view" aria-selected="false">
                    Calendar View
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="assignmentTabsContent">
            <!-- List View Tab -->
            <div class="tab-pane fade" id="list-view" role="tabpanel" aria-labelledby="list-tab">
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="department-filter-list" name="department">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Shift</label>
                        <select class="form-select" id="shift-filter-list" name="shift">
                            <option value="">All Shifts</option>
                            {% for shift in shifts %}
                                <option value="{{ shift.id }}" {% if selected_shift == shift.id|stringformat:"s" %}selected{% endif %}>
                                    {{ shift.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="status-filter-list" name="status">
                            <option value="">All Status</option>
                            <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if selected_status == 'inactive' %}selected{% endif %}>Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Assignment Type</label>
                        <select class="form-select" id="type-filter-list" name="type">
                            <option value="">All Types</option>
                            <option value="permanent" {% if selected_type == 'permanent' %}selected{% endif %}>Permanent</option>
                            <option value="temporary" {% if selected_type == 'temporary' %}selected{% endif %}>Temporary</option>
                        </select>
                    </div>
                </div>

                <!-- Date Range Filters -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start-date-filter" name="start_date" 
                               value="{{ start_date|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end-date-filter" name="end_date" 
                               value="{{ end_date|default:'' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Search</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input-list" name="search"
                                   placeholder="Search by employee name or number..." value="{{ search_query|default:'' }}">
                            <button class="btn btn-outline-secondary" type="button" id="search-btn-list">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="clear-filters-btn">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Assignments Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Department</th>
                                <th>Shift</th>
                                <th>Period</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignments-tbody">
                            {% for assignment in page_obj %}
                            <tr>
                                <td>
                                    <div>{{ assignment.employee.get_full_name }}</div>
                                    <small class="text-muted">{{ assignment.employee.employee_number }}</small>
                                </td>
                                <td>{{ assignment.employee.department.name|default:'-' }}</td>
                                <td>
                                    <div>{{ assignment.shift.name }}</div>
                                    <small class="text-muted">
                                        {{ assignment.shift.start_time|time:"g:i A" }} - {{ assignment.shift.end_time|time:"g:i A" }}
                                    </small>
                                </td>
                                <td>
                                    <div>{{ assignment.start_date|date:"M d, Y" }}</div>
                                    {% if assignment.end_date %}
                                        <small class="text-muted">Until {{ assignment.end_date|date:"M d, Y" }}</small>
                                    {% else %}
                                        <small class="text-success">Permanent</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {% if assignment.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if assignment.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div>{{ assignment.created_by.get_full_name }}</div>
                                    <small class="text-muted">{{ assignment.created_at|date:"M d, Y" }}</small>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{% url 'attendance:shift_assignment_edit' assignment.id %}" 
                                           class="btn btn-sm btn-outline-primary" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="confirmDelete('{{ assignment.id }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle me-2"></i>No shift assignments found
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Shift assignments pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if num == page_obj.number %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>

            <!-- Calendar View Tab -->
            <div class="tab-pane fade show active" id="calendar-view" role="tabpanel" aria-labelledby="calendar-tab">
                <!-- Filters -->
                <div class="calendar-filters mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Department</label>
                            <select class="form-select" id="departmentFilter">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Shift Type</label>
                            <select class="form-select" id="shiftTypeFilter">
                                <option value="">All Types</option>
                                <option value="DEFAULT">Default Shift</option>
                                <option value="NIGHT">Night Shift</option>
                                <option value="OPEN">Open Shift</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Employee</label>
                            <div class="employee-search">
                                <input type="text" class="form-control" id="employeeSearch" 
                                       placeholder="Search employee...">
                                <div class="employee-search-results" id="searchResults"></div>
                            </div>
                            <div id="selectedEmployee" class="mt-2"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="clearEmployee">
                                Clear Employee Filter
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendar Container -->
                <div id="shift-assignment-calendar"></div>

                <!-- Shift Legend -->
                <div id="shift-legend" class="mt-3">
                    <div class="legend-item">
                        <div class="legend-color shift-type-default"></div>
                        <span>Default Shift (7AM-4PM)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color shift-type-night"></div>
                        <span>Night Shift (6PM-3AM)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color shift-type-open"></div>
                        <span>Open Shift</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this shift assignment? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Employee Search Modal -->
<div class="modal fade" id="employeeSearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Employees for Shift Assignment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="selectedDate">
                
                <!-- Department Filter -->
                <div class="mb-3">
                    <label class="form-label">Department</label>
                    <select class="form-select" id="modalDepartmentFilter">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Search Input -->
                <div class="mb-3">
                    <label class="form-label">Search Employee</label>
                    <input type="text" class="form-control" id="modalEmployeeSearch" 
                           placeholder="Search by name or employee number...">
                </div>

                <!-- Employee List -->
                <div class="employee-list" style="max-height: 400px; overflow-y: auto;">
                    <div id="modalEmployeeList">
                        {% for employee in employees %}
                        <div class="employee-item" data-department="{{ employee.department.id }}">
                            <div class="form-check">
                                <input class="form-check-input employee-checkbox" type="checkbox" 
                                       value="{{ employee.id }}" id="emp_{{ employee.id }}"
                                       data-fullname="{{ employee.get_full_name }}" 
                                       data-number="{{ employee.employee_number }}"
                                       data-department="{{ employee.department.name }}">
                                <label class="form-check-label" for="emp_{{ employee.id }}">
                                    {{ employee.get_full_name }} ({{ employee.employee_number }})
                                    <small class="text-muted">- {{ employee.department.name }}</small>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmEmployeeSelection">Assign Shift</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
// Function to initialize calendar
function initializeCalendar() {
    const calendarEl = document.getElementById('shift-assignment-calendar');
    if (!calendarEl) return;

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        slotMinTime: '00:00:00',
        slotMaxTime: '24:00:00',
        allDaySlot: false,
        height: '800px',
        slotDuration: '01:00:00',
        dayMaxEvents: true,
        displayEventTime: true,
        nextDayThreshold: '00:00:00',
        events: '/api/attendance/shift-assignments/',
        eventDidMount: function(info) {
            // Add shift type class
            if (info.event.extendedProps.shift_type) {
                info.el.classList.add('shift-type-' + info.event.extendedProps.shift_type.toLowerCase());
            }
            // Add special classes
            if (info.event.extendedProps.is_date_specific) {
                info.el.classList.add('date-specific');
            }
            if (info.event.extendedProps.is_ramadan) {
                info.el.classList.add('ramadan');
            }
        }
    });

    calendar.render();
    return calendar;
}


document.addEventListener('DOMContentLoaded', function() {
    // Function to apply filters
    function applyFilters() {
        const params = new URLSearchParams();
        
        // Get all filter values
        const department = document.getElementById('department-filter-list').value;
        const shift = document.getElementById('shift-filter-list').value;
        const status = document.getElementById('status-filter-list').value;
        const type = document.getElementById('type-filter-list').value;
        const startDate = document.getElementById('start-date-filter').value;
        const endDate = document.getElementById('end-date-filter').value;
        const search = document.getElementById('search-input-list').value;

        // Add non-empty values to params
        if (department) params.append('department', department);
        if (shift) params.append('shift', shift);
        if (status) params.append('status', status);
        if (type) params.append('type', type);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (search) params.append('search', search);

        // Redirect with filters
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }

    // Add event listeners to all filters
    const filters = [
        'department-filter-list',
        'shift-filter-list',
        'status-filter-list',
        'type-filter-list',
        'start-date-filter',
        'end-date-filter'
    ];

    filters.forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', applyFilters);
    });

    // Search button click handler
    document.getElementById('search-btn-list').addEventListener('click', applyFilters);

    // Search input enter key handler
    document.getElementById('search-input-list').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });

    // Clear filters button handler
    document.getElementById('clear-filters-btn').addEventListener('click', function() {
        window.location.href = window.location.pathname;
    });

    // Date range validation
    const startDateInput = document.getElementById('start-date-filter');
    const endDateInput = document.getElementById('end-date-filter');

    startDateInput.addEventListener('change', function() {
        endDateInput.min = this.value;
    });

    endDateInput.addEventListener('change', function() {
        startDateInput.max = this.value;
    });

    // Add the confirmDelete function
    window.confirmDelete = function(assignmentId) {
        const modal = document.getElementById('deleteModal');
        const deleteForm = document.getElementById('deleteForm');
        
        // Set the form action URL
        deleteForm.action = `{% url 'attendance:shift_assignment_list' %}${assignmentId}/delete/`;
        
        // Show the modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\shifts\day_detail.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<style>
    .shift-card {
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .shift-card.default {
        border-left: 4px solid #0d6efd;
    }
    .shift-card.night {
        border-left: 4px solid #0dcaf0;
    }
    .shift-card.open {
        border-left: 4px solid #6c757d;
    }
    .shift-header {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }
    .shift-body {
        padding: 15px;
    }
    .employee-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .employee-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .employee-item:last-child {
        border-bottom: none;
    }
    .employee-info {
        flex-grow: 1;
    }
    .employee-timing {
        color: #6c757d;
        font-size: 0.9em;
    }
    .badge-date-specific {
        background-color: #ffc107;
        color: #000;
    }
    .badge-ramadan {
        background-color: #198754;
        color: #fff;
    }
    .quick-assign {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    /* Employee selection styles */
    .selected-employee {
        background-color: #f8f9fa;
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .employee-search-item {
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    .employee-search-item:hover {
        background-color: #f8f9fa;
    }
    .employee-search-item .form-check-input {
        margin-right: 10px;
        width: 18px;
        height: 18px;
    }
    .employee-search-item.checked {
        background-color: #e7f3ff;
    }
    .employee-search-results {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 0.5rem;
    }
    .select-buttons {
        border-bottom: 1px solid #dee2e6;
        padding: 10px;
        margin-bottom: 10px;
    }
    .select-buttons .btn {
        min-width: 100px;
    }
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                Shift Assignments for {{ date|date:"F j, Y" }}
            </h5>
            <div>
                <a href="{% url 'attendance:shift_assignment_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-calendar"></i> Back to Calendar
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            {% for shift_type, group in shift_groups.items %}
            <div class="col-md-4">
                <div class="shift-card card {% if shift_type == 'DEFAULT' %}default{% elif shift_type == 'NIGHT' %}night{% else %}open{% endif %}">
                    <div class="shift-header">
                        <h6 class="mb-0">{{ group.name }}</h6>
                        <small class="text-muted">{{ group.assignments|length }} employees assigned</small>
                    </div>
                    <div class="shift-body">
                        {% if group.assignments %}
                        <ul class="employee-list">
                            {% for assignment in group.assignments %}
                            <li class="employee-item">
                                <div class="employee-info">
                                    <div>{{ assignment.employee.get_full_name }}</div>
                                    <small class="text-muted">{{ assignment.employee.employee_number }}</small>
                                    <div class="employee-timing">{{ assignment.timing }}</div>
                                </div>
                                <div class="badges">
                                    {% if assignment.is_date_specific %}
                                    <span class="badge badge-date-specific">Custom Time</span>
                                    {% endif %}
                                    {% if assignment.is_ramadan %}
                                    <span class="badge badge-ramadan">Ramadan</span>
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-user-clock fa-2x mb-2"></i>
                            <p>No employees assigned to this shift</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Quick Assign Button -->
<div class="quick-assign">
    <button type="button" class="btn btn-primary rounded-circle p-3" data-bs-toggle="modal" data-bs-target="#quickAssignModal">
        <i class="fas fa-plus"></i>
    </button>
</div>

<!-- Quick Assignment Modal -->
<div class="modal fade" id="quickAssignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Shift Assignment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickAssignForm">
                    {% csrf_token %}
                    <input type="hidden" name="date" value="{{ date|date:'Y-m-d' }}">
                    
                    <!-- Employee Selection Section -->
                    <div class="mb-3">
                        <label class="form-label">Selected Employees</label>
                        <div class="d-flex align-items-center mb-2">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="employeeSearch" 
                                       placeholder="Search by name or employee number...">
                            </div>
                            <select class="form-select ms-2" id="departmentFilter" style="width: auto;">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                    <option value="{{ dept.name }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="select-buttons text-end mb-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="selectAll">
                                <i class="bi bi-check-all"></i> Select All
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="deselectAll">
                                <i class="bi bi-x-lg"></i> Deselect All
                            </button>
                        </div>

                        <div class="employee-search-results">
                            {% for employee in employees %}
                            <div class="employee-search-item" data-department="{{ employee.department.name }}">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input employee-checkbox" 
                                           id="emp_{{ employee.id }}" value="{{ employee.id }}"
                                           data-name="{{ employee.get_full_name }}"
                                           data-number="{{ employee.employee_number }}">
                                    <label class="form-check-label" for="emp_{{ employee.id }}">
                                        {{ employee.get_full_name }} ({{ employee.employee_number }})
                                        <small class="text-muted">- {{ employee.department.name }}</small>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Selected employees will be listed here -->
                        <div id="selectedEmployees" class="mt-2">
                            <span class="text-muted">No employees selected</span>
                        </div>
                        <!-- Hidden input to store selected employee IDs -->
                        <input type="hidden" name="employee[]" id="selectedEmployeeIds" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Shift</label>
                        <select class="form-select" name="shift" required>
                            <option value="">Select Shift</option>
                            {% for shift in shifts %}
                            <option value="{{ shift.id }}">{{ shift.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="customTime">
                            <label class="form-check-label" for="customTime">
                                Custom timing for this day
                            </label>
                        </div>
                    </div>

                    <div id="customTimeInputs" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Time</label>
                                    <input type="time" class="form-control" name="start_time">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">End Time</label>
                                    <input type="time" class="form-control" name="end_time">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveQuickAssign">Save Assignment</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('employeeSearch');
    const departmentFilter = document.getElementById('departmentFilter');
    const employeeList = document.querySelector('.employee-search-results');
    const selectedEmployeesDiv = document.getElementById('selectedEmployees');
    const selectedEmployeeIds = document.getElementById('selectedEmployeeIds');
    const customTimeCheck = document.getElementById('customTime');
    const customTimeInputs = document.getElementById('customTimeInputs');
    const quickAssignForm = document.getElementById('quickAssignForm');
    const saveButton = document.getElementById('saveQuickAssign');
    const selectAllBtn = document.getElementById('selectAll');
    const deselectAllBtn = document.getElementById('deselectAll');
    
    // Initialize selected employees array
    let selectedEmployees = [];

    // Handle select/deselect all
    selectAllBtn.addEventListener('click', function() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.employee-checkbox')).filter(checkbox => 
            checkbox.closest('.employee-search-item').style.display !== 'none'
        );
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
            checkbox.closest('.employee-search-item').classList.add('checked');
        });
        updateSelectedEmployees();
    });

    deselectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.closest('.employee-search-item').classList.remove('checked');
        });
        updateSelectedEmployees();
    });

    // Handle employee filtering
    function filterEmployees() {
        const searchTerm = searchInput.value.toLowerCase();
        const department = departmentFilter.value;

        document.querySelectorAll('.employee-search-item').forEach(item => {
            const label = item.querySelector('.form-check-label');
            const text = label.textContent.toLowerCase();
            const empDepartment = item.dataset.department;
            
            const matchesSearch = text.includes(searchTerm);
            const matchesDepartment = !department || empDepartment === department;
            
            item.style.display = matchesSearch && matchesDepartment ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterEmployees);
    departmentFilter.addEventListener('change', filterEmployees);

    // Handle checkbox changes
    employeeList.addEventListener('change', function(e) {
        if (e.target.classList.contains('employee-checkbox')) {
            const item = e.target.closest('.employee-search-item');
            if (e.target.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
            updateSelectedEmployees();
        }
    });

    // Function to update selected employees display
    function updateSelectedEmployees() {
        selectedEmployees = [];
        let html = '';
        
        document.querySelectorAll('.employee-checkbox:checked').forEach(checkbox => {
            selectedEmployees.push({
                id: checkbox.value,
                name: checkbox.dataset.name,
                number: checkbox.dataset.number
            });
        });

        if (selectedEmployees.length > 0) {
            selectedEmployees.forEach(emp => {
                html += `
                    <div class="selected-employee d-flex justify-content-between align-items-center">
                        <span>${emp.name} (${emp.number})</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="removeEmployee('${emp.id}')">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>`;
            });
        } else {
            html = '<span class="text-muted">No employees selected</span>';
        }

        selectedEmployeesDiv.innerHTML = html;
        selectedEmployeeIds.value = selectedEmployees.map(emp => emp.id).join(',');
    }

    // Function to remove an employee from selection
    window.removeEmployee = function(employeeId) {
        const checkbox = document.getElementById('emp_' + employeeId);
        if (checkbox) {
            checkbox.checked = false;
            checkbox.closest('.employee-search-item').classList.remove('checked');
            updateSelectedEmployees();
        }
    };

    // Toggle custom time inputs
    customTimeCheck.addEventListener('change', function() {
        customTimeInputs.style.display = this.checked ? 'block' : 'none';
    });

    // Handle form submission
    saveButton.addEventListener('click', function() {
        if (!selectedEmployeeIds.value) {
            alert('Please select at least one employee');
            return;
        }

        const formData = new FormData(quickAssignForm);
        
        fetch('/attendance/api/shift-assignments/quick/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.error || 'Failed to create assignment');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to create assignment');
        });
    });
});
</script>
{% endblock %} 
```

### 📄 hrms_project\attendance\templates\attendance\shifts\ramadan_periods.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Ramadan Periods</h5>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPeriodModal">
            Add New Period
        </button>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for period in periods %}
                    <tr>
                        <td>{{ period.year }}</td>
                        <td>{{ period.start_date }}</td>
                        <td>{{ period.end_date }}</td>
                        <td>
                            <span class="badge {% if period.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                {% if period.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="ramadanManager.editPeriod({{ period.id }})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="ramadanManager.deletePeriod({{ period.id }})">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No Ramadan periods defined yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Period Modal -->
<div class="modal fade" id="addPeriodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Ramadan Period</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPeriodForm">
                    <div class="mb-3">
                        <label class="form-label">Year*</label>
                        <input type="number" class="form-control" name="year" required min="2020" max="2050">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Start Date*</label>
                        <input type="date" class="form-control" name="start_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">End Date*</label>
                        <input type="date" class="form-control" name="end_date" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" name="is_active" id="is_active" checked>
                            <label class="form-check-label">Active</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Period Modal -->
<div class="modal fade" id="editPeriodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Ramadan Period</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editPeriodForm">
                    <input type="hidden" name="id">
                    <div class="mb-3">
                        <label class="form-label">Year*</label>
                        <input type="number" class="form-control" name="year" required min="2020" max="2050">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Start Date*</label>
                        <input type="date" class="form-control" name="start_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">End Date*</label>
                        <input type="date" class="form-control" name="end_date" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" name="is_active" id="edit_is_active">
                            <label class="form-check-label">Active</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Update</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'attendance/js/ramadan.js' %}"></script>
<script>
    const ramadanManager = new RamadanPeriodManager();
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\shifts\shift_form.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">{% if shift %}Edit{% else %}Create{% endif %} Shift</h5>
    </div>
    <div class="card-body">
        <form method="post" id="shift-form">
            {% csrf_token %}
            
            <div class="row">
                <!-- Basic Information -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Name*</label>
                        <input type="text" class="form-control" name="name" 
                               value="{{ shift.name|default:'' }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Shift Type*</label>
                        <select class="form-select" name="shift_type" required="">
                            <option value="">Select Shift Type</option>
                            {% for type_code, type_label in shift_types %}
                              <option value="{{ type_code }}" {% if shift.shift_type == type_code %}selected{% endif %}>
                                  {{ type_label }}
                              </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Timing Information -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Start Time*</label>
                        <input type="time" class="form-control" name="start_time" 
                               value="{{ shift.start_time|time:'H:i'|default:'' }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">End Time*</label>
                        <input type="time" class="form-control" name="end_time" 
                               value="{{ shift.end_time|time:'H:i'|default:'' }}" required>
                    </div>
                </div>

                <!-- Settings Column -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Grace Period (minutes)</label>
                        <input type="number" class="form-control" name="grace_period" 
                               value="{{ shift.grace_period|default:'15' }}" min="0" max="60">
                        <small class="text-muted">
                            Allowed late arrival time before marking attendance as late
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Break Duration (minutes)</label>
                        <input type="number" class="form-control" name="break_duration" 
                               value="{{ shift.break_duration|default:'60' }}" min="0" max="180">
                        <small class="text-muted">
                            Official break time during the shift
                        </small>
                    </div>

                    <!-- Default Timings -->
                    <div class="mb-3">
                        <label class="form-label">Default Start Time</label>
                        <input type="time" class="form-control" name="default_start_time" 
                               value="{{ shift.default_start_time|time:'H:i'|default:'' }}">
                        <small class="text-muted">Default start time for this shift type</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Default End Time</label>
                        <input type="time" class="form-control" name="default_end_time" 
                               value="{{ shift.default_end_time|time:'H:i'|default:'' }}">
                        <small class="text-muted">Default end time for this shift type</small>
                    </div>

                    <!-- Active Status -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" name="is_active" id="is_active"
                                   {% if shift.is_active or shift is None %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">Active</label>
                        </div>
                        <small class="text-muted">
                            Inactive shifts cannot be assigned to employees
                        </small>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    {% if shift %}Save Changes{% else %}Create Shift{% endif %}
                </button>
                <a href="{% url 'attendance:shift_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('shift-form');
    const startTimeInput = form.querySelector('[name="start_time"]');
    const endTimeInput = form.querySelector('[name="end_time"]');
    const shiftTypeSelect = form.querySelector('[name="shift_type"]');
    const defaultStartTime = form.querySelector('[name="default_start_time"]');
    const defaultEndTime = form.querySelector('[name="default_end_time"]');

    // Function to handle shift type changes
    function handleShiftTypeChange() {
        const isOpen = shiftTypeSelect.value === 'OPEN';
        const isNight = shiftTypeSelect.value === 'NIGHT';

        // Handle Open shift
        if (isOpen) {
            defaultStartTime.value = '';
            defaultEndTime.value = '';
            defaultStartTime.disabled = true;
            defaultEndTime.disabled = true;
        } else {
            defaultStartTime.disabled = false;
            defaultEndTime.disabled = false;
        }

        // Auto-suggest default times for night shift
        if (isNight && !defaultStartTime.value && !defaultEndTime.value) {
            defaultStartTime.value = '18:00';  // 6 PM
            defaultEndTime.value = '03:00';    // 3 AM
        }
    }

    // Function to check if times indicate a night shift
    function checkNightShift() {
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        
        if (startTime && endTime) {
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            
            if (end < start && shiftTypeSelect.value !== 'NIGHT') {
                if (confirm('These times indicate a night shift. Would you like to change the shift type to Night Shift?')) {
                    shiftTypeSelect.value = 'NIGHT';
                    handleShiftTypeChange();
                }
            }
        }
    }

    // Add event listeners
    shiftTypeSelect.addEventListener('change', handleShiftTypeChange);
    [startTimeInput, endTimeInput].forEach(input => {
        input.addEventListener('change', checkNightShift);
    });

    // Initial state setup
    handleShiftTypeChange();

    // Form validation
    form.addEventListener('submit', function(e) {
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        
        if (startTime === endTime) {
            e.preventDefault();
            alert('Start time and end time cannot be the same');
            return;
        }
    });
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\shifts\shift_list.html
```{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Shifts Schedule</h5>
            <div>
                <a href="{% url 'attendance:shift_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Shift
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="shiftTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="shifts-tab" data-bs-toggle="tab" data-bs-target="#shifts" 
                        type="button" role="tab" aria-controls="shifts" aria-selected="true">
                    Shift Types
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" 
                        type="button" role="tab" aria-controls="calendar" aria-selected="false">
                    Schedule Calendar
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="shiftTabsContent">
            <!-- Shifts Tab -->
            <div class="tab-pane fade show active" id="shifts" role="tabpanel" aria-labelledby="shifts-tab">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Timing</th>
                                <th>Grace Period</th>
                                <th>Break Duration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shift in shifts %}
                            <tr>
                                <td>{{ shift.name }}</td>
                                <td>{{ shift.get_shift_type_display }}</td>
                                <td>
                                    {{ shift.start_time|time:"g:i A" }} - {{ shift.end_time|time:"g:i A" }}
                                </td>
                                <td>{{ shift.grace_period }} minutes</td>
                                <td>{{ shift.break_duration }} minutes</td>
                                <td>
                                    <span class="badge {% if shift.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if shift.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'attendance:shift_edit' shift.id %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No shifts found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Calendar Tab -->
            <div class="tab-pane fade" id="calendar" role="tabpanel" aria-labelledby="calendar-tab">
                <!-- Legend -->
                <div class="mb-3">
                    <span class="badge bg-primary me-2">Default Shift (7AM-4PM)</span>
                    <span class="badge bg-success me-2">Open Shift</span>
                    <span class="badge bg-dark me-2">Night Shift (6PM-3AM)</span>
                    <span class="badge bg-warning me-2">Override Night Shift</span>
                </div>

                <!-- Month Navigation -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-sm btn-outline-secondary" id="prevMonth">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <h5 class="mb-0" id="currentMonth"></h5>
                    <button class="btn btn-sm btn-outline-secondary" id="nextMonth">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    <div class="calendar-header">
                        <div>Sun</div>
                        <div>Mon</div>
                        <div>Tue</div>
                        <div>Wed</div>
                        <div>Thu</div>
                        <div>Fri</div>
                        <div>Sat</div>
                    </div>
                    <div id="calendarDays" class="calendar-days"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Override Modal -->
<div class="modal fade" id="overrideModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Override Night Shift</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="overrideForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="date" id="overrideDate">
                    <div class="mb-3">
                        <label class="form-label">Selected Date: <span id="selectedDate"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="startTime" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="startTime" name="start_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="endTime" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="endTime" name="end_time" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="removeOverride">Remove Override</button>
                <button type="submit" form="overrideForm" class="btn btn-primary">Save Override</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.calendar-grid {
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #f8f9fa;
    padding: 10px;
    text-align: center;
    font-weight: bold;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #dee2e6;
}

.calendar-day {
    background: white;
    padding: 10px;
    min-height: 100px;
}

.calendar-day.other-month {
    background: #f8f9fa;
    color: #6c757d;
}

.shift-time {
    font-size: 0.8rem;
    margin: 2px 0;
    padding: 2px 4px;
    border-radius: 3px;
}

.shift-default { background-color: #cfe2ff; }
.shift-open { background-color: #d1e7dd; }
.shift-night { background-color: #212529; color: white; }
.shift-override { background-color: #fff3cd; }

.calendar-day:hover {
    background: #f8f9fa;
    cursor: pointer;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentDate = new Date();
let overrides = {};  // Will store override data from the server

function updateCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update month display
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
    document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
    
    // Calculate dates
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startingDay = firstDay.getDay();
    
    // Generate calendar
    let calendarHTML = '';
    let day = 1;
    
    // Previous month days
    const prevMonthDays = new Date(year, month, 0).getDate();
    for (let i = startingDay - 1; i >= 0; i--) {
        const prevDay = prevMonthDays - i;
        calendarHTML += `
            <div class="calendar-day other-month">
                <div>${prevDay}</div>
            </div>
        `;
    }
    
    // Current month days
    while (day <= lastDay.getDate()) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasOverride = overrides[dateStr];
        
        calendarHTML += `
            <div class="calendar-day" data-date="${dateStr}">
                <div>${day}</div>
                <div class="shift-time shift-default">Default: 7AM-4PM</div>
                <div class="shift-time shift-open">Open Shift</div>
                ${hasOverride ? 
                    `<div class="shift-time shift-override">Night: ${hasOverride.start_time}-${hasOverride.end_time}</div>` :
                    `<div class="shift-time shift-night">Night: 6PM-3AM</div>`
                }
            </div>
        `;
        day++;
    }
    
    // Next month days
    const remainingDays = 42 - (startingDay + lastDay.getDate());
    for (let i = 1; i <= remainingDays; i++) {
        calendarHTML += `
            <div class="calendar-day other-month">
                <div>${i}</div>
            </div>
        `;
    }
    
    document.getElementById('calendarDays').innerHTML = calendarHTML;
    
    // Add click handlers
    document.querySelectorAll('.calendar-day:not(.other-month)').forEach(day => {
        day.addEventListener('click', () => showOverrideModal(day.dataset.date));
    });
}

function showOverrideModal(date) {
    const modal = new bootstrap.Modal(document.getElementById('overrideModal'));
    document.getElementById('selectedDate').textContent = date;
    document.getElementById('overrideDate').value = date;
    
    // Set current override values if they exist
    const override = overrides[date];
    if (override) {
        document.getElementById('startTime').value = override.start_time;
        document.getElementById('endTime').value = override.end_time;
        document.getElementById('removeOverride').style.display = 'block';
    } else {
        document.getElementById('startTime').value = '18:00';
        document.getElementById('endTime').value = '03:00';
        document.getElementById('removeOverride').style.display = 'none';
    }
    
    modal.show();
}

// Event Listeners
document.getElementById('prevMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    updateCalendar();
    loadOverrides();
});

document.getElementById('nextMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    updateCalendar();
    loadOverrides();
});

document.getElementById('overrideForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/attendance/shift_override/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('overrideModal')).hide();
            loadOverrides();
        } else {
            alert('Error saving override');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving override');
    }
});

document.getElementById('removeOverride').addEventListener('click', async () => {
    const date = document.getElementById('overrideDate').value;
    
    try {
        const response = await fetch(`/attendance/shift_override/${date}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('overrideModal')).hide();
            loadOverrides();
        } else {
            alert('Error removing override');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error removing override');
    }
});

async function loadOverrides() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    
    try {
        const response = await fetch(`/attendance/shift_overrides/${year}/${month}/`);
        if (response.ok) {
            overrides = await response.json();
            updateCalendar();
        }
    } catch (error) {
        console.error('Error loading overrides:', error);
    }
}

// Initial load
updateCalendar();
loadOverrides();
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\attendance\upload_attendance.html
```{% extends "core/base.html" %}
{% load static %}

{% block title %}Upload Attendance Records{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
.preview-table {
    font-size: 0.875rem;
}
.preview-table th {
    background-color: #f8f9fa;
}
.preview-container {
    max-height: 300px;
    overflow-y: auto;
    overflow-x: auto;
}
.new-employees-list {
    max-height: 200px;
    overflow-y: auto;
}
.small {
    font-size: 0.75em;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Upload Attendance Records</h5>
        </div>
        <div class="card-body">
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="file" class="form-label">Excel File</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls" required>
                    <div class="form-text">
                        <strong>Required columns:</strong>
                        <ul class="mb-0">
                            <li>Date And Time</li>
                            <li>Personnel ID</li>
                            <li>Device Name</li>
                            <li>Event Point</li>
                            <li>Verify Type</li>
                            <li>Event Description</li>
                            <li>Remarks</li>
                        </ul>
                    </div>
                </div>
                
                <!-- File Preview -->
                <div id="previewContainer" class="mb-3" style="display: none;">
                    <h6>File Preview</h6>
                    <div class="preview-container">
                        <table class="table table-sm table-bordered preview-table">
                            <thead id="previewHeader"></thead>
                            <tbody id="previewBody"></tbody>
                        </table>
                    </div>
                    <small class="text-muted">Showing first 5 rows</small>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitBtn">Upload</button>
            </form>
            
            <!-- Result Messages -->
            <div id="successAlert" class="alert alert-success mt-3" style="display: none;">
                <h6 class="alert-heading mb-2">Upload Summary:</h6>
                <ul class="mb-0">
                    <li>New records added: <span id="newRecords">0</span></li>
                    <li>Duplicate records skipped: <span id="duplicateRecords">0</span></li>
                    <li>Total records in database: <span id="totalRecords">0</span></li>
                    <li>Attendance logs created: <span id="logsCreated">0</span></li>
                </ul>
                
                <!-- New Employees Section -->
                <div id="newEmployeesSection" class="mt-3" style="display: none;">
                    <h6 class="alert-heading mb-2">New Employees Created:</h6>
                    <div class="new-employees-list">
                        <table class="table table-sm table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Personnel ID</th>
                                    <th>Name</th>
                                </tr>
                            </thead>
                            <tbody id="newEmployeesList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="errorAlert" class="alert alert-danger mt-3" style="display: none;">
                <div id="errorMessage"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// Preview functionality
document.getElementById('file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // Get first sheet
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            
            if (jsonData.length > 0) {
                const headerRow = jsonData[0];
                const dataRows = jsonData.slice(1, 6); // Get first 5 data rows
                
                // Create header
                const headerHtml = '<tr>' + headerRow.map(cell => 
                    `<th>${cell}</th>`
                ).join('') + '</tr>';
                
                // Create body
                const bodyHtml = dataRows.map(row => 
                    '<tr>' + row.map(cell => 
                        `<td>${cell || ''}</td>`
                    ).join('') + '</tr>'
                ).join('');
                
                // Update preview
                document.getElementById('previewHeader').innerHTML = headerHtml;
                document.getElementById('previewBody').innerHTML = bodyHtml;
                document.getElementById('previewContainer').style.display = 'block';
            }
        } catch (error) {
            console.error('Error reading file:', error);
        }
    };
    reader.readAsArrayBuffer(file);
});

// Form submission
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const successAlert = document.getElementById('successAlert');
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    const submitBtn = document.getElementById('submitBtn');
    const newEmployeesSection = document.getElementById('newEmployeesSection');
    
    // Hide any existing alerts
    successAlert.style.display = 'none';
    errorAlert.style.display = 'none';
    newEmployeesSection.style.display = 'none';
    
    // Disable submit button and show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
    
    fetch('/attendance/api/records/upload_excel/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('newRecords').textContent = data.new_records;
            document.getElementById('duplicateRecords').textContent = data.duplicate_records;
            document.getElementById('totalRecords').textContent = data.total_records;
            document.getElementById('logsCreated').textContent = data.logs_created;
            
            // Display new employees if any
            if (data.new_employees && data.new_employees.length > 0) {
                const newEmployeesList = document.getElementById('newEmployeesList');
                newEmployeesList.innerHTML = data.new_employees.map(emp => `
                    <tr>
                        <td>${emp.id}</td>
                        <td>${emp.employee_number}</td>
                        <td>
                            <a href="/employees/${emp.id}/" class="text-decoration-none">
                                ${emp.name}
                                <i class="fas fa-external-link-alt ms-1 small"></i>
                            </a>
                        </td>
                    </tr>
                `).join('');
                newEmployeesSection.style.display = 'block';
            }
            
            successAlert.style.display = 'block';
            this.reset();
            document.getElementById('previewContainer').style.display = 'none';
        } else {
            errorMessage.textContent = data.error;
            errorAlert.style.display = 'block';
        }
    })
    .catch(error => {
        errorMessage.textContent = 'Error uploading file: ' + error.message;
        errorAlert.style.display = 'block';
    })
    .finally(() => {
        // Re-enable submit button and restore text
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Upload';
    });
});
</script>
{% endblock %}

```

### 📄 hrms_project\attendance\templates\base.html
```{% extends 'core/base.html' %}
{% load static %}

{% block extra_css %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<!-- Custom attendance CSS -->
<link href="{% static 'attendance/css/attendance.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2">
            <div class="list-group">
                <a href="{% url 'attendance:attendance_list' %}" 
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'attendance_list' %}active{% endif %}">
                    <i class="fas fa-clock"></i> Daily Attendance
                </a>
                <a href="{% url 'attendance:mark_attendance' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'mark_attendance' %}active{% endif %}">
                    <i class="fas fa-edit"></i> Mark Attendance
                </a>
                <a href="{% url 'attendance:shift_list' %}"
                   class="list-group-item list-group-item-action {% if 'shift' in request.resolver_match.url_name %}active{% endif %}">
                    <i class="fas fa-business-time"></i> Shift Management
                </a>
                <a href="{% url 'attendance:leave_request_list' %}"
                   class="list-group-item list-group-item-action {% if 'leave' in request.resolver_match.view_name %}active{% endif %}">
                    <i class="fas fa-calendar-minus"></i> Leave Management
                </a>
                <a href="{% url 'attendance:calendar' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'calendar' %}active{% endif %}">
                    <i class="fas fa-calendar-alt"></i> Calendar View
                </a>
                <a href="{% url 'attendance:upload_attendance' %}"
                   class="list-group-item list-group-item-action {% if request.resolver_match.url_name == 'upload_attendance' %}active{% endif %}">
                    <i class="fas fa-upload"></i> Upload Attendance
                </a>
            </div>

            <!-- Status Legend -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Status Legend</h6>
                </div>
                <div class="card-body p-2">
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot bg-success"></div>
                        <span class="ms-2">Present</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot bg-danger"></div>
                        <span class="ms-2">Absent</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot bg-warning"></div>
                        <span class="ms-2">Late</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="status-dot bg-info"></div>
                        <span class="ms-2">Leave</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="status-dot bg-primary"></div>
                        <span class="ms-2">Holiday</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            {% block attendance_content %}{% endblock %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- FullCalendar Bundle -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<!-- Custom attendance JS -->
<script src="{% static 'attendance/js/attendance.js' %}"></script>
{% endblock %}

```

### 📄 hrms_project\attendance\templatetags\__init__.py
```"""
Template tags for attendance app.

Available template tags:
- format_time: Format time object as HH:MM AM/PM
- format_duration: Format duration in days, handling half days
- attendance_status_badge: Return HTML badge for attendance status
- leave_type_badge: Return HTML badge for leave type
- leave_balance_display: Display leave balance with consumed/remaining days
- monthly_attendance_summary: Generate monthly attendance summary
- is_holiday: Check if a date is a holiday
- get_leave_status: Get leave status for a date
- attendance_date_class: Return CSS class for calendar date based on attendance

Usage:
    {% load attendance_tags %}
    
    {{ time_value|format_time }}
    {{ duration_value|format_duration }}
    
    {% attendance_status_badge status is_late %}
    {% leave_type_badge leave_type %}
    {% leave_balance_display employee leave_type %}
    {% monthly_attendance_summary employee year month %}
    {% is_holiday date %}
    {% get_leave_status employee date %}
    {{ date|attendance_date_class:employee }}
"""

```

### 📄 hrms_project\attendance\templatetags\attendance_tags.py
```from django import template
from django.utils import timezone
from django.utils.html import format_html
from datetime import datetime, time

from attendance.services import ShiftService, RamadanService
from attendance.models import AttendanceLog, Leave, Holiday

register = template.Library()

@register.filter
def format_time(value):
    """Format time object to 12-hour format"""
    if not value:
        return '-'
    if isinstance(value, str):
        try:
            value = datetime.strptime(value, '%H:%M:%S').time()
        except ValueError:
            return value
    return value.strftime('%I:%M %p')

@register.filter
def total_hours(minutes):
    """Convert minutes to hours and minutes format"""
    if not minutes:
        return '-'
    hours = minutes // 60
    remaining_minutes = minutes % 60
    return f"{hours}h {remaining_minutes}m"

@register.simple_tag
def get_attendance_status(employee, date=None):
    """Get attendance status with styled badge"""
    if not date:
        date = timezone.now().date()
    
    log = AttendanceLog.objects.filter(employee=employee, date=date).first()
    
    if not log:
        return format_html(
            '<span class="badge bg-secondary">No Record</span>'
        )
    
    if log.is_leave:
        return format_html(
            '<span class="badge bg-info">Leave</span>'
        )
    elif log.is_holiday:
        return format_html(
            '<span class="badge bg-primary">Holiday</span>'
        )
    elif not log.first_in_time:
        return format_html(
            '<span class="badge bg-danger">Absent</span>'
        )
    elif log.is_late:
        return format_html(
            '<span class="badge bg-warning text-dark">Late</span>'
        )
    else:
        return format_html(
            '<span class="badge bg-success">Present</span>'
        )

@register.simple_tag
def get_current_shift(employee, date=None):
    """Get employee's current shift with timing"""
    if not date:
        date = timezone.now().date()
    
    shift = ShiftService.get_employee_current_shift(employee)
    if not shift:
        return format_html(
            '<span class="text-muted">No Shift Assigned</span>'
        )
    
    # Check for Ramadan timing
    ramadan_timing = RamadanService.get_ramadan_shift_timing(shift, date)
    if ramadan_timing:
        start_time = ramadan_timing['start_time']
        end_time = ramadan_timing['end_time']
        return format_html(
            '{} ({} - {}) <span class="badge bg-info ms-1">Ramadan</span>',
            shift.name,
            format_time(start_time),
            format_time(end_time)
        )
    
    return format_html(
        '{} ({} - {})',
        shift.name,
        format_time(shift.start_time),
        format_time(shift.end_time)
    )

@register.simple_tag
def get_leave_balance(employee, leave_type):
    """Get employee's leave balance with color coding"""
    balance = employee.get_leave_balance(leave_type)
    color = 'success'
    if balance <= 0:
        color = 'danger'
    elif balance <= 5:
        color = 'warning'
        
    return format_html(
        '<span class="text-{}">{} days</span>',
        color, balance
    )

@register.filter
def is_holiday(date):
    """Check if date is a holiday"""
    return Holiday.objects.filter(date=date, is_active=True).exists()

@register.filter
def is_leave(employee, date):
    """Check if employee is on leave for given date"""
    return Leave.objects.filter(
        employee=employee,
        start_date__lte=date,
        end_date__gte=date,
        status='APPROVED'
    ).exists()

@register.filter
def attendance_timing(log):
    """Format attendance timing with status indicators"""
    if not log:
        return '-'
        
    in_time = format_time(log.first_in_time) if log.first_in_time else '-'
    out_time = format_time(log.last_out_time) if log.last_out_time else '-'
    
    timing = f"{in_time} - {out_time}"
    
    status_indicators = []
    if log.is_late:
        status_indicators.append(
            f'<span class="badge bg-warning text-dark ms-1" title="Late by {log.late_minutes} minutes">Late</span>'
        )
    if log.early_departure:
        status_indicators.append(
            f'<span class="badge bg-warning text-dark ms-1" title="Left early by {log.early_minutes} minutes">Early Out</span>'
        )
    
    if status_indicators:
        timing += ' ' + ' '.join(status_indicators)
    
    return format_html(timing)

@register.simple_tag
def shift_timing_display(shift, date=None):
    """Display shift timing with Ramadan adjustment if applicable"""
    if not date:
        date = timezone.now().date()
        
    ramadan_timing = RamadanService.get_ramadan_shift_timing(shift, date)
    if ramadan_timing:
        return format_html(
            '{} - {} <span class="badge bg-info ms-1">Ramadan</span>',
            format_time(ramadan_timing['start_time']),
            format_time(ramadan_timing['end_time'])
        )
    
    return format_html(
        '{} - {}',
        format_time(shift.start_time),
        format_time(shift.end_time)
    )

@register.filter
def work_hours_display(log):
    """Display work hours with color coding based on expected hours"""
    if not log or not log.total_work_minutes:
        return '-'
        
    expected_minutes = log.expected_work_minutes or 480  # Default 8 hours
    actual_minutes = log.total_work_minutes
    
    hours = actual_minutes / 60
    
    if actual_minutes >= expected_minutes:
        color = 'success'
    elif actual_minutes >= (expected_minutes * 0.75):
        color = 'warning'
    else:
        color = 'danger'
        
    return format_html(
        '<span class="text-{}">{:.1f}h</span>',
        color, hours
    )

@register.simple_tag(takes_context=True)
def get_shift_assignments(context, employee):
    """Get list of shift assignments for display"""
    assignments = employee.shiftassignment_set.filter(
        is_active=True
    ).select_related('shift').order_by('-start_date')[:5]
    
    result = []
    for assignment in assignments:
        timing = shift_timing_display(assignment.shift)
        period = "Permanent" if not assignment.end_date else f"Until {assignment.end_date.strftime('%b %d, %Y')}"
        
        result.append({
            'shift': assignment.shift.name,
            'timing': timing,
            'period': period,
            'start_date': assignment.start_date
        })
    
    return result

```

### 📄 hrms_project\attendance\tests\test_cache.py
```from datetime import date, datetime, timedelta
from django.test import TestCase, override_settings
from django.core.cache import cache
from django.contrib.auth.models import User
from django.utils import timezone

from employees.models import Employee, Department
from attendance.models import Shift, ShiftAssignment, RamadanPeriod
from attendance.cache import (
    ShiftCache, RamadanCache, AttendanceMetricsCache,
    invalidate_employee_caches, invalidate_department_caches,
    warm_employee_caches
)

@override_settings(CACHES={
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
    }
})
class CacheTests(TestCase):
    def setUp(self):
        # Clear cache before each test
        cache.clear()
        
        # Create test user
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass'
        )
        
        # Create test department
        self.department = Department.objects.create(
            name='Test Department'
        )
        
        # Create test employee
        self.employee = Employee.objects.create(
            employee_number='EMP001',
            first_name='Test',
            last_name='Employee',
            department=self.department
        )
        
        # Create test shift
        self.shift = Shift.objects.create(
            name='Day Shift',
            shift_type='REGULAR',
            start_time='09:00',
            end_time='17:00',
            break_duration=60,
            grace_period=15
        )
        
        # Create shift assignment
        self.assignment = ShiftAssignment.objects.create(
            employee=self.employee,
            shift=self.shift,
            start_date=date.today(),
            created_by=self.user
        )
        
        # Create Ramadan period
        self.ramadan_period = RamadanPeriod.objects.create(
            year=2025,
            start_date=date(2025, 3, 1),
            end_date=date(2025, 3, 30),
            is_active=True
        )

    def test_shift_cache(self):
        """Test shift caching functionality"""
        # Test employee shift caching
        shift_data = {
            'id': self.shift.id,
            'name': self.shift.name,
            'start_time': self.shift.start_time,
            'end_time': self.shift.end_time
        }
        
        # Set cache
        ShiftCache.set_employee_shift(self.employee.id, shift_data)
        
        # Get from cache
        cached_shift = ShiftCache.get_employee_shift(self.employee.id)
        self.assertEqual(cached_shift['id'], self.shift.id)
        
        # Clear cache
        ShiftCache.clear_employee_shift(self.employee.id)
        self.assertIsNone(ShiftCache.get_employee_shift(self.employee.id))
        
        # Test department shifts caching
        dept_shifts = {
            'Day Shift': [{
                'employee_id': self.employee.id,
                'employee_name': str(self.employee)
            }]
        }
        
        ShiftCache.set_department_shifts(self.department.id, dept_shifts)
        cached_dept_shifts = ShiftCache.get_department_shifts(self.department.id)
        self.assertEqual(
            cached_dept_shifts['Day Shift'][0]['employee_id'],
            self.employee.id
        )

    def test_ramadan_cache(self):
        """Test Ramadan period caching"""
        target_date = date(2025, 3, 15)
        period_data = {
            'id': self.ramadan_period.id,
            'start_date': self.ramadan_period.start_date,
            'end_date': self.ramadan_period.end_date
        }
        
        # Set cache
        RamadanCache.set_active_period(target_date, period_data)
        
        # Get from cache
        cached_period = RamadanCache.get_active_period(target_date)
        self.assertEqual(cached_period['id'], self.ramadan_period.id)
        
        # Clear specific date
        RamadanCache.clear_active_period(target_date)
        self.assertIsNone(RamadanCache.get_active_period(target_date))
        
        # Test clear all periods
        RamadanCache.set_active_period(target_date, period_data)
        RamadanCache.clear_all_periods()
        self.assertIsNone(RamadanCache.get_active_period(target_date))

    def test_attendance_metrics_cache(self):
        """Test attendance metrics caching"""
        today = date.today().isoformat()
        metrics_data = {
            'total': 10,
            'present': 8,
            'absent': 2,
            'late': 1
        }
        
        # Test without department
        AttendanceMetricsCache.set_metrics(today, metrics_data)
        cached_metrics = AttendanceMetricsCache.get_metrics(today)
        self.assertEqual(cached_metrics['total'], 10)
        
        # Test with department
        dept_metrics = {**metrics_data, 'department_id': self.department.id}
        AttendanceMetricsCache.set_metrics(today, dept_metrics, self.department.id)
        cached_dept_metrics = AttendanceMetricsCache.get_metrics(today, self.department.id)
        self.assertEqual(cached_dept_metrics['department_id'], self.department.id)
        
        # Test clear metrics
        AttendanceMetricsCache.clear_metrics(today, self.department.id)
        self.assertIsNone(
            AttendanceMetricsCache.get_metrics(today, self.department.id)
        )

    def test_cache_invalidation(self):
        """Test cache invalidation functions"""
        # Setup test data
        shift_data = {'id': self.shift.id, 'name': self.shift.name}
        metrics_data = {'total': 10, 'present': 8}
        today = date.today()
        
        # Set various caches
        ShiftCache.set_employee_shift(self.employee.id, shift_data)
        AttendanceMetricsCache.set_metrics(
            today.isoformat(),
            metrics_data,
            self.department.id
        )
        
        # Test employee cache invalidation
        invalidate_employee_caches(self.employee.id)
        self.assertIsNone(ShiftCache.get_employee_shift(self.employee.id))
        
        # Test department cache invalidation
        ShiftCache.set_department_shifts(self.department.id, {'shifts': []})
        invalidate_department_caches(self.department.id)
        self.assertIsNone(ShiftCache.get_department_shifts(self.department.id))
        self.assertIsNone(
            AttendanceMetricsCache.get_metrics(
                today.isoformat(),
                self.department.id
            )
        )

    def test_cache_warming(self):
        """Test cache warming functionality"""
        # Clear any existing cache
        ShiftCache.clear_employee_shift(self.employee.id)
        
        # Warm the cache
        warm_employee_caches(self.employee.id)
        
        # Check if cache was warmed
        cached_shift = ShiftCache.get_employee_shift(self.employee.id)
        self.assertIsNotNone(cached_shift)
        
        # Verify cached data
        self.assertEqual(cached_shift['id'], self.shift.id)

```

### 📄 hrms_project\attendance\tests\test_cleanup_shifts.py
```import os
from datetime import date, timedelta
from django.test import TestCase, override_settings
from django.core.management import call_command
from django.contrib.auth.models import User
from django.utils import timezone
from django.core.cache import cache
from io import StringIO

from employees.models import Employee, Department
from attendance.models import Shift, ShiftAssignment, RamadanPeriod
from attendance.cache import ShiftCache, RamadanCache

@override_settings(CACHES={
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
    }
})
class CleanupShiftsTest(TestCase):
    def setUp(self):
        # Clear cache
        cache.clear()
        
        # Create test user
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass'
        )
        
        # Create department
        self.department = Department.objects.create(
            name='Test Department'
        )
        
        # Create test employee
        self.employee = Employee.objects.create(
            employee_number='EMP001',
            first_name='Test',
            last_name='Employee',
            department=self.department
        )
        
        # Create test shifts
        self.day_shift = Shift.objects.create(
            name='Day Shift',
            shift_type='REGULAR',
            start_time='09:00',
            end_time='17:00',
            break_duration=60
        )
        
        self.night_shift = Shift.objects.create(
            name='Night Shift',
            shift_type='NIGHT',
            start_time='22:00',
            end_time='06:00',
            break_duration=60
        )
        
        # Create assignments
        self.old_assignment = ShiftAssignment.objects.create(
            employee=self.employee,
            shift=self.day_shift,
            start_date=date.today() - timedelta(days=100),
            end_date=date.today() - timedelta(days=95),
            is_active=False,
            created_by=self.user
        )
        
        self.current_assignment = ShiftAssignment.objects.create(
            employee=self.employee,
            shift=self.night_shift,
            start_date=date.today(),
            created_by=self.user,
            is_active=True
        )
        
        # Create Ramadan periods
        self.old_ramadan = RamadanPeriod.objects.create(
            year=2023,
            start_date=date(2023, 3, 22),
            end_date=date(2023, 4, 20),
            is_active=False
        )
        
        self.current_ramadan = RamadanPeriod.objects.create(
            year=2025,
            start_date=date(2025, 3, 1),
            end_date=date(2025, 3, 30),
            is_active=True
        )

    def test_cleanup_old_assignments(self):
        """Test cleanup of old shift assignments"""
        out = StringIO()
        call_command('cleanup_shifts', '--force', stdout=out)
        
        # Old assignment should be deleted
        self.assertFalse(
            ShiftAssignment.objects.filter(id=self.old_assignment.id).exists()
        )
        
        # Current assignment should remain
        self.assertTrue(
            ShiftAssignment.objects.filter(id=self.current_assignment.id).exists()
        )
        
        # Check output
        output = out.getvalue()
        self.assertIn('Found 1 old shift assignments', output)

    def test_cleanup_ramadan_periods(self):
        """Test cleanup of old Ramadan periods"""
        out = StringIO()
        call_command('cleanup_shifts', '--force', stdout=out)
        
        # Old period should be deleted
        self.assertFalse(
            RamadanPeriod.objects.filter(id=self.old_ramadan.id).exists()
        )
        
        # Current period should remain
        self.assertTrue(
            RamadanPeriod.objects.filter(id=self.current_ramadan.id).exists()
        )
        
        # Check output
        output = out.getvalue()
        self.assertIn('Found 1 old Ramadan periods', output)

    def test_cleanup_orphaned_shifts(self):
        """Test cleanup of orphaned shifts"""
        # Create orphaned shift
        orphaned_shift = Shift.objects.create(
            name='Orphaned Shift',
            shift_type='REGULAR',
            start_time='10:00',
            end_time='18:00'
        )
        
        out = StringIO()
        call_command('cleanup_shifts', '--force', stdout=out)
        
        # Orphaned shift should be deleted
        self.assertFalse(
            Shift.objects.filter(id=orphaned_shift.id).exists()
        )
        
        # Used shifts should remain
        self.assertTrue(
            Shift.objects.filter(id=self.day_shift.id).exists()
        )
        
        # Check output
        output = out.getvalue()
        self.assertIn('Found 1 orphaned shifts', output)

    def test_cleanup_duplicate_assignments(self):
        """Test cleanup of duplicate active assignments"""
        # Create duplicate active assignment
        duplicate = ShiftAssignment.objects.create(
            employee=self.employee,
            shift=self.day_shift,
            start_date=date.today() + timedelta(days=1),
            created_by=self.user,
            is_active=True
        )
        
        out = StringIO()
        call_command('cleanup_shifts', '--force', stdout=out)
        
        # Check only one active assignment remains
        active_count = ShiftAssignment.objects.filter(
            employee=self.employee,
            is_active=True
        ).count()
        self.assertEqual(active_count, 1)
        
        # Most recent should be active
        duplicate.refresh_from_db()
        self.assertTrue(duplicate.is_active)
        
        self.current_assignment.refresh_from_db()
        self.assertFalse(self.current_assignment.is_active)
        
        # Check output
        output = out.getvalue()
        self.assertIn('Found 1 employees with multiple active assignments', output)

    def test_dry_run(self):
        """Test dry run option"""
        initial_assignment_count = ShiftAssignment.objects.count()
        
        out = StringIO()
        call_command('cleanup_shifts', '--dry-run', stdout=out)
        
        # No data should be deleted
        self.assertEqual(
            ShiftAssignment.objects.count(),
            initial_assignment_count
        )
        
        # Check output
        output = out.getvalue()
        self.assertIn('DRY RUN - No data will be deleted', output)

    def test_archiving(self):
        """Test data archiving"""
        out = StringIO()
        call_command('cleanup_shifts', '--force', '--archive', stdout=out)
        
        # Check archive files were created
        files = os.listdir('.')
        archive_files = [f for f in files if f.startswith(('shift_assignments_archive_', 'ramadan_periods_archive_'))]
        
        self.assertTrue(any(f.startswith('shift_assignments_archive_') for f in archive_files))
        self.assertTrue(any(f.startswith('ramadan_periods_archive_') for f in archive_files))
        
        # Clean up archive files
        for f in archive_files:
            os.remove(f)

    def test_cache_clearing(self):
        """Test cache clearing during cleanup"""
        # Set some cache data
        ShiftCache.set_employee_shift(self.employee.id, {'shift_id': self.day_shift.id})
        RamadanCache.set_active_period(date.today(), {'id': self.current_ramadan.id})
        
        # Run cleanup
        call_command('cleanup_shifts', '--force')
        
        # Cache should be cleared
        self.assertIsNone(ShiftCache.get_employee_shift(self.employee.id))
        self.assertIsNone(RamadanCache.get_active_period(date.today()))

    def tearDown(self):
        # Clean up any archive files
        files = os.listdir('.')
        archive_files = [f for f in files if f.startswith(('shift_assignments_archive_', 'ramadan_periods_archive_'))]
        for f in archive_files:
            os.remove(f)

```

### 📄 hrms_project\attendance\tests\test_ramadan.py
```from datetime import datetime, date, time, timedelta
from django.test import TestCase
from django.contrib.auth.models import User
from django.utils import timezone

from employees.models import Employee, Department
from attendance.models import Shift, RamadanPeriod
from attendance.services import ShiftService, RamadanService

class RamadanTests(TestCase):
    def setUp(self):
        # Create test shift
        self.shift = Shift.objects.create(
            name='Regular Shift',
            shift_type='REGULAR',
            start_time=time(8, 0),
            end_time=time(17, 0),
            break_duration=60,
            grace_period=15
        )
        
        # Create test Ramadan period
        self.current_year = timezone.now().year
        self.ramadan_start = date(self.current_year, 3, 1)
        self.ramadan_end = date(self.current_year, 3, 30)
        
        self.ramadan_period = RamadanPeriod.objects.create(
            year=self.current_year,
            start_date=self.ramadan_start,
            end_date=self.ramadan_end,
            is_active=True
        )

    def test_ramadan_period_creation(self):
        """Test Ramadan period creation and validation"""
        # Test valid period
        period = RamadanService.create_period(
            year=self.current_year + 1,
            start_date=date(self.current_year + 1, 2, 15),
            end_date=date(self.current_year + 1, 3, 15)
        )
        self.assertTrue(period.is_active)
        self.assertEqual(period.year, self.current_year + 1)
        
        # Test invalid year
        with self.assertRaises(ValueError):
            RamadanService.create_period(
                year=self.current_year + 1,
                start_date=date(self.current_year, 2, 15),  # Different year
                end_date=date(self.current_year + 1, 3, 15)
            )
        
        # Test invalid duration
        with self.assertRaises(ValueError):
            RamadanService.create_period(
                year=self.current_year + 1,
                start_date=date(self.current_year + 1, 2, 15),
                end_date=date(self.current_year + 1, 4, 15)  # Too long
            )

    def test_overlapping_periods(self):
        """Test prevention of overlapping Ramadan periods"""
        # Try to create overlapping period
        with self.assertRaises(ValueError):
            RamadanService.create_period(
                year=self.current_year,
                start_date=date(self.current_year, 3, 15),  # Overlaps with existing period
                end_date=date(self.current_year, 4, 15)
            )

    def test_ramadan_shift_timing(self):
        """Test shift timing adjustments during Ramadan"""
        # Test during Ramadan period
        ramadan_date = self.ramadan_start + timedelta(days=5)
        timing = RamadanService.get_ramadan_shift_timing(self.shift, ramadan_date)
        
        self.assertIsNotNone(timing)
        self.assertEqual(timing['start_time'], self.shift.start_time)
        # End time should be 2 hours earlier
        expected_end = (
            datetime.combine(date.today(), self.shift.end_time) - timedelta(hours=2)
        ).time()
        self.assertEqual(timing['end_time'], expected_end)
        
        # Test outside Ramadan period
        non_ramadan_date = self.ramadan_end + timedelta(days=5)
        timing = RamadanService.get_ramadan_shift_timing(self.shift, non_ramadan_date)
        self.assertIsNone(timing)

    def test_active_period_detection(self):
        """Test finding active Ramadan period for a date"""
        # Test during Ramadan
        ramadan_date = self.ramadan_start + timedelta(days=5)
        active_period = RamadanService.get_active_period(ramadan_date)
        self.assertEqual(active_period, self.ramadan_period)
        
        # Test outside Ramadan
        non_ramadan_date = self.ramadan_end + timedelta(days=5)
        active_period = RamadanService.get_active_period(non_ramadan_date)
        self.assertIsNone(active_period)
        
        # Test with inactive period
        self.ramadan_period.is_active = False
        self.ramadan_period.save()
        active_period = RamadanService.get_active_period(ramadan_date)
        self.assertIsNone(active_period)

    def test_working_hours_calculation(self):
        """Test working hours adjustment during Ramadan"""
        normal_hours = 8.0
        
        # Test Ramadan hours
        ramadan_hours = RamadanService.calculate_working_hours(
            normal_hours=normal_hours,
            is_ramadan=True
        )
        self.assertEqual(ramadan_hours, 6.0)  # 2 hours less
        
        # Test non-Ramadan hours
        regular_hours = RamadanService.calculate_working_hours(
            normal_hours=normal_hours,
            is_ramadan=False
        )
        self.assertEqual(regular_hours, normal_hours)
        
        # Test minimum hours
        short_hours = RamadanService.calculate_working_hours(
            normal_hours=5.0,
            is_ramadan=True
        )
        self.assertEqual(short_hours, 4.0)  # Minimum allowed

    def test_period_validation(self):
        """Test comprehensive period date validation"""
        # Test same year requirement
        with self.assertRaises(ValueError):
            RamadanService.validate_period_dates(
                start_date=date(2024, 12, 31),
                end_date=date(2025, 1, 30),
                year=2024
            )
        
        # Test duration limits
        with self.assertRaises(ValueError):
            RamadanService.validate_period_dates(
                start_date=date(2024, 3, 1),
                end_date=date(2024, 4, 15),  # Too long
                year=2024
            )
        
        # Test valid period
        result = RamadanService.validate_period_dates(
            start_date=date(2024, 3, 1),
            end_date=date(2024, 3, 29),
            year=2024
        )
        self.assertTrue(result)

    def test_period_update(self):
        """Test updating existing Ramadan period"""
        new_start = date(self.current_year, 4, 1)
        new_end = date(self.current_year, 4, 29)
        
        updated_period = RamadanService.update_period(
            period_id=self.ramadan_period.id,
            year=self.current_year,
            start_date=new_start,
            end_date=new_end,
            is_active=True
        )
        
        self.assertEqual(updated_period.start_date, new_start)
        self.assertEqual(updated_period.end_date, new_end)
        self.assertTrue(updated_period.is_active)

    def test_period_listing(self):
        """Test retrieving Ramadan period lists"""
        # Create additional period
        RamadanPeriod.objects.create(
            year=self.current_year + 1,
            start_date=date(self.current_year + 1, 2, 15),
            end_date=date(self.current_year + 1, 3, 15),
            is_active=False
        )
        
        # Test active only
        active_periods = RamadanService.get_all_periods(include_inactive=False)
        self.assertEqual(len(active_periods), 1)
        
        # Test including inactive
        all_periods = RamadanService.get_all_periods(include_inactive=True)
        self.assertEqual(len(all_periods), 2)
        
        # Check sorting
        self.assertGreater(all_periods[0]['year'], all_periods[1]['year'])

```

### 📄 hrms_project\attendance\tests\test_report_api.py
```from django.test import TestCase
from django.urls import reverse
from django.contrib.auth import get_user_model
from django.utils import timezone
from rest_framework.test import APIClient
from rest_framework import status
from datetime import datetime, date, timedelta

from attendance.models import (
    AttendanceLog, Leave, Holiday, LeaveType,
    Department, Employee
)

User = get_user_model()

class ReportAPITest(TestCase):
    def setUp(self):
        # Create test user
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass123',
            is_staff=True
        )
        
        # Set up API client
        self.client = APIClient()
        self.client.force_authenticate(user=self.user)
        
        # Create test data
        self.department = Department.objects.create(name="Test Department")
        self.employee = Employee.objects.create(
            first_name="John",
            last_name="Doe",
            employee_number="EMP001",
            department=self.department
        )
        
        self.leave_type = LeaveType.objects.create(
            name="Annual Leave",
            days_per_year=21
        )
        
        # Create test dates
        self.today = timezone.now().date()
        self.start_date = self.today - timedelta(days=7)
        self.end_date = self.today
        
        # Create attendance logs
        for i in range(8):
            date = self.today - timedelta(days=i)
            AttendanceLog.objects.create(
                employee=self.employee,
                date=date,
                first_in_time=timezone.datetime.strptime('09:00', '%H:%M').time(),
                last_out_time=timezone.datetime.strptime('17:00', '%H:%M').time(),
                is_present=True,
                is_late=False if i % 2 == 0 else True
            )
        
        # Create leave record
        Leave.objects.create(
            employee=self.employee,
            leave_type=self.leave_type,
            start_date=self.start_date,
            end_date=self.start_date + timedelta(days=1),
            status='approved'
        )
        
        # Create holiday
        Holiday.objects.create(
            date=self.start_date + timedelta(days=2),
            name="Test Holiday",
            description="Test Holiday Description",
            is_active=True
        )

    def test_attendance_report_endpoint(self):
        """Test attendance report generation endpoint"""
        url = reverse('report-attendance')
        params = {
            'start_date': self.start_date.strftime('%Y-%m-%d'),
            'end_date': self.end_date.strftime('%Y-%m-%d')
        }
        
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        
        data = response.json()
        self.assertIn('summary', data)
        self.assertIn('trend_data', data)
        self.assertIn('department_stats', data)
        self.assertIn('employee_records', data)

    def test_leave_report_endpoint(self):
        """Test leave report generation endpoint"""
        url = reverse('report-leave')
        params = {
            'start_date': self.start_date.strftime('%Y-%m-%d'),
            'end_date': self.end_date.strftime('%Y-%m-%d')
        }
        
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        
        data = response.json()
        self.assertIn('total_leaves', data)
        self.assertIn('leave_type_stats', data)

    def test_holiday_report_endpoint(self):
        """Test holiday report generation endpoint"""
        url = reverse('report-holiday')
        params = {
            'start_date': self.start_date.strftime('%Y-%m-%d'),
            'end_date': self.end_date.strftime('%Y-%m-%d')
        }
        
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        
        data = response.json()
        self.assertIn('total_holidays', data)
        self.assertIn('holidays', data)

    def test_export_endpoint(self):
        """Test report export endpoint"""
        url = reverse('report-export')
        
        # Test CSV export
        params = {
            'start_date': self.start_date.strftime('%Y-%m-%d'),
            'end_date': self.end_date.strftime('%Y-%m-%d'),
            'type': 'attendance',
            'format': 'csv'
        }
        
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response['Content-Type'], 'text/csv')
        
        # Test Excel export
        params['format'] = 'excel'
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(
            response['Content-Type'],
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        )
        
        # Test PDF export
        params['format'] = 'pdf'
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response['Content-Type'], 'application/pdf')

    def test_invalid_date_range(self):
        """Test report generation with invalid date range"""
        url = reverse('report-attendance')
        params = {
            'start_date': self.end_date.strftime('%Y-%m-%d'),
            'end_date': self.start_date.strftime('%Y-%m-%d')  # End date before start date
        }
        
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)

    def test_filter_parameters(self):
        """Test report generation with various filters"""
        url = reverse('report-attendance')
        params = {
            'start_date': self.start_date.strftime('%Y-%m-%d'),
            'end_date': self.end_date.strftime('%Y-%m-%d'),
            'departments': [self.department.id],
            'status': ['present', 'late']
        }
        
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_200_OK)
        
        data = response.json()
        self.assertTrue(all(
            record['department'] == self.department.name
            for record in data['employee_records']
        ))

    def test_authentication_required(self):
        """Test that authentication is required for report endpoints"""
        self.client.logout()
        
        url = reverse('report-attendance')
        params = {
            'start_date': self.start_date.strftime('%Y-%m-%d'),
            'end_date': self.end_date.strftime('%Y-%m-%d')
        }
        
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_401_UNAUTHORIZED)

    def test_export_with_invalid_format(self):
        """Test export endpoint with invalid format"""
        url = reverse('report-export')
        params = {
            'start_date': self.start_date.strftime('%Y-%m-%d'),
            'end_date': self.end_date.strftime('%Y-%m-%d'),
            'type': 'attendance',
            'format': 'invalid_format'
        }
        
        response = self.client.get(url, params)
        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)
```

### 📄 hrms_project\attendance\tests\test_report_services.py
```from django.test import TestCase
from django.utils import timezone
from datetime import datetime, date, timedelta
from django.core.files.base import ContentFile

from attendance.models import (
    AttendanceLog, Leave, Holiday, LeaveType,
    Department, Employee
)
from attendance.services.report_service import ReportService
from attendance.services.pdf_service import PDFReportService

class ReportServicesTest(TestCase):
    def setUp(self):
        # Create test data
        self.department = Department.objects.create(name="Test Department")
        self.employee = Employee.objects.create(
            first_name="John",
            last_name="Doe",
            employee_number="EMP001",
            department=self.department
        )
        
        self.leave_type = LeaveType.objects.create(
            name="Annual Leave",
            days_per_year=21
        )
        
        # Create attendance logs
        self.today = timezone.now().date()
        self.start_date = self.today - timedelta(days=7)
        self.end_date = self.today
        
        # Create attendance logs for the past week
        for i in range(8):
            date = self.today - timedelta(days=i)
            AttendanceLog.objects.create(
                employee=self.employee,
                date=date,
                first_in_time=timezone.datetime.strptime('09:00', '%H:%M').time(),
                last_out_time=timezone.datetime.strptime('17:00', '%H:%M').time(),
                is_present=True,
                is_late=False if i % 2 == 0 else True
            )
        
        # Create a leave record
        Leave.objects.create(
            employee=self.employee,
            leave_type=self.leave_type,
            start_date=self.start_date,
            end_date=self.start_date + timedelta(days=1),
            status='approved'
        )
        
        # Create a holiday
        Holiday.objects.create(
            date=self.start_date + timedelta(days=2),
            name="Test Holiday",
            description="Test Holiday Description",
            is_active=True
        )

    def test_attendance_report_generation(self):
        """Test attendance report generation"""
        report_data = ReportService.get_attendance_report(
            start_date=self.start_date,
            end_date=self.end_date
        )
        
        # Verify report structure and data
        self.assertIn('summary', report_data)
        self.assertIn('trend_data', report_data)
        self.assertIn('department_stats', report_data)
        self.assertIn('employee_records', report_data)
        
        # Verify summary counts
        summary = report_data['summary']
        self.assertIn('present', summary)
        self.assertIn('absent', summary)
        self.assertIn('late', summary)
        self.assertIn('leave', summary)
        
        # Verify employee records
        self.assertEqual(len(report_data['employee_records']), 1)
        record = report_data['employee_records'][0]
        self.assertEqual(record['name'], "John Doe")

    def test_leave_report_generation(self):
        """Test leave report generation"""
        report_data = ReportService.get_leave_report(
            start_date=self.start_date,
            end_date=self.end_date
        )
        
        # Verify leave report structure
        self.assertIn('total_leaves', report_data)
        self.assertIn('approved_leaves', report_data)
        self.assertIn('pending_leaves', report_data)
        self.assertIn('leave_type_stats', report_data)
        
        # Verify leave counts
        self.assertEqual(report_data['total_leaves'], 1)
        self.assertEqual(report_data['approved_leaves'], 1)

    def test_holiday_report_generation(self):
        """Test holiday report generation"""
        report_data = ReportService.get_holiday_report(
            start_date=self.start_date,
            end_date=self.end_date
        )
        
        # Verify holiday report structure
        self.assertIn('total_holidays', report_data)
        self.assertIn('holidays', report_data)
        
        # Verify holiday data
        self.assertEqual(report_data['total_holidays'], 1)
        self.assertEqual(len(report_data['holidays']), 1)
        self.assertEqual(report_data['holidays'][0]['name'], "Test Holiday")

    def test_pdf_generation(self):
        """Test PDF report generation"""
        # Generate attendance report data
        report_data = ReportService.get_attendance_report(
            start_date=self.start_date,
            end_date=self.end_date
        )
        
        # Test attendance report PDF
        pdf_content = PDFReportService.generate_attendance_report_pdf(report_data)
        self.assertIsInstance(pdf_content, bytes)
        self.assertTrue(pdf_content.startswith(b'%PDF'))
        
        # Test leave report PDF
        leave_data = ReportService.get_leave_report(
            start_date=self.start_date,
            end_date=self.end_date
        )
        pdf_content = PDFReportService.generate_leave_report_pdf(leave_data)
        self.assertIsInstance(pdf_content, bytes)
        self.assertTrue(pdf_content.startswith(b'%PDF'))
        
        # Test holiday report PDF
        holiday_data = ReportService.get_holiday_report(
            start_date=self.start_date,
            end_date=self.end_date
        )
        pdf_content = PDFReportService.generate_holiday_report_pdf(holiday_data)
        self.assertIsInstance(pdf_content, bytes)
        self.assertTrue(pdf_content.startswith(b'%PDF'))

    def test_report_with_filters(self):
        """Test report generation with filters"""
        report_data = ReportService.get_attendance_report(
            start_date=self.start_date,
            end_date=self.end_date,
            departments=[self.department.id],
            status=['present', 'late']
        )
        
        # Verify filtered data
        self.assertTrue(all(
            record['department'] == self.department.name
            for record in report_data['employee_records']
        ))
        
        # Test with employee filter
        report_data = ReportService.get_attendance_report(
            start_date=self.start_date,
            end_date=self.end_date,
            employees=[self.employee.id]
        )
        
        self.assertEqual(len(report_data['employee_records']), 1)
        self.assertEqual(
            report_data['employee_records'][0]['id'],
            self.employee.id
        )

    def test_export_formats(self):
        """Test different export formats"""
        report_data = ReportService.get_attendance_report(
            start_date=self.start_date,
            end_date=self.end_date
        )
        
        # Test PDF format
        pdf_content = PDFReportService.generate_attendance_report_pdf(report_data)
        self.assertTrue(pdf_content.startswith(b'%PDF'))
        
        # Save PDF to verify it's valid
        test_file = ContentFile(pdf_content)
        self.assertTrue(test_file.size > 0)
```

### 📄 hrms_project\attendance\tests\test_shifts.py
```from datetime import datetime, date, time, timedelta
from django.test import TestCase
from django.contrib.auth.models import User
from django.utils import timezone

from employees.models import Employee, Department
from attendance.models import Shift, ShiftAssignment
from attendance.services import ShiftService

class ShiftTests(TestCase):
    def setUp(self):
        # Create test user
        self.user = User.objects.create_user(
            username='testuser',
            password='testpass'
        )
        
        # Create department
        self.department = Department.objects.create(
            name='Test Department'
        )
        
        # Create test employee
        self.employee = Employee.objects.create(
            employee_number='EMP001',
            first_name='Test',
            last_name='Employee',
            department=self.department
        )
        
        # Create test shifts
        self.day_shift = Shift.objects.create(
            name='Day Shift',
            shift_type='REGULAR',
            start_time=time(8, 0),
            end_time=time(17, 0),
            break_duration=60,
            grace_period=15
        )
        
        self.night_shift = Shift.objects.create(
            name='Night Shift',
            shift_type='NIGHT',
            start_time=time(20, 0),
            end_time=time(5, 0),
            break_duration=45,
            grace_period=15,
            is_night_shift=True
        )

    def test_shift_creation(self):
        """Test shift creation with various parameters"""
        self.assertEqual(self.day_shift.name, 'Day Shift')
        self.assertEqual(self.day_shift.break_duration, 60)
        self.assertFalse(self.day_shift.is_night_shift)
        
        self.assertEqual(self.night_shift.name, 'Night Shift')
        self.assertTrue(self.night_shift.is_night_shift)

    def test_shift_assignment(self):
        """Test assigning shifts to employees"""
        # Create permanent assignment
        assignment = ShiftService.assign_shift(
            employee=self.employee,
            shift=self.day_shift,
            start_date=date.today(),
            end_date=None,
            created_by=self.user
        )
        
        self.assertTrue(assignment.is_active)
        self.assertIsNone(assignment.end_date)
        
        # Get current shift
        current_shift = ShiftService.get_employee_current_shift(self.employee)
        self.assertEqual(current_shift, self.day_shift)
        
        # Test temporary assignment
        end_date = date.today() + timedelta(days=30)
        temp_assignment = ShiftService.assign_shift(
            employee=self.employee,
            shift=self.night_shift,
            start_date=date.today(),
            end_date=end_date,
            created_by=self.user
        )
        
        # Previous assignment should be inactive
        assignment.refresh_from_db()
        self.assertFalse(assignment.is_active)
        
        # New assignment should be active
        self.assertTrue(temp_assignment.is_active)
        self.assertEqual(temp_assignment.end_date, end_date)

    def test_bulk_shift_assignment(self):
        """Test bulk assignment of shifts"""
        # Create more test employees
        employees = []
        for i in range(3):
            emp = Employee.objects.create(
                employee_number=f'EMP00{i+2}',
                first_name=f'Test{i+2}',
                last_name='Employee',
                department=self.department
            )
            employees.append(emp)
        
        # Bulk assign shift
        employee_ids = [emp.id for emp in employees]
        created_count = ShiftService.bulk_assign_shift(
            employee_ids=employee_ids,
            shift=self.day_shift,
            start_date=date.today(),
            end_date=None,
            created_by=self.user
        )
        
        self.assertEqual(created_count, len(employees))
        
        # Verify assignments
        for emp in employees:
            current_shift = ShiftService.get_employee_current_shift(emp)
            self.assertEqual(current_shift, self.day_shift)

    def test_shift_timing_validation(self):
        """Test shift timing validation"""
        # Test invalid shift times
        with self.assertRaises(ValueError):
            Shift.objects.create(
                name='Invalid Shift',
                shift_type='REGULAR',
                start_time=time(9, 0),
                end_time=time(9, 0),  # Same as start time
                break_duration=60
            )

    def test_shift_history(self):
        """Test employee shift history tracking"""
        # Create multiple assignments
        assignments = []
        for i in range(3):
            start_date = date.today() - timedelta(days=i*30)
            end_date = start_date + timedelta(days=29) if i > 0 else None
            assignment = ShiftService.assign_shift(
                employee=self.employee,
                shift=self.day_shift if i % 2 == 0 else self.night_shift,
                start_date=start_date,
                end_date=end_date,
                created_by=self.user
            )
            assignments.append(assignment)
        
        # Get shift history
        history = ShiftService.get_employee_shift_history(self.employee)
        
        self.assertEqual(len(history), 3)
        self.assertTrue(history[0]['is_active'])  # Most recent should be active
        self.assertEqual(history[0]['shift_name'], self.day_shift.name)

    def test_department_shifts(self):
        """Test getting department shift assignments"""
        # Create multiple employees with different shifts
        employees = []
        for i in range(4):
            emp = Employee.objects.create(
                employee_number=f'EMP00{i+2}',
                first_name=f'Test{i+2}',
                last_name='Employee',
                department=self.department
            )
            employees.append(emp)
            
            # Assign shifts alternating between day and night
            shift = self.day_shift if i % 2 == 0 else self.night_shift
            ShiftService.assign_shift(
                employee=emp,
                shift=shift,
                start_date=date.today(),
                end_date=None,
                created_by=self.user
            )
        
        # Get department shifts
        dept_shifts = ShiftService.get_department_shifts(self.department.id)
        
        self.assertEqual(len(dept_shifts), 2)  # Should have both shifts
        self.assertTrue(self.day_shift.name in dept_shifts)
        self.assertTrue(self.night_shift.name in dept_shifts)
        
        # Each shift should have 2 employees
        for shift_name, employees in dept_shifts.items():
            self.assertEqual(len(employees), 2)

```

### 📄 hrms_project\attendance\tests\test_timing.py
```from datetime import datetime, date, time, timedelta
from django.test import TestCase
from attendance.utils.timing import (
    calculate_time_difference,
    is_within_grace_period,
    calculate_late_minutes,
    calculate_early_departure,
    calculate_work_duration,
    adjust_ramadan_timing,
    parse_time_string,
    format_minutes_as_hours,
    is_night_shift,
    get_shift_period,
    is_time_in_shift
)

class TimingUtilsTests(TestCase):
    def test_calculate_time_difference(self):
        """Test time difference calculation"""
        # Regular case
        start = time(9, 0)
        end = time(17, 0)
        self.assertEqual(calculate_time_difference(start, end), 480)  # 8 hours
        
        # Overnight shift
        start = time(22, 0)
        end = time(6, 0)
        self.assertEqual(calculate_time_difference(start, end), 480)  # 8 hours
        
        # Same time
        start = end = time(9, 0)
        self.assertEqual(calculate_time_difference(start, end), 0)

    def test_grace_period(self):
        """Test grace period checks"""
        expected = time(9, 0)
        
        # Within grace period
        actual = time(9, 10)
        self.assertTrue(is_within_grace_period(actual, expected, 15))
        
        # Outside grace period
        actual = time(9, 20)
        self.assertFalse(is_within_grace_period(actual, expected, 15))
        
        # Exact match
        self.assertTrue(is_within_grace_period(expected, expected, 0))

    def test_late_minutes_calculation(self):
        """Test late minutes calculation"""
        expected = time(9, 0)
        grace = 10
        
        # Not late (within grace)
        actual = time(9, 5)
        self.assertEqual(calculate_late_minutes(actual, expected, grace), 0)
        
        # Late
        actual = time(9, 30)
        self.assertEqual(calculate_late_minutes(actual, expected, grace), 30)
        
        # Very late
        actual = time(10, 0)
        self.assertEqual(calculate_late_minutes(actual, expected, grace), 60)

    def test_early_departure(self):
        """Test early departure calculation"""
        expected = time(17, 0)
        
        # Not early
        actual = time(17, 30)
        self.assertEqual(calculate_early_departure(actual, expected), 0)
        
        # Early
        actual = time(16, 30)
        self.assertEqual(calculate_early_departure(actual, expected), 30)
        
        # Very early
        actual = time(15, 0)
        self.assertEqual(calculate_early_departure(actual, expected), 120)

    def test_work_duration(self):
        """Test work duration calculation"""
        # Regular day
        in_time = time(9, 0)
        out_time = time(17, 0)
        self.assertEqual(calculate_work_duration(in_time, out_time), 480)  # 8 hours
        
        # With break
        self.assertEqual(calculate_work_duration(in_time, out_time, 60), 420)  # 7 hours
        
        # Overnight shift
        in_time = time(22, 0)
        out_time = time(6, 0)
        self.assertEqual(calculate_work_duration(in_time, out_time), 480)  # 8 hours

    def test_ramadan_timing(self):
        """Test Ramadan timing adjustments"""
        start = time(8, 0)
        end = time(17, 0)
        
        adjusted_start, adjusted_end = adjust_ramadan_timing(start, end)
        
        # Start time should remain same
        self.assertEqual(adjusted_start, start)
        # End time should be 2 hours earlier
        self.assertEqual(adjusted_end, time(15, 0))
        
        # Test with different reduction
        _, adjusted_end = adjust_ramadan_timing(start, end, reduction_hours=3)
        self.assertEqual(adjusted_end, time(14, 0))

    def test_time_string_parsing(self):
        """Test time string parsing"""
        # 24-hour format
        self.assertEqual(parse_time_string('14:30'), time(14, 30))
        
        # 12-hour format
        self.assertEqual(parse_time_string('02:30 PM'), time(14, 30))
        
        # With seconds
        self.assertEqual(parse_time_string('14:30:00'), time(14, 30))
        
        # Invalid format
        self.assertIsNone(parse_time_string('invalid'))

    def test_minutes_formatting(self):
        """Test minutes to hours formatting"""
        # Only minutes
        self.assertEqual(format_minutes_as_hours(45), '45m')
        
        # Only hours
        self.assertEqual(format_minutes_as_hours(120), '2h')
        
        # Hours and minutes
        self.assertEqual(format_minutes_as_hours(150), '2h 30m')
        
        # Zero
        self.assertEqual(format_minutes_as_hours(0), '0m')

    def test_night_shift_detection(self):
        """Test night shift detection"""
        # Regular day shift
        self.assertFalse(is_night_shift(time(9, 0), time(17, 0)))
        
        # Night shift crossing midnight
        self.assertTrue(is_night_shift(time(22, 0), time(6, 0)))
        
        # Evening shift
        self.assertTrue(is_night_shift(time(18, 0), time(2, 0)))

    def test_shift_period(self):
        """Test shift period calculation"""
        check_date = date(2025, 1, 1)
        
        # Regular day shift
        start, end = get_shift_period(
            check_date,
            time(9, 0),
            time(17, 0)
        )
        self.assertEqual(start.date(), check_date)
        self.assertEqual(end.date(), check_date)
        
        # Night shift
        start, end = get_shift_period(
            check_date,
            time(22, 0),
            time(6, 0)
        )
        self.assertEqual(start.date(), check_date)
        self.assertEqual(end.date(), check_date + timedelta(days=1))

    def test_time_in_shift(self):
        """Test time in shift checking"""
        shift_start = time(9, 0)
        shift_end = time(17, 0)
        check_date = date(2025, 1, 1)
        
        # Within shift
        check_time = datetime.combine(check_date, time(12, 0))
        self.assertTrue(is_time_in_shift(check_time, shift_start, shift_end))
        
        # Outside shift
        check_time = datetime.combine(check_date, time(8, 0))
        self.assertFalse(is_time_in_shift(check_time, shift_start, shift_end))
        
        # Within grace period
        check_time = datetime.combine(check_date, time(9, 10))
        self.assertTrue(is_time_in_shift(check_time, shift_start, shift_end, grace_minutes=15))

```

### 📄 hrms_project\attendance\urls.py
```from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views  

from .views import shifts_views
from .views import attendance_views
from .views import calendar_views
from .views import leave_views
from .views import holiday_views
from .views import ramadan_views
from .api import report_views

app_name = 'attendance'

# Create a router and register the ViewSets
router = DefaultRouter()
router.register(r'api/shifts', shifts_views.ShiftViewSet, basename='shift')
router.register(r'api/attendance_records', attendance_views.AttendanceRecordViewSet, basename='attendancerecord')
router.register(r'api/attendance_logs', attendance_views.AttendanceLogListViewSet, basename='attendancelog')
router.register(r'api/leaves', leave_views.LeaveViewSet, basename='leave')
router.register(r'api/holidays', holiday_views.HolidayViewSet, basename='holiday')
router.register(r'api/reports', report_views.ReportViewSet, basename='report')

urlpatterns = [
    # Include router URLs
    path('', include(router.urls)),
    
    # Report URLs
    path('attendance_report/', attendance_views.attendance_report, name='attendance_report'),
    path('attendance_detail/', attendance_views.attendance_detail_view, name='attendance_detail'),
    path('api/details/', attendance_views.attendance_detail_api, name='attendance_detail_api'),
    path('api/reports/export/', report_views.ReportViewSet.as_view({'get': 'export'}), name='report-export'),
    
    # Attendance URLs
    path('attendance_list/', attendance_views.attendance_list, name='attendance_list'),
    path('mark_attendance/', attendance_views.mark_attendance, name='mark_attendance'),
    path('upload_attendance/', attendance_views.upload_attendance, name='upload_attendance'),
    path('reprocess_attendance/', attendance_views.reprocess_attendance_view, name='reprocess_attendance'),
    
    # Calendar URLs
    path('calendar/', calendar_views.calendar_view, name='calendar'),
    path('calendar/month/', calendar_views.calendar_month, name='calendar_month'),
    path('calendar/week/', calendar_views.calendar_week, name='calendar_week'),
    path('calendar/department/', calendar_views.calendar_department, name='calendar_department'),
    path('api/calendar_events/', calendar_views.calendar_events, name='calendar_events'),
    
    # Leave Management URLs
    path('leave_request_list/', leave_views.leave_request_list, name='leave_request_list'),
    path('leave_request_create/', leave_views.leave_request_create, name='leave_request_create'),
    path('leave_request_detail/<int:pk>/', leave_views.leave_request_detail, name='leave_request_detail'),
    path('leave_balance/', leave_views.leave_balance, name='leave_balance'),
    path('leave_types/', leave_views.leave_types, name='leave_types'),
    path('api/leaves/<int:pk>/approve/', leave_views.leave_request_action, {'action': 'approve'}, name='leave_request_approve'),
    path('api/leaves/<int:pk>/reject/', leave_views.leave_request_action, {'action': 'reject'}, name='leave_request_reject'),
    path('api/leaves/<int:pk>/cancel/', leave_views.leave_request_action, {'action': 'cancel'}, name='leave_request_cancel'),
    path('api/leaves/<int:pk>/delete/', leave_views.leave_request_action, {'action': 'delete'}, name='leave_request_delete'),
    
    # Holiday Management URLs
    path('holiday_list/', holiday_views.holiday_list, name='holiday_list'),
    path('holiday_create/', holiday_views.holiday_create, name='holiday_create'),
    path('holiday_edit/<int:pk>/', holiday_views.holiday_edit, name='holiday_edit'),
    path('holiday_delete/<int:pk>/', holiday_views.holiday_delete, name='holiday_delete'),
    path('preview_next_year_holidays/', holiday_views.preview_next_year_holidays, name='preview_next_year_holidays'),
    path('generate_next_year_holidays/', holiday_views.generate_next_year_holidays, name='generate_next_year_holidays'),
    path('recurring_holidays/', holiday_views.recurring_holidays, name='recurring_holidays'),
    
    # Shift Management URLs
    path('shifts/', shifts_views.shift_list, name='shift_list'),
    path('shifts/create/', shifts_views.shift_create, name='shift_create'),
    path('shifts/<int:pk>/edit/', shifts_views.shift_edit, name='shift_edit'),
    path('shifts/day/<str:date>/', shifts_views.shift_day_detail, name='shift_day_detail'),
    path('shift-assignments/', shifts_views.shift_assignment_list, name='shift_assignment_list'),
    path('shift-assignments/create/', shifts_views.shift_assignment_create, name='shift_assignment_create'),
    path('shift-assignments/<int:pk>/edit/', shifts_views.shift_assignment_edit, name='shift_assignment_edit'),
    path('shift-assignments/<int:pk>/delete/', shifts_views.shift_assignment_delete, name='shift_assignment_delete'),
    
    # API Endpoints
    path('api/get_calendar_events/', views.get_calendar_events, name='get_calendar_events'),
    path('api/get_employee_attendance/<int:employee_id>/', views.get_employee_attendance, name='get_employee_attendance'),
    path('api/attendance_record/<int:record_id>/', views.attendance_record_api, name='attendance_record_api'),
    path('api/add_attendance_record/', views.add_attendance_record, name='add_attendance_record'),
    path('api/search_employees/', views.search_employees, name='search_employees'),
    path('api/attendance_details/', views.attendance_details, name='attendance_details'),
    path('api/employee/<int:employee_id>/shifts/', shifts_views.get_employee_shifts, name='get_employee_shifts'),
    path('api/logs/', attendance_views.AttendanceLogListViewSet.as_view({'get': 'list'}), name='attendance_log_list'),
    path('api/shift_assignment_calendar_events/', shifts_views.shift_assignment_calendar_events, name='shift_assignment_calendar_events'),
    path('api/shift-assignments/quick/', views.quick_shift_assignment, name='quick_shift_assignment'),
    path('api/shift-assignments/<int:pk>/', views.shift_assignment_detail, name='shift_assignment_detail'),
    path('get_department_employees/', views.get_department_employees, name='get_department_employees'),
    path('api/records/upload_excel/', attendance_views.AttendanceRecordViewSet.as_view({'post': 'upload_excel'}), name='upload_excel'),
    
    # Ramadan Period URLs
    path('ramadan_periods/', ramadan_views.RamadanPeriodListView.as_view(), name='ramadan_periods'),
    path('ramadan_period/add/', ramadan_views.RamadanPeriodAddView.as_view(), name='ramadan_period_add'),
    path('ramadan_period/<int:pk>/', ramadan_views.RamadanPeriodDetailView.as_view(), name='ramadan_period_detail'),
    
    # Shift Override URLs
    path('shift_override/', views.create_shift_override, name='shift_override_create'),
    path('shift_override/<str:date>/', views.delete_shift_override, name='shift_override_delete'),
    path('shift_overrides/<int:year>/<int:month>/', views.get_shift_overrides, name='shift_overrides_list'),
]

```

### 📄 hrms_project\attendance\utils\__init__.py
```from .attendance_processor import process_attendance_excel, process_daily_attendance, get_attendance_summary

__all__ = [
    'process_attendance_excel',
    'process_daily_attendance',
    'get_attendance_summary',
]

```

### 📄 hrms_project\attendance\utils\attendance_processor.py
```from typing import List, Dict, Any
from datetime import datetime, date
import pandas as pd
from django.db import transaction
from attendance.models import AttendanceRecord, AttendanceLog

def process_attendance_excel(file_obj) -> tuple:
    """
    Process uploaded Excel file containing attendance data
    Expected columns: Date And Time, Personnel ID, First Name, Last Name, Card Number,
                     Device Name, Event Point, Verify Type, In/Out Status, Event Description, Remarks
    Returns: records_created, duplicates, total_records, new_employees, unique_dates
    """
    from employees.models import Employee
    
    try:
        # Read Excel file
        df = pd.read_excel(file_obj)
        
        # Verify required columns exist
        required_columns = ['Date And Time', 'Personnel ID']
        missing_columns = [col for col in required_columns if col not in df.columns]
        if missing_columns:
            raise ValueError(f"Missing required columns: {', '.join(missing_columns)}")
        
        # Initialize counters
        records_created = 0
        duplicates = 0
        new_employees = 0
        unique_dates = set()
        
        # Process the DataFrame and create records
        for _, row in df.iterrows():
            try:
                # Convert date_and_time to datetime
                timestamp = pd.to_datetime(row['Date And Time'])
                employee_id = str(row['Personnel ID'])  # Convert to string to handle numeric IDs
                
                # Try to find the employee, skip if not found
                try:
                    employee = Employee.objects.get(employee_number=employee_id)
                except Employee.DoesNotExist:
                    print(f"Employee not found: {employee_id}")
                    continue
                
                # Add date to unique dates set
                unique_dates.add(timestamp.date())
                
                # Check for duplicate record
                if AttendanceRecord.objects.filter(
                    employee=employee,
                    timestamp=timestamp
                ).exists():
                    duplicates += 1
                    continue
                
                # Create the record
                AttendanceRecord.objects.create(
                    employee=employee,
                    timestamp=timestamp,
                    device_name=row.get('Device Name', ''),
                    event_point=row.get('Event Point', ''),
                    verify_type=row.get('Verify Type', ''),
                    event_description=row.get('Event Description', ''),
                    remarks=row.get('Remarks', '')
                )
                records_created += 1
                
            except Exception as row_error:
                print(f"Error processing row: {row_error}")
                continue
        
        return records_created, duplicates, len(df), new_employees, unique_dates
        
    except Exception as e:
        raise ValueError(f"Error processing Excel file: {str(e)}")

def process_daily_attendance(date_to_process: date) -> int:
    """
    Process attendance records for a specific date and create attendance logs
    Returns the number of logs created/updated
    """
    from django.db.models import Min, Max
    
    logs_processed = 0
    
    with transaction.atomic():
        # Get all records for the specified date grouped by employee
        employee_records = AttendanceRecord.objects.filter(
            timestamp__date=date_to_process,
            is_active=True
        ).values('employee').annotate(
            first_in=Min('timestamp'),
            last_out=Max('timestamp')
        )
        
        # Process each employee's records
        for record in employee_records:
            employee_id = record['employee']
            first_in = record['first_in']
            last_out = record['last_out']
            
            # Get or create the attendance log
            log, created = AttendanceLog.objects.get_or_create(
                employee_id=employee_id,
                date=date_to_process,
                defaults={
                    'first_in_time': first_in.time(),
                    'last_out_time': last_out.time() if last_out else None,
                    'status': 'present',
                    'source': 'system'
                }
            )
            
            if not created:
                # Update existing log
                log.first_in_time = first_in.time()
                log.last_out_time = last_out.time() if last_out else None
                log.status = 'present'
                log.save()
            
            logs_processed += 1
    
    return logs_processed

def get_attendance_summary(start_date: date, end_date: date, employee_id: int = None) -> Dict[str, Any]:
    """
    Get attendance summary for a date range and optionally for a specific employee
    """
    query = AttendanceLog.objects.filter(date__range=(start_date, end_date))
    if employee_id:
        query = query.filter(employee_id=employee_id)
    
    summary = {
        'total_days': (end_date - start_date).days + 1,
        'present_days': query.count(),
        'absent_days': 0,  # Calculate based on business logic
        'late_days': query.filter(is_late=True).count(),
        'early_departure_days': query.filter(left_early=True).count(),
    }
    
    return summary

```

### 📄 hrms_project\attendance\utils\display.py
```from django.utils.html import format_html
from django.utils.safestring import mark_safe
from typing import Dict, Any, Optional
from datetime import date, time, datetime

class DisplayFormatter:
    """Centralized display formatting utilities for consistent UI presentation"""
    
    @staticmethod
    def color_coded_display(value: Any, display_value: str, color_map: Dict[str, str]) -> str:
        """
        Generate color-coded HTML display for values.
        
        Args:
            value: The value to look up in the color map
            display_value: The text to display
            color_map: Dictionary mapping values to colors
            
        Returns:
            HTML formatted string with colored span
        
        Example:
            >>> color_map = {'active': 'green', 'inactive': 'red'}
            >>> DisplayFormatter.color_coded_display('active', 'Active', color_map)
            '<span style="color: green;">Active</span>'
        """
        color = color_map.get(str(value), 'gray')
        return format_html('<span style="color: {};">{}</span>', color, display_value)
    
    @staticmethod
    def timing_display(start_time: Optional[time], end_time: Optional[time], title: str = '') -> str:
        """
        Format time range for display.
        
        Args:
            start_time: Starting time
            end_time: Ending time
            title: Optional hover title for the time range
            
        Returns:
            HTML formatted string showing time range
        """
        if not (start_time and end_time):
            return format_html('<span class="text-muted">Not set</span>')
        
        time_str = f"{start_time.strftime('%I:%M %p')} - {end_time.strftime('%I:%M %p')}"
        if title:
            return format_html('<span title="{}">{}</span>', title, time_str)
        return format_html('<span>{}</span>', time_str)

    @staticmethod
    def period_display(start_date: date, end_date: Optional[date] = None, is_permanent: bool = False) -> str:
        """
        Format date period for display.
        
        Args:
            start_date: Period start date
            end_date: Optional period end date
            is_permanent: Whether the period is permanent
            
        Returns:
            Formatted string showing date period
        """
        start = start_date.strftime('%b %d, %Y')
        if end_date:
            if is_permanent:
                return f"From {start} (Permanent)"
            return f"{start} - {end_date.strftime('%b %d, %Y')}"
        return f"From {start}"

    @staticmethod
    def duration_display(duration_minutes: int, show_zero: bool = True) -> str:
        """
        Format duration in minutes for display.
        
        Args:
            duration_minutes: Duration in minutes
            show_zero: Whether to show zero durations
            
        Returns:
            Formatted string showing duration
        """
        if duration_minutes == 0 and not show_zero:
            return ''
            
        hours = duration_minutes // 60
        minutes = duration_minutes % 60
        
        if hours and minutes:
            return f"{hours}h {minutes}m"
        elif hours:
            return f"{hours}h"
        return f"{minutes}m"

# Common color maps used across the application
STATUS_COLORS = {
    'present': 'green',
    'absent': 'red',
    'late': 'orange',
    'leave': 'blue',
    'holiday': 'purple'
}

SHIFT_TYPE_COLORS = {
    'DEFAULT': 'green',
    'NIGHT': 'purple',
    'OPEN': 'blue'
}

```

### 📄 hrms_project\attendance\utils\timing.py
```from datetime import datetime, date, time, timedelta
from typing import Optional, Tuple, Dict, Any
from django.utils import timezone

def calculate_time_difference(start: time, end: time) -> int:
    """
    Calculate minutes between two time objects, handling overnight shifts
    
    Args:
        start: Start time
        end: End time
        
    Returns:
        Number of minutes between times
    """
    start_dt = datetime.combine(date.today(), start)
    end_dt = datetime.combine(date.today(), end)
    
    # Handle overnight shifts
    if end < start:
        end_dt += timedelta(days=1)
        
    return int((end_dt - start_dt).total_seconds() / 60)

def is_within_grace_period(
    actual_time: time,
    expected_time: time,
    grace_minutes: int
) -> bool:
    """
    Check if actual time is within grace period of expected time
    
    Args:
        actual_time: The actual time to check
        expected_time: The expected time
        grace_minutes: Number of grace period minutes
        
    Returns:
        True if within grace period, False otherwise
    """
    actual_dt = datetime.combine(date.today(), actual_time)
    expected_dt = datetime.combine(date.today(), expected_time)
    grace_delta = timedelta(minutes=grace_minutes)
    
    return actual_dt <= (expected_dt + grace_delta)

def calculate_late_minutes(
    actual_time: time,
    expected_time: time,
    grace_minutes: int = 0
) -> int:
    """
    Calculate minutes late, considering grace period
    
    Args:
        actual_time: Actual time of arrival
        expected_time: Expected arrival time
        grace_minutes: Grace period in minutes
        
    Returns:
        Number of minutes late (0 if not late)
    """
    if is_within_grace_period(actual_time, expected_time, grace_minutes):
        return 0
        
    actual_dt = datetime.combine(date.today(), actual_time)
    expected_dt = datetime.combine(date.today(), expected_time)
    
    return int((actual_dt - expected_dt).total_seconds() / 60)

def calculate_early_departure(
    actual_time: time,
    expected_time: time
) -> int:
    """
    Calculate minutes of early departure
    
    Args:
        actual_time: Actual departure time
        expected_time: Expected departure time
        
    Returns:
        Number of minutes left early (0 if not early)
    """
    actual_dt = datetime.combine(date.today(), actual_time)
    expected_dt = datetime.combine(date.today(), expected_time)
    
    if actual_dt >= expected_dt:
        return 0
        
    return int((expected_dt - actual_dt).total_seconds() / 60)

def calculate_work_duration(
    in_time: time,
    out_time: time,
    break_minutes: int = 0
) -> int:
    """
    Calculate total working minutes, excluding break time
    
    Args:
        in_time: Time in
        out_time: Time out
        break_minutes: Break duration in minutes
        
    Returns:
        Total working minutes
    """
    total_minutes = calculate_time_difference(in_time, out_time)
    return max(0, total_minutes - break_minutes)

def adjust_ramadan_timing(
    normal_start: time,
    normal_end: time,
    reduction_hours: int = 2
) -> Tuple[time, time]:
    """
    Adjust shift timing for Ramadan
    
    Args:
        normal_start: Regular start time
        normal_end: Regular end time
        reduction_hours: Hours to reduce by
        
    Returns:
        Tuple of (adjusted_start, adjusted_end)
    """
    # Keep start time same, reduce end time
    end_dt = datetime.combine(date.today(), normal_end)
    adjusted_end = (end_dt - timedelta(hours=reduction_hours)).time()
    
    return (normal_start, adjusted_end)

def parse_time_string(time_str: str) -> Optional[time]:
    """
    Parse time string in various formats
    
    Args:
        time_str: Time string to parse
        
    Returns:
        time object or None if invalid
    """
    formats = [
        '%H:%M',        # 24-hour (14:30)
        '%I:%M %p',     # 12-hour with AM/PM (02:30 PM)
        '%H:%M:%S',     # 24-hour with seconds
        '%I:%M:%S %p'   # 12-hour with seconds and AM/PM
    ]
    
    for fmt in formats:
        try:
            return datetime.strptime(time_str, fmt).time()
        except ValueError:
            continue
            
    return None

def format_minutes_as_hours(minutes: int) -> str:
    """
    Format minutes as hours and minutes string
    
    Args:
        minutes: Number of minutes
        
    Returns:
        Formatted string (e.g., "2h 30m")
    """
    hours = minutes // 60
    remaining_minutes = minutes % 60
    
    if hours == 0:
        return f"{remaining_minutes}m"
    elif remaining_minutes == 0:
        return f"{hours}h"
    else:
        return f"{hours}h {remaining_minutes}m"

def is_night_shift(start: time, end: time) -> bool:
    """
    Check if shift timing indicates a night shift
    
    Args:
        start: Shift start time
        end: Shift end time
        
    Returns:
        True if night shift, False otherwise
    """
    # Consider night shift if:
    # 1. End time is before start time (crosses midnight)
    # 2. Start time is after 6 PM (18:00)
    return end < start or start >= time(18, 0)

def get_shift_period(
    date_to_check: date,
    start: time,
    end: time
) -> Tuple[datetime, datetime]:
    """
    Get actual datetime period for a shift on a given date
    
    Args:
        date_to_check: Date of the shift
        start: Shift start time
        end: Shift end time
        
    Returns:
        Tuple of (period_start, period_end) datetimes
    """
    period_start = datetime.combine(date_to_check, start)
    period_end = datetime.combine(date_to_check, end)
    
    # Handle overnight shifts
    if end < start:
        period_end += timedelta(days=1)
        
    return (period_start, period_end)

def is_time_in_shift(
    check_time: datetime,
    shift_start: time,
    shift_end: time,
    grace_minutes: int = 0
) -> bool:
    """
    Check if a given datetime falls within shift hours
    
    Args:
        check_time: Datetime to check
        shift_start: Shift start time
        shift_end: Shift end time
        grace_minutes: Grace period in minutes
        
    Returns:
        True if time falls within shift period, False otherwise
    """
    shift_date = check_time.date()
    period_start, period_end = get_shift_period(shift_date, shift_start, shift_end)
    
    # Add grace period
    period_start -= timedelta(minutes=grace_minutes)
    period_end += timedelta(minutes=grace_minutes)
    
    return period_start <= check_time <= period_end

```

### 📄 hrms_project\attendance\utils\validation.py
```from datetime import datetime
from typing import List, Optional, Any, Dict
from rest_framework.exceptions import ValidationError
import logging

logger = logging.getLogger('attendance')

class RequestValidator:
    """Centralized request validation utilities"""
    
    @staticmethod
    def validate_date_range(start_date: str, end_date: str, fmt: str = '%Y-%m-%d') -> Dict[str, datetime]:
        """
        Validate and parse date range parameters.
        
        Args:
            start_date: Start date string
            end_date: End date string
            fmt: Date string format
            
        Returns:
            Dictionary with parsed start_date and end_date
            
        Raises:
            ValidationError: If dates are invalid or start_date > end_date
        """
        logger.debug(f"Validating date range: start={start_date}, end={end_date}")
        
        if not start_date or not end_date:
            logger.error("Missing date parameters")
            raise ValidationError("Both start_date and end_date are required")
        
        try:
            parsed_start = datetime.strptime(start_date, fmt)
            parsed_end = datetime.strptime(end_date, fmt)
            logger.debug(f"Parsed dates: start={parsed_start}, end={parsed_end}")
        except ValueError:
            logger.error(f"Invalid date format. Expected {fmt}")
            raise ValidationError(f"Invalid date format. Use {fmt}")
        
        if parsed_start > parsed_end:
            logger.error("Start date is after end date")
            raise ValidationError("Start date must be before end date")
            
        return {
            'start_date': parsed_start,
            'end_date': parsed_end
        }

    @staticmethod
    def validate_list_param(params: dict, param_name: str, coerce_type: type = str) -> Optional[List]:
        """
        Validate and parse list parameters from request.
        Handles both single values and lists with [] suffix.
        
        Args:
            params: Request parameters dictionary
            param_name: Name of the parameter to validate
            coerce_type: Type to convert values to
            
        Returns:
            List of values or None if parameter not provided
            
        Example:
            >>> # For params like departments[] or departments
            >>> departments = validate_list_param(request.query_params, 'departments', int)
        """
        logger.debug(f"Validating list parameter: {param_name}")
        
        # Try array notation first (e.g. departments[])
        values = params.getlist(f'{param_name}[]', [])
        if not values or not values[0]:
            # Try single param that might be comma-separated
            values = params.getlist(param_name, [])
            
        if not values or not values[0]:
            logger.debug(f"No values provided for {param_name}")
            return None
            
        try:
            result = [coerce_type(v.strip()) for v in values if v.strip()]
            logger.debug(f"Validated {param_name}: {result}")
            return result
        except (ValueError, TypeError):
            logger.error(f"Invalid {param_name} values. Expected {coerce_type.__name__} values.")
            raise ValidationError(
                f"Invalid {param_name} values. Expected {coerce_type.__name__} values."
            )

    @staticmethod
    def validate_report_params(params: dict, optional_params: Optional[List[str]] = None) -> Dict:
        """
        Validate common report parameters.
        
        Args:
            params: Request parameters dictionary
            optional_params: List of optional parameter names to extract
            
        Returns:
            Dictionary of validated parameters
            
        Example:
            >>> validated = validate_report_params(
            ...     request.query_params, 
            ...     ['departments', 'employees', 'status']
            ... )
        """
        logger.debug("Validating report parameters")
        
        # Validate required date range
        validated = RequestValidator.validate_date_range(
            params.get('start_date'),
            params.get('end_date')
        )
        
        # Process optional parameters if specified
        if optional_params:
            param_configs = {
                'departments': (int, 'Department IDs'),
                'employees': (int, 'Employee IDs'),
                'status': (str, 'Status values'),
                'leave_types': (str, 'Leave type codes')
            }
            
            for param in optional_params:
                if param in param_configs:
                    coerce_type, description = param_configs[param]
                    values = RequestValidator.validate_list_param(params, param, coerce_type)
                    if values:
                        validated[param] = values
        
        logger.debug(f"Validated report parameters: {validated}")
        return validated

class ModelValidator:
    """Validation utilities for model operations"""
    
    @staticmethod
    def validate_date_not_past(date_value: datetime, field_name: str = 'date'):
        """Validate that a date is not in the past"""
        logger.debug(f"Validating date not past: {field_name}={date_value}")
        
        if date_value and date_value.date() < datetime.now().date():
            logger.error(f"{field_name} is in the past")
            raise ValidationError({field_name: "Date cannot be in the past"})

    @staticmethod
    def validate_positive_integer(value: int, field_name: str):
        """Validate that a value is a positive integer"""
        logger.debug(f"Validating positive integer: {field_name}={value}")
        
        if value and value < 0:
            logger.error(f"{field_name} is not positive")
            raise ValidationError({field_name: "Value must be positive"})

    @staticmethod
    def validate_date_range(start_date: datetime, end_date: datetime):
        """Validate a date range is valid"""
        logger.debug(f"Validating date range: start={start_date}, end={end_date}")
        
        if start_date and end_date and start_date > end_date:
            logger.error("End date is before start date")
            raise ValidationError({
                'end_date': "End date must be after start date"
            })

```

### 📄 hrms_project\attendance\utils.py
```import pandas as pd
from datetime import datetime, time, timedelta
from django.utils import timezone
from django.db import transaction
from .models import AttendanceRecord, AttendanceLog
from employees.models import Employee

def process_attendance_excel(file_path):
    """
    Process attendance Excel file from the machine
    Expected columns: Date And Time, Personnel ID, Device Name, Event Point, 
                     Verify Type, Event Description, Remarks
    Returns: records_created, duplicates, total_records, new_employees, unique_dates
    """
    try:
        # Determine the engine based on file extension
        file_extension = str(file_path).lower()
        engine = 'xlrd' if file_extension.endswith('.xls') else 'openpyxl'
        
        # Read Excel file
        df = pd.read_excel(file_path, engine=engine)
        
        if df.empty:
            return 0, 0, 0, [], set()
            
        # Standardize column names
        df.columns = [c.strip().lower().replace(' ', '_') for c in df.columns]
        
        # Verify required columns
        required_columns = ['date_and_time', 'personnel_id']
        missing_columns = [col for col in required_columns if col not in df.columns]
        if missing_columns:
            raise Exception(f"Missing required columns: {', '.join(missing_columns)}")
        
        records_to_create = []
        duplicates = 0
        new_employees = []
        unique_dates = set()
        
        # Get existing timestamps for each employee to check duplicates
        existing_records = {
            (str(r.employee_id), r.timestamp.strftime('%Y-%m-%d %H:%M:%S')): True 
            for r in AttendanceRecord.objects.all()
        }
        
        # Get existing employee numbers
        existing_employee_numbers = set(Employee.objects.values_list('employee_number', flat=True))
        
        for _, row in df.iterrows():
            try:
                # Convert date_and_time to datetime
                timestamp = pd.to_datetime(row['date_and_time'])
                unique_dates.add(timestamp.date())
                
                # Try to get employee or create placeholder
                try:
                    employee = Employee.objects.get(employee_number=row['personnel_id'])
                except Employee.DoesNotExist:
                    # Only create employee if not already created in this session
                    if row['personnel_id'] not in existing_employee_numbers:
                        employee = Employee.objects.create(
                            employee_number=row['personnel_id'],
                            first_name=row.get('first_name', f"Employee {row['personnel_id']}"),
                            last_name=row.get('last_name', ''),
                            email=f"employee{row['personnel_id']}@placeholder.com"
                        )
                        new_employees.append({
                            'id': employee.id,
                            'employee_number': employee.employee_number,
                            'name': f"{employee.first_name} {employee.last_name}".strip()
                        })
                        existing_employee_numbers.add(row['personnel_id'])
                    else:
                        employee = Employee.objects.get(employee_number=row['personnel_id'])
                
                # Check for duplicates
                record_key = (str(employee.id), timestamp.strftime('%Y-%m-%d %H:%M:%S'))
                if record_key in existing_records:
                    duplicates += 1
                    continue
                
                # Create attendance record
                record = AttendanceRecord(
                    employee=employee,
                    timestamp=timestamp,
                    device_name=row.get('device_name', ''),
                    event_point=row.get('event_point', ''),
                    verify_type=row.get('verify_type', ''),
                    event_description=row.get('event_description', ''),
                    remarks=row.get('remarks', '')
                )
                records_to_create.append(record)
                existing_records[record_key] = True
                
            except Exception as e:
                continue
        
        # Bulk create records
        records_created = 0
        if records_to_create:
            AttendanceRecord.objects.bulk_create(records_to_create, ignore_conflicts=True)
            records_created = len(records_to_create)
        
        total_records = AttendanceRecord.objects.count()
        
        return records_created, duplicates, total_records, new_employees, unique_dates
        
    except Exception as e:
        raise Exception(f"Error processing Excel file: {str(e)}")

def generate_attendance_log(date, employee):
    """
    Generate attendance log for an employee on a specific date
    Returns first in and last out times
    """
    try:
        # Get all attendance records for the employee on the date
        records = AttendanceRecord.objects.filter(
            employee=employee,
            timestamp__date=date,
            is_active=True
        ).order_by('timestamp')
        
        if not records.exists():
            return None, None
        
        # Get first and last records
        first_record = records.first()
        last_record = records.last()
        
        first_in = first_record.timestamp.time()
        last_out = last_record.timestamp.time()
        
        return first_in, last_out
    
    except Exception as e:
        print(f"Error generating attendance log: {str(e)}")
        return None, None

def process_daily_attendance(date=None):
    """
    Process attendance records and create attendance logs for all employees
    """
    if date is None:
        date = timezone.now().date()
    
    try:
        # Get all employees with attendance records for the date
        employees = Employee.objects.filter(
            attendance_records__timestamp__date=date,
            attendance_records__is_active=True
        ).distinct()
        
        logs_created = 0
        
        for employee in employees:
            first_in, last_out = generate_attendance_log(date, employee)
            
            if first_in and last_out:
                # Create or update attendance log
                AttendanceLog.objects.update_or_create(
                    employee=employee,
                    date=date,
                    defaults={
                        'first_in_time': first_in,
                        'last_out_time': last_out,
                        'source': 'system'
                    }
                )
                logs_created += 1
        
        return logs_created
    
    except Exception as e:
        raise Exception(f"Error processing daily attendance: {str(e)}")

def validate_attendance_edit(original_log, edited_in_time, edited_out_time):
    """
    Validate attendance edit times
    """
    try:
        # Convert string times to time objects if necessary
        if isinstance(edited_in_time, str):
            edited_in_time = datetime.strptime(edited_in_time, '%H:%M').time()
        if isinstance(edited_out_time, str):
            edited_out_time = datetime.strptime(edited_out_time, '%H:%M').time()
        
        # Basic validation
        if edited_in_time > edited_out_time:
            raise ValueError("First in time cannot be after last out time")
        
        # Check if times are within 24 hours
        time_diff = datetime.combine(datetime.today(), edited_out_time) - \
                   datetime.combine(datetime.today(), edited_in_time)
        
        if time_diff > timedelta(hours=24):
            raise ValueError("Time difference cannot be more than 24 hours")
        
        return True
        
    except Exception as e:
        raise ValueError(f"Invalid time format or values: {str(e)}")

def get_attendance_summary(employee, start_date, end_date):
    """
    Get attendance summary for an employee within a date range
    """
    logs = AttendanceLog.objects.filter(
        employee=employee,
        date__range=(start_date, end_date),
        is_active=True
    ).order_by('date')
    
    summary = {
        'total_days': (end_date - start_date).days + 1,
        'present_days': logs.count(),
        'absent_days': 0,
        'leave_days': 0,
        'holidays': 0,
        'attendance_details': []
    }
    
    for log in logs:
        summary['attendance_details'].append({
            'date': log.date,
            'first_in': log.first_in_time,
            'last_out': log.last_out_time,
            'source': log.source
        })
    
    return summary
```

### 📄 hrms_project\attendance\views\__init__.py
```from .attendance_views import *
from .calendar_views import *
from .leave_views import *
from .holiday_views import *
from .shifts_views import * # Already present, but ensure it's there
from .ramadan_views import *
```

### 📄 hrms_project\attendance\views\attendance_views.py
```from datetime import datetime, date, timedelta, time
from typing import List, Dict, Any

from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.db import transaction
from django.db.models import Q, Sum, Count
from django.http import JsonResponse, Http404
from django.utils import timezone
from django.contrib import messages
from django.conf import settings
from django.core.management import call_command
from django.core.paginator import Paginator
from rest_framework import status
from rest_framework import viewsets
from rest_framework.decorators import api_view, permission_classes, action
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser
from rest_framework.pagination import PageNumberPagination

from employees.models import Employee, Department
from attendance.models import (
    AttendanceRecord, AttendanceLog, Leave, Holiday, LeaveType,
    RamadanPeriod, ShiftAssignment
)
from attendance.services import ShiftService, RamadanService
from attendance.services.report_service import ReportService
from attendance.serializers import (
    ShiftSerializer, AttendanceRecordSerializer, AttendanceLogSerializer,
    LeaveSerializer, HolidaySerializer
)
from attendance.utils import process_attendance_excel, process_daily_attendance, get_attendance_summary

@login_required
def attendance_list(request):
    """Display attendance list page"""
    # Get filter parameters
    start_date = request.GET.get('start_date', date.today().strftime('%Y-%m-%d'))
    end_date = request.GET.get('end_date', date.today().strftime('%Y-%m-%d'))
    department = request.GET.get('department', '')
    search = request.GET.get('search', '')

    # Base queryset
    queryset = AttendanceLog.objects.filter(date=date.today())

    # Apply filters
    if department:
        queryset = queryset.filter(employee__department_id=department)
    if search:
        queryset = queryset.filter(
            Q(employee__first_name__icontains=search) |
            Q(employee__last_name__icontains=search) |
            Q(employee__employee_number__icontains=search)
        )

    # Get holidays for the current date
    is_holiday = Holiday.objects.filter(
        Q(date=date.today()) & Q(is_active=True)
    ).exists()

    # Calculate summary counts
    if is_holiday:
        # On holidays, only count people who came to work
        present_count = queryset.filter(first_in_time__isnull=False).count()
        late_count = 0
        absent_count = 0
        # Filter out absent employees on holidays
        queryset = queryset.filter(first_in_time__isnull=False)
    else:
        present_count = queryset.filter(first_in_time__isnull=False, is_late=False).count()
        late_count = queryset.filter(is_late=True).count()
        absent_count = queryset.filter(first_in_time__isnull=True).count()

    on_leave_count = Leave.objects.filter(
        Q(start_date__lte=date.today()) &
        Q(end_date__gte=date.today()) &
        Q(status='approved')
    ).count()

    context = {
        'departments': Department.objects.all(),
        'present_count': present_count,
        'late_count': late_count,
        'absent_count': absent_count,
        'on_leave_count': on_leave_count,
    }
    return render(request, 'attendance/attendance_list.html', context)

@login_required
def mark_attendance(request):
    """View for manual attendance marking"""
    return render(request, 'attendance/mark_attendance.html')

@login_required
def upload_attendance(request):
    """Display attendance upload page"""
    return render(request, 'attendance/upload_attendance.html')

@login_required
def attendance_report(request):
    """
    View for the attendance report page.
    Initializes the page with departments and other necessary data.
    The actual report data is loaded via AJAX using the API endpoints.
    """
    context = {
        'departments': Department.objects.all(),
        'today': date.today().strftime('%Y-%m-%d'),
        'title': 'Attendance Reports',  # For page title
        'active_tab': 'reports'  # For navigation highlighting
    }

    return render(request, 'attendance/attendance_report.html', context)

@login_required
def attendance_detail_view(request):
    """View for displaying and editing attendance details"""
    try:
        personnel_id = request.GET.get('personnel_id')
        employee_id = request.GET.get('employee_id')  # Support both ID types
        date_str = request.GET.get('date')

        # Get employee by either personnel_id or employee_id
        if personnel_id:
            employee = get_object_or_404(Employee, employee_number=personnel_id)
        elif employee_id:
            employee = get_object_or_404(Employee, id=employee_id)
        else:
            raise Http404("Missing employee identifier")

        # Handle date parameter
        if date_str:
            try:
                # Try parsing YYYY-MM-DD format first
                date_obj = datetime.strptime(date_str.strip(), '%Y-%m-%d').date()
            except ValueError:
                try:
                    # Fallback to MMM DD, YYYY format
                    date_obj = datetime.strptime(date_str.strip(), '%b %d, %Y').date()
                except ValueError:
                    raise Http404("Invalid date format")

            log = get_object_or_404(AttendanceLog, employee=employee, date=date_obj)

            # Get all raw attendance records for this date
            records = AttendanceRecord.objects.filter(
                employee=employee,
                timestamp__date=date_obj,
                is_active=True
            ).order_by('timestamp')

            context = get_attendance_detail_context(employee, log, records)

        else:
            # If no date specified, show monthly view
            start_date = request.GET.get('start_date', date.today().replace(day=1).strftime('%Y-%m-%d'))
            end_date = request.GET.get('end_date', date.today().strftime('%Y-%m-%d'))

            attendance_logs = AttendanceLog.objects.filter(
                employee=employee,
                date__range=[start_date, end_date]
            ).order_by('-date')

            # Paginate results
            paginator = Paginator(attendance_logs, 31)  # Show up to a month of records per page
            page = request.GET.get('page', 1)
            attendance_records = paginator.get_page(page)

            context = {
                'employee': employee,
                'attendance_records': attendance_records,
                'start_date': start_date,
                'end_date': end_date,
                'title': f'Attendance Detail - {employee.first_name} {employee.last_name}',
                'active_tab': 'reports'
            }

        return render(request, 'attendance/attendance_detail.html', context)

    except Exception as e:
        if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
            return JsonResponse({'error': str(e)}, status=500)
        messages.error(request, f"Error loading attendance details: {str(e)}")
        return redirect('attendance:attendance_list')

@login_required
def reprocess_attendance_view(request):
    """View for triggering attendance reprocessing"""
    if request.method == 'POST':
        try:
            start_date = request.POST.get('start_date')
            end_date = request.POST.get('end_date')
            employee_id = request.POST.get('employee_id')

            command_args = []

            if start_date and end_date:
                command_args.extend(['--date-range', start_date, end_date])
            elif start_date:
                command_args.extend(['--date', start_date])

            if employee_id:
                command_args.extend(['--employee-id', employee_id])

            # Call the management command
            call_command('reprocess_attendance', *command_args)

            messages.success(request, "Attendance logs have been reprocessed successfully")
        except Exception as e:
            messages.error(request, f"Error reprocessing attendance logs: {str(e)}")

    return redirect('attendance:attendance_list')

def get_attendance_detail_context(employee, log, records):
    """Helper function to get context for attendance detail view"""
    # Find first IN and last OUT records
    first_in_record = None
    last_out_record = None
    for record in records:
        if record.event_point == 'IN':
            if not first_in_record:
                first_in_record = record
        elif record.event_point == 'OUT':
            last_out_record = record

    raw_records = []
    for record in records:
        is_first_in = record == first_in_record
        is_last_out = record == last_out_record

        raw_records.append({
            'id': record.id,
            'time': record.timestamp.strftime('%I:%M %p'),
            'event_point': record.event_point,
            'description': record.event_description or 'Normal Punch',
            'device': record.device_name or 'Unknown Device',
            'is_first_in': is_first_in,
            'is_last_out': is_last_out,
            'label': ' (First)' if is_first_in else (' (Last)' if is_last_out else ''),
            'row_class': 'table-primary' if is_first_in or is_last_out else ''
        })

    # Calculate total hours
    total_hours = 0
    if log.first_in_time and log.last_out_time:
        first_in = datetime.combine(log.date, log.first_in_time)
        last_out = datetime.combine(log.date, log.last_out_time)
        duration = last_out - first_in
        total_hours = round(duration.total_seconds() / 3600, 2)

    return {
        'employee_name': employee.get_full_name(),
        'personnel_id': employee.employee_number,
        'department': employee.department.name if employee.department else '-',
        'designation': employee.designation or '-',
        'date': log.date.strftime('%b %d, %Y'),
        'day': log.date.strftime('%A'),
        'raw_records': raw_records,
        'stats': {
            'status': 'Late' if log.is_late else ('Present' if log.first_in_time else 'Absent'),
            'total_hours': f"{total_hours:.2f}",
            'first_in': log.first_in_time.strftime('%I:%M %p') if log.first_in_time else '-',
            'last_out': log.last_out_time.strftime('%I:%M %p') if log.last_out_time else '-',
            'is_late': log.is_late
        }
    }

@login_required
def attendance_report(request):
    """View for displaying attendance reports and analytics"""
    context = {
        'departments': Department.objects.all()
    }
    return render(request, 'attendance/attendance_report.html', context)

@login_required
def reprocess_attendance_view(request):
    """View for triggering attendance reprocessing"""
    if request.method == 'POST':
        try:
            start_date = request.POST.get('start_date')
            end_date = request.POST.get('end_date')
            employee_id = request.POST.get('employee_id')

            command_args = []
            
            if start_date and end_date:
                command_args.extend(['--date-range', start_date, end_date])
            elif start_date:
                command_args.extend(['--date', start_date])
                
            if employee_id:
                command_args.extend(['--employee-id', employee_id])

            # Call the management command
            call_command('reprocess_attendance', *command_args)
            
            messages.success(request, "Attendance logs have been reprocessed successfully")
        except Exception as e:
            messages.error(request, f"Error reprocessing attendance logs: {str(e)}")

    return redirect('attendance:attendance_list')

# API ViewSets
class AttendanceRecordViewSet(viewsets.ModelViewSet):
    """ViewSet for managing raw attendance records"""
    serializer_class = AttendanceRecordSerializer
    permission_classes = [IsAuthenticated]
    queryset = AttendanceRecord.objects.all()

    @action(detail=False, methods=['post'], parser_classes=[MultiPartParser])
    def upload_excel(self, request):
        """Handle Excel file upload"""
        if 'file' not in request.FILES:
            return Response({'error': 'No file provided'}, status=status.HTTP_400_BAD_REQUEST)

        try:
            excel_file = request.FILES['file']
            records_created, duplicates, total_records, new_employees, unique_dates = process_attendance_excel(excel_file)

            # Process logs for each unique date in the uploaded file
            logs_created = 0
            for date_obj in unique_dates:
                logs_created += process_daily_attendance(date_obj)

            return Response({
                'message': 'File processed successfully',
                'new_records': records_created,
                'duplicate_records': duplicates,
                'total_records': total_records,
                'logs_created': logs_created,
                'new_employees': new_employees,
                'success': True
            })
        except Exception as e:
            return Response({
                'error': str(e),
                'success': False
            }, status=status.HTTP_400_BAD_REQUEST)

class LargeResultsSetPagination(PageNumberPagination):
    """Custom pagination class for large result sets"""
    page_size = 400
    page_size_query_param = 'page_size'
    max_page_size = 1000

class AttendanceLogViewSet(viewsets.ModelViewSet):
    """ViewSet for managing processed attendance logs"""
    serializer_class = AttendanceLogSerializer
    permission_classes = [IsAuthenticated]
    queryset = AttendanceLog.objects.all()
    pagination_class = LargeResultsSetPagination

    def get_queryset(self):
        queryset = AttendanceLog.objects.select_related('employee').all()
        start_date = self.request.query_params.get('start_date')
        end_date = self.request.query_params.get('end_date')
        employee_id = self.request.query_params.get('employee')
        department_id = self.request.query_params.get('department')

        if start_date:
            queryset = queryset.filter(date__gte=start_date)
        if end_date:
            queryset = queryset.filter(date__lte=end_date)
        if employee_id:
            queryset = queryset.filter(employee_id=employee_id)
        if department_id:
            queryset = queryset.filter(employee__department_id=department_id)

        return queryset

# API Views

class LargeResultsSetPagination(PageNumberPagination):
    """Custom pagination class for large result sets"""
    page_size = 400
    page_size_query_param = 'page_size'
    max_page_size = 1000

class AttendanceLogListViewSet(viewsets.ReadOnlyModelViewSet):
    """ViewSet for listing and retrieving attendance logs with filtering"""
    serializer_class = AttendanceLogSerializer
    permission_classes = [IsAuthenticated]
    queryset = AttendanceLog.objects.select_related('employee').all()
    pagination_class = LargeResultsSetPagination

    def get_queryset(self):
        queryset = super().get_queryset().order_by('-date')

        # Get filter parameters
        start_date = self.request.query_params.get('start_date')
        end_date = self.request.query_params.get('end_date')
        department = self.request.query_params.get('department')
        status = self.request.query_params.get('status')
        search = self.request.query_params.get('search')

        # Apply filters
        if start_date:
            try:
                start_date = datetime.strptime(start_date, '%Y-%m-%d').date()
                queryset = queryset.filter(date__gte=start_date)
            except ValueError:
                pass

        if end_date:
            try:
                end_date = datetime.strptime(end_date, '%Y-%m-%d').date()
                queryset = queryset.filter(date__lte=end_date)
            except ValueError:
                pass

        if department:
            queryset = queryset.filter(employee__department_id=department)

        if status:
            if status == 'late':
                queryset = queryset.filter(is_late=True)
            elif status == 'present':
                queryset = queryset.filter(first_in_time__isnull=False)
            elif status == 'absent':
                queryset = queryset.filter(first_in_time__isnull=True)

        if search:
            queryset = queryset.filter(
                Q(employee__first_name__icontains=search) |
                Q(employee__last_name__icontains=search) |
                Q(employee__employee_number__icontains=search)
            )

        return queryset

    def list(self, request, *args, **kwargs):
        queryset = self.get_queryset()
        
        # Get date parameters and parse them
        start_date = request.query_params.get('start_date')
        end_date = request.query_params.get('end_date')
        
        try:
            if not start_date:
                start_date = date.today()
            else:
                start_date = datetime.strptime(start_date, '%Y-%m-%d').date()
                
            if not end_date:
                end_date = date.today()
            else:
                end_date = datetime.strptime(end_date, '%Y-%m-%d').date()
        except ValueError:
            start_date = date.today()
            end_date = date.today()

        # Check for holidays in the date range
        holidays_in_range = Holiday.objects.filter(
            Q(date__range=[start_date, end_date]) & Q(is_active=True)
        )
        holiday_dates = set(h.date for h in holidays_in_range)

        # For holiday dates, only include employees who came to work
        holiday_queryset = queryset.filter(date__in=holiday_dates, first_in_time__isnull=False)
        non_holiday_queryset = queryset.exclude(date__in=holiday_dates)

        # Combine querysets
        queryset = non_holiday_queryset | holiday_queryset

        # Calculate summary counts
        present_count = (
            non_holiday_queryset.filter(first_in_time__isnull=False, is_late=False).count() +
            holiday_queryset.filter(first_in_time__isnull=False).count()
        )
        late_count = non_holiday_queryset.filter(is_late=True).count()
        absent_count = non_holiday_queryset.filter(first_in_time__isnull=True).count()
        
        # Get on leave count with proper date validation
        start_date = self.request.query_params.get('start_date')
        end_date = self.request.query_params.get('end_date')
        
        # Use today's date if no valid dates are provided
        try:
            if not start_date:
                start_date = date.today()
            else:
                start_date = datetime.strptime(start_date, '%Y-%m-%d').date()
                
            if not end_date:
                end_date = date.today()
            else:
                end_date = datetime.strptime(end_date, '%Y-%m-%d').date()
        except ValueError:
            # If date parsing fails, default to today
            start_date = date.today()
            end_date = date.today()

        on_leave_count = Leave.objects.filter(
            Q(start_date__lte=end_date) & 
            Q(end_date__gte=start_date) &
            Q(status='approved')
        ).count()

        # Get paginated results
        page = self.paginate_queryset(queryset)
        if page is not None:
            serializer = self.get_serializer(page, many=True)
            response = self.get_paginated_response(serializer.data)
            response.data['summary'] = {
                'present': present_count,
                'absent': absent_count,
                'late': late_count,
                'leave': on_leave_count
            }
            return response

        serializer = self.get_serializer(queryset, many=True)
        return Response({
            'results': serializer.data,
            'summary': {
                'present': present_count,
                'absent': absent_count,
                'late': late_count,
                'leave': on_leave_count
            }
        })

    def get_serializer_context(self):
        context = super().get_serializer_context()
        context['request'] = self.request
        return context


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_employee_attendance(request, employee_id):
    """Get attendance summary for an employee"""
    start_date = request.query_params.get('start_date')
    end_date = request.query_params.get('end_date')

    if not start_date or not end_date:
        return Response(
            {'error': 'Start date and end date are required'},
            status=status.HTTP_400_BAD_REQUEST
        )

    try:
        employee = get_object_or_404(Employee, id=employee_id)
        summary = get_attendance_summary(employee, start_date, end_date)
        return Response(summary)
    except Exception as e:
        return Response(
            {'error': str(e)},
            status=status.HTTP_500_INTERNAL_SERVER_ERROR
        )

@api_view(['GET'])
def attendance_details(request):
    """Get detailed attendance information for a specific log"""
    try:
        personnel_id = request.GET.get('personnel_id')
        date_str = request.GET.get('date')

        if not personnel_id or not date_str:
            return Response({'error': 'Missing required parameters'}, status=400)

        try:
            # Try parsing YYYY-MM-DD format
            date = datetime.strptime(date_str, '%Y-%m-%d').date()
        except ValueError:
            try:
                # Fallback to MMM DD, YYYY format
                date = datetime.strptime(date_str, '%b %d, %Y').date()
            except ValueError:
                return Response({'error': 'Invalid date format. Expected YYYY-MM-DD or MMM DD, YYYY'}, status=400)

        employee = Employee.objects.get(employee_number=personnel_id)
        log = AttendanceLog.objects.select_related('employee').get(employee=employee, date=date)

        # Get raw attendance records for this date
        records = AttendanceRecord.objects.filter(
            employee=employee,
            timestamp__date=date,
            is_active=True
        ).order_by('timestamp')

        raw_records = []
        for record in records:
            raw_records.append({
                'id': record.id,
                'time': record.timestamp.strftime('%I:%M %p'),
                'device': record.device_name or 'Unknown Device',
                'event_point': record.event_point,
                'description': record.event_description or 'Normal Punch'
            })

        # Calculate total hours
        total_hours = 0
        if log.first_in_time and log.last_out_time:
            first_in = datetime.combine(date, log.first_in_time)
            last_out = datetime.combine(date, log.last_out_time)
            duration = last_out - first_in
            total_hours = round(duration.total_seconds() / 3600, 2)

        return Response({
            'log_id': log.id,
            'date': log.date.strftime('%b %d, %Y'),
            'employee': log.employee.get_full_name(),
            'status': 'Late' if log.is_late else ('Present' if log.first_in_time else 'Absent'),
            'source': log.source or '-',
            'stats': {
                'status': 'Late' if log.is_late else ('Present' if log.first_in_time else 'Absent'),
                'total_hours': f"{total_hours:.2f}",
                'first_in': log.first_in_time.strftime('%I:%M %p') if log.first_in_time else '-',
                'last_out': log.last_out_time.strftime('%I:%M %p') if log.last_out_time else '-',
                'is_late': log.is_late
            },
            'raw_records': raw_records
        })
    except Exception as e:
        return Response({'error': str(e)}, status=400)


@api_view(['GET'])
def get_department_employees(request):
    """AJAX view to get employees by department"""
    department_id = request.GET.get('department')
    search_query = request.GET.get('q', '').strip()

    if search_query:
        employees = Employee.objects.filter(
            Q(employee_number__icontains=search_query) |
            Q(first_name__icontains=search_query) |
            Q(last_name__icontains=search_query)
        )
        if department_id:
            employees = employees.filter(department_id=department_id)
    elif department_id:
        employees = Employee.objects.filter(department_id=department_id)
    else:
        employees = Employee.objects.all()

    employees = employees.values('id', 'user__first_name', 'user__last_name')

    employee_list = [
        {
            'id': emp['id'],
            'name': f"{emp['user__first_name']} {emp['user__last_name']}"
        }
        for emp in employees
    ]

    return JsonResponse({'employees': employee_list})


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def attendance_detail_api(request):
    """API endpoint for getting attendance details"""
    try:
        personnel_id = request.GET.get('personnel_id')
        date_str = request.GET.get('date')

        if not personnel_id or not date_str:
            return Response({'error': 'Missing required parameters'}, status=400)

        # Try different date formats
        date_obj = None
        for date_format in ['%b %d, %Y', '%Y-%m-%d']:
            try:
                date_obj = datetime.strptime(date_str.strip(), date_format).date()
                break
            except ValueError:
                continue
        
        if not date_obj:
            return Response({'error': 'Invalid date format. Expected YYYY-MM-DD or MMM DD, YYYY'}, status=400)

        employee = Employee.objects.get(employee_number=personnel_id)
        log = AttendanceLog.objects.select_related('employee').get(employee=employee, date=date_obj)
        # Calculate total hours from minutes
        total_hours = f"{log.total_work_minutes // 60}h {log.total_work_minutes % 60}m" if log.total_work_minutes else "0h 0m"

        data = {
            'id': log.id,
            'employee_name': log.employee.get_full_name(),
            'personnel_id': log.employee.employee_number,
            'department': log.employee.department.name if log.employee.department else None,
            'designation': log.employee.designation,
            'date': log.date,
            'stats': {
                'status': log.status,
                'total_hours': total_hours,
                'first_in': log.first_in_time.strftime('%I:%M %p') if log.first_in_time else '-',
                'last_out': log.last_out_time.strftime('%I:%M %p') if log.last_out_time else '-'
            },
            'raw_records': []
        }

        # Add in time if exists
        if log.first_in_time:
            data['raw_records'].append({
                'id': log.id,
                'time': log.first_in_time.strftime('%I:%M %p'),
                'event_point': 'IN',
                'description': 'First In',
                'device': log.source
            })

        # Add out time if exists
        if log.last_out_time:
            data['raw_records'].append({
                'id': log.id,
                'time': log.last_out_time.strftime('%I:%M %p'),
                'event_point': 'OUT',
                'description': 'Last Out',
                'device': log.source
            })

        return Response(data)
    except AttendanceLog.DoesNotExist:
        return Response({'error': 'Log not found'}, status=404)

@api_view(['PATCH', 'DELETE'])
@permission_classes([IsAuthenticated])
def attendance_record_api(request, record_id):
    """API endpoint for updating or deleting attendance records"""
    try:
        log = AttendanceLog.objects.get(id=record_id)

        if request.method == 'DELETE':
            log.delete()
            return Response(status=204)

        if request.method == 'PATCH':
            time_str = request.data.get('time')
            reason = request.data.get('reason')

            if not time_str or not reason:
                return Response({'error': 'Time and reason are required'}, status=400)

            # Parse the time string
            try:
                hour, minute = map(int, time_str.split(':'))
                new_time = datetime.combine(log.date, time(hour, minute))

                # Update the appropriate time field based on the record type - assuming first record is IN and last is OUT
                records = AttendanceRecord.objects.filter(
                    attendancelog=log
                ).order_by('timestamp')

                if records.exists():
                    first_record = records.first()
                    last_record = records.last()

                    if log.first_in_time and log.first_in_time == first_record.timestamp.time(): #compare time not datetime
                        log.first_in_time = new_time.time() # set time only
                    elif log.last_out_time and log.last_out_time == last_record.timestamp.time(): #compare time not datetime
                        log.last_out_time = new_time.time() # set time only

                log.save()
                return Response({'status': 'success'})
            except ValueError:
                return Response({'error': 'Invalid time format'}, status=400)

    except AttendanceLog.DoesNotExist:
        return Response({'error': 'Record not found'}, status=404)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def add_attendance_record(request):
    """API endpoint for adding a new attendance record"""
    personnel_id = request.data.get('personnel_id')
    date_str = request.data.get('date')
    time_str = request.data.get('time')
    event_point = request.data.get('type') # using event_point instead of type as in models
    device_name = request.data.get('device_name') # device name
    reason = request.data.get('reason') # remarks instead of reason to match model field

    if not all([personnel_id, date_str, time_str, event_point, reason, device_name]): #check device_name and reason
        return Response({'error': 'All fields are required'}, status=400)

    try:
        employee = Employee.objects.get(employee_number=personnel_id)
        log_date = datetime.strptime(date_str, '%Y-%m-%d').date()
        record_time = datetime.strptime(time_str, '%H:%M').time() # only time part

        timestamp = datetime.combine(log_date, record_time) # combine date and time for timestamp

        # Create attendance record
        record = AttendanceRecord.objects.create(
            employee=employee,
            timestamp=timestamp,
            event_point=event_point, # use event_point
            device_name=device_name, # use device_name
            remarks=reason, # use remarks for reason
            source='manual' # set source to manual
        )

        return Response({'status': 'success', 'record_id': record.id }, status=status.HTTP_201_CREATED)

    except Employee.DoesNotExist:
        return Response({'error': 'Employee not found'}, status=status.HTTP_400_BAD_REQUEST)
    except ValueError as e:
        return Response({'error': f'Invalid data: {str(e)}'}, status=status.HTTP_400_BAD_REQUEST)
    except Exception as e:
        return Response({'error': f'Error creating record: {str(e)}'}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@api_view(['GET'])
def search_employees(request):
    """Search employees by ID or name"""
    query = request.GET.get('q', '').strip()
    department_id = request.GET.get('department')

    if not query:
        return Response([])

    try:
        # Build the query
        employee_query = Q(employee_number__icontains=query) | \
                        Q(first_name__icontains=query) | \
                        Q(last_name__icontains=query)

        # Add department filter if specified
        if department_id:
            employee_query &= Q(department_id=department_id)

        # Get employees matching the criteria
        employees = Employee.objects.filter(employee_query, is_active=True) \
                                 .select_related('department') \
                                 .order_by('employee_number')[:10]

        # Format response
        employee_list = [{
            'id': emp.id,
            'employee_number': emp.employee_number,
            'full_name': emp.get_full_name(),
            'department': emp.department.name if emp.department else None
        } for emp in employees]

        return Response(employee_list)

    except Exception as e:
        return Response(
            {'error': str(e)},
            status=status.HTTP_500_INTERNAL_SERVER_ERROR
        )
```

### 📄 hrms_project\attendance\views\calendar_views.py
```from datetime import datetime
from django.db.models import Q

from django.shortcuts import render
from django.contrib.auth.decorators import login_required
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response

from employees.models import Employee, Department
from attendance.models import (
    AttendanceRecord, AttendanceLog, Leave, Holiday, LeaveType,
    RamadanPeriod
)
from attendance.services import ShiftService, RamadanService


@login_required
def calendar_view(request):
    """View for displaying attendance calendar"""
    return render(request, 'attendance/calendar.html')

@login_required
def calendar_month(request):
    """View for monthly calendar"""
    context = {
        'view_type': 'month',
        'departments': Department.objects.all()
    }
    return render(request, 'attendance/calendar.html', context)

@login_required
def calendar_week(request):
    """View for weekly calendar"""
    context = {
        'view_type': 'week',
        'departments': Department.objects.all()
    }
    return render(request, 'attendance/calendar.html', context)

@login_required
def calendar_department(request):
    """View for department-wise calendar"""
    context = {
        'view_type': 'department',
        'departments': Department.objects.all()
    }
    return render(request, 'attendance/calendar.html', context)


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def calendar_events(request):
    """Get attendance events for calendar"""
    start_date = request.query_params.get('start')
    end_date = request.query_params.get('end')
    department = request.query_params.get('department')
    employee = request.query_params.get('employee')

    try:
        # Parse dates in YYYY-MM-DD format
        start = datetime.strptime(start_date, '%Y-%m-%d').date()
        end = datetime.strptime(end_date, '%Y-%m-%d').date()

        # Get holidays in the date range
        holidays = Holiday.objects.filter(
            date__range=[start, end],
            is_active=True
        )
        
        # Create holiday events first
        events = []
        for holiday in holidays:
            events.append({
                'id': f'holiday_{holiday.id}',
                'title': holiday.name,  # Show holiday name instead of employee
                'start': holiday.date.isoformat(),
                'end': holiday.date.isoformat(),
                'color': '#6f42c1',  # purple for holidays
                'allDay': True,
                'extendedProps': {
                    'type': 'holiday',
                    'holiday_type': holiday.holiday_type,
                    'description': holiday.description,
                    'tooltip': f"{holiday.name} - {holiday.description if holiday.description else ''}"
                }
            })

        # Build query for attendance logs
        query = Q(date__range=[start, end])
        if department:
            query &= Q(employee__department_id=department)
        if employee:
            query &= Q(employee_id=employee)

        logs = AttendanceLog.objects.filter(query).select_related('employee')

        def calculate_late_by(log):
            if not log.first_in_time or not log.shift:
                return None
            shift_start = log.shift.start_time
            first_in = log.first_in_time
            if first_in > shift_start:
                late_by = datetime.combine(log.date, first_in) - datetime.combine(log.date, shift_start)
                return str(late_by)
            return None

        def calculate_work_hours(log):
            if not log.first_in_time or not log.last_out_time:
                return None
            work_time = datetime.combine(log.date, log.last_out_time) - datetime.combine(log.date, log.first_in_time)
            return str(work_time)

        attendance_events = []
        for log in logs:
            # Skip weekends (Friday) unless there's attendance
            if log.date.weekday() == 4:  # Friday is 4 in Python's weekday() (0 = Monday)
                if not log.first_in_time:
                    continue  # Skip showing absent on Fridays
            
            status = log.status.title()
            
            # Set color based on status
            if status == 'Present':
                color = '#28a745'  # green
            elif status == 'Absent' and log.date.weekday() != 4:  # Don't show absent for Fridays
                color = '#dc3545'  # red
            elif status == 'Late':
                color = '#ffc107'  # yellow
            elif status == 'Leave':
                color = '#17a2b8'  # cyan
            else:
                continue  # Skip other statuses like holiday since we handle them separately

            event = {
                'id': f'attendance_{log.id}',
                'title': f"{log.employee.get_full_name()} - {status}",
                'start': log.date.isoformat(),
                'end': log.date.isoformat(),
                'color': color,
                'extendedProps': {
                    'type': 'attendance',
                    'employee_id': log.employee.id,
                    'employee': log.employee.get_full_name(),
                    'department': log.employee.department.name if log.employee.department else None,
                    'status': status,
                    'status_color': color.replace('#', ''),
                    'time_in': log.first_in_time.strftime('%I:%M %p') if log.first_in_time else None,
                    'time_out': log.last_out_time.strftime('%I:%M %p') if log.last_out_time else None,
                    'late_by': calculate_late_by(log),
                    'work_hours': calculate_work_hours(log),
                    'tooltip': f"{log.employee.get_full_name()} - {status}\n" +
                             f"In: {log.first_in_time.strftime('%I:%M %p') if log.first_in_time else 'N/A'}\n" +
                             f"Out: {log.last_out_time.strftime('%I:%M %p') if log.last_out_time else 'N/A'}"
                }
            }
            attendance_events.append(event)

        events.extend(attendance_events)

        return Response(events)
    except (ValueError, TypeError) as e:
        print(e)
        return Response({
            'error': f'Invalid date format. Expected YYYY-MM-DD, received: start={start_date}, end={end_date}',
            'details': str(e)
        }, status=400)


# API Views - Keep these API views here as they are general API related
@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_calendar_events(request):
    """API endpoint for getting calendar events"""
    start_date = request.query_params.get('start')
    end_date = request.query_params.get('end')
    
    try:
        start = datetime.strptime(start_date, '%Y-%m-%d').date()
        end = datetime.strptime(end_date, '%Y-%m-%d').date()
        
        logs = AttendanceLog.objects.filter(
            date__range=[start, end]
        ).select_related('employee')
        
        events = []
        for log in logs:
            status = 'Present'
            color = '#28a745'  # green
            
            if not log.first_in_time:
                status = 'Absent'
                color = '#dc3545'  # red
            elif log.is_late:
                status = 'Late'
                color = '#ffc107'  # yellow
                
            events.append({
                'id': log.id,
                'title': f"{log.employee.get_full_name()} - {status}",
                'start': log.date.isoformat(),
                'end': log.date.isoformat(),
                'color': color,
                'extendedProps': {
                    'employee_id': log.employee.id,
                    'status': status,
                    'in_time': log.first_in_time.strftime('%H:%M') if log.first_in_time else None,
                    'out_time': log.last_out_time.strftime('%H:%M') if log.last_out_time else None
                }
            })
            
        return Response(events)
    except (ValueError, TypeError):
        return Response({'error': 'Invalid date format'}, status=400)

```

### 📄 hrms_project\attendance\views\holiday_views.py
```from datetime import datetime, date, timedelta, time
from typing import List, Dict, Any

from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.db import transaction
from django.db.models import Q
from django.http import JsonResponse, Http404
from django.utils import timezone
from django.contrib import messages
from rest_framework import status
from rest_framework import viewsets
from rest_framework.decorators import api_view, permission_classes, action
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser
from rest_framework.pagination import PageNumberPagination

from employees.models import Employee, Department
from attendance.models import (
    AttendanceRecord, AttendanceLog, Leave, Holiday, LeaveType,
    RamadanPeriod
)
from attendance.services import ShiftService, RamadanService
from attendance.serializers import ShiftSerializer, AttendanceRecordSerializer, AttendanceLogSerializer, LeaveSerializer, HolidaySerializer
from attendance.utils import process_attendance_excel, process_daily_attendance, get_attendance_summary
from attendance.forms import HolidayForm


@login_required
def holiday_list(request):
    """View for displaying list of holidays"""
    holidays = Holiday.objects.all().order_by('-date')
    context = {
        'holidays': holidays,
        'title': 'Holidays'
    }
    return render(request, 'attendance/holiday_list.html', context)

@login_required
def holiday_create(request):
    """View for creating new holidays"""
    if request.method == 'POST':
        form = HolidayForm(request.POST)
        if form.is_valid():
            holiday = form.save(commit=False)
            holiday.created_by = request.user
            holiday.save()
            form.save_m2m()  # Save many-to-many relationships
            messages.success(request, 'Holiday created successfully.')
            return redirect('attendance:holiday_list')
    else:
        form = HolidayForm()
    
    context = {
        'form': form,
        'title': 'Create Holiday',
        'departments': Department.objects.all()
    }
    return render(request, 'attendance/holiday_form.html', context)


@login_required
def recurring_holidays(request):
    """View for managing recurring holidays"""
    holidays = Holiday.objects.filter(is_recurring=True).order_by('-date')
    departments = Department.objects.all()
    context = {
        'holidays': holidays,
        'departments': departments,
        'title': 'Recurring Holidays'
    }
    return render(request, 'attendance/recurring_holidays.html', context)


@login_required
def preview_next_year_holidays(request):
    """Preview holidays for next year based on recurring holidays"""
    current_year = timezone.now().year
    next_year = current_year + 1
    
    # Get all recurring holidays
    recurring_holidays = Holiday.objects.filter(is_recurring=True)
    
    # Generate preview data
    preview_holidays = []
    for holiday in recurring_holidays:
        # Create a new date for next year while keeping month and day
        next_year_date = holiday.date.replace(year=next_year)
        preview_holidays.append({
            'name': holiday.name,
            'date': next_year_date.strftime('%Y-%m-%d'),
            'type': 'Recurring',
            'type': holiday.get_holiday_type_display()
        })
    
    return JsonResponse({'holidays': preview_holidays})


@login_required
def generate_next_year_holidays(request):
    """Generate holidays for next year based on recurring holidays"""
    if request.method != 'POST':
        return JsonResponse({'error': 'Only POST method is allowed'}, status=405)
    
    current_year = timezone.now().year
    next_year = current_year + 1
    count = 0
    
    # Get all recurring holidays
    recurring_holidays = Holiday.objects.filter(is_recurring=True)
    
    with transaction.atomic():
        for holiday in recurring_holidays:
            # Create a new date for next year while keeping month and day
            next_year_date = holiday.date.replace(year=next_year)
            
            # Check if holiday already exists for this date
            if not Holiday.objects.filter(date=next_year_date, name=holiday.name).exists():
                # Create new holiday
                new_holiday = Holiday.objects.create(
                    name=holiday.name,
                    date=next_year_date,
                    description=holiday.description,
                    is_recurring=True,
                    created_by=request.user
                )
                
                # Set other fields from the recurring holiday
                count += 1
    
    return JsonResponse({'count': count})


@login_required
def holiday_edit(request, pk):
    """View for editing holidays"""
    holiday = get_object_or_404(Holiday, pk=pk)
    
    if request.method == 'POST':
        form = HolidayForm(request.POST, instance=holiday)
        if form.is_valid():
            form.save()
            messages.success(request, 'Holiday updated successfully.')
            return redirect('attendance:holiday_list')
    else:
        form = HolidayForm(instance=holiday)
    
    context = {
        'form': form,
        'holiday': holiday,
        'title': 'Edit Holiday',
        'departments': Department.objects.all()
    }
    return render(request, 'attendance/holiday_form.html', context)


@login_required
def holiday_delete(request, pk):
    """View for deleting holidays"""
    holiday = get_object_or_404(Holiday, pk=pk)
    
    if request.method == 'POST':
        holiday.delete()
        messages.success(request, 'Holiday deleted successfully.')
        return redirect('attendance:holiday_list')
        
    context = {
        'holiday': holiday
    }
    return render(request, 'attendance/holiday_confirm_delete.html', context)


class HolidayViewSet(viewsets.ModelViewSet):
    """ViewSet for managing holidays"""
    serializer_class = HolidaySerializer
    permission_classes = [IsAuthenticated]
    queryset = Holiday.objects.all()

    def get_queryset(self):
        return Holiday.objects.filter(is_active=True).order_by('-date')
```

### 📄 hrms_project\attendance\views\leave_views.py
```from datetime import datetime, date, timedelta
from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.db.models import Q, Sum, Count
from decimal import Decimal
from django.db import models
from django.utils import timezone
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from django.http import JsonResponse
from django.views.decorators.http import require_POST

from ..models import (
    Leave, LeaveType, LeaveBalance, LeaveBeginningBalance,
    AttendanceLog, Holiday, LeaveDocument, LeaveActivity  # Add LeaveActivity to imports
)
from ..services.leave_rule_service import LeaveRuleService
from ..serializers import LeaveSerializer
from ..forms import LeaveBalanceUploadForm, LeaveRequestForm
from employees.models import Employee, Department  # Add Department here

@login_required
def leave_request_list(request):
    """Display leave requests list page"""
    # Initialize query
    leave_requests = Leave.objects.select_related(
        'employee',
        'employee__department',
        'leave_type'
    ).filter(is_active=True)
    
    # For non-staff users, only show their own requests
    if not request.user.is_staff:
        leave_requests = leave_requests.filter(employee=request.user.employee)
    
    # Apply filters if provided
    status = request.GET.get('status')
    leave_type = request.GET.get('leave_type')
    department = request.GET.get('department')
    employee = request.GET.get('employee')
    start_date = request.GET.get('start_date')
    end_date = request.GET.get('end_date')
    
    if status:
        leave_requests = leave_requests.filter(status=status)
    if leave_type:
        leave_requests = leave_requests.filter(leave_type__code=leave_type)
    if department and request.user.is_staff:
        leave_requests = leave_requests.filter(employee__department_id=department)
    if employee and request.user.is_staff:
        leave_requests = leave_requests.filter(employee_id=employee)
    if start_date:
        leave_requests = leave_requests.filter(start_date__gte=start_date)
    if end_date:
        leave_requests = leave_requests.filter(end_date__lte=end_date)
    
    # Order by most recent first
    leave_requests = leave_requests.order_by('-created_at')
    
    # Get leave types and departments for filters
    leave_types = LeaveType.objects.filter(is_active=True)
    departments = Department.objects.all() if request.user.is_staff else []
    
    # Get employees for filter (only for staff users)
    employees = []
    if request.user.is_staff:
        employees_query = Employee.objects.all()
        if department:
            employees_query = employees_query.filter(department_id=department)
        employees = employees_query.order_by('first_name', 'last_name')
    
    context = {
        'leave_requests': leave_requests,
        'leave_types': leave_types,
        'departments': departments,
        'employees': employees,
        'selected_employee': employee,  # Pass selected employee ID for maintaining filter state
    }
    
    return render(request, 'attendance/leave_request_list.html', context)

@login_required
def leave_request_create(request):
    """Display leave request creation page and handle form submission"""
    # Get selected employee from query params or POST data
    employee_id = request.GET.get('employee') or request.POST.get('employee')
    employee = None
    leave_balances = None
    departments = None
    employees = None
    
    # For staff users, allow employee selection
    if request.user.is_staff:
        departments = Department.objects.all().order_by('name')
        employees_query = Employee.objects.all()
        
        # Filter by department if provided
        department_id = request.GET.get('department')
        if department_id:
            employees_query = employees_query.filter(department_id=department_id)
        
        # Filter by search query if provided
        search_query = request.GET.get('search', '').strip()
        if search_query:
            employees_query = employees_query.filter(
                Q(employee_number__icontains=search_query) |
                Q(first_name__icontains=search_query) |
                Q(last_name__icontains=search_query)
            )
        
        employees = employees_query.order_by('first_name', 'last_name')
        
        if employee_id:
            try:
                employee = employees_query.get(id=employee_id)
                leave_balances = LeaveBalance.objects.filter(employee=employee)
            except Employee.DoesNotExist:
                messages.error(request, "Selected employee not found.")
                return redirect('attendance:leave_request_list')
    else:
        # For regular users, only allow them to request for themselves
        try:
            employee = request.user.employee
            leave_balances = LeaveBalance.objects.filter(employee=employee)
        except AttributeError:
            messages.error(request, "No employee record found for your user account. Please contact HR.")
            return redirect('attendance:leave_request_list')
    
    if request.method == 'POST':
        # Handle AJAX request for updating sub-types
        if request.headers.get('X-Requested-With') == 'XMLHttpRequest' and request.POST.get('update_sub_types'):
            form = LeaveRequestForm(request.POST)
            leave_type_id = request.POST.get('leave_type')
            if leave_type_id:
                form.set_sub_type_choices(leave_type_id)
                return JsonResponse({
                    'sub_type_choices': form.fields['leave_sub_type'].choices
                })
            return JsonResponse({'sub_type_choices': []})

        if not employee:
            messages.error(request, "Please select an employee first.")
            return redirect('attendance:leave_request_create')
            
        form = LeaveRequestForm(request.POST, request.FILES)
        if form.is_valid():
            leave_request = form.save(commit=False)
            leave_request.employee = employee
            leave_request.status = 'pending'
            
            # Ensure end date is never less than start date
            if leave_request.end_date < leave_request.start_date:
                leave_request.end_date = leave_request.start_date
            
            # Calculate duration based on start and end dates and leave type
            duration = (leave_request.end_date - leave_request.start_date).days + 1
            
            # Adjust duration based on leave sub-type
            leave_sub_type = form.cleaned_data.get('leave_sub_type')
            if leave_sub_type:
                if leave_sub_type in ['half_day', 'morning', 'afternoon']:
                    duration = 0.5
                elif '_' in leave_sub_type:
                    # Extract days from sub-type code (e.g., '3_days' -> 3)
                    try:
                        days = int(leave_sub_type.split('_')[0])
                        duration = days
                    except (ValueError, IndexError):
                        pass
            
            leave_request.duration = duration
            
            # Validate leave request using LeaveRuleService
            is_valid, message, data = LeaveRuleService.validate_leave_request(
                employee=employee,
                leave_type=leave_request.leave_type,
                sub_type=leave_sub_type,
                start_date=leave_request.start_date,
                end_date=leave_request.end_date
            )
            
            if not is_valid:
                messages.error(request, message)
                return render(request, 'attendance/leave_request_form.html', {
                    'form': form,
                    'leave_balances': leave_balances,
                    'departments': departments,
                    'employees': employees,
                    'selected_employee': employee
                })
            
            # If HR admin is creating the request, auto-approve it
            if request.user.is_staff:
                leave_request.status = 'approved'
                leave_request.approved_by = request.user
                leave_request.approved_at = timezone.now()
            
            leave_request.save()
            
            # Create activity record for leave creation
            LeaveActivity.objects.create(
                leave=leave_request,
                actor=request.user,
                action='create',
                details=f"Leave request created by {request.user.get_full_name()}"
            )
            
            # Handle document upload if provided
            if form.cleaned_data.get('document'):
                LeaveDocument.objects.create(
                    leave=leave_request,
                    document=form.cleaned_data['document'],
                    document_type='supporting_document'
                )
            
            messages.success(request, 'Leave request submitted successfully')
            return redirect('attendance:leave_request_list')
    else:
        form = LeaveRequestForm()
    
    # Calculate balance percentages for progress bars
    if leave_balances and employee:
        for balance in leave_balances:
            # Get the leave type
            leave_type = balance.leave_type
            
            # For annual leave types, calculate the balance more accurately
            if leave_type.code in ['ANNUAL', 'HALF']:
                # Get beginning balance
                beginning_balance = LeaveBeginningBalance.objects.filter(
                    employee=employee,
                    leave_type=leave_type
                ).order_by('-as_of_date').first()
                
                initial_balance = beginning_balance.balance_days if beginning_balance else 0
                
                # Get beginning date (try join_date first, then beginning balance, then default to Jan 1st)
                if beginning_balance:
                    start_date = beginning_balance.as_of_date
                else:
                    # Try to get join_date if it exists
                    try:
                        if hasattr(employee, 'join_date') and employee.join_date:
                            start_date = employee.join_date
                        else:
                            # Default to January 1st of current year if no join_date
                            current_year = date.today().year
                            start_date = date(current_year, 1, 1)
                    except AttributeError:
                        # Default to January 1st of current year if join_date field doesn't exist
                        current_year = date.today().year
                        start_date = date(current_year, 1, 1)
                
                # Calculate balance percentage based on used and pending days
                if balance.total_days > 0:
                    used_percentage = (balance.used_days / balance.total_days) * 100
                    pending_percentage = (balance.pending_days / balance.total_days) * 100
                    balance.balance_percentage = min(100, used_percentage + pending_percentage)
                else:
                    balance.balance_percentage = 0
            else:
                # For other leave types, use a simpler calculation
                if balance.total_days > 0:
                    used_percentage = (balance.used_days / balance.total_days) * 100
                    pending_percentage = (balance.pending_days / balance.total_days) * 100
                    balance.balance_percentage = min(100, used_percentage + pending_percentage)
                else:
                    balance.balance_percentage = 0
    
    return render(request, 'attendance/leave_request_form.html', {
        'form': form,
        'leave_balances': leave_balances,
        'departments': departments,
        'employees': employees,
        'selected_employee': employee
    })

@login_required
def leave_request_detail(request, pk):
    """Display leave request details page"""
    leave = get_object_or_404(Leave.objects.select_related(
        'employee',
        'employee__department',
        'leave_type',
        'approved_by'
    ), pk=pk)
    
    # Get similar leaves (same type, same employee)
    similar_leaves = Leave.objects.filter(
        employee=leave.employee,
        leave_type=leave.leave_type,
        is_active=True
    ).exclude(
        pk=pk  # Exclude current leave
    ).select_related(
        'employee',
        'leave_type'
    ).order_by('-created_at')
    
    # Get leave balances
    balances = {
        'annual': {'remaining': 0},
        'sick': {'remaining': 0},
        'permission': {'remaining': 0}
    }
    
    try:
        leave_balances = LeaveBalance.objects.filter(
            employee=leave.employee,
            is_active=True
        ).select_related('leave_type')
        
        for balance in leave_balances:
            if balance.leave_type.code == 'ANNUAL':
                balances['annual']['remaining'] = balance.available_days
            elif balance.leave_type.code == 'SICK':
                balances['sick']['remaining'] = balance.available_days
            elif balance.leave_type.code == 'PERMISSION':
                balances['permission']['remaining'] = balance.available_days
    except LeaveBalance.DoesNotExist:
        pass
    
    context = {
        'leave': leave,
        'similar_leaves': similar_leaves,
        'balance': balances
    }
    
    return render(request, 'attendance/leave_request_detail.html', context)


@login_required
def leave_balance(request):
    """View for showing employee leave balances and handling beginning balance imports"""
    from employees.models import Employee, Department
    from django.db.models import Q
    
    # Get query parameters
    selected_department = request.GET.get('department')
    selected_employee = request.GET.get('employee')
    search_query = request.GET.get('search', '').strip()
    
    # Initialize employee
    employee = None
    
    # For staff users, allow employee selection
    if request.user.is_staff:
        # Get departments and employees for filters
        departments = Department.objects.all().order_by('name')
        employees_query = Employee.objects.all()
        
        # Filter employees by department if selected
        if selected_department:
            employees_query = employees_query.filter(department_id=selected_department)
            
        # Filter by search query (employee number or name)
        if search_query:
            employees_query = employees_query.filter(
                Q(employee_number__icontains=search_query) |
                Q(first_name__icontains=search_query) |
                Q(last_name__icontains=search_query)
            )
            
        # Get selected employee if any
        if selected_employee:
            try:
                employee = employees_query.get(id=selected_employee)
            except Employee.DoesNotExist:
                messages.error(request, "Selected employee not found.")
                
        employees = employees_query.order_by('first_name', 'last_name')
    else:
        # For regular users, only show their own balances
        try:
            employee = request.user.employee
        except AttributeError:
            messages.error(request, "No employee record found for your user account. Please contact HR.")
            return redirect('attendance:attendance_list')
        
        departments = []
        employees = []

    # Handle CSV upload for beginning balances
    if request.method == 'POST':
        form = LeaveBalanceUploadForm(request.POST, request.FILES)
        if form.is_valid():
            try:
                csv_file = request.FILES['csv_file']
                as_of_date = form.cleaned_data['as_of_date']
                leave_type_code = form.cleaned_data['leave_type_code']
                
                # Get the leave type
                leave_type = get_object_or_404(LeaveType, code=leave_type_code)
                
                # Process CSV file
                import csv
                from io import TextIOWrapper
                decoded_file = TextIOWrapper(csv_file.file, encoding='utf-8')
                reader = csv.DictReader(decoded_file)
                
                success_count = 0
                error_count = 0
                for row in reader:
                    try:
                        emp_number = row['employee_number']
                        balance = float(row['leave_balance'])
                        
                        # Get employee by number
                        emp = Employee.objects.get(employee_number=emp_number)
                        
                        # Create or update beginning balance
                        LeaveBeginningBalance.objects.update_or_create(
                            employee=emp,
                            leave_type=leave_type,
                            as_of_date=as_of_date,
                            defaults={'balance_days': balance}
                        )
                        success_count += 1
                    except (Employee.DoesNotExist, KeyError, ValueError) as e:
                        error_count += 1
                        continue
                
                messages.success(request, f"Successfully processed {success_count} records. {error_count} records had errors.")
            except Exception as e:
                messages.error(request, f"Error processing file: {str(e)}")
    else:
        form = LeaveBalanceUploadForm()

    # Get all leave types and balances
    leave_types = LeaveType.objects.all()
    balances = []
    
    # Get beginning balances based on selected employee or user
    if request.user.is_staff:
        if employee:
            beginning_balances = LeaveBeginningBalance.objects.filter(
                employee=employee
            ).select_related('leave_type', 'employee').order_by('-as_of_date')
        else:
            beginning_balances = LeaveBeginningBalance.objects.all().select_related('leave_type', 'employee').order_by('-as_of_date')
    else:
        beginning_balances = LeaveBeginningBalance.objects.filter(
            employee=employee
        ).select_related('leave_type').order_by('-as_of_date')

    # Initialize or get leave balances
    target_employee = employee if employee else request.user.employee if not request.user.is_staff else None
    
    if target_employee:
        # Initialize leave balances if they don't exist
        for leave_type in leave_types:
            LeaveBalance.objects.get_or_create(
                employee=target_employee,
                leave_type=leave_type,
                defaults={
                    'total_days': leave_type.days_allowed,
                    'used_days': 0
                }
            )
        
        # Get balances for the target employee
        for leave_type in leave_types:
            leave_balance = LeaveBalance.objects.filter(employee=target_employee, leave_type=leave_type).first()
            
            if leave_type.code in ['ANNUAL', 'HALF']:  # Special calculation for annual and half-day leaves
                # Get beginning balance
                beginning_balance = LeaveBeginningBalance.objects.filter(
                    employee=target_employee,
                    leave_type=leave_type
                ).order_by('-as_of_date').first()
                
                initial_balance = beginning_balance.balance_days if beginning_balance else 0
                
                # Get beginning date (try join_date first, then beginning balance, then default to Jan 1st)
                if beginning_balance:
                    start_date = beginning_balance.as_of_date
                else:
                    # Try to get join_date if it exists
                    try:
                        if hasattr(target_employee, 'join_date') and target_employee.join_date:
                            start_date = target_employee.join_date
                        else:
                            # Default to January 1st of current year if no join_date
                            current_year = date.today().year
                            start_date = date(current_year, 1, 1)
                    except AttributeError:
                        # Default to January 1st of current year if join_date field doesn't exist
                        current_year = date.today().year
                        start_date = date(current_year, 1, 1)
                    
                end_date = date.today()
                
                try:
                    # Get holidays for the period once
                    holiday_dates = set(Holiday.objects.filter(
                        date__range=[start_date, end_date]
                    ).values_list('date', flat=True))
                    
                    # Get attendance logs for the period
                    attendance_logs = set(AttendanceLog.objects.filter(
                        employee=target_employee,
                        date__range=[start_date, end_date],
                        status='present'  # Only count present days
                    ).values_list('date', flat=True))
                    
                    # Count Fridays that should be included
                    friday_count = 0
                    current_date = start_date
                    while current_date <= end_date:
                        if current_date.weekday() == 4:  # Friday
                            thursday = current_date - timedelta(days=1)
                            saturday = current_date + timedelta(days=1)
                            
                            # Check if Thursday or Saturday was attended or was a holiday
                            thursday_attended = thursday in attendance_logs or thursday in holiday_dates
                            saturday_attended = saturday in attendance_logs or saturday in holiday_dates
                            
                            if thursday_attended or saturday_attended:
                                friday_count += 1
                        
                        current_date += timedelta(days=1)
                    
                    # Calculate total working days including valid Fridays and holidays
                    total_working_days = Decimal(len(attendance_logs) + friday_count + len(holiday_dates))
                    
                    # Calculate monthly rate (2.5 days per month, assuming 30 working days per month)
                    daily_rate = Decimal('2.5') / Decimal('30')
                    
                    # Calculate accrued leave
                    accrued_days = total_working_days * daily_rate
                    
                    # Get used days and pending days
                    used_days = leave_balance.used_days if leave_balance else Decimal('0')
                    pending_days = leave_balance.pending_days if leave_balance else Decimal('0')
                    
                    # Calculate total and remaining days
                    total_days = Decimal(initial_balance) + accrued_days
                    remaining_days = total_days - used_days - pending_days
                    
                    # Update the balance object with calculated values
                    leave_balance.total_days = total_days
                    leave_balance.remaining_days = remaining_days
                    
                    # Calculate balance percentage based on used and pending days
                    if total_days > 0:
                        used_percentage = (used_days / total_days) * 100
                        pending_percentage = (pending_days / total_days) * 100
                        leave_balance.balance_percentage = min(100, used_percentage + pending_percentage)
                    else:
                        leave_balance.balance_percentage = 0
                    
                    # Add debug message
                    print(f"Leave calculation for {leave_type.code}:")
                    print(f"Start date: {start_date}, End date: {end_date}")
                    print(f"Working days: {len(attendance_logs)}, Fridays: {friday_count}, Holidays: {len(holiday_dates)}")
                    print(f"Total working days: {total_working_days}")
                    print(f"Daily rate: {daily_rate}, Accrued days: {accrued_days}")
                    print(f"Initial balance: {initial_balance}, Used days: {used_days}, Pending days: {pending_days}")
                    print(f"Total days: {total_days}, Remaining days: {remaining_days}")
                    
                except Exception as e:
                    print(f"Error in leave calculation: {str(e)}")
                    # If there's an error in calculation, use defaults
                    total_days = 0
                    remaining_days = 0
                    used_days = 0
                    pending_days = 0
            else:
                # For all other leave types, simply use the allowed days and subtract used days
                total_days = leave_type.days_allowed
                used_days = leave_balance.used_days if leave_balance else 0
                pending_days = leave_balance.pending_days if leave_balance else 0
                remaining_days = total_days - used_days - pending_days
                
                # Calculate balance percentage based on used and pending days
                if total_days > 0:
                    used_percentage = (used_days / total_days) * 100
                    pending_percentage = (pending_days / total_days) * 100
                    leave_balance.balance_percentage = min(100, used_percentage + pending_percentage)
                else:
                    leave_balance.balance_percentage = 0
            
            balances.append({
                'leave_type': leave_type,
                'total_days': round(total_days, 2),
                'used_days': round(used_days, 2),
                'pending_days': round(pending_days, 2),
                'available_days': round(remaining_days, 2)
            })

    # Add context for template
    context = {
        'form': form,
        'balances': balances,
        'beginning_balances': beginning_balances,
        'departments': departments,
        'employees': employees,
        'selected_department': selected_department,
        'selected_employee': selected_employee
    }

    return render(request, 'attendance/leave_balance.html', context)


@login_required
def leave_types(request):
    """View for managing leave types"""
    leave_types = LeaveType.objects.all().order_by('name')
    context = {
        'leave_types': leave_types
    }
    return render(request, 'attendance/leave_types.html', context)


class LeaveViewSet(viewsets.ModelViewSet):
    """ViewSet for managing leave requests"""
    serializer_class = LeaveSerializer
    permission_classes = [IsAuthenticated]
    queryset = Leave.objects.all()

    def get_queryset(self):
        queryset = Leave.objects.filter(is_active=True)
        status_param = self.request.query_params.get('status')
        if status_param:
            queryset = queryset.filter(status=status_param)
        return queryset

@login_required
@require_POST
def leave_request_action(request, pk, action):
    """Handle leave request actions (approve, reject, cancel, delete)"""
    if action not in ['approve', 'reject', 'cancel', 'delete']:
        return JsonResponse({'error': 'Invalid action'}, status=400)
        
    try:
        leave = Leave.objects.get(pk=pk, is_active=True)
        
        # Check permissions
        if action in ['approve', 'reject', 'delete']:
            if not request.user.is_staff:
                return JsonResponse({'error': 'Permission denied'}, status=403)
        elif action == 'cancel':
            if leave.employee.user != request.user and not request.user.is_staff:
                return JsonResponse({'error': 'Permission denied'}, status=403)
        
        if action == 'delete':
            # Delete all associated leave activities
            LeaveActivity.objects.filter(leave=leave).delete()
            
            # Mark leave as inactive
            leave.is_active = False
            leave.save()
        else:
            # Update leave status
            if action == 'approve':
                leave.status = 'approved'
                leave.approved_by = request.user
                leave.approved_at = timezone.now()
            elif action == 'reject':
                leave.status = 'rejected'
                leave.rejected_by = request.user
                leave.rejected_at = timezone.now()
            else:  # cancel
                leave.status = 'cancelled'
                leave.cancelled_at = timezone.now()
                
            leave.save()
            
            # Create activity record for this action
            LeaveActivity.objects.create(
                leave=leave,
                actor=request.user,
                action=action,
                details=f"Leave request {action}ed by {request.user.get_full_name()}"
            )
            
        return JsonResponse({'status': 'success'})
        
    except Leave.DoesNotExist:
        return JsonResponse({'error': 'Leave request not found'}, status=404)
```

### 📄 hrms_project\attendance\views\ramadan_views.py
```from django.contrib.auth.mixins import LoginRequiredMixin, PermissionRequiredMixin
from django.views.generic import ListView
from django.http import JsonResponse
from django.views import View
from django.shortcuts import get_object_or_404
import json

from ..models import RamadanPeriod

class RamadanPeriodListView(LoginRequiredMixin, PermissionRequiredMixin, ListView):
    model = RamadanPeriod
    template_name = 'attendance/shifts/ramadan_periods.html'
    context_object_name = 'periods'
    permission_required = 'attendance.view_ramadanperiod'

    def get_queryset(self):
        return RamadanPeriod.objects.order_by('-year')

class RamadanPeriodAddView(LoginRequiredMixin, PermissionRequiredMixin, View):
    permission_required = 'attendance.add_ramadanperiod'

    def post(self, request, *args, **kwargs):
        try:
            data = json.loads(request.body)
            period = RamadanPeriod.objects.create(
                year=data['year'],
                start_date=data['start_date'],
                end_date=data['end_date'],
                is_active=data['is_active']
            )
            return JsonResponse({
                'id': period.id,
                'message': 'Ramadan period created successfully'
            })
        except Exception as e:
            return JsonResponse({'error': str(e)}, status=400)

class RamadanPeriodDetailView(LoginRequiredMixin, PermissionRequiredMixin, View):
    permission_required = 'attendance.change_ramadanperiod'

    def get(self, request, pk, *args, **kwargs):
        period = get_object_or_404(RamadanPeriod, pk=pk)
        return JsonResponse({
            'id': period.id,
            'year': period.year,
            'start_date': period.start_date.isoformat(),
            'end_date': period.end_date.isoformat(),
            'is_active': period.is_active
        })

    def put(self, request, pk, *args, **kwargs):
        try:
            period = get_object_or_404(RamadanPeriod, pk=pk)
            data = json.loads(request.body)
            
            period.year = data['year']
            period.start_date = data['start_date']
            period.end_date = data['end_date']
            period.is_active = data['is_active']
            period.save()

            return JsonResponse({
                'message': 'Ramadan period updated successfully'
            })
        except Exception as e:
            return JsonResponse({'error': str(e)}, status=400)

    def delete(self, request, pk, *args, **kwargs):
        try:
            period = get_object_or_404(RamadanPeriod, pk=pk)
            period.delete()
            return JsonResponse({
                'message': 'Ramadan period deleted successfully'
            })
        except Exception as e:
            return JsonResponse({'error': str(e)}, status=400)

```

### 📄 hrms_project\attendance\views\shifts_views.py
```from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.http import JsonResponse
from django.core.paginator import Paginator
from django.db.models import Q
from rest_framework import viewsets
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from datetime import datetime, timedelta
from dateutil import parser
from django.views.decorators.http import require_http_methods
from django.utils.dateparse import parse_date
from calendar import monthrange
from django.db import transaction
import logging

# Configure logging
logger = logging.getLogger(__name__)

# Module-level flag to track if we've already logged the cache import message
_cache_import_logged = False

# Try to import cache, but don't fail if it's not configured
try:
    from django.core.cache import cache
    # Only log once
    if not _cache_import_logged:
        logger.info("Successfully imported cache")
        _cache_import_logged = True
except ImportError:
    if not _cache_import_logged:
        logger.warning("Failed to import cache, continuing without caching")
        _cache_import_logged = True
    cache = None

from ..serializers import ShiftSerializer
from ..models import Shift, ShiftAssignment, DateSpecificShiftOverride
from ..services.shift_service import ShiftService
from employees.models import Employee, Department

class ShiftViewSet(viewsets.ModelViewSet):
    """ViewSet for managing shifts through the API"""
    queryset = Shift.objects.all()
    serializer_class = ShiftSerializer
    permission_classes = [IsAuthenticated]


@login_required
def shift_list(request):
    """View for listing all shifts"""
    shifts = Shift.objects.all().order_by('start_time')
    return render(request, 'attendance/shifts/shift_list.html', {'shifts': shifts})

@login_required
def shift_create(request):
    """View for creating a new shift"""
    if request.method == 'POST':
        name = request.POST.get('name')
        shift_type = request.POST.get('shift_type')
        start_time = request.POST.get('start_time')
        end_time = request.POST.get('end_time')
        is_night_shift = request.POST.get('is_night_shift') == 'on'
        grace_period = int(request.POST.get('grace_period', 15))
        break_duration = int(request.POST.get('break_duration', 60))

        # Handle night shift timing fields
        default_night_start_time = request.POST.get('default_night_start_time')
        default_night_end_time = request.POST.get('default_night_end_time')

        shift = Shift.objects.create(
            name=name,
            shift_type=shift_type,
            start_time=start_time,
            end_time=end_time,
            is_night_shift=is_night_shift,
            grace_period=grace_period,
            break_duration=break_duration,
            default_night_start_time=default_night_start_time if default_night_start_time else None,
            default_night_end_time=default_night_end_time if default_night_end_time else None
        )
        messages.success(request, 'Shift created successfully.')
        return redirect('attendance:shift_list')

    context = {
        'shift_types': Shift.SHIFT_TYPES # Pass SHIFT_TYPES to context
    }
    return render(request, 'attendance/shifts/shift_form.html', context) # Pass context here

@login_required
def shift_edit(request, pk):
    """View for editing an existing shift"""
    shift = get_object_or_404(Shift, pk=pk)

    if request.method == 'POST':
        # Update basic fields
        shift.name = request.POST.get('name')
        shift.shift_type = request.POST.get('shift_type')
        shift.start_time = request.POST.get('start_time')
        shift.end_time = request.POST.get('end_time')
        shift.is_night_shift = request.POST.get('is_night_shift') == 'on'
        shift.grace_period = int(request.POST.get('grace_period', 15))
        shift.break_duration = int(request.POST.get('break_duration', 60))

        # Update night shift timing fields
        default_night_start_time = request.POST.get('default_night_start_time')
        default_night_end_time = request.POST.get('default_night_end_time')
        shift.default_night_start_time = default_night_start_time if default_night_start_time else None
        shift.default_night_end_time = default_night_end_time if default_night_end_time else None
        shift.save()

        messages.success(request, 'Shift updated successfully.')
        return redirect('attendance:shift_list')

    context = {
        'shift': shift,
        'shift_types': Shift.SHIFT_TYPES # Pass SHIFT_TYPES to context
    }
    return render(request, 'attendance/shifts/shift_form.html', context) # Pass context here

@login_required
def shift_assignment_list(request):
    """View for listing shift assignments"""
    # Get filter parameters
    department_id = request.GET.get('department')
    shift_id = request.GET.get('shift')
    status = request.GET.get('status')
    assignment_type = request.GET.get('type')
    search_query = request.GET.get('search')
    start_date = request.GET.get('start_date')
    end_date = request.GET.get('end_date')

    # Start with all assignments
    assignments = ShiftAssignment.objects.select_related(
        'employee', 
        'employee__department', 
        'shift', 
        'created_by'
    ).order_by('-created_at')

    # Apply filters
    if department_id:
        assignments = assignments.filter(employee__department_id=department_id)
    if shift_id:
        assignments = assignments.filter(shift_id=shift_id)
    if status:
        if status == 'active':
            assignments = assignments.filter(is_active=True)
        elif status == 'inactive':
            assignments = assignments.filter(is_active=False)
    if assignment_type:
        if assignment_type == 'permanent':
            assignments = assignments.filter(end_date__isnull=True)
        elif assignment_type == 'temporary':
            assignments = assignments.filter(end_date__isnull=False)
    if search_query:
        assignments = assignments.filter(
            Q(employee__first_name__icontains=search_query) |
            Q(employee__last_name__icontains=search_query) |
            Q(employee__employee_number__icontains=search_query)
        )
    if start_date:
        assignments = assignments.filter(start_date__gte=start_date)
    if end_date:
        assignments = assignments.filter(
            Q(end_date__lte=end_date) | 
            Q(end_date__isnull=True, start_date__lte=end_date)
        )

    # Paginate results
    paginator = Paginator(assignments, 10)  # Show 10 assignments per page
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'shifts': Shift.objects.all(),
        'departments': Department.objects.all(),
        'employees': Employee.objects.select_related('department').all(),
        # Add filter values to context for maintaining state
        'selected_department': department_id,
        'selected_shift': shift_id,
        'selected_status': status,
        'selected_type': assignment_type,
        'search_query': search_query,
        'start_date': start_date,
        'end_date': end_date,
    }
    
    return render(request, 'attendance/shifts/assignment_list.html', context)

@login_required
def shift_assignment_create(request):
    """View for creating a new shift assignment"""
    if request.method == 'POST':
        # Get comma-separated employee IDs and split them
        employee_ids = request.POST.getlist('employee[]', [])
        logger.debug(f"Received employee_ids: {employee_ids}")
        
        if not employee_ids:  # Check if the list is empty
            messages.error(request, 'Please select at least one employee.')
            return redirect('attendance:shift_assignment_create')

        shift_id = request.POST.get('shift')
        if not shift_id:
            messages.error(request, 'Please select a shift.')
            return redirect('attendance:shift_assignment_create')

        start_date = request.POST.get('start_date')
        if not start_date:
            messages.error(request, 'Please provide a start date.')
            return redirect('attendance:shift_assignment_create')

        end_date = request.POST.get('end_date') or None
        is_active = request.POST.get('is_active') == 'on'
        
        logger.info(f"Creating shift assignments - Shift: {shift_id}, Start: {start_date}, End: {end_date}, Active: {is_active}")

        try:
            with transaction.atomic():
                created_count = 0
                for employee_id in employee_ids:
                    # Skip empty employee IDs
                    if not employee_id:
                        logger.warning(f"Skipping empty employee_id")
                        continue

                    # Validate employee exists
                    try:
                        employee = Employee.objects.get(id=employee_id)
                        logger.debug(f"Found employee: {employee.get_full_name()}")
                    except Employee.DoesNotExist:
                        logger.error(f"Employee with ID {employee_id} does not exist")
                        messages.error(request, f'Employee with ID {employee_id} does not exist.')
                        continue

                    # Deactivate any existing active assignments for this employee
                    deactivated = ShiftAssignment.objects.filter(
                        employee_id=employee_id,
                        is_active=True
                    ).update(is_active=False)
                    logger.debug(f"Deactivated {deactivated} existing assignments for employee {employee_id}")

                    # Create new assignment
                    ShiftAssignment.objects.create(
                        employee_id=employee_id,
                        shift_id=shift_id,
                        start_date=start_date,
                        end_date=end_date,
                        is_active=is_active,
                        created_by=request.user
                    )
                    created_count += 1
                    logger.debug(f"Created new assignment for employee {employee_id}")

                if created_count > 0:
                    success_msg = f'{created_count} Shift assignment{"s" if created_count > 1 else ""} created successfully.'
                    logger.info(success_msg)
                    messages.success(request, success_msg)
                    
                    # Clear any cached shift assignments
                    for employee_id in employee_ids:
                        if employee_id:
                            cache_key = f'employee_shifts_{employee_id}'
                            logger.debug(f"Attempting to clear cache for key: {cache_key}")
                            if cache:
                                try:
                                    cache.delete(cache_key)
                                    logger.debug(f"Successfully cleared cache for key: {cache_key}")
                                except Exception as cache_error:
                                    logger.error(f"Error clearing cache for key {cache_key}: {str(cache_error)}")
                    
                    return redirect('attendance:shift_assignment_list')
                else:
                    warning_msg = 'No shift assignments were created. Please check your selections.'
                    logger.warning(warning_msg)
                    messages.warning(request, warning_msg)

        except Exception as e:
            error_msg = f'Error assigning shift: {str(e)}'
            logger.error(error_msg, exc_info=True)
            messages.error(request, error_msg)

    # Get active employees and shifts
    employees = Employee.objects.filter(is_active=True).select_related('department')
    shifts = Shift.objects.filter(is_active=True)
    departments = Department.objects.all()

    return render(request, 'attendance/shifts/assignment_form.html', {
        'employees': employees,
        'shifts': shifts,
        'departments': departments
    })

@login_required
def shift_assignment_edit(request, pk):
    """View for editing a shift assignment"""
    assignment = get_object_or_404(ShiftAssignment.objects.select_related(
        'employee', 
        'employee__department', 
        'shift'
    ), pk=pk)

    if request.method == 'POST':
        try:
            with transaction.atomic():
                # If making this assignment active, deactivate other active assignments
                if request.POST.get('is_active') == 'on' and not assignment.is_active:
                    ShiftAssignment.objects.filter(
                        employee=assignment.employee,
                        is_active=True
                    ).exclude(pk=pk).update(is_active=False)

                assignment.shift_id = request.POST.get('shift')
                assignment.start_date = request.POST.get('start_date')
                assignment.end_date = request.POST.get('end_date') or None
                assignment.is_active = request.POST.get('is_active') == 'on'
                assignment.save()

                messages.success(request, 'Shift assignment updated successfully.')
                return redirect('attendance:shift_assignment_list')

        except Exception as e:
            messages.error(request, f'Error updating shift assignment: {str(e)}')

    employees = Employee.objects.filter(is_active=True).select_related('department')
    shifts = Shift.objects.filter(is_active=True)
    departments = Department.objects.all()

    context = {
        'form': assignment,  # Pass the assignment as form for template
        'employees': employees,
        'shifts': shifts,
        'departments': departments,
        'title': 'Edit Shift Assignment'  # Add a title for the page
    }

    return render(request, 'attendance/shifts/assignment_form.html', context)

@login_required
def shift_assignment_delete(request, pk):
    """View for deleting a shift assignment"""
    assignment = get_object_or_404(ShiftAssignment, pk=pk)
    
    try:
        assignment.delete()
        messages.success(request, 'Shift assignment deleted successfully.')
    except Exception as e:
        messages.error(request, f'Error deleting shift assignment: {str(e)}')
    
    return redirect('attendance:shift_assignment_list')

@login_required
def get_employee_shifts(request, employee_id):
    """API endpoint for getting an employee's shift history"""
    assignments = ShiftAssignment.objects.filter(
        employee_id=employee_id
    ).select_related('shift').order_by('-start_date')
    
    data = [{
        'id': a.id,
        'shift_name': a.shift.name,
        'start_date': a.start_date.strftime('%Y-%m-%d'),
        'end_date': a.end_date.strftime('%Y-%m-%d') if a.end_date else None,
        'is_active': a.is_active
    } for a in assignments]
    
    return JsonResponse({'assignments': data})

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def shift_assignment_calendar_events(request):
    """API endpoint for providing shift assignment events for FullCalendar"""
    start_date_str = request.query_params.get('start')
    end_date_str = request.query_params.get('end')
    department_filter = request.query_params.get('department')
    shift_type_filter = request.query_params.get('shift_type')
    employee_id_filter = request.query_params.get('employee_id')
    view_type = request.query_params.get('view', 'dayGridMonth')

    try:
        # Parse ISO format dates with timezone
        start_date = parser.parse(start_date_str).date()
        end_date = parser.parse(end_date_str).date()
    except (ValueError, TypeError):
        return Response({'error': 'Invalid date range'}, status=400)

    assignments = ShiftAssignment.objects.filter(
        Q(start_date__lte=end_date) & 
        (Q(end_date__isnull=True) | Q(end_date__gte=start_date)),
        is_active=True
    ).select_related('employee', 'shift', 'employee__department')

    if department_filter:
        assignments = assignments.filter(employee__department_id=department_filter)
    if shift_type_filter:
        assignments = assignments.filter(shift__shift_type=shift_type_filter)
    if employee_id_filter:
        assignments = assignments.filter(employee_id=employee_id_filter)

    events = []
    for assignment in assignments:
        current_date = max(assignment.start_date, start_date)
        end_date_assignment = assignment.end_date if assignment.end_date else end_date

        while current_date <= min(end_date_assignment, end_date):
            # Get shift timing for this specific date
            daily_timing = ShiftService.get_shift_timing(assignment.shift, current_date)
            
            # Check for night shift override
            night_shift_override = None
            if assignment.shift.is_night_shift:
                night_shift_override = DateSpecificShiftOverride.objects.filter(
                    date=current_date,
                    shift_type='NIGHT'
                ).first()

            # Set event start and end times based on view type
            if view_type in ['timeGridWeek', 'timeGridDay']:
                if assignment.shift.is_night_shift:
                    # For night shifts in week/day view, create event spanning to next day
                    if night_shift_override:
                        start_time = night_shift_override.override_start_time
                        end_time = night_shift_override.override_end_time
                    else:
                        start_time = daily_timing['start_time']
                        end_time = daily_timing['end_time']
                    
                    # Create event spanning to next day
                    next_day = current_date + timedelta(days=1)
                    event_start = datetime.combine(current_date, start_time)
                    event_end = datetime.combine(next_day, end_time)
                else:
                    # For regular shifts, keep within same day
                    event_start = datetime.combine(current_date, daily_timing['start_time'])
                    event_end = datetime.combine(current_date, daily_timing['end_time'])
            else:
                # For month view, use all-day events
                event_start = current_date
                event_end = current_date + timedelta(days=1)

            # Format the timing string for display
            if night_shift_override:
                timing_str = f"{night_shift_override.override_start_time.strftime('%I:%M %p')} - {night_shift_override.override_end_time.strftime('%I:%M %p')}"
            else:
                timing_str = f"{daily_timing['start_time'].strftime('%I:%M %p')} - {daily_timing['end_time'].strftime('%I:%M %p')}"

            # Set event properties
            event = {
                'id': f"{assignment.id}_{current_date.isoformat()}",
                'title': f"{assignment.employee.get_full_name()} - {assignment.shift.name}",
                'start': event_start.isoformat() if isinstance(event_start, datetime) else event_start.isoformat(),
                'end': event_end.isoformat() if isinstance(event_end, datetime) else event_end.isoformat(),
                'shift_timing': timing_str,
                'employee_id': assignment.employee.id,
                'shift_id': assignment.shift.id,
                'department': assignment.employee.department.name if assignment.employee.department else None,
                'shift_type': assignment.shift.shift_type,
                'is_date_specific': daily_timing.get('is_date_specific', False) or bool(night_shift_override),
                'is_ramadan': daily_timing.get('is_ramadan', False),
                'allDay': view_type == 'dayGridMonth',
                'className': [
                    f'shift-type-{assignment.shift.shift_type.lower()}',
                    'date-specific' if daily_timing.get('is_date_specific') or bool(night_shift_override) else '',
                    'ramadan' if daily_timing.get('is_ramadan', False) else ''
                ]
            }
            events.append(event)
            current_date += timedelta(days=1)

    return Response(events)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def quick_shift_assignment(request):
    """API endpoint for quick shift assignments from calendar"""
    try:
        # Get employee IDs from the array format
        employee_ids = request.data.get('employee[]', '').split(',')
        shift_id = request.data.get('shift')
        date = request.data.get('date')
        start_time = request.data.get('start_time')
        end_time = request.data.get('end_time')

        if not all([employee_ids, shift_id, date]) or not employee_ids[0]:
            return Response({
                'success': False,
                'error': 'Missing required fields'
            }, status=400)

        shift = get_object_or_404(Shift, id=shift_id)
        assignments = []
        skipped = []
        
        # Parse the date once
        assignment_date = datetime.strptime(date, '%Y-%m-%d').date()

        # Check for night shift override if this is a night shift
        if shift.shift_type == 'NIGHT':
            override = DateSpecificShiftOverride.objects.filter(
                date=assignment_date,
                shift_type='NIGHT'
            ).first()
            
            if override:
                # Use override times instead of custom times for night shift
                start_time = override.override_start_time.strftime('%H:%M')
                end_time = override.override_end_time.strftime('%H:%M')

        # Create or update date-specific shift if custom times provided
        if start_time and end_time and shift.shift_type != 'NIGHT':
            ShiftService.set_date_specific_shift(
                shift=shift,
                date=assignment_date,
                start_time=datetime.strptime(start_time, '%H:%M').time(),
                end_time=datetime.strptime(end_time, '%H:%M').time(),
                created_by=request.user
            )

        # Create assignments for all selected employees
        for employee_id in employee_ids:
            try:
                employee = get_object_or_404(Employee, id=employee_id)
                
                # Check for existing assignments on this date
                existing_assignments = ShiftAssignment.objects.filter(
                    employee=employee,
                    start_date__lte=assignment_date,
                    end_date__gte=assignment_date,
                    is_active=True
                ).select_related('shift')

                if existing_assignments.exists():
                    # Get the highest priority existing assignment
                    highest_priority_assignment = max(
                        existing_assignments,
                        key=lambda x: x.shift.priority
                    )

                    # Skip if existing assignment has higher or equal priority
                    if highest_priority_assignment.shift.priority >= shift.priority:
                        skipped.append({
                            'employee': str(employee),
                            'reason': f'Already assigned to {highest_priority_assignment.shift.name} (higher priority)'
                        })
                        continue
                    else:
                        # Deactivate lower priority assignments for this date
                        for existing in existing_assignments:
                            if existing.start_date == existing.end_date == assignment_date:
                                # If it's a single-day assignment, deactivate it
                                existing.is_active = False
                                existing.save()
                            else:
                                # If it's a multi-day assignment, split it
                                if existing.start_date < assignment_date:
                                    # Create a new assignment for the days before
                                    ShiftAssignment.objects.create(
                                        employee=employee,
                                        shift=existing.shift,
                                        start_date=existing.start_date,
                                        end_date=assignment_date - timedelta(days=1),
                                        is_active=True,
                                        created_by=request.user
                                    )
                                if existing.end_date > assignment_date:
                                    # Create a new assignment for the days after
                                    ShiftAssignment.objects.create(
                                        employee=employee,
                                        shift=existing.shift,
                                        start_date=assignment_date + timedelta(days=1),
                                        end_date=existing.end_date,
                                        is_active=True,
                                        created_by=request.user
                                    )
                                # Deactivate the original assignment
                                existing.is_active = False
                                existing.save()

                # Create new assignment
                assignment = ShiftService.assign_shift(
                    employee=employee,
                    shift=shift,
                    start_date=assignment_date,
                    end_date=assignment_date,  # Set end_date to the same as start_date
                    created_by=request.user
                )
                assignments.append(assignment.id)
            except Exception as e:
                print(f"Error assigning shift to employee {employee_id}: {str(e)}")
                skipped.append({
                    'employee': str(employee),
                    'reason': str(e)
                })
                continue

        if assignments:
            response_data = {
                'success': True,
                'assignment_ids': assignments,
                'message': f'Successfully assigned shift to {len(assignments)} employees for {date}'
            }
            if skipped:
                response_data['skipped'] = skipped
            return Response(response_data)
        else:
            return Response({
                'success': False,
                'error': 'No assignments were created',
                'skipped': skipped
            }, status=400)

    except Exception as e:
        return Response({
            'success': False,
            'error': str(e)
        }, status=400)

@api_view(['GET', 'PUT', 'DELETE'])
@permission_classes([IsAuthenticated])
def shift_assignment_detail(request, pk):
    """API endpoint for retrieving, updating, or deleting a shift assignment"""
    assignment = get_object_or_404(ShiftAssignment, pk=pk)

    if request.method == 'GET':
        # Return assignment details
        shift_timing = ShiftService.get_shift_timing(assignment.shift, assignment.start_date)
        return Response({
            'id': assignment.id,
            'employee': {
                'id': assignment.employee.id,
                'name': str(assignment.employee)
            },
            'shift': {
                'id': assignment.shift.id,
                'name': assignment.shift.name,
                'is_night_shift': assignment.shift.shift_type == 'NIGHT'
            },
            'start_date': assignment.start_date,
            'end_date': assignment.end_date,
            'start_time': shift_timing['start_time'],
            'end_time': shift_timing['end_time'],
            'is_date_specific': shift_timing.get('is_date_specific', False)
        })
    
    elif request.method == 'PUT':
        # Update assignment
        try:
            start_time = request.data.get('start_time')
            end_time = request.data.get('end_time')
            
            if start_time and end_time:
                # Update or create date-specific shift timing
                ShiftService.set_date_specific_shift(
                    shift=assignment.shift,
                    date=assignment.start_date,
                    start_time=datetime.strptime(start_time, '%H:%M').time(),
                    end_time=datetime.strptime(end_time, '%H:%M').time(),
                    created_by=request.user
                )
            
            # Update other fields if needed
            if 'end_date' in request.data:
                assignment.end_date = request.data['end_date']
                assignment.save()

            return Response({'success': True})
        except Exception as e:
            return Response({
                'success': False,
                'error': str(e)
            }, status=400)
    
    elif request.method == 'DELETE':
        try:
            assignment.delete()
            return Response({'success': True})
        except Exception as e:
            return Response({
                'success': False,
                'error': str(e)
            }, status=400)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def create_shift_override(request):
    """Create or update a night shift override for a specific date"""
    try:
        date = parse_date(request.POST.get('date'))
        start_time = request.POST.get('start_time')
        end_time = request.POST.get('end_time')

        if not all([date, start_time, end_time]):
            return Response({
                'success': False,
                'error': 'Missing required fields'
            }, status=400)

        # Convert time strings to time objects
        start_time = datetime.strptime(start_time, '%H:%M').time()
        end_time = datetime.strptime(end_time, '%H:%M').time()

        # Create or update override
        override, created = DateSpecificShiftOverride.objects.update_or_create(
            date=date,
            shift_type='NIGHT',
            defaults={
                'override_start_time': start_time,
                'override_end_time': end_time
            }
        )

        return Response({
            'success': True,
            'override_id': override.id,
            'created': created
        })

    except Exception as e:
        return Response({
            'success': False,
            'error': str(e)
        }, status=400)

@api_view(['DELETE'])
@permission_classes([IsAuthenticated])
def delete_shift_override(request, date):
    """Remove a night shift override for a specific date"""
    try:
        date = parse_date(date)
        if not date:
            return Response({
                'success': False,
                'error': 'Invalid date format'
            }, status=400)

        # Delete the override if it exists
        override = DateSpecificShiftOverride.objects.filter(
            date=date,
            shift_type='NIGHT'
        ).first()

        if override:
            override.delete()
            return Response({'success': True})
        else:
            return Response({
                'success': False,
                'error': 'Override not found'
            }, status=404)

    except Exception as e:
        return Response({
            'success': False,
            'error': str(e)
        }, status=400)

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_shift_overrides(request, year, month):
    """Get all night shift overrides for a specific month"""
    try:
        # Validate year and month
        year = int(year)
        month = int(month)
        if not (1 <= month <= 12):
            raise ValueError('Invalid month')

        # Get the first and last day of the month
        _, last_day = monthrange(year, month)
        start_date = datetime(year, month, 1).date()
        end_date = datetime(year, month, last_day).date()

        # Get all overrides for the month
        overrides = DateSpecificShiftOverride.objects.filter(
            date__range=(start_date, end_date),
            shift_type='NIGHT'
        )

        # Format the response
        override_dict = {
            override.date.isoformat(): {
                'start_time': override.override_start_time.strftime('%H:%M'),
                'end_time': override.override_end_time.strftime('%H:%M')
            }
            for override in overrides
        }

        return Response(override_dict)

    except Exception as e:
        return Response({
            'success': False,
            'error': str(e)
        }, status=400)

@login_required
def shift_day_detail(request, date):
    """View for showing all shifts and their assigned employees for a specific day"""
    try:
        selected_date = datetime.strptime(date, '%Y-%m-%d').date()
    except ValueError:
        messages.error(request, 'Invalid date format')
        return redirect('attendance:shift_assignment_list')

    # Get all shifts
    shifts = Shift.objects.filter(is_active=True)
    
    # Get night shift override for this date if exists
    night_shift_override = DateSpecificShiftOverride.objects.filter(
        date=selected_date,
        shift_type='NIGHT'
    ).first()
    
    # Get all assignments for this day
    assignments = ShiftAssignment.objects.filter(
        Q(start_date__lte=selected_date) & 
        (Q(end_date__isnull=True) | Q(end_date__gte=selected_date)),
        is_active=True
    ).select_related('employee', 'shift', 'employee__department')

    # Group assignments by shift type
    shift_groups = {
        'DEFAULT': {'name': 'Default Shift (7AM-4PM)', 'assignments': []},
        'NIGHT': {
            'name': 'Night Shift',
            'timing': f"{night_shift_override.override_start_time.strftime('%I:%M %p')} - {night_shift_override.override_end_time.strftime('%I:%M %p')}" if night_shift_override else '6PM-3AM',
            'is_overridden': bool(night_shift_override),
            'assignments': []
        },
        'OPEN': {'name': 'Open Shift', 'assignments': []}
    }

    for assignment in assignments:
        shift_type = assignment.shift.shift_type
        if shift_type in shift_groups:
            # Get shift timing for this specific date
            if shift_type == 'NIGHT' and night_shift_override:
                timing = f"{night_shift_override.override_start_time.strftime('%I:%M %p')} - {night_shift_override.override_end_time.strftime('%I:%M %p')}"
                is_date_specific = True
                is_ramadan = False  # Override takes precedence over Ramadan timing
            else:
                shift_timing = ShiftService.get_shift_timing(assignment.shift, selected_date)
                timing = f"{shift_timing['start_time'].strftime('%I:%M %p')} - {shift_timing['end_time'].strftime('%I:%M %p')}"
                is_date_specific = shift_timing.get('is_date_specific', False)
                is_ramadan = shift_timing.get('is_ramadan', False)
            
            shift_groups[shift_type]['assignments'].append({
                'employee': assignment.employee,
                'shift': assignment.shift,
                'timing': timing,
                'is_date_specific': is_date_specific,
                'is_ramadan': is_ramadan
            })

    # Get all active employees for the quick assignment modal
    employees = Employee.objects.filter(
        is_active=True
    ).select_related('department').order_by('department__name', 'first_name')

    context = {
        'date': selected_date,
        'shift_groups': shift_groups,
        'departments': Department.objects.all(),
        'shifts': shifts,
        'employees': employees,
        'night_shift_override': night_shift_override,
    }
    
    return render(request, 'attendance/shifts/day_detail.html', context)

```

### 📄 hrms_project\attendance\views.py
```from datetime import datetime, date, timedelta, time
from typing import List, Dict, Any

from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.db import transaction
from django.db.models import Q, Sum, Count, models # Added models import
from django.http import JsonResponse, Http404
from django.utils import timezone
from django.contrib import messages
from rest_framework import status
from rest_framework import viewsets
from rest_framework.decorators import api_view, permission_classes, action
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser
from rest_framework.pagination import PageNumberPagination # Keep Pagination import here


from employees.models import Employee, Department
from .models import (
    AttendanceRecord, AttendanceLog, Leave, Holiday, LeaveType,
    RamadanPeriod, LeaveBalance # Added LeaveBalance import if needed for leave balance view
)
from .services import ShiftService, RamadanService
from .serializers import ShiftSerializer, AttendanceRecordSerializer, AttendanceLogSerializer, LeaveSerializer, HolidaySerializer # Keep serializers import


# API ViewSets - Keep ViewSets registrations here
class ShiftViewSet(viewsets.ModelViewSet): # ShiftViewSet moved to shifts_views, but registration kept here. Adjust if needed
    """ViewSet for managing shifts"""
    serializer_class = ShiftSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        return Shift.objects.filter(is_active=True)

```

### 📄 hrms_project\employees\admin.py
```from django.contrib import admin
from .models import (
    Department, Division, Location, Employee, EmployeeDependent,
    EmergencyContact, EmployeeDocument, EmployeeAsset, EmployeeEducation,
    EmployeeOffence, LifeEvent, EmployeeBankAccount, CostProfitCenter,
    DependentDocument, OffenseRule
)

@admin.register(Department)
class DepartmentAdmin(admin.ModelAdmin):
    list_display = ('name', 'name_ar', 'code', 'parent')
    search_fields = ('name', 'name_ar', 'code')
    list_filter = ('parent',)

@admin.register(Division)
class DivisionAdmin(admin.ModelAdmin):
    list_display = ('name', 'name_ar', 'code', 'department')
    search_fields = ('name', 'name_ar', 'code')
    list_filter = ('department',)

@admin.register(Location)
class LocationAdmin(admin.ModelAdmin):
    list_display = ('name', 'code')
    search_fields = ('name', 'code', 'address')

@admin.register(CostProfitCenter)
class CostProfitCenterAdmin(admin.ModelAdmin):
    list_display = ('code', 'name', 'is_active')
    search_fields = ('code', 'name')
    list_filter = ('is_active',)

@admin.register(Employee)
class EmployeeAdmin(admin.ModelAdmin):
    list_display = ('employee_number', 'get_full_name', 'designation', 'department', 'is_active')
    search_fields = ('employee_number', 'first_name', 'last_name', 'email')
    list_filter = ('is_active', 'department', 'division', 'employee_category', 'in_probation')
    
    fieldsets = (
        ('Personal Information', {
            'fields': (
                ('employee_number', 'profile_picture'),
                ('first_name', 'middle_name', 'last_name'),
                ('first_name_ar', 'middle_name_ar', 'last_name_ar'),
                ('date_of_birth', 'gender'),
                ('nationality', 'religion'),
                ('marital_status', 'education_category'),
                ('cpr_number', 'email'),
                'in_probation'
            )
        }),
        ('Employment Information', {
            'fields': (
                ('designation', 'department'),
                ('division', 'location'),
                ('contract_type', 'joined_date'),
                ('cost_center', 'profit_center'),
                'employee_category',
                'is_active'
            )
        })
    )

    def get_full_name(self, obj):
        return obj.get_full_name()
    get_full_name.short_description = 'Full Name'

@admin.register(EmployeeBankAccount)
class EmployeeBankAccountAdmin(admin.ModelAdmin):
    list_display = ('employee', 'bank', 'account_number', 'iban')
    search_fields = ('employee__employee_number', 'bank', 'account_number', 'iban')
    list_filter = ('bank',)

@admin.register(EmployeeDocument)
class EmployeeDocumentAdmin(admin.ModelAdmin):
    list_display = ('employee', 'document_type', 'document_number', 'issue_date', 'expiry_date')
    search_fields = ('employee__employee_number', 'document_type', 'document_number')
    list_filter = ('document_type', 'issue_date', 'expiry_date')

@admin.register(EmployeeDependent)
class EmployeeDependentAdmin(admin.ModelAdmin):
    list_display = ('employee', 'name', 'relation', 'date_of_birth', 'valid_passage')
    search_fields = ('employee__employee_number', 'name', 'passport_number', 'cpr_number')
    list_filter = ('relation', 'valid_passage')

@admin.register(DependentDocument)
class DependentDocumentAdmin(admin.ModelAdmin):
    list_display = ['name', 'document_type', 'document_number', 'issue_date', 'expiry_date', 'status']
    list_filter = ['document_type', 'status', 'nationality']
    search_fields = ['name', 'document_number']
    date_hierarchy = 'created_at'

@admin.register(EmergencyContact)
class EmergencyContactAdmin(admin.ModelAdmin):
    list_display = ('employee', 'name', 'relationship', 'phone_number')
    search_fields = ('employee__employee_number', 'name', 'phone_number')

@admin.register(EmployeeAsset)
class EmployeeAssetAdmin(admin.ModelAdmin):
    list_display = ('employee', 'asset_name', 'asset_number', 'issue_date', 'return_date')
    search_fields = ('employee__employee_number', 'asset_name', 'asset_number')
    list_filter = ('issue_date', 'return_date')

@admin.register(EmployeeEducation)
class EmployeeEducationAdmin(admin.ModelAdmin):
    list_display = ('employee', 'institution', 'degree', 'graduation_year')
    search_fields = ('employee__employee_number', 'institution', 'degree')
    list_filter = ('graduation_year',)

@admin.register(OffenseRule)
class OffenseRuleAdmin(admin.ModelAdmin):
    list_display = ('rule_id', 'group', 'name', 'first_penalty', 'second_penalty', 'third_penalty', 'fourth_penalty', 'is_active')
    list_filter = ('group', 'is_active')
    search_fields = ('rule_id', 'name', 'description')
    ordering = ('group', 'rule_id')
    fieldsets = (
        (None, {
            'fields': ('rule_id', 'group', 'name', 'description')
        }),
        ('Penalties', {
            'fields': ('first_penalty', 'second_penalty', 'third_penalty', 'fourth_penalty')
        }),
        ('Additional Information', {
            'fields': ('remarks', 'is_active')
        })
    )

@admin.register(EmployeeOffence)
class EmployeeOffenceAdmin(admin.ModelAdmin):
    list_display = ('employee', 'rule', 'offense_date', 'offense_count', 'applied_penalty', 'is_acknowledged')
    list_filter = ('offense_date', 'rule__group', 'is_acknowledged')
    search_fields = ('employee__first_name', 'employee__last_name', 'rule__name', 'details')
    raw_id_fields = ('employee', 'rule')
    readonly_fields = ('offense_count', 'original_penalty', 'created_by', 'modified_by', 'created_at', 'updated_at')
    fieldsets = (
        (None, {
            'fields': ('employee', 'rule', 'offense_date', 'offense_count')
        }),
        ('Penalty Information', {
            'fields': ('original_penalty', 'applied_penalty', 'details')
        }),
        ('Documents', {
            'fields': ('warning_letter', 'acknowledgment', 'is_acknowledged', 'acknowledged_at')
        }),
        ('Audit Trail', {
            'fields': ('created_by', 'modified_by', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        })
    )

    def save_model(self, request, obj, form, change):
        if not change:  # New object
            obj.created_by = request.user
        obj.modified_by = request.user
        super().save_model(request, obj, form, change)

@admin.register(LifeEvent)
class LifeEventAdmin(admin.ModelAdmin):
    list_display = ('employee', 'event_type', 'date')
    search_fields = ('employee__employee_number',)
    list_filter = ('event_type', 'date')

```

### 📄 hrms_project\employees\api_views.py
```from rest_framework import viewsets, status
from rest_framework.decorators import action, permission_classes, api_view
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.db import models
from django.db.models import Count, Q, F, Value
from django.db.models.functions import Cast, Greatest
from django.contrib.postgres.search import TrigramSimilarity
from django.shortcuts import get_object_or_404
from django.utils import timezone
from django.views.decorators.http import require_http_methods
from django.http import JsonResponse, HttpResponse
from django.conf import settings
from django.template.loader import render_to_string
from .models import EmployeeAsset, Employee, AssetType, OffenseRule, EmployeeOffence, OffenseDocument
from .serializers import EmployeeAssetSerializer, AssetTypeSerializer, BulkEmployeeAssetSerializer, OffenseRuleSerializer, EmployeeOffenceSerializer, OffenseDocumentSerializer
from reportlab.pdfgen import canvas
from decimal import Decimal
from io import BytesIO
import json
import os
import logging

logger = logging.getLogger(__name__)

class BaseAPIViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        return self.queryset.filter(employee__company=self.request.user.employee.company)

class AssetTypeViewSet(BaseAPIViewSet):
    serializer_class = AssetTypeSerializer
    queryset = AssetType.objects.all()

    def get_queryset(self):
        """Return all asset types as they are shared across the company"""
        return self.queryset

class EmployeeAssetViewSet(BaseAPIViewSet):
    serializer_class = EmployeeAssetSerializer
    queryset = EmployeeAsset.objects.all()

    def get_queryset(self):
        """Filter assets by employee if specified"""
        queryset = super().get_queryset()
        employee_id = self.request.query_params.get('employee_id')
        if employee_id:
            queryset = queryset.filter(employee_id=employee_id)
        return queryset

    def perform_create(self, serializer):
        """Create a new asset"""
        employee_id = self.request.data.get('employee')
        if not employee_id and hasattr(self.request.user, 'employee'):
            employee = self.request.user.employee
        else:
            employee = get_object_or_404(Employee, id=employee_id)
            
        # Get the asset type
        asset_type_id = self.request.data.get('asset_type')
        asset_type = get_object_or_404(AssetType, id=asset_type_id)
        
        # Use the asset type name as the asset name if not provided
        asset_name = self.request.data.get('asset_name') or asset_type.name
        
        serializer.save(
            employee=employee,
            asset_type=asset_type,
            asset_name=asset_name
        )

    @action(detail=False, methods=['post'])
    def return_assets(self, request):
        """Handle returning multiple assets at once"""
        asset_ids = request.data.get('asset_ids', [])
        return_date = request.data.get('return_date')
        return_condition = request.data.get('return_condition')

        if not asset_ids or not return_date or not return_condition:
            return Response(
                {'error': 'Missing required fields'},
                status=status.HTTP_400_BAD_REQUEST
            )

        try:
            # Ensure user can only return assets they have access to
            assets = self.get_queryset().filter(
                id__in=asset_ids,
                return_date__isnull=True
            )
            
            if not assets.exists():
                return Response(
                    {'error': 'No valid assets found to return'},
                    status=status.HTTP_404_NOT_FOUND
                )

            assets.update(
                return_date=return_date,
                return_condition=return_condition,
                updated_at=timezone.now()
            )
            return Response({'status': 'success'})
        except Exception as e:
            return Response(
                {'error': str(e)},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

@api_view(['POST'])
def add_employee_asset(request, employee_id):
    """Add one or more assets to an employee"""
    try:
        employee = get_object_or_404(Employee, id=employee_id)
        data = request.data.copy()
        
        # Check if we're dealing with multiple assets
        if isinstance(data, list) or (isinstance(data, dict) and 'asset_type' in data and isinstance(data['asset_type'], list)):
            # Convert data to the format expected by BulkEmployeeAssetSerializer
            assets_data = []
            if isinstance(data, list):
                assets_data = data
            else:
                # Handle multiple assets of the same type
                asset_types = data.get('asset_type', [])
                base_data = {
                    'employee': employee_id,
                    'asset_name': data.get('asset_name'),
                    'asset_number': data.get('asset_number'),
                    'condition': data.get('condition', 'New'),
                    'value': data.get('value', '0.00'),
                    'notes': data.get('notes', ''),
                    'issue_date': data.get('issue_date', timezone.now().date())
                }
                
                for asset_type_id in asset_types:
                    asset_data = base_data.copy()
                    asset_data['asset_type_id'] = asset_type_id
                    assets_data.append(asset_data)
            
            # Add employee ID to each asset
            for asset in assets_data:
                asset['employee'] = employee_id
            
            serializer = BulkEmployeeAssetSerializer(data={'assets': assets_data})
            if serializer.is_valid():
                assets = serializer.save()
                return Response(
                    EmployeeAssetSerializer(assets, many=True).data,
                    status=status.HTTP_201_CREATED
                )
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        # Single asset
        data['employee'] = employee_id
        serializer = EmployeeAssetSerializer(data=data)
        if serializer.is_valid():
            asset = serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)

@api_view(['PUT', 'PATCH'])
def edit_employee_asset(request, employee_id, asset_id):
    """Edit an employee's asset"""
    try:
        asset = get_object_or_404(EmployeeAsset, id=asset_id, employee_id=employee_id)
        data = request.data.copy()
        
        serializer = EmployeeAssetSerializer(asset, data=data, partial=True)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)

@api_view(['DELETE'])
def delete_employee_asset(request, employee_id, asset_id):
    """Delete an employee's asset"""
    asset = get_object_or_404(EmployeeAsset, id=asset_id, employee_id=employee_id)
    asset.delete()
    return Response(status=status.HTTP_204_NO_CONTENT)

@api_view(['GET'])
def get_employee_asset(request, employee_id, asset_id):
    """Get details of an employee's asset"""
    try:
        asset = get_object_or_404(EmployeeAsset, id=asset_id, employee_id=employee_id)
        serializer = EmployeeAssetSerializer(asset)
        return Response(serializer.data)
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)

@api_view(['POST'])
def return_employee_asset(request, employee_id, asset_id):
    """Mark an asset as returned"""
    try:
        asset = get_object_or_404(EmployeeAsset, id=asset_id, employee_id=employee_id)
        
        # Get return date and condition from request
        data = request.data.copy()
        return_date = data.get('return_date')
        return_condition = data.get('return_condition')
        return_notes = data.get('return_notes')
        
        if not return_date:
            return Response({'error': 'Return date is required'}, status=status.HTTP_400_BAD_REQUEST)
            
        if not return_condition:
            return Response({'error': 'Return condition is required'}, status=status.HTTP_400_BAD_REQUEST)
            
        # Update asset
        serializer = EmployeeAssetSerializer(asset, data={
            'return_date': return_date,
            'return_condition': return_condition,
            'return_notes': return_notes
        }, partial=True)
        
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)

@require_http_methods(['GET', 'POST'])
def employee_offenses(request, employee_id):
    """Get all offenses or create a new one for an employee"""
    try:
        employee = get_object_or_404(Employee, id=employee_id)
        
        if request.method == 'GET':
            offenses = employee.employee_offence_records.all()
            serializer = EmployeeOffenceSerializer(offenses, many=True)
            return Response(serializer.data)
            
        elif request.method == 'POST':
            serializer = EmployeeOffenceSerializer(data=request.data)
            if serializer.is_valid():
                serializer.save(
                    employee=employee,
                    created_by=request.user,
                    modified_by=request.user
                )
                return Response(serializer.data, status=status.HTTP_201_CREATED)
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
            
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@require_http_methods(['GET', 'DELETE'])
def employee_offense_detail(request, employee_id, offense_id):
    """Get or delete an employee's offense"""
    try:
        offense = get_object_or_404(EmployeeOffence, id=offense_id, employee_id=employee_id)
        
        if request.method == 'GET':
            serializer = EmployeeOffenceSerializer(offense)
            return Response(serializer.data)
            
        elif request.method == 'DELETE':
            offense.delete()
            return Response(status=status.HTTP_204_NO_CONTENT)
            
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@require_http_methods(['POST'])
def cancel_offense(request, employee_id, offense_id):
    """Cancel an employee's offense"""
    try:
        offense = get_object_or_404(EmployeeOffence, id=offense_id, employee_id=employee_id)
        if offense.is_cancelled:
            return Response({'error': 'Offense is already cancelled'}, status=status.HTTP_400_BAD_REQUEST)
            
        offense.is_cancelled = True
        offense.modified_by = request.user
        offense.save()
        
        serializer = EmployeeOffenceSerializer(offense)
        return Response(serializer.data)
        
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@require_http_methods(['POST'])
def add_offense_document(request, employee_id, offense_id):
    """Add a document to an offense"""
    try:
        offense = get_object_or_404(EmployeeOffence, id=offense_id, employee_id=employee_id)
        serializer = OffenseDocumentSerializer(data=request.data)
        
        if serializer.is_valid():
            serializer.save(offense=offense)
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

@api_view(['GET'])
def get_employee_offense_count(request, employee_id):
    """Get the count of active offenses for an employee and rule"""
    try:
        rule_id = request.GET.get('rule')
        year = request.GET.get('year')
        
        if not rule_id or not year:
            return Response({'error': 'Rule and year are required'}, status=status.HTTP_400_BAD_REQUEST)
        
        # Get all active offenses for this rule, ordered by date
        offenses = EmployeeOffence.objects.filter(
            employee_id=employee_id,
            rule_id=rule_id,
            offense_date__year=year,
            is_active=True
        ).order_by('offense_date')
        
        # Count how many times this rule has been violated
        offense_count = offenses.count()
        
        # Get the rule details
        rule = OffenseRule.objects.get(id=rule_id)
        
        # Determine which penalty to apply based on count
        penalty = None
        if offense_count == 0:
            penalty = rule.first_penalty
        elif offense_count == 1:
            penalty = rule.second_penalty
        elif offense_count == 2:
            penalty = rule.third_penalty
        elif offense_count >= 3:
            penalty = rule.fourth_penalty
        
        return Response({
            'count': offense_count,
            'suggested_penalty': penalty,
            'offenses': [{
                'date': o.offense_date,
                'penalty': o.applied_penalty
            } for o in offenses]
        })
        
    except OffenseRule.DoesNotExist:
        return Response({'error': 'Rule not found'}, status=status.HTTP_404_NOT_FOUND)
    except Exception as e:
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

class OffenseRuleViewSet(viewsets.ModelViewSet):
    serializer_class = OffenseRuleSerializer
    queryset = OffenseRule.objects.all()
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        logger.debug("Fetching offense rules...")
        queryset = OffenseRule.objects.filter(is_active=True)
        group = self.request.query_params.get('group', None)
        search = self.request.query_params.get('search', None)

        if group:
            logger.debug(f"Filtering by group: {group}")
            queryset = queryset.filter(group=group)
        
        if search:
            logger.debug(f"Searching with trigram similarity for: {search}")
            from django.contrib.postgres.search import TrigramSimilarity
            from django.db.models import Q, F, Value
            from django.db.models.functions import Cast, Greatest
            
            print(search)
            search_value = Value(search, output_field=models.TextField())
            
            queryset = queryset.annotate(
                rule_id_similarity=TrigramSimilarity('rule_id', search_value),
                name_similarity=TrigramSimilarity('name', search_value),
                desc_similarity=TrigramSimilarity('description', search_value)
            ).annotate(
                similarity=Greatest(
                    'rule_id_similarity',
                    'name_similarity',
                    'desc_similarity'
                )
            ).filter(
                Q(similarity__gt=0.1) |  # Fuzzy match
                Q(rule_id__iexact=search) |  # Exact matches first
                Q(name__icontains=search) |  # Then contains
                Q(description__icontains=search)
            ).order_by('-similarity', 'rule_id')  # Sort by similarity then rule ID
            
            logger.debug(f"Search SQL: {str(queryset.query)}")
            
            print(queryset.query)
            logger.debug(f"Found {queryset.count()} results")
            logger.debug("Search complete")
        
        rules = queryset.order_by('rule_id') if not search else queryset
        logger.debug(f"Found {rules.count()} rules")
        return rules

    def list(self, request, *args, **kwargs):
        logger.debug("Listing offense rules...")
        queryset = self.get_queryset()
        serializer = self.get_serializer(queryset, many=True)
        logger.debug("Serialization complete")
        return Response(serializer.data)

class EmployeeOffenseViewSet(viewsets.ModelViewSet):
    serializer_class = EmployeeOffenceSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        return EmployeeOffence.objects.all()

    def create(self, request, *args, **kwargs):
        data = request.data.copy()
        
        # Ensure employee is set
        if not data.get('employee'):
            data['employee'] = request.user.employee.id
            
        serializer = self.get_serializer(data=data)
        serializer.is_valid(raise_exception=True)
        self.perform_create(serializer)
        headers = self.get_success_headers(serializer.data)
        return Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)

    def perform_create(self, serializer):
        serializer.save(
            created_by=self.request.user,
            modified_by=self.request.user
        )

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def update_offense_status(request, pk):
    try:
        offense = EmployeeOffence.objects.get(pk=pk)
        status = request.data.get('status')
        
        if status == 'signed':
            offense.is_acknowledged = True
            offense.signed_date = timezone.now()
        elif status == 'refused':
            offense.is_acknowledged = False
            offense.refused_date = timezone.now()
            offense.refused_reason = request.data.get('reason', '')
        elif status == 'sent':
            offense.sent_date = timezone.now()
        
        offense.save()
        return Response({'status': 'success'})
    except EmployeeOffence.DoesNotExist:
        return Response({'error': 'Offense not found'}, status=404)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def record_offense_payment(request, pk):
    try:
        offense = EmployeeOffence.objects.get(pk=pk)
        amount = Decimal(request.data.get('amount', 0))
        
        if not offense.monetary_amount or not offense.is_active:
            return Response({'error': 'Invalid offense for payment'}, status=400)
        
        if amount <= 0:
            return Response({'error': 'Invalid payment amount'}, status=400)
        
        # Record the payment
        offense.remaining_amount = max(0, offense.remaining_amount - amount)
        
        # If fully paid, mark as inactive
        if offense.remaining_amount == 0:
            offense.is_active = False
            offense.completed_date = timezone.now()
        
        offense.save()
        
        # Create payment record
        #OffensePayment.objects.create(
        #    offense=offense,
        #    amount=amount,
        #    payment_date=timezone.now()
        #)
        
        return Response({
            'status': 'success',
            'remaining_amount': offense.remaining_amount,
            'is_active': offense.is_active
        })
    except EmployeeOffence.DoesNotExist:
        return Response({'error': 'Offense not found'}, status=404)

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_employee_offense_count(request, employee_id):
    try:
        rule_id = request.GET.get('rule')
        year = int(request.GET.get('year', timezone.now().year))
        
        if not rule_id:
            return Response({'error': 'Rule ID is required'}, status=400)
        
        # Get active offenses for this employee and rule in the specified year
        offenses = EmployeeOffence.objects.filter(
            employee_id=employee_id,
            rule_id=rule_id,
            offense_date__year=year,
            is_active=True
        ).order_by('offense_date')
        
        count = offenses.count()
        
        # Get the suggested penalty based on count
        rule = OffenseRule.objects.get(pk=rule_id)
        suggested_penalty = rule.get_penalty_for_count(count + 1)
        
        return Response({
            'count': count,
            'suggested_penalty': suggested_penalty,
            'offenses': [{
                'date': offense.offense_date,
                'penalty': offense.get_applied_penalty_display()
            } for offense in offenses]
        })
    except (OffenseRule.DoesNotExist, ValueError):
        return Response({'error': 'Invalid rule or year'}, status=400)

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def print_offense(request, pk):
    try:
        offense = EmployeeOffence.objects.get(pk=pk)
        
        # Generate PDF using your template
        # This is just a placeholder - implement your actual PDF generation here
        response = HttpResponse(content_type='application/pdf')
        response['Content-Disposition'] = f'inline; filename="offense_{offense.id}.pdf"'
        
        # Create PDF
        buffer = BytesIO()
        p = canvas.Canvas(buffer)
        
        # Add content to PDF
        p.drawString(100, 800, f"Offense Notice - {offense.rule.name}")
        p.drawString(100, 780, f"Employee: {offense.employee.full_name}")
        p.drawString(100, 760, f"Date: {offense.offense_date.strftime('%d/%m/%Y')}")
        p.drawString(100, 740, f"Penalty: {offense.get_applied_penalty_display()}")
        
        if offense.monetary_amount:
            p.drawString(100, 720, f"Amount: {offense.monetary_amount} BHD")
            if offense.is_active:
                p.drawString(100, 700, f"Remaining: {offense.remaining_amount} BHD")
        
        p.showPage()
        p.save()
        
        # Get the value of the buffer and write it to the response
        pdf = buffer.getvalue()
        buffer.close()
        response.write(pdf)
        
        return response
    except EmployeeOffence.DoesNotExist:
        return Response({'error': 'Offense not found'}, status=404)

```

### 📄 hrms_project\employees\apps.py
```from django.apps import AppConfig


class EmployeesConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'employees'

```

### 📄 hrms_project\employees\forms.py
```from django import forms
from django.db import transaction
from crispy_forms.helper import FormHelper
from crispy_forms.layout import Layout, Submit, Row, Column, Div, HTML, Field, Fieldset
from crispy_forms.bootstrap import Tab, TabHolder
from .models import (
    Employee, Department, Division, EmployeeDependent, 
    EmergencyContact, EmployeeDocument, EmployeeBankAccount,
    CostProfitCenter, DependentDocument,
    EmployeeAsset, EmployeeEducation, EmployeeOffence, LifeEvent,
    SalaryDetail, SalaryRevision, SalaryCertificate
)

class EmployeeForm(forms.ModelForm):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.helper = FormHelper()
        self.helper.form_method = 'post'
        self.helper.form_class = 'form-horizontal'
        self.helper.label_class = 'col-lg-3'
        self.helper.field_class = 'col-lg-9'
        
        # Make some fields optional
        optional_fields = ['middle_name', 'middle_name_ar', 'religion',
                         'education_category', 'profile_picture']
        
        for field in optional_fields:
            self.fields[field].required = False

        # Add Bootstrap classes to all fields
        for field_name, field in self.fields.items():
            if isinstance(field.widget, forms.CheckboxInput):
                field.widget.attrs.update({
                    'class': 'form-check-input'
                })
            elif isinstance(field.widget, forms.FileInput):
                field.widget.attrs.update({
                    'class': 'form-control-file'
                })
            else:
                field.widget.attrs.update({
                    'class': 'form-control',
                    'placeholder': field.label
                })

        # Load related fields efficiently
        self.fields['department'].queryset = Department.objects.all()
        self.fields['division'].queryset = Division.objects.all().select_related('department')
        self.fields['cost_center'].queryset = CostProfitCenter.objects.filter(is_active=True)
        self.fields['profit_center'].queryset = CostProfitCenter.objects.filter(is_active=True)

        # Define form layout
        self.helper.layout = Layout(
            TabHolder(
                Tab('Employee Information',
                    Fieldset('Basic Information',
                        Row(
                            Column('employee_number', css_class='form-group col-md-6'),
                            Column('profile_picture', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                    ),
                    Fieldset('Personal Information (English)',
                        Row(
                            Column('first_name', css_class='form-group col-md-6'),
                            Column('middle_name', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                        Row(
                            Column('last_name', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                    ),
                    Fieldset('Personal Information (Arabic)',
                        Row(
                            Column('first_name_ar', css_class='form-group col-md-6'),
                            Column('middle_name_ar', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                        Row(
                            Column('last_name_ar', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                    ),
                    Fieldset('Demographics',
                        Row(
                            Column('date_of_birth', css_class='form-group col-md-6'),
                            Column('gender', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                        Row(
                            Column('marital_status', css_class='form-group col-md-6'),
                            Column('nationality', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                        Row(
                            Column('religion', css_class='form-group col-md-6'),
                            Column('education_category', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                    ),
                    Fieldset('Contact & Identification',
                        Row(
                            
                            Column('primary_phone', css_class='form-group col-md-6'),
                            Column('secondary_phone', css_class='form-group col-md-6'),

                            css_class='form-row'
                        ),
                        Row(
                            Column('email', css_class='form-group col-md-6'),
                            Column('cpr_number', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                    ),
                ),
                Tab('Employment Information',
                    Fieldset('Position Details',
                        Row(
                            Column('designation', css_class='form-group col-md-6'),
                            Column('employee_category', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                    ),
                    Fieldset('Department & Location',
                        Row(
                            Column('division', css_class='form-group col-md-6'),
                            Column('department', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                        Row(
                            Column('location', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                    ),
                    Fieldset('Contract Information',
                        Row(
                            Column('contract_type', css_class='form-group col-md-6'),
                            Column('joined_date', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                        Row(
                            Column('in_probation', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                    ),
                    Fieldset('Financial Centers',
                        Row(
                            Column('cost_center', css_class='form-group col-md-6'),
                            Column('profit_center', css_class='form-group col-md-6'),
                            css_class='form-row'
                        ),
                    ),
                ),
            ),
            Div(
                Row(
                    Column(Field('is_active'), css_class='form-group col-6'),
                    Column(
                        HTML("""
                            <div class="text-end">
                                <a href="{% url 'employees:employee_list' %}" class="btn btn-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary">Save</button>
                            </div>
                        """),
                        css_class='form-group col-6'
                    ),
                    css_class='form-row'
                ),
                css_class='card-footer'
            )
        )

    class Meta:
        model = Employee
        fields = [
            # General Information
            'employee_number', 'profile_picture', 'first_name', 'middle_name', 'last_name',
            'first_name_ar', 'middle_name_ar', 'last_name_ar', 'date_of_birth',
            'gender', 'marital_status', 'nationality', 'religion', 'education_category',
            'cpr_number', 'email', 'primary_phone', 'secondary_phone', 'in_probation',
            # Employment Information
            'designation', 'division', 'department', 'location', 'contract_type',
            'joined_date', 'cost_center', 'profit_center', 'employee_category',
            # System Fields
            'is_active'
        ]
        widgets = {
            'date_of_birth': forms.DateInput(attrs={'type': 'date'}),
            'joined_date': forms.DateInput(attrs={'type': 'date'}),
        }

class EmployeeBankAccountForm(forms.ModelForm):
    class Meta:
        model = EmployeeBankAccount
        fields = ['bank', 'account_number', 'iban', 'transfer_amount', 'is_primary']
        widgets = {
            'bank': forms.TextInput(attrs={'class': 'form-control'}),
            'account_number': forms.TextInput(attrs={'class': 'form-control'}),
            'iban': forms.TextInput(attrs={'class': 'form-control'}),
            'transfer_amount': forms.NumberInput(attrs={'class': 'form-control'}),
            'is_primary': forms.CheckboxInput(attrs={'class': 'form-check-input'}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.helper = FormHelper()
        self.helper.form_method = 'post'
        self.helper.form_class = 'form-horizontal'
        self.helper.label_class = 'col-lg-3'
        self.helper.field_class = 'col-lg-9'
        self.helper.layout = Layout(
            Row(
                Column('bank', css_class='form-group col-md-6 mb-0'),
                Column('account_number', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('iban', css_class='form-group col-md-6 mb-0'),
                Column('transfer_amount', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('is_primary', css_class='form-group col-12 mb-0'),
                css_class='form-row'
            ),
            Submit('submit', 'Save Bank Account', css_class='btn-primary')
        )

EmployeeBankAccountFormSet = forms.inlineformset_factory(
    Employee,
    EmployeeBankAccount,
    form=EmployeeBankAccountForm,
    extra=1,
    can_delete=True,
    min_num=0,
    validate_min=False,
)

class EmployeeDependentForm(forms.ModelForm):
    class Meta:
        model = EmployeeDependent
        fields = [
            'name', 'relation', 'date_of_birth', 'passport_number',
            'passport_expiry', 'cpr_number', 'cpr_expiry', 'valid_passage'
        ]
        widgets = {
            'date_of_birth': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'passport_expiry': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'cpr_expiry': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.helper = FormHelper()
        self.helper.form_method = 'post'
        self.helper.form_class = 'form-horizontal'
        self.helper.label_class = 'col-lg-3'
        self.helper.field_class = 'col-lg-9'
        
        # Add Bootstrap classes to fields
        for field_name, field in self.fields.items():
            if isinstance(field.widget, forms.CheckboxInput):
                field.widget.attrs['class'] = 'form-check-input'
            else:
                field.widget.attrs['class'] = 'form-control'

        self.helper.layout = Layout(
            Row(
                Column('name', css_class='form-group col-md-6 mb-0'),
                Column('relation', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('date_of_birth', css_class='form-group col-md-6 mb-0'),
                Column('valid_passage', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('passport_number', css_class='form-group col-md-6 mb-0'),
                Column('passport_expiry', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('cpr_number', css_class='form-group col-md-6 mb-0'),
                Column('cpr_expiry', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Submit('submit', 'Save Dependent', css_class='btn-primary')
        )

class DependentDocumentForm(forms.ModelForm):
    class Meta:
        model = DependentDocument
        fields = ['document_type', 'document_number', 'name', 'issue_date', 'expiry_date', 'nationality', 'document_file']
        widgets = {
            'issue_date': forms.DateInput(attrs={'type': 'date'}),
            'expiry_date': forms.DateInput(attrs={'type': 'date'}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.fields['document_number'].required = False
        self.fields['issue_date'].required = False
        self.fields['expiry_date'].required = False
        self.fields['nationality'].required = False
        self.fields['document_file'].required = False
        self.helper = FormHelper()
        self.helper.form_method = 'post'
        self.helper.form_class = 'form-horizontal'
        self.helper.label_class = 'col-lg-3'
        self.helper.field_class = 'col-lg-9'

        # Add Bootstrap classes to fields
        for field_name, field in self.fields.items():
            if isinstance(field.widget, forms.FileInput):
                field.widget.attrs['class'] = 'form-control-file'
            else:
                field.widget.attrs['class'] = 'form-control'

        self.helper.layout = Layout(
            Row(
                Column('document_type', css_class='form-group col-md-6 mb-0'),
                Column('document_number', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('name', css_class='form-group col-md-6 mb-0'),
                Column('nationality', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('issue_date', css_class='form-group col-md-6 mb-0'),
                Column('expiry_date', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('document_file', css_class='form-group col-12 mb-0'),
                css_class='form-row'
            ),
            Submit('submit', 'Upload Document', css_class='btn-primary')
        )

class EmergencyContactForm(forms.ModelForm):
    class Meta:
        model = EmergencyContact
        fields = ['name', 'relationship', 'phone_number', 'alternative_phone', 'address']

class EmployeeDocumentForm(forms.ModelForm):
    class Meta:
        model = EmployeeDocument
        fields = [
            'document_type', 'document_number', 'profession_title',
            'issue_date', 'issue_place', 'expiry_date', 'other_info',
            'document_file'
        ]
        widgets = {
            'issue_date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'expiry_date': forms.DateInput(attrs={'type': 'date', 'class': 'form-control'}),
            'other_info': forms.Textarea(attrs={'rows': 3, 'class': 'form-control'}),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.helper = FormHelper()
        self.helper.form_method = 'post'
        self.helper.form_class = 'form-horizontal'
        self.helper.label_class = 'col-lg-3'
        self.helper.field_class = 'col-lg-9'
        self.helper.layout = Layout(
            Row(
                Column('document_type', css_class='form-group col-md-6 mb-0'),
                Column('document_number', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('profession_title', css_class='form-group col-md-12 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('issue_date', css_class='form-group col-md-6 mb-0'),
                Column('issue_place', css_class='form-group col-md-6 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('expiry_date', css_class='form-group col-md-12 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('other_info', css_class='form-group col-12 mb-0'),
                css_class='form-row'
            ),
            Row(
                Column('document_file', css_class='form-group col-12 mb-0'),
                css_class='form-row'
            ),
            Submit('submit', 'Save Document', css_class='btn-primary')
        )

    def clean(self):
        cleaned_data = super().clean()
        issue_date = cleaned_data.get('issue_date')
        expiry_date = cleaned_data.get('expiry_date')

        if issue_date and expiry_date and expiry_date < issue_date:
            raise forms.ValidationError({
                'expiry_date': 'Expiry date cannot be earlier than issue date.'
            })

        return cleaned_data





class SalaryDetailForm(forms.ModelForm):
    class Meta:
        model = SalaryDetail
        fields = [
            'basic_salary',
            'housing_allowance',
            'transportation_allowance',
            'other_allowances',
            'currency',
            'effective_from',
            'notes'
        ]
        widgets = {
            'effective_from': forms.DateInput(attrs={'type': 'date'}),
            'notes': forms.Textarea(attrs={'rows': 3}),
        }

    def clean(self):
        cleaned_data = super().clean()
        other_allowances = cleaned_data.get('other_allowances')
        
        # Validate other_allowances format
        if other_allowances:
            if not isinstance(other_allowances, dict):
                raise forms.ValidationError({
                    'other_allowances': 'Other allowances must be a valid JSON object'
                })
            
            # Validate each allowance value is numeric
            for key, value in other_allowances.items():
                try:
                    float(value)
                except (ValueError, TypeError):
                    raise forms.ValidationError({
                        'other_allowances': f'Value for {key} must be a number'
                    })
        
        return cleaned_data

class SalaryCertificateForm(forms.ModelForm):
    class Meta:
        model = SalaryCertificate
        fields = [
            'purpose',
            'expiry_date'
        ]
        widgets = {
            'purpose': forms.TextInput(attrs={'placeholder': 'e.g., Bank Loan, Visa Application'}),
            'expiry_date': forms.DateInput(attrs={'type': 'date'}),
        }

class SalaryRevisionForm(forms.ModelForm):
    class Meta:
        model = SalaryRevision
        fields = [
            'revision_type',
            'revision_date',
            'reason',
            'reference_number'
        ]
        widgets = {
            'revision_date': forms.DateInput(attrs={'type': 'date'}),
            'reason': forms.Textarea(attrs={'rows': 3}),
            'reference_number': forms.TextInput(attrs={'placeholder': 'Optional reference number'}),
        }

    def clean(self):
        cleaned_data = super().clean()
        revision_date = cleaned_data.get('revision_date')
        
        if revision_date:
            # Ensure revision date is not in the future
            if revision_date > timezone.now().date():
                raise forms.ValidationError({
                    'revision_date': 'Revision date cannot be in the future'
                })
        
        return cleaned_data

```

### 📄 hrms_project\employees\management\__init__.py
```

```

### 📄 hrms_project\employees\management\commands\__init__.py
```

```

### 📄 hrms_project\employees\management\commands\reset_offenses.py
```from django.core.management.base import BaseCommand
from django.utils import timezone
from employees.models import EmployeeOffence


class Command(BaseCommand):
    help = 'Deactivate all offenses from previous years'

    def handle(self, *args, **kwargs):
        current_year = timezone.now().year
        count = EmployeeOffence.objects.filter(
            offense_date__year__lt=current_year,
            is_active=True
        ).count()
        
        if count > 0:
            EmployeeOffence.deactivate_previous_year_offenses()
            self.stdout.write(
                self.style.SUCCESS(f'Successfully deactivated {count} offenses from previous years')
            )
        else:
            self.stdout.write(
                self.style.SUCCESS('No previous year offenses to deactivate')
            )

```

### 📄 hrms_project\employees\migrations\0001_initial.py
```# Generated by Django 4.2.9 on 2025-01-12 04:36

from django.conf import settings
import django.core.validators
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='AssetType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True)),
                ('description', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
            ],
            options={
                'verbose_name': 'Asset Type',
                'verbose_name_plural': 'Asset Types',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='Bank',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('swift_code', models.CharField(max_length=20)),
            ],
        ),
        migrations.CreateModel(
            name='CostProfitCenter',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('code', models.CharField(max_length=20, unique=True)),
                ('description', models.TextField(blank=True, null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Cost/Profit Center',
                'verbose_name_plural': 'Cost/Profit Centers',
                'ordering': ['code'],
            },
        ),
        migrations.CreateModel(
            name='Department',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('name_ar', models.CharField(blank=True, max_length=100, null=True, verbose_name='Name (Arabic)')),
                ('code', models.CharField(default='DEPT', max_length=20, unique=True)),
                ('manager', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('parent', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='employees.department')),
            ],
        ),
        migrations.CreateModel(
            name='Division',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('name_ar', models.CharField(max_length=100, verbose_name='Name (Arabic)')),
                ('code', models.CharField(max_length=20, unique=True)),
                ('department', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='employees.department')),
            ],
        ),
        migrations.CreateModel(
            name='Employee',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('employee_number', models.CharField(default='EMP0001', max_length=20, unique=True)),
                ('profile_picture', models.ImageField(blank=True, null=True, upload_to='employee_pictures/')),
                ('first_name', models.CharField(default='First', max_length=50)),
                ('middle_name', models.CharField(blank=True, max_length=50, null=True)),
                ('last_name', models.CharField(default='Last', max_length=50)),
                ('first_name_ar', models.CharField(blank=True, max_length=50, null=True, verbose_name='First Name (Arabic)')),
                ('middle_name_ar', models.CharField(blank=True, max_length=50, null=True, verbose_name='Middle Name (Arabic)')),
                ('last_name_ar', models.CharField(blank=True, max_length=50, null=True, verbose_name='Last Name (Arabic)')),
                ('date_of_birth', models.DateField(blank=True, null=True)),
                ('gender', models.CharField(blank=True, choices=[('M', 'Male'), ('F', 'Female')], max_length=1, null=True)),
                ('marital_status', models.CharField(blank=True, choices=[('S', 'Single'), ('M', 'Married'), ('D', 'Divorced'), ('W', 'Widowed')], max_length=20, null=True)),
                ('nationality', models.CharField(blank=True, choices=[('ALGERIAN', 'Algerian'), ('AMERICAN', 'American'), ('ARGENTINA', 'Argentina'), ('AUSTRALIAN', 'Australian'), ('BAHRAINI', 'Bahraini'), ('BANGLADESHI', 'Bangladeshi'), ('BELGIAN', 'Belgian'), ('BRAZILIAN', 'Brazilian'), ('BRITISH', 'British'), ('BULGARIAN', 'Bulgarian'), ('CAMEROONIAN', 'Cameroonian'), ('CANADIAN', 'Canadian'), ('CHILEAN', 'Chilean'), ('CHINESE', 'Chinese'), ('COLOMBIAN', 'Colombian'), ('CROATIAN', 'Croatian'), ('CUBAN', 'Cuban'), ('CYPRIOT', 'Cypriot'), ('CZECH', 'Czech'), ('DANISH', 'Danish'), ('DJIBOUTIAN', 'Djiboutian'), ('EGYPTIAN', 'Egyptian'), ('FILIPINO', 'Filipino'), ('FRENCH', 'French'), ('GERMAN', 'German'), ('GHANAIAN', 'Ghanaian'), ('GREEK', 'Greek'), ('DUTCH', 'Dutch'), ('HONG_KONGER', 'Hong Konger'), ('INDIAN', 'Indian'), ('INDONESIAN', 'Indonesian'), ('IRANIAN', 'Iranian'), ('IRAQI', 'Iraqi'), ('IRISH', 'Irish'), ('ITALIAN', 'Italian'), ('JAMAICAN', 'Jamaican'), ('JAPANESE', 'Japanese'), ('JORDANIAN', 'Jordanian'), ('KENYAN', 'Kenyan'), ('KUWAITI', 'Kuwaiti'), ('LEBANESE', 'Lebanese'), ('MALAWIAN', 'Malawian'), ('MALAYSIAN', 'Malaysian'), ('MEXICAN', 'Mexican'), ('MOROCCAN', 'Moroccan'), ('NEPALI', 'Nepali'), ('DUTCH', 'Dutch'), ('NEW_ZEALANDER', 'New Zealander'), ('NIGERIAN', 'Nigerian'), ('NORWEGIAN', 'Norwegian'), ('OMANI', 'Omani'), ('PAKISTANI', 'Pakistani'), ('POLISH', 'Polish'), ('PORTUGUESE', 'Portuguese'), ('RUSSIAN', 'Russian'), ('SAUDI', 'Saudi'), ('SCOTTISH', 'Scottish'), ('SERBIAN', 'Serbian'), ('SEYCHELLOIS', 'Seychellois'), ('SINGAPOREAN', 'Singaporean'), ('SOUTH_AFRICAN', 'South African'), ('SPANISH', 'Spanish'), ('SRI_LANKAN', 'Sri Lankan'), ('SUDANESE', 'Sudanese'), ('SWEDISH', 'Swedish'), ('SWISS', 'Swiss'), ('SYRIAN', 'Syrian'), ('TAIWANESE', 'Taiwanese'), ('TANZANIAN', 'Tanzanian'), ('THAI', 'Thai'), ('TUNISIAN', 'Tunisian'), ('TURKISH', 'Turkish'), ('EMIRATI', 'Emirati'), ('UGANDAN', 'Ugandan'), ('UKRAINIAN', 'Ukrainian'), ('VENEZUELAN', 'Venezuelan'), ('VIETNAMESE', 'Vietnamese'), ('YEMENI', 'Yemeni'), ('ZIMBABWEAN', 'Zimbabwean'), ('OTHER', 'Other')], max_length=50, null=True, verbose_name='Nationality')),
                ('religion', models.CharField(blank=True, max_length=50, null=True)),
                ('education_category', models.CharField(blank=True, max_length=50, null=True)),
                ('cpr_number', models.CharField(blank=True, max_length=20, null=True, unique=True)),
                ('email', models.EmailField(blank=True, max_length=254, null=True)),
                ('primary_phone', models.CharField(blank=True, max_length=20, null=True, verbose_name='Primary Number')),
                ('secondary_phone', models.CharField(blank=True, max_length=20, null=True, verbose_name='Secondary Number')),
                ('address', models.TextField(blank=True, null=True)),
                ('in_probation', models.BooleanField(default=True)),
                ('designation', models.CharField(blank=True, max_length=100, null=True)),
                ('contract_type', models.CharField(blank=True, choices=[('FT', 'Full Time'), ('PT', 'Part Time'), ('CT', 'Contract'), ('INT', 'Intern')], max_length=20, null=True)),
                ('joined_date', models.DateField(blank=True, null=True)),
                ('employee_category', models.CharField(blank=True, choices=[('GEN', 'General'), ('SUP', 'Supervisor'), ('MGR', 'Manager'), ('EXE', 'Executive')], max_length=20, null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('cost_center', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='cost_center_employees', to='employees.costprofitcenter')),
                ('department', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='employees.department')),
                ('division', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='employees.division')),
            ],
            options={
                'verbose_name': 'Employee',
                'verbose_name_plural': 'Employees',
                'ordering': ['employee_number'],
            },
        ),
        migrations.CreateModel(
            name='EmployeeOffence',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('offense_date', models.DateField()),
                ('applied_penalty', models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('DISMISS', 'Dismissal')], max_length=10)),
                ('original_penalty', models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('DISMISS', 'Dismissal')], max_length=10)),
                ('offense_count', models.PositiveIntegerField(default=1)),
                ('details', models.TextField()),
                ('warning_letter', models.FileField(blank=True, null=True, upload_to='offense_documents/')),
                ('acknowledgment', models.FileField(blank=True, null=True, upload_to='offense_documents/')),
                ('is_acknowledged', models.BooleanField(default=False)),
                ('acknowledged_at', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_offence_records', to=settings.AUTH_USER_MODEL)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='employee_offence_records', to='employees.employee')),
                ('modified_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='modified_offence_records', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Employee Offense',
                'verbose_name_plural': 'Employee Offenses',
                'ordering': ['-offense_date', '-created_at'],
            },
        ),
        migrations.CreateModel(
            name='Location',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('address', models.TextField()),
                ('code', models.CharField(max_length=20, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='OffenseRule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('rule_id', models.CharField(max_length=20, unique=True)),
                ('group', models.CharField(choices=[('ATTENDANCE', 'Attendance'), ('BEHAVIOR', 'Behavior'), ('PERFORMANCE', 'Performance'), ('SAFETY', 'Safety'), ('PROPERTY', 'Property'), ('OTHER', 'Other')], max_length=20)),
                ('name', models.CharField(max_length=200)),
                ('description', models.TextField()),
                ('first_penalty', models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('DISMISS', 'Dismissal')], max_length=10)),
                ('second_penalty', models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('DISMISS', 'Dismissal')], max_length=10)),
                ('third_penalty', models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('DISMISS', 'Dismissal')], max_length=10)),
                ('fourth_penalty', models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('DISMISS', 'Dismissal')], max_length=10)),
                ('remarks', models.TextField(blank=True, null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Offense Rule',
                'verbose_name_plural': 'Offense Rules',
                'ordering': ['group', 'rule_id'],
            },
        ),
        migrations.CreateModel(
            name='OffenseDocument',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('document', models.FileField(upload_to='offense_documents/')),
                ('document_type', models.CharField(max_length=50)),
                ('notes', models.TextField(blank=True, null=True)),
                ('uploaded_at', models.DateTimeField(auto_now_add=True)),
                ('offense', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documents', to='employees.employeeoffence')),
            ],
            options={
                'ordering': ['-uploaded_at'],
            },
        ),
        migrations.CreateModel(
            name='LifeEvent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('event_type', models.CharField(choices=[('MAR', 'Marriage'), ('CHD', 'Child Birth'), ('DEA', 'Death in Family'), ('OTH', 'Other')], max_length=3)),
                ('date', models.DateField()),
                ('description', models.TextField()),
                ('documents', models.FileField(blank=True, upload_to='life_event_documents/')),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='life_events', to='employees.employee')),
            ],
        ),
        migrations.AddField(
            model_name='employeeoffence',
            name='rule',
            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='employees.offenserule'),
        ),
        migrations.CreateModel(
            name='EmployeeEducation',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('institution', models.CharField(default='Unknown Institution', max_length=100)),
                ('major', models.CharField(default='General', max_length=100)),
                ('degree', models.CharField(default='Unknown Degree', max_length=50)),
                ('graduation_year', models.IntegerField(default=2000)),
                ('gpa', models.DecimalField(blank=True, decimal_places=2, max_digits=3, null=True)),
                ('description', models.TextField(blank=True)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='education', to='employees.employee')),
            ],
        ),
        migrations.CreateModel(
            name='EmployeeDocument',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('document_type', models.CharField(choices=[('PASSPORT', 'Passport'), ('RESIDENT', 'Resident Permit'), ('CPR', 'C.P.R'), ('GATE', 'Gate Pass'), ('CONTRACT', 'Contract'), ('CV', 'CV'), ('DRIVING', 'Driving License')], max_length=10)),
                ('document_number', models.CharField(max_length=50)),
                ('profession_title', models.CharField(blank=True, max_length=100, null=True, verbose_name='Profession / Title')),
                ('issue_date', models.DateField(blank=True, null=True)),
                ('issue_place', models.CharField(blank=True, max_length=100, null=True)),
                ('expiry_date', models.DateField(blank=True, null=True)),
                ('other_info', models.TextField(blank=True, null=True)),
                ('document_file', models.FileField(blank=True, null=True, upload_to='employee_documents/%Y/%m/', validators=[django.core.validators.FileExtensionValidator(allowed_extensions=['pdf', 'jpg', 'jpeg', 'png', 'doc', 'docx'])])),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documents', to='employees.employee')),
            ],
            options={
                'verbose_name': 'Employee Document',
                'verbose_name_plural': 'Employee Documents',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='EmployeeDependent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('relation', models.CharField(choices=[('spouse', 'Spouse'), ('child', 'Child'), ('parent', 'Parent'), ('sibling', 'Sibling'), ('other', 'Other')], max_length=20)),
                ('date_of_birth', models.DateField()),
                ('passport_number', models.CharField(blank=True, max_length=50, null=True)),
                ('passport_expiry', models.DateField(blank=True, null=True)),
                ('cpr_number', models.CharField(blank=True, max_length=20, null=True)),
                ('cpr_expiry', models.DateField(blank=True, null=True)),
                ('valid_passage', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='dependents', to='employees.employee')),
            ],
            options={
                'verbose_name': 'Employee Dependent',
                'verbose_name_plural': 'Employee Dependents',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='EmployeeBankAccount',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('bank', models.CharField(max_length=100)),
                ('account_number', models.CharField(max_length=50)),
                ('iban', models.CharField(max_length=50, verbose_name='IBAN No')),
                ('transfer_amount', models.DecimalField(blank=True, decimal_places=2, max_digits=10, null=True, verbose_name='Amount to be Transferred')),
                ('is_primary', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='bank_accounts', to='employees.employee')),
            ],
            options={
                'verbose_name': 'Employee Bank Account',
                'verbose_name_plural': 'Employee Bank Accounts',
                'ordering': ['-is_primary', '-created_at'],
            },
        ),
        migrations.CreateModel(
            name='EmployeeAsset',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('asset_name', models.CharField(max_length=100)),
                ('asset_number', models.CharField(blank=True, max_length=50, null=True)),
                ('issue_date', models.DateField(default=django.utils.timezone.now)),
                ('return_date', models.DateField(blank=True, null=True)),
                ('condition', models.TextField(default='New')),
                ('return_condition', models.TextField(blank=True, null=True)),
                ('value', models.DecimalField(decimal_places=2, default=0.0, max_digits=10)),
                ('notes', models.TextField(blank=True, null=True)),
                ('return_notes', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('asset_type', models.ForeignKey(null=True, on_delete=django.db.models.deletion.PROTECT, related_name='assets', to='employees.assettype')),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='assets', to='employees.employee')),
            ],
            options={
                'verbose_name': 'Employee Asset',
                'verbose_name_plural': 'Employee Assets',
                'ordering': ['-created_at'],
            },
        ),
        migrations.AddField(
            model_name='employee',
            name='location',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='employees.location'),
        ),
        migrations.AddField(
            model_name='employee',
            name='profit_center',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='profit_center_employees', to='employees.costprofitcenter'),
        ),
        migrations.CreateModel(
            name='EmergencyContact',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('relationship', models.CharField(max_length=50)),
                ('phone_number', models.CharField(max_length=20)),
                ('alternative_phone', models.CharField(blank=True, max_length=20)),
                ('address', models.TextField(blank=True)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='emergency_contacts', to='employees.employee')),
            ],
        ),
        migrations.CreateModel(
            name='DependentDocument',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('document_type', models.CharField(choices=[('PASSPORT', 'Passport'), ('CPR', 'CPR'), ('BIRTH_CERTIFICATE', 'Birth Certificate'), ('MARRIAGE_CERTIFICATE', 'Marriage Certificate'), ('OTHER', 'Other')], max_length=50)),
                ('document_number', models.CharField(blank=True, max_length=50, null=True)),
                ('name', models.CharField(max_length=255)),
                ('issue_date', models.DateField(blank=True, null=True)),
                ('expiry_date', models.DateField(blank=True, null=True)),
                ('nationality', models.CharField(blank=True, choices=[('ALGERIAN', 'Algerian'), ('AMERICAN', 'American'), ('ARGENTINA', 'Argentina'), ('AUSTRALIAN', 'Australian'), ('BAHRAINI', 'Bahraini'), ('BANGLADESHI', 'Bangladeshi'), ('BELGIAN', 'Belgian'), ('BRAZILIAN', 'Brazilian'), ('BRITISH', 'British'), ('BULGARIAN', 'Bulgarian'), ('CAMEROONIAN', 'Cameroonian'), ('CANADIAN', 'Canadian'), ('CHILEAN', 'Chilean'), ('CHINESE', 'Chinese'), ('COLOMBIAN', 'Colombian'), ('CROATIAN', 'Croatian'), ('CUBAN', 'Cuban'), ('CYPRIOT', 'Cypriot'), ('CZECH', 'Czech'), ('DANISH', 'Danish'), ('DJIBOUTIAN', 'Djiboutian'), ('EGYPTIAN', 'Egyptian'), ('FILIPINO', 'Filipino'), ('FRENCH', 'French'), ('GERMAN', 'German'), ('GHANAIAN', 'Ghanaian'), ('GREEK', 'Greek'), ('DUTCH', 'Dutch'), ('HONG_KONGER', 'Hong Konger'), ('INDIAN', 'Indian'), ('INDONESIAN', 'Indonesian'), ('IRANIAN', 'Iranian'), ('IRAQI', 'Iraqi'), ('IRISH', 'Irish'), ('ITALIAN', 'Italian'), ('JAMAICAN', 'Jamaican'), ('JAPANESE', 'Japanese'), ('JORDANIAN', 'Jordanian'), ('KENYAN', 'Kenyan'), ('KUWAITI', 'Kuwaiti'), ('LEBANESE', 'Lebanese'), ('MALAWIAN', 'Malawian'), ('MALAYSIAN', 'Malaysian'), ('MEXICAN', 'Mexican'), ('MOROCCAN', 'Moroccan'), ('NEPALI', 'Nepali'), ('DUTCH', 'Dutch'), ('NEW_ZEALANDER', 'New Zealander'), ('NIGERIAN', 'Nigerian'), ('NORWEGIAN', 'Norwegian'), ('OMANI', 'Omani'), ('PAKISTANI', 'Pakistani'), ('POLISH', 'Polish'), ('PORTUGUESE', 'Portuguese'), ('RUSSIAN', 'Russian'), ('SAUDI', 'Saudi'), ('SCOTTISH', 'Scottish'), ('SERBIAN', 'Serbian'), ('SEYCHELLOIS', 'Seychellois'), ('SINGAPOREAN', 'Singaporean'), ('SOUTH_AFRICAN', 'South African'), ('SPANISH', 'Spanish'), ('SRI_LANKAN', 'Sri Lankan'), ('SUDANESE', 'Sudanese'), ('SWEDISH', 'Swedish'), ('SWISS', 'Swiss'), ('SYRIAN', 'Syrian'), ('TAIWANESE', 'Taiwanese'), ('TANZANIAN', 'Tanzanian'), ('THAI', 'Thai'), ('TUNISIAN', 'Tunisian'), ('TURKISH', 'Turkish'), ('EMIRATI', 'Emirati'), ('UGANDAN', 'Ugandan'), ('UKRAINIAN', 'Ukrainian'), ('VENEZUELAN', 'Venezuelan'), ('VIETNAMESE', 'Vietnamese'), ('YEMENI', 'Yemeni'), ('ZIMBABWEAN', 'Zimbabwean'), ('OTHER', 'Other')], max_length=50, null=True)),
                ('document_file', models.FileField(blank=True, null=True, upload_to='dependent_documents/')),
                ('status', models.CharField(default='active', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('dependent', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documents', to='employees.employeedependent')),
            ],
        ),
    ]

```

### 📄 hrms_project\employees\migrations\0002_add_is_active_to_offense.py
```# Generated by Django 4.2.9 on 2025-01-12 05:12

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employees', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='employeeoffence',
            name='is_active',
            field=models.BooleanField(default=True),
        ),
    ]

```

### 📄 hrms_project\employees\migrations\0003_add_initial_offense_rules.py
```from django.db import migrations

def convert_penalty_to_code(penalty):
    penalty_map = {
        'Oral Warning': 'ORAL',
        'Written Warning': 'WRITTEN',
        '0.05': 'D005',
        '0.10': 'D010',
        '0.15': 'D015',
        '0.25': 'D025',
        '0.50': 'D050',
        '0.75': 'D075',
        '1': 'D100',
        '2': 'D200',
        '3': 'D300',
        '5': 'D500',
        'Dismissal': 'DISMISSAL',
    }
    return penalty_map.get(penalty, penalty)

def add_initial_offense_rules(apps, schema_editor):
    OffenseRule = apps.get_model('employees', 'OffenseRule')

    rules = [
        {
            'rule_id': '1.1',
            'group': 'ATTENDANCE_TIME',
            'name': 'Tardiness - Up to 15 Min (No Disruption)',
            'description': "Reporting late up to 15 minutes beyond the attendance time without permission or a valid excuse, where the delay doesn't hamper other workers.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.05'),
            'fourth_penalty': convert_penalty_to_code('0.10'),
            'remarks': '',
        },
        {
            'rule_id': '1.2',
            'group': 'ATTENDANCE_TIME',
            'name': 'Tardiness - Up to 15 Min (With Disruption)',
            'description': "Reporting late up to 15 minutes beyond the attendance time without permission or a valid excuse, resulting in the disruption of other workers.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '1.3',
            'group': 'ATTENDANCE_TIME',
            'name': 'Tardiness - 15 to 30 Min (No Disruption)',
            'description': "Reporting late more than 15 minutes but up to 30 minutes beyond the attendance time without permission or valid excuse, where the delay doesn't hamper other workers.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.15'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '1.4',
            'group': 'ATTENDANCE_TIME',
            'name': 'Tardiness - 15 to 30 Min (With Disruption)',
            'description': "Reporting late more than 15 minutes but up to 30 minutes beyond the attendance time without permission or valid excuse, resulting in the disruption of other workers.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.50'),
            'third_penalty': convert_penalty_to_code('0.75'),
            'fourth_penalty': convert_penalty_to_code('1'),
            'remarks': '',
        },
        {
            'rule_id': '1.5',
            'group': 'ATTENDANCE_TIME',
            'name': 'Tardiness - 30 to 60 Min (No Disruption)',
            'description': "Reporting late more than 15 minutes and up to 60 minutes beyond the attendance time without permission or a valid excuse, where the delay doesn't disrupt other workers.",
            'first_penalty': convert_penalty_to_code('0.25'),
            'second_penalty': convert_penalty_to_code('0.50'),
            'third_penalty': convert_penalty_to_code('0.75'),
            'fourth_penalty': convert_penalty_to_code('1'),
            'remarks': '',
        },
        {
            'rule_id': '1.6',
            'group': 'ATTENDANCE_TIME',
            'name': 'Tardiness - 30 to 60 Min (With Disruption)',
            'description': "Reporting late more than 15 minutes and up to 60 minutes beyond the attendance time without permission or a valid excuse, where the delay disrupts other workers.",
            'first_penalty': convert_penalty_to_code('0.30'),
            'second_penalty': convert_penalty_to_code('0.50'),
            'third_penalty': convert_penalty_to_code('0.75'),
            'fourth_penalty': convert_penalty_to_code('2'),
            'remarks': '',
        },
        {
            'rule_id': '1.7',
            'group': 'ATTENDANCE_TIME',
            'name': 'Tardiness - Over 60 Min',
            'description': "Reporting late more than one hour beyond the attendance time without permission or a valid excuse, where the delay does not result in hampering other workers.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('1'),
            'third_penalty': convert_penalty_to_code('2'),
            'fourth_penalty': convert_penalty_to_code('3'),
            'remarks': 'In addition to deducting delay hours.',
        },
        {
            'rule_id': '1.8',
            'group': 'ATTENDANCE_TIME',
            'name': 'Early Departure - Up to 15 Min',
            'description': "Leaving work early, no more than 15 minutes prior to the set hour without permission or a valid excuse.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('1'),
            'remarks': '',
        },
        {
            'rule_id': '1.9',
            'group': 'ATTENDANCE_TIME',
            'name': 'Early Departure - Over 15 Min',
            'description': "Leaving work early, more than 15 minutes prior to the leaving hour without permission or a valid excuse.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('1'),
            'remarks': 'In addition to deducting delay hours.',
        },
        {
            'rule_id': '1.10',
            'group': 'ATTENDANCE_TIME',
            'name': 'Unauthorized Overstay',
            'description': "Staying at work or returning to work after the working hours without a reasonable excuse.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('1'),
            'remarks': '',
        },
        {
            'rule_id': '2.1',
            'group': 'WORK_ORG',
            'name': 'Unauthorized Exit Use',
            'description': "Getting out from any exit other than those designated for this purpose.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.15'),
            'fourth_penalty': convert_penalty_to_code('0.25'),
            'remarks': '',
        },
        {
            'rule_id': '2.2',
            'group': 'WORK_ORG',
            'name': 'Unauthorized Visitors',
            'description': "Receiving visitors other than organization’s workers at the workplace without permission from management.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.15'),
            'fourth_penalty': convert_penalty_to_code('0.25'),
            'remarks': '',
        },
        {
            'rule_id': '2.3',
            'group': 'WORK_ORG',
            'name': 'Unauthorized Eating',
            'description': "Eating in any place or at any time other than those set for this purpose.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.15'),
            'fourth_penalty': convert_penalty_to_code('0.25'),
            'remarks': '',
        },
        {
            'rule_id': '2.4',
            'group': 'WORK_ORG',
            'name': 'Sleeping on Duty',
            'description': "Falling asleep during the working hours.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '2.5',
            'group': 'WORK_ORG',
            'name': 'Unauthorized Phone Use',
            'description': "Using organization's telephone for private purposes without permission.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '2.6',
            'group': 'WORK_ORG',
            'name': 'Loitering',
            'description': "Loitering or being caught anywhere other than set places during working hours.",
            'first_penalty': convert_penalty_to_code('0.10'),
            'second_penalty': convert_penalty_to_code('0.25'),
            'third_penalty': convert_penalty_to_code('0.50'),
            'fourth_penalty': convert_penalty_to_code('1'),
            'remarks': '',
        },
        {
            'rule_id': '2.7',
            'group': 'WORK_ORG',
            'name': 'Attendance Sheet Manipulation',
            'description': "Manipulation of the attendance sheet.",
            'first_penalty': convert_penalty_to_code('0.25'),
            'second_penalty': convert_penalty_to_code('0.50'),
            'third_penalty': convert_penalty_to_code('1'),
            'fourth_penalty': convert_penalty_to_code('2'),
            'remarks': '',
        },
        {
            'rule_id': '2.8',
            'group': 'WORK_ORG',
            'name': 'Disobeying Workflow Orders',
            'description': "Disobeying regular orders related to the workflow.",
            'first_penalty': convert_penalty_to_code('0.25'),
            'second_penalty': convert_penalty_to_code('0.50'),
            'third_penalty': convert_penalty_to_code('1'),
            'fourth_penalty': convert_penalty_to_code('2'),
            'remarks': '',
        },
        {
            'rule_id': '2.9',
            'group': 'WORK_ORG',
            'name': 'Failure to Follow Instructions',
            'description': "Failure to perform instructions related to workflow, provided those instructions are posted in a visible place.",
            'first_penalty': convert_penalty_to_code('0.25'),
            'second_penalty': convert_penalty_to_code('0.50'),
            'third_penalty': convert_penalty_to_code('1'),
            'fourth_penalty': convert_penalty_to_code('2'),
            'remarks': '',
        },
        {
            'rule_id': '2.10',
            'group': 'WORK_ORG',
            'name': 'Sleeping on Duty (Critical Role)',
            'description': "Falling asleep in a position or role that requires being permanently awake.",
            'first_penalty': convert_penalty_to_code('0.50'),
            'second_penalty': convert_penalty_to_code('1'),
            'third_penalty': convert_penalty_to_code('2'),
            'fourth_penalty': convert_penalty_to_code('3'),
            'remarks': '',
        },
        {
            'rule_id': '2.11',
            'group': 'WORK_ORG',
            'name': 'Incitement Against Instructions',
            'description': "Incitement against special instructions and orders.",
            'first_penalty': convert_penalty_to_code('2'),
            'second_penalty': convert_penalty_to_code('3'),
            'third_penalty': convert_penalty_to_code('5'),
            'fourth_penalty': convert_penalty_to_code('Dismissal'),
            'remarks': '',
        },
        {
            'rule_id': '2.12',
            'group': 'WORK_ORG',
            'name': 'Negligence Causing Harm',
            'description': "Neglect or negligence in work that causes harm to workers' health or safety, or damage to materials and tools.",
            'first_penalty': convert_penalty_to_code('2'),
            'second_penalty': convert_penalty_to_code('3'),
            'third_penalty': convert_penalty_to_code('5'),
            'fourth_penalty': convert_penalty_to_code('Dismissal'),
            'remarks': '',
        },
        {
            'rule_id': '2.13',
            'group': 'WORK_ORG',
            'name': 'Prohibited Substance Use',
            'description': "Smoking where it is forbidden to maintain workers' health, or drinking alcohol in the workplace.",
            'first_penalty': convert_penalty_to_code('2'),
            'second_penalty': convert_penalty_to_code('3'),
            'third_penalty': convert_penalty_to_code('5'),
            'fourth_penalty': convert_penalty_to_code('Dismissal'),
            'remarks': 'Worker may be dismissed if the violation results in gross damage',
        },
        {
            'rule_id': '3.1',
            'group': 'BEHAVIOR',
            'name': 'Unauthorized Fundraising',
            'description': "Raising funds or money without permission.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.2',
            'group': 'BEHAVIOR',
            'name': 'Unauthorized Posting',
            'description': "Posting on walls either by writing or taping ads.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.3',
            'group': 'BEHAVIOR',
            'name': 'Wasteful Material Consumption',
            'description': "Wasteful consumption of raw materials without permission.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.50'),
            'third_penalty': convert_penalty_to_code('1'),
            'fourth_penalty': convert_penalty_to_code('2'),
            'remarks': '',
        },
        {
            'rule_id': '3.4',
            'group': 'BEHAVIOR',
            'name': 'Misrepresentation Causing Dispute',
            'description': "Misrepresentation regarding seniors or peers in a way that results in suspending work or arising disputes internally within the Company.",
            'first_penalty': convert_penalty_to_code('0.25'),
            'second_penalty': convert_penalty_to_code('0.50'),
            'third_penalty': convert_penalty_to_code('1'),
            'fourth_penalty': convert_penalty_to_code('2'),
            'remarks': '',
        },
        {
            'rule_id': '3.5',
            'group': 'BEHAVIOR',
            'name': 'Refusal of Search',
            'description': "Refusal of search while leaving work.",
            'first_penalty': convert_penalty_to_code('0.25'),
            'second_penalty': convert_penalty_to_code('0.50'),
            'third_penalty': convert_penalty_to_code('1'),
            'fourth_penalty': convert_penalty_to_code('2'),
            'remarks': '',
        },
        {
            'rule_id': '3.6',
            'group': 'BEHAVIOR',
            'name': 'Violation of Health Instructions',
            'description': "Violation of health instructions while being at work.",
            'first_penalty': convert_penalty_to_code('0.50'),
            'second_penalty': convert_penalty_to_code('1'),
            'third_penalty': convert_penalty_to_code('2'),
            'fourth_penalty': convert_penalty_to_code('5'),
            'remarks': '',
        },
        {
            'rule_id': '3.7',
            'group': 'BEHAVIOR',
            'name': 'Unauthorized Use of Materials',
            'description': "Using objects, materials, and tools for private purposes.",
            'first_penalty': convert_penalty_to_code('1'),
            'second_penalty': convert_penalty_to_code('2'),
            'third_penalty': convert_penalty_to_code('3'),
            'fourth_penalty': convert_penalty_to_code('5'),
            'remarks': '',
        },
        {
            'rule_id': '3.8',
            'group': 'BEHAVIOR',
            'name': 'Quarrels and Rioting',
            'description': "Quarrelling with peers or creating quarrels while being at work, or rioting.",
            'first_penalty': convert_penalty_to_code('1'),
            'second_penalty': convert_penalty_to_code('2'),
            'third_penalty': convert_penalty_to_code('3'),
            'fourth_penalty': convert_penalty_to_code('5'),
            'remarks': '',
        },
        {
            'rule_id': '3.9',
            'group': 'BEHAVIOR',
            'name': 'Malingering',
            'description': "Malingering or the unapproved and undocumented use of sick leave. (Sick leaves need to be provided from government hospitals or clinics, or a private clinic or hospital approved by the company insurance provider, contingent on the use of medical insurance).",
            'first_penalty': convert_penalty_to_code('1'),
            'second_penalty': convert_penalty_to_code('2'),
            'third_penalty': convert_penalty_to_code('3'),
            'fourth_penalty': convert_penalty_to_code('5'),
            'remarks': '',
        },
        {
            'rule_id': '3.10',
            'group': 'BEHAVIOR',
            'name': 'Refusal of Medical Exam',
            'description': "Refusal of medical examination when requested by the organization's physician.",
            'first_penalty': convert_penalty_to_code('1'),
            'second_penalty': convert_penalty_to_code('2'),
            'third_penalty': convert_penalty_to_code('3'),
            'fourth_penalty': convert_penalty_to_code('5'),
            'remarks': '',
        },
        {
            'rule_id': '3.11',
            'group': 'BEHAVIOR',
            'name': 'Failure to Deliver Collected Money',
            'description': "Non-delivery of collected money into the organization account on time without a reasonable excuse.",
            'first_penalty': convert_penalty_to_code('2'),
            'second_penalty': convert_penalty_to_code('3'),
            'third_penalty': convert_penalty_to_code('5'),
            'fourth_penalty': convert_penalty_to_code('Dismissal'),
            'remarks': '',
        },
        {
            'rule_id': '3.12',
            'group': 'BEHAVIOR',
            'name': 'Violation of In-House Instructions',
            'description': "Violation of in-house instructions on work.",
            'first_penalty': convert_penalty_to_code('2'),
            'second_penalty': convert_penalty_to_code('3'),
            'third_penalty': convert_penalty_to_code('5'),
            'fourth_penalty': convert_penalty_to_code('Dismissal'),
            'remarks': '',
        },
        {
            'rule_id': '3.13',
            'group': 'BEHAVIOR',
            'name': 'Dress Code Violation',
            'description': "Not following the dress code required by the organization.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.10'),
            'fourth_penalty': convert_penalty_to_code('0.25'),
            'remarks': '',
        },
        {
            'rule_id': '3.14',
            'group': 'BEHAVIOR',
            'name': 'Failure to Complete Training',
            'description': "Failure to complete the training and development course.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.15',
            'group': 'BEHAVIOR',
            'name': 'Refusal to Attend Overtimes',
            'description': "Refusal to attend overtimes.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.16',
            'group': 'BEHAVIOR',
            'name': 'Unauthorized Transactions',
            'description': "Entering into purchase/sale transactions or the promotion of goods at the workplace.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.17',
            'group': 'BEHAVIOR',
            'name': 'Leaving Info Unattended',
            'description': "Leaving essential or confidential information unattended at the office or desk.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.18',
            'group': 'BEHAVIOR',
            'name': 'Leaving Info on Shared Device',
            'description': "Leaving essential or confidential information on the printer, photocopier, or fax machine.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.19',
            'group': 'BEHAVIOR',
            'name': 'Damage to Data Backups',
            'description': "Damaging data backups without permission from the organization’s management.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.20',
            'group': 'BEHAVIOR',
            'name': 'Failure to Report Theft',
            'description': "Failure to report any theft of a computer or related accessories.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.21',
            'group': 'BEHAVIOR',
            'name': 'Failure to Log Off Computer',
            'description': "Failure to log out and shut the computer down while being out of the office, unless otherwise required.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.22',
            'group': 'BEHAVIOR',
            'name': 'Misuse of Email',
            'description': "Misuse of email.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.23',
            'group': 'BEHAVIOR',
            'name': 'Trespassing/Assaulting Officials',
            'description': "Trespassing on or assaulting officials in any way.",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.24',
            'group': 'BEHAVIOR',
            'name': 'Tampering with Messages',
            'description': "Hiding, destroying, opening, or causing to be hidden, destroyed, or opened by third parties any message delivered to the mail (wired and wireless messages).",
            'first_penalty': convert_penalty_to_code('Written Warning'),
            'second_penalty': convert_penalty_to_code('0.10'),
            'third_penalty': convert_penalty_to_code('0.25'),
            'fourth_penalty': convert_penalty_to_code('0.50'),
            'remarks': '',
        },
        {
            'rule_id': '3.25',
            'group': 'BEHAVIOR',
            'name': 'Negligence with Data Backups',
            'description': "Negligence to keep a backup away from the computer or in a safe place.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.10'),
            'fourth_penalty': convert_penalty_to_code('0.25'),
            'remarks': '',
        },
        {
            'rule_id': '3.26',
            'group': 'BEHAVIOR',
            'name': 'Failure to Shut Down PC',
            'description': "Failure to shut down personal computers at the end of official working hours.",
            'first_penalty': convert_penalty_to_code('Oral Warning'),
            'second_penalty': convert_penalty_to_code('Written Warning'),
            'third_penalty': convert_penalty_to_code('0.10'),
            'fourth_penalty': convert_penalty_to_code('0.25'),
            'remarks': '',
        },
    ]

    for rule_data in rules:
        OffenseRule.objects.create(**rule_data)

def remove_initial_offense_rules(apps, schema_editor):
    OffenseRule = apps.get_model('employees', 'OffenseRule')
    rule_ids_to_remove = [
        '1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7', '1.8', '1.9', '1.10',
        '2.1', '2.2', '2.3', '2.4', '2.5', '2.6', '2.7', '2.8', '2.9', '2.10', '2.11', '2.12', '2.13',
        '3.1', '3.2', '3.3', '3.4', '3.5', '3.6', '3.7', '3.8', '3.9', '3.10', '3.11', '3.12', '3.13', '3.14', '3.15', '3.16', '3.17', '3.18', '3.19', '3.20', '3.21', '3.22', '3.23', '3.24', '3.25', '3.26',
    ]
    OffenseRule.objects.filter(rule_id__in=rule_ids_to_remove).delete()

class Migration(migrations.Migration):
    dependencies = [
        ('employees', '0002_add_is_active_to_offense'),
    ]

    operations = [
        migrations.RunPython(add_initial_offense_rules, remove_initial_offense_rules),
    ]
```

### 📄 hrms_project\employees\migrations\0004_update_offense_groups.py
```# Generated by Django 4.2.9 on 2025-01-12 05:30

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employees', '0003_add_initial_offense_rules'),
    ]

    operations = [
        migrations.AlterField(
            model_name='offenserule',
            name='group',
            field=models.CharField(choices=[('ATTENDANCE_TIME', 'Violations Concerning Attendance Time'), ('WORK_ORG', 'Violations Concerning Work Organization'), ('BEHAVIOR', 'Violations Concerning Employee Behavior'), ('SAFETY', 'Violations Concerning Safety'), ('PROPERTY', 'Violations Concerning Company Property'), ('OTHER', 'Other Violations')], max_length=20),
        ),
    ]

```

### 📄 hrms_project\employees\migrations\0005_remove_employeeoffence_acknowledgment_and_more.py
```# Generated by Django 4.2.9 on 2025-01-12 07:00

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employees', '0004_update_offense_groups'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='employeeoffence',
            name='acknowledgment',
        ),
        migrations.RemoveField(
            model_name='employeeoffence',
            name='warning_letter',
        ),
        migrations.AddField(
            model_name='employeeoffence',
            name='completed_date',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='employeeoffence',
            name='monetary_amount',
            field=models.DecimalField(blank=True, decimal_places=3, max_digits=10, null=True),
        ),
        migrations.AddField(
            model_name='employeeoffence',
            name='monthly_deduction',
            field=models.DecimalField(blank=True, decimal_places=3, max_digits=10, null=True),
        ),
        migrations.AddField(
            model_name='employeeoffence',
            name='refused_date',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='employeeoffence',
            name='refused_reason',
            field=models.TextField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='employeeoffence',
            name='remaining_amount',
            field=models.DecimalField(blank=True, decimal_places=3, max_digits=10, null=True),
        ),
        migrations.AddField(
            model_name='employeeoffence',
            name='sent_date',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='employeeoffence',
            name='signed_date',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='employeeoffence',
            name='applied_penalty',
            field=models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('MONETARY', 'Monetary Penalty'), ('DISMISS', 'Dismissal')], max_length=10),
        ),
        migrations.AlterField(
            model_name='employeeoffence',
            name='original_penalty',
            field=models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('MONETARY', 'Monetary Penalty'), ('DISMISS', 'Dismissal')], max_length=10),
        ),
        migrations.AlterField(
            model_name='offenserule',
            name='first_penalty',
            field=models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('MONETARY', 'Monetary Penalty'), ('DISMISS', 'Dismissal')], max_length=10),
        ),
        migrations.AlterField(
            model_name='offenserule',
            name='fourth_penalty',
            field=models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('MONETARY', 'Monetary Penalty'), ('DISMISS', 'Dismissal')], max_length=10),
        ),
        migrations.AlterField(
            model_name='offenserule',
            name='second_penalty',
            field=models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('MONETARY', 'Monetary Penalty'), ('DISMISS', 'Dismissal')], max_length=10),
        ),
        migrations.AlterField(
            model_name='offenserule',
            name='third_penalty',
            field=models.CharField(choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('MONETARY', 'Monetary Penalty'), ('DISMISS', 'Dismissal')], max_length=10),
        ),
    ]

```

### 📄 hrms_project\employees\migrations\0006_add_salary_models.py
```from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('employees', '0005_remove_employeeoffence_acknowledgment_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='SalaryDetail',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('basic_salary', models.DecimalField(decimal_places=3, max_digits=10)),
                ('housing_allowance', models.DecimalField(decimal_places=3, default=0, max_digits=10)),
                ('transportation_allowance', models.DecimalField(decimal_places=3, default=0, max_digits=10)),
                ('other_allowances', models.JSONField(default=dict, help_text='Store other allowances as key-value pairs')),
                ('total_salary', models.DecimalField(decimal_places=3, max_digits=10)),
                ('currency', models.CharField(default='BHD', max_length=3)),
                ('effective_from', models.DateField()),
                ('effective_to', models.DateField(blank=True, null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('notes', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_salary_details', to=settings.AUTH_USER_MODEL)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='salary_details', to='employees.employee')),
            ],
            options={
                'verbose_name': 'Salary Detail',
                'verbose_name_plural': 'Salary Details',
                'ordering': ['-effective_from'],
            },
        ),
        migrations.CreateModel(
            name='SalaryCertificate',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('certificate_number', models.CharField(max_length=50, unique=True)),
                ('issued_date', models.DateField()),
                ('purpose', models.CharField(max_length=200)),
                ('is_valid', models.BooleanField(default=True)),
                ('expiry_date', models.DateField(blank=True, null=True)),
                ('additional_notes', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='salary_certificates', to='employees.employee')),
                ('issued_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('salary_detail', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='employees.salarydetail')),
            ],
            options={
                'verbose_name': 'Salary Certificate',
                'verbose_name_plural': 'Salary Certificates',
                'ordering': ['-issued_date'],
            },
        ),
        migrations.CreateModel(
            name='SalaryRevision',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('revision_type', models.CharField(choices=[('INC', 'Increment'), ('PRO', 'Promotion'), ('ADJ', 'Adjustment'), ('DEM', 'Demotion'), ('PEN', 'Penalty'), ('OTH', 'Other')], max_length=3)),
                ('revision_date', models.DateField()),
                ('reason', models.TextField()),
                ('reference_number', models.CharField(blank=True, max_length=50, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('approved_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('employee', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='salary_revisions', to='employees.employee')),
                ('new_salary', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='revisions_to', to='employees.salarydetail')),
                ('previous_salary', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='revisions_from', to='employees.salarydetail')),
            ],
            options={
                'verbose_name': 'Salary Revision',
                'verbose_name_plural': 'Salary Revisions',
                'ordering': ['-revision_date'],
            },
        ),
    ]
```

### 📄 hrms_project\employees\migrations\0008_enable_trigram.py
```from django.contrib.postgres.operations import TrigramExtension
from django.db import migrations

class Migration(migrations.Migration):
    dependencies = [
        ('employees', '0006_add_salary_models'),
    ]

    operations = [
        TrigramExtension(),
    ]

```

### 📄 hrms_project\employees\migrations\0009_alter_employeeoffence_details_and_more.py
```# Generated by Django 4.2.9 on 2025-01-25 12:48

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employees', '0008_enable_trigram'),
    ]

    operations = [
        migrations.AlterField(
            model_name='employeeoffence',
            name='details',
            field=models.TextField(blank=True),
        ),
        migrations.AlterField(
            model_name='employeeoffence',
            name='original_penalty',
            field=models.CharField(blank=True, choices=[('ORAL', 'Oral Warning'), ('WRITTEN', 'Written Warning'), ('D005', '0.05 Day Deduction'), ('D010', '0.10 Day Deduction'), ('D015', '0.15 Day Deduction'), ('D025', '0.25 Day Deduction'), ('D030', '0.30 Day Deduction'), ('D050', '0.50 Day Deduction'), ('D075', '0.75 Day Deduction'), ('D100', '1 Day Deduction'), ('D200', '2 Days Deduction'), ('D300', '3 Days Deduction'), ('D500', '5 Days Deduction'), ('MONETARY', 'Monetary Penalty'), ('DISMISS', 'Dismissal')], max_length=10, null=True),
        ),
    ]

```

### 📄 hrms_project\employees\migrations\0010_employee_user.py
```# Generated by Django 4.2.9 on 2025-02-04 08:28

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('employees', '0009_alter_employeeoffence_details_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='employee',
            name='user',
            field=models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='employee', to=settings.AUTH_USER_MODEL),
        ),
    ]

```

### 📄 hrms_project\employees\migrations\__init__.py
```
```

### 📄 hrms_project\employees\models.py
```from django.db import models
from django.conf import settings
from django.core.validators import MinValueValidator
from django.core.exceptions import ValidationError
from django.utils import timezone
from django.core.files.uploadedfile import UploadedFile
from django.core.validators import FileExtensionValidator
import os

class Department(models.Model):
    name = models.CharField(max_length=100)
    name_ar = models.CharField(max_length=100, verbose_name="Name (Arabic)", blank=True, null=True)
    code = models.CharField(max_length=20, default='DEPT', unique=True)
    parent = models.ForeignKey('self', on_delete=models.SET_NULL, null=True, blank=True)
    manager = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, blank=True)
    
    def __str__(self):
        return self.name

class Division(models.Model):
    name = models.CharField(max_length=100)
    name_ar = models.CharField(max_length=100, verbose_name="Name (Arabic)")
    code = models.CharField(max_length=20, unique=True)
    department = models.ForeignKey(Department, on_delete=models.CASCADE)

    def __str__(self):
        return self.name

class Location(models.Model):
    name = models.CharField(max_length=100)
    address = models.TextField()
    code = models.CharField(max_length=20, unique=True)

    def __str__(self):
        return self.name

class Bank(models.Model):
    name = models.CharField(max_length=100)
    swift_code = models.CharField(max_length=20)

    def __str__(self):
        return self.name

class CostProfitCenter(models.Model):
    name = models.CharField(max_length=100)
    code = models.CharField(max_length=20, unique=True)
    description = models.TextField(blank=True, null=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.code} - {self.name}"

    class Meta:
        verbose_name = 'Cost/Profit Center'
        verbose_name_plural = 'Cost/Profit Centers'
        ordering = ['code']

class Employee(models.Model):
    # Choice Fields
    GENDER_CHOICES = [
        ('M', 'Male'),
        ('F', 'Female'),
    ]
    MARITAL_STATUS_CHOICES = [
        ('S', 'Single'),
        ('M', 'Married'),
        ('D', 'Divorced'),
        ('W', 'Widowed'),
    ]
    CONTRACT_TYPE_CHOICES = [
        ('FT', 'Full Time'),
        ('PT', 'Part Time'),
        ('CT', 'Contract'),
        ('INT', 'Intern'),
    ]
    EMPLOYEE_CATEGORY_CHOICES = [
        ('GEN', 'General'),
        ('SUP', 'Supervisor'),
        ('MGR', 'Manager'),
        ('EXE', 'Executive'),
    ]
    NATIONALITY_CHOICES = [
        ('ALGERIAN', 'Algerian'),
        ('AMERICAN', 'American'),
        ('ARGENTINA', 'Argentina'),
        ('AUSTRALIAN', 'Australian'),
        ('BAHRAINI', 'Bahraini'),
        ('BANGLADESHI', 'Bangladeshi'),
        ('BELGIAN', 'Belgian'),
        ('BRAZILIAN', 'Brazilian'),
        ('BRITISH', 'British'),
        ('BULGARIAN', 'Bulgarian'),
        ('CAMEROONIAN', 'Cameroonian'),
        ('CANADIAN', 'Canadian'),
        ('CHILEAN', 'Chilean'),
        ('CHINESE', 'Chinese'),
        ('COLOMBIAN', 'Colombian'),
        ('CROATIAN', 'Croatian'),
        ('CUBAN', 'Cuban'),
        ('CYPRIOT', 'Cypriot'),
        ('CZECH', 'Czech'),
        ('DANISH', 'Danish'),
        ('DJIBOUTIAN', 'Djiboutian'),
        ('EGYPTIAN', 'Egyptian'),
        ('FILIPINO', 'Filipino'),
        ('FRENCH', 'French'),
        ('GERMAN', 'German'),
        ('GHANAIAN', 'Ghanaian'),
        ('GREEK', 'Greek'),
        ('DUTCH', 'Dutch'),
        ('HONG_KONGER', 'Hong Konger'),
        ('INDIAN', 'Indian'),
        ('INDONESIAN', 'Indonesian'),
        ('IRANIAN', 'Iranian'),
        ('IRAQI', 'Iraqi'),
        ('IRISH', 'Irish'),
        ('ITALIAN', 'Italian'),
        ('JAMAICAN', 'Jamaican'),
        ('JAPANESE', 'Japanese'),
        ('JORDANIAN', 'Jordanian'),
        ('KENYAN', 'Kenyan'),
        ('KUWAITI', 'Kuwaiti'),
        ('LEBANESE', 'Lebanese'),
        ('MALAWIAN', 'Malawian'),
        ('MALAYSIAN', 'Malaysian'),
        ('MEXICAN', 'Mexican'),
        ('MOROCCAN', 'Moroccan'),
        ('NEPALI', 'Nepali'),
        ('DUTCH', 'Dutch'),
        ('NEW_ZEALANDER', 'New Zealander'),
        ('NIGERIAN', 'Nigerian'),
        ('NORWEGIAN', 'Norwegian'),
        ('OMANI', 'Omani'),
        ('PAKISTANI', 'Pakistani'),
        ('POLISH', 'Polish'),
        ('PORTUGUESE', 'Portuguese'),
        ('RUSSIAN', 'Russian'),
        ('SAUDI', 'Saudi'),
        ('SCOTTISH', 'Scottish'),
        ('SERBIAN', 'Serbian'),
        ('SEYCHELLOIS', 'Seychellois'),
        ('SINGAPOREAN', 'Singaporean'),
        ('SOUTH_AFRICAN', 'South African'),
        ('SPANISH', 'Spanish'),
        ('SRI_LANKAN', 'Sri Lankan'),
        ('SUDANESE', 'Sudanese'),
        ('SWEDISH', 'Swedish'),
        ('SWISS', 'Swiss'),
        ('SYRIAN', 'Syrian'),
        ('TAIWANESE', 'Taiwanese'),
        ('TANZANIAN', 'Tanzanian'),
        ('THAI', 'Thai'),
        ('TUNISIAN', 'Tunisian'),
        ('TURKISH', 'Turkish'),
        ('EMIRATI', 'Emirati'),
        ('UGANDAN', 'Ugandan'),
        ('UKRAINIAN', 'Ukrainian'),
        ('VENEZUELAN', 'Venezuelan'),
        ('VIETNAMESE', 'Vietnamese'),
        ('YEMENI', 'Yemeni'),
        ('ZIMBABWEAN', 'Zimbabwean'),
        ('OTHER', 'Other'),
    ]

    # General Information
    user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='employee',
        null=True,
        blank=True
    )
    employee_number = models.CharField(max_length=20, unique=True, default='EMP0001')
    profile_picture = models.ImageField(upload_to='employee_pictures/', blank=True, null=True)
    first_name = models.CharField(max_length=50, default='First')
    middle_name = models.CharField(max_length=50, blank=True, null=True)
    last_name = models.CharField(max_length=50, default='Last')
    first_name_ar = models.CharField(max_length=50, verbose_name="First Name (Arabic)", blank=True, null=True)
    middle_name_ar = models.CharField(max_length=50, verbose_name="Middle Name (Arabic)", blank=True, null=True)
    last_name_ar = models.CharField(max_length=50, verbose_name="Last Name (Arabic)", blank=True, null=True)
    date_of_birth = models.DateField(blank=True, null=True)
    gender = models.CharField(max_length=1, choices=GENDER_CHOICES, blank=True, null=True)
    marital_status = models.CharField(max_length=20, choices=MARITAL_STATUS_CHOICES, blank=True, null=True)
    nationality = models.CharField(
        max_length=50,
        choices=NATIONALITY_CHOICES,
        blank=True,
        null=True,
        verbose_name='Nationality'
    )
    religion = models.CharField(max_length=50, blank=True, null=True)
    education_category = models.CharField(max_length=50, blank=True, null=True)
    cpr_number = models.CharField(max_length=20, unique=True, blank=True, null=True)
    email = models.EmailField(max_length=254, blank=True, null=True)
    primary_phone = models.CharField(max_length=20, blank=True, null=True, verbose_name='Primary Number')
    secondary_phone = models.CharField(max_length=20, blank=True, null=True, verbose_name='Secondary Number')
    address = models.TextField(blank=True, null=True)
    in_probation = models.BooleanField(default=True)

    # Employment Information
    designation = models.CharField(max_length=100, blank=True, null=True)
    division = models.ForeignKey(Division, on_delete=models.SET_NULL, null=True, blank=True)
    department = models.ForeignKey(Department, on_delete=models.SET_NULL, null=True, blank=True)
    location = models.ForeignKey(Location, on_delete=models.SET_NULL, null=True, blank=True)
    contract_type = models.CharField(max_length=20, choices=CONTRACT_TYPE_CHOICES, blank=True, null=True)
    joined_date = models.DateField(blank=True, null=True)
    cost_center = models.ForeignKey(CostProfitCenter, on_delete=models.SET_NULL, null=True, blank=True, related_name='cost_center_employees')
    profit_center = models.ForeignKey(CostProfitCenter, on_delete=models.SET_NULL, null=True, blank=True, related_name='profit_center_employees')
    employee_category = models.CharField(max_length=20, choices=EMPLOYEE_CATEGORY_CHOICES, blank=True, null=True)

    # System Fields
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = 'Employee'
        verbose_name_plural = 'Employees'
        ordering = ['employee_number']

    def __str__(self):
        return f"{self.first_name} {self.last_name} ({self.employee_number})"

    def get_full_name(self):
        middle = f" {self.middle_name}" if self.middle_name else ""
        return f"{self.first_name}{middle} {self.last_name}"

    def get_full_name_ar(self):
        middle = f" {self.middle_name_ar}" if self.middle_name_ar else ""
        return f"{self.first_name_ar}{middle} {self.last_name_ar}"

class EmployeeBankAccount(models.Model):
    employee = models.ForeignKey('Employee', on_delete=models.CASCADE, related_name='bank_accounts')
    bank = models.CharField(max_length=100)
    account_number = models.CharField(max_length=50)
    iban = models.CharField(max_length=50, verbose_name="IBAN No")
    transfer_amount = models.DecimalField(
        max_digits=10, 
        decimal_places=2, 
        verbose_name="Amount to be Transferred",
        null=True,
        blank=True
    )
    is_primary = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-is_primary', '-created_at']
        verbose_name = "Employee Bank Account"
        verbose_name_plural = "Employee Bank Accounts"

    def __str__(self):
        return f"{self.employee.get_full_name()} - {self.bank} ({self.account_number})"

    def save(self, *args, **kwargs):
        # If this account is being set as primary, unset primary for other accounts
        if self.is_primary:
            EmployeeBankAccount.objects.filter(
                employee=self.employee, 
                is_primary=True
            ).exclude(pk=self.pk).update(is_primary=False)
        super().save(*args, **kwargs)

class EmployeeDependent(models.Model):
    RELATIONSHIP_CHOICES = [
        ('spouse', 'Spouse'),
        ('child', 'Child'),
        ('parent', 'Parent'),
        ('sibling', 'Sibling'),
        ('other', 'Other'),
    ]
    
    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='dependents')
    name = models.CharField(max_length=100)
    relation = models.CharField(max_length=20, choices=RELATIONSHIP_CHOICES)
    date_of_birth = models.DateField()
    passport_number = models.CharField(max_length=50, blank=True, null=True)
    passport_expiry = models.DateField(blank=True, null=True)
    cpr_number = models.CharField(max_length=20, blank=True, null=True)
    cpr_expiry = models.DateField(blank=True, null=True)
    valid_passage = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = "Employee Dependent"
        verbose_name_plural = "Employee Dependents"
        ordering = ['name']

    def __str__(self):
        return f"{self.name} ({self.get_relation_display()})"

class DependentDocument(models.Model):
    DOCUMENT_TYPES = [
        ('PASSPORT', 'Passport'),
        ('CPR', 'CPR'),
        ('BIRTH_CERTIFICATE', 'Birth Certificate'),
        ('MARRIAGE_CERTIFICATE', 'Marriage Certificate'),
        ('OTHER', 'Other'),
    ]

    dependent = models.ForeignKey(EmployeeDependent, on_delete=models.CASCADE, related_name='documents')
    document_type = models.CharField(max_length=50, choices=DOCUMENT_TYPES)
    document_number = models.CharField(max_length=50, blank=True, null=True)
    name = models.CharField(max_length=255)
    issue_date = models.DateField(blank=True, null=True)
    expiry_date = models.DateField(blank=True, null=True)
    nationality = models.CharField(max_length=50, choices=Employee.NATIONALITY_CHOICES, blank=True, null=True)
    document_file = models.FileField(upload_to='dependent_documents/', blank=True, null=True)
    status = models.CharField(max_length=20, default='active')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.dependent.name} - {self.get_document_type_display()}"

class EmergencyContact(models.Model):
    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='emergency_contacts')
    name = models.CharField(max_length=100)
    relationship = models.CharField(max_length=50)
    phone_number = models.CharField(max_length=20)
    alternative_phone = models.CharField(max_length=20, blank=True)
    address = models.TextField(blank=True)

    def __str__(self):
        return f"{self.name} ({self.relationship})"

class EmployeeDocument(models.Model):
    DOCUMENT_TYPES = [
        ('PASSPORT', 'Passport'),
        ('RESIDENT', 'Resident Permit'),
        ('CPR', 'C.P.R'),
        ('GATE', 'Gate Pass'),
        ('CONTRACT', 'Contract'),
        ('CV', 'CV'),
        ('DRIVING', 'Driving License'),
    ]
    
    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='documents')
    document_type = models.CharField(max_length=10, choices=DOCUMENT_TYPES)
    document_number = models.CharField(max_length=50)
    profession_title = models.CharField(max_length=100, blank=True, null=True, verbose_name="Profession / Title")
    issue_date = models.DateField(null=True, blank=True)
    issue_place = models.CharField(max_length=100, null=True, blank=True)
    expiry_date = models.DateField(null=True, blank=True)
    other_info = models.TextField(blank=True, null=True)
    document_file = models.FileField(
        upload_to='employee_documents/%Y/%m/',
        validators=[
            FileExtensionValidator(
                allowed_extensions=['pdf', 'jpg', 'jpeg', 'png', 'doc', 'docx']
            )
        ],
        null=True,
        blank=True
    )
    created_at = models.DateTimeField(default=timezone.now)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-created_at']
        verbose_name = "Employee Document"
        verbose_name_plural = "Employee Documents"

    def __str__(self):
        return f"{self.employee.get_full_name()} - {self.get_document_type_display()}"

    def clean(self):
        if self.expiry_date and self.issue_date:
            if self.expiry_date < self.issue_date:
                raise ValidationError({
                    'expiry_date': 'Expiry date cannot be earlier than issue date.'
                })

    def save(self, *args, **kwargs):
        if not self.pk:  # Only set created_at for new instances
            self.created_at = timezone.now()
            
        if self.document_file:
            # Get file extension
            _, ext = os.path.splitext(self.document_file.name)
            
            # Create new filename
            new_filename = f"{self.employee.employee_number}_{self.employee.get_full_name().replace(' ', '_')}_{self.get_document_type_display()}_{self.document_number}{ext}"
            
            # Set the new filename
            self.document_file.name = os.path.join(
                'employee_documents',
                timezone.now().strftime('%Y'),
                timezone.now().strftime('%m'),
                new_filename
            )
            
        self.full_clean()
        super().save(*args, **kwargs)

    @property
    def is_expired(self):
        return self.expiry_date < timezone.now().date() if self.expiry_date else False

    @property
    def file_extension(self):
        name, extension = os.path.splitext(self.document_file.name)
        return extension.lower()

    @property
    def is_image(self):
        return self.file_extension in ['.jpg', '.jpeg', '.png']

class AssetType(models.Model):
    name = models.CharField(max_length=100, unique=True)
    description = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(default=timezone.now)

    def __str__(self):
        return self.name

    class Meta:
        ordering = ['name']
        verbose_name = "Asset Type"
        verbose_name_plural = "Asset Types"

class EmployeeAsset(models.Model):
    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='assets')
    asset_type = models.ForeignKey(AssetType, on_delete=models.PROTECT, related_name='assets', null=True)
    asset_name = models.CharField(max_length=100)
    asset_number = models.CharField(max_length=50, blank=True, null=True)
    issue_date = models.DateField(default=timezone.now)
    return_date = models.DateField(null=True, blank=True)
    condition = models.TextField(default='New')
    return_condition = models.TextField(null=True, blank=True)
    value = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    notes = models.TextField(blank=True, null=True)
    return_notes = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(default=timezone.now)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        if self.asset_number:
            return f"{self.asset_name} - {self.asset_number}"
        return self.asset_name

    class Meta:
        ordering = ['-created_at']
        verbose_name = "Employee Asset"
        verbose_name_plural = "Employee Assets"

class EmployeeEducation(models.Model):
    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='education')
    institution = models.CharField(max_length=100, default='Unknown Institution')
    major = models.CharField(max_length=100, default='General')
    degree = models.CharField(max_length=50, default='Unknown Degree')
    graduation_year = models.IntegerField(default=2000)
    gpa = models.DecimalField(max_digits=3, decimal_places=2, blank=True, null=True)
    description = models.TextField(blank=True)

    def __str__(self):
        return f"{self.degree} from {self.institution}"

class OffenseRule(models.Model):
    PENALTY_CHOICES = [
        ('ORAL', 'Oral Warning'),
        ('WRITTEN', 'Written Warning'),
        ('D005', '0.05 Day Deduction'),
        ('D010', '0.10 Day Deduction'),
        ('D015', '0.15 Day Deduction'),
        ('D025', '0.25 Day Deduction'),
        ('D030', '0.30 Day Deduction'),
        ('D050', '0.50 Day Deduction'),
        ('D075', '0.75 Day Deduction'),
        ('D100', '1 Day Deduction'),
        ('D200', '2 Days Deduction'),
        ('D300', '3 Days Deduction'),
        ('D500', '5 Days Deduction'),
        ('MONETARY', 'Monetary Penalty'),
        ('DISMISS', 'Dismissal'),
    ]
    GROUP_CHOICES = [
        ('ATTENDANCE_TIME', 'Violations Concerning Attendance Time'),
        ('WORK_ORG', 'Violations Concerning Work Organization'),
        ('BEHAVIOR', 'Violations Concerning Employee Behavior'),
        ('SAFETY', 'Violations Concerning Safety'),
        ('PROPERTY', 'Violations Concerning Company Property'),
        ('OTHER', 'Other Violations'),
    ]

    rule_id = models.CharField(max_length=20, unique=True)
    group = models.CharField(max_length=20, choices=GROUP_CHOICES)
    name = models.CharField(max_length=200)
    description = models.TextField()
    first_penalty = models.CharField(max_length=10, choices=PENALTY_CHOICES)
    second_penalty = models.CharField(max_length=10, choices=PENALTY_CHOICES)
    third_penalty = models.CharField(max_length=10, choices=PENALTY_CHOICES)
    fourth_penalty = models.CharField(max_length=10, choices=PENALTY_CHOICES)
    remarks = models.TextField(blank=True, null=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['group', 'rule_id']
        verbose_name = 'Offense Rule'
        verbose_name_plural = 'Offense Rules'

    def __str__(self):
        return f"{self.rule_id} - {self.name}"

    def get_penalty_for_count(self, count):
        if count == 1:
            return self.first_penalty
        elif count == 2:
            return self.second_penalty
        elif count == 3:
            return self.third_penalty
        elif count >= 4:
            return self.fourth_penalty
        return None

    def get_penalty_display(self, penalty_code):
        return dict(self.PENALTY_CHOICES).get(penalty_code, penalty_code)


class EmployeeOffence(models.Model):
    employee = models.ForeignKey('Employee', on_delete=models.CASCADE, related_name='employee_offence_records')
    rule = models.ForeignKey(OffenseRule, on_delete=models.PROTECT)
    offense_date = models.DateField()
    applied_penalty = models.CharField(max_length=10, choices=OffenseRule.PENALTY_CHOICES)
    original_penalty = models.CharField(max_length=10, choices=OffenseRule.PENALTY_CHOICES, null=True, blank=True)
    offense_count = models.PositiveIntegerField(default=1)
    details = models.TextField(blank=True)
    
    # Monetary penalty fields
    monetary_amount = models.DecimalField(max_digits=10, decimal_places=3, null=True, blank=True)
    remaining_amount = models.DecimalField(max_digits=10, decimal_places=3, null=True, blank=True)
    monthly_deduction = models.DecimalField(max_digits=10, decimal_places=3, null=True, blank=True)
    
    # Status tracking
    is_acknowledged = models.BooleanField(default=False)
    acknowledged_at = models.DateTimeField(null=True, blank=True)
    signed_date = models.DateTimeField(null=True, blank=True)
    refused_date = models.DateTimeField(null=True, blank=True)
    refused_reason = models.TextField(blank=True, null=True)
    sent_date = models.DateTimeField(null=True, blank=True)
    completed_date = models.DateTimeField(null=True, blank=True)
    is_active = models.BooleanField(default=True)
    
    # Audit fields
    created_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, related_name='created_offence_records')
    modified_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, related_name='modified_offence_records')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-offense_date', '-created_at']
        verbose_name = 'Employee Offense'
        verbose_name_plural = 'Employee Offenses'

    def __str__(self):
        return f"{self.employee} - {self.rule.name} ({self.offense_date})"

    def save(self, *args, **kwargs):
        # If this is a new offense, set the offense count
        if not self.pk:
            self.offense_count = self.get_offense_count()
            
            # If this is a monetary penalty, set the remaining amount
            if self.applied_penalty == 'MONETARY' and self.monetary_amount:
                self.remaining_amount = self.monetary_amount

        super().save(*args, **kwargs)

    def get_offense_count(self):
        """Get the count of active offenses for this rule and employee"""
        return EmployeeOffence.objects.filter(
            employee=self.employee,
            rule=self.rule,
            offense_date__year=self.offense_date.year,
            is_active=True
        ).count() + 1

    def get_original_penalty_display(self):
        return dict(OffenseRule.PENALTY_CHOICES).get(self.original_penalty, '')

    def get_applied_penalty_display(self):
        penalty = dict(OffenseRule.PENALTY_CHOICES).get(self.applied_penalty, '')
        if self.applied_penalty == 'MONETARY' and self.monetary_amount:
            penalty += f" ({self.monetary_amount} BHD)"
        return penalty

    @classmethod
    def deactivate_previous_year_offenses(cls):
        """Deactivate all offenses from previous years"""
        current_year = timezone.now().year
        cls.objects.filter(
            offense_date__year__lt=current_year,
            is_active=True
        ).update(is_active=False)

class OffenseDocument(models.Model):
    offense = models.ForeignKey(EmployeeOffence, on_delete=models.CASCADE, related_name='documents')
    document = models.FileField(upload_to='offense_documents/')
    document_type = models.CharField(max_length=50)
    notes = models.TextField(blank=True, null=True)
    uploaded_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-uploaded_at']

    def __str__(self):
        return f"{self.offense} - {self.document_type}"

class LifeEvent(models.Model):
    EVENT_TYPES = [
        ('MAR', 'Marriage'),
        ('CHD', 'Child Birth'),
        ('DEA', 'Death in Family'),
        ('OTH', 'Other'),
    ]

    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='life_events')
    event_type = models.CharField(max_length=3, choices=EVENT_TYPES)
    date = models.DateField()
    description = models.TextField()
    documents = models.FileField(upload_to='life_event_documents/', blank=True)

    def __str__(self):
        return f"{self.get_event_type_display()} on {self.date}"

class SalaryDetail(models.Model):
    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='salary_details')
    basic_salary = models.DecimalField(max_digits=10, decimal_places=3)
    housing_allowance = models.DecimalField(max_digits=10, decimal_places=3, default=0)
    transportation_allowance = models.DecimalField(max_digits=10, decimal_places=3, default=0)
    other_allowances = models.JSONField(default=dict, help_text="Store other allowances as key-value pairs")
    total_salary = models.DecimalField(max_digits=10, decimal_places=3)
    currency = models.CharField(max_length=3, default='BHD')
    effective_from = models.DateField()
    effective_to = models.DateField(null=True, blank=True)
    is_active = models.BooleanField(default=True)
    notes = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    created_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, related_name='created_salary_details')

    class Meta:
        ordering = ['-effective_from']
        verbose_name = "Salary Detail"
        verbose_name_plural = "Salary Details"

    def __str__(self):
        return f"{self.employee.get_full_name()} - {self.effective_from}"

    def save(self, *args, **kwargs):
        # Calculate total salary
        self.total_salary = (
            self.basic_salary +
            self.housing_allowance +
            self.transportation_allowance +
            sum(float(amount) for amount in self.other_allowances.values())
        )
        
        # If this is a new active salary detail, deactivate other active ones
        if self.is_active and not self.pk:
            SalaryDetail.objects.filter(
                employee=self.employee,
                is_active=True
            ).update(
                is_active=False,
                effective_to=self.effective_from
            )
            
        super().save(*args, **kwargs)

class SalaryRevision(models.Model):
    REVISION_TYPES = [
        ('INC', 'Increment'),
        ('PRO', 'Promotion'),
        ('ADJ', 'Adjustment'),
        ('DEM', 'Demotion'),
        ('PEN', 'Penalty'),
        ('OTH', 'Other'),
    ]

    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='salary_revisions')
    revision_type = models.CharField(max_length=3, choices=REVISION_TYPES)
    previous_salary = models.ForeignKey(SalaryDetail, on_delete=models.PROTECT, related_name='revisions_from')
    new_salary = models.ForeignKey(SalaryDetail, on_delete=models.PROTECT, related_name='revisions_to')
    revision_date = models.DateField()
    reason = models.TextField()
    reference_number = models.CharField(max_length=50, blank=True, null=True)
    approved_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-revision_date']
        verbose_name = "Salary Revision"
        verbose_name_plural = "Salary Revisions"

    def __str__(self):
        return f"{self.employee.get_full_name()} - {self.get_revision_type_display()} on {self.revision_date}"

    @property
    def difference(self):
        return self.new_salary.total_salary - self.previous_salary.total_salary

    @property
    def percentage_change(self):
        return (self.difference / self.previous_salary.total_salary) * 100

class SalaryCertificate(models.Model):
    employee = models.ForeignKey(Employee, on_delete=models.CASCADE, related_name='salary_certificates')
    certificate_number = models.CharField(max_length=50, unique=True)
    issued_date = models.DateField()
    purpose = models.CharField(max_length=200)
    salary_detail = models.ForeignKey(SalaryDetail, on_delete=models.PROTECT)
    issued_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True)
    is_valid = models.BooleanField(default=True)
    expiry_date = models.DateField(null=True, blank=True)
    additional_notes = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-issued_date']
        verbose_name = "Salary Certificate"
        verbose_name_plural = "Salary Certificates"

    def __str__(self):
        return f"{self.employee.get_full_name()} - {self.certificate_number}"

```

### 📄 hrms_project\employees\serializers.py
```from rest_framework import serializers
from .models import EmployeeAsset, AssetType, EmployeeOffence, OffenseDocument, OffenseRule
from django.utils import timezone

class AssetTypeSerializer(serializers.ModelSerializer):
    class Meta:
        model = AssetType
        fields = '__all__'

class EmployeeAssetSerializer(serializers.ModelSerializer):
    asset_type_display = serializers.CharField(read_only=True)
    
    class Meta:
        model = EmployeeAsset
        fields = '__all__'
        read_only_fields = ['id', 'created_at', 'updated_at']

    def to_representation(self, instance):
        representation = super().to_representation(instance)
        representation['asset_type_display'] = instance.get_asset_type_display()
        return representation

class BulkEmployeeAssetSerializer(serializers.Serializer):
    employee_ids = serializers.ListField(
        child=serializers.IntegerField(),
        required=True
    )
    asset_type = serializers.PrimaryKeyRelatedField(
        queryset=AssetType.objects.all(),
        required=True
    )
    asset_number = serializers.CharField(required=True)
    description = serializers.CharField(required=False, allow_blank=True)
    issue_date = serializers.DateField(required=True)
    return_date = serializers.DateField(required=False, allow_null=True)
    
    def create(self, validated_data):
        employee_ids = validated_data.pop('employee_ids')
        assets = []
        
        for employee_id in employee_ids:
            asset = EmployeeAsset.objects.create(
                employee_id=employee_id,
                **validated_data
            )
            assets.append(asset)
        
        return assets

class OffenseDocumentSerializer(serializers.ModelSerializer):
    class Meta:
        model = OffenseDocument
        fields = '__all__'

class OffenseRuleSerializer(serializers.ModelSerializer):
    class Meta:
        model = OffenseRule
        fields = '__all__'

class EmployeeOffenceSerializer(serializers.ModelSerializer):
    class Meta:
        model = EmployeeOffence
        fields = '__all__'
        read_only_fields = ('created_by', 'modified_by', 'created_at', 'updated_at')

    def create(self, validated_data):
        # Set original_penalty to match applied_penalty if not provided
        if 'original_penalty' not in validated_data:
            validated_data['original_penalty'] = validated_data.get('applied_penalty')
        
        # Set details to empty string if not provided
        if 'details' not in validated_data:
            validated_data['details'] = ''
            
        return super().create(validated_data)

```

### 📄 hrms_project\employees\static\employees\js\assets.js
```document.addEventListener('DOMContentLoaded', function() {
    const employeeId = 1; // Make sure this is defined globally
    const API_BASE = '/employees/api'; // Base API path

    // Initialize modals
    const viewAssetModal = new bootstrap.Modal('#viewAssetModal');
    const assetsModal = new bootstrap.Modal(document.getElementById('addAssetsModal'));
    const assetTypeModal = new bootstrap.Modal(document.getElementById('addAssetTypeModal'));
    const manageTypesModal = new bootstrap.Modal(document.getElementById('manageAssetTypesModal'));
    const returnAssetModal = new bootstrap.Modal(document.getElementById('returnAssetModal'));

    // Function to properly clean up modal
    function cleanupModal() {
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }

    // Handle saving asset type
    document.getElementById('saveAssetTypeBtn').addEventListener('click', async function() {
        const formData = new FormData(document.getElementById('addAssetTypeForm'));
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch(`${API_BASE}/asset-types/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to add asset type');
            }

            const newType = await response.json();
            
            // Add new option to asset type select
            const select = document.querySelector('#addAssetsForm select[name="asset_type"]');
            const option = new Option(newType.name, newType.id);
            select.add(option);
            option.selected = true; // Select the new option

            // Add new row to asset types table if it exists
            const typeTable = document.querySelector('#assetTypesTable tbody');
            if (typeTable) {
                const newRow = typeTable.insertRow();
                newRow.dataset.typeId = newType.id;
                newRow.innerHTML = `
                    <td>${newType.name}</td>
                    <td>${newType.description || '-'}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger delete-type" data-type-id="${newType.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            }

            // Reset and close the asset type modal
            document.getElementById('addAssetTypeForm').reset();
            assetTypeModal.hide();
            cleanupModal();

        } catch (error) {
            console.error('Error adding asset type:', error);
            alert(error.message || 'Failed to add asset type. Please try again.');
        }
    });

    // Handle assets form submission
    document.getElementById('saveAssetsBtn').addEventListener('click', async function() {
        const form = document.getElementById('addAssetsForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const selectedTypes = Array.from(form.querySelector('select[name="asset_type"]').selectedOptions);

        if (selectedTypes.length === 0) {
            alert('Please select at least one asset type');
            return;
        }

        try {
            let currentNumber = data.asset_number;

            for (const option of selectedTypes) {
                const type = {
                    id: option.value,
                    name: option.text
                };
                const quantity = parseInt(data[`quantity_${type.id}`]) || 1;

                for (let i = 0; i < quantity; i++) {
                    const assetData = {
                        asset_name: `${type.name} ${currentNumber}`,
                        asset_type_id: type.id,
                        asset_number: currentNumber,
                        issue_date: data.issue_date || new Date().toISOString().split('T')[0],
                        condition: data.condition || 'New',
                        value: data.value || '0',
                        notes: data.notes || ''
                    };

                    console.log('Sending asset data:', assetData);
                    const response = await fetch(`/employees/${employeeId}/assets/add/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(assetData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Failed to add ${type.name} asset ${i + 1}`);
                    }

                    currentNumber = incrementAssetNumber(currentNumber, 1);
                }
            }

            // Reset form and close modal
            form.reset();
            assetsModal.hide();
            cleanupModal();
            location.reload();
        } catch (error) {
            console.error('Error adding assets:', error);
            alert(error.message || 'Failed to add assets. Please try again.');
        }
    });

    // Handle deleting asset type
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-type') || e.target.closest('.delete-type')) {
            const btn = e.target.classList.contains('delete-type') ? e.target : e.target.closest('.delete-type');
            const typeId = btn.dataset.typeId;
            const typeName = btn.closest('tr').cells[0].textContent;

            if (confirm(`Are you sure you want to delete the asset type "${typeName}"? This cannot be undone.`)) {
                deleteAssetType(typeId);
            }
        }
    });

    // Function to delete asset type
    async function deleteAssetType(typeId) {
        try {
            const response = await fetch(`${API_BASE}/asset-types/${typeId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to delete asset type');
            }

            // Remove the row from the manage types table
            const row = document.querySelector(`#assetTypesTable tr[data-type-id="${typeId}"]`);
            if (row) {
                row.remove();
            }

            // Remove the option from the asset type select
            const select = document.querySelector('#addAssetsForm select[name="asset_type"]');
            const option = select.querySelector(`option[value="${typeId}"]`);
            if (option) {
                option.remove();
            }

        } catch (error) {
            console.error('Error deleting asset type:', error);
            alert(error.message || 'Failed to delete asset type. Please try again.');
        }
    }

    // Handle view asset button
    document.addEventListener('click', function(e) {
        const viewBtn = e.target.closest('.view-asset');
        if (viewBtn) {
            e.preventDefault();
            const assetId = viewBtn.dataset.assetId;
            viewAsset(assetId);
        }
    });

    // Function to view asset details
    async function viewAsset(assetId) {
        try {
            const response = await fetch(`/employees/${employeeId}/assets/${assetId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch asset details');
            }

            const asset = await response.json();
            console.log('Asset details:', asset); // Debug log
            
            // Populate modal with asset details
            const elements = {
                viewAssetType: asset.asset_type?.name,
                viewAssetName: asset.asset_name,
                viewAssetNumber: asset.asset_number,
                viewIssueDate: asset.issue_date ? new Date(asset.issue_date).toLocaleDateString() : null,
                viewCondition: asset.condition,
                viewValue: asset.value ? `$${parseFloat(asset.value).toFixed(2)}` : null,
                viewNotes: asset.notes
            };

            // Update each element with fallback to '-' if value is null/undefined
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value || '-';
                }
            });

            // Handle return details section
            const returnSection = document.getElementById('returnDetailsSection');
            if (returnSection) {
                if (asset.return_date) {
                    document.getElementById('viewReturnDate').textContent = new Date(asset.return_date).toLocaleDateString();
                    document.getElementById('viewReturnCondition').textContent = asset.return_condition || '-';
                    document.getElementById('viewReturnNotes').textContent = asset.return_notes || '-';
                    returnSection.style.display = 'block';
                } else {
                    returnSection.style.display = 'none';
                }
            }

            // Show the modal
            const modalElement = document.getElementById('viewAssetModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
            
        } catch (error) {
            console.error('Error viewing asset:', error);
            alert(error.message || 'Failed to view asset details');
        }
    }

    // Handle return asset button
    document.addEventListener('click', function(e) {
        if (e.target.closest('.return-asset')) {
            const btn = e.target.closest('.return-asset');
            const assetId = btn.dataset.assetId;
            const row = btn.closest('tr');
            const assetName = row.cells[2].textContent;
            
            // Set current date as default
            const returnDateInput = document.getElementById('returnDate');
            returnDateInput.value = new Date().toISOString().split('T')[0];
            
            // Store asset ID in the modal
            document.getElementById('returnAssetIds').value = assetId;
            
            // Show return modal
            returnAssetModal.show();
        }
    });

    // Handle select all checkbox
    document.getElementById('selectAll').addEventListener('change', function(e) {
        const checkboxes = document.querySelectorAll('.asset-select:not(:disabled)');
        checkboxes.forEach(checkbox => checkbox.checked = e.target.checked);
        updateBulkReturnButton();
    });

    // Handle individual checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('asset-select')) {
            updateBulkReturnButton();
        }
    });

    // Update bulk return button visibility
    function updateBulkReturnButton() {
        const checkedBoxes = document.querySelectorAll('.asset-select:checked').length;
        const bulkReturnBtn = document.getElementById('bulkReturnBtn');
        bulkReturnBtn.style.display = checkedBoxes > 0 ? 'inline-block' : 'none';
    }

    // Handle bulk return button
    document.getElementById('bulkReturnBtn').addEventListener('click', function() {
        const selectedAssets = Array.from(document.querySelectorAll('.asset-select:checked')).map(checkbox => {
            const row = checkbox.closest('tr');
            return {
                id: row.dataset.assetId,
                name: row.cells[2].textContent
            };
        });

        if (selectedAssets.length === 0) {
            alert('Please select at least one asset to return');
            return;
        }

        // Set current date as default
        const returnDateInput = document.getElementById('returnDate');
        returnDateInput.value = new Date().toISOString().split('T')[0];
        
        // Store asset IDs in the modal
        document.getElementById('returnAssetIds').value = selectedAssets.map(a => a.id).join(',');
        
        // Show return modal
        returnAssetModal.show();
    });

    // Handle confirm return button
    document.getElementById('confirmReturnAsset').addEventListener('click', async function() {
        const form = document.getElementById('returnAssetForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const assetIds = document.getElementById('returnAssetIds').value.split(',');
        const returnDate = document.getElementById('returnDate').value;
        const returnCondition = document.getElementById('returnCondition').value;
        const returnNotes = document.getElementById('returnNotes').value;

        try {
            // Return each asset
            for (const assetId of assetIds) {
                const response = await fetch(`/employees/${employeeId}/assets/${assetId}/return/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        return_date: returnDate,
                        return_condition: returnCondition,
                        return_notes: returnNotes
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to return asset');
                }
            }

            // Close modal and refresh page
            returnAssetModal.hide();
            cleanupModal();
            location.reload();
            
        } catch (error) {
            console.error('Error returning assets:', error);
            alert(error.message || 'Failed to return assets');
        }
    });

    // Handle delete asset button
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-asset')) {
            const btn = e.target.closest('.delete-asset');
            const assetId = btn.dataset.assetId;
            const row = btn.closest('tr');
            const assetName = row.cells[2].textContent;
            
            if (confirm(`Are you sure you want to delete "${assetName}"? This cannot be undone.`)) {
                deleteAsset(assetId);
            }
        }
    });

    // Function to delete an asset
    async function deleteAsset(assetId) {
        try {
            const response = await fetch(`/employees/${employeeId}/assets/${assetId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (!response.ok) {
                throw new Error('Failed to delete asset');
            }

            // Remove the row from the table
            const row = document.querySelector(`tr[data-asset-id="${assetId}"]`);
            if (row) {
                row.remove();
            }
            
        } catch (error) {
            console.error('Error deleting asset:', error);
            alert(error.message || 'Failed to delete asset');
        }
    }

    // Utility function to increment asset numbers
    function incrementAssetNumber(baseNumber, increment) {
        const matches = baseNumber.match(/^([A-Za-z]+)(\d+)$/);
        if (!matches) return baseNumber;
        
        const prefix = matches[1];
        const number = parseInt(matches[2]);
        const newNumber = (number + increment).toString().padStart(matches[2].length, '0');
        return prefix + newNumber;
    }

    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Add event listeners for modal hidden events
    ['addAssetTypeModal', 'manageAssetTypesModal', 'addAssetsModal', 'viewAssetModal', 'returnAssetModal'].forEach(modalId => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            modalElement.addEventListener('hidden.bs.modal', cleanupModal);
        }
    });

    // Handle modal backdrop cleanup
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            cleanupModal();
        }
    });
});

```

### 📄 hrms_project\employees\static\employees\js\employee_detail.js
```// Initialize all tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

```

### 📄 hrms_project\employees\static\employees\js\offences.js
```// Global variables
let allRules = []; // Store all rules for searching

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals and tooltips
    const addOffenceModal = new bootstrap.Modal('#addOffenceModal');
    const viewOffenceModal = new bootstrap.Modal('#viewOffenceModal');
    const addDocumentModal = new bootstrap.Modal('#addDocumentModal');

    // Cache DOM elements
    const offenseSearch = document.getElementById('offenseSearch');
    const offenceGroup = document.getElementById('offenceGroup');
    const offenceRule = document.getElementById('offenceRule');
    const appliedPenalty = document.getElementById('appliedPenalty');
    const offenseDate = document.getElementById('offenseDate');
    const addOffenceForm = document.getElementById('addOffenceForm');
    const addDocumentForm = document.getElementById('addDocumentForm');
    const ruleDescription = document.getElementById('ruleDescription');
    const ruleDescriptionText = document.getElementById('ruleDescriptionText');
    const previousOffenses = document.getElementById('previousOffenses');
    const previousOffensesList = document.getElementById('previousOffensesList');
    const offenseYear = document.getElementById('offenseYear');
    const offenseCount = document.getElementById('offenseCount');
    const suggestedPenalty = document.getElementById('suggestedPenalty');
    const penaltyNote = document.getElementById('penaltyNote');
    const monetaryPenaltySection = document.getElementById('monetaryPenaltySection');

    let currentRule = null; // Store the currently selected rule

    // Get the employee ID from the URL
    const employeeId = window.location.pathname.split('/')[2];

    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    offenseDate.value = today;
    offenseYear.textContent = new Date().getFullYear();

    // Helper Functions
    function populateRules(filterGroup = null) {
        console.log('Populating rules with filter:', filterGroup);
        console.log('Available rules:', allRules);

        let filteredRules = allRules;
        if (filterGroup) {
            filteredRules = allRules.filter(rule => rule.group === filterGroup);
        }

        let options = '<option value="">Select Rule</option>';
        if (Array.isArray(filteredRules)) {
            filteredRules.forEach(rule => {
                const groupLabel = offenceGroup.querySelector(`option[value="${rule.group}"]`)?.textContent || '';
                options += `<option value="${rule.id}" data-group="${rule.group}" data-description="${rule.description}">${rule.rule_id} - ${rule.name}</option>`;
            });
        }
        offenceRule.innerHTML = options;
        console.log('Updated dropdown HTML:', offenceRule.innerHTML);

        // Update tooltips after populating options
        offenceRule.querySelectorAll('option').forEach(option => {
            if (option.dataset.description) {
                option.title = option.dataset.description;
            }
        });
    }

    function formatRule(rule) {
        if (!rule.id) return rule.text;

        const highlight = (text, term) => {
            if (!term) return text;
            return text.replace(new RegExp(escapeRegex(term), 'gi'), match => `<strong>${match}</strong>`);
        };

        const searchTerm = rule.element?.dataset?.searchTerm || '';
        const description = rule.rule?.description || '';
        const groupDisplay = rule.rule?.group_display || '';

        const $container = $(
            `<div class="rule-option p-2">
                <div class="rule-title fw-bold mb-1">${highlight(rule.text, searchTerm)}</div>
                <div class="rule-info small text-muted">
                    <div class="mb-1"><strong>Group:</strong> ${groupDisplay}</div>
                    <div class="text-wrap">${highlight(description, searchTerm)}</div>
                </div>
             </div>`
        );

        return $container;
    }

    function formatRuleSelection(rule) {
        if (!rule.id) return rule.text;
        return `${rule.rule?.rule_id} - ${rule.rule?.name}`;
    }

    // API Functions
    async function fetchAllRules() {
        try {
            console.log('Fetching rules...');
            const response = await fetch('/employees/api/offense-rules/');
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            console.log('Raw API response:', data);

            allRules = Array.isArray(data) ? data : (data.results || []);
            console.log('Processed rules:', allRules);

            populateRules();
        } catch (error) {
            console.error('Error loading rules:', error);
            showAlert('Error loading rules. Please try again.', 'danger');
        }
    }

    async function updatePenalty(ruleId, year = new Date().getFullYear()) {
        try {
            const rule = allRules.find(r => r.id === parseInt(ruleId));
            if (!rule) return;

            currentRule = rule;

            // Get active offense count for the specified year
            const response = await fetch(`/employees/api/employee-offenses/${employeeId}/count/?rule=${ruleId}&year=${year}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            // Set the suggested penalty
            appliedPenalty.value = data.suggested_penalty;
            suggestedPenalty.textContent = appliedPenalty.options[appliedPenalty.selectedIndex].text;
            suggestedPenalty.dataset.value = data.suggested_penalty;
            penaltyNote.style.display = 'none';

            // Show description
            if (rule.description) {
                ruleDescriptionText.textContent = rule.description;
                ruleDescription.style.display = 'block';
            } else {
                ruleDescription.style.display = 'none';
            }

            // Update offense count and list
            offenseCount.textContent = data.count + 1;

            if (data.offenses && data.offenses.length > 0) {
                let offenseHtml = '<ul class="mb-2">';
                data.offenses.forEach((offense, index) => {
                    const date = new Date(offense.date).toLocaleDateString();
                    offenseHtml += `<li>Offense #${index + 1}: ${date} - ${offense.penalty}</li>`;
                });
                offenseHtml += '</ul>';

                previousOffensesList.innerHTML = offenseHtml;
                previousOffenses.style.display = 'block';
            } else {
                previousOffensesList.innerHTML = '<p class="mb-2">No previous offenses this year.</p>';
                previousOffenses.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading rule details:', error);
            showAlert('Error loading rule details. Please try again.', 'danger');
        }
    }





    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // Initialize and destroy Select2 when modal is shown/hidden
    $('#addOffenceModal').on('shown.bs.modal', function() {
        console.log('Modal shown, initializing select2...');

        // Initialize select2 with a small delay
        setTimeout(function() {
            $('#offenseSearch').select2({
                width: '100%',
                placeholder: 'Search for offense rule...',
                minimumInputLength: 2,
                dropdownParent: $('#addOffenceModal'),
                ajax: {
                    url: '/employees/api/offense-rules/',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            search: params.term,
                            page: params.page || 1
                        };
                    },
                    processResults: function(data) {
                        return {
                            results: data.map(function(rule) {
                                return {
                                    id: rule.id,
                                    text: `${rule.rule_id} - ${rule.name}`,
                                    rule: {
                                        ...rule,
                                        group_display: rule.group_display || rule.group
                                    }
                                };
                            }),
                            pagination: {
                                more: false
                            }
                        };
                    },
                    cache: true
                },
                templateResult: formatRule,
                templateSelection: formatRuleSelection,
                escapeMarkup: function(markup) {
                    return markup;
                }
            });
        }, 50); // 50ms delay - you can adjust if needed

    }).on('hidden.bs.modal', function() {
        // Destroy select2 when modal is hidden
        try {
            $('#offenseSearch').select2('destroy');
        } catch (e) {
            console.log('No select2 instance to destroy');
        }
    });

    // Handle offense date change
    offenseDate.addEventListener('change', async function() {
        if (currentRule) {
            const year = new Date(this.value).getFullYear();
            offenseYear.textContent = year;
            await updatePenalty(currentRule.id, year);
        }
    });

    // Handle applied penalty change
    appliedPenalty.addEventListener('change', function() {
        const suggestedValue = suggestedPenalty.dataset.value;
        const monetaryPenaltySection = document.getElementById('monetaryPenaltySection');

        // Show/hide monetary penalty section based on penalty type
        if (this.value === 'MONETARY') {
            monetaryPenaltySection.style.display = 'block';
        } else {
            monetaryPenaltySection.style.display = 'none';
        }

        // Show warning if different from suggested penalty
        if (suggestedValue && this.value !== suggestedValue) {
            penaltyNote.style.display = 'block';
        } else {
            penaltyNote.style.display = 'none';
        }
    });

    // Handle offense status changes
    async function markOffenseStatus(offenseId, status) {
        try {
            const response = await fetch(`/employees/api/employee-offenses/${offenseId}/status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ status })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Reload the page to show updated status
            location.reload();
        } catch (error) {
            console.error('Error updating offense status:', error);
            showAlert('Error updating offense status. Please try again.', 'danger');
        }
    }

    // Handle monetary penalty payments
    async function recordPayment(offenseId) {
        const amount = prompt('Enter payment amount (BHD):');
        if (!amount) return;

        try {
            const response = await fetch(`/employees/api/employee-offenses/${offenseId}/payment/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ amount: parseFloat(amount) })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Reload the page to show updated payment status
            location.reload();
        } catch (error) {
            console.error('Error recording payment:', error);
            showAlert('Error recording payment. Please try again.', 'danger');
        }
    }

    // Print offense
    async function printOffense(offenseId) {
        try {
            const response = await fetch(`/employees/api/employee-offenses/${offenseId}/print/`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Create a blob from the PDF stream
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);

            // Open the PDF in a new window
            window.open(url);
        } catch (error) {
            console.error('Error generating offense print:', error);
            showAlert('Error generating offense print. Please try again.', 'danger');
        }
    }

    // Event Listeners
    $(offenseSearch).on('select2:select', async function(e) {
        const selectedRule = e.params.data.rule;
        if (selectedRule) {
            offenceGroup.value = selectedRule.group;
            await populateRules();
            offenceRule.value = selectedRule.id;
            await updatePenalty(selectedRule.id);
        }
    });

    offenceGroup.addEventListener('change', function() {
        const group = this.value;
        populateRules(group);
    });

    offenceRule.addEventListener('change', async function() {
        const ruleId = this.value;
        if (!ruleId) {
            ruleDescription.style.display = 'none';
            return;
        }

        const selectedOption = this.options[this.selectedIndex];
        const group = selectedOption.dataset.group;

        if (group && offenceGroup.value !== group) {
            offenceGroup.value = group;
        }

        await updatePenalty(ruleId);
    });

    // Handle offense date change
    offenseDate.addEventListener('change', async function() {
        if (currentRule) {
            const year = new Date(this.value).getFullYear();
            offenseYear.textContent = year;
            await updatePenalty(currentRule.id, year);
        }
    });

    // Handle applied penalty change
    appliedPenalty.addEventListener('change', function() {
        const suggestedValue = suggestedPenalty.dataset.value;
        const monetaryPenaltySection = document.getElementById('monetaryPenaltySection');

        // Show/hide monetary penalty section based on penalty type
        if (this.value === 'MONETARY') {
            monetaryPenaltySection.style.display = 'block';
        } else {
            monetaryPenaltySection.style.display = 'none';
        }

        // Show warning if different from suggested penalty
        if (suggestedValue && this.value !== suggestedValue) {
            penaltyNote.style.display = 'block';
        } else {
            penaltyNote.style.display = 'none';
        }
    });

    // Handle save offense
    document.getElementById('saveOffenceBtn').addEventListener('click', async function() {
        try {
            const formData = new FormData(addOffenceForm);

            // Add employee ID to form data
            formData.append('employee', employeeId);

            // Get the rule ID from the select element
            const selectedRule = $('#offenseSearch').select2('data')[0];
            if (!selectedRule || !selectedRule.id) {
                showAlert('Please select an offense rule.', 'danger');
                return;
            }

            // Add the rule ID with correct field name
            formData.append('rule', selectedRule.id);

            // If it's a monetary penalty, add the monetary fields
            if (appliedPenalty.value === 'MONETARY') {
                const monetaryAmount = document.getElementById('monetaryAmount').value;
                const monthlyDeduction = document.getElementById('monthlyDeduction').value;

                if (!monetaryAmount || monetaryAmount <= 0) {
                    showAlert('Please enter a valid monetary penalty amount.', 'danger');
                    return;
                }

                if (!monthlyDeduction || monthlyDeduction <= 0) {
                    showAlert('Please enter a valid monthly deduction amount.', 'danger');
                    return;
                }

                formData.append('monetary_amount', monetaryAmount);
                formData.append('monthly_deduction', monthlyDeduction);
            }

            const response = await fetch('/employees/api/employee-offenses/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || error.detail || 'Failed to save offense');
            }

            const offense = await response.json();

            // Clear form and close modal
            addOffenceForm.reset();
            monetaryPenaltySection.style.display = 'none';
            addOffenceModal.hide();

            // Show success message and reload page
            showAlert('Offense added successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            console.error('Error saving offense:', error);
            showAlert(error.message || 'Error saving offense. Please try again.', 'danger');
        }
    });

    // Handle view offense
    document.addEventListener('click', function(e) {
        const viewBtn = e.target.closest('.view-offence');
        if (viewBtn) {
            e.preventDefault();
            viewOffence(viewBtn.dataset.offenceId);
        }
    });

    // Handle add document
    document.addEventListener('click', function(e) {
        const addDocBtn = e.target.closest('.add-document');
        if (addDocBtn) {
            e.preventDefault();
            document.getElementById('documentOffenseId').value = addDocBtn.dataset.offenceId;
            addDocumentModal.show();
        }
    });

    // Handle save document
    document.getElementById('saveDocumentBtn').addEventListener('click', async function() {
        if (!addDocumentForm.checkValidity()) {
            addDocumentForm.reportValidity();
            return;
        }

        const formData = new FormData(addDocumentForm);

        try {
            const response = await fetch('/employees/api/offense-documents/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });

            if (!response.ok) throw new Error('Failed to save document');

            addDocumentModal.hide();
            addDocumentForm.reset();
            showAlert('Document added successfully!', 'success');

            // Refresh offense details if viewing
            const offenseId = formData.get('offense_id');
            if (viewOffenceModal._isShown) {
                viewOffence(offenseId);
            }
        } catch (error) {
            console.error('Error saving document:', error);
            showAlert('Error saving document. Please try again.', 'danger');
        }
    });

    // Initialize
    fetchAllRules();
});

// Utility Functions
function addOffenceToTable(offense) {
    const tbody = document.querySelector('#offencesTable tbody');
    const tr = document.createElement('tr');
    tr.dataset.offenceId = offense.id;

    if (!offense.is_active) {
        tr.classList.add('table-secondary');
    }

    const offenseDate = new Date(offense.offense_date);

    tr.innerHTML = `
        <td>${offense.rule.rule_id}</td>
        <td>${offenseDate.toLocaleDateString()}</td>
        <td>${offenseDate.getFullYear()}</td>
        <td>${offense.rule.group_display}</td>
        <td>${offense.rule.name}</td>
        <td>${offense.offense_count}</td>
        <td>${offense.original_penalty_display}</td>
        <td>${offense.applied_penalty_display}</td>
        <td>
            ${offense.is_active ?
                `<span class="badge ${offense.is_acknowledged ? 'bg-success' : 'bg-warning'}">
                    ${offense.is_acknowledged ? 'Acknowledged' : 'Pending'}
                </span>` :
                '<span class="badge bg-secondary">Inactive</span>'
            }
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-info view-offence" data-offence-id="${offense.id}" title="View Details">
                <i class="fas fa-eye"></i>
            </button>
            ${offense.is_active ?
                `<button type="button" class="btn btn-sm btn-primary add-document" data-offence-id="${offense.id}" title="Add Document">
                    <i class="fas fa-file-upload"></i>
                </button>` : ''
            }
        </td>
    `;

    tbody.insertBefore(tr, tbody.firstChild);
}

async function viewOffence(offenseId) {
    try {
        // Get offense details
        const response = await fetch(`/employees/api/employee-offenses/${offenseId}/`);
        const offense = await response.json();

        // Update offense details
        document.getElementById('viewRuleId').textContent = offense.rule.rule_id;
        document.getElementById('viewRuleName').textContent = offense.rule.name;
        document.getElementById('viewGroup').textContent = offense.rule.group_display;
        document.getElementById('viewDescription').textContent = offense.rule.description;
        document.getElementById('viewDate').textContent = new Date(offense.offense_date).toLocaleDateString();
        document.getElementById('viewOriginalPenalty').textContent = offense.original_penalty_display;
        document.getElementById('viewAppliedPenalty').textContent = offense.applied_penalty_display;
        document.getElementById('viewStatus').innerHTML = offense.is_active ?
            `<span class="badge ${offense.is_acknowledged ? 'bg-success' : 'bg-warning'}">
                ${offense.is_acknowledged ? 'Acknowledged' : 'Pending'}
            </span>` :
            '<span class="badge bg-secondary">Inactive</span>';

        // Get offense count and history
        const year = new Date(offense.offense_date).getFullYear();
        const countResponse = await fetch(`/employees/api/employee-offenses/${offense.employee}/count/?rule=${offense.rule.id}&year=${year}`);
        if (!countResponse.ok) {
            throw new Error(`HTTP error! status: ${countResponse.status}`);
        }
        const countData = await countResponse.json();

        // Show previous offenses if any exist
        const viewPreviousOffenses = document.getElementById('viewPreviousOffenses');
        const viewPreviousOffensesList = document.getElementById('viewPreviousOffensesList');

        if (countData.offenses && countData.offenses.length > 0) {
            let offenseHtml = `<p class="mb-2">This is offense #${countData.count} for this rule in ${year}.</p>`;
            offenseHtml += '<ul class="mb-0">';
            countData.offenses.forEach((o, index) => {
                const date = new Date(o.date).toLocaleDateString();
                const isCurrent = o.date === offense.offense_date;
                offenseHtml += `<li${isCurrent ? ' class="fw-bold"' : ''}>${date} - ${o.penalty}${isCurrent ? ' (Current)' : ''}</li>`;
            });
            offenseHtml += '</ul>';

            viewPreviousOffensesList.innerHTML = offenseHtml;
            viewPreviousOffenses.style.display = 'block';
        } else {
            viewPreviousOffenses.style.display = 'none';
        }

        // Update documents list
        const documentsList = document.getElementById('viewDocumentsList');
        if (offense.documents && offense.documents.length > 0) {
            let docsHtml = '<ul class="list-unstyled mb-0">';
            offense.documents.forEach(doc => {
                docsHtml += `
                    <li class="mb-2">
                        <i class="fas fa-file me-2"></i>
                        <a href="${doc.file_url}" target="_blank">${doc.name || 'Document'}</a>
                        <small class="text-muted">(${doc.document_type_display})</small>
                    </li>`;
            });
            docsHtml += '</ul>';
            documentsList.innerHTML = docsHtml;
        } else {
            documentsList.innerHTML = '<p class="text-muted mb-0">No documents attached</p>';
        }

        // Show the modal
        const viewOffenceModal = new bootstrap.Modal('#viewOffenceModal');
        viewOffenceModal.show();
    } catch (error) {
        console.error('Error loading offense details:', error);
        showAlert('Error loading offense details. Please try again.', 'danger');
    }
}

function showAlert(message, type = 'info') {
    const alertsContainer = document.getElementById('alerts-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    alertsContainer.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
```

### 📄 hrms_project\employees\templates\employees\base.html
```<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}HRM System{% endblock %}</title>
    
    <!-- jQuery first -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    
    {% block extra_css %}{% endblock %}
    <style>
        body {
            padding-top: 10px;
        }
        .navbar {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 1030;
        }
        .main-content {
            margin-top: 2rem;
        }
        .select2-container {
            width: 100% !important;
        }
        .select2-selection__rendered {
            line-height: 31px !important;
        }
        .select2-container .select2-selection--single {
            height: 35px !important;
        }
        .select2-selection__arrow {
            height: 34px !important;
        }
        .flag-icon {
            margin-right: 8px;
        }
        /* Toast styling */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1060;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="{% url 'core:dashboard' %}"><i class="fas fa-home"></i> HRM System</a>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'employees:employee_list' %}">Employees</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <span class="nav-link">Welcome, {{ user.username }}</span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'core:logout' %}">Logout</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'core:login' %}">Login</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Main Content -->
    <div class="container-fluid main-content p-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Select2 and flag icons -->
    <link href="https://cdn.jsdelivr.net/npm/flag-icon-css@4.1.7/css/flag-icons.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Utility Functions -->
    <script>
    function showToast(title, message, type = 'info') {
        const toastContainer = document.querySelector('.toast-container');
        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : 
                       type === 'error' ? 'bg-danger' : 
                       type === 'warning' ? 'bg-warning' : 'bg-info';
        const textClass = type === 'warning' ? 'text-dark' : 'text-white';
        
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header ${bgClass} ${textClass}">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
        toast.show();
        
        // Remove the toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function () {
            toastElement.remove();
        });
    }

    function showFormErrors(form, errors) {
        // Clear previous error messages
        form.find('.invalid-feedback').remove();
        form.find('.is-invalid').removeClass('is-invalid');
        
        // Add new error messages
        for (const field in errors) {
            const input = form.find(`[name="${field}"]`);
            input.addClass('is-invalid');
            
            const errorDiv = $('<div>')
                .addClass('invalid-feedback')
                .text(errors[field].join(' '));
            
            input.after(errorDiv);
        }
        
        // Show error toast
        showToast('Error', 'Please correct the errors in the form.', 'error');
    }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>

```

### 📄 hrms_project\employees\templates\employees\certificate_form.html
```{% extends "employees/base.html" %}
{% load static %}

{% block title %}Request Salary Certificate - {{ employee.get_full_name }}{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="card info-card">
        <div class="card-header">
            <h5 class="mb-0">Request Salary Certificate</h5>
        </div>
        <div class="card-body">
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="{{ form.purpose.id_for_label }}" class="form-label">Purpose *</label>
                            {{ form.purpose }}
                            {% if form.purpose.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.purpose.errors.0 }}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Specify the purpose for requesting this certificate</small>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.expiry_date.id_for_label }}" class="form-label">Expiry Date</label>
                            {{ form.expiry_date }}
                            {% if form.expiry_date.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.expiry_date.errors.0 }}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Optional. Leave blank if certificate should not expire.</small>
                        </div>
                    </div>
                </div>

                <!-- Current Salary Information (Read-only) -->
                {% if employee.salary_details.exists %}
                {% with current_salary=employee.salary_details.first %}
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading mb-2">Current Salary Information</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <small class="d-block text-muted">Basic Salary:</small>
                            <strong>{{ current_salary.basic_salary }} {{ current_salary.currency }}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="d-block text-muted">Total Allowances:</small>
                            <strong>{{ current_salary.housing_allowance|add:current_salary.transportation_allowance }} {{ current_salary.currency }}</strong>
                        </div>
                        <div class="col-md-4">
                            <small class="d-block text-muted">Total Salary:</small>
                            <strong>{{ current_salary.total_salary }} {{ current_salary.currency }}</strong>
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% else %}
                <div class="alert alert-warning mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No active salary details found. Please add salary details before requesting a certificate.
                </div>
                {% endif %}

                <div class="d-flex justify-content-end">
                    <a href="{% url 'employees:employee_detail' employee.id %}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary" {% if not employee.salary_details.exists %}disabled{% endif %}>
                        Request Certificate
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize form validation
    (function() {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();
</script>
{% endblock %}
```

### 📄 hrms_project\employees\templates\employees\employee_confirm_delete.html
```{% extends "employees/base.html" %}

{% block title %}Delete Employee{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Confirm Delete</h5>
    </div>
    <div class="card-body">
        <p>Are you sure you want to delete the employee "{{ employee.get_full_name }}"?</p>
        <p class="text-danger">This action cannot be undone.</p>
    </div>
    <div class="card-footer">
        <form method="post">
            {% csrf_token %}
            <a href="{% url 'employees:employee_detail' employee.pk %}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</div>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\employee_detail.html
```{% extends "employees/base.html" %}
{% load static %}

{% block title %}{{ employee.get_full_name }} - Employee Details{% endblock %}

{% block extra_css %}
<style>
    /* Keep the CSS here as it's specific to this page */
    .profile-header {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .info-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
        border: none;
    }

    .info-card .card-header {
        background: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem 1.5rem;
    }

    .info-card .card-header h5 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }

    .info-section {
        padding: 1rem;
        background: #f8f9fc;
        border-radius: 0.5rem;
    }

    .section-title {
        color: #4e73df;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-group {
        display: grid;
        gap: 1rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
    }

    .info-item label {
        font-size: 0.8rem;
        color: #858796;
        margin-bottom: 0.25rem;
    }

    .info-item .value {
        color: #2c3e50;
        font-weight: 500;
    }

    .nav-pills .nav-link {
        color: #6c757d;
        padding: 0.75rem 1.25rem;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .nav-pills .nav-link.active {
        background-color: #4e73df;
        color: white;
    }

    .nav-pills .nav-link:hover:not(.active) {
        background-color: #f8f9fa;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-block;
    }

    .status-active {
        background-color: #e3fcef;
        color: #00a854;
    }

    .status-inactive {
        background-color: #fff1f0;
        color: #f5222d;
    }

    .status-warning {
        background-color: #fff7e6;
        color: #fa8c16;
    }

    .status-success {
        background-color: #e3fcef;
        color: #00a854;
    }

    .table {
        --bs-table-hover-bg: rgba(78, 115, 223, 0.05);
    }

    .btn-group .btn {
        margin: 0 2px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Profile Header -->
 <div class="container-fluid p-4">
<div class="profile-header">
    <div class="row align-items-center">
        <div class="col-auto">
            {% if employee.profile_picture %}
                <a href="#" data-bs-toggle="modal" data-bs-target="#profilePictureModal">
                    <img src="{{ employee.profile_picture.url }}" alt="Profile Picture" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                </a>
                <!-- Profile Picture Modal -->
                <div class="modal fade" id="profilePictureModal" tabindex="-1" aria-labelledby="profilePictureModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="profilePictureModalLabel">{{ employee.get_full_name }}'s Profile Picture</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img src="{{ employee.profile_picture.url }}" alt="Profile Picture" class="img-fluid">
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                    <i class="fas fa-user fa-3x text-white"></i>
                </div>
            {% endif %}
        </div>
        <div class="col">
            <h2 class="mb-1">{{ employee.get_full_name }}</h2>
            <p class="mb-1">Employee #{{ employee.employee_number }}</p>
            <p class="mb-0">{{ employee.designation|default:"" }}</p>
        </div>
        <div class="col-auto">
            <span class="status-badge {% if employee.is_active %}status-active{% else %}status-inactive{% endif %}">
                {{ employee.is_active|yesno:"Active,Inactive" }}
            </span>
        </div>
        <div class="col-auto">
            <a href="{% url 'employees:employee_update' employee.pk %}" class="btn btn-light me-2">
                <i class="fas fa-edit"></i> Edit
            </a>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="nav flex-column nav-pills" id="employeeTabs" role="tablist">
            <a class="nav-link active" data-bs-toggle="pill" href="#general" role="tab">
                <i class="fas fa-user me-2"></i>General
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#bank" role="tab">
                <i class="fas fa-university me-2"></i>Bank
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#documents" role="tab">
                <i class="fas fa-file-alt me-2"></i>Documents
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#dependents" role="tab">
                <i class="fas fa-users me-2"></i>Dependents
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#salary" role="tab">
                <i class="fas fa-money-bill-wave me-2"></i>Salary
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#attendance" role="tab">
                <i class="fas fa-calendar-check me-2"></i>Attendance
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#bond" role="tab">
                <i class="fas fa-handshake me-2"></i>Bond & Guarantee
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#assets" role="tab">
                <i class="fas fa-laptop me-2"></i>Assets In Hand
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#education" role="tab">
                <i class="fas fa-graduation-cap me-2"></i>Education
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#offences" role="tab">
                <i class="fas fa-exclamation-triangle me-2"></i>Offences
            </a>
            <a class="nav-link" data-bs-toggle="pill" href="#events" role="tab">
                <i class="fas fa-history me-2"></i>Life Events
            </a>
        </div>
    </div>

    <div class="col-md-9">
        <div class="tab-content" id="employeeTabContent">
            <!-- Include the content for each tab here -->
            {% include 'employees/preview/_employee_general_tab.html' %}
            {% include 'employees/preview/_employee_bank_tab.html' %}
            {% include 'employees/preview/_employee_documents_tab.html' %}
            {% include 'employees/preview/dependents/_employee_dependents_tab.html' %}
            {% include 'employees/preview/_employee_salary_tab.html' %}
            {% include 'employees/preview/_employee_attendance_tab.html' %}
            {% include 'employees/preview/_employee_bond_tab.html' %}
            {% include 'employees/preview/assets_in_hand/_employee_assets_tab.html' %}
            {% include 'employees/preview/_employee_education_tab.html' %}
            {% include 'employees/preview/_employee_offences_tab.html' %}
            {% include 'employees/preview/_employee_events_tab.html' %}
        </div>
    </div>
</div>
</div>

<!-- Delete Modal -->
{% include 'employees/preview/_employee_delete_modal.html' %}
{% endblock %}

{% block extra_js %}
<!-- Custom JS for employee details -->
<script src="{% static 'employees/js/employee_detail.js' %}"></script>
<script src="{% static 'employees/js/offences.js' %}"></script>
{% endblock %}
```

### 📄 hrms_project\employees\templates\employees\employee_form.html
```{% extends "employees/base.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Employee{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Employee</h2>
    </div>
</div>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="card">
        <div class="card-body">
            {% crispy form %}
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all tabs
        var triggerTabList = [].slice.call(document.querySelectorAll('.nav-tabs a'))
        triggerTabList.forEach(function(triggerEl) {
            new bootstrap.Tab(triggerEl)
        })
    });

    $(document).ready(function() {
        // Initialize Select2 for nationality field
        $('#id_nationality').select2({
            placeholder: 'Select nationality',
            allowClear: true,
            templateResult: formatNationality,
            templateSelection: formatNationality
        });

        // Format nationality options with flags
        function formatNationality(nationality) {
            if (!nationality.id) {
                return nationality.text;
            }

            // Map nationality values to their corresponding flag codes
            const flagMap = {
                'ALGERIAN': 'dz',
                'AMERICAN': 'us',
                'ARGENTINA': 'ar',
                'AUSTRALIAN': 'au',
                'BAHRAINI': 'bh',
                'BANGLADESHI': 'bd',
                'BELGIAN': 'be',
                'BRAZILIAN': 'br',
                'BRITISH': 'gb',
                'BULGARIAN': 'bg',
                'CAMEROONIAN': 'cm',
                'CANADIAN': 'ca',
                'CHILEAN': 'cl',
                'CHINESE': 'cn',
                'COLOMBIAN': 'co',
                'CROATIAN': 'hr',
                'CUBAN': 'cu',
                'CYPRIOT': 'cy',
                'CZECH': 'cz',
                'DANISH': 'dk',
                'DJIBOUTIAN': 'dj',
                'EGYPTIAN': 'eg',
                'FILIPINO': 'ph',
                'FRENCH': 'fr',
                'GERMAN': 'de',
                'GHANAIAN': 'gh',
                'GREEK': 'gr',
                'DUTCH': 'nl',
                'HONG_KONGER': 'hk',
                'INDIAN': 'in',
                'INDONESIAN': 'id',
                'IRANIAN': 'ir',
                'IRAQI': 'iq',
                'IRISH': 'ie',
                'ITALIAN': 'it',
                'JAMAICAN': 'jm',
                'JAPANESE': 'jp',
                'JORDANIAN': 'jo',
                'KENYAN': 'ke',
                'KUWAITI': 'kw',
                'LEBANESE': 'lb',
                'MALAWIAN': 'mw',
                'MALAYSIAN': 'my',
                'MEXICAN': 'mx',
                'MOROCCAN': 'ma',
                'NEPALI': 'np',
                'NEW_ZEALANDER': 'nz',
                'NIGERIAN': 'ng',
                'NORWEGIAN': 'no',
                'OMANI': 'om',
                'PAKISTANI': 'pk',
                'POLISH': 'pl',
                'PORTUGUESE': 'pt',
                'RUSSIAN': 'ru',
                'SAUDI': 'sa',
                'SCOTTISH': 'gb-sct',
                'SERBIAN': 'rs',
                'SEYCHELLOIS': 'sc',
                'SINGAPOREAN': 'sg',
                'SOUTH_AFRICAN': 'za',
                'SPANISH': 'es',
                'SRI_LANKAN': 'lk',
                'SUDANESE': 'sd',
                'SWEDISH': 'se',
                'SWISS': 'ch',
                'SYRIAN': 'sy',
                'TAIWANESE': 'tw',
                'TANZANIAN': 'tz',
                'THAI': 'th',
                'TUNISIAN': 'tn',
                'TURKISH': 'tr',
                'EMIRATI': 'ae',
                'UGANDAN': 'ug',
                'UKRAINIAN': 'ua',
                'VENEZUELAN': 've',
                'VIETNAMESE': 'vn',
                'YEMENI': 'ye',
                'ZIMBABWEAN': 'zw'
            };

            const flagCode = flagMap[nationality.id] || 'unknown';
            return $('<span><span class="flag-icon flag-icon-' + flagCode + '"></span> ' + nationality.text + '</span>');
        }
    });
</script>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\employee_list.html
```{% extends "employees/base.html" %}
{% load static %}

{% block title %}Employee List{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/select/1.3.4/css/select.bootstrap5.min.css" rel="stylesheet">
<style>
    .container-fluid {
        padding: 1rem;
    }
    .selected {
        background-color: #e2e6ea !important;
    }
    .table tbody tr {
        cursor: pointer;
    }
    .card {
        border-radius: 0;
        border: none;
    }
    .card-body {
        padding: 0;
    }
    .table-responsive {
        margin: 0;
    }
    .header-section {
        padding: 1rem;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .table thead th {
        background-color: #f8f9fa;
        border-top: none;
    }
    .table td, .table th {
        padding: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="header-section">
    <div class="row align-items-center">
        <div class="col">
            <h2 class="m-0">Employee List</h2>
        </div>
        <div class="col-auto">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="includeInactive">
                <label class="form-check-label" for="includeInactive">
                    Include Inactive Employees
                </label>
            </div>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <button id="exportExcel" class="btn btn-success">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button id="bulkActions" class="btn btn-secondary dropdown-toggle ms-2" data-bs-toggle="dropdown" disabled>
                    <i class="fas fa-cog"></i> Bulk Actions
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item bulk-status" data-status="active" href="#"><i class="fas fa-check-circle text-success"></i> Set Active</a></li>
                    <li><a class="dropdown-item bulk-status" data-status="inactive" href="#"><i class="fas fa-times-circle text-danger"></i> Set Inactive</a></li>
                </ul>
                <a href="{% url 'employees:employee_create' %}" class="btn btn-primary ms-2">
                    <i class="fas fa-plus"></i> Add Employee
                </a>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table id="employeeTable" class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="form-check-input" id="selectAll">
                        </th>
                        <th>Employee #</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>CPR Number</th>
                        <th>PassNo</th>
                        <th>Division</th>
                        <th>Department</th>
                        <th>Designation</th>
                        <th>Joined Date</th>
                        <th>Re-joined Date</th>
                        <th>Status</th>
                        <th>CreatedOn</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in employees %}
                    <tr data-employee-id="{{ employee.id }}">
                        <td>
                            <input type="checkbox" class="form-check-input row-checkbox">
                        </td>
                        <td>{{ employee.employee_number }}</td>
                        <td>{{ employee.first_name }}</td>
                        <td>{{ employee.last_name }}</td>
                        <td>{{ employee.cpr_number|default:'-' }}</td>
                        <td>{{ employee.passport_number|default:'-' }}</td>
                        <td>{{ employee.division.name|default:'-' }}</td>
                        <td>{{ employee.department.name|default:'-' }}</td>
                        <td>{{ employee.designation|default:'-' }}</td>
                        <td>{{ employee.joined_date|date:"d/m/Y"|default:'-' }}</td>
                        <td>{{ employee.rejoined_date|date:"d/m/Y"|default:'-' }}</td>
                        <td>
                            {% if employee.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>{{ employee.created_at|date:"d/m/Y"|default:'-' }}</td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'employees:employee_detail' employee.id %}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'employees:employee_update' employee.id %}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/select/1.3.4/js/dataTables.select.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize the checkbox state from localStorage
    var showInactive = localStorage.getItem('showInactiveEmployees') === 'true';
    $('#includeInactive').prop('checked', showInactive);

    // Custom filter for active/inactive employees
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        var showInactive = $('#includeInactive').is(':checked');
        var status = data[11]; // Status column index (adjusted for checkbox column)
        
        if (!showInactive && status.includes('Inactive')) {
            return false;
        }
        return true;
    });

    var table = $('#employeeTable').DataTable({
        dom: 'Bfrtip',
        select: false,
        buttons: [
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel"></i> Export Selected',
                exportOptions: {
                    columns: ':not(:last-child)',
                    rows: function(idx, data, node) {
                        return $(node).find('.row-checkbox').prop('checked');
                    }
                }
            }
        ],
        order: [[1, 'asc']],
        pageLength: 25,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]]
    });

    // Apply initial filter
    table.draw();

    // Handle inactive employee toggle
    $('#includeInactive').change(function() {
        var showInactive = $(this).is(':checked');
        // Save state to localStorage
        localStorage.setItem('showInactiveEmployees', showInactive);
        table.draw();
    });

    // Handle "Select All" checkbox
    $('#selectAll').change(function() {
        var isChecked = $(this).prop('checked');
        $('.row-checkbox').prop('checked', isChecked);
        updateSelectedState();
    });

    // Handle individual row checkboxes
    $(document).on('change', '.row-checkbox', function() {
        updateSelectedState();
    });

    // Update selected state and bulk actions button
    function updateSelectedState() {
        var selectedCount = $('.row-checkbox:checked').length;
        var totalCount = $('.row-checkbox').length;
        
        // Update "Select All" checkbox
        $('#selectAll').prop('checked', selectedCount === totalCount && totalCount > 0);
        
        // Enable/disable bulk actions button
        $('#bulkActions').prop('disabled', selectedCount === 0);
        
        // Update row highlighting
        $('.row-checkbox').each(function() {
            $(this).closest('tr').toggleClass('selected', $(this).prop('checked'));
        });
    }

    // Handle bulk status change
    $('.bulk-status').click(function(e) {
        e.preventDefault();
        var status = $(this).data('status');
        var selectedIds = [];
        
        $('.row-checkbox:checked').each(function() {
            var employeeId = $(this).closest('tr').data('employee-id');
            if (employeeId) {
                selectedIds.push(employeeId);
            }
        });

        if (selectedIds.length === 0) {
            alert('Please select at least one employee');
            return;
        }

        if (confirm('Are you sure you want to change the status of ' + selectedIds.length + ' selected employee(s)?')) {
            var formData = new FormData();
            selectedIds.forEach(function(id) {
                formData.append('employee_ids[]', id);
            });
            formData.append('status', status);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            $.ajax({
                url: '{% url "employees:bulk_status_change" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + response.error);
                    }
                },
                error: function() {
                    alert('An error occurred while updating employee status.');
                }
            });
        }
    });

    // Export to Excel button
    $('#exportExcel').click(function() {
        table.button('.buttons-excel').trigger();
    });
});
</script>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\preview\_employee_attendance_tab.html
```<!-- Attendance information will be here -->

```

### 📄 hrms_project\employees\templates\employees\preview\_employee_bank_tab.html
```{% load static %}
<div class="tab-pane fade" id="bank" role="tabpanel">
    <div class="info-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-university me-2"></i>Bank Accounts</h5>
            <a href="{% url 'employees:add_bank_account' employee.pk %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> Add Bank Account
            </a>
        </div>
        <div class="card-body">
            {% if employee.bank_accounts.exists %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Bank</th>
                                <th>Account Number</th>
                                <th>IBAN</th>
                                <th>Transfer Amount</th>
                                <th>Primary</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account in employee.bank_accounts.all %}
                            <tr>
                                <td>{{ account.bank }}</td>
                                <td>{{ account.account_number }}</td>
                                <td>{{ account.iban }}</td>
                                <td>{{ account.transfer_amount|default:"-" }}</td>
                                <td>
                                    {% if account.is_primary %}
                                        <span class="status-badge status-active">Primary</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{% url 'employees:edit_bank_account' employee.pk account.pk %}" class="btn btn-sm btn-info">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'employees:delete_bank_account' employee.pk account.pk %}" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-muted">No bank accounts added yet.</p>
            {% endif %}
        </div>
    </div>
</div>
```

### 📄 hrms_project\employees\templates\employees\preview\_employee_bond_tab.html
```<!-- Bond & Guarantee information will be here -->

```

### 📄 hrms_project\employees\templates\employees\preview\_employee_checklist_tab.html
```<!-- Checklist information will be here -->

```

### 📄 hrms_project\employees\templates\employees\preview\_employee_delete_modal.html
```<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete {{ employee.get_full_name }}?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{% url 'employees:employee_delete' employee.pk %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
```

### 📄 hrms_project\employees\templates\employees\preview\_employee_documents_tab.html
```{% load static %}
<div class="tab-pane fade" id="documents" role="tabpanel">
    <div class="info-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-file-alt me-2"></i>Documents</h5>
            <a href="{% url 'employees:add_document' employee.id %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> Add Document
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Document Type</th>
                            <th>File</th>
                            <th>Upload Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if employee.documents.all %}
                            {% for document in employee.documents.all %}
                                <tr>
                                    <td>{{ document.get_document_type_display }}</td>
                                    <td>
                                        {% if document.document_file %}
                                            {% if document.is_image %}
                                                <img src="{{ document.document_file.url }}" alt="Document" style="height: 50px;">
                                            {% else %}
                                                <a href="{{ document.document_file.url }}" target="_blank">
                                                    <i class="fas fa-file"></i> View Document
                                                </a>
                                            {% endif %}
                                        {% else %}
                                            No file attached
                                        {% endif %}
                                    </td>
                                    <td>{{ document.created_at|date:"d/m/Y" }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{% url 'employees:view_document' employee.id document.id %}"
                                               class="btn btn-sm btn-info" title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'employees:edit_document' employee.id document.id %}"
                                               class="btn btn-sm btn-warning" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'employees:delete_document' employee.id document.id %}"
                                               class="btn btn-sm btn-danger" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No documents found.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
```

### 📄 hrms_project\employees\templates\employees\preview\_employee_education_tab.html
```<!-- Education information will be here -->

```

### 📄 hrms_project\employees\templates\employees\preview\_employee_events_tab.html
```<!-- Life Events information will be here -->

```

### 📄 hrms_project\employees\templates\employees\preview\_employee_general_tab.html
```{% load static %}
<div class="tab-pane fade show active" id="general" role="tabpanel">
    <div class="info-card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Employee Information</h5>
            <div class="status-badge {% if employee.is_active %}status-active{% else %}status-inactive{% endif %}">
                {{ employee.is_active|yesno:"Active,Inactive" }}
            </div>
        </div>
        <div class="card-body">
            <!-- Basic Information -->
            <div class="info-section mb-4">
                <div class="section-title">Basic Information</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="info-item">
                            <label>Employee Number</label>
                            <div class="value">{{ employee.employee_number }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <label>Profile Picture</label>
                            <div class="value">
                                {% if employee.profile_picture %}
                                    <img src="{{ employee.profile_picture.url }}" alt="Profile Picture" class="img-thumbnail" style="max-width: 150px;">
                                {% else %}
                                    <span class="text-muted">No profile picture</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Information (English) -->
            <div class="info-section mb-4">
                <div class="section-title">Personal Information (English)</div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>First Name</label>
                            <div class="value">{{ employee.first_name }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Middle Name</label>
                            <div class="value">{{ employee.middle_name|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Last Name</label>
                            <div class="value">{{ employee.last_name }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Information (Arabic) -->
            <div class="info-section mb-4">
                <div class="section-title">Personal Information (Arabic)</div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>First Name (Arabic)</label>
                            <div class="value">{{ employee.first_name_ar|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Middle Name (Arabic)</label>
                            <div class="value">{{ employee.middle_name_ar|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Last Name (Arabic)</label>
                            <div class="value">{{ employee.last_name_ar|default:"-" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Demographics -->
            <div class="info-section mb-4">
                <div class="section-title">Demographics</div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Date of Birth</label>
                            <div class="value">{{ employee.date_of_birth|date:"d/m/Y"|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Gender</label>
                            <div class="value">{{ employee.get_gender_display|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Marital Status</label>
                            <div class="value">{{ employee.get_marital_status_display|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Nationality</label>
                            <div class="value">{{ employee.get_nationality_display|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Religion</label>
                            <div class="value">{{ employee.religion|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Education Category</label>
                            <div class="value">{{ employee.education_category|default:"-" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact & Identification -->
            <div class="info-section mb-4">
                <div class="section-title">Contact & Identification</div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item">
                            <label>Email:</label>
                            <span>{{ employee.email|default:'-' }}</span>
                        </div>
                        <div class="info-item">
                            <label>Primary Number:</label>
                            <span>{{ employee.primary_phone|default:'-' }}</span>
                        </div>
                        <div class="info-item">
                            <label>Secondary Number:</label>
                            <span>{{ employee.secondary_phone|default:'-' }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <label>CPR Number:</label>
                            <span>{{ employee.cpr_number|default:'-' }}</span>
                        </div>
                        <div class="info-item">
                            <label>Address:</label>
                            <span>{{ employee.address|default:'-' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Employment Information</h5>

            <!-- Employment Information -->
            <div class="info-section mb-4">
                <div class="section-title">Position Details</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="info-item">
                            <label>Designation</label>
                            <div class="value">{{ employee.designation|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <label>Employee Category</label>
                            <div class="value">{{ employee.get_employee_category_display|default:"-" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Department & Location -->
            <div class="info-section mb-4">
                <div class="section-title">Department & Location</div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Division</label>
                            <div class="value">{{ employee.division|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Department</label>
                            <div class="value">{{ employee.department|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Location</label>
                            <div class="value">{{ employee.location|default:"-" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contract Information -->
            <div class="info-section mb-4">
                <div class="section-title">Contract Information</div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Contract Type</label>
                            <div class="value">{{ employee.get_contract_type_display|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Joined Date</label>
                            <div class="value">{{ employee.joined_date|date:"d/m/Y"|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-item">
                            <label>Probation Status</label>
                            <div class="value">{{ employee.in_probation|yesno:"Yes,No" }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Centers -->
            <div class="info-section">
                <div class="section-title">Financial Centers</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="info-item">
                            <label>Cost Center</label>
                            <div class="value">{{ employee.cost_center|default:"-" }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <label>Profit Center</label>
                            <div class="value">{{ employee.profit_center|default:"-" }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

### 📄 hrms_project\employees\templates\employees\preview\_employee_offences_tab.html
```{% load static %}

<link rel="stylesheet" href="{% static 'employees/css/offences.css' %}">

<!-- Add this style to fix z-index issues -->
<style>
    .select2-container--open {
        z-index: 9999 !important; /* Increased z-index and !important */
    }

    .select2-dropdown {
        z-index: 9999 !important; /* Increased z-index and !important for dropdown itself */
    }
</style>

<!-- Offences information will be here -->
<div class="tab-pane fade" id="offences" role="tabpanel">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Employee Offences</h5>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOffenceModal">
                <i class="fas fa-plus"></i> Add Offence
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="offencesTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Rule</th>
                            <th>Penalty</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for offence in employee.employee_offence_records.all %}
                        <tr data-offence-id="{{ offence.id }}" class="{% if not offence.is_active %}table-secondary{% endif %}">
                            <td>{{ offence.offense_date|date:"d/m/Y" }}</td>
                            <td>{{ offence.rule.name }}</td>
                            <td>
                                {{ offence.get_applied_penalty_display }}
                                {% if offence.monetary_amount %}
                                <br>
                                <small class="text-muted">
                                    Amount: {{ offence.monetary_amount }} BHD
                                    {% if offence.is_active %}
                                    (Remaining: {{ offence.remaining_amount }} BHD)
                                    {% endif %}
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                {% if offence.is_active %}
                                    {% if offence.is_acknowledged %}
                                    <span class="badge bg-success">Acknowledged</span>
                                    {% else %}
                                    <span class="badge bg-warning">Pending</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-info view-offence" data-offence-id="{{ offence.id }}" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if offence.is_active %}
                                <button type="button" class="btn btn-sm btn-primary add-document" data-offence-id="{{ offence.id }}" title="Add Document">
                                    <i class="fas fa-file-upload"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No offences found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Offence Modal -->
    <div class="modal fade" id="addOffenceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Offence</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="alerts-container"></div>
                    <form id="addOffenceForm">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <div class="col-12 mb-3">
                                <label class="form-label">Search Offense Rule</label>
                                <select class="form-select" id="offenseSearch" style="width: 100%">
                                    <option value="">Search for offense rule...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Offense Group</label>
                                <select class="form-select" id="offenceGroup" name="group" required>
                                    <option value="">Select Group</option>
                                    {% for group, label in offense_groups %}
                                    <option value="{{ group }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Offense Rule</label>
                                <select class="form-select" id="offenceRule" name="rule" required>
                                    <option value="">Select Rule</option>
                                </select>
                            </div>
                            <div class="col-12" id="ruleDescription" style="display: none;">
                                <div class="alert alert-info">
                                    <strong>Description:</strong>
                                    <span id="ruleDescriptionText"></span>
                                </div>
                            </div>
                            <div class="col-12" id="previousOffenses" style="display: none;">
                                <div class="alert alert-warning">
                                    <strong>Offense History for <span id="offenseYear">2025</span>:</strong>
                                    <div id="previousOffensesList" class="mt-2"></div>
                                    <div class="mt-2">
                                        <strong>Suggested Penalty:</strong>
                                        <span id="suggestedPenalty" class="text-danger"></span>
                                        <small class="d-block text-muted mt-1">
                                            This will be offense #<span id="offenseCount">0</span> for this rule this year.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Offense Date</label>
                                <input type="date" class="form-control" id="offenseDate" name="offense_date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Applied Penalty</label>
                                <select class="form-select" id="appliedPenalty" name="applied_penalty" required>
                                    <option value="">Select Penalty</option>
                                    {% for code, label in penalty_choices %}
                                    <option value="{{ code }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted" id="penaltyNote" style="display: none;">
                                    This penalty differs from the suggested penalty based on the offense count.
                                </small>
                            </div>
                        </div>
                        <div id="monetaryPenaltySection" class="mb-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Monetary Penalty Amount</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="monetaryAmount" name="monetary_amount" step="0.01" min="0">
                                        <span class="input-group-text">BHD</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Monthly Deduction Amount</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="monthlyDeduction" name="monthly_deduction" step="0.01" min="0">
                                        <span class="input-group-text">BHD</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Details</label>
                            <textarea class="form-control" name="details" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveOffenceBtn">Save Offence</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Offence Modal -->
        <div class="modal fade" id="viewOffenceModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Offense Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <strong>Rule ID:</strong>
                            <span id="viewRuleId"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Rule Name:</strong>
                            <span id="viewRuleName"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Group:</strong>
                            <span id="viewGroup"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Description:</strong>
                            <span id="viewDescription"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Date:</strong>
                            <span id="viewDate"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Original Penalty:</strong>
                            <span id="viewOriginalPenalty"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Applied Penalty:</strong>
                            <span id="viewAppliedPenalty"></span>
                        </div>
                        <div class="mb-3">
                            <strong>Status:</strong>
                            <span id="viewStatus"></span>
                        </div>
                        <div class="mb-3" id="viewPreviousOffenses" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Offense History:</strong>
                                <div id="viewPreviousOffensesList"></div>
                            </div>
                        </div>
                        <div class="mb-3" id="viewDocuments">
                            <strong>Documents:</strong>
                            <div id="viewDocumentsList"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-danger" id="cancelOffenceBtn">Cancel Offense</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Add Document Modal -->
    <div class="modal fade" id="addDocumentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addDocumentForm">
                        {% csrf_token %}
                        <input type="hidden" name="offense_id" id="documentOffenseId">
                        <div class="mb-3">
                            <label class="form-label">Document Type</label>
                            <input type="text" class="form-control" name="document_type" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Document</label>
                            <input type="file" class="form-control" name="document" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" name="notes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveDocumentBtn">Save Document</button>
                </div>
            </div>
        </div>
    </div>
</div>

```

### 📄 hrms_project\employees\templates\employees\preview\_employee_salary_tab.html
```<div class="tab-pane fade" id="salary" role="tabpanel">
    <div class="card info-card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Current Salary Details</h5>
            {% if perms.employees.add_salarydetail %}
            <a href="{% url 'employees:add_salary' employee.id %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i>Add New
            </a>
            {% endif %}
        </div>
        <div class="card-body">
            {% if employee.salary_details.exists %}
                {% with current_salary=employee.salary_details.filter.first %}
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item mb-3">
                            <label>Basic Salary</label>
                            <div class="value">{{ current_salary.basic_salary }} {{ current_salary.currency }}</div>
                        </div>
                        <div class="info-item mb-3">
                            <label>Housing Allowance</label>
                            <div class="value">{{ current_salary.housing_allowance }} {{ current_salary.currency }}</div>
                        </div>
                        <div class="info-item mb-3">
                            <label>Transportation Allowance</label>
                            <div class="value">{{ current_salary.transportation_allowance }} {{ current_salary.currency }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        {% if current_salary.other_allowances %}
                        <div class="info-item mb-3">
                            <label>Other Allowances</label>
                            <div class="value">
                                {% for name, amount in current_salary.other_allowances.items %}
                                <div>{{ name }}: {{ amount }} {{ current_salary.currency }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <div class="info-item mb-3">
                            <label>Total Salary</label>
                            <div class="value fw-bold text-primary">{{ current_salary.total_salary }} {{ current_salary.currency }}</div>
                        </div>
                        <div class="info-item mb-3">
                            <label>Effective From</label>
                            <div class="value">{{ current_salary.effective_from|date:"d M Y" }}</div>
                        </div>
                    </div>
                </div>
                {% if current_salary.notes %}
                <div class="mt-3">
                    <label class="text-muted">Notes:</label>
                    <p class="mb-0">{{ current_salary.notes }}</p>
                </div>
                {% endif %}
                {% endwith %}
            {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                    <p class="mb-0">No salary details available.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Salary History -->
    <div class="card info-card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Salary Revision History</h5>
        </div>
        <div class="card-body">
            {% if employee.salary_revisions.exists %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Previous</th>
                            <th>New</th>
                            <th>Change</th>
                            <th>Reference</th>
                            {% if perms.employees.view_salaryrevision %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for revision in employee.salary_revisions.all %}
                        <tr>
                            <td>{{ revision.revision_date|date:"d M Y" }}</td>
                            <td>{{ revision.get_revision_type_display }}</td>
                            <td>{{ revision.previous_salary.total_salary }} {{ revision.previous_salary.currency }}</td>
                            <td>{{ revision.new_salary.total_salary }} {{ revision.new_salary.currency }}</td>
                            <td>
                                <span class="{% if revision.difference > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ revision.difference|floatformat:3 }} ({{ revision.percentage_change|floatformat:1 }}%)
                                </span>
                            </td>
                            <td>{{ revision.reference_number|default:"-" }}</td>
                            {% if perms.employees.view_salaryrevision %}
                            <td>
                                <button class="btn btn-sm btn-outline-primary" title="View Details"
                                    data-bs-toggle="modal" data-bs-target="#revisionModal{{ revision.id }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-history fa-2x mb-2"></i>
                <p class="mb-0">No salary revisions found.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Certificates -->
    <div class="card info-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Salary Certificates</h5>
            {% if perms.employees.add_salarycertificate %}
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newCertificateModal">
                <i class="fas fa-plus me-1"></i>Request New
            </button>
            {% endif %}
        </div>
        <div class="card-body">
            {% if employee.salary_certificates.exists %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Certificate No.</th>
                            <th>Issued Date</th>
                            <th>Purpose</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cert in employee.salary_certificates.all %}
                        <tr>
                            <td>{{ cert.certificate_number }}</td>
                            <td>{{ cert.issued_date|date:"d M Y" }}</td>
                            <td>{{ cert.purpose }}</td>
                            <td>
                                <span class="badge {% if cert.is_valid %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ cert.is_valid|yesno:"Valid,Invalid" }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    {% if perms.employees.change_salarycertificate %}
                                    <button class="btn btn-sm btn-outline-secondary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-certificate fa-2x mb-2"></i>
                <p class="mb-0">No certificates issued yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- New Certificate Modal -->
<div class="modal fade" id="newCertificateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Salary Certificate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newCertificateForm" method="post" action="{% url 'employees:request_certificate' employee.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label class="form-label">Purpose *</label>
                        <input type="text" name="purpose" class="form-control" required
                               placeholder="e.g., Bank Loan, Visa Application">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Expiry Date</label>
                        <input type="date" name="expiry_date" class="form-control">
                        <small class="form-text text-muted">Optional. Leave blank if certificate should not expire.</small>
                    </div>
                    
                    <!-- Current Salary Information (Read-only) -->
                    {% if employee.salary_details.exists %}
                    {% with current_salary=employee.salary_details.first %}
                    <div class="alert alert-info mb-0">
                        <h6 class="alert-heading mb-2">Current Salary Information</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <small class="d-block text-muted">Basic Salary:</small>
                                <strong>{{ current_salary.basic_salary }} {{ current_salary.currency }}</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="d-block text-muted">Total Allowances:</small>
                                <strong>{{ current_salary.housing_allowance|add:current_salary.transportation_allowance }} {{ current_salary.currency }}</strong>
                            </div>
                            <div class="col-md-4">
                                <small class="d-block text-muted">Total Salary:</small>
                                <strong>{{ current_salary.total_salary }} {{ current_salary.currency }}</strong>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No active salary details found. Please add salary details before requesting a certificate.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Request</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Revision Detail Modals -->
{% for revision in employee.salary_revisions.all %}
<div class="modal fade" id="revisionModal{{ revision.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Salary Revision Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-3">Previous Salary</h6>
                        <div class="info-item mb-2">
                            <label>Basic Salary</label>
                            <div class="value">{{ revision.previous_salary.basic_salary }}</div>
                        </div>
                        <div class="info-item mb-2">
                            <label>Total Allowances</label>
                            <div class="value">
                                {{ revision.previous_salary.housing_allowance|add:revision.previous_salary.transportation_allowance }}
                            </div>
                        </div>
                        <div class="info-item mb-2">
                            <label>Total Salary</label>
                            <div class="value">{{ revision.previous_salary.total_salary }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="mb-3">New Salary</h6>
                        <div class="info-item mb-2">
                            <label>Basic Salary</label>
                            <div class="value">{{ revision.new_salary.basic_salary }}</div>
                        <div class="info-item mb-2">
                            <label>Total Allowances</label>
                            <div class="value">
                                {{ revision.new_salary.housing_allowance|add:revision.new_salary.transportation_allowance }}
                            </div>
                        </div>
                        <div class="info-item mb-2">
                            <label>Total Salary</label>
                            <div class="value">{{ revision.new_salary.total_salary }}</div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="info-item mb-2">
                    <label>Reason for Revision</label>
                    <div class="value">{{ revision.reason }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-item mb-2">
                            <label>Approved By</label>
                            <div class="value">{{ revision.approved_by.get_full_name }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item mb-2">
                            <label>Reference Number</label>
                            <div class="value">{{ revision.reference_number|default:"-" }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

```

### 📄 hrms_project\employees\templates\employees\preview\assets_in_hand\_employee_assets_tab.html
```{% load static %}

{% block content %}
<div class="tab-pane fade" id="assets" role="tabpanel">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ employee.get_full_name }}'s Assets</h3>
            <div class="card-tools">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addAssetTypeModal">
                        <i class="fas fa-plus-circle"></i> Add Asset Type
                    </button>
                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#manageAssetTypesModal">
                        <i class="fas fa-cog"></i> Manage Types
                    </button>
                </div>
                <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addAssetsModal">
                    <i class="fas fa-plus"></i> Add Assets
                </button>
                <button type="button" class="btn btn-warning" id="bulkReturnBtn" style="display: none;">
                    <i class="fas fa-undo"></i> Return Selected
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="assetsTable">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" class="form-check-input">
                            </th>
                            <th>Asset Type</th>
                            <th>Asset Name</th>
                            <th>Asset Number</th>
                            <th>Issue Date</th>
                            <th>Return Date</th>
                            <th>Condition</th>
                            <th>Value</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in employee.assets.all %}
                        <tr data-asset-id="{{ asset.id }}">
                            <td>
                                <input type="checkbox" class="form-check-input asset-select" {% if asset.return_date %}disabled{% endif %}>
                            </td>
                            <td>{{ asset.asset_type.name }}</td>
                            <td>{{ asset.asset_name }}</td>
                            <td>{{ asset.asset_number }}</td>
                            <td>{{ asset.issue_date|date:"Y-m-d" }}</td>
                            <td>{{ asset.return_date|date:"Y-m-d"|default:"-" }}</td>
                            <td>{{ asset.condition }}</td>
                            <td>{{ asset.value }}</td>
                            <td>
                                <span class="badge {% if asset.return_date %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if asset.return_date %}Returned{% else %}In Hand{% endif %}
                                </span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-info view-asset" data-asset-id="{{ asset.id }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if not asset.return_date %}
                                <button type="button" class="btn btn-sm btn-success return-asset" data-asset-id="{{ asset.id }}">
                                    <i class="fas fa-undo"></i>
                                </button>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-danger delete-asset" data-asset-id="{{ asset.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center">No assets found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- View Asset Details Modal -->
<div class="modal fade" id="viewAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asset Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Asset Type:</strong></div>
                    <div class="col-sm-8" id="viewAssetType"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Asset Name:</strong></div>
                    <div class="col-sm-8" id="viewAssetName"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Asset Number:</strong></div>
                    <div class="col-sm-8" id="viewAssetNumber"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Issue Date:</strong></div>
                    <div class="col-sm-8" id="viewIssueDate"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Condition:</strong></div>
                    <div class="col-sm-8" id="viewCondition"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Value:</strong></div>
                    <div class="col-sm-8" id="viewValue"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Notes:</strong></div>
                    <div class="col-sm-8" id="viewNotes"></div>
                </div>
                <div id="returnDetailsSection" style="display: none;">
                    <hr>
                    <h6 class="mb-3">Return Details</h6>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Return Date:</strong></div>
                        <div class="col-sm-8" id="viewReturnDate"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Return Condition:</strong></div>
                        <div class="col-sm-8" id="viewReturnCondition"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4"><strong>Return Notes:</strong></div>
                        <div class="col-sm-8" id="viewReturnNotes"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Add Assets Modal -->
<div class="modal fade" id="addAssetsModal" tabindex="-1" aria-labelledby="addAssetsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAssetsModalLabel">Add Assets</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAssetsForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Asset Types</label>
                                <select class="form-select" name="asset_type" multiple size="5" required>
                                    {% for type in asset_types %}
                                    <option value="{{ type.id }}">{{ type.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple types</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Starting Asset Number</label>
                                <input type="text" class="form-control" name="asset_number" required>
                                <small class="text-muted">Numbers will be auto-incremented (e.g., LAP001, LAP002)</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Quantity per Type</label>
                                <input type="number" class="form-control" name="quantity" min="1" value="1" required>
                                <small class="text-muted">This quantity will be applied to each selected type</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Issue Date</label>
                                <input type="date" class="form-control" name="issue_date" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Condition</label>
                                <textarea class="form-control" name="condition" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Value</label>
                                <input type="number" step="0.01" class="form-control" name="value" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAssetsBtn">Save Assets</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Asset Type Modal -->
<div class="modal fade" id="addAssetTypeModal" tabindex="-1" aria-labelledby="addAssetTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAssetTypeModalLabel">Add New Asset Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAssetTypeForm">
                    <div class="mb-3">
                        <label class="form-label">Type Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAssetTypeBtn">Save Type</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Asset Types Modal -->
<div class="modal fade" id="manageAssetTypesModal" tabindex="-1" aria-labelledby="manageAssetTypesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageAssetTypesModalLabel">Manage Asset Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="assetTypesTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for type in asset_types %}
                            <tr data-type-id="{{ type.id }}">
                                <td>{{ type.name }}</td>
                                <td>{{ type.description|default:"-" }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-danger delete-type" data-type-id="{{ type.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- View/Edit Asset Modal -->
<div class="modal fade" id="viewAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asset Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Asset details will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Return Asset Modal -->
<div class="modal fade" id="returnAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Return Asset(s)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="returnAssetForm">
                    <input type="hidden" name="asset_ids" id="returnAssetIds">
                    <div class="mb-3">
                        <label for="returnDate" class="form-label">Return Date</label>
                        <input type="date" class="form-control" id="returnDate" name="return_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="returnCondition" class="form-label">Return Condition</label>
                        <select class="form-select" id="returnCondition" name="return_condition" required>
                            <option value="">Select condition...</option>
                            <option value="Excellent">Excellent</option>
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                            <option value="Damaged">Damaged</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="returnNotes" class="form-label">Return Notes</label>
                        <textarea class="form-control" id="returnNotes" name="return_notes" rows="3" 
                            placeholder="Add any notes about the condition or return of the asset(s)"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmReturnAsset">Return Asset(s)</button>
            </div>
        </div>
    </div>
</div>





{% endblock %}

{% block extra_js %}
<script src="{% static 'employees/js/assets.js' %}"></script>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\preview\bank\bank_account_confirm_delete.html
```{% extends "employees/base.html" %}

{% block title %}Delete Bank Account - {{ employee.get_full_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2>Delete Bank Account - {{ employee.get_full_name }}</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <p>Are you sure you want to delete the following bank account?</p>
                    <ul class="list-unstyled">
                        <li><strong>Bank:</strong> {{ bank_account.bank }}</li>
                        <li><strong>Account Number:</strong> {{ bank_account.account_number }}</li>
                        <li><strong>IBAN:</strong> {{ bank_account.iban }}</li>
                        <li><strong>Transfer Amount:</strong> {{ bank_account.transfer_amount }}</li>
                        {% if bank_account.is_primary %}
                            <li><strong>Primary Account:</strong> Yes</li>
                        {% endif %}
                    </ul>
                    <form method="post">
                        {% csrf_token %}
                        <div class="mt-3">
                            <a href="{% url 'employees:employee_detail' employee.pk %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-danger">Delete Bank Account</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\preview\bank\bank_account_form.html
```{% extends "employees/base.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} - {{ employee.get_full_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ title }} - {{ employee.get_full_name }}</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {{ form|crispy }}
                        <div class="mt-3">
                            <a href="{% url 'employees:employee_detail' employee.pk %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Bank Account</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\preview\dependents\_employee_dependents_tab.html
```<!-- Dependents Tab Content -->
<div class="tab-pane fade" id="dependents" role="tabpanel">
    <div class="info-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-users me-2"></i>Dependents</h5>
            <a href="{% url 'employees:add_dependent' employee.id %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i> Add Dependent
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="dependentsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Relation</th>
                            <th>Date of Birth</th>
                            <th>Passport Number</th>
                            <th>Passport Expiry</th>
                            <th>CPR Number</th>
                            <th>CPR Expiry</th>
                            <th>Valid Passage</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dependent in employee.dependents.all %}
                        <tr>
                            <td>{{ dependent.name }}</td>
                            <td>{{ dependent.get_relation_display }}</td>
                            <td>{{ dependent.date_of_birth|date:"Y-m-d" }}</td>
                            <td>{{ dependent.passport_number|default:"-" }}</td>
                            <td>{{ dependent.passport_expiry|date:"Y-m-d"|default:"-" }}</td>
                            <td>{{ dependent.cpr_number|default:"-" }}</td>
                            <td>{{ dependent.cpr_expiry|date:"Y-m-d"|default:"-" }}</td>
                            <td>{% if dependent.valid_passage %}Yes{% else %}No{% endif %}</td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'employees:dependent_documents' employee.id dependent.id %}" class="btn btn-info btn-sm">
                                        <i class="fas fa-file"></i>
                                    </a>
                                    <a href="{% url 'employees:edit_dependent' employee.id dependent.id %}" class="btn btn-warning btn-sm">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteDependent({{ dependent.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">No dependents found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Document Modal -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div id="documentModalContent"></div>
    </div>
</div>

{% block extra_js %}
<script>
let currentDependentId = null;

// Function to generate document filename
function generateDocumentFilename() {
    const employeeNumber = "{{ employee.employee_number }}";
    const fullName = "{{ employee.get_full_name }}".replace(/\s+/g, '_');
    const documentType = document.getElementById('id_document_type').options[document.getElementById('id_document_type').selectedIndex].text;
    const documentNumber = document.getElementById('id_document_number').value;
    
    return `${employeeNumber}_${fullName}_${documentType}_${documentNumber}.pdf`;
}

function deleteDependent(dependentId) {
    if (confirm('Are you sure you want to delete this dependent?')) {
        $.post(`{% url 'employees:delete_dependent' employee.id 0 %}`.replace('0', dependentId), {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(response) {
            if (response.status === 'success') {
                location.reload();
                showToast('Success', response.message, 'success');
            } else {
                showToast('Error', response.message, 'error');
            }
        });
    }
}
</script>
{% endblock %}
```

### 📄 hrms_project\employees\templates\employees\preview\dependents\dependent_document_form.html
```{% extends "employees/base.html" %}

{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<style>
    .method-button {
        padding: 10px 20px;
        margin: 5px;
        border: 1px solid #ddd;
        cursor: pointer;
    }
    .method-button.active {
        background-color: #007bff;
        color: white;
    }
    .upload-content, .scan-content, .scan-preview {
        margin-top: 20px;
    }
    .preview-images {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    .preview-image-container {
        position: relative;
        max-width: 150px;
    }
    .preview-image-container img {
        width: 100%;
        height: auto;
        cursor: pointer;
    }
    .page-number {
        position: absolute;
        top: 5px;
        left: 5px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 5px;
        font-size: 12px;
    }
    .document-field {
        display: none;
    }
    .document-field.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{% if document %}Edit{% else %}Add{% endif %} Document for {{ dependent.name }}</h3>
                    <div class="card-tools">
                        <a href="{% url 'employees:dependent_documents' employee.id dependent.id %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to Documents
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="documentForm">
                        {% csrf_token %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="document_type">Document Type</label>
                                    <select class="form-control" id="document_type" name="document_type" required onchange="toggleDocumentFields()">
                                        <option value="">Select Document Type</option>
                                        <option value="PASSPORT">Passport</option>
                                        <option value="CPR">CPR</option>
                                        <option value="BIRTH_CERTIFICATE">Birth Certificate</option>
                                        <option value="MARRIAGE_CERTIFICATE">Marriage Certificate</option>
                                        <option value="OTHER">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="name">Document Name</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="document_number">Document Number</label>
                                    <input type="text" class="form-control" id="document_number" name="document_number">
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic fields based on document type -->
                        <div class="row mb-3">
                            <!-- Issue Date - for Passport -->
                            <div class="col-md-6 document-field" data-document-types="PASSPORT">
                                <div class="form-group">
                                    <label for="issue_date">Issue Date</label>
                                    <input type="date" class="form-control" id="issue_date" name="issue_date">
                                </div>
                            </div>

                            <!-- Expiry Date - for Passport and CPR -->
                            <div class="col-md-6 document-field" data-document-types="PASSPORT,CPR">
                                <div class="form-group">
                                    <label for="expiry_date">Expiry Date</label>
                                    <input type="date" class="form-control" id="expiry_date" name="expiry_date">
                                </div>
                            </div>

                            <!-- Nationality - for Passport and CPR -->
                            <div class="col-md-6 document-field" data-document-types="PASSPORT,CPR">
                                <div class="form-group">
                                    <label for="nationality">Nationality</label>
                                    <select class="form-control" id="nationality" name="nationality">
                                        <option value="">Select Nationality</option>
                                        {% for code, name in nationality_choices %}
                                            <option value="{{ code }}">{{ name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Method Selection -->
                        <div class="btn-group mb-4" role="group" aria-label="Document upload method">
                            <button type="button" class="btn btn-outline-primary method-button active" onclick="selectMethod('upload')">
                                <i class="fas fa-upload"></i> Upload File
                            </button>
                            <button type="button" class="btn btn-outline-primary method-button" onclick="selectMethod('scan')">
                                <i class="fas fa-scanner"></i> Scan Document
                            </button>
                        </div>

                        <!-- Upload Content -->
                        <div class="upload-content">
                            <div class="form-group">
                                <label for="document_file">Upload Document</label>
                                <input type="file" class="form-control-file" id="document_file" name="document_file" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        </div>

                        <!-- Scan Content -->
                        <div class="scan-content" style="display: none;">
                            <div class="form-group">
                                <label>Scan Mode</label>
                                <div class="form-check">
                                    <input type="radio" id="singleSide" name="scanMode" value="single" class="form-check-input" checked>
                                    <label class="form-check-label" for="singleSide">Single Side</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" id="doubleSide" name="scanMode" value="double" class="form-check-input">
                                    <label class="form-check-label" for="doubleSide">Double Side</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" id="feeder" name="scanMode" value="feeder" class="form-check-input">
                                    <label class="form-check-label" for="feeder">Document Feeder</label>
                                </div>
                            </div>
                            
                            <div id="scanInstructions" class="alert alert-info mb-3">
                                Place your document on the scanner and click 'Start Scanning'
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="startScanning()">
                                Start Scanning <span class="spinner" style="display: none;"><i class="fas fa-spinner fa-spin"></i></span>
                            </button>
                        </div>

                        <!-- Scan Preview -->
                        <div class="scan-preview" style="display: none;">
                            <h4 class="mt-4">Preview</h4>
                            <div class="preview-images"></div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Document
                            </button>
                            <a href="{% url 'employees:dependent_documents' employee.id dependent.id %}" class="btn btn-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div id="imageModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" class="img-fluid" src="" alt="Preview">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{% static 'employees/utilities/scanning.js' %}"></script>
<script>
    function toggleDocumentFields() {
        const documentType = document.getElementById('document_type').value;
        const fields = document.querySelectorAll('.document-field');
        
        fields.forEach(field => {
            const documentTypes = field.getAttribute('data-document-types').split(',');
            if (documentTypes.includes(documentType)) {
                field.classList.add('show');
                const inputs = field.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (documentType === 'PASSPORT') {
                        input.required = true;
                    } else if (documentType === 'CPR') {
                        input.required = documentType === 'CPR' && input.name === 'expiry_date';
                    } else {
                        input.required = false;
                    }
                });
            } else {
                field.classList.remove('show');
                const inputs = field.querySelectorAll('input, select');
                inputs.forEach(input => input.required = false);
            }
        });
    }

    // Handle upload/scan method selection
    function selectMethod(method) {
        // Update buttons
        document.querySelectorAll('.method-button').forEach(btn => {
            btn.classList.remove('active');
        });
        const selectedBtn = document.querySelector(`.method-button[onclick="selectMethod('${method}')"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('active');
        }
        
        // Show/hide content
        const uploadContent = document.querySelector('.upload-content');
        const scanContent = document.querySelector('.scan-content');
        
        if (method === 'upload') {
            uploadContent.style.display = 'block';
            scanContent.style.display = 'none';
        } else {
            uploadContent.style.display = 'none';
            scanContent.style.display = 'block';
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        selectMethod('upload');
        toggleDocumentFields();
        
        // Set scan endpoint and CSRF token for scanning.js
        window.scanEndpoint = '{% url "employees:scan_dependent_document" employee.id dependent.id %}';
        window.csrfToken = '{{ csrf_token }}';
        
        // Check if we're on Windows
        fetch('{% url "employees:system_info" %}')
            .then(response => response.json())
            .then(data => {
                const isWindows = data.platform === 'Windows';
                if (!isWindows) {
                    const scanButton = document.querySelector('[onclick="selectMethod(\'scan\')"]');
                    if (scanButton) {
                        scanButton.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error checking system:', error);
            });
    });

    // Handle image preview modal
    document.addEventListener('click', function(e) {
        if (e.target.matches('.preview-image-container img')) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const originalSrc = e.target.getAttribute('data-original') || e.target.src;
            
            modalImg.src = originalSrc;
            new bootstrap.Modal(modal).show();
        }
    });

    // Handle form submission
    document.getElementById('documentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': window.csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = '{% url "employees:dependent_documents" employee.id dependent.id %}';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the document');
        });
    });
</script>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\preview\dependents\dependent_documents_list.html
```{% extends "employees/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{ dependent.name }}'s Documents</h3>
                    <div class="card-tools">
                        <a href="{% url 'employees:employee_detail' employee.id %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to Employee
                        </a>
                        <a href="{% url 'employees:add_dependent_document' employee.id dependent.id %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> Add Document
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="documentsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Number</th>
                                    <th>Issue Date</th>
                                    <th>Expiry Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for document in documents %}
                                <tr>
                                    <td>{{ document.name }}</td>
                                    <td>{{ document.get_document_type_display }}</td>
                                    <td>{{ document.document_number|default:'-' }}</td>
                                    <td>{{ document.issue_date|date:"Y-m-d" }}</td>
                                    <td>{{ document.expiry_date|date:"Y-m-d"|default:'-' }}</td>
                                    <td>{{ document.status }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{% url 'employees:view_dependent_document' employee.id dependent.id document.id %}" 
                                               class="btn btn-info btn-sm" target="_blank">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'employees:edit_dependent_document' employee.id dependent.id document.id %}" 
                                               class="btn btn-warning btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-danger btn-sm" 
                                                    onclick="deleteDocument({{ document.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No documents found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function deleteDocument(documentId) {
    if (confirm('Are you sure you want to delete this document?')) {
        $.post(`{% url 'employees:delete_dependent_document' employee.id dependent.id 0 %}`.replace('0', documentId), {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(response) {
            if (response.status === 'success') {
                location.reload();
                showToast('Success', response.message, 'success');
            } else {
                showToast('Error', response.message, 'error');
            }
        });
    }
}
</script>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\preview\dependents\dependent_form.html
```{% extends "employees/base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{% if dependent %}Edit{% else %}Add{% endif %} Dependent</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="dependentForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-8 offset-md-2">
                                {{ form|crispy }}
                                <div class="mt-3">
                                    <a href="{% url 'employees:employee_detail' employee.id %}" class="btn btn-secondary">Cancel</a>
                                    <button type="submit" class="btn btn-primary">{% if dependent %}Update{% else %}Add{% endif %} Dependent</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#dependentForm').on('submit', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = "{% if dependent %}{% url 'employees:edit_dependent' employee.id dependent.id %}{% else %}{% url 'employees:add_dependent' employee.id %}{% endif %}";
        
        $.ajax({
            url: url,
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.status === 'success') {
                    // Show success message
                    showToast('Success', response.message, 'success');
                    // Redirect back to employee detail page
                    window.location.href = "{% url 'employees:employee_detail' employee.id %}";
                } else {
                    // Show error message
                    showFormErrors(form, response.errors);
                }
            },
            error: function(xhr, errmsg, err) {
                showToast('Error', 'An error occurred while processing your request.', 'error');
            }
        });
    });
});
</script>
{% endblock %}
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\preview\dependents\scanning_js.html
```<script>
const { jsPDF } = window.jspdf;
let isWindows = false;

// Get system information when page loads
fetch('/employees/system-info/')
    .then(response => response.json())
    .then(data => {
        isWindows = data.platform === 'Windows';
        if (!isWindows) {
            document.querySelector('[onclick="selectMethod(\'scan\')"]').style.display = 'none';
        }
    });

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    selectMethod('upload');
    updateScanInstructions();
});

function selectMethod(method) {
    // Update buttons
    document.querySelectorAll('.method-button').forEach(btn => {
        btn.classList.remove('active');
    });
    const selectedBtn = method === 'upload' ? 
        document.querySelector('.method-button:first-child') :
        document.querySelector('.method-button:last-child');
    selectedBtn.classList.add('active');
    
    // Show/hide content
    const uploadContent = document.querySelector('.upload-content');
    const scanContent = document.querySelector('.scan-content');
    const scanPreview = document.querySelector('.scan-preview');
    
    if (method === 'upload') {
        uploadContent.style.display = 'block';
        scanContent.style.display = 'none';
        scanPreview.style.display = 'none';
    } else if (method === 'scan' && isWindows) {
        uploadContent.style.display = 'none';
        scanContent.style.display = 'block';
    }
}

let currentSide = 'front';
let frontImage = null;
let backImage = null;

function updateScanInstructions() {
    const mode = document.querySelector('input[name="scanMode"]:checked').value;
    const instructions = document.getElementById('twoSideInstructions');
    
    if (mode === 'double') {
        instructions.classList.add('active');
        instructions.querySelector('p').innerHTML = `
            <span class="scan-side-indicator">${currentSide === 'front' ? 'Front' : 'Back'} Side:</span> 
            Place the document with the ${currentSide} side facing down on the scanner.
        `;
    } else {
        instructions.classList.remove('active');
    }
}

// Add event listeners for scan mode changes
document.querySelectorAll('input[name="scanMode"]').forEach(radio => {
    radio.addEventListener('change', () => {
        currentSide = 'front';
        frontImage = null;
        backImage = null;
        updateScanInstructions();
        
        // Clear previews when changing modes
        const previewImages = document.querySelector('.preview-images');
        if (previewImages) {
            previewImages.innerHTML = '';
        }
    });
});

// Function to create thumbnail from image data
function createThumbnail(imageData, maxWidth = 150, maxHeight = 150) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Calculate new dimensions
            if (width > height) {
                if (width > maxWidth) {
                    height = Math.round(height * maxWidth / width);
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width = Math.round(width * maxHeight / height);
                    height = maxHeight;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            resolve(canvas.toDataURL('image/jpeg', 0.7));
        };
        img.src = imageData;
    });
}

async function startScanning() {
    if (!isWindows) {
        alert('Scanner functionality is only available on Windows systems.');
        return;
    }

    const scanBtn = document.querySelector('.scan-content button');
    const spinner = document.querySelector('.scan-content .spinner');  
    const previewContainer = document.querySelector('.scan-preview');
    const previewImages = document.querySelector('.preview-images');
    const scanMode = document.querySelector('input[name="scanMode"]:checked').value;
    
    try {
        // Show loading state
        scanBtn.disabled = true;
        if (spinner) {  
            spinner.style.display = 'inline-block';
        }
        
        // Clear previews if starting fresh scan
        if (scanMode !== 'double' || currentSide === 'front') {
            previewImages.innerHTML = '';
        }
        
        // Call our scanning endpoint
        const response = await fetch('{% url "employees:scan_document" employee.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                useFeeder: scanMode === 'feeder',
                currentSide: currentSide
            })
        });
        
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to scan document');
        }
        
        const data = await response.json();
        
        if (scanMode === 'double') {
            // Handle two-sided scanning
            if (currentSide === 'front') {
                frontImage = data.images[0];
                
                // Create thumbnail
                const thumbnailData = await createThumbnail(frontImage.data);
                
                // Show front preview
                const previewContainer = document.createElement('div');
                previewContainer.className = 'preview-image-container';
                
                const pageNumber = document.createElement('div');
                pageNumber.className = 'page-number';
                pageNumber.textContent = 'Front Side';
                previewContainer.appendChild(pageNumber);
                
                const img = document.createElement('img');
                img.src = thumbnailData;
                img.alt = 'Front Side';
                img.setAttribute('data-original', frontImage.data);
                previewContainer.appendChild(img);
                
                previewImages.appendChild(previewContainer);
                
                // Update instructions for back side
                currentSide = 'back';
                updateScanInstructions();
                
                // Update button text and add spinner
                scanBtn.innerHTML = 'Scan Back Side <span class="spinner"><i class="fas fa-spinner fa-spin"></i></span>';
                
            } else {
                backImage = data.images[0];
                
                // Create thumbnail
                const thumbnailData = await createThumbnail(backImage.data);
                
                // Show back preview
                const previewContainer = document.createElement('div');
                previewContainer.className = 'preview-image-container';
                
                const pageNumber = document.createElement('div');
                pageNumber.className = 'page-number';
                pageNumber.textContent = 'Back Side';
                previewContainer.appendChild(pageNumber);
                
                const img = document.createElement('img');
                img.src = thumbnailData;
                img.alt = 'Back Side';
                img.setAttribute('data-original', backImage.data);
                previewContainer.appendChild(img);
                
                previewImages.appendChild(previewContainer);
                
                try {
                    // Create PDF with both sides
                    const doc = new jsPDF();
                    
                    // Add front side
                    doc.addImage(frontImage.data, 'JPEG', 0, 0, 210, 297);
                    
                    // Add back side
                    doc.addPage();
                    doc.addImage(backImage.data, 'JPEG', 0, 0, 210, 297);
                    
                    // Convert to blob and create file
                    const pdfBlob = doc.output('blob');
                    const file = new File([pdfBlob], "scanned_document.pdf", { type: "application/pdf" });
                    
                    // Update file input
                    const fileInput = document.querySelector('input[type="file"]');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    // Reset for next scan
                    currentSide = 'front';
                    scanBtn.innerHTML = 'Start Scanning <span class="spinner"><i class="fas fa-spinner fa-spin"></i></span>';
                    updateScanInstructions();
                } catch (pdfError) {
                    console.error('PDF Creation Error:', pdfError);
                    throw new Error('Failed to create PDF: ' + pdfError.message);
                }
            }
            
        } else {
            // Handle single-side or feeder scanning
            try {
                const doc = new jsPDF();
                let firstPage = true;
                
                for (const image of data.images) {
                    if (!firstPage) {
                        doc.addPage();
                    }
                    doc.addImage(image.data, 'JPEG', 0, 0, 210, 297);
                    firstPage = false;
                    
                    // Create thumbnail
                    const thumbnailData = await createThumbnail(image.data);
                    
                    // Add preview
                    const container = document.createElement('div');
                    container.className = 'preview-image-container';
                    
                    const pageNumber = document.createElement('div');
                    pageNumber.className = 'page-number';
                    pageNumber.textContent = 'Page ' + (data.images.indexOf(image) + 1);
                    container.appendChild(pageNumber);
                    
                    const img = document.createElement('img');
                    img.src = thumbnailData;
                    img.alt = 'Page ' + (data.images.indexOf(image) + 1);
                    img.setAttribute('data-original', image.data);
                    container.appendChild(img);
                    
                    previewImages.appendChild(container);
                }
                
                // Create file from PDF
                const pdfBlob = doc.output('blob');
                const file = new File([pdfBlob], "scanned_document.pdf", { type: "application/pdf" });
                
                // Update file input
                const fileInput = document.querySelector('input[type="file"]');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
            } catch (pdfError) {
                console.error('PDF Creation Error:', pdfError);
                throw new Error('Failed to create PDF: ' + pdfError.message);
            }
        }
        
        // Show preview section
        previewContainer.style.display = 'block';
        
    } catch (error) {
        alert('Error while scanning: ' + error.message);
        console.error(error);
    } finally {
        // Reset loading state
        scanBtn.disabled = false;
        if (spinner) {  
            spinner.style.display = 'none';
        }
    }
}

// Form submission handling
$('#documentForm').on('submit', function(e) {
    e.preventDefault();
    var form = $(this);
    var formData = new FormData(this);
    
    $.ajax({
        url: form.attr('action'),
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.status === 'success') {
                showToast('Success', response.message, 'success');
                window.location.href = "{% url 'employees:dependent_documents' employee.id dependent.id %}";
            } else {
                showToast('Error', 'Please correct the errors below.', 'error');
                // Display form errors
                for (var field in response.errors) {
                    var errorField = $('#id_' + field);
                    errorField.addClass('is-invalid');
                    errorField.siblings('.invalid-feedback').remove();
                    errorField.after('<div class="invalid-feedback">' + response.errors[field].join(', ') + '</div>');
                }
            }
        },
        error: function() {
            showToast('Error', 'An error occurred while saving the document.', 'error');
        }
    });
});

// Image modal functionality
document.querySelectorAll('.preview-image-container img').forEach(img => {
    img.onclick = function() {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        modal.style.display = 'block';
        modalImg.src = this.getAttribute('data-original') || this.src;
    }
});

document.querySelector('.close-modal').onclick = function() {
    document.getElementById('imageModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('imageModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}
</script>

```

### 📄 hrms_project\employees\templates\employees\preview\document\document_confirm_delete.html
```{% extends "employees/base.html" %}

{% block title %}Delete Document - {{ employee.get_full_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2>Delete Document - {{ employee.get_full_name }}</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <p>Are you sure you want to delete the following document?</p>
                    <ul class="list-unstyled">
                        <li><strong>Document Type:</strong> {{ document.get_document_type_display }}</li>
                        <li><strong>Document Number:</strong> {{ document.document_number }}</li>
                        <li><strong>Issue Date:</strong> {{ document.issue_date|date:"d/m/Y" }}</li>
                        <li><strong>Expiry Date:</strong> {{ document.expiry_date|date:"d/m/Y" }}</li>
                    </ul>
                    <form method="post">
                        {% csrf_token %}
                        <div class="mt-3">
                            <a href="{% url 'employees:employee_detail' employee.pk %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-danger">Delete Document</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\preview\document\document_form.html
```{% extends "employees/base.html" %}

{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<style>
    .method-button {
        padding: 10px 20px;
        margin: 5px;
        border: 1px solid #ddd;
        cursor: pointer;
    }
    .method-button.active {
        background-color: #007bff;
        color: white;
    }
    .upload-content, .scan-content, .scan-preview {
        margin-top: 20px;
    }
    .preview-images {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }
    .preview-image-container {
        position: relative;
        max-width: 150px;
    }
    .preview-image-container img {
        width: 100%;
        height: auto;
        cursor: pointer;
    }
    .page-number {
        position: absolute;
        top: 5px;
        left: 5px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 5px;
        font-size: 12px;
    }
    #twoSideInstructions {
        display: none;
        padding: 10px;
        margin: 10px 0;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
    }
    #twoSideInstructions.active {
        display: block;
    }
    .scan-side-indicator {
        font-weight: bold;
        color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{% if document %}Edit{% else %}Add{% endif %} Document for {{ employee.name }}</h3>
                    <div class="card-tools">
                        <a href="{% url 'employees:employee_detail' employee.id %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Back to Employee
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="documentForm">
                        {% csrf_token %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.document_type|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.document_number|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.profession_title|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.issue_place|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                {{ form.issue_date|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.expiry_date|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                {{ form.other_info|as_crispy_field }}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">Document Upload Method</label>
                                <div class="d-flex">
                                    <button type="button" class="method-button active" onclick="selectMethod('upload')">
                                        <i class="fas fa-upload"></i> Upload File
                                    </button>
                                    <button type="button" class="method-button" onclick="selectMethod('scan')">
                                        <i class="fas fa-scanner"></i> Scan Document
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="upload-content">
                            {{ form.document_file|as_crispy_field }}
                        </div>

                        <div class="scan-content" style="display: none;">
                            <div class="form-group">
                                <label>Scan Mode</label>
                                <div class="form-check">
                                    <input type="radio" id="singleSide" name="scanMode" value="single" class="form-check-input" checked>
                                    <label class="form-check-label" for="singleSide">Single Side</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" id="doubleSide" name="scanMode" value="double" class="form-check-input">
                                    <label class="form-check-label" for="doubleSide">Double Side</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" id="feeder" name="scanMode" value="feeder" class="form-check-input">
                                    <label class="form-check-label" for="feeder">Document Feeder</label>
                                </div>
                            </div>

                            <div id="twoSideInstructions" class="alert alert-info">
                                <p></p>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="startScanning()">
                                Start Scanning <span class="spinner" style="display: none;"><i class="fas fa-spinner fa-spin"></i></span>
                            </button>
                        </div>

                        <div class="scan-preview" style="display: none;">
                            <h5>Scanned Pages</h5>
                            <div class="preview-images"></div>
                        </div>

                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Document
                            </button>
                            <a href="{% url 'employees:employee_detail' employee.id %}" class="btn btn-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div id="imageModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img id="modalImage" class="img-fluid" src="" alt="Preview">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{% static 'employees/utilities/scanning.js' %}"></script>
<script>
    // Handle upload/scan method selection
    function selectMethod(method) {
        // Update buttons
        document.querySelectorAll('.method-button').forEach(btn => {
            btn.classList.remove('active');
        });
        const selectedBtn = document.querySelector(`.method-button[onclick*="${method}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('active');
        }

        // Show/hide content sections
        const uploadContent = document.querySelector('.upload-content');
        const scanContent = document.querySelector('.scan-content');
        const scanPreview = document.querySelector('.scan-preview');

        if (method === 'upload') {
            uploadContent.style.display = 'block';
            scanContent.style.display = 'none';
            scanPreview.style.display = 'none';
        } else {
            uploadContent.style.display = 'none';
            scanContent.style.display = 'block';
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        selectMethod('upload');
        
        // Set scan endpoint for the scanning.js
        window.scanEndpoint = '{% url "employees:scan_document" employee.id %}';
        
        // Check if we're on Windows
        fetch('{% url "employees:system_info" %}')
            .then(response => response.json())
            .then(data => {
                const isWindows = data.platform === 'Windows';
                if (!isWindows) {
                    const scanButton = document.querySelector('[onclick="selectMethod(\'scan\')"]');
                    if (scanButton) {
                        scanButton.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error checking system:', error);
            });
    });

    // Handle image preview modal
    document.addEventListener('click', function(e) {
        if (e.target.matches('.preview-image-container img')) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const originalSrc = e.target.getAttribute('data-original') || e.target.src;
            
            modalImg.src = originalSrc;
            new bootstrap.Modal(modal).show();
        }
    });
</script>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\preview\document\document_view.html
```{% extends "employees/base.html" %}

{% block title %}View Document - {{ employee.get_full_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2>View Document - {{ employee.get_full_name }}</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Document Type:</strong> {{ document.get_document_type_display }}</p>
                            <p><strong>Document Number:</strong> {{ document.document_number }}</p>
                            <p><strong>Profession/Title:</strong> {{ document.profession_title|default:"-" }}</p>
                            <p><strong>Issue Date:</strong> {{ document.issue_date|date:"d/m/Y" }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Issue Place:</strong> {{ document.issue_place }}</p>
                            <p><strong>Expiry Date:</strong> {{ document.expiry_date|date:"d/m/Y" }}</p>
                            <p><strong>Status:</strong> 
                                {% if document.is_expired %}
                                    <span class="badge bg-danger">Expired</span>
                                {% else %}
                                    <span class="badge bg-success">Valid</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    {% if document.other_info %}
                    <div class="row mb-4">
                        <div class="col">
                            <h5>Additional Information</h5>
                            <p>{{ document.other_info|linebreaks }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col">
                            <h5>Document File</h5>
                            {% if document.is_image %}
                                <img src="{{ document.document_file.url }}" alt="Document" class="img-fluid">
                            {% else %}
                                <div class="d-grid gap-2">
                                    <a href="{{ document.document_file.url }}" class="btn btn-primary" target="_blank">
                                        <i class="fas fa-download"></i> Download Document
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mt-4">
                        <a href="{% url 'employees:employee_detail' employee.pk %}" class="btn btn-secondary">Back</a>
                        <a href="{% url 'employees:edit_document' employee.pk document.pk %}" class="btn btn-warning">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <a href="{% url 'employees:delete_document' employee.pk document.pk %}" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

```

### 📄 hrms_project\employees\templates\employees\revision_form.html
```{% extends "employees/base.html" %}
{% load static %}

{% block title %}Add Salary Revision - {{ employee.get_full_name }}{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="card info-card">
        <div class="card-header">
            <h5 class="mb-0">Add Salary Revision</h5>
        </div>
        <div class="card-body">
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Current Salary Information (Read-only) -->
                {% if employee.salary_details.exists %}
                {% with current_salary=employee.salary_details.first %}
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading mb-2">Current Salary Information</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <small class="d-block text-muted">Basic Salary:</small>
                            <strong>{{ current_salary.basic_salary }} {{ current_salary.currency }}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="d-block text-muted">Housing Allowance:</small>
                            <strong>{{ current_salary.housing_allowance }} {{ current_salary.currency }}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="d-block text-muted">Transportation:</small>
                            <strong>{{ current_salary.transportation_allowance }} {{ current_salary.currency }}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="d-block text-muted">Total Salary:</small>
                            <strong>{{ current_salary.total_salary }} {{ current_salary.currency }}</strong>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Effective since: {{ current_salary.effective_from|date:"d M Y" }}</small>
                    </div>
                </div>
                {% endwith %}
                {% else %}
                <div class="alert alert-warning mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No active salary details found. Please add salary details before creating a revision.
                </div>
                {% endif %}

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.revision_type.id_for_label }}" class="form-label">Revision Type *</label>
                            {{ form.revision_type }}
                            {% if form.revision_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.revision_type.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.revision_date.id_for_label }}" class="form-label">Effective Date *</label>
                            {{ form.revision_date }}
                            {% if form.revision_date.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.revision_date.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="{{ form.reason.id_for_label }}" class="form-label">Reason for Revision *</label>
                    {{ form.reason }}
                    {% if form.reason.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.reason.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div class="form-group mb-4">
                    <label for="{{ form.reference_number.id_for_label }}" class="form-label">Reference Number</label>
                    {{ form.reference_number }}
                    {% if form.reference_number.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.reference_number.errors.0 }}
                    </div>
                    {% endif %}
                    <small class="form-text text-muted">Optional. Enter any reference number or document ID related to this revision.</small>
                </div>

                <div class="d-flex justify-content-end">
                    <a href="{% url 'employees:employee_detail' employee.id %}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary" {% if not employee.salary_details.exists %}disabled{% endif %}>
                        Save Revision
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize form validation
    (function() {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();
</script>
{% endblock %}
```

### 📄 hrms_project\employees\templates\employees\salary_form.html
```{% extends "employees/base.html" %}
{% load static %}

{% block title %}{{ is_edit|yesno:"Edit,Add" }} Salary Details - {{ employee.get_full_name }}{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="card info-card">
        <div class="card-header">
            <h5 class="mb-0">{{ is_edit|yesno:"Edit,Add" }} Salary Details</h5>
        </div>
        <div class="card-body">
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.basic_salary.id_for_label }}" class="form-label">Basic Salary *</label>
                            {{ form.basic_salary }}
                            {% if form.basic_salary.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.basic_salary.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.currency.id_for_label }}" class="form-label">Currency *</label>
                            {{ form.currency }}
                            {% if form.currency.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.currency.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.housing_allowance.id_for_label }}" class="form-label">Housing Allowance</label>
                            {{ form.housing_allowance }}
                            {% if form.housing_allowance.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.housing_allowance.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.transportation_allowance.id_for_label }}" class="form-label">Transportation Allowance</label>
                            {{ form.transportation_allowance }}
                            {% if form.transportation_allowance.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.transportation_allowance.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.effective_from.id_for_label }}" class="form-label">Effective From *</label>
                            {{ form.effective_from }}
                            {% if form.effective_from.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.effective_from.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.other_allowances.id_for_label }}" class="form-label">Other Allowances (JSON)</label>
                            {{ form.other_allowances }}
                            <small class="form-text text-muted">Format: {"allowance_name": amount}</small>
                            {% if form.other_allowances.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.other_allowances.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.notes.errors.0 }}
                    </div>
                    {% endif %}
                </div>

                <div class="d-flex justify-content-end">
                    <a href="{% url 'employees:employee_detail' employee.id %}" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize form validation
    (function() {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();
</script>
{% endblock %}
```

### 📄 hrms_project\employees\urls.py
```from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views, api_views

app_name = 'employees'

# Create a router for API views
router = DefaultRouter()
router.register(r'asset-types', api_views.AssetTypeViewSet, basename='asset-type')
router.register(r'employee-assets', api_views.EmployeeAssetViewSet, basename='employee-asset')
router.register(r'offense-rules', api_views.OffenseRuleViewSet, basename='offense-rule')
router.register(r'employee-offenses', api_views.EmployeeOffenseViewSet, basename='employee-offense')

urlpatterns = [
    # Include API URLs under /api/ namespace
    path('api/', include(router.urls)),

    # Class-based views
    path('', views.EmployeeListView.as_view(), name='employee_list'),
    path('<int:pk>/', views.EmployeeDetailView.as_view(), name='employee_detail'),
    path('create/', views.EmployeeCreateView.as_view(), name='employee_create'),
    path('<int:pk>/update/', views.EmployeeUpdateView.as_view(), name='employee_update'),
    path('<int:pk>/delete/', views.EmployeeDeleteView.as_view(), name='employee_delete'),

    # Bank Account Management
    path('<int:employee_id>/bank-accounts/add/', views.add_bank_account, name='add_bank_account'),
    path('<int:employee_id>/bank-accounts/<int:account_id>/edit/', views.edit_bank_account, name='edit_bank_account'),
    path('<int:employee_id>/bank-accounts/<int:account_id>/delete/', views.delete_bank_account, name='delete_bank_account'),

    # Employee Assets
    path('<int:employee_id>/assets/add/', api_views.add_employee_asset, name='add_employee_asset'),
    path('<int:employee_id>/assets/<int:asset_id>/', api_views.get_employee_asset, name='get_employee_asset'),
    path('<int:employee_id>/assets/<int:asset_id>/edit/', api_views.edit_employee_asset, name='edit_employee_asset'),
    path('<int:employee_id>/assets/<int:asset_id>/return/', api_views.return_employee_asset, name='return_employee_asset'),
    path('<int:employee_id>/assets/<int:asset_id>/delete/', api_views.delete_employee_asset, name='delete_employee_asset'),

    # Document Management
    path('<int:employee_id>/documents/', views.employee_documents, name='employee_documents'),
    path('<int:employee_id>/documents/add/', views.add_document, name='add_document'),
    path('<int:employee_id>/documents/<int:document_id>/edit/', views.edit_document, name='edit_document'),
    path('<int:employee_id>/documents/<int:document_id>/delete/', views.delete_document, name='delete_document'),
    path('<int:employee_id>/documents/<int:document_id>/view/', views.view_document, name='view_document'),

    # Salary Management
    path('<int:employee_id>/salary/add/', views.add_salary, name='add_salary'),
    path('salary/<int:salary_id>/edit/', views.edit_salary, name='edit_salary'),
    path('<int:employee_id>/salary/revision/add/', views.add_salary_revision, name='add_salary_revision'),
    path('<int:employee_id>/salary/certificate/request/', views.request_certificate, name='request_certificate'),

    # Scanner functionality
    path('scan-document/', views.scan_document, name='scan_document_universal'),  # Universal scanner endpoint
    path('<int:employee_id>/scan-document/', views.scan_document, name='scan_document'),  # For backward compatibility
    path('<int:employee_id>/dependents/<int:dependent_id>/scan-document/', views.scan_document, name='scan_dependent_document'),  # For dependent documents

    # Dependent Management
    path('<int:employee_id>/dependents/add/', views.add_dependent, name='add_dependent'),
    path('<int:employee_id>/dependents/<int:dependent_id>/edit/', views.edit_dependent, name='edit_dependent'),
    path('<int:employee_id>/dependents/<int:dependent_id>/delete/', views.delete_dependent, name='delete_dependent'),
    path('<int:employee_id>/dependents/<int:dependent_id>/documents/', views.dependent_documents, name='dependent_documents'),
    path('<int:employee_id>/dependents/<int:dependent_id>/documents/list/', views.get_dependent_documents, name='get_dependent_documents'),
    path('<int:employee_id>/dependents/<int:dependent_id>/documents/add/', views.add_dependent_document, name='add_dependent_document'),
    path('<int:employee_id>/dependents/<int:dependent_id>/documents/<int:document_id>/edit/', views.edit_dependent_document, name='edit_dependent_document'),
    path('<int:employee_id>/dependents/<int:dependent_id>/documents/<int:document_id>/delete/', views.delete_dependent_document, name='delete_dependent_document'),
    path('<int:employee_id>/dependents/<int:dependent_id>/documents/<int:document_id>/view/', views.view_dependent_document, name='view_dependent_document'),

    # Offence Management URLs
    path('api/offenses/', api_views.EmployeeOffenseViewSet.as_view({
        'get': 'list',
        'post': 'create'
    }), name='offense_list_create'),
    
    path('api/offenses/<int:pk>/', api_views.EmployeeOffenseViewSet.as_view({
        'get': 'retrieve',
        'put': 'update',
        'patch': 'partial_update',
        'delete': 'destroy'
    }), name='offense_detail'),

    # employee-specific offense URLs
    path('api/employees/<int:employee_id>/offenses/', api_views.employee_offenses, name='employee_offenses'),
    path('api/employees/<int:employee_id>/offenses/<int:offense_id>/', api_views.employee_offense_detail, name='employee_offense_detail'),
    # count offenses
    path('api/employee-offenses/<int:employee_id>/count/', api_views.get_employee_offense_count, name='get_employee_offense_count'),
    
    # Offense Actions
    path('api/offenses/<int:pk>/status/', api_views.update_offense_status, name='offense_status_update'),
    path('api/offenses/<int:pk>/payment/', api_views.record_offense_payment, name='offense_payment'),
    path('api/offenses/<int:pk>/print/', api_views.print_offense, name='offense_print'),
    
    # Employee-specific Offense URLs
    path('api/employees/<int:employee_id>/offenses/', api_views.employee_offenses, name='employee_offenses'),
    path('api/employees/<int:employee_id>/offenses/count/', api_views.get_employee_offense_count, name='employee_offense_count'),
    
    # Offense Rules
    path('api/offense-rules/', api_views.OffenseRuleViewSet.as_view({
        'get': 'list',
        'post': 'create'
    }), name='offense_rule_list'),
    
    path('api/offense-rules/<int:pk>/', api_views.OffenseRuleViewSet.as_view({
        'get': 'retrieve',
        'put': 'update',
        'patch': 'partial_update',
        'delete': 'destroy'
    }), name='offense_rule_detail'),

    # Bulk Status Change
    path('bulk-status-change/', views.bulk_status_change, name='bulk_status_change'),
    path('bulk-status-change/<str:status>/', views.bulk_status_change, name='bulk_status_change_with_status'),

    # System Info
    path('system-info/', views.system_info, name='system_info'),

    # Function-based views (alternative)
    # path('', views.employee_list, name='employee_list'),
    # path('<int:pk>/', views.employee_detail, name='employee_detail'),
    # path('create/', views.employee_create, name='employee_create'),
    # path('<int:pk>/update/', views.employee_update, name='employee_update'),
    # path('<int:pk>/delete/', views.employee_delete, name='employee_delete'),
]

```

### 📄 hrms_project\employees\views.py
```from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required, permission_required
from django.contrib import messages
from django.core.paginator import Paginator
from django.urls import reverse_lazy
from django.views.generic import ListView, DetailView, CreateView, UpdateView, DeleteView
from django.contrib.auth.mixins import LoginRequiredMixin, PermissionRequiredMixin
from django.db import transaction
from django.db.models import Q
from .models import (
    Employee, Department, Division, EmployeeBankAccount, EmployeeDocument,
    EmployeeDependent, DependentDocument, AssetType, OffenseRule , SalaryDetail, SalaryRevision, SalaryCertificate
)
from .forms import (
    EmployeeForm, EmployeeBankAccountForm, EmployeeDocumentForm,
    EmployeeDependentForm, DependentDocumentForm,  SalaryDetailForm, SalaryCertificateForm, SalaryRevisionForm
)
from django.http import JsonResponse, HttpResponse
from django.utils import timezone
import os
import tempfile
import base64
import io
from PIL import Image
import json
import platform
from django.views.decorators.csrf import csrf_exempt
from django.template.loader import render_to_string
import uuid
import time
from django.http import Http404

# Only import Windows-specific modules if on Windows
if platform.system() == 'Windows':
    try:
        import win32com.client
        import pythoncom
    except ImportError:
        pass

class EmployeeListView(LoginRequiredMixin, ListView):
    model = Employee
    template_name = 'employees/employee_list.html'
    context_object_name = 'employees'
    paginate_by = 10
    ordering = ['employee_number']

    def get_queryset(self):
        queryset = super().get_queryset()
        search_query = self.request.GET.get('search')
        department = self.request.GET.get('department')
        division = self.request.GET.get('division')
        status = self.request.GET.get('status')

        if search_query:
            queryset = queryset.filter(
                Q(employee_number__icontains=search_query) |
                Q(first_name__icontains=search_query) |
                Q(last_name__icontains=search_query) |
                Q(email__icontains=search_query)
            )
        
        if department:
            queryset = queryset.filter(department_id=department)
        
        if division:
            queryset = queryset.filter(division_id=division)
        
        if status:
            is_active = status == 'active'
            queryset = queryset.filter(is_active=is_active)

        return queryset.select_related('department', 'division', 'location', 'cost_center', 'profit_center')

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['departments'] = Department.objects.all()
        context['divisions'] = Division.objects.all()
        return context

class EmployeeDetailView(LoginRequiredMixin, DetailView):
    model = Employee
    template_name = 'employees/employee_detail.html'
    context_object_name = 'employee'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        employee = self.get_object()
        context.update({
            'dependents': employee.dependents.all(),
            'emergency_contacts': employee.emergency_contacts.all(),
            'documents': employee.documents.all(),
            'assets': employee.assets.all(),
            'education': employee.education.all(),
            'offences': employee.employee_offence_records.all(),
            'life_events': employee.life_events.all(),
            'bank_accounts': employee.bank_accounts.all(),
            'asset_types': AssetType.objects.all(),
            'offense_groups': OffenseRule.GROUP_CHOICES,
            'penalty_choices': OffenseRule.PENALTY_CHOICES
        })
        return context

class EmployeeCreateView(LoginRequiredMixin, PermissionRequiredMixin, CreateView):
    model = Employee
    form_class = EmployeeForm
    template_name = 'employees/employee_form.html'
    success_url = reverse_lazy('employees:employee_list')
    permission_required = 'employees.add_employee'

    def get_form_kwargs(self):
        kwargs = super().get_form_kwargs()
        kwargs['initial'] = {'employee_number': self.get_next_employee_number()}
        return kwargs

    @transaction.atomic
    def form_valid(self, form):
        response = super().form_valid(form)
        messages.success(self.request, 'Employee created successfully.')
        return response

    def get_next_employee_number(self):
        last_employee = Employee.objects.order_by('-employee_number').first()
        if not last_employee or not last_employee.employee_number.startswith('EMP'):
            return 'EMP0001'
        
        try:
            last_number = int(last_employee.employee_number[3:])
            return f'EMP{str(last_number + 1).zfill(4)}'
        except ValueError:
            return 'EMP0001'

class EmployeeUpdateView(LoginRequiredMixin, PermissionRequiredMixin, UpdateView):
    model = Employee
    form_class = EmployeeForm
    template_name = 'employees/employee_form.html'
    success_url = reverse_lazy('employees:employee_list')
    permission_required = 'employees.change_employee'

    @transaction.atomic
    def form_valid(self, form):
        response = super().form_valid(form)
        messages.success(self.request, 'Employee updated successfully.')
        return response

class EmployeeDeleteView(LoginRequiredMixin, PermissionRequiredMixin, DeleteView):
    model = Employee
    success_url = reverse_lazy('employees:employee_list')
    permission_required = 'employees.delete_employee'
    template_name = 'employees/employee_confirm_delete.html'

    @transaction.atomic
    def delete(self, request, *args, **kwargs):
        messages.success(request, 'Employee deleted successfully.')
        return super().delete(request, *args, **kwargs)

# Function-based views for those who prefer them
@login_required
def employee_list(request):
    employees = Employee.objects.all().select_related('department', 'division', 'location', 'cost_center', 'profit_center').order_by('employee_number')
    paginator = Paginator(employees, 10)
    page = request.GET.get('page')
    employees = paginator.get_page(page)
    return render(request, 'employees/employee_list.html', {'employees': employees})

@login_required
def employee_detail(request, pk):
    employee = get_object_or_404(Employee, pk=pk)
    return render(request, 'employees/employee_detail.html', {'employee': employee})

@login_required
@transaction.atomic
def employee_create(request):
    if request.method == 'POST':
        form = EmployeeForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, 'Employee created successfully.')
            return redirect('employees:employee_list')
    else:
        form = EmployeeForm()
    return render(request, 'employees/employee_form.html', {'form': form})

@login_required
@transaction.atomic
def employee_update(request, pk):
    employee = get_object_or_404(Employee, pk=pk)
    if request.method == 'POST':
        form = EmployeeForm(request.POST, instance=employee)
        if form.is_valid():
            form.save()
            messages.success(request, 'Employee updated successfully.')
            return redirect('employees:employee_list')
    else:
        form = EmployeeForm(instance=employee)
    return render(request, 'employees/employee_form.html', {'form': form})

@login_required
@transaction.atomic
def employee_delete(request, pk):
    employee = get_object_or_404(Employee, pk=pk)
    if request.method == 'POST':
        employee.delete()
        messages.success(request, 'Employee deleted successfully.')
        return redirect('employees:employee_list')
    return render(request, 'employees/employee_confirm_delete.html', {'employee': employee})

@login_required
@transaction.atomic
def add_bank_account(request, employee_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    if request.method == 'POST':
        form = EmployeeBankAccountForm(request.POST)
        if form.is_valid():
            bank_account = form.save(commit=False)
            bank_account.employee = employee
            bank_account.save()
            messages.success(request, 'Bank account added successfully.')
            return redirect('employees:employee_detail', pk=employee_id)
    else:
        form = EmployeeBankAccountForm()
    
    return render(request, 'employees/preview/bank/bank_account_form.html', {
        'form': form,
        'employee': employee,
        'title': 'Add Bank Account'
    })

@login_required
@transaction.atomic
def edit_bank_account(request, employee_id, account_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    bank_account = get_object_or_404(EmployeeBankAccount, pk=account_id, employee=employee)
    
    if request.method == 'POST':
        form = EmployeeBankAccountForm(request.POST, instance=bank_account)
        if form.is_valid():
            form.save()
            messages.success(request, 'Bank account updated successfully.')
            return redirect('employees:employee_detail', pk=employee_id)
    else:
        form = EmployeeBankAccountForm(instance=bank_account)
    
    return render(request, 'employees/preview/bank/bank_account_form.html', {
        'form': form,
        'employee': employee,
        'bank_account': bank_account,
        'title': 'Edit Bank Account'
    })

@login_required
@transaction.atomic
def delete_bank_account(request, employee_id, account_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    bank_account = get_object_or_404(EmployeeBankAccount, pk=account_id, employee=employee)
    
    if request.method == 'POST':
        bank_account.delete()
        messages.success(request, 'Bank account deleted successfully.')
        return redirect('employees:employee_detail', pk=employee_id)
    
    return render(request, 'employees/preview/bank/bank_account_confirm_delete.html', {
        'employee': employee,
        'bank_account': bank_account
    })

@login_required
@transaction.atomic
def add_document(request, employee_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    if request.method == 'POST':
        form = EmployeeDocumentForm(request.POST, request.FILES)
        if form.is_valid():
            document = form.save(commit=False)
            document.employee = employee
            document.save()
            messages.success(request, 'Document added successfully.')
            return redirect('employees:employee_detail', pk=employee_id)
    else:
        form = EmployeeDocumentForm()
    
    return render(request, 'employees/preview/document/document_form.html', {
        'form': form,
        'employee': employee,
        'title': 'Add Document'
    })

@login_required
@transaction.atomic
def edit_document(request, employee_id, document_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    document = get_object_or_404(EmployeeDocument, pk=document_id, employee=employee)
    
    if request.method == 'POST':
        form = EmployeeDocumentForm(request.POST, request.FILES, instance=document)
        if form.is_valid():
            form.save()
            messages.success(request, 'Document updated successfully.')
            return redirect('employees:employee_detail', pk=employee_id)
    else:
        form = EmployeeDocumentForm(instance=document)
    
    return render(request, 'employees/preview/document/document_form.html', {
        'form': form,
        'employee': employee,
        'document': document,
        'title': 'Edit Document'
    })

@login_required
@transaction.atomic
def delete_document(request, employee_id, document_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    document = get_object_or_404(EmployeeDocument, pk=document_id, employee=employee)
    
    if request.method == 'POST':
        document.delete()
        messages.success(request, 'Document deleted successfully.')
        return redirect('employees:employee_detail', pk=employee_id)
    
    return render(request, 'employees/preview/document/document_confirm_delete.html', {
        'employee': employee,
        'document': document
    })

@login_required
def view_document(request, employee_id, document_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    document = get_object_or_404(EmployeeDocument, pk=document_id, employee=employee)
    
    return render(request, 'employees/preview/document/document_view.html', {
        'employee': employee,
        'document': document
    })

@login_required
def bulk_status_change(request):
    if request.method == 'POST':
        try:
            employee_ids = request.POST.getlist('employee_ids[]')
            status = request.POST.get('status')
            
            if not employee_ids or status not in ['active', 'inactive']:
                return JsonResponse({'success': False, 'error': 'Invalid parameters'})
            
            # Update employee status
            Employee.objects.filter(id__in=employee_ids).update(
                is_active=(status == 'active')
            )
            
            return JsonResponse({'success': True})
        except Exception as e:
            return JsonResponse({'success': False, 'error': str(e)})
    
    return JsonResponse({'success': False, 'error': 'Invalid request method'})

@login_required
def system_info(request):
    """Return system information for the client."""
    return JsonResponse({
        'platform': platform.system()
    })

@csrf_exempt
@login_required
def scan_document(request, employee_id=None, dependent_id=None):
    """Universal document scanning view that can be used for any document type."""
    if request.method != 'POST':
        return JsonResponse({'error': 'Invalid request method'}, status=400)
    
    # Check permissions
    if employee_id:
        try:
            employee = Employee.objects.get(id=employee_id)
            if not request.user.has_perm('employees.view_employee', employee):
                return JsonResponse({'error': 'Permission denied'}, status=403)
            
            if dependent_id:
                try:
                    dependent = EmployeeDependent.objects.get(id=dependent_id, employee=employee)
                except EmployeeDependent.DoesNotExist:
                    return JsonResponse({'error': 'Dependent not found'}, status=404)
        except Employee.DoesNotExist:
            return JsonResponse({'error': 'Employee not found'}, status=404)
    
    if platform.system() != 'Windows':
        return JsonResponse({'error': 'Scanner functionality is only available on Windows'}, status=400)

    try:
        # Ensure COM is uninitialized before starting
        try:
            pythoncom.CoUninitialize()
        except:
            pass
        
        # Initialize COM in the current thread
        pythoncom.CoInitialize()
        
        try:
            data = json.loads(request.body)
            use_feeder = data.get('useFeeder', False)
            
            # Create WIA device manager with retry logic
            max_retries = 3
            device_manager = None
            
            for attempt in range(max_retries):
                try:
                    device_manager = win32com.client.Dispatch("WIA.DeviceManager")
                    break
                except Exception as e:
                    if attempt == max_retries - 1:
                        raise Exception(f"Failed to initialize scanner after {max_retries} attempts: {str(e)}")
                    time.sleep(1)  # Wait before retry
            
            devices = device_manager.DeviceInfos
            
            # Find first available scanner
            scanner = None
            scanner_info = None
            
            for i in range(1, devices.Count + 1):
                try:
                    device = devices.Item(i)
                    if device.Type == 1:  # 1 = Scanner
                        scanner_info = device
                        scanner = device.Connect()
                        print(f"Found scanner: {device.Properties('Name').Value}")
                        break
                except Exception as e:
                    print(f"Failed to connect to device {i}: {str(e)}")
                    continue
            
            if not scanner:
                return JsonResponse({'error': 'No scanner found or scanner is not ready'}, status=404)
            
            # Store scanned images
            scanned_images = []
            
            # Get default scanner item
            try:
                item = scanner.Items[1]
            except Exception as e:
                raise Exception(f"Failed to get scanner item: {str(e)}")
            
            # Get available properties
            try:
                properties = {}
                for i in range(1, item.Properties.Count + 1):
                    prop = item.Properties.Item(i)
                    properties[prop.Name] = {
                        'id': prop.PropertyID,
                        'value': prop.Value,
                        'type': prop.Type
                    }
                print("Available properties:", properties)
            except Exception as e:
                print(f"Failed to get properties: {str(e)}")
            
            # Common scan settings with fallbacks
            scan_settings = {
                'Color Mode': {'id': 6146, 'value': 2},  # Color
                'Resolution': {'id': 6147, 'value': 300},  # DPI
                'Brightness': {'id': 6148, 'value': 0},
                'Contrast': {'id': 6149, 'value': 0}
            }
            
            # Apply scan settings with error handling
            for setting_name, setting_info in scan_settings.items():
                try:
                    prop_id = str(setting_info['id'])
                    item.Properties(prop_id).Value = setting_info['value']
                except Exception as e:
                    print(f"Warning: Failed to set {setting_name} ({prop_id}): {str(e)}")
                    # Continue even if a setting fails
            
            if use_feeder:
                try:
                    # Configure feeder settings if available
                    try:
                        scanner.Properties("Document Handling Select").Value = 2
                    except:
                        print("Warning: Feeder settings not available")
                    
                    try:
                        scanner.Properties("Pages").Value = 1
                    except:
                        print("Warning: Pages setting not available")
                    
                    while True:
                        try:
                            # Perform the scan
                            image = item.Transfer()
                            
                            # Process the scanned image
                            temp_filename = f'scan_{uuid.uuid4()}.jpg'
                            temp_path = os.path.join(tempfile.gettempdir(), temp_filename)
                            image.SaveFile(temp_path)
                            
                            with open(temp_path, 'rb') as img_file:
                                img_data = base64.b64encode(img_file.read()).decode('utf-8')
                            
                            scanned_images.append({
                                'data': f'data:image/jpeg;base64,{img_data}',
                                'filename': f'page_{len(scanned_images) + 1}.jpg'
                            })
                            
                            os.remove(temp_path)
                            
                        except Exception as e:
                            if "paper empty" in str(e).lower():
                                break
                            raise Exception(f"Error during feeder scan: {str(e)}")
                            
                except Exception as e:
                    raise Exception(f"Error with document feeder: {str(e)}")
            else:
                try:
                    # Perform single page scan
                    image = item.Transfer()
                    
                    # Process the scanned image
                    temp_filename = f'scan_{uuid.uuid4()}.jpg'
                    temp_path = os.path.join(tempfile.gettempdir(), temp_filename)
                    image.SaveFile(temp_path)
                    
                    with open(temp_path, 'rb') as img_file:
                        img_data = base64.b64encode(img_file.read()).decode('utf-8')
                    
                    scanned_images.append({
                        'data': f'data:image/jpeg;base64,{img_data}',
                        'filename': 'page_1.jpg'
                    })
                    
                    os.remove(temp_path)
                    
                except Exception as e:
                    raise Exception(f"Error during single page scan: {str(e)}")
            
            if not scanned_images:
                raise Exception("No images were scanned")
            
            return JsonResponse({
                'status': 'success',
                'images': scanned_images
            })
            
        finally:
            pythoncom.CoUninitialize()
            
    except Exception as e:
        error_message = str(e)
        # Try to ensure COM is properly uninitialized
        try:
            pythoncom.CoUninitialize()
        except:
            pass
            
        return JsonResponse({
            'status': 'error',
            'error': error_message
        }, status=500)

@login_required
def add_dependent(request, employee_id):
    employee = get_object_or_404(Employee, id=employee_id)
    if request.method == 'POST':
        form = EmployeeDependentForm(request.POST)
        if form.is_valid():
            dependent = form.save(commit=False)
            dependent.employee = employee
            dependent.save()
            return JsonResponse({'status': 'success', 'message': 'Dependent added successfully'})
        return JsonResponse({'status': 'error', 'errors': form.errors})
    else:
        form = EmployeeDependentForm()
    return render(request, 'employees/preview/dependents/dependent_form.html', {
        'form': form,
        'employee': employee,
    })

@login_required
def edit_dependent(request, employee_id, dependent_id):
    employee = get_object_or_404(Employee, id=employee_id)
    dependent = get_object_or_404(EmployeeDependent, id=dependent_id, employee=employee)
    if request.method == 'POST':
        form = EmployeeDependentForm(request.POST, instance=dependent)
        if form.is_valid():
            form.save()
            return JsonResponse({'status': 'success', 'message': 'Dependent updated successfully'})
        return JsonResponse({'status': 'error', 'errors': form.errors})
    else:
        form = EmployeeDependentForm(instance=dependent)
    return render(request, 'employees/preview/dependents/dependent_form.html', {
        'form': form,
        'employee': employee,
        'dependent': dependent,
    })

@login_required
def delete_dependent(request, employee_id, dependent_id):
    if request.method == 'POST':
        employee = get_object_or_404(Employee, id=employee_id)
        dependent = get_object_or_404(EmployeeDependent, id=dependent_id, employee=employee)
        dependent.delete()
        return JsonResponse({'status': 'success', 'message': 'Dependent deleted successfully'})
    return JsonResponse({'status': 'error', 'message': 'Invalid request method'})

@login_required
def add_dependent_document(request, employee_id, dependent_id):
    try:
        employee = Employee.objects.get(id=employee_id)
        dependent = EmployeeDependent.objects.get(id=dependent_id, employee=employee)
    except (Employee.DoesNotExist, EmployeeDependent.DoesNotExist):
        raise Http404("Employee or dependent not found")
    
    if request.method == 'POST':
        try:
            # Get form data
            document_type = request.POST.get('document_type')
            name = request.POST.get('name')
            document_number = request.POST.get('document_number')
            issue_date = request.POST.get('issue_date') or None
            expiry_date = request.POST.get('expiry_date') or None
            nationality = request.POST.get('nationality')
            
            # Create document
            document = DependentDocument.objects.create(
                dependent=dependent,
                document_type=document_type,
                name=name,
                document_number=document_number,
                issue_date=issue_date,
                expiry_date=expiry_date,
                nationality=nationality
            )
            
            # Handle file upload
            if request.FILES.get('document_file'):
                document.document_file = request.FILES['document_file']
                document.save()
            
            return JsonResponse({
                'status': 'success',
                'message': 'Document added successfully',
                'document': {
                    'id': document.id,
                    'name': document.name,
                    'document_type': document.get_document_type_display(),
                    'document_number': document.document_number or '',
                    'issue_date': document.issue_date.strftime('%Y-%m-%d') if document.issue_date else '',
                    'expiry_date': document.expiry_date.strftime('%Y-%m-%d') if document.expiry_date else '',
                    'status': document.status
                }
            })
            
        except Exception as e:
            return JsonResponse({
                'status': 'error',
                'error': str(e)
            }, status=400)
    
    context = {
        'employee': employee,
        'dependent': dependent,
        'nationality_choices': Employee.NATIONALITY_CHOICES
    }
    
    return render(request, 'employees/preview/dependents/dependent_document_form.html', context)

@login_required
def edit_dependent_document(request, employee_id, dependent_id, document_id):
    employee = get_object_or_404(Employee, id=employee_id)
    dependent = get_object_or_404(EmployeeDependent, id=dependent_id, employee=employee)
    document = get_object_or_404(DependentDocument, id=document_id, dependent=dependent)
    
    if request.method == 'POST':
        form = DependentDocumentForm(request.POST, request.FILES, instance=document)
        if form.is_valid():
            document = form.save()
            
            # Handle file upload
            if 'document_file' in request.FILES:
                document.document_file = request.FILES['document_file']
                document.save()
            
            return JsonResponse({
                'status': 'success',
                'message': 'Document updated successfully',
                'document': {
                    'id': document.id,
                    'name': document.name,
                    'document_type': document.get_document_type_display(),
                    'document_number': document.document_number or '',
                    'issue_date': document.issue_date.strftime('%Y-%m-%d') if document.issue_date else '',
                    'expiry_date': document.expiry_date.strftime('%Y-%m-%d') if document.expiry_date else '',
                    'status': document.status
                }
            })
        return JsonResponse({'status': 'error', 'errors': form.errors})
    else:
        form = DependentDocumentForm(instance=document)
        
    scanning_js = render_to_string('employees/preview/dependents/scanning_js.html', {
        'employee': employee,
        'dependent': dependent
    })
    
    return render(request, 'employees/preview/dependents/dependent_document_form.html', {
        'form': form,
        'employee': employee,
        'dependent': dependent,
        'document': document,
        'scanning_js': scanning_js
    })

@login_required
def delete_dependent_document(request, employee_id, dependent_id, document_id):
    if request.method == 'POST':
        employee = get_object_or_404(Employee, id=employee_id)
        dependent = get_object_or_404(EmployeeDependent, id=dependent_id, employee=employee)
        document = get_object_or_404(DependentDocument, id=document_id, dependent=dependent)
        document.delete()
        return JsonResponse({'status': 'success', 'message': 'Document deleted successfully'})
    return JsonResponse({'status': 'error', 'message': 'Invalid request method'})

@login_required
def view_dependent_document(request, employee_id, dependent_id, document_id):
    employee = get_object_or_404(Employee, id=employee_id)
    dependent = get_object_or_404(EmployeeDependent, id=dependent_id, employee=employee)
    document = get_object_or_404(DependentDocument, id=document_id, dependent=dependent)
    
    if document.document_file:
        # Get the file extension
        file_extension = os.path.splitext(document.document_file.name)[1].lower()
        
        # Set the content type based on file extension
        content_type = 'application/pdf' if file_extension == '.pdf' else 'image/jpeg' if file_extension in ['.jpg', '.jpeg'] else 'image/png' if file_extension == '.png' else 'application/octet-stream'
        
        # Set response headers for inline display
        response = HttpResponse(document.document_file.read(), content_type=content_type)
        response['Content-Disposition'] = f'inline; filename="{os.path.basename(document.document_file.name)}"'
        return response
        
    return JsonResponse({'status': 'error', 'message': 'Document file not found'})

@login_required
def get_dependent_documents(request, employee_id, dependent_id):
    employee = get_object_or_404(Employee, id=employee_id)
    dependent = get_object_or_404(EmployeeDependent, id=dependent_id, employee=employee)
    documents = dependent.documents.all().order_by('-created_at')
    
    documents_data = [{
        'id': doc.id,
        'name': doc.name,
        'document_type': doc.get_document_type_display(),
        'document_number': doc.document_number or '',
        'issue_date': doc.issue_date.strftime('%Y-%m-%d') if doc.issue_date else '',
        'expiry_date': doc.expiry_date.strftime('%Y-%m-%d') if doc.expiry_date else '',
        'status': doc.status
    } for doc in documents]
    
    return JsonResponse({
        'status': 'success',
        'documents': documents_data
    })

@login_required
def dependent_documents(request, employee_id, dependent_id):
    employee = get_object_or_404(Employee, id=employee_id)
    dependent = get_object_or_404(EmployeeDependent, id=dependent_id, employee=employee)
    documents = dependent.documents.all().order_by('-created_at')
    
    return render(request, 'employees/preview/dependents/dependent_documents_list.html', {
        'employee': employee,
        'dependent': dependent,
        'documents': documents
    })

@login_required
def employee_documents(request, employee_id):
    """View to list all documents for an employee."""
    employee = get_object_or_404(Employee, pk=employee_id)
    documents = EmployeeDocument.objects.filter(employee=employee)
    
    context = {
        'employee': employee,
        'documents': documents,
    }
    
    return render(request, 'employees/preview/document/document_list.html', context)


@login_required
@permission_required('employees.add_salarydetail')
def add_salary(request, employee_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    
    if request.method == 'POST':
        form = SalaryDetailForm(request.POST)
        if form.is_valid():
            salary_detail = form.save(commit=False)
            salary_detail.employee = employee
            salary_detail.created_by = request.user
            
            try:
                with transaction.atomic():
                    # Save the new salary detail
                    salary_detail.save()
                    
                    # If there's a previous active salary, create a revision
                    previous_salary = SalaryDetail.objects.filter(
                        employee=employee,
                        is_active=False
                    ).order_by('-effective_from').first()
                    
                    if previous_salary:
                        SalaryRevision.objects.create(
                            employee=employee,
                            revision_type='OTH',  # Other
                            previous_salary=previous_salary,
                            new_salary=salary_detail,
                            revision_date=salary_detail.effective_from,
                            reason="New salary details added",
                            approved_by=request.user
                        )
                    
                messages.success(request, 'Salary details added successfully.')
                return redirect('employees:employee_detail', pk=employee_id)
            except Exception as e:
                messages.error(request, f'Error saving salary details: {str(e)}')
    else:
        form = SalaryDetailForm()
    
    return render(request, 'employees/salary_form.html', {
        'form': form,
        'employee': employee
    })

@login_required
@permission_required('employees.add_salarycertificate')
def request_certificate(request, employee_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    
    if request.method == 'POST':
        form = SalaryCertificateForm(request.POST)
        if form.is_valid():
            try:
                with transaction.atomic():
                    # Get the current active salary detail
                    current_salary = SalaryDetail.objects.filter(
                        employee=employee,
                        is_active=True
                    ).first()
                    
                    if not current_salary:
                        raise ValueError("No active salary details found")
                    
                    certificate = form.save(commit=False)
                    certificate.employee = employee
                    certificate.salary_detail = current_salary
                    certificate.issued_by = request.user
                    certificate.issued_date = timezone.now().date()
                    
                    # Generate a unique certificate number
                    prefix = timezone.now().strftime('%Y%m')
                    count = SalaryCertificate.objects.filter(
                        certificate_number__startswith=prefix
                    ).count()
                    certificate.certificate_number = f"{prefix}-{count+1:04d}"
                    
                    certificate.save()
                    
                    messages.success(request, 'Certificate request submitted successfully.')
                    return redirect('employees:employee_detail', pk=employee_id)
                    
            except ValueError as e:
                messages.error(request, str(e))
            except Exception as e:
                messages.error(request, f'Error requesting certificate: {str(e)}')
    else:
        form = SalaryCertificateForm()
    
    return render(request, 'employees/certificate_form.html', {
        'form': form,
        'employee': employee
    })

@login_required
@permission_required('employees.change_salarydetail')
def edit_salary(request, salary_id):
    salary_detail = get_object_or_404(SalaryDetail, pk=salary_id)
    employee = salary_detail.employee
    
    if request.method == 'POST':
        form = SalaryDetailForm(request.POST, instance=salary_detail)
        if form.is_valid():
            try:
                with transaction.atomic():
                    # Save the updated salary detail
                    updated_salary = form.save()
                    
                    # Create a revision record
                    SalaryRevision.objects.create(
                        employee=employee,
                        revision_type='ADJ',  # Adjustment
                        previous_salary=salary_detail,
                        new_salary=updated_salary,
                        revision_date=timezone.now().date(),
                        reason="Salary details updated",
                        approved_by=request.user
                    )
                    
                messages.success(request, 'Salary details updated successfully.')
                return redirect('employees:employee_detail', pk=employee.id)
            except Exception as e:
                messages.error(request, f'Error updating salary details: {str(e)}')
    else:
        form = SalaryDetailForm(instance=salary_detail)
    
    return render(request, 'employees/salary_form.html', {
        'form': form,
        'employee': employee,
        'is_edit': True
    })

@login_required
@permission_required('employees.add_salaryrevision')
def add_salary_revision(request, employee_id):
    employee = get_object_or_404(Employee, pk=employee_id)
    
    if request.method == 'POST':
        form = SalaryRevisionForm(request.POST)
        if form.is_valid():
            try:
                with transaction.atomic():
                    revision = form.save(commit=False)
                    revision.employee = employee
                    revision.approved_by = request.user
                    
                    # Get the current active salary
                    current_salary = SalaryDetail.objects.filter(
                        employee=employee,
                        is_active=True
                    ).first()
                    
                    if not current_salary:
                        raise ValueError("No active salary details found")
                    
                    # Create a new salary detail based on the current one
                    new_salary = SalaryDetail.objects.create(
                        employee=employee,
                        basic_salary=current_salary.basic_salary,
                        housing_allowance=current_salary.housing_allowance,
                        transportation_allowance=current_salary.transportation_allowance,
                        other_allowances=current_salary.other_allowances,
                        currency=current_salary.currency,
                        effective_from=revision.revision_date,
                        created_by=request.user
                    )
                    
                    revision.previous_salary = current_salary
                    revision.new_salary = new_salary
                    revision.save()
                    
                messages.success(request, 'Salary revision added successfully.')
                return redirect('employees:employee_detail', pk=employee_id)
            except ValueError as e:
                messages.error(request, str(e))
            except Exception as e:
                messages.error(request, f'Error adding salary revision: {str(e)}')
    else:
        form = SalaryRevisionForm()
    
    return render(request, 'employees/revision_form.html', {
        'form': form,
        'employee': employee
    })
```

