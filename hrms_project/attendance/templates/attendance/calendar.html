{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<style>
.fc-event {
    cursor: pointer;
}

.fc-day-friday {
    background-color: rgba(0,0,0,0.05);
}

.fc-day-today {
    background-color: rgba(0,123,255,0.1) !important;
}

.calendar-legend {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

.tooltip-inner {
    max-width: 300px;
}

#filter-collapse {
    transition: all 0.3s ease-in-out;
}
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0 d-inline-block">Attendance Calendar</h5>
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse">
                    <i class="fas fa-filter"></i> Filters
                </button>
            </div>
            <div class="btn-group">
                <button class="btn btn-outline-secondary" id="prev-month">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary" id="today">Today</button>
                <button class="btn btn-outline-secondary" id="next-month">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="collapse mb-4" id="filter-collapse">
            <div class="card card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="department-filter">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Employee</label>
                        <select class="form-select" id="employee-filter">
                            <option value="">All Employees</option>
                            {% for emp in employees %}
                            <option value="{{ emp.id }}">{{ emp.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">View Type</label>
                        <select class="form-select" id="view-type">
                            <option value="dayGridMonth">Month</option>
                            <option value="dayGridWeek">Week</option>
                            <option value="dayGridDay">Day</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" id="apply-filters">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Legend -->
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color bg-success"></div>
                <span>Present</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-danger"></div>
                <span>Absent</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-warning"></div>
                <span>Late</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-info"></div>
                <span>Leave</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-primary"></div>
                <span>Holiday</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(0,0,0,0.05);"></div>
                <span>Friday</span>
            </div>
        </div>

        <!-- Calendar -->
        <div id="calendar"></div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetails">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: false,
        dayHeaderFormat: { weekday: 'short' },
        firstDay: 0, // Start week on Sunday
        height: 'auto',
        dayCellDidMount: function(info) {
            // Add class to Fridays
            if (info.date.getDay() === 5) { // 5 is Friday
                info.el.classList.add('fc-day-friday');
            }
        },
        eventDidMount: function(info) {
            // Add tooltips
            $(info.el).tooltip({
                title: info.event.extendedProps.tooltip || info.event.title,
                placement: 'top',
                container: 'body'
            });
        },
        eventClick: function(info) {
            showEventDetails(info.event);
        },
        events: function(info, successCallback, failureCallback) {
            // Get filter values
            const department = $('#department-filter').val();
            const employee = $('#employee-filter').val();
            
            $.ajax({
                url: '{% url "attendance:calendar_events" %}',
                data: {
                    start: info.startStr,
                    end: info.endStr,
                    department: department,
                    employee: employee
                },
                success: function(response) {
                    successCallback(response.events);
                },
                error: function() {
                    failureCallback('Error loading events');
                }
            });
        }
    });

    calendar.render();

    // Navigation buttons
    $('#prev-month').click(() => calendar.prev());
    $('#next-month').click(() => calendar.next());
    $('#today').click(() => calendar.today());

    // View type change
    $('#view-type').change(function() {
        calendar.changeView($(this).val());
    });

    // Apply filters
    $('#apply-filters').click(function() {
        calendar.refetchEvents();
    });

    // Department filter change - update employee list
    $('#department-filter').change(function() {
        const departmentId = $(this).val();
        $.ajax({
            url: '{% url "attendance:get_department_employees" %}',
            data: { department: departmentId },
            success: function(response) {
                const employeeSelect = $('#employee-filter');
                employeeSelect.empty();
                employeeSelect.append('<option value="">All Employees</option>');
                response.employees.forEach(function(emp) {
                    employeeSelect.append(
                        `<option value="${emp.id}">${emp.name}</option>`
                    );
                });
            }
        });
    });

    function showEventDetails(event) {
        const modal = $('#eventModal');
        const title = event.title;
        const details = event.extendedProps;
        
        modal.find('#eventTitle').text(title);
        
        let detailsHtml = '<dl class="row mb-0">';
        
        // Common fields
        if (details.employee) {
            detailsHtml += `
                <dt class="col-sm-4">Employee</dt>
                <dd class="col-sm-8">${details.employee}</dd>
            `;
        }
        
        if (details.department) {
            detailsHtml += `
                <dt class="col-sm-4">Department</dt>
                <dd class="col-sm-8">${details.department}</dd>
            `;
        }
        
        // Attendance specific fields
        if (details.type === 'attendance') {
            detailsHtml += `
                <dt class="col-sm-4">Status</dt>
                <dd class="col-sm-8">
                    <span class="badge bg-${details.status_color}">${details.status}</span>
                </dd>
                <dt class="col-sm-4">Time In</dt>
                <dd class="col-sm-8">${details.time_in || '-'}</dd>
                <dt class="col-sm-4">Time Out</dt>
                <dd class="col-sm-8">${details.time_out || '-'}</dd>
            `;
            
            if (details.status === 'Late') {
                detailsHtml += `
                    <dt class="col-sm-4">Late By</dt>
                    <dd class="col-sm-8">${details.late_by}</dd>
                `;
            }
        }
        
        // Leave specific fields
        if (details.type === 'leave') {
            detailsHtml += `
                <dt class="col-sm-4">Leave Type</dt>
                <dd class="col-sm-8">${details.leave_type}</dd>
                <dt class="col-sm-4">Duration</dt>
                <dd class="col-sm-8">${details.duration} days</dd>
                <dt class="col-sm-4">Status</dt>
                <dd class="col-sm-8">
                    <span class="badge bg-${details.status_color}">${details.status}</span>
                </dd>
            `;
            
            if (details.reason) {
                detailsHtml += `
                    <dt class="col-sm-4">Reason</dt>
                    <dd class="col-sm-8">${details.reason}</dd>
                `;
            }
        }
        
        // Holiday specific fields
        if (details.type === 'holiday') {
            detailsHtml += `
                <dt class="col-sm-4">Holiday Type</dt>
                <dd class="col-sm-8">${details.holiday_type}</dd>
            `;
            
            if (details.description) {
                detailsHtml += `
                    <dt class="col-sm-4">Description</dt>
                    <dd class="col-sm-8">${details.description}</dd>
                `;
            }
        }
        
        detailsHtml += '</dl>';
        
        modal.find('#eventDetails').html(detailsHtml);
        modal.modal('show');
    }

    // Clean up tooltips when events are removed
    calendar.on('eventRemove', function(info) {
        $(info.el).tooltip('dispose');
    });
});
</script>
{% endblock %}
