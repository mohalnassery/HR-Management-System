{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<style>
.fc-event {
    cursor: pointer;
}

.fc-day-friday {
    background-color: rgba(0,0,0,0.05);
}

.fc-day-today {
    background-color: rgba(0,123,255,0.1) !important;
}

.calendar-legend {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

.tooltip-inner {
    max-width: 300px;
}

#filter-collapse {
    transition: all 0.3s ease-in-out;
}

/* Select2 Custom Styles */
.select2-container--default .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
    padding-left: 12px;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
}
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <h5 class="mb-0 d-inline-block me-2">Attendance Calendar</h5>
                <h6 class="mb-0 me-3" id="calendar-title"></h6>
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse">
                    <i class="fas fa-filter"></i> Filters
                </button>
            </div>
            <div class="btn-group ms-auto">
                <button class="btn btn-outline-secondary" id="prev-month">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary" id="today">Today</button>
                <button class="btn btn-outline-secondary" id="next-month">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="collapse mb-4" id="filter-collapse">
            <div class="card card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="department-filter">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Employee</label>
                        <select class="form-control" id="employee-filter">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">View Type</label>
                        <select class="form-select" id="view-type">
                            <option value="dayGridMonth">Month</option>
                            <option value="dayGridWeek">Week</option>
                            <option value="dayGridDay">Day</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" id="apply-filters">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Legend -->
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color bg-success"></div>
                <span>Present</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-danger"></div>
                <span>Absent</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-warning"></div>
                <span>Late</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-info"></div>
                <span>Leave</span>
            </div>
            <div class="legend-item">
                <div class="legend-color bg-primary"></div>
                <span>Holiday</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: rgba(0,0,0,0.05);"></div>
                <span>Friday</span>
            </div>
        </div>

        <!-- Calendar -->
        <div id="calendar"></div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetails">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2
    $('#employee-filter').select2({
        placeholder: 'Search by ID or Name',
        allowClear: true,
        minimumInputLength: 1,
        ajax: {
            url: '{% url "attendance:search_employees" %}',
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return {
                    q: params.term,
                    department: $('#department-filter').val()
                };
            },
            processResults: function(data) {
                return {
                    results: data.map(function(emp) {
                        return {
                            id: emp.id,
                            text: emp.employee_number + ' - ' + emp.full_name,
                            employee_number: emp.employee_number
                        };
                    })
                };
            },
            cache: true
        }
    });

    // Update search when department changes
    $('#department-filter').on('change', function() {
        $('#employee-filter').val(null).trigger('change');
    });

    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: false,
        dayHeaderFormat: { weekday: 'short' },
        firstDay: 0, // Start week on Sunday
        height: 'auto',
        dayCellDidMount: function(info) {
            // Add class to Fridays
            if (info.date.getDay() === 5) { // 5 is Friday
                info.el.classList.add('fc-day-friday');
            }
        },
        eventDidMount: function(info) {
            // Add tooltips
            $(info.el).tooltip({
                title: info.event.extendedProps.tooltip || info.event.title,
                placement: 'top',
                container: 'body'
            });
        },
        eventClick: function(info) {
            showEventDetails(info.event);
        },
        displayEventTime: false, // Hide time from event display
        eventDisplay: 'block', // Display events as blocks
        events: function(info, successCallback, failureCallback) {
            const department = $('#department-filter').val();
            const employee = $('#employee-filter').val();
            
            // Format dates in ISO format (YYYY-MM-DD)
            const start = info.start.toISOString().split('T')[0];
            const end = info.end.toISOString().split('T')[0];
            
            fetch(`/attendance/api/calendar_events/?start=${start}&end=${end}&department=${department}&employee=${employee}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Server error:', data.error);
                        failureCallback(new Error(data.error));
                        return;
                    }
                    successCallback(data);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    failureCallback(error);
                });
        }
    });

    calendar.render();

    // Navigation buttons
    $('#prev-month').click(() => {
        calendar.prev();
        calendar.refetchEvents();
    });
    $('#next-month').click(() => {
        calendar.next();
        calendar.refetchEvents();
    });
    $('#today').click(() => {
        calendar.today();
        calendar.refetchEvents();
    });

    // View type change
    $('#view-type').change(function() {
        calendar.changeView($(this).val());
    });

    // Apply filters
    $('#apply-filters').click(function() {
        calendar.refetchEvents();
    });

    // Handle date clicks
    $(document).on('click', '.fc-daygrid-day', function(e) {
        const date = $(this).data('date');
        const employeeId = $('#employee-filter').val();
        
        // Prepare URL for attendance details
        let url = `{% url "attendance:attendance_detail" %}?date=${date}`;
        
        if (employeeId) {
            const empNumber = $('#employee-filter').select2('data')[0]?.employee_number;
            if (empNumber) {
                url += '&personnel_id=' + empNumber;
            }
        }
        
        // Load attendance details in modal
        $('#eventDetails').load(url, function() {
            $('#eventModal').modal('show');
        });
    });

    // Update calendar title
    function updateCalendarTitle() {
        const date = calendar.getDate();
        const title = date.toLocaleString('default', { month: 'long', year: 'numeric' });
        $('#calendar-title').text(title);
    }

    // Initialize calendar with current month
    const today = new Date();
    calendar.gotoDate(today);
    updateCalendarTitle();

    // Update title on navigation
    calendar.on('datesSet', function(info) {
        updateCalendarTitle();
    });

    function showEventDetails(event) {
        const modal = $('#eventModal');
        const title = event.title;
        const details = event.extendedProps;
        
        modal.find('#eventTitle').text(title);
        
        let detailsHtml = '<dl class="row mb-0">';
        
        // Common fields
        if (details.employee) {
            detailsHtml += `
                <dt class="col-sm-4">Employee</dt>
                <dd class="col-sm-8">${details.employee}</dd>
            `;
        }
        
        if (details.department) {
            detailsHtml += `
                <dt class="col-sm-4">Department</dt>
                <dd class="col-sm-8">${details.department}</dd>
            `;
        }
        
        // Attendance specific fields
        if (details.type === 'attendance') {
            detailsHtml += `
                <dt class="col-sm-4">Status</dt>
                <dd class="col-sm-8">
                    <span class="badge bg-${details.status_color}">${details.status}</span>
                </dd>
                <dt class="col-sm-4">Time In</dt>
                <dd class="col-sm-8">${details.time_in || '-'}</dd>
                <dt class="col-sm-4">Time Out</dt>
                <dd class="col-sm-8">${details.time_out || '-'}</dd>
            `;
            
            if (details.status === 'Late') {
                detailsHtml += `
                    <dt class="col-sm-4">Late By</dt>
                    <dd class="col-sm-8">${details.late_by}</dd>
                `;
            }
        }
        
        // Leave specific fields
        if (details.type === 'leave') {
            detailsHtml += `
                <dt class="col-sm-4">Leave Type</dt>
                <dd class="col-sm-8">${details.leave_type}</dd>
                <dt class="col-sm-4">Duration</dt>
                <dd class="col-sm-8">${details.duration} days</dd>
                <dt class="col-sm-4">Status</dt>
                <dd class="col-sm-8">
                    <span class="badge bg-${details.status_color}">${details.status}</span>
                </dd>
            `;
            
            if (details.reason) {
                detailsHtml += `
                    <dt class="col-sm-4">Reason</dt>
                    <dd class="col-sm-8">${details.reason}</dd>
                `;
            }
        }
        
        // Holiday specific fields
        if (details.type === 'holiday') {
            detailsHtml += `
                <dt class="col-sm-4">Holiday Type</dt>
                <dd class="col-sm-8">${details.holiday_type}</dd>
            `;
            
            if (details.description) {
                detailsHtml += `
                    <dt class="col-sm-4">Description</dt>
                    <dd class="col-sm-8">${details.description}</dd>
                `;
            }
        }
        
        detailsHtml += '</dl>';
        
        modal.find('#eventDetails').html(detailsHtml);
        modal.modal('show');
    }

    // Clean up tooltips when events are removed
    calendar.on('eventRemove', function(info) {
        $(info.el).tooltip('dispose');
    });
});
</script>
{% endblock %}
