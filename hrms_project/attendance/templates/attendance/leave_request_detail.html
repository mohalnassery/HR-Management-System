{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
<!-- Custom badge styles -->
<style>
    .badge.bg-pending {
        background-color: #ffc107 !important;
        color: #000;
    }
    .badge.bg-approved {
        background-color: #198754 !important;
        color: #fff;
    }
    .badge.bg-rejected {
        background-color: #dc3545 !important;
        color: #fff;
    }
    .badge.bg-cancelled {
        background-color: #6c757d !important;
        color: #fff;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- jQuery first -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Then Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('Detail page loaded');
    
    // Function to show the status modal
    window.showStatusModal = function(leaveId, currentStatus) {
        console.log('showStatusModal called:', { leaveId, currentStatus });
        
        const modal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
        const statusSelect = document.getElementById('newStatus');
        
        // Map current status to action
        const statusToAction = {
            'pending': '',
            'approved': 'approve',
            'rejected': 'reject',
            'cancelled': 'cancel'
        };
        
        // Hide current status from options
        Array.from(statusSelect.options).forEach(option => {
            option.style.display = option.value === statusToAction[currentStatus] ? 'none' : '';
        });
        
        // Clear previous remarks
        document.getElementById('statusRemarks').value = '';
        
        // Store leave ID for use in handleStatusChange
        window.currentLeaveId = leaveId;
        
        // Show modal
        modal.show();
    };

    // Function to handle status change
    async function handleStatusChange() {
        const leaveId = window.currentLeaveId;
        const newStatus = document.getElementById('newStatus').value;
        const remarks = document.getElementById('statusRemarks').value;
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

        try {
            const response = await fetch(`/attendance/api/leaves/${leaveId}/${newStatus}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ remarks })
            });
            
            const data = await response.json();
            if (response.ok) {
                window.location.reload();
            } else {
                alert(data.error || 'Failed to process the request');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while processing your request');
        }
    }
    
    // Bind confirm button click
    const confirmBtn = document.getElementById('confirmStatusChange');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', handleStatusChange);
    }

    // Bind status change button
    const changeStatusBtn = document.querySelector('.change-status');
    if (changeStatusBtn) {
        changeStatusBtn.addEventListener('click', function() {
            const leaveId = this.dataset.id;
            const currentStatus = this.dataset.currentStatus;
            showStatusModal(leaveId, currentStatus);
        });
    }

    // Add delete confirmation modal handler
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    let leaveIdToDelete = null;

    // Delete button click handler
    document.querySelector('.delete-leave')?.addEventListener('click', function() {
        leaveIdToDelete = this.dataset.id;
        deleteModal.show();
    });

    // Confirm delete button handler
    document.getElementById('confirmDeleteBtn')?.addEventListener('click', async function() {
        if (!leaveIdToDelete) return;
        
        try {
            const response = await fetch(`/attendance/api/leaves/${leaveIdToDelete}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
                }
            });
            
            const data = await response.json();
            if (response.ok) {
                window.location.href = "{% url 'attendance:leave_request_list' %}";
            } else {
                alert(data.error || 'Failed to delete the leave request');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while deleting the leave request');
        }
    });
});
</script>
{% endblock %}

{% block attendance_content %}
<!-- Add CSRF Token at the top of the content -->
{% csrf_token %}

<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Leave Request Details</h5>
            </div>
            <div class="col-auto">
                {% if leave.status != 'deleted' and perms.attendance.can_approve_leave %}
                <div class="btn-group me-2">
                    <button type="button" 
                            class="btn btn-primary change-status" 
                            data-id="{{ leave.id }}"
                            data-current-status="{{ leave.status }}"
                            title="Change Status">
                        <i class="fas fa-exchange-alt"></i> Change Status
                    </button>
                    <button type="button"
                            class="btn btn-danger delete-leave"
                            data-id="{{ leave.id }}"
                            title="Delete Leave">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
                {% endif %}
                <a href="{% url 'attendance:leave_request_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Employee Information -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Employee Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Employee ID:</div>
                            <div class="col-sm-8">{{ leave.employee.employee_number }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Name:</div>
                            <div class="col-sm-8">{{ leave.employee.get_full_name }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Department:</div>
                            <div class="col-sm-8">{{ leave.employee.department.name }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Position:</div>
                            <div class="col-sm-8">{{ leave.employee.designation }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leave Balance -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">Leave Balance</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-sm-4">
                                <div class="border rounded p-2 text-center">
                                    <small class="text-muted d-block">Annual Leave</small>
                                    <strong class="d-block" id="annual-balance">{{ balance.annual.remaining }}</strong>
                                    <small class="text-muted">remaining</small>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="border rounded p-2 text-center">
                                    <small class="text-muted d-block">Sick Leave</small>
                                    <strong class="d-block" id="sick-balance">{{ balance.sick.remaining }}</strong>
                                    <small class="text-muted">remaining</small>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="border rounded p-2 text-center">
                                    <small class="text-muted d-block">Permission</small>
                                    <strong class="d-block" id="permission-balance">{{ balance.permission.remaining }}</strong>
                                    <small class="text-muted">hours</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Leave Request Details -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Leave Details</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Leave Type:</div>
                            <div class="col-sm-8">
                                <span class="badge bg-info">{{ leave.get_leave_type_display }}</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Duration:</div>
                            <div class="col-sm-8">{{ leave.start_date|date:"M d, Y" }} - {{ leave.end_date|date:"M d, Y" }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Total Days:</div>
                            <div class="col-sm-8">{{ leave.duration }} days</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Status:</div>
                            <div class="col-sm-8">
                                <span class="badge bg-{{ leave.status|lower }}">
                                    {{ leave.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Submitted On:</div>
                            <div class="col-sm-8">{{ leave.created_at|date:"M d, Y H:i" }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Last Updated:</div>
                            <div class="col-sm-8">{{ leave.updated_at|date:"M d, Y H:i" }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 text-muted">Approved By:</div>
                            <div class="col-sm-8">
                                {% if leave.approved_by %}
                                    {{ leave.approved_by.get_full_name }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {% if leave.remarks %}
                <div class="mt-3">
                    <h6 class="text-muted">Remarks</h6>
                    <p class="mb-0">{{ leave.remarks }}</p>
                </div>
                {% endif %}

                {% if leave.attachment %}
                <div class="mt-3">
                    <h6 class="text-muted">Attachment</h6>
                    <a href="{{ leave.attachment.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                        <i class="fas fa-paperclip"></i> View Attachment
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Similar Leaves History -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Similar Leaves History</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Duration</th>
                                <th>Days</th>
                                <th>Sub Type</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for similar_leave in similar_leaves %}
                            <tr {% if similar_leave.id == leave.id %}class="table-primary"{% endif %}>
                                <td>{{ similar_leave.start_date|date:"M d, Y" }} - {{ similar_leave.end_date|date:"M d, Y" }}</td>
                                <td>{{ similar_leave.duration }}</td>
                                <td>{{ similar_leave.leave_sub_type|default:"-" }}</td>
                                <td>
                                    <span class="badge bg-{{ similar_leave.status|lower }}">
                                        {{ similar_leave.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ similar_leave.created_at|date:"M d, Y H:i" }}</td>
                                <td>
                                    <a href="{% url 'attendance:leave_request_detail' similar_leave.id %}" 
                                       class="btn btn-sm btn-info" 
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No similar leave requests found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">Change Leave Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newStatus" class="form-label">New Status</label>
                    <select class="form-select" id="newStatus">
                        <option value="approve">Approve</option>
                        <option value="reject">Reject</option>
                        <option value="cancel">Cancel</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="statusRemarks" class="form-label">Remarks</label>
                    <textarea class="form-control" id="statusRemarks" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChange">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this leave request? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block footer_scripts %}
{{ block.super }}
{% endblock %}