{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Shifts Schedule</h5>
            <div>
                <a href="{% url 'attendance:shift_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Shift
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="shiftTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="shifts-tab" data-bs-toggle="tab" data-bs-target="#shifts" 
                        type="button" role="tab" aria-controls="shifts" aria-selected="true">
                    Shift Types
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" 
                        type="button" role="tab" aria-controls="calendar" aria-selected="false">
                    Schedule Calendar
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="shiftTabsContent">
            <!-- Shifts Tab -->
            <div class="tab-pane fade show active" id="shifts" role="tabpanel" aria-labelledby="shifts-tab">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Timing</th>
                                <th>Grace Period</th>
                                <th>Break Duration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shift in shifts %}
                            <tr>
                                <td>{{ shift.name }}</td>
                                <td>{{ shift.get_shift_type_display }}</td>
                                <td>
                                    {{ shift.start_time|time:"g:i A" }} - {{ shift.end_time|time:"g:i A" }}
                                </td>
                                <td>{{ shift.grace_period }} minutes</td>
                                <td>{{ shift.break_duration }} minutes</td>
                                <td>
                                    <span class="badge {% if shift.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if shift.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'attendance:shift_edit' shift.id %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center">No shifts found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Calendar Tab -->
            <div class="tab-pane fade" id="calendar" role="tabpanel" aria-labelledby="calendar-tab">
                <!-- Legend -->
                <div class="mb-3">
                    <span class="badge bg-primary me-2">Default Shift (7AM-4PM)</span>
                    <span class="badge bg-success me-2">Open Shift</span>
                    <span class="badge bg-dark me-2">Night Shift (7PM-4AM)</span>
                    <span class="badge bg-warning me-2">Override Night Shift</span>
                </div>

                <!-- Month Navigation -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-sm btn-outline-secondary" id="prevMonth">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <h5 class="mb-0" id="currentMonth"></h5>
                    <button class="btn btn-sm btn-outline-secondary" id="nextMonth">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    <div class="calendar-header">
                        <div>Sun</div>
                        <div>Mon</div>
                        <div>Tue</div>
                        <div>Wed</div>
                        <div>Thu</div>
                        <div>Fri</div>
                        <div>Sat</div>
                    </div>
                    <div id="calendarDays" class="calendar-days"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Override Modal -->
<div class="modal fade" id="overrideModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Override Night Shift</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="overrideForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="date" id="overrideDate">
                    <div class="mb-3">
                        <label class="form-label">Selected Date: <span id="selectedDate"></span></label>
                    </div>
                    <div class="mb-3">
                        <label for="startTime" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="startTime" name="start_time" required>
                    </div>
                    <div class="mb-3">
                        <label for="endTime" class="form-label">End Time</label>
                        <input type="time" class="form-control" id="endTime" name="end_time" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="removeOverride">Remove Override</button>
                <button type="submit" form="overrideForm" class="btn btn-primary">Save Override</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.calendar-grid {
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #f8f9fa;
    padding: 10px;
    text-align: center;
    font-weight: bold;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #dee2e6;
}

.calendar-day {
    background: white;
    padding: 10px;
    min-height: 100px;
}

.calendar-day.other-month {
    background: #f8f9fa;
    color: #6c757d;
}

.shift-time {
    font-size: 0.8rem;
    margin: 2px 0;
    padding: 2px 4px;
    border-radius: 3px;
}

.shift-default { background-color: #cfe2ff; }
.shift-open { background-color: #d1e7dd; }
.shift-night { background-color: #212529; color: white; }
.shift-override { background-color: #fff3cd; }

.calendar-day:hover {
    background: #f8f9fa;
    cursor: pointer;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentDate = new Date();
let overrides = {};  // Will store override data from the server

function updateCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update month display
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
    document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
    
    // Calculate dates
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startingDay = firstDay.getDay();
    
    // Generate calendar
    let calendarHTML = '';
    let day = 1;
    
    // Previous month days
    const prevMonthDays = new Date(year, month, 0).getDate();
    for (let i = startingDay - 1; i >= 0; i--) {
        const prevDay = prevMonthDays - i;
        calendarHTML += `
            <div class="calendar-day other-month">
                <div>${prevDay}</div>
            </div>
        `;
    }
    
    // Current month days
    while (day <= lastDay.getDate()) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const hasOverride = overrides[dateStr];
        
        calendarHTML += `
            <div class="calendar-day" data-date="${dateStr}">
                <div>${day}</div>
                <div class="shift-time shift-default">Default: 7AM-4PM</div>
                <div class="shift-time shift-open">Open Shift</div>
                ${hasOverride ? 
                    `<div class="shift-time shift-override">Night: ${hasOverride.start_time}-${hasOverride.end_time}</div>` :
                    `<div class="shift-time shift-night">Night: 7PM-4AM</div>`
                }
            </div>
        `;
        day++;
    }
    
    // Next month days
    const remainingDays = 42 - (startingDay + lastDay.getDate());
    for (let i = 1; i <= remainingDays; i++) {
        calendarHTML += `
            <div class="calendar-day other-month">
                <div>${i}</div>
            </div>
        `;
    }
    
    document.getElementById('calendarDays').innerHTML = calendarHTML;
    
    // Add click handlers
    document.querySelectorAll('.calendar-day:not(.other-month)').forEach(day => {
        day.addEventListener('click', () => showOverrideModal(day.dataset.date));
    });
}

function showOverrideModal(date) {
    const modal = new bootstrap.Modal(document.getElementById('overrideModal'));
    document.getElementById('selectedDate').textContent = date;
    document.getElementById('overrideDate').value = date;
    
    // Set current override values if they exist
    const override = overrides[date];
    if (override) {
        document.getElementById('startTime').value = override.start_time;
        document.getElementById('endTime').value = override.end_time;
        document.getElementById('removeOverride').style.display = 'block';
    } else {
        document.getElementById('startTime').value = '19:00';
        document.getElementById('endTime').value = '04:00';
        document.getElementById('removeOverride').style.display = 'none';
    }
    
    modal.show();
}

// Event Listeners
document.getElementById('prevMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    updateCalendar();
    loadOverrides();
});

document.getElementById('nextMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    updateCalendar();
    loadOverrides();
});

document.getElementById('overrideForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/attendance/shift_override/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('overrideModal')).hide();
            loadOverrides();
        } else {
            alert('Error saving override');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving override');
    }
});

document.getElementById('removeOverride').addEventListener('click', async () => {
    const date = document.getElementById('overrideDate').value;
    
    try {
        const response = await fetch(`/attendance/shift_override/${date}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('overrideModal')).hide();
            loadOverrides();
        } else {
            alert('Error removing override');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error removing override');
    }
});

async function loadOverrides() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;
    
    try {
        const response = await fetch(`/attendance/shift_overrides/${year}/${month}/`);
        if (response.ok) {
            overrides = await response.json();
            updateCalendar();
        }
    } catch (error) {
        console.error('Error loading overrides:', error);
    }
}

// Initial load
updateCalendar();
loadOverrides();
</script>
{% endblock %}
