{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link href="{% static 'attendance/css/shifts.css' %}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
<style>
    #shift-assignment-calendar {
        margin-top: 20px;
        height: 800px;  /* Set a fixed height */
        width: 100%;
    }
    .fc-event {
        cursor: pointer;
        border: none;
        padding: 2px 4px;
    }
    .fc-event-title {
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .fc-event-time {
        font-size: 0.9em;
        opacity: 0.8;
    }
    /* Shift type styles */
    .shift-type-default {
        background-color: #0d6efd !important;  /* Bootstrap primary */
        border-color: #0a58ca !important;
        color: white !important;
    }
    .shift-type-night {
        background-color: #0dcaf0 !important;  /* Bootstrap info */
        border-color: #0a9ec0 !important;
        color: black !important;
    }
    .shift-type-open {
        background-color: #6c757d !important;  /* Bootstrap secondary */
        border-color: #565e64 !important;
        color: white !important;
    }
    .date-specific {
        border-left: 4px solid #ffc107 !important;  /* Bootstrap warning */
    }
    .ramadan {
        border-left: 4px solid #198754 !important;  /* Bootstrap success */
    }
    /* Filter styles */
    .calendar-filters {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .calendar-filters .form-label {
        font-weight: 500;
        color: #495057;
    }
    .calendar-filters .form-select {
        border-radius: 6px;
    }
    /* Add employee search styles */
    .employee-search {
        position: relative;
        margin-bottom: 15px;
    }
    
    .employee-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .employee-search-results.show {
        display: block;
    }
    
    .employee-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .employee-item:hover {
        background-color: #f8f9fa;
    }
    
    .selected-employee {
        background-color: #e7f3ff;
        padding: 8px;
        margin: 4px 0;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Shift Assignments</h5>
            <a href="{% url 'attendance:shift_assignment_create' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Assignment
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="assignmentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view"
                        type="button" role="tab" aria-controls="list-view" aria-selected="true">
                    List View
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-view"
                        type="button" role="tab" aria-controls="calendar-view" aria-selected="false">
                    Calendar View
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="assignmentTabsContent">
            <!-- List View Tab -->
            <div class="tab-pane fade show active" id="list-view" role="tabpanel" aria-labelledby="list-tab">
                <!-- Filters -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="department-filter-list" name="department">
                            <option value="">All Departments</option>
                            {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Shift</label>
                        <select class="form-select" id="shift-filter-list" name="shift">
                            <option value="">All Shifts</option>
                            {% for shift in shifts %}
                                <option value="{{ shift.id }}" {% if selected_shift == shift.id|stringformat:"s" %}selected{% endif %}>
                                    {{ shift.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="status-filter-list" name="status">
                            <option value="">All Status</option>
                            <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
                            <option value="inactive" {% if selected_status == 'inactive' %}selected{% endif %}>Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Assignment Type</label>
                        <select class="form-select" id="type-filter-list" name="type">
                            <option value="">All Types</option>
                            <option value="permanent" {% if selected_type == 'permanent' %}selected{% endif %}>Permanent</option>
                            <option value="temporary" {% if selected_type == 'temporary' %}selected{% endif %}>Temporary</option>
                        </select>
                    </div>
                </div>

                <!-- Date Range Filters -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start-date-filter" name="start_date" 
                               value="{{ start_date|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end-date-filter" name="end_date" 
                               value="{{ end_date|default:'' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Search</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input-list" name="search"
                                   placeholder="Search by employee name or number..." value="{{ search_query|default:'' }}">
                            <button class="btn btn-outline-secondary" type="button" id="search-btn-list">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-secondary" type="button" id="clear-filters-btn">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Assignments Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Department</th>
                                <th>Shift</th>
                                <th>Period</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignments-tbody">
                            {% for assignment in page_obj %}
                            <tr>
                                <td>
                                    <div>{{ assignment.employee.get_full_name }}</div>
                                    <small class="text-muted">{{ assignment.employee.employee_number }}</small>
                                </td>
                                <td>{{ assignment.employee.department.name|default:'-' }}</td>
                                <td>
                                    <div>{{ assignment.shift.name }}</div>
                                    <small class="text-muted">
                                        {{ assignment.shift.start_time|time:"g:i A" }} - {{ assignment.shift.end_time|time:"g:i A" }}
                                    </small>
                                </td>
                                <td>
                                    <div>{{ assignment.start_date|date:"M d, Y" }}</div>
                                    {% if assignment.end_date %}
                                        <small class="text-muted">Until {{ assignment.end_date|date:"M d, Y" }}</small>
                                    {% else %}
                                        <small class="text-success">Permanent</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {% if assignment.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if assignment.is_active %}Active{% else %}Inactive{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <div>{{ assignment.created_by.get_full_name }}</div>
                                    <small class="text-muted">{{ assignment.created_at|date:"M d, Y" }}</small>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{% url 'attendance:shift_assignment_edit' assignment.id %}" 
                                           class="btn btn-sm btn-outline-primary" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="confirmDelete('{{ assignment.id }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle me-2"></i>No shift assignments found
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Shift assignments pagination" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if num == page_obj.number %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>

            <!-- Calendar View Tab -->
            <div class="tab-pane fade" id="calendar-view" role="tabpanel" aria-labelledby="calendar-tab">
                <!-- Filters -->
                <div class="calendar-filters mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Department</label>
                            <select class="form-select" id="departmentFilter">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Shift Type</label>
                            <select class="form-select" id="shiftTypeFilter">
                                <option value="">All Types</option>
                                <option value="DEFAULT">Default Shift</option>
                                <option value="NIGHT">Night Shift</option>
                                <option value="OPEN">Open Shift</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Employee</label>
                            <div class="employee-search">
                                <input type="text" class="form-control" id="employeeSearch" 
                                       placeholder="Search employee...">
                                <div class="employee-search-results" id="searchResults"></div>
                            </div>
                            <div id="selectedEmployee" class="mt-2"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="clearEmployee">
                                Clear Employee Filter
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendar Container -->
                <div id="shift-assignment-calendar"></div>

                <!-- Shift Legend -->
                <div id="shift-legend" class="mt-3">
                    <div class="legend-item">
                        <div class="legend-color shift-type-default"></div>
                        <span>Default Shift (7AM-4PM)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color shift-type-night"></div>
                        <span>Night Shift (7PM-4AM)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color shift-type-open"></div>
                        <span>Open Shift</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this shift assignment? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Employee Search Modal -->
<div class="modal fade" id="employeeSearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Employees for Shift Assignment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="selectedDate">
                
                <!-- Department Filter -->
                <div class="mb-3">
                    <label class="form-label">Department</label>
                    <select class="form-select" id="modalDepartmentFilter">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Search Input -->
                <div class="mb-3">
                    <label class="form-label">Search Employee</label>
                    <input type="text" class="form-control" id="modalEmployeeSearch" 
                           placeholder="Search by name or employee number...">
                </div>

                <!-- Employee List -->
                <div class="employee-list" style="max-height: 400px; overflow-y: auto;">
                    <div id="modalEmployeeList">
                        {% for employee in employees %}
                        <div class="employee-item" data-department="{{ employee.department.id }}">
                            <div class="form-check">
                                <input class="form-check-input employee-checkbox" type="checkbox" 
                                       value="{{ employee.id }}" id="emp_{{ employee.id }}"
                                       data-fullname="{{ employee.get_full_name }}" 
                                       data-number="{{ employee.employee_number }}"
                                       data-department="{{ employee.department.name }}">
                                <label class="form-check-label" for="emp_{{ employee.id }}">
                                    {{ employee.get_full_name }} ({{ employee.employee_number }})
                                    <small class="text-muted">- {{ employee.department.name }}</small>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmEmployeeSelection">Assign Shift</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src="{% static 'attendance/js/shifts.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to apply filters
    function applyFilters() {
        const params = new URLSearchParams();
        
        // Get all filter values
        const department = document.getElementById('department-filter-list').value;
        const shift = document.getElementById('shift-filter-list').value;
        const status = document.getElementById('status-filter-list').value;
        const type = document.getElementById('type-filter-list').value;
        const startDate = document.getElementById('start-date-filter').value;
        const endDate = document.getElementById('end-date-filter').value;
        const search = document.getElementById('search-input-list').value;

        // Add non-empty values to params
        if (department) params.append('department', department);
        if (shift) params.append('shift', shift);
        if (status) params.append('status', status);
        if (type) params.append('type', type);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (search) params.append('search', search);

        // Redirect with filters
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    }

    // Add event listeners to all filters
    const filters = [
        'department-filter-list',
        'shift-filter-list',
        'status-filter-list',
        'type-filter-list',
        'start-date-filter',
        'end-date-filter'
    ];

    filters.forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', applyFilters);
    });

    // Search button click handler
    document.getElementById('search-btn-list').addEventListener('click', applyFilters);

    // Search input enter key handler
    document.getElementById('search-input-list').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });

    // Clear filters button handler
    document.getElementById('clear-filters-btn').addEventListener('click', function() {
        window.location.href = window.location.pathname;
    });

    // Date range validation
    const startDateInput = document.getElementById('start-date-filter');
    const endDateInput = document.getElementById('end-date-filter');

    startDateInput.addEventListener('change', function() {
        endDateInput.min = this.value;
    });

    endDateInput.addEventListener('change', function() {
        startDateInput.max = this.value;
    });

    // Add the confirmDelete function
    window.confirmDelete = function(assignmentId) {
        const modal = document.getElementById('deleteModal');
        const deleteForm = document.getElementById('deleteForm');
        
        // Set the form action URL
        deleteForm.action = `{% url 'attendance:shift_assignment_list' %}${assignmentId}/delete/`;
        
        // Show the modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
});
</script>
{% endblock %}
