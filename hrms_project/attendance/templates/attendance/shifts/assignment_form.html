{% extends 'attendance/base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link href="{% static 'attendance/css/shifts.css' %}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<style>
    .selected-employee {
        background-color: #f8f9fa;
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .employee-item {
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: background-color 0.2s;
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    .employee-item:hover {
        background-color: #f8f9fa;
    }
    .employee-item .form-check-input {
        margin-right: 10px;
        width: 18px;
        height: 18px;
    }
    .employee-item.checked {
        background-color: #e7f3ff;
    }
    .employee-search-results {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 0.5rem;
    }
    .select-buttons {
        border-bottom: 1px solid #dee2e6;
        padding: 10px;
        margin-bottom: 10px;
    }
    .select-buttons .btn {
        min-width: 100px;
    }
</style>
{% endblock %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">{{ form.id|yesno:"Edit,Create" }} Shift Assignment</h5>
    </div>
    <div class="card-body">
        <form method="post" id="shift-assignment-form">
            {% csrf_token %}
            
            <!-- Employee Selection -->
            <div class="mb-3">
                {% if form %}
                    <!-- Single employee selection for edit mode -->
                    <label class="form-label">Employee</label>
                    <select class="form-select" name="employee" id="employee" disabled>
                        <option value="{{ form.employee.id }}" selected>
                            {{ form.employee.get_full_name }} ({{ form.employee.employee_number }})
                        </option>
                    </select>
                    <input type="hidden" name="employee" value="{{ form.employee.id }}">
                {% else %}
                    <!-- Multiple employee selection for create mode -->
                    <label class="form-label">Select Employees</label>
                    <div class="d-flex align-items-center mb-2">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="employeeSearch" 
                                   placeholder="Search by name or employee number...">
                            <select class="form-select" id="departmentFilter" style="max-width: 200px;">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                    <option value="{{ dept.name }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="select-buttons">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="selectAll">
                            <i class="bi bi-check-all"></i> Select All
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="deselectAll">
                            <i class="bi bi-x-lg"></i> Deselect All
                        </button>
                    </div>

                    <div class="employee-search-results">
                        {% for employee in employees %}
                        <div class="employee-item" data-department="{{ employee.department.name }}">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input employee-checkbox" 
                                       id="emp_{{ employee.id }}" value="{{ employee.id }}"
                                       data-name="{{ employee.get_full_name }}"
                                       data-number="{{ employee.employee_number }}">
                                <label class="form-check-label" for="emp_{{ employee.id }}">
                                    {{ employee.get_full_name }} ({{ employee.employee_number }})
                                    <small class="text-muted">- {{ employee.department.name }}</small>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div id="selectedEmployees" class="mt-3">
                        <span class="text-muted">No employees selected</span>
                    </div>
                    <input type="hidden" name="employee[]" id="selectedEmployeeIds" required>
                {% endif %}
            </div>

            <!-- Shift Selection -->
            <div class="mb-3">
                <label class="form-label">Shift</label>
                <select class="form-select" name="shift" id="shift" required>
                    <option value="">Select Shift</option>
                    {% for shift in shifts %}
                        <option value="{{ shift.id }}" 
                                {% if form and form.shift.id == shift.id %}selected{% endif %}
                                data-shift-type="{{ shift.shift_type }}">
                            {{ shift.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Start Date -->
            <div class="mb-3">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" name="start_date" id="start_date" required
                       value="{{ form.start_date|date:'Y-m-d' }}">
            </div>

            <!-- End Date -->
            <div class="mb-3">
                <label class="form-label">End Date (Optional)</label>
                <input type="date" class="form-control" name="end_date" id="end_date"
                       value="{{ form.end_date|date:'Y-m-d' }}">
                <small class="text-muted">Leave blank for permanent assignment</small>
            </div>

            <!-- Active Status -->
            <div class="mb-3">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="is_active" id="is_active"
                           {% if not form or form.is_active %}checked{% endif %}>
                    <label class="form-check-label" for="is_active">Active</label>
                </div>
            </div>

            <!-- Night Shift Indicator -->
            <div id="night-shift-indicator" class="alert alert-info" style="display: none;">
                <i class="fas fa-moon"></i> This is a night shift assignment
            </div>

            <!-- Submit Buttons -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    {{ form.id|yesno:"Update,Create" }} Assignment
                </button>
                <a href="{% url 'attendance:shift_assignment_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize night shift indicator
    const shiftSelect = document.getElementById('shift');
    const nightShiftIndicator = document.getElementById('night-shift-indicator');
    
    function updateNightShiftIndicator() {
        if (!shiftSelect || !nightShiftIndicator) return;
        
        const selectedOption = shiftSelect.options[shiftSelect.selectedIndex];
        if (!selectedOption) return;
        
        const isNightShift = selectedOption.dataset.shiftType === 'NIGHT';
        nightShiftIndicator.style.display = isNightShift ? 'block' : 'none';
    }
    
    // Update indicator on load and change
    updateNightShiftIndicator();
    shiftSelect?.addEventListener('change', updateNightShiftIndicator);

    // Date validation
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');

    if (startDateInput && endDateInput) {
        startDateInput.addEventListener('change', function() {
            if (endDateInput.value && this.value > endDateInput.value) {
                endDateInput.value = this.value;
            }
            endDateInput.min = this.value;
        });

        endDateInput.addEventListener('change', function() {
            if (this.value && this.value < startDateInput.value) {
                this.value = startDateInput.value;
            }
        });
    }

    // Multiple employee selection functionality (only in create mode)
    if (!document.querySelector('form').dataset.editMode) {
        const searchInput = document.getElementById('employeeSearch');
        const departmentFilter = document.getElementById('departmentFilter');
        const employeeList = document.querySelector('.employee-search-results');
        const selectedEmployeesDiv = document.getElementById('selectedEmployees');
        const selectedEmployeeIds = document.getElementById('selectedEmployeeIds');
        const selectAllBtn = document.getElementById('selectAll');
        const deselectAllBtn = document.getElementById('deselectAll');

        // Handle employee filtering
        function filterEmployees() {
            const searchTerm = searchInput.value.toLowerCase();
            const department = departmentFilter.value;

            document.querySelectorAll('.employee-item').forEach(item => {
                const label = item.querySelector('.form-check-label');
                const text = label.textContent.toLowerCase();
                const empDepartment = item.dataset.department;
                
                const matchesSearch = text.includes(searchTerm);
                const matchesDepartment = !department || empDepartment === department;
                
                item.style.display = matchesSearch && matchesDepartment ? '' : 'none';
            });
        }

        // Update selected employees display
        function updateSelectedEmployees() {
            const selectedEmployees = [];
            let html = '';
            
            document.querySelectorAll('.employee-checkbox:checked').forEach(checkbox => {
                selectedEmployees.push({
                    id: checkbox.value,
                    name: checkbox.dataset.name,
                    number: checkbox.dataset.number
                });
            });

            if (selectedEmployees.length > 0) {
                selectedEmployees.forEach(emp => {
                    html += `
                        <div class="selected-employee d-flex justify-content-between align-items-center">
                            <span>${emp.name} (${emp.number})</span>
                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                    onclick="removeEmployee('${emp.id}')">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>`;
                });
            } else {
                html = '<span class="text-muted">No employees selected</span>';
            }

            selectedEmployeesDiv.innerHTML = html;
            selectedEmployeeIds.value = selectedEmployees.map(emp => emp.id).join(',');
        }

        // Event listeners
        searchInput?.addEventListener('input', filterEmployees);
        departmentFilter?.addEventListener('change', filterEmployees);
        
        selectAllBtn?.addEventListener('click', function() {
            const visibleCheckboxes = Array.from(document.querySelectorAll('.employee-checkbox')).filter(checkbox => 
                checkbox.closest('.employee-item').style.display !== 'none'
            );
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('.employee-item').classList.add('checked');
            });
            updateSelectedEmployees();
        });

        deselectAllBtn?.addEventListener('click', function() {
            document.querySelectorAll('.employee-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.employee-item').classList.remove('checked');
            });
            updateSelectedEmployees();
        });

        employeeList?.addEventListener('change', function(e) {
            if (e.target.classList.contains('employee-checkbox')) {
                const item = e.target.closest('.employee-item');
                if (e.target.checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
                updateSelectedEmployees();
            }
        });

        // Function to remove an employee from selection
        window.removeEmployee = function(employeeId) {
            const checkbox = document.getElementById('emp_' + employeeId);
            if (checkbox) {
                checkbox.checked = false;
                checkbox.closest('.employee-item').classList.remove('checked');
                updateSelectedEmployees();
            }
        };
    }
});
</script>
{% endblock %}
