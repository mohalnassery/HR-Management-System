{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Daily Attendance</h5>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#reprocessModal">
                    <i class="fas fa-sync"></i> Reprocess Attendance
                </button>
                <a href="{% url 'attendance:upload_attendance' %}" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Upload Attendance
                </a>
            </div>

            <!-- Reprocess Modal -->
            <div class="modal fade" id="reprocessModal" tabindex="-1" aria-labelledby="reprocessModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="{% url 'attendance:reprocess_attendance' %}">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="reprocessModalLabel">Reprocess Attendance</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Date Range</label>
                                    <div class="row">
                                        <div class="col">
                                            <input type="date" name="start_date" class="form-control" required>
                                        </div>
                                        <div class="col">
                                            <input type="date" name="end_date" class="form-control" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Employee (Optional)</label>
                                    <select name="employee_id" class="form-select">
                                        <option value="">All Employees</option>
                                    </select>
                                </div>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> This will recalculate attendance statuses based on current rules. Please use with caution.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-sync"></i> Reprocess
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="start-date">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="end-date">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="department-filter">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="status-filter">
                    <option value="">All Status</option>
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                    <option value="late">Late</option>
                    <option value="leave">Leave</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="search-input" placeholder="Search employees...">
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Present</h5>
                        <h2 class="mb-0" id="present-count">{{ present_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Absent</h5>
                        <h2 class="mb-0" id="absent-count">{{ absent_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h5 class="card-title">Late</h5>
                        <h2 class="mb-0" id="late-count">{{ late_count }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">On Leave</h5>
                        <h2 class="mb-0" id="leave-count">{{ on_leave_count }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="attendance-table">
                <thead>
                    <tr>
                        <th>Personnel ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Date</th>
                        <th>First In</th>
                        <th>Last Out</th>
                        <th>Status</th>
                        <th>Source</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="attendance-logs">
                    <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated dynamically -->
            </ul>
        </nav>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start-date').value = today;
    document.getElementById('end-date').value = today;

    // Initial load of attendance data
    fetchAttendanceLogs(1);

    // Add event listeners for filters
    const filters = ['start-date', 'end-date', 'department-filter', 'status-filter', 'search-input'];
    filters.forEach(id => {
        const element = document.getElementById(id);
        element.addEventListener(id === 'search-input' ? 'input' : 'change', () => {
            fetchAttendanceLogs(1);
        });
    });

    // Initialize employee select in reprocess modal
    const employeeSelect = document.querySelector('#reprocessModal select[name="employee_id"]');
    employeeSelect.addEventListener('focus', function() {
        if (!this.dataset.loaded) {
            fetch('{% url "attendance:get_department_employees" %}')
                .then(response => response.json())
                .then(data => {
                    const options = data.employees.map(emp => 
                        `<option value="${emp.id}">${emp.name}</option>`
                    ).join('');
                    this.innerHTML += options;
                    this.dataset.loaded = 'true';
                })
                .catch(error => console.error('Error loading employees:', error));
        }
    });

    // Automatically populate reprocess date range with current filter values
    document.querySelector('[data-bs-target="#reprocessModal"]').addEventListener('click', function() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (startDate) {
            document.querySelector('#reprocessModal input[name="start_date"]').value = startDate;
        }
        if (endDate) {
            document.querySelector('#reprocessModal input[name="end_date"]').value = endDate;
        }
    });
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function fetchAttendanceLogs(page = 1) {
    // Ensure page is a number
    if (typeof page !== 'number') {
        page = 1;
    }

    const params = new URLSearchParams({
        start_date: document.getElementById('start-date').value || '',
        end_date: document.getElementById('end-date').value || '',
        department: document.getElementById('department-filter').value || '',
        status: document.getElementById('status-filter').value || '',
        search: document.getElementById('search-input').value || '',
        page: page.toString()
    });

    fetch(`/attendance/api/logs/?${params}`, {
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Update summary counts
        document.getElementById('present-count').textContent = data.summary?.present || 0;
        document.getElementById('absent-count').textContent = data.summary?.absent || 0;
        document.getElementById('late-count').textContent = data.summary?.late || 0;
        document.getElementById('leave-count').textContent = data.summary?.leave || 0;

        // Update table content
        const tbody = document.getElementById('attendance-logs');
        tbody.innerHTML = data.results.map(log => `
            <tr>
                <td>${log.personnel_id || '-'}</td>
                <td>
                    <a href="/employees/${log.employee_id}/" class="text-decoration-none">
                        ${log.employee_name || '-'}
                    </a>
                </td>
                <td>${log.department || '-'}</td>
                <td id="log-date-${log.id}">${formatDate(log.date) || '-'}</td>
                <td>${formatTime(log.first_in_time) || '-'}</td>
                <td>${formatTime(log.last_out_time) || '-'}</td>
                <td>
                    <span class="badge ${getStatusBadgeClass(getStatusText(log))}">
                        ${getStatusText(log)}
                    </span>
                </td>
                <td>${log.source || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" 
                            onclick="viewDetails('${log.id}', '${log.personnel_id || ''}', '${log.date}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        updatePagination(data);
    })
    .catch(error => {
        console.error('Error fetching attendance logs:', error);
        const tbody = document.getElementById('attendance-logs');
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-danger">
                    Error loading attendance data. Please try again.
                </td>
            </tr>
        `;
    });
}

function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

function formatTime(timeString) {
    if (!timeString) return null;
    const date = new Date(`2000-01-01T${timeString}`);
    return date.toLocaleTimeString(undefined, { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
}

function getStatusText(log) {
    if (!log.first_in_time) return 'Absent';
    if (log.is_late) return 'Late';
    return 'Present';
}

function getStatusBadgeClass(status) {
    switch (status.toLowerCase()) {
        case 'present':
            return 'bg-success';
        case 'absent':
            return 'bg-danger';
        case 'late':
            return 'bg-warning text-dark';
        case 'leave':
            return 'bg-info';
        default:
            return 'bg-secondary';
    }
}

function updatePagination(data) {
    const pagination = document.getElementById('pagination');
    if (!data.count) {
        pagination.innerHTML = '';
        return;
    }

    // Use the page size from the response or default to 400
    const pageSize = data.results.length || 400;
    const totalPages = Math.ceil(data.count / pageSize);
    const currentPage = parseInt(new URLSearchParams(window.location.search).get('page')) || 1;

    let paginationHtml = '';
    
    // Previous button
    paginationHtml += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="fetchAttendanceLogs(${currentPage - 1}); return false;">Previous</a>
        </li>
    `;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHtml += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="fetchAttendanceLogs(${i}); return false;">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }

    // Next button
    paginationHtml += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="fetchAttendanceLogs(${currentPage + 1}); return false;">Next</a>
        </li>
    `;

    pagination.innerHTML = paginationHtml;
}

function viewDetails(logId, personnelId, date) {
    if (!personnelId || !date) {
        console.error('Missing required parameters for viewDetails');
        return;
    }
    window.location.href = `{% url 'attendance:attendance_detail' %}?personnel_id=${personnelId}&date=${date}`;
}
</script>
{% endblock %}
