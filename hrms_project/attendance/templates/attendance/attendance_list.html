{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Daily Attendance</h5>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-upload"></i> Upload Attendance
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="start-date">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="end-date">
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="department-filter">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="status-filter">
                    <option value="">All Status</option>
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                    <option value="late">Late</option>
                    <option value="leave">Leave</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="search-input" placeholder="Search employees...">
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6 class="card-title">Present</h6>
                        <h3 class="card-text" id="present-count">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h6 class="card-title">Absent</h6>
                        <h3 class="card-text" id="absent-count">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning">
                    <div class="card-body">
                        <h6 class="card-title">Late</h6>
                        <h3 class="card-text" id="late-count">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-title">On Leave</h6>
                        <h3 class="card-text" id="leave-count">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="attendance-table">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Date</th>
                        <th>First In</th>
                        <th>Last Out</th>
                        <th>Status</th>
                        <th>Source</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination will be generated dynamically -->
            </ul>
        </nav>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Attendance Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="upload-form">
                    <div class="mb-3">
                        <label class="form-label">Select Excel File</label>
                        <input type="file" class="form-control" id="attendance-file" accept=".xlsx,.xls">
                        <small class="form-text text-muted">
                            Please upload Excel file with the required format
                        </small>
                    </div>
                </form>
                <div id="upload-progress" class="progress d-none">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="upload-btn">Upload</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block footer_scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default date range
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('start-date').value = today;
    document.getElementById('end-date').value = today;

    // Initial load
    loadAttendanceData();

    // Event listeners for filters
    document.getElementById('start-date').addEventListener('change', loadAttendanceData);
    document.getElementById('end-date').addEventListener('change', loadAttendanceData);
    document.getElementById('department-filter').addEventListener('change', loadAttendanceData);
    document.getElementById('status-filter').addEventListener('change', loadAttendanceData);
    
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadAttendanceData, 500);
    });

    // File upload handling
    document.getElementById('upload-btn').addEventListener('click', function() {
        const fileInput = document.getElementById('attendance-file');
        if (!fileInput.files[0]) {
            alert('Please select a file to upload');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        // Show progress bar
        const progressBar = document.querySelector('#upload-progress');
        progressBar.classList.remove('d-none');

        fetch('/api/attendance/records/upload_excel/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            alert(`Successfully processed ${data.records_created} records`);
            loadAttendanceData();
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
        })
        .catch(error => {
            alert('Error uploading file: ' + error.message);
        })
        .finally(() => {
            progressBar.classList.add('d-none');
            fileInput.value = '';
        });
    });
});

function loadAttendanceData(page = 1) {
    const params = new URLSearchParams({
        start_date: document.getElementById('start-date').value,
        end_date: document.getElementById('end-date').value,
        department: document.getElementById('department-filter').value,
        status: document.getElementById('status-filter').value,
        search: document.getElementById('search-input').value,
        page: page
    });

    fetch(`/api/attendance/logs/?${params}`)
        .then(response => response.json())
        .then(data => {
            updateTable(data.results);
            updatePagination(data.total_pages, data.current_page);
            updateSummary(data.summary);
        })
        .catch(error => console.error('Error:', error));
}

function updateTable(records) {
    const tbody = document.querySelector('#attendance-table tbody');
    tbody.innerHTML = records.map(record => `
        <tr>
            <td>${record.employee_number}</td>
            <td>${record.employee_name}</td>
            <td>${record.department}</td>
            <td>${record.date}</td>
            <td>${record.first_in_time}</td>
            <td>${record.last_out_time}</td>
            <td>
                <span class="badge bg-${getStatusBadgeClass(record.status)}">
                    ${record.status}
                </span>
            </td>
            <td>${record.source}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editAttendance(${record.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function updatePagination(totalPages, currentPage) {
    const pagination = document.getElementById('pagination');
    let html = '';

    if (totalPages > 1) {
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadAttendanceData(${currentPage - 1})">Previous</a>
            </li>
        `;

        for (let i = 1; i <= totalPages; i++) {
            html += `
                <li class="page-item ${currentPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadAttendanceData(${i})">${i}</a>
                </li>
            `;
        }

        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadAttendanceData(${currentPage + 1})">Next</a>
            </li>
        `;
    }

    pagination.innerHTML = html;
}

function updateSummary(summary) {
    document.getElementById('present-count').textContent = summary.present || 0;
    document.getElementById('absent-count').textContent = summary.absent || 0;
    document.getElementById('late-count').textContent = summary.late || 0;
    document.getElementById('leave-count').textContent = summary.leave || 0;
}

function getStatusBadgeClass(status) {
    const classes = {
        'present': 'success',
        'absent': 'danger',
        'late': 'warning',
        'leave': 'info',
        'holiday': 'primary'
    };
    return classes[status] || 'secondary';
}

function editAttendance(id) {
    // Show edit modal with attendance details
    fetch(`/api/attendance/logs/${id}/`)
        .then(response => response.json())
        .then(data => {
            // This will trigger the edit modal defined in calendar.html
            showAttendanceDetails(id);
        })
        .catch(error => console.error('Error:', error));
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}