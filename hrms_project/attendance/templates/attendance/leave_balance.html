{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
{% if user.is_staff %}
<!-- Employee Selection Form -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-user"></i> Select Employee
        </h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Department</label>
                <select class="form-select" id="department" name="department">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>
                        {{ dept.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search Employee</label>
                <input type="text" class="form-control" name="search" placeholder="Name or Employee Number" value="{{ request.GET.search }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Employee</label>
                <select class="form-select" id="employee" name="employee">
                    <option value="">Select Employee</option>
                    {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if selected_employee == emp.id|stringformat:"s" %}selected{% endif %}>
                        {{ emp.employee_number }} - {{ emp.get_full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-balance-scale"></i> Leave Balances
        </h5>
    </div>
    <div class="card-body">
        {% if user.is_staff %}
        <div class="mb-4">
            <h6 class="mb-3">Import Beginning Balances</h6>
            <form method="post" enctype="multipart/form-data" class="row g-3">
                {% csrf_token %}
                <div class="col-md-4">
                    {{ form.csv_file.label_tag }}
                    {{ form.csv_file }}
                    <small class="text-muted">{{ form.csv_file.help_text }}</small>
                </div>
                <div class="col-md-4">
                    {{ form.as_of_date.label_tag }}
                    {{ form.as_of_date }}
                    <small class="text-muted">{{ form.as_of_date.help_text }}</small>
                </div>
                {{ form.leave_type_code }}
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
        {% endif %}

        {% if beginning_balances %}
        <div class="mb-4">
            <h6 class="mb-3">Beginning Balances</h6>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            {% if user.is_staff %}
                            <th>Employee</th>
                            {% endif %}
                            <th>Leave Type</th>
                            <th>Balance Days</th>
                            <th>As of Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for balance in beginning_balances %}
                        <tr>
                            {% if user.is_staff %}
                            <td>{{ balance.employee.get_full_name }}</td>
                            {% endif %}
                            <td>{{ balance.leave_type.name }}</td>
                            <td>{{ balance.balance_days }}</td>
                            <td>{{ balance.as_of_date }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        <div class="row">
            {% for balance in balances %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">{{ balance.leave_type.name }}</h6>
                        <div class="progress mb-3" style="height: 20px;">
                            {% if balance.total_days > 0 %}
                                {% widthratio balance.used_days balance.total_days 100 as used_percentage %}
                                {% widthratio balance.pending_days balance.total_days 100 as pending_percentage %}
                                {% with total_percentage=used_percentage|add:pending_percentage %}
                                <div class="progress-bar {% if total_percentage > 75 %}bg-danger{% elif total_percentage > 50 %}bg-warning{% else %}bg-success{% endif %}"
                                     role="progressbar"
                                     style="width: {{ used_percentage }}%"
                                     aria-valuenow="{{ used_percentage }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {{ used_percentage }}%
                                </div>
                                {% if balance.pending_days > 0 %}
                                <div class="progress-bar bg-secondary"
                                     role="progressbar"
                                     style="width: {{ pending_percentage }}%"
                                     aria-valuenow="{{ pending_percentage }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {{ pending_percentage }}%
                                </div>
                                {% endif %}
                                {% endwith %}
                            {% else %}
                                <div class="progress-bar bg-success"
                                     role="progressbar"
                                     style="width: 0%"
                                     aria-valuenow="0"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    0%
                                </div>
                            {% endif %}
                        </div>
                        <div class="row text-center">
                            <div class="col">
                                <small class="text-muted d-block">Total</small>
                                <strong>{{ balance.total_days|floatformat:2 }}</strong>
                            </div>
                            <div class="col">
                                <small class="text-muted d-block">Used</small>
                                <strong>{{ balance.used_days|floatformat:2 }}</strong>
                            </div>
                            <div class="col">
                                <small class="text-muted d-block">Pending</small>
                                <strong>{{ balance.pending_days|floatformat:2 }}</strong>
                            </div>
                            <div class="col">
                                <small class="text-muted d-block">Available</small>
                                <strong>{{ balance.available_days|floatformat:2 }}</strong>
                            </div>
                        </div>
                        {% if balance.leave_type.description %}
                        <div class="mt-3">
                            <small class="text-muted">{{ balance.leave_type.description }}</small>
                        </div>
                        {% elif balance.leave_type.code == 'ANNUAL' %}
                        <div class="mt-3">
                            <small class="text-muted">Annual leave accrued at 2.5 days per 30 working days (0.083 days per working day)</small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-grid">
                            <a href="{% url 'attendance:leave_request_create' %}?type={{ balance.leave_type.id }}" 
                               class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-plus"></i> Apply for {{ balance.leave_type.name }}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="alert alert-info">
                    No leave balances found.
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
