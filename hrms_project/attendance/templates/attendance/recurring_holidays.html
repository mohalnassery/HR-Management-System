{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Recurring Holidays</h5>
        <div>
            <button id="generate-next-year" class="btn btn-success">
                <i class="fas fa-sync"></i> Generate Next Year's Holidays
            </button>
            <a href="{% url 'attendance:holiday_create' %}?recurring=true" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Recurring Holiday
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label class="form-label">Holiday Type</label>
                <select class="form-select" id="type-filter">
                    <option value="">All Types</option>
                    <option value="PUBLIC">Public Holiday</option>
                    <option value="COMPANY">Company Holiday</option>
                    <option value="OPTIONAL">Optional Holiday</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-primary" id="apply-filters">Apply Filters</button>
            </div>
        </div>

        <!-- Holiday Table -->
        <div class="table-responsive">
            <table class="table table-hover" id="recurring-holidays-table">
                <thead>
                    <tr>
                        <th>Date Pattern</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Last Generated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for holiday in holidays %}
                    <tr>
                        <td>{{ holiday.date|date:"d M" }} <em class="text-muted">(yearly)</em></td>
                        <td>{{ holiday.name }}</td>
                        <td>
                            <span class="badge bg-{{ holiday.holiday_type|lower }}">
                                {{ holiday.get_holiday_type_display }}
                            </span>
                        </td>
                        <td>
                            {% if holiday.last_generated %}
                            {{ holiday.last_generated|date:"d M Y" }}
                            {% else %}
                            <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'attendance:holiday_edit' pk=holiday.id %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-danger delete-holiday" data-id="{{ holiday.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No recurring holidays defined</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1">&laquo; First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last &raquo;</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this recurring holiday?</p>
                <p class="text-danger"><strong>Note:</strong> This will not delete any already generated holiday instances.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Generation Confirmation Modal -->
<div class="modal fade" id="generateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Next Year's Holidays</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will generate holiday entries for next year based on recurring holidays.</p>
                <div id="generation-preview">
                    <h6>Holidays to be generated:</h6>
                    <ul id="preview-list"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmGenerate">Generate</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
$(document).ready(function() {
    let deleteId = null;

    // Delete holiday
    $('.delete-holiday').click(function() {
        deleteId = $(this).data('id');
        $('#deleteModal').modal('show');
    });

    $('#confirmDelete').click(function() {
        if (deleteId) {
            $.ajax({
                url: `/attendance/holiday/${deleteId}/delete/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                success: function() {
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error deleting holiday');
                }
            });
        }
        $('#deleteModal').modal('hide');
    });

    // Generate next year's holidays
    $('#generate-next-year').click(function() {
        // First get preview
        $.ajax({
            url: '{% url "attendance:preview_next_year_holidays" %}',
            type: 'GET',
            success: function(data) {
                const previewList = $('#preview-list');
                previewList.empty();
                
                data.holidays.forEach(function(holiday) {
                    const li = $('<li>').text(
                        `${holiday.name} - ${holiday.date} - ${holiday.type}`
                    );
                    previewList.append(li);
                });
                
                $('#generateModal').modal('show');
            },
            error: function() {
                alert('Error loading preview');
            }
        });
    });

    $('#confirmGenerate').click(function() {
        $.ajax({
            url: '{% url "attendance:generate_next_year_holidays" %}',
            type: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            success: function(data) {
                $('#generateModal').modal('hide');
                alert(`Successfully generated ${data.count} holidays for next year`);
                location.reload();
            },
            error: function() {
                alert('Error generating holidays');
            }
        });
    });

    // Apply filters
    $('#apply-filters').click(function() {
        const type = $('#type-filter').val();
        window.location.href = `?type=${type}`;
    });
});
</script>
{% endblock %}
