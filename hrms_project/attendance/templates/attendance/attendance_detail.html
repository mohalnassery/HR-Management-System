{% extends 'attendance/base.html' %}
{% load static %}

{% block attendance_content %}
[Previous content remains the same until script block]

{% block extra_js %}
<script>
// Initialize variables from Django template
const attendanceId = {% if attendance %}{{ attendance.id }}{% else %}null{% endif %};
const initialInTime = {% if stats.first_in %}'{{ stats.first_in|time:"H:i" }}'{% else %}''{% endif %};
const initialOutTime = {% if stats.last_out %}'{{ stats.last_out|time:"H:i" }}'{% else %}''{% endif %};

document.addEventListener('DOMContentLoaded', function() {
    // Set initial values in edit form
    if (initialInTime) {
        document.getElementById('edit-in-time').value = initialInTime;
    }
    if (initialOutTime) {
        document.getElementById('edit-out-time').value = initialOutTime;
    }
});

function editTimes() {
    const modal = new bootstrap.Modal(document.getElementById('editLogModal'));
    modal.show();
}

function saveEdit() {
    if (!attendanceId) {
        alert('No attendance record found');
        return;
    }

    const inTime = document.getElementById('edit-in-time').value;
    const outTime = document.getElementById('edit-out-time').value;
    const reason = document.getElementById('edit-reason').value;

    if (!inTime || !outTime || !reason) {
        alert('Please fill in all fields');
        return;
    }

    fetch(`/attendance/api/attendance/${attendanceId}/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            first_in_time: inTime,
            last_out_time: outTime,
            edit_reason: reason
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to update attendance');
        return response.json();
    })
    .then(() => {
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update attendance');
    });
}
</script>
{% endblock %}
