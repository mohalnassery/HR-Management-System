{% extends "employees/base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ title }} - {{ employee.get_full_name }}{% endblock %}

{% block extra_head %}
<style>
    .document-section {
        margin: 20px 0;
    }
    .method-buttons {
        margin-bottom: 15px;
    }
    .method-button {
        padding: 8px 16px;
        margin-right: 10px;
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    .method-button.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
    }
    .scan-content, .scan-preview {
        display: none;
    }
    .scan-preview {
        margin-top: 15px;
    }
    .scan-preview h5 {
        margin-bottom: 10px;
    }
    .preview-images {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 15px;
    }
    .preview-image-container {
        flex: 0 0 calc(50% - 7.5px);
        position: relative;
    }
    .preview-image-container img {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
    }
    .page-number {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 12px;
    }
    .spinner {
        display: none;
        margin-left: 5px;
    }
    .scan-options {
        margin: 15px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    .scan-options label {
        margin-bottom: 0;
        cursor: pointer;
    }
    .scan-mode {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .scan-instructions {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background: #e9ecef;
        border-radius: 4px;
        color: #495057;
    }
    .scan-instructions.active {
        display: block;
    }
    .scan-side-indicator {
        font-weight: bold;
        color: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ title }} - {{ employee.get_full_name }}</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="document-form">
                        {% csrf_token %}
                        
                        <!-- Form fields except document -->
                        {% for field in form %}
                            {% if field.name != 'document' %}
                                {{ field|as_crispy_field }}
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Document section -->
                        <div class="document-section">
                            <label>Document file</label>
                            
                            <!-- Method buttons -->
                            <div class="method-buttons">
                                <button type="button" class="method-button active" data-method="upload">
                                    <i class="fas fa-upload"></i> Upload File
                                </button>
                                <button type="button" class="method-button" data-method="scan">
                                    <i class="fas fa-scanner"></i> Scan Document
                                </button>
                            </div>
                            
                            <!-- Upload content -->
                            <div class="upload-content">
                                {% for field in form %}
                                    {% if field.name == 'document' %}
                                        {{ field|as_crispy_field }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <!-- Scan content -->
                            <div class="scan-content">
                                <div class="scan-options">
                                    <div class="scan-mode">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scanMode" id="singleSide" value="single" checked>
                                            <label class="form-check-label" for="singleSide">
                                                Single Side
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scanMode" id="twoSides" value="double">
                                            <label class="form-check-label" for="twoSides">
                                                Two Sides (Manual Flip)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="scanMode" id="useFeeder" value="feeder">
                                            <label class="form-check-label" for="useFeeder">
                                                Document Feeder (Multiple Pages)
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="twoSideInstructions" class="scan-instructions" data-side="front">
                                        <p class="mb-2">
                                            <span class="scan-side-indicator">Front Side:</span> 
                                            Place the document with the front side facing down on the scanner.
                                        </p>
                                    </div>
                                    <div id="twoSideInstructionsBack" class="scan-instructions" data-side="back">
                                        <p class="mb-2">
                                            <span class="scan-side-indicator">Back Side:</span> 
                                            Place the document with the back side facing down on the scanner.
                                        </p>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-primary" onclick="startScanning()">
                                    Start Scanning
                                    <span class="spinner">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                </button>
                                
                                <div class="scan-preview">
                                    <h5>Scanned Document Preview</h5>
                                    <div class="preview-images"></div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <a href="{% url 'employees:employee_detail' employee.pk %}" class="btn btn-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary">Save Document</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentSide = 'front';
    let frontImage = null;
    let backImage = null;
    let isWindows = false;

    // Get system information when page loads
    fetch('/employees/system-info/')
        .then(response => response.json())
        .then(data => {
            isWindows = data.platform === 'Windows';
            // Hide scanner option if not on Windows
            if (!isWindows) {
                document.querySelector('[data-method="scan"]').style.display = 'none';
            }
        });

    function selectMethod(method) {
        // Reset all buttons and content sections
        document.querySelectorAll('.method-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.upload-content').style.display = 'none';
        document.querySelector('.scan-content').style.display = 'none';
        document.querySelector('.scan-preview').style.display = 'none';

        // Activate selected method
        document.querySelector(`[data-method="${method}"]`).classList.add('active');
        if (method === 'upload') {
            document.querySelector('.upload-content').style.display = 'block';
        } else if (method === 'scan' && isWindows) {
            document.querySelector('.scan-content').style.display = 'block';
            updateScanInstructions();
        }
    }

    function updateScanInstructions() {
        // Update scan instructions based on current side
        document.querySelectorAll('.scan-instructions').forEach(instr => {
            instr.classList.remove('active');
        });
        document.querySelector(`.scan-instructions[data-side="${currentSide}"]`).classList.add('active');
        document.querySelector('.scan-side-indicator').textContent = currentSide.charAt(0).toUpperCase() + currentSide.slice(1);
    }

    // Add event listeners for scan mode changes
    document.querySelectorAll('input[name="scanMode"]').forEach(radio => {
        radio.addEventListener('change', () => {
            currentSide = 'front';
            updateScanInstructions();
        });
    });

    async function startScanning() {
        if (!isWindows) {
            alert('Scanner functionality is only available on Windows systems.');
            return;
        }

        const useFeeder = document.querySelector('input[name="scanMode"]:checked').value === 'feeder';
        const spinner = document.querySelector('.spinner');
        const previewSection = document.querySelector('.scan-preview');
        const previewImages = document.querySelector('.preview-images');

        try {
            spinner.style.display = 'inline-block';
            
            const response = await fetch(`/employees/scan/${employee.pk}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    useFeeder: useFeeder
                })
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to scan document');
            }

            // Clear previous preview
            previewImages.innerHTML = '';
            
            // Display scanned images
            data.images.forEach((image, index) => {
                const container = document.createElement('div');
                container.className = 'preview-image-container';
                
                const img = document.createElement('img');
                img.src = image.data;
                img.alt = `Scanned page ${index + 1}`;
                
                const pageNumber = document.createElement('div');
                pageNumber.className = 'page-number';
                pageNumber.textContent = `Page ${index + 1}`;
                
                container.appendChild(img);
                container.appendChild(pageNumber);
                previewImages.appendChild(container);
            });
            
            previewSection.style.display = 'block';
            
        } catch (error) {
            alert(error.message);
        } finally {
            spinner.style.display = 'none';
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        selectMethod('upload');
        updateScanInstructions();
    });
</script>
{% endblock %}
