{% extends "employees/base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ title }} - {{ employee.get_full_name }}{% endblock %}

{% block extra_head %}
<style>
    .document-section {
        margin: 20px 0;
    }
    .method-buttons {
        margin-bottom: 15px;
    }
    .method-button {
        padding: 8px 16px;
        margin-right: 10px;
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    .method-button.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
    }
    .scan-content, .scan-preview {
        display: none;
    }
    .scan-preview {
        margin-top: 15px;
    }
    .scan-preview h5 {
        margin-bottom: 10px;
    }
    #preview-image {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
    }
    .spinner {
        display: none;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ title }} - {{ employee.get_full_name }}</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="document-form">
                        {% csrf_token %}
                        
                        <!-- Form fields except document -->
                        {% for field in form %}
                            {% if field.name != 'document' %}
                                {{ field|as_crispy_field }}
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Document section -->
                        <div class="document-section">
                            <label>Document file</label>
                            
                            <!-- Method buttons -->
                            <div class="method-buttons">
                                <button type="button" class="method-button active" onclick="selectMethod('upload')">
                                    <i class="fas fa-upload"></i> Upload File
                                </button>
                                <button type="button" class="method-button" onclick="selectMethod('scan')">
                                    <i class="fas fa-scanner"></i> Scan Document
                                </button>
                            </div>
                            
                            <!-- Upload content -->
                            <div class="upload-content">
                                {% for field in form %}
                                    {% if field.name == 'document' %}
                                        {{ field|as_crispy_field }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <!-- Scan content -->
                            <div class="scan-content">
                                <button type="button" class="btn btn-primary" onclick="startScanning()">
                                    Start Scanning
                                    <span class="spinner">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                </button>
                                
                                <div class="scan-preview">
                                    <h5>Scanned Document Preview</h5>
                                    <img id="preview-image" alt="Scanned preview">
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <a href="{% url 'employees:employee_detail' employee.pk %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Document</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function selectMethod(method) {
    // Update buttons
    document.querySelectorAll('.method-button').forEach(btn => {
        btn.classList.remove('active');
    });
    const selectedBtn = method === 'upload' ? 
        document.querySelector('.method-button:first-child') :
        document.querySelector('.method-button:last-child');
    selectedBtn.classList.add('active');
    
    // Show/hide content
    const uploadContent = document.querySelector('.upload-content');
    const scanContent = document.querySelector('.scan-content');
    const scanPreview = document.querySelector('.scan-preview');
    
    if (method === 'upload') {
        uploadContent.style.display = 'block';
        scanContent.style.display = 'none';
        scanPreview.style.display = 'none';
    } else {
        uploadContent.style.display = 'none';
        scanContent.style.display = 'block';
    }
}

async function startScanning() {
    const scanBtn = document.querySelector('.scan-content button');
    const spinner = scanBtn.querySelector('.spinner');
    const preview = document.getElementById('preview-image');
    const previewContainer = document.querySelector('.scan-preview');
    
    try {
        // Show loading state
        scanBtn.disabled = true;
        spinner.style.display = 'inline-block';
        
        // Call our scanning endpoint
        const response = await fetch('{% url "employees:scan_document" employee.pk %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to scan document');
        }
        
        const data = await response.json();
        
        // Update the preview
        preview.src = data.image_data;
        previewContainer.style.display = 'block';
        
        // Update the file input
        const fileInput = document.querySelector('input[type="file"]');
        const response2 = await fetch(data.image_data);
        const blob = await response2.blob();
        const file = new File([blob], "scanned_document.jpg", { type: "image/jpeg" });
        
        // Create a new FileList containing our scanned file
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        
    } catch (error) {
        alert('Error while scanning: ' + error.message);
        console.error(error);
    } finally {
        // Reset loading state
        scanBtn.disabled = false;
        spinner.style.display = 'none';
    }
}

// Prevent auto-scanning by removing any automatic initialization
document.addEventListener('DOMContentLoaded', function() {
    // Just initialize the upload method as active
    selectMethod('upload');
});
</script>
{% endblock %}
