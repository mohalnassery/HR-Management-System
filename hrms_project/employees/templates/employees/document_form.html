{% extends "employees/base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ title }} - {{ employee.get_full_name }}{% endblock %}

{% block extra_head %}
<style>
    .document-section {
        margin: 20px 0;
    }
    .method-buttons {
        margin-bottom: 15px;
    }
    .method-button {
        padding: 8px 16px;
        margin-right: 10px;
        border: 1px solid #ccc;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    .method-button.active {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
    }
    .scan-content, .scan-preview {
        display: none;
    }
    .scan-preview {
        margin-top: 15px;
    }
    .scan-preview h5 {
        margin-bottom: 10px;
    }
    .preview-images {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 15px;
    }
    .preview-image-container {
        flex: 0 0 calc(50% - 7.5px);
        position: relative;
    }
    .preview-image-container img {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
    }
    .page-number {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 12px;
    }
    .spinner {
        display: none;
        margin-left: 5px;
    }
    .scan-options {
        margin: 15px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    .scan-options label {
        margin-bottom: 0;
        cursor: pointer;
    }
    .scan-mode {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .scan-instructions {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background: #e9ecef;
        border-radius: 4px;
        color: #495057;
    }
    .scan-instructions.active {
        display: block;
    }
    .scan-side-indicator {
        font-weight: bold;
        color: #0056b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ title }} - {{ employee.get_full_name }}</h2>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="document-form">
                        {% csrf_token %}
                        
                        <!-- Form fields except document -->
                        {% for field in form %}
                            {% if field.name != 'document' %}
                                {{ field|as_crispy_field }}
                            {% endif %}
                        {% endfor %}
                        
                        <!-- Document section -->
                        <div class="document-section">
                            <label>Document file</label>
                            
                            <!-- Method buttons -->
                            <div class="method-buttons">
                                <button type="button" class="method-button active" onclick="selectMethod('upload')">
                                    <i class="fas fa-upload"></i> Upload File
                                </button>
                                <button type="button" class="method-button" onclick="selectMethod('scan')">
                                    <i class="fas fa-scanner"></i> Scan Document
                                </button>
                            </div>
                            
                            <!-- Upload content -->
                            <div class="upload-content">
                                {% for field in form %}
                                    {% if field.name == 'document' %}
                                        {{ field|as_crispy_field }}
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <!-- Scan content -->
                            <div class="scan-content">
                                <div class="scan-options">
                                    <div class="scan-mode">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scanMode" id="singleSide" value="single" checked>
                                            <label class="form-check-label" for="singleSide">
                                                Single Side
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="scanMode" id="twoSides" value="double">
                                            <label class="form-check-label" for="twoSides">
                                                Two Sides (Manual Flip)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="scanMode" id="useFeeder" value="feeder">
                                            <label class="form-check-label" for="useFeeder">
                                                Document Feeder (Multiple Pages)
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="twoSideInstructions" class="scan-instructions">
                                        <p class="mb-2">
                                            <span class="scan-side-indicator">Front Side:</span> 
                                            Place the document with the front side facing down on the scanner.
                                        </p>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-primary" onclick="startScanning()">
                                    Start Scanning
                                    <span class="spinner">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </span>
                                </button>
                                
                                <div class="scan-preview">
                                    <h5>Scanned Document Preview</h5>
                                    <div class="preview-images"></div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <a href="{% url 'employees:employee_detail' employee.pk %}" class="btn btn-secondary">Cancel</a>
                                <button type="submit" class="btn btn-primary">Save Document</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize jsPDF at the start
const { jsPDF } = window.jspdf;

function selectMethod(method) {
    // Update buttons
    document.querySelectorAll('.method-button').forEach(btn => {
        btn.classList.remove('active');
    });
    const selectedBtn = method === 'upload' ? 
        document.querySelector('.method-button:first-child') :
        document.querySelector('.method-button:last-child');
    selectedBtn.classList.add('active');
    
    // Show/hide content
    const uploadContent = document.querySelector('.upload-content');
    const scanContent = document.querySelector('.scan-content');
    const scanPreview = document.querySelector('.scan-preview');
    
    if (method === 'upload') {
        uploadContent.style.display = 'block';
        scanContent.style.display = 'none';
        scanPreview.style.display = 'none';
    } else {
        uploadContent.style.display = 'none';
        scanContent.style.display = 'block';
    }
}

let currentSide = 'front';
let frontImage = null;
let backImage = null;

function updateScanInstructions() {
    const mode = document.querySelector('input[name="scanMode"]:checked').value;
    const instructions = document.getElementById('twoSideInstructions');
    
    if (mode === 'double') {
        instructions.classList.add('active');
        instructions.querySelector('p').innerHTML = `
            <span class="scan-side-indicator">${currentSide === 'front' ? 'Front' : 'Back'} Side:</span> 
            Place the document with the ${currentSide} side facing down on the scanner.
        `;
    } else {
        instructions.classList.remove('active');
    }
}

// Add event listeners for scan mode changes
document.querySelectorAll('input[name="scanMode"]').forEach(radio => {
    radio.addEventListener('change', () => {
        currentSide = 'front';
        frontImage = null;
        backImage = null;
        updateScanInstructions();
        
        // Clear previews when changing modes
        const previewImages = document.querySelector('.preview-images');
        if (previewImages) {
            previewImages.innerHTML = '';
        }
    });
});

async function startScanning() {
    const scanBtn = document.querySelector('.scan-content button');
    const spinner = document.querySelector('.scan-content .spinner');  
    const previewContainer = document.querySelector('.scan-preview');
    const previewImages = document.querySelector('.preview-images');
    const scanMode = document.querySelector('input[name="scanMode"]:checked').value;
    
    try {
        // Show loading state
        scanBtn.disabled = true;
        if (spinner) {  
            spinner.style.display = 'inline-block';
        }
        
        // Clear previews if starting fresh scan
        if (scanMode !== 'double' || currentSide === 'front') {
            previewImages.innerHTML = '';
        }
        
        // Call our scanning endpoint
        const response = await fetch('{% url "employees:scan_document" employee.pk %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                useFeeder: scanMode === 'feeder',
                currentSide: currentSide
            })
        });
        
        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to scan document');
        }
        
        const data = await response.json();
        
        if (scanMode === 'double') {
            // Handle two-sided scanning
            if (currentSide === 'front') {
                frontImage = data.images[0];
                
                // Show front preview
                const previewContainer = document.createElement('div');
                previewContainer.className = 'preview-image-container';
                
                const pageNumber = document.createElement('div');
                pageNumber.className = 'page-number';
                pageNumber.textContent = 'Front Side';
                previewContainer.appendChild(pageNumber);
                
                const img = document.createElement('img');
                img.src = frontImage.data;
                img.alt = 'Front Side';
                previewContainer.appendChild(img);
                
                previewImages.appendChild(previewContainer);
                
                // Update instructions for back side
                currentSide = 'back';
                updateScanInstructions();
                
                // Update button text and add spinner
                scanBtn.innerHTML = 'Scan Back Side <span class="spinner"><i class="fas fa-spinner fa-spin"></i></span>';
                
            } else {
                backImage = data.images[0];
                
                // Show back preview
                const previewContainer = document.createElement('div');
                previewContainer.className = 'preview-image-container';
                
                const pageNumber = document.createElement('div');
                pageNumber.className = 'page-number';
                pageNumber.textContent = 'Back Side';
                previewContainer.appendChild(pageNumber);
                
                const img = document.createElement('img');
                img.src = backImage.data;
                img.alt = 'Back Side';
                previewContainer.appendChild(img);
                
                previewImages.appendChild(previewContainer);
                
                try {
                    // Create PDF with both sides
                    const doc = new jsPDF();
                    
                    // Add front side
                    doc.addImage(frontImage.data, 'JPEG', 0, 0, 210, 297);
                    
                    // Add back side
                    doc.addPage();
                    doc.addImage(backImage.data, 'JPEG', 0, 0, 210, 297);
                    
                    // Convert to blob and create file
                    const pdfBlob = doc.output('blob');
                    const file = new File([pdfBlob], "scanned_document.pdf", { type: "application/pdf" });
                    
                    // Update file input
                    const fileInput = document.querySelector('input[type="file"]');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    // Reset for next scan
                    currentSide = 'front';
                    scanBtn.innerHTML = 'Start Scanning <span class="spinner"><i class="fas fa-spinner fa-spin"></i></span>';
                    updateScanInstructions();
                } catch (pdfError) {
                    console.error('PDF Creation Error:', pdfError);
                    throw new Error('Failed to create PDF: ' + pdfError.message);
                }
            }
            
        } else {
            // Handle single-side or feeder scanning
            try {
                const doc = new jsPDF();
                let firstPage = true;
                
                for (const image of data.images) {
                    if (!firstPage) {
                        doc.addPage();
                    }
                    doc.addImage(image.data, 'JPEG', 0, 0, 210, 297);
                    firstPage = false;
                    
                    // Add preview
                    const container = document.createElement('div');
                    container.className = 'preview-image-container';
                    const img = document.createElement('img');
                    img.src = image.data;
                    container.appendChild(img);
                    previewImages.appendChild(container);
                }
                
                // Create file from PDF
                const pdfBlob = doc.output('blob');
                const file = new File([pdfBlob], "scanned_document.pdf", { type: "application/pdf" });
                
                // Update file input
                const fileInput = document.querySelector('input[type="file"]');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
            } catch (pdfError) {
                console.error('PDF Creation Error:', pdfError);
                throw new Error('Failed to create PDF: ' + pdfError.message);
            }
        }
        
        // Show preview section
        previewContainer.style.display = 'block';
        
    } catch (error) {
        alert('Error while scanning: ' + error.message);
        console.error(error);
    } finally {
        // Reset loading state
        scanBtn.disabled = false;
        if (spinner) {  
            spinner.style.display = 'none';
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    selectMethod('upload');
    updateScanInstructions();
});
</script>
<!-- Add jsPDF for PDF creation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
{% endblock %}
